
var ytp = ytp || {};

function onYouTubeIframeAPIReady() {
    if (ytp.YTAPIReady) return;
    ytp.YTAPIReady = true;
    jQuery(document).trigger("YTAPIReady");
}

var getYTPVideoID = function (url) {
    var videoID, playlistID;
    if (url.indexOf("youtu.be") > 0) {
        videoID = url.substr(url.lastIndexOf("/") + 1, url.length);
        playlistID = videoID.indexOf("?list=") > 0 ? videoID.substr(videoID.lastIndexOf("="), videoID.length) : null;
        videoID = playlistID ? videoID.substr(0, videoID.lastIndexOf("?")) : videoID;
    } else if (url.indexOf("http") > -1) {
        videoID = url.match(/[\\?&]v=([^&#]*)/)[1];
        playlistID = url.indexOf("list=") > 0 ? url.match(/[\\?&]list=([^&#]*)/)[1] : null;
    } else {
        videoID = url.length > 15 ? null : url;
        playlistID = videoID ? null : url;
    }
    return {
        videoID: videoID,
        playlistID: playlistID
    };
};

(function (jQuery, ytp) {

    jQuery.mbYTPlayer = {
        name: "jquery.mb.YTPlayer",
        version: "2.9.4",
        build: "{{ build }}",
        author: "Matteo Bicocchi",
        apiKey: "",
        defaults: {
            containment: "body",
            ratio: "auto", // "auto", "16/9", "4/3"
            videoURL: null,
            playlistURL: null,
            startAt: 0,
            stopAt: 0,
            autoPlay: true,
            vol: 50, // 1 to 100
            addRaster: false,
            opacity: 1,
            quality: "default", //or â€œsmallâ€, â€œmediumâ€, â€œlargeâ€, â€œhd720â€, â€œhd1080â€, â€œhighresâ€
            mute: false,
            loop: true,
            showControls: true,
            showAnnotations: false,
            showYTLogo: true,
            stopMovieOnBlur: true,
            realfullscreen: true,
            gaTrack: true,
            optimizeDisplay: true,
            onReady: function (player) { }
        },
        /* @fontface icons */
        controls: {
            play: "P",
            pause: "p",
            mute: "M",
            unmute: "A",
            onlyYT: "O",
            showSite: "R",
            ytLogo: "Y"
        },
        locationProtocol: "https:",
        /**
         *
         * @param options
         * @returns [players]
         */
        buildPlayer: function (options) {
            return this.each(function () {
                var YTPlayer = this;
                var $YTPlayer = jQuery(YTPlayer);
                YTPlayer.loop = 0;
                YTPlayer.opt = {};
                YTPlayer.state = {};
                YTPlayer.filtersEnabled = true;
                YTPlayer.filters = {
                    grayscale: {
                        value: 0,
                        unit: "%"
                    },
                    hue_rotate: {
                        value: 0,
                        unit: "deg"
                    },
                    invert: {
                        value: 0,
                        unit: "%"
                    },
                    opacity: {
                        value: 0,
                        unit: "%"
                    },
                    saturate: {
                        value: 0,
                        unit: "%"
                    },
                    sepia: {
                        value: 0,
                        unit: "%"
                    },
                    brightness: {
                        value: 0,
                        unit: "%"
                    },
                    contrast: {
                        value: 0,
                        unit: "%"
                    },
                    blur: {
                        value: 0,
                        unit: "px"
                    }
                };
                $YTPlayer.addClass("mb_YTPlayer");
                var property = $YTPlayer.data("property") && typeof $YTPlayer.data("property") == "string" ? eval('(' + $YTPlayer.data("property") + ')') : $YTPlayer.data("property");
                if (typeof property != "undefined" && typeof property.vol != "undefined") property.vol = property.vol === 0 ? property.vol = 1 : property.vol;
                jQuery.extend(YTPlayer.opt, jQuery.mbYTPlayer.defaults, options, property);
                if (!YTPlayer.hasChanged) {
                    YTPlayer.defaultOpt = {};
                    jQuery.extend(YTPlayer.defaultOpt, jQuery.mbYTPlayer.defaults, options, property);
                }
                YTPlayer.isRetina = (window.retina || window.devicePixelRatio > 1);
                var isIframe = function () {
                    var isIfr = false;
                    try {
                        if (self.location.href != top.location.href) isIfr = true;
                    } catch (e) {
                        isIfr = true;
                    }
                    return isIfr;
                };
                YTPlayer.canGoFullScreen = !(jQuery.browser.msie || jQuery.browser.opera || isIframe());
                if (!YTPlayer.canGoFullScreen) YTPlayer.opt.realfullscreen = false;
                if (!$YTPlayer.attr("id")) $YTPlayer.attr("id", "video_" + new Date().getTime());
                var playerID = "mbYTP_" + YTPlayer.id;
                YTPlayer.isAlone = false;
                YTPlayer.hasFocus = true;
                var videoID = this.opt.videoURL ? getYTPVideoID(this.opt.videoURL).videoID : $YTPlayer.attr("href") ? getYTPVideoID($YTPlayer.attr("href")).videoID : false;
                var playlistID = this.opt.videoURL ? getYTPVideoID(this.opt.videoURL).playlistID : $YTPlayer.attr("href") ? getYTPVideoID($YTPlayer.attr("href")).playlistID : false;
                YTPlayer.videoID = videoID;
                YTPlayer.playlistID = playlistID;
                YTPlayer.opt.showAnnotations = (YTPlayer.opt.showAnnotations) ? '0' : '3';
                var playerVars = {
                    'autoplay': 0,
                    'modestbranding': 1,
                    'controls': 0,
                    'showinfo': 0,
                    'rel': 0,
                    'enablejsapi': 1,
                    'version': 3,
                    'playerapiid': playerID,
                    'origin': '*',
                    'allowfullscreen': true,
                    'wmode': 'transparent',
                    'iv_load_policy': YTPlayer.opt.showAnnotations
                };
                if (document.createElement('video').canPlayType) jQuery.extend(playerVars, {
                    'html5': 1
                });
                if (jQuery.browser.msie && jQuery.browser.version < 9) this.opt.opacity = 1;
                var playerBox = jQuery("<div/>").attr("id", playerID).addClass("playerBox");
                var overlay = jQuery("<div/>").css({
                    position: "absolute",
                    top: 0,
                    left: 0,
                    width: "100%",
                    height: "100%"
                }).addClass("YTPOverlay");
                YTPlayer.isSelf = YTPlayer.opt.containment == "self";
                YTPlayer.defaultOpt.containment = YTPlayer.opt.containment = YTPlayer.opt.containment == "self" ? jQuery(this) : jQuery(YTPlayer.opt.containment);
                YTPlayer.isBackground = YTPlayer.opt.containment.get(0).tagName.toLowerCase() == "body";
                if (YTPlayer.isBackground && ytp.backgroundIsInited) return;
                var isPlayer = YTPlayer.opt.containment.is(jQuery(this));
                YTPlayer.canPlayOnMobile = isPlayer && jQuery(this).children().length === 0;
                if (!isPlayer) {
                    $YTPlayer.hide();
                } else {
                    YTPlayer.isPlayer = true;
                }
                if (jQuery.browser.mobile && !YTPlayer.canPlayOnMobile) {
                    $YTPlayer.remove();
                    return;
                }
                var wrapper = jQuery("<div/>").addClass("mbYTP_wrapper").attr("id", "wrapper_" + playerID);
                wrapper.css({
                    position: "absolute",
                    zIndex: 0,
                    minWidth: "100%",
                    minHeight: "100%",
                    left: 0,
                    top: 0,
                    overflow: "hidden",
                    opacity: 0
                });
                playerBox.css({
                    position: "absolute",
                    zIndex: 0,
                    width: "100%",
                    height: "100%",
                    top: 0,
                    left: 0,
                    overflow: "hidden"
                });
                wrapper.append(playerBox);
                YTPlayer.opt.containment.children().not("script, style").each(function () {
                    if (jQuery(this).css("position") == "static") jQuery(this).css("position", "relative");
                });
                if (YTPlayer.isBackground) {
                    jQuery("body").css({
                        boxSizing: "border-box"
                    });
                    wrapper.css({
                        position: "fixed",
                        top: 0,
                        left: 0,
                        zIndex: 0
                    });
                    $YTPlayer.hide();
                } else if (YTPlayer.opt.containment.css("position") == "static") YTPlayer.opt.containment.css({
                    position: "relative"
                });
                YTPlayer.opt.containment.prepend(wrapper);
                YTPlayer.wrapper = wrapper;
                playerBox.css({
                    opacity: 1
                });
                if (!jQuery.browser.mobile) {
                    playerBox.after(overlay);
                    YTPlayer.overlay = overlay;
                }
                if (!YTPlayer.isBackground) {
                    overlay.on("mouseenter", function () {
                        if (YTPlayer.controlBar) YTPlayer.controlBar.addClass("visible");
                    }).on("mouseleave", function () {
                        if (YTPlayer.controlBar) YTPlayer.controlBar.removeClass("visible");
                    })
                }
                if (!ytp.YTAPIReady) {
                    jQuery("#YTAPI").remove();
                    var tag = jQuery("<script></script>").attr({
                        "src": jQuery.mbYTPlayer.locationProtocol + "//www.youtube.com/iframe_api?v=" + jQuery.mbYTPlayer.version,
                        "id": "YTAPI"
                    });
                    jQuery("head").prepend(tag);
                } else {
                    setTimeout(function () {
                        jQuery(document).trigger("YTAPIReady");
                    }, 100)
                }
                jQuery(document).on("YTAPIReady", function () {
                    if ((YTPlayer.isBackground && ytp.backgroundIsInited) || YTPlayer.isInit) return;
                    if (YTPlayer.isBackground) {
                        ytp.backgroundIsInited = true;
                    }
                    YTPlayer.opt.autoPlay = typeof YTPlayer.opt.autoPlay == "undefined" ? (YTPlayer.isBackground ? true : false) : YTPlayer.opt.autoPlay;
                    YTPlayer.opt.vol = YTPlayer.opt.vol ? YTPlayer.opt.vol : 100;
                    jQuery.mbYTPlayer.getDataFromAPI(YTPlayer);
                    jQuery(YTPlayer).on("YTPChanged", function () {
                        if (YTPlayer.isInit) return;
                        YTPlayer.isInit = true;
                        //if is mobile && isPlayer fallback to the default YT player
                        if (jQuery.browser.mobile && YTPlayer.canPlayOnMobile) {
                            // Try to adjust the player dimention
                            if (YTPlayer.opt.containment.outerWidth() > jQuery(window).width()) {
                                YTPlayer.opt.containment.css({
                                    maxWidth: "100%"
                                });
                                var h = YTPlayer.opt.containment.outerWidth() * .6;
                                YTPlayer.opt.containment.css({
                                    maxHeight: h
                                });
                            }
                            new YT.Player(playerID, {
                                videoId: YTPlayer.videoID.toString(),
                                height: '100%',
                                width: '100%',
                                events: {
                                    'onReady': function (event) {
                                        YTPlayer.player = event.target;
                                        playerBox.css({
                                            opacity: 1
                                        });
                                        YTPlayer.wrapper.css({
                                            opacity: 1
                                        });
                                    }
                                }
                            });
                            return;
                        }
                        new YT.Player(playerID, {
                            videoId: YTPlayer.videoID.toString(),
                            playerVars: playerVars,
                            events: {
                                'onReady': function (event) {
                                    YTPlayer.player = event.target;
                                    if (YTPlayer.isReady) return;
                                    YTPlayer.isReady = YTPlayer.isPlayer && !YTPlayer.opt.autoPlay ? false : true;
                                    YTPlayer.playerEl = YTPlayer.player.getIframe();
                                    $YTPlayer.optimizeDisplay();
                                    YTPlayer.videoID = videoID;
                                    jQuery(window).on("resize.YTP", function () {
                                        $YTPlayer.optimizeDisplay();
                                    });
                                    jQuery.mbYTPlayer.checkForState(YTPlayer);
                                    // Trigger state events
                                    var YTPEvent = jQuery.Event("YTPUnstarted");
                                    YTPEvent.time = YTPlayer.player.time;
                                    if (YTPlayer.canTrigger) jQuery(YTPlayer).trigger(YTPEvent);
                                },
                                /**
                                 *
                                 * @param event
                                 *
                                 * -1 (unstarted)
                                 * 0 (ended)
                                 * 1 (playing)
                                 * 2 (paused)
                                 * 3 (buffering)
                                 * 5 (video cued).
                                 *
                                 *
                                 */
                                'onStateChange': function (event) {
                                    if (typeof event.target.getPlayerState != "function") return;
                                    var state = event.target.getPlayerState();
                                    if (YTPlayer.state == state) return;
                                    YTPlayer.state = state;
                                    var eventType;
                                    switch (state) {
                                        case -1: //------------------------------------------------ unstarted
                                            eventType = "YTPUnstarted";
                                            break;
                                        case 0: //------------------------------------------------ ended
                                            eventType = "YTPEnd";
                                            break;
                                        case 1: //------------------------------------------------ play
                                            eventType = "YTPStart";
                                            if (YTPlayer.controlBar) YTPlayer.controlBar.find(".mb_YTPPlaypause").html(jQuery.mbYTPlayer.controls.pause);
                                            if (typeof _gaq != "undefined" && eval(YTPlayer.opt.gaTrack)) _gaq.push(['_trackEvent', 'YTPlayer', 'Play', (YTPlayer.hasData ? YTPlayer.videoData.title : YTPlayer.videoID.toString())]);
                                            if (typeof ga != "undefined" && eval(YTPlayer.opt.gaTrack)) ga('send', 'event', 'YTPlayer', 'play', (YTPlayer.hasData ? YTPlayer.videoData.title : YTPlayer.videoID.toString()));
                                            break;
                                        case 2: //------------------------------------------------ pause
                                            eventType = "YTPPause";
                                            if (YTPlayer.controlBar) YTPlayer.controlBar.find(".mb_YTPPlaypause").html(jQuery.mbYTPlayer.controls.play);
                                            break;
                                        case 3: //------------------------------------------------ buffer
                                            YTPlayer.player.setPlaybackQuality(YTPlayer.opt.quality);
                                            eventType = "YTPBuffering";
                                            if (YTPlayer.controlBar) YTPlayer.controlBar.find(".mb_YTPPlaypause").html(jQuery.mbYTPlayer.controls.play);
                                            break;
                                        case 5: //------------------------------------------------ cued
                                            eventType = "YTPCued";
                                            break;
                                        default:
                                            break;
                                    }
                                    // Trigger state events
                                    var YTPEvent = jQuery.Event(eventType);
                                    YTPEvent.time = YTPlayer.player.time;
                                    if (YTPlayer.canTrigger) jQuery(YTPlayer).trigger(YTPEvent);
                                },
                                /**
                                 *
                                 * @param e
                                 */
                                'onPlaybackQualityChange': function (e) {
                                    var quality = e.target.getPlaybackQuality();
                                    var YTPQualityChange = jQuery.Event("YTPQualityChange");
                                    YTPQualityChange.quality = quality;
                                    jQuery(YTPlayer).trigger(YTPQualityChange);
                                },
                                /**
                                 *
                                 * @param err
                                 */
                                'onError': function (err) {
                                    if (err.data == 150) {
                                        console.log("Embedding this video is restricted by Youtube.");
                                        if (YTPlayer.isPlayList) jQuery(YTPlayer).playNext();
                                    }
                                    if (err.data == 2 && YTPlayer.isPlayList) jQuery(YTPlayer).playNext();
                                    if (typeof YTPlayer.opt.onError == "function") YTPlayer.opt.onError($YTPlayer, err);
                                }
                            }
                        });
                    });
                })
            });
        },
        /**
         *
         * @param YTPlayer
         */
        getDataFromAPI: function (YTPlayer) {
            YTPlayer.videoData = jQuery.mbStorage.get("YTPlayer_data_" + YTPlayer.videoID);
            jQuery(YTPlayer).off("YTPData.YTPlayer").on("YTPData.YTPlayer", function () {
                if (YTPlayer.hasData) {

                    if (YTPlayer.isPlayer && !YTPlayer.opt.autoPlay) {
                        var bgndURL = YTPlayer.videoData.thumb_max || YTPlayer.videoData.thumb_high || YTPlayer.videoData.thumb_medium;
                        YTPlayer.opt.containment.css({
                            background: "rgba(0,0,0,0.5) url(" + bgndURL + ") center center",
                            backgroundSize: "cover"
                        });
                        YTPlayer.opt.backgroundUrl = bgndURL;
                    }
                }
            });

            if (YTPlayer.videoData) {

                setTimeout(function () {
                    YTPlayer.opt.ratio = YTPlayer.opt.ratio == "auto" ? "16/9" : YTPlayer.opt.ratio;
                    YTPlayer.dataReceived = true;
                    jQuery(YTPlayer).trigger("YTPChanged");
                    var YTPData = jQuery.Event("YTPData");
                    YTPData.prop = {};
                    for (var x in YTPlayer.videoData) YTPData.prop[x] = YTPlayer.videoData[x];
                    jQuery(YTPlayer).trigger(YTPData);
                }, 500);

                YTPlayer.hasData = true;
            } else if (jQuery.mbYTPlayer.apiKey) {
                // Get video info from API3 (needs api key)
                // snippet,player,contentDetails,statistics,status
                jQuery.getJSON(jQuery.mbYTPlayer.locationProtocol + "//www.googleapis.com/youtube/v3/videos?id=" + YTPlayer.videoID + "&key=" + jQuery.mbYTPlayer.apiKey + "&part=snippet", function (data) {
                    YTPlayer.dataReceived = true;
                    jQuery(YTPlayer).trigger("YTPChanged");

                    function parseYTPlayer_data(data) {
                        YTPlayer.videoData = {};
                        YTPlayer.videoData.id = YTPlayer.videoID;
                        YTPlayer.videoData.channelTitle = data.channelTitle;
                        YTPlayer.videoData.title = data.title;
                        YTPlayer.videoData.description = data.description.length < 400 ? data.description : data.description.substring(0, 400) + " ...";
                        YTPlayer.videoData.aspectratio = YTPlayer.opt.ratio == "auto" ? "16/9" : YTPlayer.opt.ratio;
                        YTPlayer.opt.ratio = YTPlayer.videoData.aspectratio;
                        YTPlayer.videoData.thumb_max = data.thumbnails.maxres ? data.thumbnails.maxres.url : null;
                        YTPlayer.videoData.thumb_high = data.thumbnails.high ? data.thumbnails.high.url : null;
                        YTPlayer.videoData.thumb_medium = data.thumbnails.medium ? data.thumbnails.medium.url : null;
                        jQuery.mbStorage.set("YTPlayer_data_" + YTPlayer.videoID, YTPlayer.videoData);
                    }
                    parseYTPlayer_data(data.items[0].snippet);
                    YTPlayer.hasData = true;
                    var YTPData = jQuery.Event("YTPData");
                    YTPData.prop = {};
                    for (var x in YTPlayer.videoData) YTPData.prop[x] = YTPlayer.videoData[x];
                    jQuery(YTPlayer).trigger(YTPData);
                });
            } else {
                setTimeout(function () {
                    jQuery(YTPlayer).trigger("YTPChanged");
                }, 50);
                if (YTPlayer.isPlayer && !YTPlayer.opt.autoPlay) {
                    var bgndURL = jQuery.mbYTPlayer.locationProtocol + "//i.ytimg.com/vi/" + YTPlayer.videoID + "/hqdefault.jpg";
                    YTPlayer.opt.containment.css({
                        background: "rgba(0,0,0,0.5) url(" + bgndURL + ") center center",
                        backgroundSize: "cover"
                    });
                    YTPlayer.opt.backgroundUrl = bgndURL;
                }
                YTPlayer.videoData = null;
                YTPlayer.opt.ratio = YTPlayer.opt.ratio == "auto" ? "16/9" : YTPlayer.opt.ratio;
            }
            if (YTPlayer.isPlayer && !YTPlayer.opt.autoPlay) {
                YTPlayer.loading = jQuery("<div/>").addClass("loading").html("Loading").hide();
                jQuery(YTPlayer).append(YTPlayer.loading);
                YTPlayer.loading.fadeIn();
            }
        },
        /**
         *
         */
        removeStoredData: function () {
            jQuery.mbStorage.remove();
        },
        /**
         *
         * @returns {*|YTPlayer.videoData}
         */
        getVideoData: function () {
            var YTPlayer = this.get(0);
            return YTPlayer.videoData;
        },
        /**
         *
         * @returns {*|YTPlayer.videoID|boolean}
         */
        getVideoID: function () {
            var YTPlayer = this.get(0);
            return YTPlayer.videoID || false;
        },
        /**
         *
         * @param quality
         */
        setVideoQuality: function (quality) {
            var YTPlayer = this.get(0);
            if (!jQuery.browser.chrome) YTPlayer.player.setPlaybackQuality(quality);
        },
        /**
         * @param videos
         * @param shuffle
         * @param callback
         * @returns {jQuery.mbYTPlayer}
         */
        playlist: function (videos, shuffle, callback) {
            var $YTPlayer = this;
            var YTPlayer = $YTPlayer.get(0);
            YTPlayer.isPlayList = true;
            if (shuffle) videos = jQuery.shuffle(videos);
            if (!YTPlayer.videoID) {
                YTPlayer.videos = videos;
                YTPlayer.videoCounter = 0;
                YTPlayer.videoLength = videos.length;
                jQuery(YTPlayer).data("property", videos[0]);
                jQuery(YTPlayer).mb_YTPlayer();
            }
            if (typeof callback == "function") jQuery(YTPlayer).one("YTPChanged", function () {
                callback(YTPlayer);
            });
            jQuery(YTPlayer).on("YTPEnd", function () {
                jQuery(YTPlayer).playNext();
            });
            return $YTPlayer;
        },
        /**
         *
         * @returns {jQuery.mbYTPlayer}
         */
        playNext: function () {
            var YTPlayer = this.get(0);
            YTPlayer.videoCounter++;
            if (YTPlayer.videoCounter >= YTPlayer.videoLength) YTPlayer.videoCounter = 0;
            jQuery(YTPlayer).changeMovie(YTPlayer.videos[YTPlayer.videoCounter]);
            return this;
        },
        /**
         *
         * @returns {jQuery.mbYTPlayer}
         */
        playPrev: function () {
            var YTPlayer = this.get(0);
            YTPlayer.videoCounter--;
            if (YTPlayer.videoCounter < 0) YTPlayer.videoCounter = YTPlayer.videoLength - 1;
            jQuery(YTPlayer).changeMovie(YTPlayer.videos[YTPlayer.videoCounter]);
            return this;
        },
        /**
         *
         * @param opt
         */
        changeMovie: function (opt) {
            var YTPlayer = this.get(0);
            YTPlayer.opt.startAt = 0;
            YTPlayer.opt.stopAt = 0;
            YTPlayer.opt.mute = true;
            YTPlayer.hasData = false;
            YTPlayer.hasChanged = true;
            if (opt) jQuery.extend(YTPlayer.opt, YTPlayer.defaultOpt, opt);
            YTPlayer.videoID = getYTPVideoID(YTPlayer.opt.videoURL).videoID;
            jQuery(YTPlayer.playerEl).CSSAnimate({
                opacity: 0
            }, 200, function () {
                jQuery(YTPlayer).YTPGetPlayer().cueVideoByUrl(encodeURI(jQuery.mbYTPlayer.locationProtocol + "//www.youtube.com/v/" + YTPlayer.videoID), 1, YTPlayer.opt.quality);
                jQuery.mbYTPlayer.checkForState(YTPlayer);
                jQuery(YTPlayer).optimizeDisplay();
                jQuery.mbYTPlayer.getDataFromAPI(YTPlayer);
                return this;
            });
        },
        /**
         *
         * @returns {player}
         */
        getPlayer: function () {
            return jQuery(this).get(0).player;
        },
        playerDestroy: function () {
            var YTPlayer = this.get(0);
            ytp.YTAPIReady = false;
            ytp.backgroundIsInited = false;
            YTPlayer.isInit = false;
            YTPlayer.videoID = null;
            var playerBox = YTPlayer.wrapper;
            playerBox.remove();
            jQuery("#controlBar_" + YTPlayer.id).remove();
            clearInterval(YTPlayer.checkForStartAt);
            clearInterval(YTPlayer.getState);
            return this;
        },
        /**
         *
         * @param real
         * @returns {jQuery.mbYTPlayer}
         */
        fullscreen: function (real) {
            var YTPlayer = this.get(0);
            if (typeof real == "undefined") real = YTPlayer.opt.realfullscreen;
            real = eval(real);
            var controls = jQuery("#controlBar_" + YTPlayer.id);
            var fullScreenBtn = controls.find(".mb_OnlyYT");
            var videoWrapper = YTPlayer.isSelf ? YTPlayer.opt.containment : YTPlayer.wrapper;
            //var videoWrapper = YTPlayer.wrapper;
            if (real) {
                var fullscreenchange = jQuery.browser.mozilla ? "mozfullscreenchange" : jQuery.browser.webkit ? "webkitfullscreenchange" : "fullscreenchange";
                jQuery(document).off(fullscreenchange).on(fullscreenchange, function () {
                    var isFullScreen = RunPrefixMethod(document, "IsFullScreen") || RunPrefixMethod(document, "FullScreen");
                    if (!isFullScreen) {
                        YTPlayer.isAlone = false;
                        fullScreenBtn.html(jQuery.mbYTPlayer.controls.onlyYT);
                        jQuery(YTPlayer).YTPSetVideoQuality(YTPlayer.opt.quality);
                        videoWrapper.removeClass("fullscreen");
                        videoWrapper.CSSAnimate({
                            opacity: YTPlayer.opt.opacity
                        }, 500);
                        videoWrapper.css({
                            zIndex: 0
                        });
                        if (YTPlayer.isBackground) {
                            jQuery("body").after(controls);
                        } else {
                            YTPlayer.wrapper.before(controls);
                        }
                        jQuery(window).resize();
                        jQuery(YTPlayer).trigger("YTPFullScreenEnd");
                    } else {
                        jQuery(YTPlayer).YTPSetVideoQuality("default");
                        jQuery(YTPlayer).trigger("YTPFullScreenStart");
                    }
                });
            }
            if (!YTPlayer.isAlone) {
                function hideMouse() {
                    YTPlayer.overlay.css({
                        cursor: "none"
                    });
                }
                jQuery(document).on("mousemove.YTPlayer", function (e) {
                    YTPlayer.overlay.css({
                        cursor: "auto"
                    });
                    clearTimeout(YTPlayer.hideCursor);
                    if (!jQuery(e.target).parents().is(".mb_YTPBar")) YTPlayer.hideCursor = setTimeout(hideMouse, 3000);
                });
                hideMouse();
                if (real) {
                    videoWrapper.css({
                        opacity: 0
                    });
                    videoWrapper.addClass("fullscreen");
                    launchFullscreen(videoWrapper.get(0));
                    setTimeout(function () {
                        videoWrapper.CSSAnimate({
                            opacity: 1
                        }, 1000);
                        YTPlayer.wrapper.append(controls);
                        jQuery(YTPlayer).optimizeDisplay();
                        YTPlayer.player.seekTo(YTPlayer.player.getCurrentTime() + .1, true);
                    }, 500)
                } else videoWrapper.css({
                    zIndex: 10000
                }).CSSAnimate({
                    opacity: 1
                }, 1000);
                fullScreenBtn.html(jQuery.mbYTPlayer.controls.showSite);
                YTPlayer.isAlone = true;
            } else {
                jQuery(document).off("mousemove.YTPlayer");
                YTPlayer.overlay.css({
                    cursor: "auto"
                });
                if (real) {
                    cancelFullscreen();
                } else {
                    videoWrapper.CSSAnimate({
                        opacity: YTPlayer.opt.opacity
                    }, 500);
                    videoWrapper.css({
                        zIndex: 0
                    });
                }
                fullScreenBtn.html(jQuery.mbYTPlayer.controls.onlyYT);
                YTPlayer.isAlone = false;
            }

            function RunPrefixMethod(obj, method) {
                var pfx = ["webkit", "moz", "ms", "o", ""];
                var p = 0,
                        m, t;
                while (p < pfx.length && !obj[m]) {
                    m = method;
                    if (pfx[p] == "") {
                        m = m.substr(0, 1).toLowerCase() + m.substr(1);
                    }
                    m = pfx[p] + m;
                    t = typeof obj[m];
                    if (t != "undefined") {
                        pfx = [pfx[p]];
                        return (t == "function" ? obj[m]() : obj[m]);
                    }
                    p++;
                }
            }

            function launchFullscreen(element) {
                RunPrefixMethod(element, "RequestFullScreen");
            }

            function cancelFullscreen() {
                if (RunPrefixMethod(document, "FullScreen") || RunPrefixMethod(document, "IsFullScreen")) {
                    RunPrefixMethod(document, "CancelFullScreen");
                }
            }
            return this;
        },
        /**
         *
         * @returns {jQuery.mbYTPlayer}
         */
        toggleLoops: function () {
            var YTPlayer = this.get(0);
            var data = YTPlayer.opt;
            if (data.loop == 1) {
                data.loop = 0;
            } else {
                if (data.startAt) {
                    YTPlayer.player.seekTo(data.startAt);
                } else {
                    YTPlayer.player.playVideo();
                }
                data.loop = 1;
            }
            return this;
        },
        /**
         *
         * @returns {jQuery.mbYTPlayer}
         */
        play: function () {
            var YTPlayer = this.get(0);
            if (!YTPlayer.isReady) return;
            var controls = jQuery("#controlBar_" + YTPlayer.id);
            var playBtn = controls.find(".mb_YTPPlaypause");
            playBtn.html(jQuery.mbYTPlayer.controls.pause);
            YTPlayer.player.playVideo();
            YTPlayer.wrapper.CSSAnimate({
                opacity: YTPlayer.isAlone ? 1 : YTPlayer.opt.opacity
            }, 2000);
            jQuery(YTPlayer.playerEl).CSSAnimate({
                opacity: 1
            }, 1000);
            jQuery(YTPlayer).css("background-image", "none");
            return this;
        },
        /**
         *
         * @param callback
         * @returns {jQuery.mbYTPlayer}
         */
        togglePlay: function (callback) {
            var YTPlayer = this.get(0);
            if (YTPlayer.state == 1) this.YTPPause();
            else this.YTPPlay();
            if (typeof callback == "function") {
                callback(YTPlayer.state);
            }
            return this;
        },
        /**
         *
         * @returns {jQuery.mbYTPlayer}
         */
        stop: function () {
            var YTPlayer = this.get(0);
            var controls = jQuery("#controlBar_" + YTPlayer.id);
            var playBtn = controls.find(".mb_YTPPlaypause");
            playBtn.html(jQuery.mbYTPlayer.controls.play);
            YTPlayer.player.stopVideo();
            return this;
        },
        /**
         *
         * @returns {jQuery.mbYTPlayer}
         */
        pause: function () {
            var YTPlayer = this.get(0);
            var controls = jQuery("#controlBar_" + YTPlayer.id);
            var playBtn = controls.find(".mb_YTPPlaypause");
            playBtn.html(jQuery.mbYTPlayer.controls.play);
            YTPlayer.player.pauseVideo();
            return this;
        },
        /**
         *
         * @param val
         * @returns {jQuery.mbYTPlayer}
         */
        seekTo: function (val) {
            var YTPlayer = this.get(0);
            YTPlayer.player.seekTo(val, true);
            return this;
        },
        /**
         *
         * @param val
         * @returns {jQuery.mbYTPlayer}
         */
        setVolume: function (val) {
            var YTPlayer = this.get(0);
            if (!val && !YTPlayer.opt.vol && YTPlayer.player.getVolume() == 0) jQuery(YTPlayer).YTPUnmute();
            else if ((!val && YTPlayer.player.getVolume() > 0) || (val && YTPlayer.opt.vol == val)) {
                if (!YTPlayer.isMute) jQuery(YTPlayer).YTPMute();
                else jQuery(YTPlayer).YTPUnmute();
            } else {
                YTPlayer.opt.vol = val;
                YTPlayer.player.setVolume(YTPlayer.opt.vol);
                if (YTPlayer.volumeBar && YTPlayer.volumeBar.length) YTPlayer.volumeBar.updateSliderVal(val)
            }
            return this;
        },
        /**
         *
         * @returns {jQuery.mbYTPlayer}
         */
        mute: function () {
            var YTPlayer = this.get(0);
            if (YTPlayer.isMute) return;
            YTPlayer.player.mute();
            YTPlayer.isMute = true;
            YTPlayer.player.setVolume(0);
            if (YTPlayer.volumeBar && YTPlayer.volumeBar.length && YTPlayer.volumeBar.width() > 10) {
                YTPlayer.volumeBar.updateSliderVal(0);
            }
            var controls = jQuery("#controlBar_" + YTPlayer.id);
            var muteBtn = controls.find(".mb_YTPMuteUnmute");
            muteBtn.html(jQuery.mbYTPlayer.controls.unmute);
            jQuery(YTPlayer).addClass("isMuted");
            if (YTPlayer.volumeBar && YTPlayer.volumeBar.length) YTPlayer.volumeBar.addClass("muted");
            var YTPEvent = jQuery.Event("YTPMuted");
            YTPEvent.time = YTPlayer.player.time;
            if (YTPlayer.canTrigger) jQuery(YTPlayer).trigger(YTPEvent);
            return this;
        },
        /**
         *
         * @returns {jQuery.mbYTPlayer}
         */
        unmute: function () {
            var YTPlayer = this.get(0);
            if (!YTPlayer.isMute) return;
            YTPlayer.player.unMute();
            YTPlayer.isMute = false;
            YTPlayer.player.setVolume(YTPlayer.opt.vol);
            if (YTPlayer.volumeBar && YTPlayer.volumeBar.length) YTPlayer.volumeBar.updateSliderVal(YTPlayer.opt.vol > 10 ? YTPlayer.opt.vol : 10);
            var controls = jQuery("#controlBar_" + YTPlayer.id);
            var muteBtn = controls.find(".mb_YTPMuteUnmute");
            muteBtn.html(jQuery.mbYTPlayer.controls.mute);
            jQuery(YTPlayer).removeClass("isMuted");
            if (YTPlayer.volumeBar && YTPlayer.volumeBar.length) YTPlayer.volumeBar.removeClass("muted");
            var YTPEvent = jQuery.Event("YTPUnmuted");
            YTPEvent.time = YTPlayer.player.time;
            if (YTPlayer.canTrigger) jQuery(YTPlayer).trigger(YTPEvent);
            return this;
        },
        /**
         *
         * @param filter
         * @param value
         * @returns {jQuery.mbYTPlayer}
         */
        applyFilter: function (filter, value) {
            var YTPlayer = this.get(0);
            YTPlayer.filters[filter].value = value;
            if (YTPlayer.filtersEnabled) this.YTPEnableFilters();
            return this;
        },
        /**
         *
         * @param filters
         * @returns {jQuery.mbYTPlayer}
         */
        applyFilters: function (filters) {
            var YTPlayer = this.get(0);
            this.on("YTPReady", function () {
                for (var key in filters) {
                    YTPlayer.filters[key].value = filters[key];
                    jQuery(YTPlayer).YTPApplyFilter(key, filters[key]);
                }
                jQuery(YTPlayer).trigger("YTPFiltersApplied");
            });
            return this;
        },
        /**
         *
         * @param filter
         * @param value
         * @returns {*}
         */
        toggleFilter: function (filter, value) {
            return this.each(function () {
                var YTPlayer = this;
                if (!YTPlayer.filters[filter].value) YTPlayer.filters[filter].value = value;
                else YTPlayer.filters[filter].value = 0;
                if (YTPlayer.filtersEnabled) jQuery(this).YTPEnableFilters();
            })
            return this;
        },
        /**
         *
         * @param callback
         * @returns {*}
         */
        toggleFilters: function (callback) {
            return this.each(function () {
                var YTPlayer = this;
                if (YTPlayer.filtersEnabled) {
                    jQuery(YTPlayer).trigger("YTPDisableFilters");
                    jQuery(YTPlayer).YTPDisableFilters();
                } else {
                    jQuery(YTPlayer).YTPEnableFilters();
                    jQuery(YTPlayer).trigger("YTPEnableFilters");
                }
                if (typeof callback == "function") callback(YTPlayer.filtersEnabled);
            })
        },
        /**
         *
         * @returns {*}
         */
        disableFilters: function () {
            return this.each(function () {
                var YTPlayer = this;
                var iframe = jQuery(YTPlayer.playerEl);
                iframe.css("-webkit-filter", "");
                iframe.css("filter", "");
                YTPlayer.filtersEnabled = false;
            })
        },
        /**
         *
         * @returns {*}
         */
        enableFilters: function () {
            return this.each(function () {
                var YTPlayer = this;
                var iframe = jQuery(YTPlayer.playerEl);
                var filterStyle = "";
                for (var key in YTPlayer.filters) {
                    if (YTPlayer.filters[key].value) filterStyle += key.replace("_", "-") + "(" + YTPlayer.filters[key].value + YTPlayer.filters[key].unit + ") ";
                }
                iframe.css("-webkit-filter", filterStyle);
                iframe.css("filter", filterStyle);
                YTPlayer.filtersEnabled = true;
            })
            return this;
        },
        /**
         *
         * @param filter
         * @param callback
         * @returns {*}
         */
        removeFilter: function (filter, callback) {
            return this.each(function () {
                if (typeof filter == "function") {
                    callback = filter;
                    filter = null;
                }
                var YTPlayer = this;
                if (!filter)
                    for (var key in YTPlayer.filters) {
                        jQuery(this).YTPApplyFilter(key, 0);
                        if (typeof callback == "function") callback(key);
                    } else {
                    jQuery(this).YTPApplyFilter(filter, 0);
                    if (typeof callback == "function") callback(filter);
                }
            });
            return this;
        },
        /**
         *
         * @returns {{totalTime: number, currentTime: number}}
         */
        manageProgress: function () {
            var YTPlayer = this.get(0);
            var controls = jQuery("#controlBar_" + YTPlayer.id);
            var progressBar = controls.find(".mb_YTPProgress");
            var loadedBar = controls.find(".mb_YTPLoaded");
            var timeBar = controls.find(".mb_YTPseekbar");
            var totW = progressBar.outerWidth();
            var currentTime = Math.floor(YTPlayer.player.getCurrentTime());
            var totalTime = Math.floor(YTPlayer.player.getDuration());
            var timeW = (currentTime * totW) / totalTime;
            var startLeft = 0;
            var loadedW = YTPlayer.player.getVideoLoadedFraction() * 100;
            loadedBar.css({
                left: startLeft,
                width: loadedW + "%"
            });
            timeBar.css({
                left: 0,
                width: timeW
            });
            return {
                totalTime: totalTime,
                currentTime: currentTime
            };
        },
        /**
         *
         * @param YTPlayer
         */
        buildControls: function (YTPlayer) {
            var data = YTPlayer.opt;
            // @data.printUrl: is deprecated; use data.showYTLogo
            data.showYTLogo = data.showYTLogo || data.printUrl;
            if (jQuery("#controlBar_" + YTPlayer.id).length) return;
            YTPlayer.controlBar = jQuery("<span/>").attr("id", "controlBar_" + YTPlayer.id).addClass("mb_YTPBar").css({
                whiteSpace: "noWrap",
                position: YTPlayer.isBackground ? "fixed" : "absolute",
                zIndex: YTPlayer.isBackground ? 10000 : 1000
            }).hide();
            var buttonBar = jQuery("<div/>").addClass("buttonBar");
            /* play/pause button*/
            var playpause = jQuery("<span>" + jQuery.mbYTPlayer.controls.play + "</span>").addClass("mb_YTPPlaypause ytpicon").click(function () {
                if (YTPlayer.player.getPlayerState() == 1) jQuery(YTPlayer).YTPPause();
                else jQuery(YTPlayer).YTPPlay();
            });
            /* mute/unmute button*/
            var MuteUnmute = jQuery("<span>" + jQuery.mbYTPlayer.controls.mute + "</span>").addClass("mb_YTPMuteUnmute ytpicon").click(function () {
                if (YTPlayer.player.getVolume() == 0) {
                    jQuery(YTPlayer).YTPUnmute();
                } else {
                    jQuery(YTPlayer).YTPMute();
                }
            });
            /* volume bar*/
            var volumeBar = jQuery("<div/>").addClass("mb_YTPVolumeBar").css({
                display: "inline-block"
            });
            YTPlayer.volumeBar = volumeBar;
            /* time elapsed */
            var idx = jQuery("<span/>").addClass("mb_YTPTime");
            var vURL = data.videoURL ? data.videoURL : "";
            if (vURL.indexOf("http") < 0) vURL = jQuery.mbYTPlayer.locationProtocol + "//www.youtube.com/watch?v=" + data.videoURL;
            var movieUrl = jQuery("<span/>").html(jQuery.mbYTPlayer.controls.ytLogo).addClass("mb_YTPUrl ytpicon").attr("title", "view on YouTube").on("click", function () {
                window.open(vURL, "viewOnYT")
            });
            var onlyVideo = jQuery("<span/>").html(jQuery.mbYTPlayer.controls.onlyYT).addClass("mb_OnlyYT ytpicon").on("click", function () {
                jQuery(YTPlayer).YTPFullscreen(data.realfullscreen);
            });
            var progressBar = jQuery("<div/>").addClass("mb_YTPProgress").css("position", "absolute").click(function (e) {
                timeBar.css({
                    width: (e.clientX - timeBar.offset().left)
                });
                YTPlayer.timeW = e.clientX - timeBar.offset().left;
                YTPlayer.controlBar.find(".mb_YTPLoaded").css({
                    width: 0
                });
                var totalTime = Math.floor(YTPlayer.player.getDuration());
                YTPlayer.goto = (timeBar.outerWidth() * totalTime) / progressBar.outerWidth();
                YTPlayer.player.seekTo(parseFloat(YTPlayer.goto), true);
                YTPlayer.controlBar.find(".mb_YTPLoaded").css({
                    width: 0
                });
            });
            var loadedBar = jQuery("<div/>").addClass("mb_YTPLoaded").css("position", "absolute");
            var timeBar = jQuery("<div/>").addClass("mb_YTPseekbar").css("position", "absolute");
            progressBar.append(loadedBar).append(timeBar);
            buttonBar.append(playpause).append(MuteUnmute).append(volumeBar).append(idx);
            if (data.showYTLogo) {
                buttonBar.append(movieUrl);
            }
            if (YTPlayer.isBackground || (eval(YTPlayer.opt.realfullscreen) && !YTPlayer.isBackground)) buttonBar.append(onlyVideo);
            YTPlayer.controlBar.append(buttonBar).append(progressBar);
            if (!YTPlayer.isBackground) {
                YTPlayer.controlBar.addClass("inlinePlayer");
                YTPlayer.wrapper.before(YTPlayer.controlBar);
            } else {
                jQuery("body").after(YTPlayer.controlBar);
            }
            volumeBar.simpleSlider({
                initialval: YTPlayer.opt.vol,
                scale: 100,
                orientation: "h",
                callback: function (el) {
                    if (el.value == 0) {
                        jQuery(YTPlayer).YTPMute();
                    } else {
                        jQuery(YTPlayer).YTPUnmute();
                    }
                    YTPlayer.player.setVolume(el.value);
                    if (!YTPlayer.isMute) YTPlayer.opt.vol = el.value;
                }
            });
        },
        /**
         *
         *
         * */
        checkForState: function (YTPlayer) {
            var interval = YTPlayer.opt.showControls ? 100 : 700;
            clearInterval(YTPlayer.getState);
            //Checking if player has been removed from scene
            if (!jQuery.contains(document, YTPlayer)) {
                jQuery(YTPlayer).YTPPlayerDestroy();
                clearInterval(YTPlayer.getState);
                clearInterval(YTPlayer.checkForStartAt);
                return;
            }
            jQuery.mbYTPlayer.checkForStart(YTPlayer);
            YTPlayer.getState = setInterval(function () {
                var prog = jQuery(YTPlayer).YTPManageProgress();
                var $YTPlayer = jQuery(YTPlayer);
                var data = YTPlayer.opt;
                var startAt = YTPlayer.opt.startAt ? YTPlayer.opt.startAt : 0;
                var stopAt = YTPlayer.opt.stopAt > YTPlayer.opt.startAt ? YTPlayer.opt.stopAt : 0;
                stopAt = stopAt < YTPlayer.player.getDuration() ? stopAt : 0;
                if (YTPlayer.player.time != prog.currentTime) {
                    var YTPEvent = jQuery.Event("YTPTime");
                    YTPEvent.time = YTPlayer.player.time;
                    jQuery(YTPlayer).trigger(YTPEvent);
                }
                YTPlayer.player.time = prog.currentTime;
                if (YTPlayer.player.getVolume() == 0) $YTPlayer.addClass("isMuted");
                else $YTPlayer.removeClass("isMuted");
                if (YTPlayer.opt.showControls)
                    if (prog.totalTime) {
                        YTPlayer.controlBar.find(".mb_YTPTime").html(jQuery.mbYTPlayer.formatTime(prog.currentTime) + " / " + jQuery.mbYTPlayer.formatTime(prog.totalTime));
                    } else {
                        YTPlayer.controlBar.find(".mb_YTPTime").html("-- : -- / -- : --");
                    }
                if (eval(YTPlayer.opt.stopMovieOnBlur))
                    if (!document.hasFocus()) {
                        if (YTPlayer.state == 1) {
                            YTPlayer.hasFocus = false;
                            $YTPlayer.YTPPause();
                        }
                    } else if (document.hasFocus() && !YTPlayer.hasFocus && !(YTPlayer.state == -1 || YTPlayer.state == 0)) {
                        YTPlayer.hasFocus = true;
                        $YTPlayer.YTPPlay();
                    }
                if (YTPlayer.controlBar && YTPlayer.controlBar.outerWidth() <= 400 && !YTPlayer.isCompact) {
                    YTPlayer.controlBar.addClass("compact");
                    YTPlayer.isCompact = true;
                    if (!YTPlayer.isMute && YTPlayer.volumeBar) YTPlayer.volumeBar.updateSliderVal(YTPlayer.opt.vol);
                } else if (YTPlayer.controlBar && YTPlayer.controlBar.outerWidth() > 400 && YTPlayer.isCompact) {
                    YTPlayer.controlBar.removeClass("compact");
                    YTPlayer.isCompact = false;
                    if (!YTPlayer.isMute && YTPlayer.volumeBar) YTPlayer.volumeBar.updateSliderVal(YTPlayer.opt.vol);
                }
                if (YTPlayer.player.getPlayerState() == 1 && (parseFloat(YTPlayer.player.getDuration() - 1.5) < YTPlayer.player.getCurrentTime() || (stopAt > 0 && parseFloat(YTPlayer.player.getCurrentTime()) > stopAt))) {
                    if (YTPlayer.isEnded) return;
                    YTPlayer.isEnded = true;
                    setTimeout(function () {
                        YTPlayer.isEnded = false
                    }, 1000);
                    if (YTPlayer.isPlayList) {
                        clearInterval(YTPlayer.getState);
                        var YTPEnd = jQuery.Event("YTPEnd");
                        YTPEnd.time = YTPlayer.player.time;
                        jQuery(YTPlayer).trigger(YTPEnd);
                        return;
                    } else if (!data.loop) {
                        YTPlayer.player.pauseVideo();
                        YTPlayer.wrapper.CSSAnimate({
                            opacity: 0
                        }, 1000, function () {
                            var YTPEnd = jQuery.Event("YTPEnd");
                            YTPEnd.time = YTPlayer.player.time;
                            jQuery(YTPlayer).trigger(YTPEnd);
                            YTPlayer.player.seekTo(startAt, true);
                            if (!YTPlayer.isBackground) {
                                YTPlayer.opt.containment.css({
                                    background: "rgba(0,0,0,0.5) url(" + YTPlayer.opt.backgroundUrl + ") center center",
                                    backgroundSize: "cover"
                                });
                            }
                        });
                    } else {

                        startAt = startAt || 1;

                        YTPlayer.player.pauseVideo();
                        YTPlayer.player.seekTo(startAt, true);
                        $YTPlayer.YTPPlay();

                    }
                }
            }, interval);
        },
        /**
         *
         * */
        checkForStart: function (YTPlayer) {
            var $YTPlayer = jQuery(YTPlayer);
            //Checking if player has been removed from scene
            if (!jQuery.contains(document, YTPlayer)) {
                jQuery(YTPlayer).YTPPlayerDestroy();
                return
            }
            if (jQuery.browser.chrome) YTPlayer.opt.quality = "default";
            YTPlayer.player.pauseVideo();
            jQuery(YTPlayer).muteYTPVolume();
            jQuery("#controlBar_" + YTPlayer.id).remove();
            if (YTPlayer.opt.showControls) jQuery.mbYTPlayer.buildControls(YTPlayer);
            if (YTPlayer.opt.addRaster) {
                var classN = YTPlayer.opt.addRaster == "dot" ? "raster-dot" : "raster";
                YTPlayer.overlay.addClass(YTPlayer.isRetina ? classN + " retina" : classN);
            } else {
                YTPlayer.overlay.removeClass(function (index, classNames) {
                    // change the list into an array
                    var current_classes = classNames.split(" "),
                            // array of classes which are to be removed
                            classes_to_remove = [];
                    jQuery.each(current_classes, function (index, class_name) {
                        // if the classname begins with bg add it to the classes_to_remove array
                        if (/raster.*/.test(class_name)) {
                            classes_to_remove.push(class_name);
                        }
                    });
                    classes_to_remove.push("retina");
                    // turn the array back into a string
                    return classes_to_remove.join(" ");
                })
            }
            YTPlayer.checkForStartAt = setInterval(function () {
                jQuery(YTPlayer).YTPMute();
                var startAt = YTPlayer.opt.startAt ? YTPlayer.opt.startAt : 1;
                var canPlayVideo = (YTPlayer.player.getVideoLoadedFraction() > startAt / YTPlayer.player.getDuration());
                if (YTPlayer.player.getDuration() > 0 && YTPlayer.player.getCurrentTime() >= startAt && canPlayVideo) {
                    clearInterval(YTPlayer.checkForStartAt);
                    YTPlayer.isReady = true;
                    if (typeof YTPlayer.opt.onReady == "function") YTPlayer.opt.onReady(YTPlayer);
                    var YTPready = jQuery.Event("YTPReady");
                    jQuery(YTPlayer).trigger(YTPready);
                    YTPlayer.player.pauseVideo();
                    if (!YTPlayer.opt.mute) jQuery(YTPlayer).YTPUnmute();
                    YTPlayer.canTrigger = true;
                    if (YTPlayer.opt.autoPlay) {
                        $YTPlayer.YTPPlay();
                        $YTPlayer.css("background-image", "none");
                        jQuery(YTPlayer.playerEl).CSSAnimate({
                            opacity: 1
                        }, 1000);
                        YTPlayer.wrapper.CSSAnimate({
                            opacity: YTPlayer.isAlone ? 1 : YTPlayer.opt.opacity
                        }, 1000);
                    } else {
                        YTPlayer.player.pauseVideo();
                        if (!YTPlayer.isPlayer) {
                            jQuery(YTPlayer.playerEl).CSSAnimate({
                                opacity: 1
                            }, 1000);
                            YTPlayer.wrapper.CSSAnimate({
                                opacity: YTPlayer.isAlone ? 1 : YTPlayer.opt.opacity
                            }, 1000);
                        }
                    }
                    if (YTPlayer.isPlayer && !YTPlayer.opt.autoPlay) {
                        YTPlayer.loading.html("Ready");
                        setTimeout(function () {
                            YTPlayer.loading.fadeOut();


                        }, 100)
                    }
                    if (YTPlayer.controlBar) YTPlayer.controlBar.slideDown(1000);
                } else {
                    //YTPlayer.player.playVideo();
                    if (startAt >= 0) YTPlayer.player.seekTo(startAt, true);
                }
            }, 1000);
        },
        /**
         *
         * @param s
         * @returns {string}
         */
        formatTime: function (s) {
            var min = Math.floor(s / 60);
            var sec = Math.floor(s - (60 * min));
            return (min <= 9 ? "0" + min : min) + " : " + (sec <= 9 ? "0" + sec : sec);
        }
    };
    /**
     *
     * @returns {boolean}
     */
    jQuery.fn.toggleVolume = function () {
        var YTPlayer = this.get(0);
        if (!YTPlayer) return;
        if (YTPlayer.player.isMuted()) {
            jQuery(YTPlayer).YTPUnmute();
            return true;
        } else {
            jQuery(YTPlayer).YTPMute();
            return false;
        }
    };
    /**
     *
     */
    jQuery.fn.optimizeDisplay = function () {
        var YTPlayer = this.get(0);
        var data = YTPlayer.opt;
        var playerBox = jQuery(YTPlayer.playerEl);
        var win = {};
        var el = YTPlayer.wrapper;
        win.width = el.outerWidth();
        win.height = el.outerHeight();
        var margin = 24;
        var overprint = 100;
        var vid = {};
        if (data.optimizeDisplay) {
            vid.width = win.width + ((win.width * margin) / 100);
            vid.height = data.ratio == "16/9" ? Math.ceil((9 * win.width) / 16) : Math.ceil((3 * win.width) / 4);
            vid.marginTop = -((vid.height - win.height) / 2);
            vid.marginLeft = -((win.width * (margin / 2)) / 100);
            if (vid.height < win.height) {
                vid.height = win.height + ((win.height * margin) / 100);
                vid.width = data.ratio == "16/9" ? Math.floor((16 * win.height) / 9) : Math.floor((4 * win.height) / 3);
                vid.marginTop = -((win.height * (margin / 2)) / 100);
                vid.marginLeft = -((vid.width - win.width) / 2);
            }
            vid.width += overprint;
            vid.height += overprint;
            vid.marginTop -= overprint / 2;
            vid.marginLeft -= overprint / 2;
        } else {
            vid.width = "100%";
            vid.height = "100%";
            vid.marginTop = 0;
            vid.marginLeft = 0;
        }
        playerBox.css({
            width: vid.width,
            height: vid.height,
            marginTop: vid.marginTop,
            marginLeft: vid.marginLeft
        });
    };
    /**
     *
     * @param arr
     * @returns {Array|string|Blob|*}
     *
     */
    jQuery.shuffle = function (arr) {
        var newArray = arr.slice();
        var len = newArray.length;
        var i = len;
        while (i--) {
            var p = parseInt(Math.random() * len);
            var t = newArray[i];
            newArray[i] = newArray[p];
            newArray[p] = t;
        }
        return newArray;
    };

    /* Exposed public method */
    jQuery.fn.YTPlayer = jQuery.mbYTPlayer.buildPlayer;
    jQuery.fn.YTPGetPlayer = jQuery.mbYTPlayer.getPlayer;
    jQuery.fn.YTPGetVideoID = jQuery.mbYTPlayer.getVideoID;
    jQuery.fn.YTPChangeMovie = jQuery.mbYTPlayer.changeMovie;
    jQuery.fn.YTPPlayerDestroy = jQuery.mbYTPlayer.playerDestroy;

    jQuery.fn.YTPPlay = jQuery.mbYTPlayer.play;
    jQuery.fn.YTPTogglePlay = jQuery.mbYTPlayer.togglePlay;
    jQuery.fn.YTPStop = jQuery.mbYTPlayer.stop;
    jQuery.fn.YTPPause = jQuery.mbYTPlayer.pause;
    jQuery.fn.YTPSeekTo = jQuery.mbYTPlayer.seekTo;

    jQuery.fn.YTPlaylist = jQuery.mbYTPlayer.playlist;
    jQuery.fn.YTPPlayNext = jQuery.mbYTPlayer.playNext;
    jQuery.fn.YTPPlayPrev = jQuery.mbYTPlayer.playPrev;

    jQuery.fn.YTPMute = jQuery.mbYTPlayer.mute;
    jQuery.fn.YTPUnmute = jQuery.mbYTPlayer.unmute;
    jQuery.fn.YTPToggleVolume = jQuery.mbYTPlayer.toggleVolume;
    jQuery.fn.YTPSetVolume = jQuery.mbYTPlayer.setVolume;

    jQuery.fn.YTPGetVideoData = jQuery.mbYTPlayer.getVideoData;
    jQuery.fn.YTPFullscreen = jQuery.mbYTPlayer.fullscreen;
    jQuery.fn.YTPToggleLoops = jQuery.mbYTPlayer.toggleLoops;
    jQuery.fn.YTPSetVideoQuality = jQuery.mbYTPlayer.setVideoQuality;
    jQuery.fn.YTPManageProgress = jQuery.mbYTPlayer.manageProgress;

    jQuery.fn.YTPApplyFilter = jQuery.mbYTPlayer.applyFilter;
    jQuery.fn.YTPApplyFilters = jQuery.mbYTPlayer.applyFilters;
    jQuery.fn.YTPToggleFilter = jQuery.mbYTPlayer.toggleFilter;
    jQuery.fn.YTPToggleFilters = jQuery.mbYTPlayer.toggleFilters;
    jQuery.fn.YTPRemoveFilter = jQuery.mbYTPlayer.removeFilter;
    jQuery.fn.YTPDisableFilters = jQuery.mbYTPlayer.disableFilters;
    jQuery.fn.YTPEnableFilters = jQuery.mbYTPlayer.enableFilters;


    /**
     *
     * @deprecated
     *
     **/
    jQuery.fn.mb_YTPlayer = jQuery.mbYTPlayer.buildPlayer;
    jQuery.fn.playNext = jQuery.mbYTPlayer.playNext;
    jQuery.fn.playPrev = jQuery.mbYTPlayer.playPrev;
    jQuery.fn.changeMovie = jQuery.mbYTPlayer.changeMovie;
    jQuery.fn.getVideoID = jQuery.mbYTPlayer.getVideoID;
    jQuery.fn.getPlayer = jQuery.mbYTPlayer.getPlayer;
    jQuery.fn.playerDestroy = jQuery.mbYTPlayer.playerDestroy;
    jQuery.fn.fullscreen = jQuery.mbYTPlayer.fullscreen;
    jQuery.fn.buildYTPControls = jQuery.mbYTPlayer.buildControls;
    jQuery.fn.playYTP = jQuery.mbYTPlayer.play;
    jQuery.fn.toggleLoops = jQuery.mbYTPlayer.toggleLoops;
    jQuery.fn.stopYTP = jQuery.mbYTPlayer.stop;
    jQuery.fn.pauseYTP = jQuery.mbYTPlayer.pause;
    jQuery.fn.seekToYTP = jQuery.mbYTPlayer.seekTo;
    jQuery.fn.muteYTPVolume = jQuery.mbYTPlayer.mute;
    jQuery.fn.unmuteYTPVolume = jQuery.mbYTPlayer.unmute;
    jQuery.fn.setYTPVolume = jQuery.mbYTPlayer.setVolume;
    jQuery.fn.setVideoQuality = jQuery.mbYTPlayer.setVideoQuality;
    jQuery.fn.manageYTPProgress = jQuery.mbYTPlayer.manageProgress;
    jQuery.fn.YTPGetDataFromFeed = jQuery.mbYTPlayer.getVideoData;


})(jQuery, ytp);
;
/*
 * ******************************************************************************
 *  jquery.mb.components
 *  file: jquery.mb.CSSAnimate.min.js
 *
 *  Copyright (c) 2001-2014. Matteo Bicocchi (Pupunzi);
 *  Open lab srl, Firenze - Italy
 *  email: matteo@open-lab.com
 *  site: 	http://pupunzi.com
 *  blog:	http://pupunzi.open-lab.com
 * 	http://open-lab.com
 *
 *  Licences: MIT, GPL
 *  http://www.opensource.org/licenses/mit-license.php
 *  http://www.gnu.org/licenses/gpl.html
 *
 *  last modified: 26/03/14 21.40
 *  *****************************************************************************
 */

function uncamel(a) { return a.replace(/([A-Z])/g, function (a) { return "-" + a.toLowerCase() }) } function setUnit(a, b) { return "string" != typeof a || a.match(/^[\-0-9\.]+jQuery/) ? "" + a + b : a } function setFilter(a, b, c) { var d = uncamel(b), e = jQuery.browser.mozilla ? "" : jQuery.CSS.sfx; a[e + "filter"] = a[e + "filter"] || "", c = setUnit(c > jQuery.CSS.filters[b].max ? jQuery.CSS.filters[b].max : c, jQuery.CSS.filters[b].unit), a[e + "filter"] += d + "(" + c + ") ", delete a[b] } jQuery.support.CSStransition = function () { var a = document.body || document.documentElement, b = a.style; return void 0 !== b.transition || void 0 !== b.WebkitTransition || void 0 !== b.MozTransition || void 0 !== b.MsTransition || void 0 !== b.OTransition }(), jQuery.CSS = { name: "mb.CSSAnimate", author: "Matteo Bicocchi", version: "2.0.0", transitionEnd: "transitionEnd", sfx: "", filters: { blur: { min: 0, max: 100, unit: "px" }, brightness: { min: 0, max: 400, unit: "%" }, contrast: { min: 0, max: 400, unit: "%" }, grayscale: { min: 0, max: 100, unit: "%" }, hueRotate: { min: 0, max: 360, unit: "deg" }, invert: { min: 0, max: 100, unit: "%" }, saturate: { min: 0, max: 400, unit: "%" }, sepia: { min: 0, max: 100, unit: "%" } }, normalizeCss: function (a) { var b = jQuery.extend(!0, {}, a); jQuery.browser.webkit || jQuery.browser.opera ? jQuery.CSS.sfx = "-webkit-" : jQuery.browser.mozilla ? jQuery.CSS.sfx = "-moz-" : jQuery.browser.msie && (jQuery.CSS.sfx = "-ms-"); for (var c in b) { "transform" === c && (b[jQuery.CSS.sfx + "transform"] = b[c], delete b[c]), "transform-origin" === c && (b[jQuery.CSS.sfx + "transform-origin"] = a[c], delete b[c]), "filter" !== c || jQuery.browser.mozilla || (b[jQuery.CSS.sfx + "filter"] = a[c], delete b[c]), "blur" === c && setFilter(b, "blur", a[c]), "brightness" === c && setFilter(b, "brightness", a[c]), "contrast" === c && setFilter(b, "contrast", a[c]), "grayscale" === c && setFilter(b, "grayscale", a[c]), "hueRotate" === c && setFilter(b, "hueRotate", a[c]), "invert" === c && setFilter(b, "invert", a[c]), "saturate" === c && setFilter(b, "saturate", a[c]), "sepia" === c && setFilter(b, "sepia", a[c]); var d = ""; "x" === c && (d = jQuery.CSS.sfx + "transform", b[d] = b[d] || "", b[d] += " translateX(" + setUnit(a[c], "px") + ")", delete b[c]), "y" === c && (d = jQuery.CSS.sfx + "transform", b[d] = b[d] || "", b[d] += " translateY(" + setUnit(a[c], "px") + ")", delete b[c]), "z" === c && (d = jQuery.CSS.sfx + "transform", b[d] = b[d] || "", b[d] += " translateZ(" + setUnit(a[c], "px") + ")", delete b[c]), "rotate" === c && (d = jQuery.CSS.sfx + "transform", b[d] = b[d] || "", b[d] += " rotate(" + setUnit(a[c], "deg") + ")", delete b[c]), "rotateX" === c && (d = jQuery.CSS.sfx + "transform", b[d] = b[d] || "", b[d] += " rotateX(" + setUnit(a[c], "deg") + ")", delete b[c]), "rotateY" === c && (d = jQuery.CSS.sfx + "transform", b[d] = b[d] || "", b[d] += " rotateY(" + setUnit(a[c], "deg") + ")", delete b[c]), "rotateZ" === c && (d = jQuery.CSS.sfx + "transform", b[d] = b[d] || "", b[d] += " rotateZ(" + setUnit(a[c], "deg") + ")", delete b[c]), "scale" === c && (d = jQuery.CSS.sfx + "transform", b[d] = b[d] || "", b[d] += " scale(" + setUnit(a[c], "") + ")", delete b[c]), "scaleX" === c && (d = jQuery.CSS.sfx + "transform", b[d] = b[d] || "", b[d] += " scaleX(" + setUnit(a[c], "") + ")", delete b[c]), "scaleY" === c && (d = jQuery.CSS.sfx + "transform", b[d] = b[d] || "", b[d] += " scaleY(" + setUnit(a[c], "") + ")", delete b[c]), "scaleZ" === c && (d = jQuery.CSS.sfx + "transform", b[d] = b[d] || "", b[d] += " scaleZ(" + setUnit(a[c], "") + ")", delete b[c]), "skew" === c && (d = jQuery.CSS.sfx + "transform", b[d] = b[d] || "", b[d] += " skew(" + setUnit(a[c], "deg") + ")", delete b[c]), "skewX" === c && (d = jQuery.CSS.sfx + "transform", b[d] = b[d] || "", b[d] += " skewX(" + setUnit(a[c], "deg") + ")", delete b[c]), "skewY" === c && (d = jQuery.CSS.sfx + "transform", b[d] = b[d] || "", b[d] += " skewY(" + setUnit(a[c], "deg") + ")", delete b[c]), "perspective" === c && (d = jQuery.CSS.sfx + "transform", b[d] = b[d] || "", b[d] += " perspective(" + setUnit(a[c], "px") + ")", delete b[c]) } return b }, getProp: function (a) { var b = []; for (var c in a) b.indexOf(c) < 0 && b.push(uncamel(c)); return b.join(",") }, animate: function (a, b, c, d, e) { return this.each(function () { function o() { f.called = !0, f.CSSAIsRunning = !1, g.off(jQuery.CSS.transitionEnd + "." + f.id), clearTimeout(f.timeout), g.css(jQuery.CSS.sfx + "transition", ""), "function" == typeof e && e.apply(f), "function" == typeof f.CSSqueue && (f.CSSqueue(), f.CSSqueue = null) } var f = this, g = jQuery(this); f.id = f.id || "CSSA_" + (new Date).getTime(); var h = h || { type: "noEvent" }; if (f.CSSAIsRunning && f.eventType == h.type && !jQuery.browser.msie && jQuery.browser.version <= 9) return f.CSSqueue = function () { g.CSSAnimate(a, b, c, d, e) }, void 0; if (f.CSSqueue = null, f.eventType = h.type, 0 !== g.length && a) { if (a = jQuery.normalizeCss(a), f.CSSAIsRunning = !0, "function" == typeof b && (e = b, b = jQuery.fx.speeds._default), "function" == typeof c && (d = c, c = 0), "string" == typeof c && (e = c, c = 0), "function" == typeof d && (e = d, d = "cubic-bezier(0.65,0.03,0.36,0.72)"), "string" == typeof b) for (var i in jQuery.fx.speeds) { if (b == i) { b = jQuery.fx.speeds[i]; break } b = jQuery.fx.speeds._default } if (b || (b = jQuery.fx.speeds._default), "string" == typeof e && (d = e, e = null), !jQuery.support.CSStransition) { for (var j in a) { if ("transform" === j && delete a[j], "filter" === j && delete a[j], "transform-origin" === j && delete a[j], "auto" === a[j] && delete a[j], "x" === j) { var k = a[j], l = "left"; a[l] = k, delete a[j] } if ("y" === j) { var k = a[j], l = "top"; a[l] = k, delete a[j] } ("-ms-transform" === j || "-ms-filter" === j) && delete a[j] } return g.delay(c).animate(a, b, e), void 0 } var m = { "default": "ease", "in": "ease-in", out: "ease-out", "in-out": "ease-in-out", snap: "cubic-bezier(0,1,.5,1)", easeOutCubic: "cubic-bezier(.215,.61,.355,1)", easeInOutCubic: "cubic-bezier(.645,.045,.355,1)", easeInCirc: "cubic-bezier(.6,.04,.98,.335)", easeOutCirc: "cubic-bezier(.075,.82,.165,1)", easeInOutCirc: "cubic-bezier(.785,.135,.15,.86)", easeInExpo: "cubic-bezier(.95,.05,.795,.035)", easeOutExpo: "cubic-bezier(.19,1,.22,1)", easeInOutExpo: "cubic-bezier(1,0,0,1)", easeInQuad: "cubic-bezier(.55,.085,.68,.53)", easeOutQuad: "cubic-bezier(.25,.46,.45,.94)", easeInOutQuad: "cubic-bezier(.455,.03,.515,.955)", easeInQuart: "cubic-bezier(.895,.03,.685,.22)", easeOutQuart: "cubic-bezier(.165,.84,.44,1)", easeInOutQuart: "cubic-bezier(.77,0,.175,1)", easeInQuint: "cubic-bezier(.755,.05,.855,.06)", easeOutQuint: "cubic-bezier(.23,1,.32,1)", easeInOutQuint: "cubic-bezier(.86,0,.07,1)", easeInSine: "cubic-bezier(.47,0,.745,.715)", easeOutSine: "cubic-bezier(.39,.575,.565,1)", easeInOutSine: "cubic-bezier(.445,.05,.55,.95)", easeInBack: "cubic-bezier(.6,-.28,.735,.045)", easeOutBack: "cubic-bezier(.175, .885,.32,1.275)", easeInOutBack: "cubic-bezier(.68,-.55,.265,1.55)" }; m[d] && (d = m[d]), g.off(jQuery.CSS.transitionEnd + "." + f.id); var n = jQuery.CSS.getProp(a), p = {}; jQuery.extend(p, a), p[jQuery.CSS.sfx + "transition-property"] = n, p[jQuery.CSS.sfx + "transition-duration"] = b + "ms", p[jQuery.CSS.sfx + "transition-delay"] = c + "ms", p[jQuery.CSS.sfx + "transition-timing-function"] = d, setTimeout(function () { g.one(jQuery.CSS.transitionEnd + "." + f.id, o), g.css(p) }, 1), f.timeout = setTimeout(function () { return f.called || !e ? (f.called = !1, f.CSSAIsRunning = !1, void 0) : (g.css(jQuery.CSS.sfx + "transition", ""), e.apply(f), f.CSSAIsRunning = !1, "function" == typeof f.CSSqueue && (f.CSSqueue(), f.CSSqueue = null), void 0) }, b + c + 10) } }) } }, jQuery.fn.CSSAnimate = jQuery.CSS.animate, jQuery.normalizeCss = jQuery.CSS.normalizeCss, jQuery.fn.css3 = function (a) { return this.each(function () { var b = jQuery(this), c = jQuery.normalizeCss(a); b.css(c) }) };
;
var nAgt = navigator.userAgent; if (!jQuery.browser) { jQuery.browser = {}, jQuery.browser.mozilla = !1, jQuery.browser.webkit = !1, jQuery.browser.opera = !1, jQuery.browser.safari = !1, jQuery.browser.chrome = !1, jQuery.browser.msie = !1, jQuery.browser.ua = nAgt, jQuery.browser.name = navigator.appName, jQuery.browser.fullVersion = "" + parseFloat(navigator.appVersion), jQuery.browser.majorVersion = parseInt(navigator.appVersion, 10); var nameOffset, verOffset, ix; if (-1 != (verOffset = nAgt.indexOf("Opera"))) jQuery.browser.opera = !0, jQuery.browser.name = "Opera", jQuery.browser.fullVersion = nAgt.substring(verOffset + 6), -1 != (verOffset = nAgt.indexOf("Version")) && (jQuery.browser.fullVersion = nAgt.substring(verOffset + 8)); else if (-1 != (verOffset = nAgt.indexOf("OPR"))) jQuery.browser.opera = !0, jQuery.browser.name = "Opera", jQuery.browser.fullVersion = nAgt.substring(verOffset + 4); else if (-1 != (verOffset = nAgt.indexOf("MSIE"))) jQuery.browser.msie = !0, jQuery.browser.name = "Microsoft Internet Explorer", jQuery.browser.fullVersion = nAgt.substring(verOffset + 5); else if (-1 != nAgt.indexOf("Trident")) { jQuery.browser.msie = !0, jQuery.browser.name = "Microsoft Internet Explorer"; var start = nAgt.indexOf("rv:") + 3, end = start + 4; jQuery.browser.fullVersion = nAgt.substring(start, end) } else -1 != (verOffset = nAgt.indexOf("Chrome")) ? (jQuery.browser.webkit = !0, jQuery.browser.chrome = !0, jQuery.browser.name = "Chrome", jQuery.browser.fullVersion = nAgt.substring(verOffset + 7)) : -1 != (verOffset = nAgt.indexOf("Safari")) ? (jQuery.browser.webkit = !0, jQuery.browser.safari = !0, jQuery.browser.name = "Safari", jQuery.browser.fullVersion = nAgt.substring(verOffset + 7), -1 != (verOffset = nAgt.indexOf("Version")) && (jQuery.browser.fullVersion = nAgt.substring(verOffset + 8))) : -1 != (verOffset = nAgt.indexOf("AppleWebkit")) ? (jQuery.browser.webkit = !0, jQuery.browser.name = "Safari", jQuery.browser.fullVersion = nAgt.substring(verOffset + 7), -1 != (verOffset = nAgt.indexOf("Version")) && (jQuery.browser.fullVersion = nAgt.substring(verOffset + 8))) : -1 != (verOffset = nAgt.indexOf("Firefox")) ? (jQuery.browser.mozilla = !0, jQuery.browser.name = "Firefox", jQuery.browser.fullVersion = nAgt.substring(verOffset + 8)) : (nameOffset = nAgt.lastIndexOf(" ") + 1) < (verOffset = nAgt.lastIndexOf("/")) && (jQuery.browser.name = nAgt.substring(nameOffset, verOffset), jQuery.browser.fullVersion = nAgt.substring(verOffset + 1), jQuery.browser.name.toLowerCase() == jQuery.browser.name.toUpperCase() && (jQuery.browser.name = navigator.appName)); -1 != (ix = jQuery.browser.fullVersion.indexOf(";")) && (jQuery.browser.fullVersion = jQuery.browser.fullVersion.substring(0, ix)), -1 != (ix = jQuery.browser.fullVersion.indexOf(" ")) && (jQuery.browser.fullVersion = jQuery.browser.fullVersion.substring(0, ix)), jQuery.browser.majorVersion = parseInt("" + jQuery.browser.fullVersion, 10), isNaN(jQuery.browser.majorVersion) && (jQuery.browser.fullVersion = "" + parseFloat(navigator.appVersion), jQuery.browser.majorVersion = parseInt(navigator.appVersion, 10)), jQuery.browser.version = jQuery.browser.majorVersion } jQuery.browser.android = /Android/i.test(nAgt), jQuery.browser.blackberry = /BlackBerry|BB|PlayBook/i.test(nAgt), jQuery.browser.ios = /iPhone|iPad|iPod|webOS/i.test(nAgt), jQuery.browser.operaMobile = /Opera Mini/i.test(nAgt), jQuery.browser.windowsMobile = /IEMobile|Windows Phone/i.test(nAgt), jQuery.browser.kindle = /Kindle|Silk/i.test(nAgt), jQuery.browser.mobile = jQuery.browser.android || jQuery.browser.blackberry || jQuery.browser.ios || jQuery.browser.windowsMobile || jQuery.browser.operaMobile || jQuery.browser.kindle, jQuery.isMobile = jQuery.browser.mobile, jQuery.isTablet = jQuery.browser.mobile && jQuery(window).width() > 765, jQuery.isAndroidDefault = jQuery.browser.android && !/chrome/i.test(nAgt);
;/*___________________________________________________________________________________________________________________________________________________
 _ jquery.mb.components                                                                                                                             _
 _                                                                                                                                                  _
 _ file: jquery.mb.simpleSlider.min.js                                                                                                              _
 _ last modified: 16/05/15 23.45                                                                                                                    _
 _                                                                                                                                                  _
 _ Open Lab s.r.l., Florence - Italy                                                                                                                _
 _                                                                                                                                                  _
 _ email: matteo@open-lab.com                                                                                                                       _
 _ site: http://pupunzi.com                                                                                                                         _
 _       http://open-lab.com                                                                                                                        _
 _ blog: http://pupunzi.open-lab.com                                                                                                                _
 _ Q&A:  http://jquery.pupunzi.com                                                                                                                  _
 _                                                                                                                                                  _
 _ Licences: MIT, GPL                                                                                                                               _
 _    http://www.opensource.org/licenses/mit-license.php                                                                                            _
 _    http://www.gnu.org/licenses/gpl.html                                                                                                          _
 _                                                                                                                                                  _
 _ Copyright (c) 2001-2015. Matteo Bicocchi (Pupunzi);                                                                                              _
 ___________________________________________________________________________________________________________________________________________________*/

!function (a) { /iphone|ipod|ipad|android|ie|blackberry|fennec/.test(navigator.userAgent.toLowerCase()); var c = "ontouchstart" in window || window.navigator && window.navigator.msPointerEnabled && window.MSGesture || window.DocumentTouch && document instanceof DocumentTouch || !1; a.simpleSlider = { defaults: { initialval: 0, scale: 100, orientation: "h", readonly: !1, callback: !1 }, events: { start: c ? "touchstart" : "mousedown", end: c ? "touchend" : "mouseup", move: c ? "touchmove" : "mousemove" }, init: function (b) { return this.each(function () { var d = this, e = a(d); e.addClass("simpleSlider"), d.opt = {}, a.extend(d.opt, a.simpleSlider.defaults, b), a.extend(d.opt, e.data()); var f = "h" == d.opt.orientation ? "horizontal" : "vertical", g = a("<div/>").addClass("level").addClass(f); e.prepend(g), d.level = g, e.css({ cursor: "default" }), "auto" == d.opt.scale && (d.opt.scale = a(d).outerWidth()), e.updateSliderVal(), d.opt.readonly || (e.on(a.simpleSlider.events.start, function (a) { c && (a = a.changedTouches[0]), d.canSlide = !0, e.updateSliderVal(a), e.css({ cursor: "col-resize" }), a.preventDefault(), a.stopPropagation() }), a(document).on(a.simpleSlider.events.move, function (b) { c && (b = b.changedTouches[0]), d.canSlide && (a(document).css({ cursor: "default" }), e.updateSliderVal(b), b.preventDefault(), b.stopPropagation()) }).on(a.simpleSlider.events.end, function () { a(document).css({ cursor: "auto" }), d.canSlide = !1, e.css({ cursor: "auto" }) })) }) }, updateSliderVal: function (b) { function g(a, b) { return Math.floor(100 * a / b) } var c = this, d = c.get(0); d.opt.initialval = "number" == typeof d.opt.initialval ? d.opt.initialval : d.opt.initialval(d); var e = a(d).outerWidth(), f = a(d).outerHeight(); d.x = "object" == typeof b ? b.clientX + document.body.scrollLeft - c.offset().left : "number" == typeof b ? b * e / d.opt.scale : d.opt.initialval * e / d.opt.scale, d.y = "object" == typeof b ? b.clientY + document.body.scrollTop - c.offset().top : "number" == typeof b ? (d.opt.scale - d.opt.initialval - b) * f / d.opt.scale : d.opt.initialval * f / d.opt.scale, d.y = c.outerHeight() - d.y, d.scaleX = d.x * d.opt.scale / e, d.scaleY = d.y * d.opt.scale / f, d.outOfRangeX = d.scaleX > d.opt.scale ? d.scaleX - d.opt.scale : d.scaleX < 0 ? d.scaleX : 0, d.outOfRangeY = d.scaleY > d.opt.scale ? d.scaleY - d.opt.scale : d.scaleY < 0 ? d.scaleY : 0, d.outOfRange = "h" == d.opt.orientation ? d.outOfRangeX : d.outOfRangeY, d.value = "undefined" != typeof b ? "h" == d.opt.orientation ? d.x >= c.outerWidth() ? d.opt.scale : d.x <= 0 ? 0 : d.scaleX : d.y >= c.outerHeight() ? d.opt.scale : d.y <= 0 ? 0 : d.scaleY : "h" == d.opt.orientation ? d.scaleX : d.scaleY, "h" == d.opt.orientation ? d.level.width(g(d.x, e) + "%") : d.level.height(g(d.y, f)), "function" == typeof d.opt.callback && d.opt.callback(d) } }, a.fn.simpleSlider = a.simpleSlider.init, a.fn.updateSliderVal = a.simpleSlider.updateSliderVal }(jQuery);
;/*___________________________________________________________________________________________________________________________________________________
 _ jquery.mb.components                                                                                                                             _
 _                                                                                                                                                  _
 _ file: jquery.mb.storage.min.js                                                                                                                   _
 _ last modified: 24/05/15 16.08                                                                                                                    _
 _                                                                                                                                                  _
 _ Open Lab s.r.l., Florence - Italy                                                                                                                _
 _                                                                                                                                                  _
 _ email: matteo@open-lab.com                                                                                                                       _
 _ site: http://pupunzi.com                                                                                                                         _
 _       http://open-lab.com                                                                                                                        _
 _ blog: http://pupunzi.open-lab.com                                                                                                                _
 _ Q&A:  http://jquery.pupunzi.com                                                                                                                  _
 _                                                                                                                                                  _
 _ Licences: MIT, GPL                                                                                                                               _
 _    http://www.opensource.org/licenses/mit-license.php                                                                                            _
 _    http://www.gnu.org/licenses/gpl.html                                                                                                          _
 _                                                                                                                                                  _
 _ Copyright (c) 2001-2015. Matteo Bicocchi (Pupunzi);                                                                                              _
 ___________________________________________________________________________________________________________________________________________________*/

!function (a) { a.mbCookie = { set: function (a, b, c, d) { b = JSON.stringify(b), c || (c = 7), d = d ? "; domain=" + d : ""; var f, e = new Date; e.setTime(e.getTime() + 1e3 * 60 * 60 * 24 * c), f = "; expires=" + e.toGMTString(), document.cookie = a + "=" + b + f + "; path=/" + d }, get: function (a) { for (var b = a + "=", c = document.cookie.split(";"), d = 0; d < c.length; d++) { for (var e = c[d]; " " == e.charAt(0) ;) e = e.substring(1, e.length); if (0 == e.indexOf(b)) return JSON.parse(e.substring(b.length, e.length)) } return null }, remove: function (b) { a.mbCookie.set(b, "", -1) } }, a.mbStorage = { set: function (a, b) { b = JSON.stringify(b), localStorage.setItem(a, b) }, get: function (a) { return localStorage[a] ? JSON.parse(localStorage[a]) : null }, remove: function (a) { a ? localStorage.removeItem(a) : localStorage.clear() } } }(jQuery);
/**
 * jQuery Unveil
 * A very lightweight jQuery plugin to lazy load images
 * http://luis-almeida.github.com/unveil
 *
 * Licensed under the MIT license.
 * Copyright 2013 Luís Almeida
 * https://github.com/luis-almeida
 */

; (function ($) {

    $.fn.unveil = function (threshold, callback) {

        var $w = $(window),
            th = threshold || 0,
            retina = window.devicePixelRatio > 1,
            attrib = retina ? "data-src-retina" : "name",
            images = this,
            loaded;

        this.one("unveil", function () {
            var source = this.getAttribute(attrib);
            source = source || this.getAttribute("name");
            if (source) {
                this.setAttribute("src", source);
                if (typeof callback === "function") callback.call(this);
            }
        });

        function unveil() {
            var inview = images.filter(function () {
                var $e = $(this);
                if ($e.is(":hidden")) return;

                var wt = $w.scrollTop(),
                    wb = wt + $w.height(),
                    et = $e.offset().top,
                    eb = et + $e.height();

                return eb >= wt - th && et <= wb + th;
            });

            loaded = inview.trigger("unveil");
            images = images.not(loaded);
        }

        $w.on("scroll.unveil resize.unveil lookup.unveil", unveil);

        unveil();

        return this;

    };

})(window.jQuery || window.Zepto);
 

/*
 * jQuery Nivo Slider v2.7.1
 * http://nivo.dev7studios.com
 *
 * Copyright 2011, Gilbert Pellegrom
 * Free to use and abuse under the MIT license.
 * http://www.opensource.org/licenses/mit-license.php
 * 
 * March 2010
 */

(function($) {

    var NivoSlider = function(element, options){
		//Defaults are below
		var settings = $.extend({}, $.fn.nivoSlider.defaults, options);

        //Useful variables. Play carefully.
        var vars = {
            currentSlide: 0,
            currentImage: '',
            totalSlides: 0,
            running: false,
            paused: false,
            stop: false
        };
    
        //Get this slider
        var slider = $(element);
        slider.data('nivo:vars', vars);
        slider.css('position','relative');
        slider.addClass('nivoSlider');
        
        //Find our slider children
        var kids = slider.children();
        kids.each(function() {
            var child = $(this);
            var link = '';
            if(!child.is('img')){
                if(child.is('a')){
                    child.addClass('nivo-imageLink');
                    link = child;
                }
                child = child.find('img:first');
            }
            //Get img width & height
            var childWidth = child.width();
            if(childWidth == 0) childWidth = child.attr('width');
            var childHeight = child.height();
            if(childHeight == 0) childHeight = child.attr('height');
            //Resize the slider
            if(childWidth > slider.width()){
                slider.width(childWidth);
            }
            if(childHeight > slider.height()){
                slider.height(childHeight);
            }
            if(link != ''){
                link.css('display','none');
            }
            child.css('display','none');
            vars.totalSlides++;
        });
        
        //If randomStart
        if(settings.randomStart){
        	settings.startSlide = Math.floor(Math.random() * vars.totalSlides);
        }
        
        //Set startSlide
        if(settings.startSlide > 0){
            if(settings.startSlide >= vars.totalSlides) settings.startSlide = vars.totalSlides - 1;
            vars.currentSlide = settings.startSlide;
        }
        
        //Get initial image
        if($(kids[vars.currentSlide]).is('img')){
            vars.currentImage = $(kids[vars.currentSlide]);
        } else {
            vars.currentImage = $(kids[vars.currentSlide]).find('img:first');
        }
        
        //Show initial link
        if($(kids[vars.currentSlide]).is('a')){
            $(kids[vars.currentSlide]).css('display','block');
        }
        
        //Set first background
        slider.css('background', 'transparent url("' + vars.currentImage.attr('src') + '") no-repeat');

        //Create caption
        slider.append(
            $('<div class="nivo-caption"><p></p></div>').css({ display:'none', opacity:settings.captionOpacity })
        );		
        
        // Cross browser default caption opacity
        $('.nivo-caption', slider).css('opacity', 0);
		
		// Process caption function
		var processCaption = function(settings){
			var nivoCaption = $('.nivo-caption', slider);
			if(vars.currentImage.attr('title') != '' && vars.currentImage.attr('title') != undefined){
				var title = vars.currentImage.attr('title');
				if(title.substr(0,1) == '#') title = $(title).html();	

				if(nivoCaption.css('opacity') != 0){
					nivoCaption.find('p').stop().fadeTo(settings.animSpeed, 0, function(){
						$(this).html(title);
						$(this).stop().fadeTo(settings.animSpeed, 1);
					});
				} else {
					nivoCaption.find('p').html(title);
				}					
				nivoCaption.stop().fadeTo(settings.animSpeed, settings.captionOpacity);
			} else {
				nivoCaption.stop().fadeTo(settings.animSpeed, 0);
			}
		}
		
        //Process initial  caption
        processCaption(settings);
        
        //In the words of Super Mario "let's a go!"
        var timer = 0;
        if(!settings.manualAdvance && kids.length > 1){
            timer = setInterval(function(){ nivoRun(slider, kids, settings, false); }, settings.pauseTime);
        }

        //Add Direction nav
        if(settings.directionNav){
            slider.append('<div class="nivo-directionNav"><a class="nivo-prevNav">'+ settings.prevText +'</a><a class="nivo-nextNav">'+ settings.nextText +'</a></div>');
            
            //Hide Direction nav
            if(settings.directionNavHide){
                $('.nivo-directionNav', slider).hide();
                slider.hover(function(){
                    $('.nivo-directionNav', slider).show();
                }, function(){
                    $('.nivo-directionNav', slider).hide();
                });
            }
            
            $('a.nivo-prevNav', slider).live('click', function(){
                if(vars.running) return false;
                clearInterval(timer);
                timer = '';
                vars.currentSlide -= 2;
                nivoRun(slider, kids, settings, 'prev');
            });
            
            $('a.nivo-nextNav', slider).live('click', function(){
                if(vars.running) return false;
                clearInterval(timer);
                timer = '';
                nivoRun(slider, kids, settings, 'next');
            });
        }
        
        //Add Control nav
        if(settings.controlNav){
            var nivoControl = $('<div class="nivo-controlNav"></div>');
            slider.append(nivoControl);
            for(var i = 0; i < kids.length; i++){
                if(settings.controlNavThumbs){
                    var child = kids.eq(i);
                    if(!child.is('img')){
                        child = child.find('img:first');
                    }
                    if (settings.controlNavThumbsFromRel) {
                        nivoControl.append('<a class="nivo-control" rel="'+ i +'"><img src="'+ child.attr('rel') + '" alt="" /></a>');
                    } else {
                        nivoControl.append('<a class="nivo-control" rel="'+ i +'"><img src="'+ child.attr('src').replace(settings.controlNavThumbsSearch, settings.controlNavThumbsReplace) +'" alt="" /></a>');
                    }
                } else {
                    nivoControl.append('<a class="nivo-control" rel="'+ i +'">'+'</a>');
                }
                
            }
            //Set initial active link
            $('.nivo-controlNav a:eq('+ vars.currentSlide +')', slider).addClass('active');
            
            $('.nivo-controlNav a', slider).live('click', function(){
                if(vars.running) return false;
                if($(this).hasClass('active')) return false;
                clearInterval(timer);
                timer = '';
                slider.css('background', 'transparent url("' + vars.currentImage.attr('src') + '") no-repeat');
                vars.currentSlide = $(this).attr('rel') - 1;
                nivoRun(slider, kids, settings, 'control');
            });
        }
        
        //Keyboard Navigation
        if(settings.keyboardNav){
            $(window).keypress(function(event){
                //Left
                if(event.keyCode == '37'){
                    if(vars.running) return false;
                    clearInterval(timer);
                    timer = '';
                    vars.currentSlide-=2;
                    nivoRun(slider, kids, settings, 'prev');
                }
                //Right
                if(event.keyCode == '39'){
                    if(vars.running) return false;
                    clearInterval(timer);
                    timer = '';
                    nivoRun(slider, kids, settings, 'next');
                }
            });
        }
        
        //For pauseOnHover setting
        if(settings.pauseOnHover){
            slider.hover(function(){
                vars.paused = true;
                clearInterval(timer);
                timer = '';
            }, function(){
                vars.paused = false;
                //Restart the timer
                if(timer == '' && !settings.manualAdvance){
                    timer = setInterval(function(){ nivoRun(slider, kids, settings, false); }, settings.pauseTime);
                }
            });
        }
        
        //Event when Animation finishes
        slider.bind('nivo:animFinished', function(){ 
            vars.running = false; 
            //Hide child links
            $(kids).each(function(){
                if($(this).is('a')){
                    $(this).css('display', 'none');
                    $(this).removeClass('active_banner');
                }
            });
            //Show current link
            if($(kids[vars.currentSlide]).is('a')){
                $(kids[vars.currentSlide]).css('display', 'block');
                $(kids[vars.currentSlide]).addClass('active_banner');
            }
            //Restart the timer
            if(timer == '' && !vars.paused && !settings.manualAdvance){
                timer = setInterval(function(){ nivoRun(slider, kids, settings, false); }, settings.pauseTime);
            }
            //Trigger the afterChange callback
            settings.afterChange.call(this);
        });
        
        // Add slices for slice animations
        var createSlices = function(slider, settings, vars){
            for(var i = 0; i < settings.slices; i++){
				var sliceWidth = Math.round(slider.width()/settings.slices);
				if(i == settings.slices-1){
					slider.append(
						$('<div class="nivo-slice"></div>').css({ 
							left:(sliceWidth*i)+'px', width:(slider.width()-(sliceWidth*i))+'px',
							height:'0px', 
							opacity: '0',
							top: '0',
							background: 'transparent url("' + vars.currentImage.attr('src') + '") no-repeat -' + ((sliceWidth + (i * sliceWidth)) - sliceWidth) + 'px 0%'
						})
					);
				} else {
					slider.append(
						$('<div class="nivo-slice"></div>').css({ 
							left:(sliceWidth*i)+'px', width:sliceWidth+'px',
							height:'0px', 
							opacity: '0',
							top: '0',
							background: 'transparent url("' + vars.currentImage.attr('src') + '") no-repeat -' + ((sliceWidth + (i * sliceWidth)) - sliceWidth) + 'px 0%'
						})
					);
				}
			}
        }
		
		// Add boxes for box animations
		var createBoxes = function(slider, settings, vars){
			var boxWidth = Math.round(slider.width()/settings.boxCols);
			var boxHeight = Math.round(slider.height()/settings.boxRows);
			
			for(var rows = 0; rows < settings.boxRows; rows++){
				for(var cols = 0; cols < settings.boxCols; cols++){
					if(cols == settings.boxCols-1){
						slider.append(
							$('<div class="nivo-box"></div>').css({ 
								opacity:0,
								left:(boxWidth*cols)+'px', 
								top:(boxHeight*rows)+'px',
								width:(slider.width()-(boxWidth*cols))+'px',
								height:boxHeight+'px',
								background: 'transparent url("' + vars.currentImage.attr('src') + '") no-repeat -' + ((boxWidth + (cols * boxWidth)) - boxWidth) + 'px -' + ((boxHeight + (rows * boxHeight)) - boxHeight) + 'px'
							})
						);
					} else {
						slider.append(
							$('<div class="nivo-box"></div>').css({ 
								opacity:0,
								left:(boxWidth*cols)+'px', 
								top:(boxHeight*rows)+'px',
								width:boxWidth+'px',
								height:boxHeight+'px',
								background: 'transparent url("' + vars.currentImage.attr('src') + '") no-repeat -' + ((boxWidth + (cols * boxWidth)) - boxWidth) + 'px -' + ((boxHeight + (rows * boxHeight)) - boxHeight) + 'px'
							})
						);
					}
				}
			}
		}

        // Private run method
		var nivoRun = function(slider, kids, settings, nudge){
			//Get our vars
			var vars = slider.data('nivo:vars');
            
            //Trigger the lastSlide callback
            if(vars && (vars.currentSlide == vars.totalSlides - 1)){ 
				settings.lastSlide.call(this);
			}
            
            // Stop
			if((!vars || vars.stop) && !nudge) return false;
			
			//Trigger the beforeChange callback
			settings.beforeChange.call(this);
					
			//Set current background before change
			if(!nudge){
			    slider.css('background', 'transparent url("' + vars.currentImage.attr('src') + '") no-repeat');
			} else {
				if(nudge == 'prev'){
				    slider.css('background', 'transparent url("' + vars.currentImage.attr('src') + '") no-repeat');
				}
				if(nudge == 'next'){
				    slider.css('background', 'transparent url("' + vars.currentImage.attr('src') + '") no-repeat');
				}
			}
			vars.currentSlide++;
            //Trigger the slideshowEnd callback
			if(vars.currentSlide == vars.totalSlides){ 
				vars.currentSlide = 0;
				settings.slideshowEnd.call(this);
			}
			if(vars.currentSlide < 0) vars.currentSlide = (vars.totalSlides - 1);
			//Set vars.currentImage
			if($(kids[vars.currentSlide]).is('img')){
				vars.currentImage = $(kids[vars.currentSlide]);
			} else {
				vars.currentImage = $(kids[vars.currentSlide]).find('img:first');
			}
			
			//Set active links
			if(settings.controlNav){
				$('.nivo-controlNav a', slider).removeClass('active');
				$('.nivo-controlNav a:eq('+ vars.currentSlide +')', slider).addClass('active');
			}
			
			//Process caption
			processCaption(settings);
			
			// Remove any slices from last transition
			$('.nivo-slice', slider).remove();
			
			// Remove any boxes from last transition
			$('.nivo-box', slider).remove();
			
			var currentEffect = settings.effect;
			//Generate random effect
			if(settings.effect == 'random'){
				var anims = new Array('sliceDownRight','sliceDownLeft','sliceUpRight','sliceUpLeft','sliceUpDown','sliceUpDownLeft','fold','fade',
                'boxRandom','boxRain','boxRainReverse','boxRainGrow','boxRainGrowReverse');
				currentEffect = anims[Math.floor(Math.random()*(anims.length + 1))];
				if(currentEffect == undefined) currentEffect = 'fade';
			}
            
            //Run random effect from specified set (eg: effect:'fold,fade')
            if(settings.effect.indexOf(',') != -1){
                var anims = settings.effect.split(',');
                currentEffect = anims[Math.floor(Math.random()*(anims.length))];
				if(currentEffect == undefined) currentEffect = 'fade';
            }
            
            //Custom transition as defined by "data-transition" attribute
            if(vars.currentImage.attr('data-transition')){
            	currentEffect = vars.currentImage.attr('data-transition');
            }
		
			//Run effects
			vars.running = true;
			if(currentEffect == 'sliceDown' || currentEffect == 'sliceDownRight' || currentEffect == 'sliceDownLeft'){
				createSlices(slider, settings, vars);
				var timeBuff = 0;
				var i = 0;
				var slices = $('.nivo-slice', slider);
				if(currentEffect == 'sliceDownLeft') slices = $('.nivo-slice', slider)._reverse();
				
				slices.each(function(){
					var slice = $(this);
					slice.css({ 'top': '0px' });
					if(i == settings.slices-1){
						setTimeout(function(){
							slice.animate({ height:'100%', opacity:'1.0' }, settings.animSpeed, '', function(){ slider.trigger('nivo:animFinished'); });
						}, (100 + timeBuff));
					} else {
						setTimeout(function(){
							slice.animate({ height:'100%', opacity:'1.0' }, settings.animSpeed);
						}, (100 + timeBuff));
					}
					timeBuff += 50;
					i++;
				});
			} 
			else if(currentEffect == 'sliceUp' || currentEffect == 'sliceUpRight' || currentEffect == 'sliceUpLeft'){
				createSlices(slider, settings, vars);
				var timeBuff = 0;
				var i = 0;
				var slices = $('.nivo-slice', slider);
				if(currentEffect == 'sliceUpLeft') slices = $('.nivo-slice', slider)._reverse();
				
				slices.each(function(){
					var slice = $(this);
					slice.css({ 'bottom': '0px' });
					if(i == settings.slices-1){
						setTimeout(function(){
							slice.animate({ height:'100%', opacity:'1.0' }, settings.animSpeed, '', function(){ slider.trigger('nivo:animFinished'); });
						}, (100 + timeBuff));
					} else {
						setTimeout(function(){
							slice.animate({ height:'100%', opacity:'1.0' }, settings.animSpeed);
						}, (100 + timeBuff));
					}
					timeBuff += 50;
					i++;
				});
			} 
			else if(currentEffect == 'sliceUpDown' || currentEffect == 'sliceUpDownRight' || currentEffect == 'sliceUpDownLeft'){
				createSlices(slider, settings, vars);
				var timeBuff = 0;
				var i = 0;
				var v = 0;
				var slices = $('.nivo-slice', slider);
				if(currentEffect == 'sliceUpDownLeft') slices = $('.nivo-slice', slider)._reverse();
				
				slices.each(function(){
					var slice = $(this);
					if(i == 0){
						slice.css('top','0px');
						i++;
					} else {
						slice.css('bottom','0px');
						i = 0;
					}
					
					if(v == settings.slices-1){
						setTimeout(function(){
							slice.animate({ height:'100%', opacity:'1.0' }, settings.animSpeed, '', function(){ slider.trigger('nivo:animFinished'); });
						}, (100 + timeBuff));
					} else {
						setTimeout(function(){
							slice.animate({ height:'100%', opacity:'1.0' }, settings.animSpeed);
						}, (100 + timeBuff));
					}
					timeBuff += 50;
					v++;
				});
			} 
			else if(currentEffect == 'fold'){
				createSlices(slider, settings, vars);
				var timeBuff = 0;
				var i = 0;
				
				$('.nivo-slice', slider).each(function(){
					var slice = $(this);
					var origWidth = slice.width();
					slice.css({ top:'0px', height:'100%', width:'0px' });
					if(i == settings.slices-1){
						setTimeout(function(){
							slice.animate({ width:origWidth, opacity:'1.0' }, settings.animSpeed, '', function(){ slider.trigger('nivo:animFinished'); });
						}, (100 + timeBuff));
					} else {
						setTimeout(function(){
							slice.animate({ width:origWidth, opacity:'1.0' }, settings.animSpeed);
						}, (100 + timeBuff));
					}
					timeBuff += 50;
					i++;
				});
			}  
			else if(currentEffect == 'fade'){
				createSlices(slider, settings, vars);
				
				var firstSlice = $('.nivo-slice:first', slider);
                firstSlice.css({
                    'height': '100%',
                    'width': slider.width() + 'px',
                    'top': '0'
                });
    
				firstSlice.animate({ opacity:'1.0' }, (settings.animSpeed*2), '', function(){ slider.trigger('nivo:animFinished'); });
			}          
            else if(currentEffect == 'slideInRight'){
				createSlices(slider, settings, vars);
				
                var firstSlice = $('.nivo-slice:first', slider);
                firstSlice.css({
                    'height': '100%',
                    'width': '0px',
                    'top': '0',
                    'opacity': '1'
                });

                firstSlice.animate({ width: slider.width() + 'px' }, (settings.animSpeed*2), '', function(){ slider.trigger('nivo:animFinished'); });
            }
            else if(currentEffect == 'slideInLeft'){
				createSlices(slider, settings, vars);
				
                var firstSlice = $('.nivo-slice:first', slider);
                firstSlice.css({
                    'height': '100%',
                    'width': '0px',
                    'opacity': '1',
                    'top': '0',
                    'left': '',
                    'right': '0px'
                });

                firstSlice.animate({ width: slider.width() + 'px' }, (settings.animSpeed*2), '', function(){ 
                    // Reset positioning
                    firstSlice.css({
                        'left': '0px',
                        'right': ''
                    });
                    slider.trigger('nivo:animFinished'); 
                });
            }
			else if(currentEffect == 'boxRandom'){
				createBoxes(slider, settings, vars);
				
				var totalBoxes = settings.boxCols * settings.boxRows;
				var i = 0;
				var timeBuff = 0;
				
				var boxes = shuffle($('.nivo-box', slider));
				boxes.each(function(){
					var box = $(this);
					if(i == totalBoxes-1){
						setTimeout(function(){
							box.animate({ opacity:'1' }, settings.animSpeed, '', function(){ slider.trigger('nivo:animFinished'); });
						}, (100 + timeBuff));
					} else {
						setTimeout(function(){
							box.animate({ opacity:'1' }, settings.animSpeed);
						}, (100 + timeBuff));
					}
					timeBuff += 20;
					i++;
				});
			}
			else if(currentEffect == 'boxRain' || currentEffect == 'boxRainReverse' || currentEffect == 'boxRainGrow' || currentEffect == 'boxRainGrowReverse'){
				createBoxes(slider, settings, vars);
				
				var totalBoxes = settings.boxCols * settings.boxRows;
				var i = 0;
				var timeBuff = 0;
				
				// Split boxes into 2D array
				var rowIndex = 0;
				var colIndex = 0;
				var box2Darr = new Array();
				box2Darr[rowIndex] = new Array();
				var boxes = $('.nivo-box', slider);
				if(currentEffect == 'boxRainReverse' || currentEffect == 'boxRainGrowReverse'){
					boxes = $('.nivo-box', slider)._reverse();
				}
				boxes.each(function(){
					box2Darr[rowIndex][colIndex] = $(this);
					colIndex++;
					if(colIndex == settings.boxCols){
						rowIndex++;
						colIndex = 0;
						box2Darr[rowIndex] = new Array();
					}
				});
				
				// Run animation
				for(var cols = 0; cols < (settings.boxCols * 2); cols++){
					var prevCol = cols;
					for(var rows = 0; rows < settings.boxRows; rows++){
						if(prevCol >= 0 && prevCol < settings.boxCols){
							/* Due to some weird JS bug with loop vars 
							being used in setTimeout, this is wrapped
							with an anonymous function call */
							(function(row, col, time, i, totalBoxes) {
								var box = $(box2Darr[row][col]);
                                var w = box.width();
                                var h = box.height();
                                if(currentEffect == 'boxRainGrow' || currentEffect == 'boxRainGrowReverse'){
                                    box.width(0).height(0);
                                }
								if(i == totalBoxes-1){
									setTimeout(function(){
										box.animate({ opacity:'1', width:w, height:h }, settings.animSpeed/1.3, '', function(){ slider.trigger('nivo:animFinished'); });
									}, (100 + time));
								} else {
									setTimeout(function(){
										box.animate({ opacity:'1', width:w, height:h }, settings.animSpeed/1.3);
									}, (100 + time));
								}
							})(rows, prevCol, timeBuff, i, totalBoxes);
							i++;
						}
						prevCol--;
					}
					timeBuff += 100;
				}
			}
		}
		
		// Shuffle an array
		var shuffle = function(arr){
			for(var j, x, i = arr.length; i; j = parseInt(Math.random() * i), x = arr[--i], arr[i] = arr[j], arr[j] = x);
			return arr;
		}
        
        // For debugging
        var trace = function(msg){
            if (this.console && typeof console.log != "undefined")
                console.log(msg);
        }
        
        // Start / Stop
        this.stop = function(){
            if(!$(element).data('nivo:vars').stop){
                $(element).data('nivo:vars').stop = true;
                trace('Stop Slider');
            }
        }
        
        this.start = function(){
            if($(element).data('nivo:vars').stop){
                $(element).data('nivo:vars').stop = false;
                trace('Start Slider');
            }
        }
        
        //Trigger the afterLoad callback
        settings.afterLoad.call(this);
		
		return this;
    };
        
    $.fn.nivoSlider = function(options) {
    
        return this.each(function(key, value){
            var element = $(this);
            // Return early if this element already has a plugin instance
            if (element.data('nivoslider')) return element.data('nivoslider');
            // Pass options to plugin constructor
            var nivoslider = new NivoSlider(this, options);
            // Store plugin object in this element's data
            element.data('nivoslider', nivoslider);
        });

	};
	
	//Default settings
	$.fn.nivoSlider.defaults = {
		effect: 'random',
		slices: 15,
		boxCols: 8,
		boxRows: 4,
		animSpeed: 200,
		pauseTime: 40000,
		startSlide: 0,
		directionNav: true,
		directionNavHide: true,
		controlNav: true,
		controlNavThumbs: false,
        controlNavThumbsFromRel: false,
		controlNavThumbsSearch: '.jpg',
		controlNavThumbsReplace: '_thumb.jpg',
		keyboardNav: true,
		pauseOnHover: true,
		manualAdvance: false,
		captionOpacity: 0.8,
		prevText: 'Prev',
		nextText: 'Next',
		randomStart: false,
		beforeChange: function(){},
		afterChange: function(){},
		slideshowEnd: function(){},
        lastSlide: function(){},
        afterLoad: function(){}
	};
	
	$.fn._reverse = [].reverse;
	
})(jQuery);

function ZuznowParseURL(url) {
    var a = document.createElement('a');
    a.href = url;
    return {
        source: url,
        protocol: a.protocol.replace(':', ''),
        host: a.hostname,
        port: a.port,
        query: a.search,
        params: (function () {
            var ret = {},
                seg = a.search.replace(/^\?/, '').split('&'),
                len = seg.length, i = 0, s;
            for (; i < len; i++) {
                if (!seg[i]) { continue; }
                s = seg[i].split('=');
                ret[s[0]] = s[1];
            }
            return ret;
        })(),
        file: (a.pathname.match(/\/([^\/?#]+)$/i) || [, ''])[1],
        hash: a.hash.replace('#', ''),
        path: a.pathname.replace(/^([^\/])/, '/$1'),
        relative: (a.href.match(/tps?:\/\/[^\/]+(.+)/) || [, ''])[1],
        segments: a.pathname.replace(/^\//, '').split('/')
    };
}

function ZuznowGetCookie(c_name) {
    var i, x, y, ARRcookies = document.cookie.split(";");
    for (i = 0; i < ARRcookies.length; i++) {
        x = ARRcookies[i].substr(0, ARRcookies[i].indexOf("="));
        y = ARRcookies[i].substr(ARRcookies[i].indexOf("=") + 1);
        x = x.replace(/^\s+|\s+$/g, "");
        if (x == c_name) {
            return unescape(y);
        }
    }
    return "";
}
function ZuznowSetCookie(c_name, value, expiredays) {
    var exdate = new Date();
    exdate.setDate(exdate.getDate() + expiredays);
    document.cookie = c_name + "=" + escape(value) +
		((expiredays == null) ? "" : ";expires=" + exdate.toUTCString()) + ";Path=/;";
}


function ZuznowShouldRedirect(mobile_domain, redirect_tablets, redirect_ssl) {
    redirect_tablets = redirect_tablets || false;
    redirect_ssl = redirect_ssl || false;
    var redirect = false;
    if (navigator.userAgent.match(/(iPhone|iPod|BlackBerry)/i)) {
        redirect = true;
    }
    else if (navigator.userAgent.match(/(Android)/i)) {
        if (navigator.userAgent.match(/(Mobile)/i)) {
            redirect = true;
        }
        else if (redirect_tablets) {
            redirect = true;
        }
    }
    else if (navigator.userAgent.match(/(iPad)/i)) {
        if (redirect_tablets) {
            redirect = true;
        }
    }
    var myURL = ZuznowParseURL(window.location.href);
    if (myURL.protocol == "https" && !redirect_ssl) {
        redirect = false;
    }
    if (ZuznowGetCookie("mob_no_redirect") == "true") {
        redirect = false;
    }
    else if (myURL.query.match(/(mob_no_redirect=true)/i)) {
        ZuznowSetCookie("mob_no_redirect", "true");
        redirect = false;
    }

    if (myURL.host == mobile_domain) {
        redirect = false;
    }
    if (getParameterByName('mobilepayment').toLowerCase() =='true') {
        redirect = false;
    }
    return redirect;
}
function ZuznowRedirect(mobile_domain, redirect_tablets, redirect_ssl, redirect_ssl_to_plain, ssl_mobile_domain) {
    ssl_mobile_domain = ssl_mobile_domain || mobile_domain;
    if (ZuznowShouldRedirect(mobile_domain, redirect_tablets, redirect_ssl)) {
        redirect_ssl_to_plain = redirect_ssl_to_plain || false;
        var myURL = ZuznowParseURL(window.location.href);
        var myScheme = myURL.protocol;
        if (redirect_ssl_to_plain) {
            myScheme = "http";
        }
        if (myURL.protocol == "https") {
            mobile_domain = ssl_mobile_domain;
        }
        document.write('<style>*{display:none;}</style>');
        var myNewURL = myScheme + "://" + mobile_domain ;
        location.replace(myNewURL);
    }
}
//ZuznowRedirect('m.eshet-tours.com', false, true, false, 'm.eshet-tours.com');
function getParameterByName(name) {
    name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
    var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
        results = regex.exec(location.search);
    return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
}
var pageType = '';

$(function () {

    //Create/Get a unique cookie that identifies the client for the like billions service
    var value;
    var CheckCookieForLB = getCookie("lbIdentifier");
    if (CheckCookieForLB == "") {
        value = createGuid();
        CheckCookieForLB = setCookie("lbIdentifier", value, 60);
    }
    else {

        value = CheckCookieForLB;
    }

    $('[placeholder]').focus(function () {
        var input = $(this);
        if (input.val() == input.attr('placeholder')) {
            input.val('');
            input.removeClass('placeholder');
        }
    }).blur(function () {
        var input = $(this);
        if (input.val() == '' || input.val() == input.attr('placeholder')) {
            input.addClass('placeholder');
            input.val(input.attr('placeholder'));
        }
    }).blur();

    //Tooltip creator. to operate => insert data to 'data-tooltip' attribute
    $('[data-tooltip]').each(function () {
        $(this).addClass('tooltip_parent');
        $('<div class="tooltip">' + $(this).attr('data-tooltip') + '</div>').appendTo($(this));
        $(this).removeAttr('data-tooltip');

    });

    jQuery.fn.center = function () {
        this.css("position", "absolute");

        this.css("top", Math.max(0, (($(window).height() - $(this).outerHeight()) / 2) +
                                                    $(window).scrollTop()) + "px");
        this.css("left", Math.max(0, (($(window).width() - $(this).outerWidth()) / 2) +
                                                    $(window).scrollLeft()) + "px");

        return this;
    }

    jQuery.fn.centerFixed = function () {
        this.css("position", "fixed");
        this.css("top", Math.max(0, (($(window).height() - $(this).outerHeight()) / 2)) + "px");
        this.css("left", Math.max(0, (($(window).width() - $(this).outerWidth()) / 2) +
                                                    $(window).scrollLeft()) + "px");

        return this;
    }
});

function exctractDomain(url) {
    var domain;
    //find & remove protocol (http, ftp, etc.) and get domain
    if (url.indexOf("://") > -1) {
        domain = url.split('/')[2];
    }
    else {
        domain = url.split('/')[0];
    }

    //find & remove port number
    domain = domain.split(':')[0];

    return domain;

}

function isDomainsSimilar(url1, url2) {
    return exctractDomain(url1).toUpperCase() === exctractDomain(url2).toUpperCase();
}

function AddGoogleIdAndEshetToursId(url) {
    var urlNew = url;

    if (isDomainsSimilar(siteUrlPoc, url)) {

        var connectionChar = (urlNew.indexOf("?") != -1) ? "&" : "?";
        var gaParams = getGoogleParams();
        var utmSource = getUtmSource();

        if (gaParams != "") {
            urlNew += connectionChar + gaParams;
        }

        if (utmSource != null && utmSource != "") {

            connectionChar = (urlNew.indexOf("?") != -1) ? "&" : "?";
            urlNew += connectionChar + "originsource=" + utmSource;
        }


    }
    return urlNew;
}

function getGoogleParams() {

    var gaParams = "";
    try {
        gaParams = ga.getAll()[0].get('linkerParam');
    } catch (e) { }

    return gaParams;
}

function doDatePickerDateRange() {
    $(".toDP #ui-datepicker-div td").live({
        mouseenter: function () {
            $(this).parent().addClass("finalRow");

            $(".finalRow").prevAll().find("td:not(.ui-datepicker-unselectable, .ui-state-disabled-start-date) a ").addClass("in-range");
            $(this).prevAll("td:not(.ui-datepicker-unselectable, .ui-state-disabled-start-date)").find("a").addClass("in-range");

            //for Holiday
            $(".finalRow").prevAll().find("td:not(.ui-datepicker-unselectable, .ui-state-disabled-start-date).holiday a ").addClass("in-range");
            $(this).prevAll("td:not(.ui-datepicker-unselectable, .ui-state-disabled-start-date).holiday ").find("a").addClass("in-range");

            //for Charter
            $(".finalRow").prevAll().find("td:not(.ui-datepicker-unselectable, .ui-state-disabled-start-date).charter a ").addClass("in-range");
            $(this).prevAll("td:not(.ui-datepicker-unselectable, .ui-state-disabled-start-date).charter ").find("a").addClass("in-range");

            if ($(this).parents('.ui-datepicker-group-last').length > 0) {
                $(".ui-datepicker-group-first").find("td:not(.ui-datepicker-unselectable, .ui-state-disabled-start-date) a ").addClass("in-range");

                //Holiday
                $(".ui-datepicker-group-first").find("td:not(.ui-datepicker-unselectable, .ui-state-disabled-start-date).holiday a").addClass("in-range");

                //Charter
                $(".ui-datepicker-group-first").find("td:not(.ui-datepicker-unselectable, .ui-state-disabled-start-date).charter a").addClass("in-range");
            }
        },
        mouseleave: function () {
            $(this).parent().removeClass("finalRow");
            $("#ui-datepicker-div td a").removeClass("in-range");
        }
    });


}

function setDP_classesForJS(isTo) {
    
    $("#calendarWrapper").attr("class", "wrap popupCalendar");
    if (isTo == "True") {
        $("#calendarWrapper").removeClass("fromDP");
        $("#calendarWrapper").addClass("toDP");
    } else if (isTo == "False") {
        $("#calendarWrapper").addClass("fromDP");
        $("#calendarWrapper").removeClass("toDP");
    } else {
        $("#calendarWrapper").removeClass("fromDP");
        $("#calendarWrapper").removeClass("toDP");
    }
}

function ShowPrices(obj, event) {
    if ($(obj).parents(".price_info_forJquery").find(".price_information_box").css('display') != 'none') {
        $(obj).parents(".price_info_forJquery").find(".price_information_box").slideUp("easy");
    } else {
        $(obj).parents(".price_info_forJquery").find(".price_information_box").slideDown("easy");
    }
    event.stopPropagation();
}


function RemoveErrorMsg() {
    $('.formError').remove();
}

function showErrorPopUp(text) {
    if (text != null || text != undefined) {
        $("div.erropPopup").find("div.modal-body-msg").hide();
        $("div.erropPopup").find("div.modal-body-msg." + text).show();
    }

    $(".erropPopup").show();
}
function hideErrorPopUp() {
    $(".erropPopup").hide();
}
function showPriceChangePopUp() {
    $(".pricechangedPopup").show();
    setTimeout(function () {
        hidePriceChangedPopUp();
    }, 5000);

}
function hidePriceChangedPopUp() {
    $(".pricechangedPopup").hide();
}

function initCustomDomesticLoader(fromDate, toDate, dest, adults) {
    var x = $('#divBGTextnoActive');
    $(x).html('');
    $(x).html($(x).html() + "<span style='display:block;color:#fff;font: bold 14px/1 Arial;'>מבצע חיפוש למלון&nbsp;" + dest + '</span>');
    $(x).html($(x).html() + "<span style='display:block;color:#fff;font: bold 14px/1 Arial;'>לתאריכים&nbsp;" + fromDate + "&nbsp;-&nbsp;" + toDate + '</span>');
    $(x).html($(x).html() + "<span style='display:block;color:#fff;font: bold 14px/1 Arial;'>" + "להרכב&nbsp;" + adults + '</span>');
    $(x).html($(x).html() + "<span style='display:block;color:#fff;font: bold 14px/1 Arial;'>אנא המתן...</span>");
    $('.AnimatedContainerBG p').html($(x).html());
    $('#divBGTextnoActive').html($('#divBGTextnoActive2').html());

    //LoadingPopup();
    initSearchLoader();
}


jQuery(document).ready(function ($) {

    InitMainJs();
    FixImagesSize();

});

function FixImagesSize() {
    setTimeout(function () {
        $.each($(".promotion_item .preload-me"), function () {
            var src = $(this).attr("src");
            var name = $(this).attr("name");
            var height = $(this).height();
            var width = $(this).width();
            $(this).attr("src", src + "?width=" + width + "&height=" + height + "&mode=crop");
            $(this).attr("name", name + "?width=" + width + "&height=" + height + "&mode=crop");
        });
    }, 1000);
}

//Set highet Between tow element
function SetHighet(first_elemet_id, second_elemet_id) {
    var highestCol = Math.max($('#' + first_elemet_id).height(), $('#' + second_elemet_id).height());
    if (highestCol > 0) {
        $('#' + first_elemet_id).height(highestCol);
        $('#' + second_elemet_id).height(highestCol);
    }

}

//Set highet Between tow element
function SetHighetbyClass(first_elemet_id, second_elemet_id) {
    var highestCol = Math.max($('#' + first_elemet_id).height(), $('#' + second_elemet_id).height());
    if (highestCol > 0) {
        $('.' + first_elemet_id).height(highestCol);
        $('.' + second_elemet_id).height(highestCol);
    }

}

function SetHighetForThreeElemnet(first_elemet_id, second_elemet_id, therd_elemnt) {
    var highestColfirst = Math.max($('#' + first_elemet_id).height(), $('#' + second_elemet_id).height());
    var highestColsecond = Math.max(highestColfirst, $('#' + therd_elemnt).height());



    $('#' + first_elemet_id).height(highestColsecond);
    $('#' + second_elemet_id).height(highestColsecond);
    $('#' + therd_elemnt).height(highestColsecond);
}


function doDatePickerPositionHandle(input) {

    var scrollBottom = $(window).scrollTop() + $(window).height();
    var isValidScreen = scrollBottom > 746;

    var positionOfInput = $(input).offset();
    var isValidLeftSpace = positionOfInput.left > 410;

    if (!isValidScreen) {
        //$("html, body").scrollTop(160);
        var mainWizardPos = $('.main-wizard-wrapper_JS').offset();
        if (mainWizardPos != undefined) {
            $("html, body").scrollTop(mainWizardPos.top);
        }
    }

    if (!isValidLeftSpace) {
        if (positionOfInput.left > 300) {
            $('.datepickerWrapper').removeClass('wizard_arrow_pos_25');
            $('.datepickerWrapper').removeClass('wizard_arrow_pos_50');
            $('.datepickerWrapper').addClass('wizard_arrow_pos_75');
        }
        else if (positionOfInput.left < 50) {
            $('.datepickerWrapper').removeClass('wizard_arrow_pos_50');
            $('.datepickerWrapper').removeClass('wizard_arrow_pos_75');
            $('.datepickerWrapper').addClass('wizard_arrow_pos_25');
        } else {
            $('.datepickerWrapper').removeClass('wizard_arrow_pos_75');
            $('.datepickerWrapper').removeClass('wizard_arrow_pos_25');
            $('.datepickerWrapper').addClass('wizard_arrow_pos_50');
        }
    } else {
        $('.datepickerWrapper').removeClass('wizard_arrow_pos_25');
        $('.datepickerWrapper').removeClass('wizard_arrow_pos_50');
        $('.datepickerWrapper').removeClass('wizard_arrow_pos_75');
    }

}

function InitMainJs() {
    if ($.browser.msie) $("html").removeClass("csstransforms3d");
    var dtGlobals = {}; // Global storage


    /* !Custom touch events */
    /* !(we need to add swipe events here) */

    dtGlobals.touches = {};
    dtGlobals.touches.touching = false;
    dtGlobals.touches.touch = false;
    dtGlobals.touches.currX = 0;
    dtGlobals.touches.currY = 0;
    dtGlobals.touches.cachedX = 0;
    dtGlobals.touches.cachedY = 0;
    dtGlobals.touches.count = 0;
    dtGlobals.resizeCounter = 0;

    dtGlobals.isMobile = (/(Android|BlackBerry|iPhone|iPod|iPad|Palm|Symbian)/.test(navigator.userAgent));
    dtGlobals.isAndroid = (/(Android)/.test(navigator.userAgent));
    dtGlobals.isiOS = (/(iPhone|iPod|iPad)/.test(navigator.userAgent));
    dtGlobals.isiPhone = (/(iPhone|iPod)/.test(navigator.userAgent));
    dtGlobals.isiPad = (/(iPad)/.test(navigator.userAgent));


    $(document).on('touchstart', function (e) {
        if (e.originalEvent.touches.length == 1) {
            dtGlobals.touches.touch = e.originalEvent.touches[0];

            // caching the current x
            dtGlobals.touches.cachedX = dtGlobals.touches.touch.pageX;
            // caching the current y
            dtGlobals.touches.cachedY = dtGlobals.touches.touch.pageY;
            // a touch event is detected      
            dtGlobals.touches.touching = true;

            // detecting if after 200ms the finger is still in the same position
            setTimeout(function () {

                dtGlobals.touches.currX = dtGlobals.touches.touch.pageX;
                dtGlobals.touches.currY = dtGlobals.touches.touch.pageY;

                if ((dtGlobals.touches.cachedX === dtGlobals.touches.currX) && !dtGlobals.touches.touching && (dtGlobals.touches.cachedY === dtGlobals.touches.currY)) {
                    // Here you get the Tap event
                    dtGlobals.touches.count++;
                    $(e.target).trigger("tap");
                }
            }, 200);
        }
    });

    $(document).on('touchend touchcancel', function (e) {
        // here we can consider finished the touch event
        dtGlobals.touches.touching = false;
    });

    $(document).on('touchmove', function (e) {
        dtGlobals.touches.touch = e.originalEvent.touches[0];

        if (dtGlobals.touches.touching) {
            // here you are swiping
        }
    });


    $(document).on("tap", function (e) {
        $(".dt-hovered").trigger("mouseout");
    });

    /* Custom touch events:end */
    /* !Debounced resize event */
    var dtResizeTimeout;
    $(window).on("resize", function () {
        clearTimeout(dtResizeTimeout);
        dtResizeTimeout = setTimeout(function () {
            $(window).trigger("debouncedresize");
        }, 200);
    });
    /* Debounced resize event: end */

    /* !jQuery extensions */

    /* !- Check if element exists */
    $.fn.exists = function () {
        if ($(this).length > 0) {
            return true;
        } else {
            return false;
        }
    }

    /* !- Check if element is loaded */
    $.fn.loaded = function (callback, jointCallback, ensureCallback) {
        var len = this.length;
        if (len > 0) {
            return this.each(function () {
                var el = this,
                    $el = $(el),
                    blank = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";

                $el.on("load.dt", function (event) {
                    $(this).off("load.dt");
                    if (typeof callback == "function") {
                        callback.call(this);
                    }
                    if (--len <= 0 && (typeof jointCallback == "function")) {
                        jointCallback.call(this);
                    }
                });

                if (!el.complete || el.complete === undefined) {
                    el.src = el.src;
                } else {
                    $el.trigger("load.dt")
                }
            });
        } else if (ensureCallback) {
            if (typeof jointCallback == "function") {
                jointCallback.call(this);
            }
            return this;
        }
    };

    /* jQuery extensions: end */


    /* !Main navigation */
    /* We need to fine-tune timings and do something about the usage of jQuery "animate" function */

    $("#mobile-menu").wrap('<div id="dl-menu" class="dl-menuwrapper wf-mobile-visible" />');

    var $mainNav = $(".main-nav");

    $(".act", $mainNav).parents("li").addClass("act");

    var $mobileNav = $mainNav.clone();
    var backCap = $("#mobile-menu > .menu-back").html();

    $mobileNav
        .attr("id", "")
        .attr("class", "dl-menu")
        .find(".sub-nav")
            .addClass("dl-submenu")
            .removeClass("sub-nav")
            .prepend('<li class="dl-back"><a href="#"><span>' + backCap + '</a></li>');

    $mobileNav.appendTo("#dl-menu").wrap('<div class="dl-container" />');

    if ($("html").hasClass("old-ie")) {
        $('#dl-menu').dlmenu();
    }

    if ($mainNav.hasClass("fancy-rollovers") && $("html").hasClass("csstransforms3d")) {
        $("> li > a", $mainNav).each(function () {
            var $this = $(this).css("padding", 0),
                tempHtml = $this.html();

            tempHtml = '<span>' + tempHtml + '<span>' + tempHtml + '</span></span>';
            $this.html(tempHtml);
        });
    }

    $(".sub-nav", $mainNav).parent().each(function () {
        var $this = $(this);

        $this.find("> a").on("click", function (e) {
            if (!$(this).hasClass("dt-clicked")) {
                e.preventDefault();
                $mainNav.find(".dt-clicked").removeClass("dt-clicked");
                $(this).addClass("dt-clicked");
            } else {
                e.stopPropagation();
            }

        });

        var menuTimeoutShow,
            menuTimeoutHide;

        $this.on("mouseenter tap", function (e) {
            if (e.type == "tap") e.stopPropagation();

            var $this = $(this);
            $this.addClass("dt-hovered");

            if ($("#page").width() - ($this.children('ul').offset().left - $("#page").offset().left) - 230 < 0) {
                $this.children('ul').addClass("right-overflow");
            }

            clearTimeout(menuTimeoutShow);
            clearTimeout(menuTimeoutHide);

            menuTimeoutShow = setTimeout(function () {
                if ($this.hasClass("dt-hovered")) {
                    $this.children('ul').stop().css("visibility", "visible").animate({
                        "opacity": 1
                    }, 200);
                }
            }, 350);
        });

        $this.on("mouseleave", function (e) {
            var $this = $(this);
            $this.removeClass("dt-hovered");

            clearTimeout(menuTimeoutShow);
            clearTimeout(menuTimeoutHide);

            menuTimeoutHide = setTimeout(function () {
                if (!$this.hasClass("dt-hovered")) {
                    $this.children('ul').stop().animate({
                        "opacity": 0
                    }, 150, function () {
                        $(this).css("visibility", "hidden");
                    });

                    setTimeout(function () {
                        if (!$this.hasClass("dt-hovered")) {
                            $this.children('ul').removeClass("right-overflow");
                        }
                    }, 400);
                }
            }, 200);

            $this.find("> a").removeClass("dt-clicked");
        });

    });

    /* Main navigation: end */


    /* !Navigation widget */

    $('.custom-nav > li > a').click(function (e) {
        $menuItem = $(this).parent();
        if ($menuItem.hasClass("has-children")) e.preventDefault();

        if ($(this).attr('class') != 'active') {
            $('.custom-nav > li > ul').slideUp(400);
            $(this).next().slideDown(500);
            $('.custom-nav > li > a').removeClass('active');
            $(this).addClass('active');
        }

        $menuItem.siblings().removeClass("act");
        $menuItem.addClass("act");
    });
    $('.custom-nav > li > ul').each(function () {
        $this = $(this);
        $thisChildren = $this.find('li');
        if ($thisChildren.hasClass('act')) {
            $this.prev().addClass('active');
            $this.parent().siblings().removeClass("act");
            $this.parent().addClass('act');
            $(this).slideDown(500);
        }
    });


    /* Navigation widget: end */
    try {
        $('.shortcode-tabs').goTabs().css('visibility', 'visible');

    } catch (e) {

    }

    /* !Royal Slider */
    if ($(".rsHomePorthole").exists()) {
        var portholeSlider = {};
        portholeSlider.container = $("#main-slideshow");
        portholeSlider.width = portholeSlider.container.attr("data-width") ? parseInt(portholeSlider.container.attr("data-width")) : 1280;
        portholeSlider.height = portholeSlider.container.attr("data-height") ? parseInt(portholeSlider.container.attr("data-height")) : 720;
        portholeSlider.autoslide = portholeSlider.container.attr("data-autoslide") && parseInt(portholeSlider.container.attr("data-autoslide")) > 999 ? parseInt(portholeSlider.container.attr("data-autoslide")) : 5000;
        portholeSlider.scale = portholeSlider.container.attr("data-scale") ? portholeSlider.container.attr("data-scale") : "fill";
        portholeSlider.paused = portholeSlider.container.attr("data-paused") ? portholeSlider.container.attr("data-paused") : true;
        portholeSlider.hendheld = $(window).width() < 740 && dtGlobals.isMobile ? true : false;

        $("#main-slideshow-content").appendTo(portholeSlider.container);

        portholeSlider.api = $(".rsHomePorthole").royalSlider({
            autoScaleSlider: true,
            autoScaleSliderWidth: portholeSlider.width,
            autoScaleSliderHeight: portholeSlider.height,
            autoPlay: {
                enabled: !portholeSlider.hendheld,
                stopAtAction: false,
                pauseOnHover: false,
                delay: portholeSlider.autoslide
            },
            imageScaleMode: portholeSlider.scale,
            imageScalePadding: 0,
            numImagesToPreload: 6,
            slidesOrientation: "horizontal",
            disableResponsiveness: false,
            loopRewind: true,
            arrowsNav: false,
            globalCaption: true,
            controlNavigation: !portholeSlider.hendheld ? 'porthole' : 'none',
            thumbs: {
                orientation: 'vertical',
                drag: false,
                touch: false,
                spacing: 10,
                firstMargin: false,
                appendSpan: false
            },
            block: {
                fadeEffect: true,
                moveEffect: 'bottom',
                moveOffset: 5
            }
        }).data("royalSlider");
        if (portholeSlider.paused === "true" || portholeSlider.paused === true) portholeSlider.api.stopAutoPlay();
    }


    //$(".slider-post").each(function () {
    //    $(this).royalSlider({
    //        autoScaleSlider: true,
    //        imageScaleMode: "fit",
    //        autoScaleSliderWidth: $(this).attr('data-width'),
    //        autoScaleSliderHeight: $(this).attr('data-height'),
    //        imageScalePadding: 0,
    //        numImagesToPreload: 6,
    //        slidesOrientation: "horizontal",
    //        disableResponsiveness: false,
    //        globalCaption: true
    //    });
    //});

    $(".slider-simple").each(function () {
        $(this).royalSlider({
            autoScaleSlider: true,
            imageScaleMode: "fit",
            autoScaleSliderWidth: $(this).attr('data-width'),
            autoScaleSliderHeight: $(this).attr('data-height'),
            imageScalePadding: 0,
            numImagesToPreload: 6,
            slidesOrientation: "horizontal",
            disableResponsiveness: false,
            globalCaption: true
        });
    });

    $(".slider-content").each(function () {
        var $this = $(this),
            autoslide = $this.attr("data-autoslide") && parseInt($this.attr("data-autoslide")) > 999 ? parseInt($this.attr("data-autoslide")) : 5000;
        hendheld = !($(window).width() < 740 && dtGlobals.isMobile) && $this.attr("data-autoslide") ? true : false;

        $this.royalSlider({
            autoPlay: {
                enabled: hendheld,
                stopAtAction: false,
                pauseOnHover: false,
                delay: autoslide
            },
            autoHeight: true,
            controlsInside: false,
            fadeinLoadedSlide: false,
            controlNavigationSpacing: 0,
            controlNavigation: 'bullets',
            imageScaleMode: 'none',
            imageAlignCenter: false,
            loop: false,
            loopRewind: true,
            numImagesToPreload: 6,
            keyboardNavEnabled: true

        }).data('royalSlider');
    });

    /* Royal Slider: end */
    //Full-width scroller
    $(".fullwidth-slider").each(function () {
        var $this = $(this),
            scroller = $this.theScroller({
                "prev": $this.parent().find('.prev'),
                "next": $this.parent().find('.next')
            }).data("theScroller");


    });
    //Instagram
    function calcPics(maxitemwidth) {
        var $collection = $('.instagram-photos');
        if ($collection.length < 1) return false;

        //var maxitemwidth = maxitemwidth ? maxitemwidth : parseInt($collection.find('> a').css('max-width'));

        $collection.each(function () {
            /* $(this).find('a').css({ 'width': (100/(Math.ceil($(this).width()/maxitemwidth)))+'%' }); // Not optimized */
            var maxitemwidth = maxitemwidth ? maxitemwidth : parseInt($(this).find('> a').css('max-width'));

            // Cahce everything
            var $container = $(this),
                containerwidth = $container.width(),
                itemperc = (100 / (Math.ceil(containerwidth / maxitemwidth)));

            $container.find('a').css({ 'width': itemperc + '%' });
        });
    };
    function moveOffset() {
        if ($(".map-container.full").length) {
            var offset_map = $(".map-container.full").position().left;
            $(".map-container.full").css({
                width: $('#main').width(),
                marginLeft: -offset_map
            });
        };
        if ($(".slider-wrapper").length) {
            $(".slider-wrapper.full").each(function () {
                var offset_fs = $(this).position().left;
                var $frame = $(this).children('.fullwidth-slider');
                $(this).css({
                    width: $('#main').width(),
                    'margin-left': -offset_fs
                });

                var scroller = $(this).children().data("theScroller");
                scroller.update();

            });
        };
    };
    /*calcPics();
    moveOffset();*/

    /* !Masonry layout: */

    var $isoCollection = $(".iso-container");
    var $gridCollection = $(".wf-container.grid-masonry");
    // !- Columns width calculation
    function calculateColumns(container) {

        var $isoContainer = container,
            containerWidth = $isoContainer.width(),
            minCol = Math.floor(containerWidth / 12);

        if (minCol * 3 >= 200) {

            $("> .iso-item", $isoContainer).each(function () {
                var $this = $(this);
                if ($this.hasClass("wf-1-4")) {
                    $this.css("width", minCol * 3);
                } else if ($this.hasClass("wf-2-4") || $this.hasClass("wf-1-2")) {
                    $this.css("width", minCol * 6);
                } else if ($this.hasClass("wf-1-3")) {
                    $this.css("width", minCol * 4);
                } else if ($this.hasClass("wf-2-3")) {
                    $this.css("width", minCol * 8);
                }
            });

        } else if (minCol * 3 < 200 && minCol * 3 > 150) {

            $("> .iso-item", $isoContainer).each(function () {
                var $this = $(this);
                if ($this.hasClass("wf-1-4")) {
                    $this.css("width", minCol * 6);
                } else if ($this.hasClass("wf-2-4") || $this.hasClass("wf-1-2")) {
                    $this.css("width", minCol * 12);
                } else if ($this.hasClass("wf-1-3")) {
                    $this.css("width", minCol * 6);
                } else if ($this.hasClass("wf-2-3")) {
                    $this.css("width", minCol * 12);
                }
            });

        } else if (minCol * 3 <= 150) {
            $("> .iso-item", $isoContainer).each(function () {
                $(this).css("width", minCol * 12);
            });
        }
    };

    $isoCollection.each(function () {
        var $isoContainer = $(this);

        calculateColumns($isoContainer);

        $(".preload-me", $isoContainer).loaded(null, function () {

            // !- Slider initialization
            $(".slider-masonry", $isoContainer).each(function () {
                var $_this = $(this),
                    attrW = $_this.data('width'),
                    attrH = $_this.data('height');

                $_this.royalSlider({
                    autoScaleSlider: true,
                    autoScaleSliderWidth: attrW,
                    autoScaleSliderHeight: attrH,
                    imageScaleMode: "fit",
                    imageScalePadding: 0,
                    slidesOrientation: "horizontal",
                    disableResponsiveness: true
                });

            });

            // !- Masonry initialization
            $isoContainer.isotope({
                itemSelector: '.iso-item',
                resizable: false,
                layoutMode: 'masonry',
                animationEngine: 'best-available',
                masonry: { columnWidth: 1 },
                getSortData: {
                    date: function ($elem) {
                        return $elem.attr('data-date');
                    },
                    name: function ($elem) {
                        return $elem.attr('data-name');
                    }
                }
            });

            $(".iso-item", $isoContainer).css("visibility", "visible");

            // !- Window resize event
            $(window).on("debouncedresize", function () {
                calculateColumns($isoContainer);

                $(".royalSlider", $isoContainer).each(function () {
                    $(this).data('royalSlider').updateSliderSize();
                });

                $isoContainer.isotope('reLayout');
            });
        }, true);
    });

    /**/
    function calculateGridColumns(container) {

        var $gridContainer = container,
            containerWidth = $gridContainer.width();
        if ($('#main').hasClass('sidebar-none')) {
            minCol = Math.floor(containerWidth / 248);
        } else {
            minCol = Math.floor(containerWidth / 186);
        }

        if (minCol == 5) {
            $("> .wf-cell", $gridContainer).each(function () {
                var $this = $(this);
                if ($this.hasClass("wf-1-4")) {
                    $(this).css("width", minCol * 5 + "%");
                } else if ($this.hasClass("wf-2-4") || $this.hasClass("wf-1-2")) {
                    $this.css("width", minCol * 10 + "%");
                } else if ($this.hasClass("wf-1-3")) {
                    $this.css("width", minCol * 6.6666 + "%");
                }
            });
        } else if (minCol < 5 && minCol >= 4) {
            $("> .wf-cell", $gridContainer).each(function () {
                var $this = $(this);
                if ($this.hasClass("wf-1-4")) {
                    $(this).css("width", minCol * 6.25 + "%");
                } else if ($this.hasClass("wf-2-4") || $this.hasClass("wf-1-2")) {
                    $this.css("width", minCol * 12.5 + "%");
                } else if ($this.hasClass("wf-1-3")) {
                    $this.css("width", minCol * 8.333 + "%");
                }
            });
        } else if (minCol < 4 && minCol >= 3) {
            $("> .wf-cell", $gridContainer).each(function () {
                var $this = $(this);
                if ($this.hasClass("wf-1-4")) {
                    $this.css("width", minCol * 11.111 + "%");
                } else if ($this.hasClass("wf-2-4") || $this.hasClass("wf-1-2")) {
                    $this.css("width", minCol * 16.667 + "%");
                } else if ($this.hasClass("wf-1-3")) {
                    $this.css("width", minCol * 11.111 + "%");
                }
            });

        }
        else if (minCol < 3 && minCol >= 2) {
            $("> .wf-cell", $gridContainer).each(function () {
                var $this = $(this);
                $this.css("width", minCol * 25 + "%");
            });
        }
        else if (minCol < 2 && minCol >= 1) {
            $("> .wf-cell", $gridContainer).each(function () {
                var $this = $(this);
                $this.css("width", minCol * 50 + "%");

            });
        }
        if (containerWidth < 360) {
            $("> .wf-cell", $gridContainer).each(function () {
                var $this = $(this);
                $this.css("width", "100%");
            });
        }
    };
    $gridCollection.each(function () {
        var $gridContainer = $(this);
        calculateGridColumns($gridContainer);
        $(window).on("debouncedresize", function () {
            calculateGridColumns($gridCollection);
        });
    });
    // !- Filter
    $(".filter-categories > a").on("click", function (e) {
        var $this = $(this);

        if (typeof arguments.callee.dtPreventD == 'undefined') {
            arguments.callee.dtPreventD = !$this.parents('.filter').first().hasClass('without-isotope');
        }

        e.preventDefault();

        $this.trigger("mouseleave");

        if ($this.hasClass("act_menu_title") && !$this.hasClass("show-all")) {
            e.stopImmediatePropagation();
            $this.removeClass("act_menu_title");
            $this.siblings("a.show-all").trigger('click');//.addClass("act");
        } else {
            $this.siblings().removeClass("act_menu_title");
            $this.addClass("act_menu_title");

            if (!arguments.callee.dtPreventD) {
                window.location.href = $this.attr('href');
            }
        }
    });

    $(".filter-extras a").on("click", function (e) {
        var $this = $(this);

        if (typeof arguments.callee.dtPreventD == 'undefined') {
            arguments.callee.dtPreventD = !$this.parents('.filter').first().hasClass('without-isotope');
        }

        if (arguments.callee.dtPreventD) {
            e.preventDefault();
        }

        $this.siblings().removeClass("act_menu_title");
        $this.addClass("act_menu_title");
    });

    /* Masonry layout: end */

    $('.full-boxed-pricing').each(function () {
        $(this).find('.shortcode-pricing-table').last().addClass('last')
    })

    /* !Widgets: */

    if (dtGlobals.isMobile) {
        $('.fs-navigation .prev, .fs-navigation .next').addClass('ar-hide');

    } else {

    };

    $('img').on('dragstart', function (event) { event.preventDefault(); });
    $('.fs-entry .show-content, .rollover-project .show-content').each(function () {
        var $this = $(this);
        $this.append('<i></i>')
    });


    $('.no-touch .fs-entry, .no-touch .swiper-slide').each(function () {
        var ent = $(this);
        ent.find('> .link').on('mousedown', function (e) {
            var mouseDX = e.pageX,
                mouseDY = e.pageY;
            ent.find('> .link').one('mouseup', function (e) {
                var mouseUX = e.pageX,
                    mouseUY = e.pageY;
                if (Math.abs(mouseDX - mouseUX) < 5) {
                    var $thisLink = $(this),
                        ent = jQuery(this).parents('.fs-entry, .swiper-slide'),
                        mi = ent.find('.fs-entry-content, > .swiper-caption');
                    $('.fs-entry .link, .swiper-slide > .link').removeClass('act');
                    $thisLink.addClass('act');
                    $('.fs-entry-content, .swiper-caption').not(mi).fadeOut(300);
                    mi.delay(300).fadeIn(400);
                }
            })

        });
        ent.find('.close-link').on('mousedown tap', function (e) {
            var $this = $(this),
                ent = jQuery(this).parents('.fs-entry, .swiper-slide'),
                mi = ent.find('.fs-entry-content, > .swiper-caption');

            mi.delay(100).fadeOut(300, function () {
                ent.find('> .link').removeClass('act');
            });
        });
    });
    $('.touch .fs-entry, .rollover-project, .touch .swiper-slide').each(function () {
        var ent = jQuery(this);
        /*ent.find('>.link').on('tap', function() {
            var $this = $(this),
                ent=jQuery(this).parents('.fs-entry, .swiper-slide'),
                mi=ent.find('.fs-entry-content, > .swiper-caption');
            $('.fs-entry .link, .swiper-slide > .link').removeClass('act');
            $this.addClass('act');
            $('.fs-entry-content, .swiper-caption').not(mi).fadeOut(300);
            //mi.fadeOut(300);		
            mi.delay(300).fadeIn(400);		
        });
        
        ent.find('.close-link').on('tap', function() {
            var $this = $(this),
                ent=jQuery(this).parents('.fs-entry, .swiper-slide'),
                mi=ent.find('.fs-entry-content, > .swiper-caption');
            
            mi.delay(100).fadeOut(300, function(){
                ent.find('> .link').removeClass('act');
            });
        });*/

        ent.find('> .link').on('mousedown tap', function (e) {
            var mouseDX = e.pageX,
                mouseDY = e.pageY;
            ent.find('> .link').one('mouseup tap', function (e) {
                var mouseUX = e.pageX,
                    mouseUY = e.pageY;
                if (Math.abs(mouseDX - mouseUX) < 5) {
                    var $thisLink = $(this),
                        ent = jQuery(this).parents('.fs-entry, .swiper-slide'),
                        mi = ent.find('.fs-entry-content, > .swiper-caption');
                    $('.fs-entry-content, .swiper-caption').not(mi).fadeOut(200);
                    mi.delay(100).fadeIn(300);
                }
            })

        });
        ent.find('.close-link').on('mousedown tap', function (e) {
            var $this = $(this),
                ent = jQuery(this).parents('.fs-entry, .swiper-slide'),
                mi = ent.find('.fs-entry-content, > .swiper-caption');

            mi.delay(100).fadeOut(200, function () {
            });
        });
    });
    $('.touch .rollover-project').each(function () {
        var ent = $(this);
        ent.find('.link').on('tap', function () {
            var $this = $(this),
                ent = $(this).parents('.rollover-project'),
                mi = ent.find('.rollover-content');
            $('.rollover-project .link').removeClass('act');
            $this.addClass('act');
            $('.rollover-content').not(mi).fadeOut(300);
            //mi.fadeOut(300);		
            mi.delay(150).fadeIn(200);
        });

        ent.find('.close-link').on('tap', function () {
            var $this = $(this),
                ent = jQuery(this).parents('.rollover-project'),
                mi = ent.find('.rollover-content');

            mi.delay(100).fadeOut(100, function () {
                ent.find('.link').removeClass('act');
            });
        });
    });
    // Albums, exclude featured image from gallery post
    $('.albums .ignore-feaured-image').on('click', function (e) {
        e.preventDefault();
        $(this).siblings('.dt-prettyphoto-gallery-container').first().find("a[rel^='prettyPhoto']").first().click();
        return false;
    });

    // albums with rollover info
    $('.albums .rollover-content, .media .rollover-content').on('click', function (e) {
        if ($(e.target).is('a')) return true;
        $(this).siblings("a[rel^='prettyPhoto']").first().click();
    });

    // init prettyPhoto
    //  $("a[rel^='prettyPhoto']").prettyPhoto();

    //device rollovers



    $('#parent-element a').live("touchstart", function (e) {
        var $link_id = $(this).attr('id');
        if ($(this).parent().data('clicked') == $link_id) {
            // element has been tapped (hovered), reset 'clicked' data flag on parent element and return true (activating the link)
            $(this).parent().data('clicked', null);
            return true;
        } else {
            $(this).trigger("mouseenter").siblings().trigger("mouseout"); //triggers the hover state on the tapped link (because preventDefault(); breaks this) and untriggers the hover state for all other links in the container.
            // element has not been tapped (hovered) yet, set 'clicked' data flag on parent element to id of clicked link, and prevent click
            e.preventDefault(); // return false; on the end of this else statement would do the same
            $(this).parent().data('clicked', $link_id); //set this link's ID as the last tapped link ('clicked')
        }
    });

    $('.skill-value').each(function () {
        var $_this = $(this),
            $this_data = $_this.data('width'),
            current_percent = 0,
            progress = null;
        var progress = setInterval(function () {
            if (current_percent >= $this_data) {
                clearInterval(progress);
                $_this.find('> span').delay(2000).fadeOut(200, function () { });

            } else {
                current_percent += 1
                var skill_html = parseInt($_this.find('> span').html());
                $_this.css({
                    width: current_percent + '%'
                });
                if (skill_html >= 99) {
                    $_this.addClass('full');
                }
                //console.log(current_percent)
            }
            $_this.find('> span').text(current_percent + '%');

        }, 10)


        /*function run(){
            if( current_percent >= $this_data ){
                clearInterval(progress);
                $_this.find('> span').delay(2000).fadeOut(200, function(){});			
    
            }else{
                current_percent++;
                $_this.css('width', current_percent +"%");
                $_this.find('> span').text(current_percent+"%");
                if(current_percent == 100){
                    clearInterval(progress);
                    //ex1running = false;
                }
            }
        }
        progress = setInterval(run, 50);*/
        var fadeTimeout;
        $_this.hover(function () {
            clearTimeout(fadeTimeout);
            fadeTimeout = setTimeout(function () {
                $_this.find('> span').stop(true, true).fadeIn(200);
            }, 200);
        }, function () {
            clearTimeout(fadeTimeout);
            $_this.find('> span').fadeOut(200);
        });

    });

    /* !- Grayscale */
    if (!(typeof simple_tooltip == "undefined")) {
        simple_tooltip(".shortcode-tooltip", "shortcode-tooltip-content");
    }

    // !- Accordion
    $('.st-toggle').toggle();
    $('.st-accordion').accordion({
        open: 0,
        oneOpenedItem: true
    });

    $(".filter-grayscale .slider-masonry").on("mouseenter tap", function (e) {
        if (e.type == "tap") {
            e.stopPropagation();
            //e.preventDefault();
        }
        $(this).addClass("dt-hovered");
    });

    $(".filter-grayscale .slider-masonry").on("mouseleave", function (e) {
        $(this).removeClass("dt-hovered");
    });

    /* Grayscale: end */


    /* !- Fancy grid */

    $.fn.fancyGrid = function (options) {
        return this.each(function () {

            var defaults = {
                setWidth: true,
                setHeight: false,
                setLineHeight: false,
                cellsSelector: "",
                contentSelector: "",
                borderBoxSelector: "",
                maintainBorders: false,
                maintainImages: false,
                minColWidth: 150
            },
                settings = $.extend({}, defaults, options),
                $gridContainer = $(this),
                $cells = settings.cellsSelector ? $(settings.cellsSelector, $gridContainer) : $gridContainer.children();


            if ($cells.length < 1) return false;

            var calcWidth = function () {
                var containerWidth = $gridContainer.width();

                var $this = $($cells[0]),
                    curW = $this.width(),
                    basicW,
                    basicDenom = $gridContainer.data("basicDenom"),
                    basicCSS = $gridContainer.data("basicCSS"),
                    basicClass = $gridContainer.data("basicClass");

                if (!basicDenom) {
                    if ($this.hasClass("wf-1-6")) {
                        basicDenom = 6;
                        basicCSS = "16.6667%";
                        basicClass = "wf-1-6";
                    }
                    else if ($this.hasClass("wf-1-5")) {
                        basicDenom = 5;
                        basicCSS = "20%";
                        basicClass = "wf-1-5";
                    }
                    else if ($this.hasClass("wf-1-4")) {
                        basicDenom = 4;
                        basicCSS = "25%";
                        basicClass = "wf-1-4";
                    }
                    else if ($this.hasClass("wf-1-3")) {
                        basicDenom = 3;
                        basicCSS = "33.3333%";
                        basicClass = "wf-1-3";
                    }
                    else if ($this.hasClass("wf-2-4") || $this.hasClass("wf-1-2")) {
                        basicDenom = 2;
                        basicCSS = "50%";
                        basicClass = "wf-1-2";
                    }
                    else if ($this.hasClass("wf-1")) {
                        basicDenom = 1;
                        basicCSS = "100%";
                        basicClass = "wf-1";
                    };
                };

                $gridContainer.data("basicDenom", basicDenom);
                $gridContainer.data("basicCSS", basicCSS);
                $gridContainer.data("basicClass", basicClass);

                basicW = containerWidth / basicDenom;

                if (basicW < settings.minColWidth) {
                    $cells.css({ 'width': 100 / Math.floor(containerWidth / settings.minColWidth) + '%' });
                } else {
                    $cells.css("width", basicCSS);
                }

                /*
                            if (basicW < 150 && containerWidth/2 > 150) {
                                $cells.css("width", "50%");
                            }
                            else if (basicW < 150 && containerWidth/2 <= 150) {
                                $cells.css("width", "100%");
                            }
                            else {
                                $cells.css("width", basicCSS);
                            };
                */
            };

            var calcHeight = function () {
                var topPosition = 0,
                    totalRows = 0,
                    currentRowStart = 0,
                    currentRow = -1,
                    rows = [],
                    tallest = [];

                $cells.each(function () {

                    var $this = $(this),
						currentHeight = settings.contentSelector ? $(settings.contentSelector, $this).outerHeight(true) : $this.children().outerHeight(true);

                    topPostion = $this.position().top;

                    if (currentRowStart != topPostion) {
                        // We just came to a new row
                        // Set the variables for the new row
                        currentRow++;
                        currentRowStart = topPostion;
                        tallest[currentRow] = currentHeight;
                        rows.push([]);
                        rows[currentRow].push($this);

                    } else {

                        // Another div on the current row. Add it to the list and check if it's taller
                        rows[currentRow].push($this);
                        tallest[currentRow] = (tallest[currentRow] < currentHeight) ? (currentHeight) : (tallest[currentRow]);

                    }

                });

                totalRows = rows.length;

                for (i = 0; i < totalRows; i++) {
                    var inCurrentRow = rows[i].length;

                    for (j = 0; j < inCurrentRow; j++) {

                        settings.borderBoxSelector ? $(settings.borderBoxSelector, rows[i][j]).css("height", tallest[i]) : rows[i][j].css("height", tallest[i]);
                        if (settings.setLineHeight)
                            settings.borderBoxSelector ? $(settings.borderBoxSelector, rows[i][j]).css("line-height", tallest[i] + 'px') : rows[i][j].css("line-height", tallest[i] + 'px');

                        if (settings.maintainBorders && j == 0) {
                            rows[i][j].addClass("border-left-none");
                        } else {
                            rows[i][j].removeClass("border-left-none");
                        }

                        if (settings.maintainBorders && i == totalRows - 1) {
                            rows[i][j].addClass("border-bottom-none");
                        } else {
                            rows[i][j].removeClass("border-bottom-none");
                        }

                    }
                }

            }


            if (settings.setWidth) calcWidth();
            if (settings.setHeight || settings.setLineHeight) calcHeight();

            if (settings.maintainImages) {
                $("img", $cells).loaded(null, function () {
                    $gridContainer.addClass("grid-ready");
                    if (settings.setHeight || settings.setLineHeight) calcHeight();
                }, true);
            } else {
                $gridContainer.addClass("grid-ready");
            }

            $(window).on("debouncedresize", function () { // ! needs to be !changed
                if (settings.setWidth) calcWidth();
                if (settings.setHeight || settings.setLineHeight) calcHeight();
            });

        });
    }

    $(".items-grid").fancyGrid({
        setWidth: true,
        setHeight: true,
        maintainBorders: true,
        contentSelector: "article",
        borderBoxSelector: ".borders_new",
        minColWidth: 180
    });

    $(".benefits-grid").fancyGrid({
        setWidth: true,
        setHeight: true,
        maintainBorders: true,
        maintainImages: true,
        contentSelector: ".borders_new > div",
        borderBoxSelector: ".borders_new",
        minColWidth: 180
    });
    $(".logos-grid").fancyGrid({
        setWidth: true,
        setHeight: true,
        setLineHeight: true,
        maintainBorders: true,
        maintainImages: true,
        contentSelector: ".borders_new > a img",
        borderBoxSelector: ".borders_new",
        minColWidth: 130
    });

    /* Fancy grid: end */


    /* !Sandbox */
    /* !Fancy header*/
    var fancyFeaderOverlap = $("#fancy-header.overlap").exists();

    function fancyFeaderCalc() {
        if (fancyFeaderOverlap) {
            $("#fancy-header.overlap > .wf-wrap").css({
                "padding-top": $("#header").height()
            });
        }
    }

    fancyFeaderCalc();

    /* Fancy header:end*/
    /* !Rolovers*/
    $('.rollover, .rollover-video, .post-rollover, .swiper-slide .link').each(function () {
        var $this = $(this);
        $this.append('<i></i>');
    });
    $('.rollover, .post-rollover').each(function () {
        var $this = $(this);
        if ($("html").hasClass("old-ie")) {
            $(".rollover i, .post-rollover i, .rollover .rollover-thumbnails").fadeOut();
            $this.hover(function () {
                $("i, .rollover-thumbnails", this).css('display', 'block');
            }, function () {
                $("i, .rollover-thumbnails", this).css('display', 'none');
            });
        }
    });
    $('.fs-entry, .rollover-project .link, .swiper-slide').each(function () {
        var $this = $(this);
        if ($("html").hasClass("old-ie")) {
            $(".fs-entry .link, .rollover-project .link i, .swiper-slide .link").fadeOut();
            $this.hover(function () {
                $(" > .link, i", this).css('display', 'block');
            }, function () {
                $(" > .link, i", this).css('display', 'none');
            });
        }
    });
    /* Rolovers:end*/
    /* !Share links*/
    $('.entry-share a').each(function () {
        var caroufredselTimeout;
        var $this = $(this);
        $this.find('.share-content').css({
            'margin-left': -$this.find('.share-content').width() / 2
        })

        $this.hover(function () {
            clearTimeout(caroufredselTimeout);
            caroufredselTimeout = setTimeout(function () {
                $this.find('.share-content').stop(true, true).fadeIn(200);
            }, 200);
        }, function () {
            clearTimeout(caroufredselTimeout);
            $this.find('.share-content').fadeOut(200);
        });

    });
    /*Share links: end*/

    var addSliderTimeout;
    clearTimeout(addSliderTimeout);
    //jQuery(".swiper-container").fadeOut();
    addSliderTimeout = setTimeout(function () {
        //var homeSliderH = jQuery(".swiper-container").height();
        if ($(".swiper-container").length) {
            var loading_label = jQuery("<div></div>").attr("id", "loading-label").addClass("loading-label").css("position", "fixed").hide().appendTo("body");
            loading_label.fadeIn(250);

            jQuery(".swiper-container").animate({
                //minHeight : homeSliderH + "px"
            }, 500, function () {
                //jQuery(".swiper-container > .swiper-wrapper").fadeIn();
                loading_label.fadeOut(500);
            });
        };
    }, 300);

    /* !Metro slider*/
    $(".swiper-container > .swiper-wrapper > .swiper-slide .preload-me").loaded(null, function () {

        /* !Metro slider*/
        if ($('.swiper-wrapper').length > 0) {
            var swiperColH = 6;
            var swiperN1 = $('.swiper-n1').swiper({
                slidesPerSlide: swiperColH,
                onTouchMove: function () {
                    var posX = swiperN1.getTranslate('x');

                    if (posX >= 0) {
                        $('.swiper-n1 .arrow-right').removeClass('disable');
                        $('.swiper-n1 .arrow-left').addClass('disable');
                    } else if (posX <= -($('.swiper-n1 > .swiper-wrapper').width() - $('.swiper-n1').width())) {
                        $('.swiper-n1 .arrow-right').addClass('disable');
                        $('.swiper-n1 .arrow-left').removeClass('disable');
                    } else {
                        $('.swiper-n1 .arrow-left').removeClass('disable');
                        $('.swiper-n1 .arrow-right').removeClass('disable');
                    }
                },
                onSlideChangeEnd: function () {
                    var posX = swiperN1.getTranslate('x');
                    if (posX >= 0) {
                        $('.swiper-n1 .arrow-right').removeClass('disable');
                        $('.swiper-n1 .arrow-left').addClass('disable');
                    } else if (posX <= -($('.swiper-n1 > .swiper-wrapper').width() - $('.swiper-n1').width())) {
                        $('.swiper-n1 .arrow-right').addClass('disable');
                        $('.swiper-n1 .arrow-left').removeClass('disable');
                    }
                }

            });
            var swiperN1Length = swiperN1.slides.length;

            $('.swiper-n1 .arrow-left').addClass('disable');
            //Navigation arrows
            $('.swiper-n1 .arrow-left').click(function (e) {
                e.preventDefault();
                swiperN1.swipePrev();
                var swiperN1Index = swiperN1.activeIndex;
                $('.swiper-n1 .arrow-right').removeClass('disable');
                if (swiperN1Index == 0) {

                    $(this).addClass('disable');
                } else {
                    $(this).removeClass('disable');
                }
            });
            $('.swiper-n1 .arrow-right').click(function (e) {
                e.preventDefault();
                swiperN1.swipeNext();
                var swiperN1Index = swiperN1.activeIndex;
                $('.swiper-n1 .arrow-left').removeClass('disable');
                if ((swiperN1Index + swiperColH) >= swiperN1Length) {

                    $(this).addClass('disable');
                } else {
                    $(this).removeClass('disable');
                }
            });
            //Vertical
            var swiperCol = 3;
            var swiperN2 = $('.swiper-n2').swiper({
                slidesPerSlide: swiperCol,
                mode: 'vertical',
                onTouchMove: function () {
                    var posY = swiperN2.getTranslate('y');
                    if ((posY) >= 0) {
                        $('.swiper-n2 .arrow-bottom').removeClass('disable');
                        $('.swiper-n2 .arrow-top').addClass('disable');
                    } else if ((posY) <= -($('.swiper-n2 > .swiper-wrapper').height() - $('.swiper-n2').height())) {
                        $('.swiper-n2 .arrow-bottom').addClass('disable');
                        $('.swiper-n2 .arrow-top').removeClass('disable');
                    } else {
                        $('.swiper-n2 .arrow-top').removeClass('disable');
                        $('.swiper-n2 .arrow-bottom').removeClass('disable');
                    }
                },
                onSlideChangeEnd: function () {
                    var posY = swiperN2.getTranslate('y');
                    if (posY >= 0) {
                        $('.swiper-n2 .arrow-bottom').removeClass('disable');
                        $('.swiper-n2 .arrow-top').addClass('disable');
                    } else if (posY <= -($('.swiper-n2 > .swiper-wrapper').height() - $('.swiper-n2').height())) {
                        $('.swiper-n2 .arrow-bottom').addClass('disable');
                        $('.swiper-n2 .arrow-top').removeClass('disable');
                    }
                }
            });

            var swiperN2Length = swiperN2.slides.length;
            $('.swiper-n2 .arrow-top').addClass('disable');
            $('.swiper-n2 .arrow-top').click(function (e) {
                e.preventDefault();
                swiperN2.swipePrev();
                var swiperN2Index = swiperN2.activeIndex;
                $('.swiper-n2 .arrow-bottom').removeClass('disable');
                if (swiperN2Index == 0) {
                    $(this).addClass('disable');
                } else {
                    $(this).removeClass('disable');
                }
            });
            $('.swiper-n2 .arrow-bottom').click(function (e) {
                e.preventDefault();
                swiperN2.swipeNext();
                var swiperN2Index = swiperN2.activeIndex;
                $('.swiper-n2 .arrow-top').removeClass('disable');
                if ((swiperN2Index + swiperCol) >= swiperN2Length) {

                    $(this).addClass('disable');
                } else {
                    $(this).removeClass('disable');
                }
            });


            var swiperN3 = $('.swiper-n3').swiper({
                slidesPerSlide: swiperCol,
                mode: 'vertical',
                slidesPerSlide: swiperCol,
                mode: 'vertical',
                onTouchMove: function () {
                    var posY = swiperN3.getTranslate('y');
                    if ((posY) >= 0) {
                        $('.swiper-n3 .arrow-bottom').removeClass('disable');
                        $('.swiper-n3 .arrow-top').addClass('disable');
                    } else if ((posY) <= -($('.swiper-n3 > .swiper-wrapper').height() - $('.swiper-n3').height())) {
                        $('.swiper-n3 .arrow-bottom').addClass('disable');
                        $('.swiper-n3 .arrow-top').removeClass('disable');
                    } else {
                        $('.swiper-n3 .arrow-top').removeClass('disable');
                        $('.swiper-n3 .arrow-bottom').removeClass('disable');
                    }
                },
                onSlideChangeEnd: function () {
                    var posY = swiperN3.getTranslate('y');
                    if (posY >= 0) {
                        $('.swiper-n3 .arrow-bottom').removeClass('disable');
                        $('.swiper-n3 .arrow-top').addClass('disable');
                    } else if ((posY - 10) <= -($('.swiper-n3 > .swiper-wrapper').height() - $('.swiper-n3').height())) {
                        $('.swiper-n3 .arrow-bottom').addClass('disable');
                        $('.swiper-n3 .arrow-top').removeClass('disable');
                    }
                }
            });

            var swiperN3Length = swiperN3.slides.length;
            $('.swiper-n3 .arrow-top').addClass('disable');
            $('.swiper-n3 .arrow-top').click(function (e) {
                e.preventDefault();
                swiperN3.swipePrev();
                var swiperN3Index = swiperN3.activeIndex;
                $('.swiper-n3 .arrow-bottom').removeClass('disable');
                if (swiperN3Index == 0) {
                    $(this).addClass('disable');
                } else {
                    $(this).removeClass('disable');
                }
            });
            $('.swiper-n3 .arrow-bottom').click(function (e) {
                e.preventDefault();
                swiperN3.swipeNext();
                var swiperN3Index = swiperN3.activeIndex;
                $('.swiper-n3 .arrow-top').removeClass('disable');
                if ((swiperN3Index + swiperCol) >= swiperN3Length) {

                    $(this).addClass('disable');
                } else {
                    $(this).removeClass('disable');
                }
            });


            $(window).resize(function () {
                //Unset height
                $('.swiper-container').css({ height: '' })
                //Calc Height
                $('.swiper-container').css({ height: $('.swiper-container').find('img').height() });
                swiperN1.reInit();
                swiperN2.reInit();
                swiperN3.reInit();

            }).trigger('resize')
        };
    });
    /* !Metro slider: end*/
    $(window).on("debouncedresize", function (event) {
        dtGlobals.resizeCounter++;
        calcPics();
        moveOffset();
        fancyFeaderCalc();
        $(".slider-wrapper").not('.full').each(function () {
            var scroller = $(this).children().data("theScroller");
            scroller.update();
        });
        /*H1 max-width*/
        $('h1.entry-title').css({
            'max-width': $('.content').width() - $('.navigation-inner').width()
        })


    }).trigger("debouncedresize");

    /* !Beautiful loading */

    dtGlobals.imgLoaded = setTimeout(function () {
        $("body").append('<style>img {opacity: 1}</style>');
    }, 20000);

    $("img").loaded(

		function () {
		    $(this).css("opacity", 1);
		},
		function () {
		    clearTimeout(dtGlobals.imgLoaded);
		},
		true
	);

    /* !Beautiful loading: end */
    /* Sandbox: end */

    /* Old ie raw emulation */
    //$("html").addClass("old-ie");

}
function LoadImagesOpacity() {
    $("img").loaded(

           function () {
               $(this).css("opacity", 1);
           }
       );
}

function openMoreCars(obj) {
    if (!$(obj).parents(".drive_wrapper").find(".div_more_cars_JS").hasClass("open_car_details_JS")) {
        if ($(obj).find(".img_more_details").length > 0) {
            $(obj).find(".img_more_details").attr("src", GlobalAppRootJS + "/images/arrow-down-blue.PNG");
            $(obj).find(".img_more_details").addClass("mt2");
            $(obj).parents(".drive_wrapper").find(".more_cars_text_flydrive_JS").hide();
        } else if ($(obj).parents(".drive_wrapper").find(".img_more_details").length > 0) {
            $(obj).parents(".drive_wrapper").find(".img_more_details").attr("src", GlobalAppRootJS + "/images/arrow-down-blue.PNG");
            $(obj).parents(".drive_wrapper").find(".img_more_details").addClass("mt2");
            $(obj).parents(".drive_wrapper").find(".more_cars_text_flydrive_JS").hide();
        }
        $(obj).parents(".drive_wrapper").find(".div_more_cars_JS").slideDown("easy");
        $(obj).parents(".drive_wrapper").find(".div_more_cars_JS").addClass("open_car_details_JS");
    } else {
        if ($(obj).find(".img_more_details").length > 0) {
            $(obj).find(".img_more_details").attr("src", GlobalAppRootJS + "/images/arrow-left-blue.PNG");
            $(obj).find(".img_more_details").removeClass("mt2");
            $(obj).parents(".drive_wrapper").find(".more_cars_text_flydrive_JS").show();
        } else if ($(obj).parents(".drive_wrapper").find(".img_more_details").length > 0) {
            $(obj).parents(".drive_wrapper").find(".img_more_details").attr("src", GlobalAppRootJS + "/images/arrow-left-blue.PNG");
            $(obj).parents(".drive_wrapper").find(".img_more_details").removeClass("mt2");
            $(obj).parents(".drive_wrapper").find(".more_cars_text_flydrive_JS").show();
        }

        $(obj).parents(".drive_wrapper").find(".div_more_cars_JS").slideUp("easy");
        $(obj).parents(".drive_wrapper").find(".div_more_cars_JS").removeClass("open_car_details_JS");
    }
}

var FromDynamicFlight = false;
function getFlightDetails(obj) {
    if ($(obj).parents(".search_result_box_wrapper").find(".flightDetailsWrapper").css('display') != 'none') {
        $(obj).parents(".search_result_box_wrapper").find(".flightDetailsWrapper").slideUp("easy");
        $(obj).parents(".search_result_box_wrapper").removeClass("open");


        if ($(obj).find(".img_more_details").length > 0) {
            $(obj).find(".img_more_details").attr("src", GlobalAppRootJS + "/images/arrow-left-blue.PNG");
            $(obj).find(".img_more_details").removeClass("mt2");
        }

    } else {

        if ($(obj).find(".img_more_details").length > 0) {
            $(obj).find(".img_more_details").attr("src", GlobalAppRootJS + "/images/arrow-down-blue.PNG");
            $(obj).find(".img_more_details").addClass("mt2");
        }

        if (!$(obj).hasClass("isFilled")) {

            var serializedObject = $(obj).find(".SerializedItinerary").val();
            var postData = new Object({ "data": serializedObject, "FromDynamicFlight": FromDynamicFlight });

            $.ajax({
                type: 'POST',
                url: GlobalAppRootJS + "/Handlers/FlightDetailsPopUp.aspx",
                data: postData,
                success: function (data) {
                    if (data == "") {
                        //alert('<%=Resource("CantChooseHotel", "Hotel")%>');
                        return;
                    } else {

                        //$("#testPopup").html(data);

                        $(obj).parents(".search_result_box_wrapper").find(".flightDetailsWrapper").hide();
                        $(obj).parents(".search_result_box_wrapper").find(".flightDetailsWrapper").html(data);

                        if ($(obj).hasClass('fly_drive_JS')) {
                            $('.total_price_per_pass').hide();
                        }
                        $(obj).parents(".search_result_box_wrapper").find(".flightDetailPopupWrapper_js").fadeIn(500);
                        $(obj).parents(".search_result_box_wrapper").find(".flightDetailsWrapper").center()
                        $(obj).parents(".search_result_box_wrapper").find(".flightDetailsWrapper").fadeIn(500);

                        //$(obj).parents(".search_result_box_wrapper").find(".flightDetailsWrapper").slideDown("easy");
                        $(obj).addClass("isFilled");

                        $(obj).parents(".search_result_box_wrapper").addClass("open");
                    }

                },
                error: function (request, status, error) {
                    alert('חלה שגיאה, נא נסה שנית');
                },
                complete: function () {
                    // $(obj).parents(".search_result_box_wrapper").find(".flightDetailsWrapper").slideDown("easy");

                }
            });
        } else {
            //$(obj).parents(".search_result_box_wrapper").find(".flightDetailsWrapper").slideDown("easy");
            $(obj).parents(".search_result_box_wrapper").find(".flightDetailPopupWrapper_js").fadeIn(500);
            $(obj).parents(".search_result_box_wrapper").find(".flightDetailsWrapper").center()
            $(obj).parents(".search_result_box_wrapper").find(".flightDetailsWrapper").fadeIn(500);
            $(obj).parents(".search_result_box_wrapper").addClass("open");
        }
    }
}

function getFlightDetailsPopUp(obj) {

    if (!$(obj).hasClass("isFilled")) {

        var serializedObject = $(obj).find(".SerializedItinerary").val();
        var postData = new Object({ "data": serializedObject, "FromDynamicFlight": FromDynamicFlight });

        $.ajax({
            type: 'POST',
            url: GlobalAppRootJS + "/Handlers/FlightDetailsPopup.aspx",
            data: postData,
            success: function (data) {
                if (data == "") {
                    return;
                } else {
                    var wrap = $(obj).siblings(".flightDetailPopupWrapper_js");
                    $(wrap).find(".flightDetailsWrapper").html(data);
                    $(wrap).fadeIn(500);
                    $(wrap).find(".flightDetailsWrapper").fadeIn(500);

                    //set max popup height to 80% of window height:
                    var windowHeight = Math.round($(window).height() * 0.8) - 37;
                    if ($(wrap).find(".flightDetailsWrapper .custom-scrollbar").height() > windowHeight) {
                        $(wrap).find(".flightDetailsWrapper .custom-scrollbar").height(windowHeight);
                    }


                    $(wrap).find(".flightDetailsWrapper").centerFixed();
                    $(obj).addClass("isFilled");
                }

            },
            error: function (request, status, error) {
                alert('חלה שגיאה, נא נסה שנית');
            }
        });
    } else {
        var wrap = $(obj).siblings(".flightDetailPopupWrapper_js");
        $(wrap).fadeIn(500);
        $(wrap).find(".flightDetailsWrapper").fadeIn(500);
        $(wrap).find(".flightDetailsWrapper").centerFixed();
    }
}

function closeFlightInfoPopup() {
    $(".flightDetailPopupWrapper_js").fadeOut(500);
    $(".flightDetailsWrapper").fadeOut(500);
}
function addDaysToDate(date, days) {
    var result = new Date(date);
    result.setDate(date.getDate() + days);
    return result;
}

function OpenMoreHotelResults(obj) {
    if ($(obj).hasClass('div_close_more_result_JS')) {
        obj = $(obj).parents('.search_item').find('.div_openMoreHotels_JS');
    }
    showMoreHotelResults(obj);
}

function showMoreHotelResults(obj) {
    var moreResultElement = $(obj).parents(".search_item").find(".div_WrapperMoreResults");

    //Not at Use at Deals(=if not deals)
    if (!$(obj).hasClass('div_openMoreHotels_JS')) {
        setArrowPosition(obj, !moreResultElement.is(':visible'));
    }
    moreResultElement.slideToggle(400, openAndCloseMoreResultsDeals(obj));
}

function openAndCloseMoreResultsDeals(obj) {
    if ($(obj).parents('.search_item').find('.div_close_more_result_JS').is(':visible')) {
        $(obj).parents('.search_item').find('.div_close_more_result_JS').hide();
        $(obj).parents('.search_item').removeClass('open_search_results');
        $(obj).parents('.search_item').find('.span_arrow_JS').html('▼');
        $(obj).parents('.search_item').find('.i_arrow_JS').removeClass('icon-arrow_up');
        $(obj).parents('.search_item').find('.i_arrow_JS').addClass('icon-arrow_down');
    } else {
        $(obj).parents('.search_item').find('.div_close_more_result_JS').show();
        $(obj).parents('.search_item').addClass('open_search_results');
        $(obj).parents('.search_item').find('.span_arrow_JS').html('▲');
        $(obj).parents('.search_item').find('.i_arrow_JS').removeClass('icon-arrow_down');
        $(obj).parents('.search_item').find('.i_arrow_JS').addClass('icon-arrow_up');
    }
}
function setArrowPosition(obj, down) {

    var position = "left";
    if (down) {
        position = "down";
    }
    $(obj).parent().find("img").attr('src', GlobalAppRootJS + "/images/arrow-" + position + "-blue.PNG");

}

function loadErrorTimeOutPopUp() {
    $("#dialog_ttl_time_overtime").dialog({
        autoOpen: true,
        modal: false,
        height: 300,
        width: 500,
        open: function (event, ui) {
            $('.parg_can').show();
            $('.popup_serach_again_btn ').show();

        },
        close: function (event, ui) {
            $('.parg_can').hide();
            $('.popup_serach_again_btn ').hide();
            //Show Wizard For Out logic
            $('#main_wizard').show();
            $('#wrap_Hotel').show();
            //Set true To Avoid Getting Same Resualt From Cache
            //$("#hdn_SkipHotel").val("True");
            $('#btn_sumbit').click();//parent.history.back();
            $("#hdn_SkipHotel").val("False");
            $('#main_wizard').hide();
            $('#wrap_Hotel').hide();
        },
        buttons: {
            OK: function () {
                $(this).dialog("close");
                location.reload(true);
            }

        },
        dialogClass: 'TTlPopUp'

    });

    $('.TTlPopUp .ui-button-text:contains(OK)').text('אישור');

}

$(document).ready(function () {
    $('.text-banner-conteiner').mouseover(function () {
        $(this).next().find('.promo_shadow').addClass("promo_shadow_hover");
    });
    $('.text-banner-conteiner').mouseout(function () {
        $(this).next().find('.promo_shadow').removeClass("promo_shadow_hover");
    });
    $('.stamp-position').mouseover(function () {
        $(this).next().addClass("promo_shadow_hover");
    });
    $('.stamp-position').mouseout(function () {
        $(this).next().removeClass("promo_shadow_hover");
    });
    $('.text-banner-conteiner').mouseover(function () {
        $(this).parent().parent().find('.promo_shadow').addClass("promo_shadow_hover");
    });
    $('.text-banner-conteiner').mouseout(function () {
        $(this).parent().parent().find('.promo_shadow').removeClass("promo_shadow_hover");
    });
    $('.discount-row.discount-row-small').mouseover(function () {
        $(this).parent().next().find('.promo_shadow').addClass("promo_shadow_hover");
    });
    $('.discount-row.discount-row-small').mouseout(function () {
        $(this).parent().next().find('.promo_shadow').removeClass("promo_shadow_hover");
    });

});

function bindResetEventToOrderClick() {

    $(".order").click(function () {
        resetSearch();
    });
}

function resetSearch(event) {

    $('.domestic_search_details').show();
    $('#main_wizard').hide();
    $('#main_wizard').height('');
}
function CutDisplayedText(str, maxLength) {
    var strTmp = str;
    if (str != '' && str.length > maxLength) {
        strTmp = str.substring(0, maxLength);
        var i = strTmp.lastIndexOf(' ') + 1;
        strTmp = i > 0 ? strTmp.substring(0, i) : strTmp;
    }
    return strTmp;
}
function CutMoreText(str, maxLength) {
    try {
        var strTmp = str;

        if (str != '' && str.length > maxLength) {
            var strLenght = str.length;
            strTmp = str.substring(0, maxLength);
            var index = strTmp.lastIndexOf(' ');

            if (index > 0 && strLenght > index) {
                var indexFrom = index + 1;
                var indexTo = strLenght - indexFrom;
                strTmp = str.substring(indexFrom, strLenght);
            }
            else {
                strTmp = str;
            }
        }
        return strTmp;
    } catch (e) {
        return '';
    }

}

function normalizePromosHeight() {

    var maxHeight = -1;
    var maxContentHeight = -1;

    // normalize promos heights in the home page promos gallery
    if ($(".banner-2-columns").length > 0) {
        maxHeight = -1;
        maxContentHeight = -1;

        $('.banner-2-columns .small_promotion .promo_content').each(function () {
            maxHeight = maxHeight > $(this).height() ? maxHeight : $(this).height();
        });
        $('.banner-2-columns .small_promotion .promo_content').height(maxHeight);

    }
    // normalize promos heights in the lobby pages promos gallery
    $(".lobby_structure_new").each(function () {

        if ($(this).find('.promotion_item').length > 0) {

            maxHeight = -1;
            maxContentHeight = -1;

            $(this).find('.promotion_item .promo_content').each(function () {
                maxHeight = maxHeight > $(this).height() ? maxHeight : $(this).height();
            });
            $(this).find('.promotion_item .promo_content').height(maxHeight);


            var promotionHeight = $(this).find(".promotion_item").first().height();
            var containerHeight = promotionHeight * 2 - 20;



            $(this).find('.block-info-loby-hotel').height(promotionHeight);
            $(this).find('.hot-destination').height(containerHeight);


            $(this).find('.promotion_item .promo_price_and_notes').each(function () {
                maxContentHeight = maxContentHeight > $(this).height() ? maxContentHeight : $(this).height();
            });

            $(this).find('.promotion_item .promo_price_and_notes').height(maxContentHeight);
        }

    });

    var linesCount = 0;
    $(".gallery_lines").each(function () {
        maxHeight = -1;
        maxContentHeight = -1;
        linesCount = $(this).find('.promotion_item').length / 4;

        for (var i = 0; i < linesCount; i++) {
            maxHeight = -1;
            $(this).find('.promotion_item.line_' + i + ' .promo_content').each(function () {
                maxHeight = maxHeight > $(this).height() ? maxHeight : $(this).height();
            });
            $(this).find('.promotion_item.line_' + i + ' .promo_content').height(maxHeight);

        }

    });
    //normalize promos height in guide/organized page
    $(".promo_gallery_organized").each(function () {
        maxHeight = -1;
        $(this).find('.promotion_item .promo_content').each(function () {
            maxHeight = maxHeight > $(this).height() ? maxHeight : $(this).height();
        });
        $(this).find('.promotion_item .promo_content').height(maxHeight);
    });



    //normalize promos height in categories controler
    $(".tab_content_articles").each(function () {
        maxHeight = -1;
        $(this).find('.promotion_item .promo_content').each(function () {
            maxHeight = maxHeight > $(this).height() ? maxHeight : $(this).height();
        });
        $(this).find('.promotion_item .promo_content').height(maxHeight);
    });



}

$(document).ready(function () {

    normalizePromosHeight();
});

function getCookie(cname) {
    var name = cname + "=";
    var ca = document.cookie.split(';');
    for (var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) == ' ') c = c.substring(1);
        if (c.indexOf(name) == 0) return c.substring(name.length, c.length);
    }
    return "";
}

function setCookie(cname, cvalue, exdays) {
    var d = new Date();
    d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
    var expires = "expires=" + d.toUTCString();
    document.cookie = cname + "=" + cvalue + "; " + expires;
}

function createGuid() {
    var str = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx';
    str = str.replace(/[xy]/g, function (c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
    return str;
}


//////////////////////////
/// ______Yotpo_________//
/////////////////////////
//Yotpo - replace the stars in with rating number
function switchAverage(average_review) {
    averageObj = {};
    averageObj.num = Math.round(average_review * 10) / 10;
    if (average_review >= 4.5) {
        averageObj.text = 'מצויין';
        return averageObj;
    }
    if (average_review >= 4) {
        averageObj.text = 'טוב מאוד';
        return averageObj;
    }
    if (average_review >= 2.5) {
        averageObj.text = 'טוב';
        return averageObj;
    }
    else {
        averageObj.text = 'טעון שיפור';
        return averageObj;
    }
}

//scroll to yotpo review at the page bottom
$(document).on("click", "#yotpo_average", function () {
    $('html, body').animate({
        scrollTop: $('#opinionsContainer').offset().top
    }, 500);

    var title = $(this).parent().find('h1').text();

    //if has the area name before the hotel like מלון בתל אביב והסביבה - ווסט תל אביב" i take only the hotel name ==> "ווסט תל אביב"
    if (title.indexOf("-") > -1) {
        title = title.substring(title.indexOf("-")).replace("-", "").trim();
    }


    pushYotpoToAnalytics(title, "domestichotels", "YotpoProductPage");

});


//search result page  -  if click on the yotpo rating 
//i will trigger has he clicked on the product page
$(document).on("click", ".yotpo_average_domestic", function () {
    try {
        var title = $(this).parent().find('.result-title').text();
        pushYotpoToAnalytics(title, "domestichotels", "YotpoSearchReasult");
    } catch (e) { }
    $(this).parent().parent().parent().find("#Submit1").trigger("click");
    //============================================Scroll To Yotpo Review=======================================
    var TryCount = 0;
    var YotpoScrollInterval = setInterval(function () {
        if (location.hash != '' && $('#opinionsContainer').length > 0) {
            $('html, body').animate({
                scrollTop: $('#opinionsContainer').offset().top
            }, 1000);
            clearInterval(YotpoScrollInterval);
            YotpoScrollInterval = null;
        }
        if (TryCount > 3) {
            clearInterval(YotpoScrollInterval);
            YotpoScrollInterval = null;
        }
        TryCount++;
    }, 2000);





});


//productType - like the promotions (domestichotels...)
function pushYotpoToAnalytics(title, productType, eventName) {
    //push google analytics!
    try {
        GTDataLayer.push({ 'category': 'yotpo-review', 'action': title, 'label': productType, 'event': eventName });
    }
    catch (e) { }
}




function initYotpoProductPage() {
    var average = $("#ratingValue").html();
    var averageCount = $("#reviewCount").html();

    if (average != "" && averageCount != "" && average != undefined && averageCount != undefined) {
        insertYotpoAverage(average, averageCount + " חוות דעת");
    }
    setTimeout(function () { replaceStars(average); }, 3000);
}

/* replace the yotpo starts with decimal rank like (4.5)*/
function replaceStars(average) {
    if ($('.yotpo-stars').length > 0 && $('.yotpo-stars .yotpo-icon').length > 0) {
        if ($('.write-first-review-button').length > 0) { $('.yotpo_main_widget_wrapper').hide(); }
        $.each($('.yotpo-stars'), function () {
            if (average == "" || average == undefined) {
                average = $(this).find('.yotpo-icon-star').length + ($(this).find('.yotpo-icon-half-star').length * 0.5);
            }
            $(this).html(average + '/<span>5</span>')
        });
        //INSERT GRAY NOTICE:
        if ($(".verified_eshet").length == 0) {
            $("<div class='verified_eshet'>חוות הדעת הינן חוות דעת מאומתות של לקוחות אשת טורס ששהו במקום.</div>").insertAfter(".yotpo-bottomline-box-2");
        }

        // insert average near product name
        if ($(".based-on").length > 0) {
            insertYotpoAverage(average, $(".based-on").html());
        }

        if (average > 0) {
            $('.yotpo_main_widget_wrapper').show();
        }

    }
}

function insertYotpoAverage(average, averageCount) {
    // insert average near product name
    if (average > 0 && $("#yotpo_average").html() == "") {
        var averageNum = average;
        var averageText = switchAverage(average).text;
        $("#yotpo_average").html(formatYotpoForProductInfo(averageNum, averageText, averageCount));
    }
}


function OpenOrCloseDesc(obj) {
    if ($(obj).hasClass("text-closed-js")) {
        $(obj).removeClass("text-closed-js");
        openDesc(obj);
    } else {
        $(obj).addClass("text-closed-js");
        closeDesc(obj);
    }
}

function openDesc(obj) {
    $(".long-text-js").slideDown();
    $(".3-dots-js").hide();
    $(obj).html("סגור");

    $(obj).next().text("▲");
}

function closeDesc(obj) {
    $(".long-text-js").slideUp();
    $(".3-dots-js").show();
    $(obj).html("קרא עוד");
    $(obj).next().text("▼");
}

function formatYotpoForResults(averageNum, averageText, averageCount) {
    var html = '<div class="display_inline_block pt5 mb10 tooltip_parent">';
    html += '<div class="yotpo_average_num right"><strong>' + averageNum + '</strong>/5</div>';
    html += '<div class="right">';
    html += '<div class="yotpo_average_text fs17 color_remark_blue fw500">' + averageText + '</div>';
    html += '<div class="fs13">לפי ' + averageCount + ' חוות דעת</div>';
    html += '</div>';
    html += '<div class="tooltip mt7">חוות הדעת הינן חוות דעת מאומתות של לקוחות אשת טורס ששהו במקום.</div>';
    html += '</div>';
    return html;
}


function formatYotpoForProductInfo(averageNum, averageText, averageCount) {
    var html = '<div class="display_inline_block">';
    html += '<span class="yotpo_average_num right"><strong>' + averageNum + '</strong>/5</span>';
    html += '<span class="lh14 fs20 right ml10 fw500 color_remark_blue ">' + averageText + '</span>';
    html += '<span class="fs14 right underline mt4">לפי ' + averageCount + '</span>';
    html += '</div>';
    return html;
}


function shortenedSelect() {

    // Shorten select option text if it stretches beyond max-width of select element
    $.each($('.shortenedSelect option'), function (key, optionElement) {
        var curText = $(optionElement).text();
        $(this).attr('title', curText);

        // Tip: parseInt('350px', 10) removes the 'px' by forcing parseInt to use a base ten numbering system.
        var lengthToShortenTo = Math.round(parseInt($(this).parent('select').css('max-width'), 10) / 9);

        if (curText.length > lengthToShortenTo) {
            $(this).text(curText.substring(0, lengthToShortenTo) + '...');
        }
    });

    // Show full name in tooltip after choosing an option
    $('.shortenedSelect').change(function () {
        $(this).attr('title', ($(this).find('option:eq(' + $(this).get(0).selectedIndex + ')').attr('title')));
    });
}

function showPopup(html, customClass, actionConfirm, actionCancel) {
    var actionCancelstr = "";
    if (actionCancel !== undefined) { actionCancelstr = actionCancel; }
    var customClassStr = "";
    if (customClass !== undefined) { customClassStr = customClass; }

    $("body").append('<div class="poc-style"><div class="popup-wrap ' + customClassStr + '" ><div class="black_overlay" onclick="closePopup(); ' + actionCancelstr + '" ></div><div class="popup custom-scrollbar"><i class="icon-x close-popup" onclick="closePopup(); ' + actionCancelstr + '"></i><div class="popup--content">' + html + '</div>');
    if (actionConfirm !== undefined) { $("body").append('<div class="button" onclick="closePopup();' + actionConfirm + '">אישור</div>'); }
    $("body").append('</div></div></div></div>');
    $(".popup-wrap .popup").centerFixed();

}


function closePopup() {
    $(".popup-wrap").remove();
}

function SetCookie(cname, cvalue, exdays) {
    var d = new Date();
    d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
    var expires = "expires=" + d.toGMTString();
    document.cookie = cname + "=" + cvalue + "; " + expires + ";path=/";
}

var guid = (function () {
    function s4() {
        return Math.floor((1 + Math.random()) * 0x10000).toString(16).substring(1);
    }
    return function () { return s4() + s4() + '-' + s4() + '-' + s4() + '-' + s4() + '-' + s4() + s4() + s4(); };
})();

function getParameterByName(name) {
    var url = window.location.href;
    name = name.replace(/[\[\]]/g, "\\$&");
    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, " "));
}

function isFirstLobbyOrHomePage() {
    var url = window.location.href;
    var count = url.split('/').length - 1;
    return (count <= 5);
}


// Datepicker legend and message
function setDatepickerBreakRow(htmlLegendString, holidaysLegendString) {

    if ($(".ui-datepicker-row-break").find('.ulHolidays').length <= 0) {
        $(".ui-datepicker-row-break").addClass('datepicker-legend-row');
        $(".ui-datepicker-row-break").append(htmlLegendString);

        if ($('.ui-datepicker tbody tr td.locked').length <= 0) {
            if ($(".ui-datepicker-row-break").find('.datepicker-message').length <= 0) {
                $(".ui-datepicker-row-break").append('<div class="datepicker-message">*באפשרותך לבחור כל תאריך יציאה וחזרה</div>');
            }
        }
    }

    // Check if there are holidays on the calenadar
    var holidaysDatesArray = $('.ui-datepicker-calendar tbody tr td.holiday');

    if (holidaysDatesArray != undefined && holidaysDatesArray.length > 0) {
        // Show datepicker holidays legend...   
        if ($('.ulHolidays').find('.holidays-legend').length <= 0) {
            $('.ulHolidays').append(holidaysLegendString);
        }
    } else {
        $('.ulHolidays').find('.holidays-legend').remove();
    }




}



// handle utm_source start //////////////////////////////////////////////////////////
function saveUtmSource() {
    var utm_source = getParameterByName("utm_source") != null ? getParameterByName("utm_source") : getParameterByName("originsource");
    if (utm_source == null || utm_source == "") {
        var gclid = getParameterByName("gclid");
        var referrer = document.referrer;
        
        if (gclid != null && gclid != "") {
            //google ppc
            utm_source = "gppc";
        }else if (referrer.indexOf(".google.") != -1) {
            //google organic
            utm_source = "go";
        }
    }
    if (utm_source != null && utm_source != "") {
        sessionStorage.setItem('utm_source', utm_source);
        SetCookie("utm_source", utm_source, 30);
    }
}

function getUtmSource() {
    var utmSource = sessionStorage.getItem('utm_source');
    if (utmSource != null) {
        return utmSource;
    }
    utmSource = getCookie('utm_source');
    if (utmSource != null) {
        return utmSource;
    }

    return "";
}

function pushUtmSource() {
    var utmSource = getUtmSource();
    if (utmSource != null && utmSource != "") {
        GTDataLayer.push({
            'source': utmSource
        });
    }
}

saveUtmSource();
// handle utm_source end //////////////////////////////////////////////////////////

// auto_event 
function pushAutoEvent(category, action, label) {
    GTDataLayer.push({
        event: "auto_event",
        category: category,
        action: action,
        label: label
    });
}


// Push event on search button click in the wizard
function pushDealSearchEvent(category, action, destName, Pax, fromDate, toDate) {
    var label = destName + " – " + Pax + " - " + fromDate + " - " + toDate
    pushAutoEvent(category, action, label);
}


function pausecomp(millis) {
    var date = new Date();
    var curDate = null;

    do { curDate = new Date(); }
    while (curDate - date < millis);
}


$(document).ready(function () {  
    initPromotions();
});

function isCruisePage() {
    var thisPageUrl = document.location.href;
    return (thisPageUrl.toLowerCase().indexOf("cruise") != -1);
}

function isKosherPage() {
    var thisPageUrl = document.location.href;
    return (thisPageUrl.toLowerCase().indexOf("domestichotels/kosher") != -1 || thisPageUrl.toLowerCase().indexOf("groups/shabat_chatan") != -1);
}

function initLobbyYotpo(yotpoAPIKey) {
    (function e() {
        var e = document.createElement("script");
        e.type = "text/javascript", e.async = true, e.src = "//staticw2.yotpo.com/" + yotpoAPIKey + "/widget.js";
        var t = document.getElementsByTagName("script")[0];
        t.parentNode.insertBefore(e, t);
    })();
}

$("document").ready(function () {

    if ($(".static-yotpo-reviews").length > 0) {
        initLobbyYotpo(yotpoAPIKey);
        setTimeout(function () { replaceStars(); }, 3000);
    }
});

// Draw propmotions tiles
function drawPromotionsTiles(promotionsContainer, data) {    
    var maxRow = 2;
    var maxRowLength = 20;
    if (data != null && data.Promotions != null && data.Promotions.length > 0) {        
        data.Promotions = data.Promotions.slice(0, data.PromotionsToShowCount);
        for (var i = 0 ; i < data.Promotions.length; i++) {
            data.Promotions[i].shortTitle = ToShortString(data.Promotions[i].Title, maxRowLength, maxRow);
            if (data.Promotions[i].Img == "" || data.Promotions[i].Img == null) {
                data.Promotions[i].Img = siteUrlPoc + "/images/global/white-background.jpg";
            }
        }
        promotionsContainer.first().html($('#promotionsTilesTemplate').render(data));
    }
}

// Draw promotions special view (1 big, two small, 1 big)
function drawPromotionsBanners(promotionsContainer, data) {

    if (data != null && data.Promotions != null && data.Promotions.length > 0) {
        for (var i = 0 ; i < data.Promotions.length && i < 4 ; i++) {

            if (i == 0 || i == 3) { //big promotions
                data.Promotions[i].shortTitle = ToShortString(data.Promotions[i].Title, 35, 2);
            } else {
                data.Promotions[i].shortTitle = ToShortString(data.Promotions[i].Title, 20, 2);
            }
            if (data.Promotions[i].Img == "" || data.Promotions[i].Img == null) {
                data.Promotions[i].Img = siteUrlPoc + "/images/global/white-background.jpg";
            }
        }
        promotionsContainer.first().html($('#promotionsBannersTemplate').render(data));
    }
}

function ToShortString(str, maxRowLength, maxRow) {
    letters = 0; //Total number of letters in the string
    row = 1;
    shortStr = "";
    var words = str.split(" "); //Array of words

    for (var i = 0; i < words.length; i++) //for each word in word Array
    {
        if (words[i] != null && words[i] != "") {
            if (i > 0) //Add space after first word
            {
                shortStr += " ";
                letters += 1;
            }
            shortStr += words[i];
            letters += words[i].length;
            if (letters > (maxRow * maxRowLength)) {
                // the total number of letters is too big - cuts the string adds "..."          
                diff = (letters - (maxRow * maxRowLength) + 3);
                shortStr = shortStr.substring(0, (shortStr.length - diff));
                return shortStr + "...";
            }
            if (letters > (maxRowLength * row)) {
                letters = ((maxRowLength * row) + words[i].length);
                row++;
            }
        }
    }
    return shortStr;
}

// Initialize New Promotions in old site
function initPromotions() {
    setPageType();
    var targetUrl = PocSiteUrl + '/LandingPage/PromotionsBlocksJson?caller=' + pageType + '&type=null';
    $.ajax({
        type: "GET",
        contentType: "application/json",
        dataType: 'json',
        url: targetUrl,
        success: function (data) {
            if (data != null && data.length > 0) {
                if (pageType === 'divur') { //divur
                    if ($("#organized_promotions").length > 0) {
                        if (data[0] != null) { // case organized
                            var PromotionsToShowCount = setPromotionToShowCount(data[0].Promotions.length);
                            data[0].PromotionsToShowCount = PromotionsToShowCount;
                            drawPromotionsTiles($("#organized_promotions"), data[0]);
                        }
                    }
                    if ($("#domestic_hotels_promotions").length > 0) {
                        if (data[1] != null) { // case domestic hotels
                            var PromotionsToShowCount = setPromotionToShowCount(data[1].Promotions.length);
                            data[1].PromotionsToShowCount = PromotionsToShowCount;
                            drawPromotionsTiles($("#domestic_hotels_promotions"), data[1]);
                        }
                    }
                } else if (pageType === 'homepage') { //homepage                    

                    if ($("#organized_promotions").length > 0) {
                        if (data[0] != null) { // case organized                          
                            drawPromotionsTiles($("#organized_promotions"), data[0]);
                        }
                    }
                    if ($("#domestic_hotels_promotions_banners").length > 0) {
                        if (data[1] != null) { // case domestic hotels                         
                            drawPromotionsBanners($("#domestic_hotels_promotions_banners"), data[1]);
                        }
                    }
                    if ($("#domestic_hotels_promotions").length > 0) {
                        if (data[2] != null) { // case domestic hotels                           
                            drawPromotionsTiles($("#domestic_hotels_promotions"), data[2]);
                        }
                    }

                }

                showDiscountOnPromotion();
            }
        },
        error: function () {

        }
    });
}

function setPromotionToShowCount(promotionsLength) {

    var countToShow = promotionsLength;
    try {               
        while ((countToShow % 4 != 0 && countToShow > 4)){
            countToShow--;
        }
    } catch (e) { }
    return countToShow;
}

function setPageType() {
    pageType = (window.location.href.indexOf('campaigns/divur') > -1) ? 'divur' : 'homepage';   
}



/*!
 * jQuery Migrate - v1.1.1 - 2013-02-16
 * https://github.com/jquery/jquery-migrate
 * Copyright 2005, 2013 jQuery Foundation, Inc. and other contributors; Licensed MIT
 */
(function( jQuery, window, undefined ) {
// See http://bugs.jquery.com/ticket/13335
// "use strict";


var warnedAbout = {};

// List of warnings already given; public read only
jQuery.migrateWarnings = [];

// Set to true to prevent console output; migrateWarnings still maintained
// jQuery.migrateMute = false;

// Show a message on the console so devs know we're active
if ( !jQuery.migrateMute && window.console && console.log ) {
	console.log("JQMIGRATE: Logging is active");
}

// Set to false to disable traces that appear with warnings
if ( jQuery.migrateTrace === undefined ) {
	jQuery.migrateTrace = true;
}

// Forget any warnings we've already given; public
jQuery.migrateReset = function() {
	warnedAbout = {};
	jQuery.migrateWarnings.length = 0;
};

function migrateWarn( msg) {
	if ( !warnedAbout[ msg ] ) {
		warnedAbout[ msg ] = true;
		jQuery.migrateWarnings.push( msg );
		if ( window.console && console.warn && !jQuery.migrateMute ) {
			console.warn( "JQMIGRATE: " + msg );
			if ( jQuery.migrateTrace && console.trace ) {
				console.trace();
			}
		}
	}
}

function migrateWarnProp( obj, prop, value, msg ) {
	if ( Object.defineProperty ) {
		// On ES5 browsers (non-oldIE), warn if the code tries to get prop;
		// allow property to be overwritten in case some other plugin wants it
		try {
			Object.defineProperty( obj, prop, {
				configurable: true,
				enumerable: true,
				get: function() {
					migrateWarn( msg );
					return value;
				},
				set: function( newValue ) {
					migrateWarn( msg );
					value = newValue;
				}
			});
			return;
		} catch( err ) {
			// IE8 is a dope about Object.defineProperty, can't warn there
		}
	}

	// Non-ES5 (or broken) browser; just set the property
	jQuery._definePropertyBroken = true;
	obj[ prop ] = value;
}

if ( document.compatMode === "BackCompat" ) {
	// jQuery has never supported or tested Quirks Mode
	migrateWarn( "jQuery is not compatible with Quirks Mode" );
}


var attrFn = jQuery( "<input/>", { size: 1 } ).attr("size") && jQuery.attrFn,
	oldAttr = jQuery.attr,
	valueAttrGet = jQuery.attrHooks.value && jQuery.attrHooks.value.get ||
		function() { return null; },
	valueAttrSet = jQuery.attrHooks.value && jQuery.attrHooks.value.set ||
		function() { return undefined; },
	rnoType = /^(?:input|button)$/i,
	rnoAttrNodeType = /^[238]$/,
	rboolean = /^(?:autofocus|autoplay|async|checked|controls|defer|disabled|hidden|loop|multiple|open|readonly|required|scoped|selected)$/i,
	ruseDefault = /^(?:checked|selected)$/i;

// jQuery.attrFn
migrateWarnProp( jQuery, "attrFn", attrFn || {}, "jQuery.attrFn is deprecated" );

jQuery.attr = function( elem, name, value, pass ) {
	var lowerName = name.toLowerCase(),
		nType = elem && elem.nodeType;

	if ( pass ) {
		// Since pass is used internally, we only warn for new jQuery
		// versions where there isn't a pass arg in the formal params
		if ( oldAttr.length < 4 ) {
			migrateWarn("jQuery.fn.attr( props, pass ) is deprecated");
		}
		if ( elem && !rnoAttrNodeType.test( nType ) &&
			(attrFn ? name in attrFn : jQuery.isFunction(jQuery.fn[name])) ) {
			return jQuery( elem )[ name ]( value );
		}
	}

	// Warn if user tries to set `type`, since it breaks on IE 6/7/8; by checking
	// for disconnected elements we don't warn on $( "<button>", { type: "button" } ).
	if ( name === "type" && value !== undefined && rnoType.test( elem.nodeName ) && elem.parentNode ) {
		migrateWarn("Can't change the 'type' of an input or button in IE 6/7/8");
	}

	// Restore boolHook for boolean property/attribute synchronization
	if ( !jQuery.attrHooks[ lowerName ] && rboolean.test( lowerName ) ) {
		jQuery.attrHooks[ lowerName ] = {
			get: function( elem, name ) {
				// Align boolean attributes with corresponding properties
				// Fall back to attribute presence where some booleans are not supported
				var attrNode,
					property = jQuery.prop( elem, name );
				return property === true || typeof property !== "boolean" &&
					( attrNode = elem.getAttributeNode(name) ) && attrNode.nodeValue !== false ?

					name.toLowerCase() :
					undefined;
			},
			set: function( elem, value, name ) {
				var propName;
				if ( value === false ) {
					// Remove boolean attributes when set to false
					jQuery.removeAttr( elem, name );
				} else {
					// value is true since we know at this point it's type boolean and not false
					// Set boolean attributes to the same name and set the DOM property
					propName = jQuery.propFix[ name ] || name;
					if ( propName in elem ) {
						// Only set the IDL specifically if it already exists on the element
						elem[ propName ] = true;
					}

					elem.setAttribute( name, name.toLowerCase() );
				}
				return name;
			}
		};

		// Warn only for attributes that can remain distinct from their properties post-1.9
		if ( ruseDefault.test( lowerName ) ) {
			migrateWarn( "jQuery.fn.attr('" + lowerName + "') may use property instead of attribute" );
		}
	}

	return oldAttr.call( jQuery, elem, name, value );
};

// attrHooks: value
jQuery.attrHooks.value = {
	get: function( elem, name ) {
		var nodeName = ( elem.nodeName || "" ).toLowerCase();
		if ( nodeName === "button" ) {
			return valueAttrGet.apply( this, arguments );
		}
		if ( nodeName !== "input" && nodeName !== "option" ) {
			migrateWarn("jQuery.fn.attr('value') no longer gets properties");
		}
		return name in elem ?
			elem.value :
			null;
	},
	set: function( elem, value ) {
		var nodeName = ( elem.nodeName || "" ).toLowerCase();
		if ( nodeName === "button" ) {
			return valueAttrSet.apply( this, arguments );
		}
		if ( nodeName !== "input" && nodeName !== "option" ) {
			migrateWarn("jQuery.fn.attr('value', val) no longer sets properties");
		}
		// Does not return so that setAttribute is also used
		elem.value = value;
	}
};


var matched, browser,
	oldInit = jQuery.fn.init,
	oldParseJSON = jQuery.parseJSON,
	// Note this does NOT include the #9521 XSS fix from 1.7!
	rquickExpr = /^(?:[^<]*(<[\w\W]+>)[^>]*|#([\w\-]*))$/;

// $(html) "looks like html" rule change
jQuery.fn.init = function( selector, context, rootjQuery ) {
	var match;

	if ( selector && typeof selector === "string" && !jQuery.isPlainObject( context ) &&
			(match = rquickExpr.exec( selector )) && match[1] ) {
		// This is an HTML string according to the "old" rules; is it still?
		if ( selector.charAt( 0 ) !== "<" ) {
			migrateWarn("$(html) HTML strings must start with '<' character");
		}
		// Now process using loose rules; let pre-1.8 play too
		if ( context && context.context ) {
			// jQuery object as context; parseHTML expects a DOM object
			context = context.context;
		}
		if ( jQuery.parseHTML ) {
			return oldInit.call( this, jQuery.parseHTML( jQuery.trim(selector), context, true ),
					context, rootjQuery );
		}
	}
	return oldInit.apply( this, arguments );
};
jQuery.fn.init.prototype = jQuery.fn;

// Let $.parseJSON(falsy_value) return null
jQuery.parseJSON = function( json ) {
	if ( !json && json !== null ) {
		migrateWarn("jQuery.parseJSON requires a valid JSON string");
		return null;
	}
	return oldParseJSON.apply( this, arguments );
};

jQuery.uaMatch = function( ua ) {
	ua = ua.toLowerCase();

	var match = /(chrome)[ \/]([\w.]+)/.exec( ua ) ||
		/(webkit)[ \/]([\w.]+)/.exec( ua ) ||
		/(opera)(?:.*version|)[ \/]([\w.]+)/.exec( ua ) ||
		/(msie) ([\w.]+)/.exec( ua ) ||
		ua.indexOf("compatible") < 0 && /(mozilla)(?:.*? rv:([\w.]+)|)/.exec( ua ) ||
		[];

	return {
		browser: match[ 1 ] || "",
		version: match[ 2 ] || "0"
	};
};

// Don't clobber any existing jQuery.browser in case it's different
if ( !jQuery.browser ) {
	matched = jQuery.uaMatch( navigator.userAgent );
	browser = {};

	if ( matched.browser ) {
		browser[ matched.browser ] = true;
		browser.version = matched.version;
	}

	// Chrome is Webkit, but Webkit is also Safari.
	if ( browser.chrome ) {
		browser.webkit = true;
	} else if ( browser.webkit ) {
		browser.safari = true;
	}

	jQuery.browser = browser;
}

// Warn if the code tries to get jQuery.browser
migrateWarnProp( jQuery, "browser", jQuery.browser, "jQuery.browser is deprecated" );

jQuery.sub = function() {
	function jQuerySub( selector, context ) {
		return new jQuerySub.fn.init( selector, context );
	}
	jQuery.extend( true, jQuerySub, this );
	jQuerySub.superclass = this;
	jQuerySub.fn = jQuerySub.prototype = this();
	jQuerySub.fn.constructor = jQuerySub;
	jQuerySub.sub = this.sub;
	jQuerySub.fn.init = function init( selector, context ) {
		if ( context && context instanceof jQuery && !(context instanceof jQuerySub) ) {
			context = jQuerySub( context );
		}

		return jQuery.fn.init.call( this, selector, context, rootjQuerySub );
	};
	jQuerySub.fn.init.prototype = jQuerySub.fn;
	var rootjQuerySub = jQuerySub(document);
	migrateWarn( "jQuery.sub() is deprecated" );
	return jQuerySub;
};


// Ensure that $.ajax gets the new parseJSON defined in core.js
jQuery.ajaxSetup({
	converters: {
		"text json": jQuery.parseJSON
	}
});


var oldFnData = jQuery.fn.data;

jQuery.fn.data = function( name ) {
	var ret, evt,
		elem = this[0];

	// Handles 1.7 which has this behavior and 1.8 which doesn't
	if ( elem && name === "events" && arguments.length === 1 ) {
		ret = jQuery.data( elem, name );
		evt = jQuery._data( elem, name );
		if ( ( ret === undefined || ret === evt ) && evt !== undefined ) {
			migrateWarn("Use of jQuery.fn.data('events') is deprecated");
			return evt;
		}
	}
	return oldFnData.apply( this, arguments );
};


var rscriptType = /\/(java|ecma)script/i,
	oldSelf = jQuery.fn.andSelf || jQuery.fn.addBack;

jQuery.fn.andSelf = function() {
	migrateWarn("jQuery.fn.andSelf() replaced by jQuery.fn.addBack()");
	return oldSelf.apply( this, arguments );
};

// Since jQuery.clean is used internally on older versions, we only shim if it's missing
if ( !jQuery.clean ) {
	jQuery.clean = function( elems, context, fragment, scripts ) {
		// Set context per 1.8 logic
		context = context || document;
		context = !context.nodeType && context[0] || context;
		context = context.ownerDocument || context;

		migrateWarn("jQuery.clean() is deprecated");

		var i, elem, handleScript, jsTags,
			ret = [];

		jQuery.merge( ret, jQuery.buildFragment( elems, context ).childNodes );

		// Complex logic lifted directly from jQuery 1.8
		if ( fragment ) {
			// Special handling of each script element
			handleScript = function( elem ) {
				// Check if we consider it executable
				if ( !elem.type || rscriptType.test( elem.type ) ) {
					// Detach the script and store it in the scripts array (if provided) or the fragment
					// Return truthy to indicate that it has been handled
					return scripts ?
						scripts.push( elem.parentNode ? elem.parentNode.removeChild( elem ) : elem ) :
						fragment.appendChild( elem );
				}
			};

			for ( i = 0; (elem = ret[i]) != null; i++ ) {
				// Check if we're done after handling an executable script
				if ( !( jQuery.nodeName( elem, "script" ) && handleScript( elem ) ) ) {
					// Append to fragment and handle embedded scripts
					fragment.appendChild( elem );
					if ( typeof elem.getElementsByTagName !== "undefined" ) {
						// handleScript alters the DOM, so use jQuery.merge to ensure snapshot iteration
						jsTags = jQuery.grep( jQuery.merge( [], elem.getElementsByTagName("script") ), handleScript );

						// Splice the scripts into ret after their former ancestor and advance our index beyond them
						ret.splice.apply( ret, [i + 1, 0].concat( jsTags ) );
						i += jsTags.length;
					}
				}
			}
		}

		return ret;
	};
}

var eventAdd = jQuery.event.add,
	eventRemove = jQuery.event.remove,
	eventTrigger = jQuery.event.trigger,
	oldToggle = jQuery.fn.toggle,
	oldLive = jQuery.fn.live,
	oldDie = jQuery.fn.die,
	ajaxEvents = "ajaxStart|ajaxStop|ajaxSend|ajaxComplete|ajaxError|ajaxSuccess",
	rajaxEvent = new RegExp( "\\b(?:" + ajaxEvents + ")\\b" ),
	rhoverHack = /(?:^|\s)hover(\.\S+|)\b/,
	hoverHack = function( events ) {
		if ( typeof( events ) !== "string" || jQuery.event.special.hover ) {
			return events;
		}
		if ( rhoverHack.test( events ) ) {
			migrateWarn("'hover' pseudo-event is deprecated, use 'mouseenter mouseleave'");
		}
		return events && events.replace( rhoverHack, "mouseenter$1 mouseleave$1" );
	};

// Event props removed in 1.9, put them back if needed; no practical way to warn them
if ( jQuery.event.props && jQuery.event.props[ 0 ] !== "attrChange" ) {
	jQuery.event.props.unshift( "attrChange", "attrName", "relatedNode", "srcElement" );
}

// Undocumented jQuery.event.handle was "deprecated" in jQuery 1.7
if ( jQuery.event.dispatch ) {
	migrateWarnProp( jQuery.event, "handle", jQuery.event.dispatch, "jQuery.event.handle is undocumented and deprecated" );
}

// Support for 'hover' pseudo-event and ajax event warnings
jQuery.event.add = function( elem, types, handler, data, selector ){
	if ( elem !== document && rajaxEvent.test( types ) ) {
		migrateWarn( "AJAX events should be attached to document: " + types );
	}
	eventAdd.call( this, elem, hoverHack( types || "" ), handler, data, selector );
};
jQuery.event.remove = function( elem, types, handler, selector, mappedTypes ){
	eventRemove.call( this, elem, hoverHack( types ) || "", handler, selector, mappedTypes );
};

jQuery.fn.error = function() {
	var args = Array.prototype.slice.call( arguments, 0);
	migrateWarn("jQuery.fn.error() is deprecated");
	args.splice( 0, 0, "error" );
	if ( arguments.length ) {
		return this.bind.apply( this, args );
	}
	// error event should not bubble to window, although it does pre-1.7
	this.triggerHandler.apply( this, args );
	return this;
};

jQuery.fn.toggle = function( fn, fn2 ) {

	// Don't mess with animation or css toggles
	if ( !jQuery.isFunction( fn ) || !jQuery.isFunction( fn2 ) ) {
		return oldToggle.apply( this, arguments );
	}
	migrateWarn("jQuery.fn.toggle(handler, handler...) is deprecated");

	// Save reference to arguments for access in closure
	var args = arguments,
		guid = fn.guid || jQuery.guid++,
		i = 0,
		toggler = function( event ) {
			// Figure out which function to execute
			var lastToggle = ( jQuery._data( this, "lastToggle" + fn.guid ) || 0 ) % i;
			jQuery._data( this, "lastToggle" + fn.guid, lastToggle + 1 );

			// Make sure that clicks stop
			event.preventDefault();

			// and execute the function
			return args[ lastToggle ].apply( this, arguments ) || false;
		};

	// link all the functions, so any of them can unbind this click handler
	toggler.guid = guid;
	while ( i < args.length ) {
		args[ i++ ].guid = guid;
	}

	return this.click( toggler );
};

jQuery.fn.live = function( types, data, fn ) {
	migrateWarn("jQuery.fn.live() is deprecated");
	if ( oldLive ) {
		return oldLive.apply( this, arguments );
	}
	jQuery( this.context ).on( types, this.selector, data, fn );
	return this;
};

jQuery.fn.die = function( types, fn ) {
	migrateWarn("jQuery.fn.die() is deprecated");
	if ( oldDie ) {
		return oldDie.apply( this, arguments );
	}
	jQuery( this.context ).off( types, this.selector || "**", fn );
	return this;
};

// Turn global events into document-triggered events
jQuery.event.trigger = function( event, data, elem, onlyHandlers  ){
	if ( !elem && !rajaxEvent.test( event ) ) {
		migrateWarn( "Global events are undocumented and deprecated" );
	}
	return eventTrigger.call( this,  event, data, elem || document, onlyHandlers  );
};
jQuery.each( ajaxEvents.split("|"),
	function( _, name ) {
		jQuery.event.special[ name ] = {
			setup: function() {
				var elem = this;

				// The document needs no shimming; must be !== for oldIE
				if ( elem !== document ) {
					jQuery.event.add( document, name + "." + jQuery.guid, function() {
						jQuery.event.trigger( name, null, elem, true );
					});
					jQuery._data( this, name, jQuery.guid++ );
				}
				return false;
			},
			teardown: function() {
				if ( this !== document ) {
					jQuery.event.remove( document, name + "." + jQuery._data( this, name ) );
				}
				return false;
			}
		};
	}
);


})( jQuery, window );
/* version number */
//-------------------
/* end version number */
///Change Ctaegory in Smart Promotion Category Menus
function change_cateogry(ControlID, CategoryID) {
    //hide All Cateogry
    $('.category_promotion_' + ControlID).hide();
    //Show Specific Category
    $('.category_' + ControlID + "_" + CategoryID).css('opacity', '0');

    $('.category_' + ControlID + "_" + CategoryID).show();

    $('.category_' + ControlID + "_" + CategoryID).animate({ opacity: 1 });


}




var siteUrl = '';

$(document).ready(function () {

    if (window.location.href.indexOf("smartpromotion") != -1 && $("#HiddenBasketContainer").find('.newBasketItem').length > 0)
        $("#HiddenBasketContainer").show();

    //$('.dateRangeFrom input, .dateRangeTo input').attr('readOnly', 'true');

    FixHeight();

    // Start - Tabs
    $(".tabs ul li:first").addClass("activeTab").show();
    $(".tabs > div:first").show();

    $(".tabs > ul > li").live("click", function () {

        $(".tabs > ul > li").removeClass("activeTab");
        $(this).addClass("activeTab");
        $(".tabs > div").hide();

        var activeTab = '#' + $(this).children("a").attr("href").split('#')[1];
        $(activeTab).show();
        return false;
    });

    // End - Tabs

    // Start - Tool Tip Phone Order

    $(".phoneOrderInner img").live('click', function () {
        $('#PricePhoneOrder').fadeIn("slow");
    });

    $('.closeToolTip').live('click', function () {
        $('#PricePhoneOrder').fadeOut("slow");
    });

    // End - Tool Tip Phone Order

    // Start - Flights One Way

    $('.oneWayTableOutGoing input[type=radio][name=rdoFlightOutGoing]').live('change', function () {

        $('.oneWayTableOutGoing tr td').css('background-color', '#fff');

        $(this).parents('tr').children('td').each(function () {
            $(this).css('background-color', '#f8f8f8');
        });

    });

    $('.oneWayTableIncoming input[type=radio][name=rdoFlightIncoming]').live('change', function () {

        $('.oneWayTableIncoming tr td').css('background-color', '#fff');

        $(this).parents('tr').children('td').each(function () {
            $(this).css('background-color', '#f8f8f8');
        });

    });

    // End - Flights One Way


    // Start - Loading Flash

    try {
        $('#loadingFlash').flash({
            src: '/flash/loader_v2.swf',
            width: 620,
            height: 179
        });
    }
    catch (err) {

    }


    // End - Loading Flash


    // Start - Payment

    $('#creditCard').show();

    $('#acceptedCredit input[type="radio"]').bind('click', function () {

        var creditID = $(this).attr("class");

        if ($(this).is(':checked')) {
            $('#creditCard, #payPal, #postOffice').hide();
            $('div#' + creditID).show();
        }
    });

    // End - Payment


    // Start - Erase Left Side

    $('.erase').bind('click', function () {
        $(this).parents('.shadowBoxLeft').hide();
    });

    // End - Erase Left Side
    //alert($('#hidTotalItems').val());
    if ($('.hiddenContainer').length > 0) {
        $('.flightsMoreResults').show();
    }
    else { // hide more results when no results.
        $('.flightsMoreResults').hide();
    }
});

$(document).ready(function () {
    
    $(".more-promotions-offers-title-js").bind("click", function () {

        openCloseMoreOffers(this)

    });

});

function SetGlobalVars(pSiteUrl) {
    siteUrl = pSiteUrl;
}

function FixHeight() {

    //    var RightHeight = $('.rightColumn').height();
    //    var LeftHeight = $('.leftColumn').height();
    //    var CenterHeight = $('.centerColumn').height();
    //    var CenterLeftHeight = $('.centerLeftColumn').height();

    //    // Limiting the right column for any height causes it to overlap ther footer when the right column is expanded. why limit it ?
    //    if (CenterHeight != null) {

    //        if (CenterHeight >= RightHeight) {
    //            $('.rightColumn').height(CenterHeight);
    //            $('.rightColumn').css("min-height", CenterHeight + 376);
    //        }
    //        else {
    //            RightHeight = RightHeight;
    //            $('.centerColumn').css('height',RightHeight);
    //            $('.centerColumn').css("min-height", RightHeight);
    //        }
    //        
    //        if (CenterHeight > LeftHeight) {
    //            $('.leftColumn').css("min-height", CenterHeight);
    //        }
    //    }

    //    if (CenterLeftHeight != null) {
    //        
    //        if (CenterLeftHeight > RightHeight) {
    //        
    //            $('.rightColumn').css("min-height", CenterLeftHeight);
    //        }
    //    }

}

function openCloseMoreOffers(obj) {    
    if ($(obj).parent().next().hasClass("more-promotions-offers-closed")) {
        var newSrc = appRoot + "/images/blue_arrow_down.png";
        $(obj).next().attr("src", newSrc);
        $(obj).parent().next().slideDown("slow");
        $(obj).parent().next().removeClass("more-promotions-offers-closed");
        $(obj).parent().next().addClass("more-promotions-offers-opened");
    } else {
        var newSrc = appRoot + "/images/blue_arrow_left.png";

        $(obj).next().attr("src", newSrc);
        $(obj).parent().next().slideUp("slow");
        $(obj).parent().next().removeClass("more-promotions-offers-opened");
        $(obj).parent().next().addClass("more-promotions-offers-closed");
    }
}




/* version number */
//-------------------
/* end version number */
// Start - More Dates Popup

//-------------------------------------------------- New Main Loading Banner - BEGIN --------------------------------------------------//  
// Global var for stoping the banner message replace
var isLoadingDialogOpen = false;

// Handles Loading dialog on IE browsers
function initLoadingDialogForOldBrowsers() {
    $('#loadingPopup').css('display', 'none');
    $('#old_browser_loader').css('display', 'block');
    try {
        $("#old_browser_loader").dialog("open");
    } catch (e) {
        loadingPopupInitDialog();
        try {
            $("#old_browser_loader").dialog("open");
        } catch (e) { }
    }

    // Hide Dialog Title
    $('div[class="ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix"]').hide();
}
// Handles Loading dialog on new browsers
function initLoadingDialogForNewBrowsers(isSearch) {
    
    replaceBannerMessage(0);
    $('#loadingPopup').css('display', 'block');
    $('#old_browser_loader').css('display', 'none');
    if (isSearch) {
        $('.loading-banner-body').addClass('search-banner');
    } else {
        $('.loading-banner-body').removeClass('search-banner');
    }
    try{
        $("#loadingPopup").dialog("open");
    }catch(e){
        loadingPopupInitDialog();
        try {
            $("#loadingPopup").dialog("open");
        } catch (e) { }
    }
    
    // Hide Dialog Title
    $('div[class="ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix"]').hide();
}

// Searching Loading Banner - Has more information
function initSearchLoader() {
    initSmallLoader(true);
}

// Initializing New Loading banner 
function initSmallLoader(isSearch) {

    isLoadingDialogOpen = true;

    if (detectIE() != false && detectIE() < 10) {   // Old Internet Explorer     
        $('#loadingPopup').css('display', 'none');
        $('#old_browser_loader').css('display', 'block');

        initLoadingDialogForOldBrowsers();
    }
    else {
        initLoadingDialogForNewBrowsers(isSearch);
    }    
}
// Closing function for the Loading Banner dialog
function  CloseSmallLoader() {
    
    if ($("#loadingPopup").dialog("isOpen")) {
        $("#loadingPopup").dialog("close");
    }
    else if ($("#old_browser_loader").dialog("isOpen")) {
        $("#old_browser_loader").dialog("close");
    }
    $("#loadingPopup").dialog("close");
    isLoadingDialogOpen = false;
    //$(".loader-wrapper").remove();
}

// Function for replacing messages in the banner
function replaceBannerMessage(index) {
    
    // Get the messages array
    var bannerMessagesArray = $('.dynamic-messages-container ul li');
    if (index == bannerMessagesArray.size()) {
        index = 0;
    }

    if (isLoadingDialogOpen) {
        $('.banner-messge span').fadeOut(600, function () {
            $('.banner-messge span').html($(bannerMessagesArray[index]).html());
            $('.banner-messge span').fadeIn(600);
            setTimeout(function () {
                replaceBannerMessage(index + 1);
            }, 3000);
        });
    }

}

//-------------------------------------------------- New Main Loading Banner - END --------------------------------------------------//  


function MoreDatesPopup(pck_id, destination, la_id, productType) {
    ;
    if (productType == "Deals")
        $('#PackageDetailsMoreDatePopupLoader').show();

    if (productType == "OrganizedTour")
        $('#OrganizerdTourMoreDatePopupLoader').show();

    if (productType == "Cruise")
        $('#CruiseMoreDatePopupLoader').show();

    $.get('/Handlers/MoreDatesPopup.aspx?pck_id=' + pck_id + '&hotel_id=' + la_id + '&to=' + destination + '&productType=' + productType, function (data) {
        $('#moreDatesPopup').html(data);
        $('.loder_more_res').hide();


        if (productType == "OrganizedTour")
            $('#OrganizerdTourMoreDatePopupLoader').hide();
        if (productType == "Deals")
            $('#PackageDetailsMoreDatePopupLoader').hide();
        if (productType == "Cruise")
            $('#CruiseMoreDatePopupLoader').hide();
    });
}

function GetCookie(c_name) {
    var i, x, y, ARRcookies = document.cookie.split(";");
    for (i = 0; i < ARRcookies.length; i++) {
        x = ARRcookies[i].substr(0, ARRcookies[i].indexOf("="));
        y = ARRcookies[i].substr(ARRcookies[i].indexOf("=") + 1);
        x = x.replace(/^\s+|\s+$/g, "");
        if (x == c_name) {
            return unescape(y);
        }
    }
    return "";
}

function ActivateLoaderFromServerSide(newUrl, promotionSizeEvent, productType , titleElement) {
    //push google analitics!
    try {
        var title = $(titleElement).find('.promo_title').text();

        if (title == "") {
            //Wizard promotion
            if ($(titleElement).attr("class") == "promotion_box_hp") {
                title = $(titleElement).find(".fs-title").text();

                //wizard static image + text
                if (title == "") {
                    title = $(titleElement).find("img").attr("title");
                }

            }
            else {//Mega menu promotion

                if ($(titleElement).attr("class") == "mega_menu_img_col_wrapper") {
                    title = $(titleElement).find(".mega_menu_title").text();
                }
            }
        }

        title = title.trim();

        if (title == "") {
            title = "unknown";
        }       
        GTDataLayer.push({ 'category': 'Promotion', 'action': title, 'label': productType, 'event': promotionSizeEvent });
    } catch (e) {
        //??
        //console.log("Error in push google analitics!")
    }



    $(window).bind('beforeunload', function (e) {
        //$('html').css("overflow", "hidden"); // check with Ziv. for now commented 'cause it moves the HTML aside.        
        setTimeout(function () {
            initSmallLoader();
        }, 500);
    });
    
    var queryChar = (newUrl.indexOf("?") != -1) ? "&" : "?";

    newUrl = AddGoogleIdAndEshetToursId(newUrl);

    if ($(titleElement).find("a").length > 0) {
        var linkUrl = $(titleElement).find("a").attr("href");
        var linkNewUrl = AddGoogleIdAndEshetToursId(linkUrl);
        $(titleElement).find("a").attr("href", linkNewUrl);
    }

    window.location.href = newUrl;
    
}
var PreventClosingPopUpinMasterPage = false;
// End - Loading Popup


// Start - Add Recommendation Popup

function AddRecommendationPopup(url) {
    $("#addRecommendation").dialog({
        bgiframe: true,
        width: 445,
        //height: 430,
        modal: true,
        autoOpen: true,
        draggable: false,
        resizable: false,
        dialogClass: 'addRecommendationFrame'
    });
    $('div[class="ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix"]').hide();
    $("#addRecommendation").dialog("open");
    $('#iframeRecommendation').attr('src', url)
}

function AddRecommendationPopup() {
    $("#addRecommendation").dialog({
        bgiframe: true,
        width: 445,
        //height: 430,
        modal: true,
        autoOpen: true,
        draggable: false,
        resizable: false,
        dialogClass: 'recommendation-form'
    });
    $('div[class="ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix"]').hide();
    $("#addRecommendation").dialog("open");

}

// End - Add Recommendation Popup


// Start - Additions Gallery Pic Popup

function AdditionsGalleryPicPopup() {
    $("#additionsGalleryPic").dialog({
        bgiframe: true,
        width: 420,
        //height: 303,
        modal: true,
        autoOpen: true,
        draggable: false,
        resizable: false,
        dialogClass: 'additionsFrame'
    });
    $('div[class="ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix"]').hide();
    $("#additionsGalleryPic").dialog("open");

}

// End - Additions Gallery Pic Popup

// Start - Additions Gallery Popup
function AdditionsGalleryPopup(src, tourId, day) {

    src += (src.indexOf("?") != -1) ? "&" : "?";
    src += "tourId=" + tourId + "&day=" + day;

    $("#additionsGallery").dialog({
        bgiframe: true,
        width: 420,
        // height: 303,
        modal: true,
        autoOpen: true,
        draggable: false,
        resizable: false,
        dialogClass: 'additionsFrame',
        close: function () { }
    });

    $('div[class="ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix"]').hide();

    $.get(src, function (data) {
        $("#ModalGallery").html(data);
        $("#additionsGallery").dialog("open");
        $('#additionsGallery').find('#DayGalleryTitle').html($('#Day_' + day).html());

        if ($('#moreGalleryPic > *').size() > 0) {
            $('#moreGalleryPic').nivoSlider({
                prevText: '',
                nextText: ''
            });
        }

    });
}
// End - Additions Gallery Popup


// Start - Additions Video Popup

function AdditionsVideoPopup() {

    $("#additionsVideo").dialog({
        bgiframe: true,
        width: 420,
        //height: 430,
        modal: true,
        autoOpen: true,
        draggable: false,
        resizable: false,
        dialogClass: 'additionsFrame',
        close: function () { $(this).dialog('destroy'); }
    });
    $('div[class="ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix"]').hide();
    $("#additionsVideo").dialog("open");

}

// End - Additions Video Popup


// Start - Additions Map Popup
///open domestic Hotel Map



function checkEmail(inputvalue) {
    var pattern = /^([a-zA-Z0-9_.-])+@([a-zA-Z0-9_.-])+\.([a-zA-Z])+([a-zA-Z])+/;
    if (pattern.test(inputvalue)) {
        return 1;
    } else {
        return 0;
    }
}
function validatePhone(value) {
    if (value.length < 9) {
        return 0;
    }
    for (i = 0; i < value.length; i++) {
        if (parseInt(value[i]) == NaN) {
            return 0;
        }
    }
    return 1;

}

// End - Additions Map Popup
function paymentPopup(data, callback) {

    var y = $(window).scrollTop();
    $(window).scrollTop(y + 700);

    if (checkEmail($("#txtMail").val()) == 0) {
        $("#MailError").show();
    }
    else {
        $("#MailError").hide();
    }

    if (validatePhone($("#txtPassangerPhone").val()) == 0) {
        $("#PhoneError").show();
    }
    else {
        $("#PhoneError").hide();

    }
    var selectedCount = 0;
    var AgeErrorCount = 0;
    var typePassenger = "";
    var index = 0;
    for (var i = 0; i < data.length; i++) {
        typePassenger = data[i].Type;
        if ((data[i].FirstName == "" || data[i].LastName == "")) {
            selectedCount++;
        }

        if (DateComparision(data[i].Type, data[i].BirthDate) == 1) {
            AgeErrorCount++;
            index = i;
            break;
        }

    }
    if (data.length == 0) {
        $('#spnPassengersCount').show();
        return;
    }
    else {
        $('#spnPassengersCount').hide();
    }

    $('.passengertbody tr').find('select').css({ backgroundColor: 'transparent', borderColor: '#abadb3' });
    if (selectedCount > 0 && AgeErrorCount > 0) {
        $('.ageerror').remove();
        $('.years:eq(' + index + ')').css({ borderColor: 'red' });
        $("#PassangersAgeError").append('<bdo class="ageerror" dir="rtl">' + getErrorPassenger(typePassenger) + '</bdo>');
        $("#TravelDetailsError").show();
        $("#PassangersAgeError").show();
        return;
    }
    else if (selectedCount > 0) {

        $("#TravelDetailsError").show();
        $("#PassangersAgeError").hide();
        return;
    }
    else if (AgeErrorCount > 0) {
        $('.ageerror').remove();
        $('.years:eq(' + index + ')').css({ borderColor: 'red' });
        $("#PassangersAgeError").append('<bdo class="ageerror" dir="rtl">' + getErrorPassenger(typePassenger) + '</bdo>');
        $("#PassangersAgeError")[0].style.display = "block";
        $("#TravelDetailsError")[0].style.display = "none";
        return;
    }



    if (validatePhone($("#txtPassangerPhone").val()) == 0 || checkEmail($("#txtMail").val()) == 0)
        return;

    if (selectedCount == 0 && AgeErrorCount == 0) {
        $("#TravelDetailsError")[0].style.display = "none";
        $("#PassangersAgeError")[0].style.display = "none";
        for (x in data) {
            var r = data[x].TypeName;
            if (r != null)
                data[x].TypeName = (data[x].TypeName.replace("<strong>", "")).replace("</strong>", "");
        }

        $("#PassengerList").html($($("#PassengerListTpl").tmpl(data)));
        $("#PassengerMail").html($($("#PassengerMailTpl").tmpl(data[0])));

        $("#paymentPopup").dialog({
            bgiframe: true,
            width: 490,
            //height: 430,
            modal: true,
            autoOpen: true,
            draggable: false,
            resizable: false,
            dialogClass: 'paymentPopupFrame'
        });

        $('div[class="ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix"]').hide();
        $('html, body').css('overflowY', 'hidden');
        $("#paymentPopup").dialog("open");
        $("#paymentPopup #okBtn").unbind('click');
        $("#paymentPopup #okBtn").bind('click', callback);
        $("#paymentPopup #fixDetails").unbind('click');
        $("#paymentPopup #fixDetails").bind('click', function () { $("#paymentPopup").dialog("close") });
    }
}

function getErrorPassenger(typePassenger) {
    var resource = "";
    switch (typePassenger) {
        case "Adult":
            {
                resource = '&nbsp;(מבוגר)';
            }
            break;
        case "Young":
            {
                resource = '&nbsp;(צעיר)';
            }
            break;
        case "Child":
            {
                resource = '&nbsp;(ילד)';
            }
            break;
        case "Baby":
            {
                resource = '&nbsp;(תינוק)';
            }
            break;
        case "Old":
            {
                resource = '&nbsp;(פנסיונר)';
            }
            break;

    }
    return resource;
}

function DateComparision(PassangerType, BirthDate) {

    var PassangerBirthDate = new Date();
    var BirthDateValue = BirthDate.split('/');
    PassangerBirthDate.setFullYear(BirthDateValue[2], (BirthDateValue[1] - 1), BirthDateValue[0]);

    var DateMin = new Date();
    var DateMax = new Date();

    var dd = DateMin.getDate();
    var mm = DateMin.getMonth();
    var yyyy = DateMin.getFullYear();

    if (PassangerType == "Adult") {
        DateMax.setFullYear(yyyy - 101, mm, dd);
        DateMin.setFullYear(yyyy - 24, mm, dd);

        if (PassangerBirthDate <= DateMax || PassangerBirthDate >= DateMin) {
            return 1;
        }
    }
    else if (PassangerType == "Old") {
        DateMax.setFullYear(yyyy - 120, mm, dd);
        DateMin.setFullYear(yyyy - 65, mm, dd);
        if (PassangerBirthDate <= DateMax || PassangerBirthDate >= DateMin)
            return 1;
    }
    else if (PassangerType == "Baby") {
        DateMax.setFullYear(yyyy - 2, mm, dd);
        DateMin.setFullYear(yyyy, mm, dd);
        if (PassangerBirthDate <= DateMax || PassangerBirthDate >= DateMin)
            return 1;
    }
    else if (PassangerType == "Child") {
        DateMax.setFullYear(yyyy - 12, mm, dd);
        DateMin.setFullYear(yyyy - 2, mm, dd);
        if (PassangerBirthDate <= DateMax || PassangerBirthDate >= DateMin)
            return 1;
    }
    else if (PassangerType == "Young") {
        DateMax.setFullYear(yyyy - 24, mm, dd);
        DateMin.setFullYear(yyyy - 12, mm, dd);
        if (PassangerBirthDate <= DateMax || PassangerBirthDate >= DateMin)
            return 1;
    }


    return 0;

}

function validationPopup() {
    $(".validationPopup").dialog({
        bgiframe: true,
        width: 490,
        //height: 430,
        modal: true,
        autoOpen: true,
        draggable: false,
        resizable: false,
        dialogClass: 'paymentPopupFrameValidation'
    });
    $('div[class="ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix"]').hide();
    $(".validationPopup").dialog("open");

}


function openGeneralAlertDialog() {
    alert("general error");
}

function closePaymentPopup() {
    $("#paymentPopup").dialog("close");
    $('html, body').css('overflowY', 'auto');
}

function closeValidationPopup() {
    $(".validationPopup").dialog("close");
}

function closedialog() {
    RefreshBasket();
    $('.ui-dialog-titlebar-close').click();
}


function RefreshBasket() {
    $.get("/Handlers/User/Basket.aspx", function (data) {
        $("#basketPH").html(data);
        // loadBasketCount();

        $("#relogin,#A2").bind('click', function () {
            $.ajax({
                dataType: "json",
                type: 'POST',
                url: "/Handlers/User/UserSession.aspx?action=LOGOUT",
                success: function (data) {
                    document.location.href = "/";
                }
            });

        });

        $(".erase").click(function () {
            var obj = $(this);
            if (confirm('מוצר זה ימחק מסל הקניות שלך, האם להמשיך?')) {
                ContinueWithDelete(obj.attr("rel"));
            }
        });
    });
}

function MailKeyPress(event) {

    var c;
    if (navigator.appCodeName == "Mozilla") {
        c = event.which;

        if (c == undefined) //FIX for IE6 / 7 / 8
            c = event.keyCode;
    }
    else {
        if (window.event) // IE8 and earlier
            c = event.keyCode;
        else if (event.which) // IE9/Firefox/Chrome/Opera/Safari
            c = event.which;
    }

    if ((c >= "65" && c <= "90") || (c >= "48" && c <= "57") ||
                 (c >= "97" && c <= "122") || c == 45 || c == 64 || c == 46 || c == 95 || c == 0 || c == 8)

        return true;
    else
        return false;

}
function MailInputTextTest() {
    if (navigator.appCodeName == "Mozilla") {
        $("div").bind('paste', function (e) {
            return false;
        });
    }
    else {
        $("div").bind('paste', function (e) {
            if (ExtractText(window.clipboardData.getData('Text')) == "0")
                return true;
            else
                return false;
        });
    }
}
function ExtractText(sValue) {
    var result = "0";
    var sDigits = "";

    for (var i = sValue.length - 1; i >= 0; i--) {
        var c = Asc(sValue.charAt(i));
        if ((c >= "65" && c <= "90") || (c >= "48" && c <= "57") ||
                 (c >= "97" && c <= "122") || c == 45 || c == 64 || c == 46 || c == 95)

            result = "1";
    }
    return result;
}
function Asc(String) {

    return String.charCodeAt(0);
}

function PhoneKeyPress(event) {

    var c;
    if (navigator.appCodeName == "Mozilla") {
        c = event.which;

        if (c == undefined) //FIX for IE6 / 7 / 8
            c = event.keyCode;
    }
    else {
        if (window.event) // IE8 and earlier
            c = event.keyCode;
        else if (event.which) // IE9/Firefox/Chrome/Opera/Safari
            c = event.which;
    }

    if ((c >= "48" && c <= "57") || c == "43" || c == "0" || c == "8")

        return true;
    else
        return false;

}
function PhoneInputTextTest() {
    if (navigator.appCodeName == "Mozilla") {
        $("div").bind('paste', function (e) {
            return false;
        });
    }
    else {
        $("div").bind('paste', function (e) {
            if (ExtractText1(window.clipboardData.getData('Text')) == "0")
                return true;
            else
                return false;
        });
    }
}
function ExtractText1(sValue) {
    var result = "0";
    var sDigits = "";

    for (var i = sValue.length - 1; i >= 0; i--) {
        var c = Asc(sValue.charAt(i));
        if ((c >= "48" && c <= "57") || c == "43")
            result = "1";
    }
    return result;
}

function KeyPress(event) {

    var c;
    if (navigator.appCodeName == "Mozilla") {
        c = event.which;

        if (c == undefined) //FIX for IE6 / 7 / 8
            c = event.keyCode;
    }
    else {
        if (window.event) // IE8 and earlier
            c = event.keyCode;
        else if (event.which) // IE9/Firefox/Chrome/Opera/Safari
            c = event.which;
    }

    if ((c >= "65" && c <= "90") ||
            (c >= "97" && c <= "122")
            || (c >= "1488" && c <= "1514") || c == 45 || c == 39 || c == 32 || c == 8 || c == 0)
        return true;
    else
        return false;

}
function InputTextTest() {
    if (navigator.appCodeName == "Mozilla") {
        $("div").bind('paste', function (e) {
            return false;
        });
    }
    else {
        $("div").bind('paste', function (e) {
            if (ExtractText(window.clipboardData.getData('Text')) == "0")
                return true;
            else
                return false;
        });
    }
}
function ExtractText(sValue) {
    var result = "0";
    var sDigits = "";

    for (var i = sValue.length - 1; i >= 0; i--) {
        var c = Asc(sValue.charAt(i));
        if ((c >= "65" && c <= "90") ||
                 (c >= "97" && c <= "122")
                  || (c >= "1488" && c <= "1514") || c == 45 || c == 39 || c == 32)
            result = "1";
    }
    return result;
}
function Asc(String) {

    return String.charCodeAt(0);
}

/*!
 * jQuery Form Plugin
 * version: 3.02 (07-MAR-2012)
 * @requires jQuery v1.3.2 or later
 *
 * Examples and documentation at: http://malsup.com/jquery/form/
 * Dual licensed under the MIT and GPL licenses:
 *    http://www.opensource.org/licenses/mit-license.php
 *    http://www.gnu.org/licenses/gpl.html
 */
/*global ActiveXObject alert */
;(function($) {
"use strict";

/*
    Usage Note:
    -----------
    Do not use both ajaxSubmit and ajaxForm on the same form.  These
    functions are mutually exclusive.  Use ajaxSubmit if you want
    to bind your own submit handler to the form.  For example,

    $(document).ready(function() {
        $('#myForm').bind('submit', function(e) {
            e.preventDefault(); // <-- important
            $(this).ajaxSubmit({
                target: '#output'
            });
        });
    });

    Use ajaxForm when you want the plugin to manage all the event binding
    for you.  For example,

    $(document).ready(function() {
        $('#myForm').ajaxForm({
            target: '#output'
        });
    });
    
    You can also use ajaxForm with delegation (requires jQuery v1.7+), so the
    form does not have to exist when you invoke ajaxForm:

    $('#myForm').ajaxForm({
        delegation: true,
        target: '#output'
    });
    
    When using ajaxForm, the ajaxSubmit function will be invoked for you
    at the appropriate time.
*/

/**
 * Feature detection
 */
var feature = {};
feature.fileapi = $("<input type='file'/>").get(0).files !== undefined;
feature.formdata = window.FormData !== undefined;

/**
 * ajaxSubmit() provides a mechanism for immediately submitting
 * an HTML form using AJAX.
 */
$.fn.ajaxSubmit = function(options) {
    /*jshint scripturl:true */

    // fast fail if nothing selected (http://dev.jquery.com/ticket/2752)
    if (!this.length) {
        log('ajaxSubmit: skipping submit process - no element selected');
        return this;
    }
    
    var method, action, url, $form = this;

    if (typeof options == 'function') {
        options = { success: options };
    }

    method = this.attr('method');
    action = this.attr('action');
    url = (typeof action === 'string') ? $.trim(action) : '';
    url = url || window.location.href || '';
    if (url) {
        // clean url (don't include hash vaue)
        url = (url.match(/^([^#]+)/)||[])[1];
    }

    options = $.extend(true, {
        url:  url,
        success: $.ajaxSettings.success,
        type: method || 'GET',
        iframeSrc: /^https/i.test(window.location.href || '') ? 'javascript:false' : 'about:blank'
    }, options);

    // hook for manipulating the form data before it is extracted;
    // convenient for use with rich editors like tinyMCE or FCKEditor
    var veto = {};
    this.trigger('form-pre-serialize', [this, options, veto]);
    if (veto.veto) {
        log('ajaxSubmit: submit vetoed via form-pre-serialize trigger');
        return this;
    }

    // provide opportunity to alter form data before it is serialized
    if (options.beforeSerialize && options.beforeSerialize(this, options) === false) {
        log('ajaxSubmit: submit aborted via beforeSerialize callback');
        return this;
    }

    var traditional = options.traditional;
    if ( traditional === undefined ) {
        traditional = $.ajaxSettings.traditional;
    }
    
    var qx, a = this.formToArray(options.semantic);
    if (options.data) {
        options.extraData = options.data;
        qx = $.param(options.data, traditional);
    }

    // give pre-submit callback an opportunity to abort the submit
    if (options.beforeSubmit && options.beforeSubmit(a, this, options) === false) {
        log('ajaxSubmit: submit aborted via beforeSubmit callback');
        return this;
    }

    // fire vetoable 'validate' event
    this.trigger('form-submit-validate', [a, this, options, veto]);
    if (veto.veto) {
        log('ajaxSubmit: submit vetoed via form-submit-validate trigger');
        return this;
    }

    var q = $.param(a, traditional);
    if (qx) {
        q = ( q ? (q + '&' + qx) : qx );
    }    
    if (options.type.toUpperCase() == 'GET') {
        options.url += (options.url.indexOf('?') >= 0 ? '&' : '?') + q;
        options.data = null;  // data is null for 'get'
    }
    else {
        options.data = q; // data is the query string for 'post'
    }

    var callbacks = [];
    if (options.resetForm) {
        callbacks.push(function() { $form.resetForm(); });
    }
    if (options.clearForm) {
        callbacks.push(function() { $form.clearForm(options.includeHidden); });
    }

    // perform a load on the target only if dataType is not provided
    if (!options.dataType && options.target) {
        var oldSuccess = options.success || function(){};
        callbacks.push(function(data) {
            var fn = options.replaceTarget ? 'replaceWith' : 'html';
            $(options.target)[fn](data).each(oldSuccess, arguments);
        });
    }
    else if (options.success) {
        callbacks.push(options.success);
    }

    options.success = function(data, status, xhr) { // jQuery 1.4+ passes xhr as 3rd arg
        var context = options.context || options;    // jQuery 1.4+ supports scope context 
        for (var i=0, max=callbacks.length; i < max; i++) {
            callbacks[i].apply(context, [data, status, xhr || $form, $form]);
        }
    };

    // are there files to upload?
    var fileInputs = $('input:file:enabled[value]', this); // [value] (issue #113)
    var hasFileInputs = fileInputs.length > 0;
    var mp = 'multipart/form-data';
    var multipart = ($form.attr('enctype') == mp || $form.attr('encoding') == mp);

    var fileAPI = feature.fileapi && feature.formdata;
    log("fileAPI :" + fileAPI);
    var shouldUseFrame = (hasFileInputs || multipart) && !fileAPI;

    // options.iframe allows user to force iframe mode
    // 06-NOV-09: now defaulting to iframe mode if file input is detected
    if (options.iframe !== false && (options.iframe || shouldUseFrame)) {
        // hack to fix Safari hang (thanks to Tim Molendijk for this)
        // see:  http://groups.google.com/group/jquery-dev/browse_thread/thread/36395b7ab510dd5d
        if (options.closeKeepAlive) {
            $.get(options.closeKeepAlive, function() {
                fileUploadIframe(a);
            });
        }
          else {
            fileUploadIframe(a);
          }
    }
    else if ((hasFileInputs || multipart) && fileAPI) {
        fileUploadXhr(a);
    }
    else {
        $.ajax(options);
    }

     // fire 'notify' event
     this.trigger('form-submit-notify', [this, options]);
     return this;

     // XMLHttpRequest Level 2 file uploads (big hat tip to francois2metz)
    function fileUploadXhr(a) {
        var formdata = new FormData();

        for (var i=0; i < a.length; i++) {
            formdata.append(a[i].name, a[i].value);
        }

        if (options.extraData) {
            for (var k in options.extraData)
                if (options.extraData.hasOwnProperty(k))
                    formdata.append(k, options.extraData[k]);
        }

        options.data = null;

        var s = $.extend(true, {}, $.ajaxSettings, options, {
            contentType: false,
            processData: false,
            cache: false,
            type: 'POST'
        });

		if (options.uploadProgress) {
			// workaround because jqXHR does not expose upload property
			s.xhr = function() {
				var xhr = jQuery.ajaxSettings.xhr();
				if (xhr.upload) {
					xhr.upload.onprogress = function(event) {
						var percent = 0;
						if (event.lengthComputable)
							percent = parseInt((event.position / event.total) * 100, 10);
						options.uploadProgress(event, event.position, event.total, percent);
					}
				}
				return xhr;
			}
		}

      	s.data = null;
      	var beforeSend = s.beforeSend;
      	s.beforeSend = function(xhr, o) {
          	o.data = formdata;
            if(beforeSend)
                beforeSend.call(o, xhr, options);
      	};
      	$.ajax(s);
   	 }

    // private function for handling file uploads (hat tip to YAHOO!)
    function fileUploadIframe(a) {
        var form = $form[0], el, i, s, g, id, $io, io, xhr, sub, n, timedOut, timeoutHandle;
        var useProp = !!$.fn.prop;

        if (a) {
            if ( useProp ) {
                // ensure that every serialized input is still enabled
                for (i=0; i < a.length; i++) {
                    el = $(form[a[i].name]);
                    el.prop('disabled', false);
                }
            } else {
                for (i=0; i < a.length; i++) {
                    el = $(form[a[i].name]);
                    el.removeAttr('disabled');
                }
            }
        }

        if ($(':input[name=submit],:input[id=submit]', form).length) {
            // if there is an input with a name or id of 'submit' then we won't be
            // able to invoke the submit fn on the form (at least not x-browser)
            alert('Error: Form elements must not have name or id of "submit".');
            return;
        }
        
        s = $.extend(true, {}, $.ajaxSettings, options);
        s.context = s.context || s;
        id = 'jqFormIO' + (new Date().getTime());
        if (s.iframeTarget) {
            $io = $(s.iframeTarget);
            n = $io.attr('name');
            if (!n)
                 $io.attr('name', id);
            else
                id = n;
        }
        else {
            $io = $('<iframe name="' + id + '" src="'+ s.iframeSrc +'" />');
            $io.css({ position: 'absolute', top: '-1000px', left: '-1000px' });
        }
        io = $io[0];


        xhr = { // mock object
            aborted: 0,
            responseText: null,
            responseXML: null,
            status: 0,
            statusText: 'n/a',
            getAllResponseHeaders: function() {},
            getResponseHeader: function() {},
            setRequestHeader: function() {},
            abort: function(status) {
                var e = (status === 'timeout' ? 'timeout' : 'aborted');
                log('aborting upload... ' + e);
                this.aborted = 1;
                $io.attr('src', s.iframeSrc); // abort op in progress
                xhr.error = e;
                if (s.error)
                    s.error.call(s.context, xhr, e, status);
                if (g)
                    $.event.trigger("ajaxError", [xhr, s, e]);
                if (s.complete)
                    s.complete.call(s.context, xhr, e);
            }
        };

        g = s.global;
        // trigger ajax global events so that activity/block indicators work like normal
        if (g && 0 === $.active++) {
            $.event.trigger("ajaxStart");
        }
        if (g) {
            $.event.trigger("ajaxSend", [xhr, s]);
        }

        if (s.beforeSend && s.beforeSend.call(s.context, xhr, s) === false) {
            if (s.global) {
                $.active--;
            }
            return;
        }
        if (xhr.aborted) {
            return;
        }

        // add submitting element to data if we know it
        sub = form.clk;
        if (sub) {
            n = sub.name;
            if (n && !sub.disabled) {
                s.extraData = s.extraData || {};
                s.extraData[n] = sub.value;
                if (sub.type == "image") {
                    s.extraData[n+'.x'] = form.clk_x;
                    s.extraData[n+'.y'] = form.clk_y;
                }
            }
        }
        
        var CLIENT_TIMEOUT_ABORT = 1;
        var SERVER_ABORT = 2;

        function getDoc(frame) {
            var doc = frame.contentWindow ? frame.contentWindow.document : frame.contentDocument ? frame.contentDocument : frame.document;
            return doc;
        }
        
        // Rails CSRF hack (thanks to Yvan Barthelemy)
        var csrf_token = $('meta[name=csrf-token]').attr('content');
        var csrf_param = $('meta[name=csrf-param]').attr('content');
        if (csrf_param && csrf_token) {
            s.extraData = s.extraData || {};
            s.extraData[csrf_param] = csrf_token;
        }

        // take a breath so that pending repaints get some cpu time before the upload starts
        function doSubmit() {
            // make sure form attrs are set
            var t = $form.attr('target'), a = $form.attr('action');

            // update form attrs in IE friendly way
            form.setAttribute('target',id);
            if (!method) {
                form.setAttribute('method', 'POST');
            }
            if (a != s.url) {
                form.setAttribute('action', s.url);
            }

            // ie borks in some cases when setting encoding
            if (! s.skipEncodingOverride && (!method || /post/i.test(method))) {
                $form.attr({
                    encoding: 'multipart/form-data',
                    enctype:  'multipart/form-data'
                });
            }

            // support timout
            if (s.timeout) {
                timeoutHandle = setTimeout(function() { timedOut = true; cb(CLIENT_TIMEOUT_ABORT); }, s.timeout);
            }
            
            // look for server aborts
            function checkState() {
                try {
                    var state = getDoc(io).readyState;
                    log('state = ' + state);
                    if (state && state.toLowerCase() == 'uninitialized')
                        setTimeout(checkState,50);
                }
                catch(e) {
                    log('Server abort: ' , e, ' (', e.name, ')');
                    cb(SERVER_ABORT);
                    if (timeoutHandle)
                        clearTimeout(timeoutHandle);
                    timeoutHandle = undefined;
                }
            }

            // add "extra" data to form if provided in options
            var extraInputs = [];
            try {
                if (s.extraData) {
                    for (var n in s.extraData) {
                        if (s.extraData.hasOwnProperty(n)) {
                            extraInputs.push(
                                $('<input type="hidden" name="'+n+'">').attr('value',s.extraData[n])
                                    .appendTo(form)[0]);
                        }
                    }
                }

                if (!s.iframeTarget) {
                    // add iframe to doc and submit the form
                    $io.appendTo('body');
                    if (io.attachEvent)
                        io.attachEvent('onload', cb);
                    else
                        io.addEventListener('load', cb, false);
                }
                setTimeout(checkState,15);
                form.submit();
            }
            finally {
                // reset attrs and remove "extra" input elements
                form.setAttribute('action',a);
                if(t) {
                    form.setAttribute('target', t);
                } else {
                    $form.removeAttr('target');
                }
                $(extraInputs).remove();
            }
        }

        if (s.forceSync) {
            doSubmit();
        }
        else {
            setTimeout(doSubmit, 10); // this lets dom updates render
        }

        var data, doc, domCheckCount = 50, callbackProcessed;

        function cb(e) {
            if (xhr.aborted || callbackProcessed) {
                return;
            }
            try {
                doc = getDoc(io);
            }
            catch(ex) {
                log('cannot access response document: ', ex);
                e = SERVER_ABORT;
            }
            if (e === CLIENT_TIMEOUT_ABORT && xhr) {
                xhr.abort('timeout');
                return;
            }
            else if (e == SERVER_ABORT && xhr) {
                xhr.abort('server abort');
                return;
            }

            if (!doc || doc.location.href == s.iframeSrc) {
                // response not received yet
                if (!timedOut)
                    return;
            }
            if (io.detachEvent)
                io.detachEvent('onload', cb);
            else    
                io.removeEventListener('load', cb, false);

            var status = 'success', errMsg;
            try {
                if (timedOut) {
                    throw 'timeout';
                }

                var isXml = s.dataType == 'xml' || doc.XMLDocument || $.isXMLDoc(doc);
                log('isXml='+isXml);
                if (!isXml && window.opera && (doc.body === null || !doc.body.innerHTML)) {
                    if (--domCheckCount) {
                        // in some browsers (Opera) the iframe DOM is not always traversable when
                        // the onload callback fires, so we loop a bit to accommodate
                        log('requeing onLoad callback, DOM not available');
                        setTimeout(cb, 250);
                        return;
                    }
                    // let this fall through because server response could be an empty document
                    //log('Could not access iframe DOM after mutiple tries.');
                    //throw 'DOMException: not available';
                }

                //log('response detected');
                var docRoot = doc.body ? doc.body : doc.documentElement;
                xhr.responseText = docRoot ? docRoot.innerHTML : null;
                xhr.responseXML = doc.XMLDocument ? doc.XMLDocument : doc;
                if (isXml)
                    s.dataType = 'xml';
                xhr.getResponseHeader = function(header){
                    var headers = {'content-type': s.dataType};
                    return headers[header];
                };
                // support for XHR 'status' & 'statusText' emulation :
                if (docRoot) {
                    xhr.status = Number( docRoot.getAttribute('status') ) || xhr.status;
                    xhr.statusText = docRoot.getAttribute('statusText') || xhr.statusText;
                }

                var dt = (s.dataType || '').toLowerCase();
                var scr = /(json|script|text)/.test(dt);
                if (scr || s.textarea) {
                    // see if user embedded response in textarea
                    var ta = doc.getElementsByTagName('textarea')[0];
                    if (ta) {
                        xhr.responseText = ta.value;
                        // support for XHR 'status' & 'statusText' emulation :
                        xhr.status = Number( ta.getAttribute('status') ) || xhr.status;
                        xhr.statusText = ta.getAttribute('statusText') || xhr.statusText;
                    }
                    else if (scr) {
                        // account for browsers injecting pre around json response
                        var pre = doc.getElementsByTagName('pre')[0];
                        var b = doc.getElementsByTagName('body')[0];
                        if (pre) {
                            xhr.responseText = pre.textContent ? pre.textContent : pre.innerText;
                        }
                        else if (b) {
                            xhr.responseText = b.textContent ? b.textContent : b.innerText;
                        }
                    }
                }
                else if (dt == 'xml' && !xhr.responseXML && xhr.responseText) {
                    xhr.responseXML = toXml(xhr.responseText);
                }

                try {
                    data = httpData(xhr, dt, s);
                }
                catch (e) {
                    status = 'parsererror';
                    xhr.error = errMsg = (e || status);
                }
            }
            catch (e) {
                log('error caught: ',e);
                status = 'error';
                xhr.error = errMsg = (e || status);
            }

            if (xhr.aborted) {
                log('upload aborted');
                status = null;
            }

            if (xhr.status) { // we've set xhr.status
                status = (xhr.status >= 200 && xhr.status < 300 || xhr.status === 304) ? 'success' : 'error';
            }

            // ordering of these callbacks/triggers is odd, but that's how $.ajax does it
            if (status === 'success') {
                if (s.success)
                    s.success.call(s.context, data, 'success', xhr);
                if (g)
                    $.event.trigger("ajaxSuccess", [xhr, s]);
            }
            else if (status) {
                if (errMsg === undefined)
                    errMsg = xhr.statusText;
                if (s.error)
                    s.error.call(s.context, xhr, status, errMsg);
                if (g)
                    $.event.trigger("ajaxError", [xhr, s, errMsg]);
            }

            if (g)
                $.event.trigger("ajaxComplete", [xhr, s]);

            if (g && ! --$.active) {
                $.event.trigger("ajaxStop");
            }

            if (s.complete)
                s.complete.call(s.context, xhr, status);

            callbackProcessed = true;
            if (s.timeout)
                clearTimeout(timeoutHandle);

            // clean up
            setTimeout(function() {
                if (!s.iframeTarget)
                    $io.remove();
                xhr.responseXML = null;
            }, 100);
        }

        var toXml = $.parseXML || function(s, doc) { // use parseXML if available (jQuery 1.5+)
            if (window.ActiveXObject) {
                doc = new ActiveXObject('Microsoft.XMLDOM');
                doc.async = 'false';
                doc.loadXML(s);
            }
            else {
                doc = (new DOMParser()).parseFromString(s, 'text/xml');
            }
            return (doc && doc.documentElement && doc.documentElement.nodeName != 'parsererror') ? doc : null;
        };
        var parseJSON = $.parseJSON || function(s) {
            /*jslint evil:true */
            return window['eval']('(' + s + ')');
        };

        var httpData = function( xhr, type, s ) { // mostly lifted from jq1.4.4

            var ct = xhr.getResponseHeader('content-type') || '',
                xml = type === 'xml' || !type && ct.indexOf('xml') >= 0,
                data = xml ? xhr.responseXML : xhr.responseText;

            if (xml && data.documentElement.nodeName === 'parsererror') {
                if ($.error)
                    $.error('parsererror');
            }
            if (s && s.dataFilter) {
                data = s.dataFilter(data, type);
            }
            if (typeof data === 'string') {
                if (type === 'json' || !type && ct.indexOf('json') >= 0) {
                    data = parseJSON(data);
                } else if (type === "script" || !type && ct.indexOf("javascript") >= 0) {
                    $.globalEval(data);
                }
            }
            return data;
        };
    }
};

/**
 * ajaxForm() provides a mechanism for fully automating form submission.
 *
 * The advantages of using this method instead of ajaxSubmit() are:
 *
 * 1: This method will include coordinates for <input type="image" /> elements (if the element
 *    is used to submit the form).
 * 2. This method will include the submit element's name/value data (for the element that was
 *    used to submit the form).
 * 3. This method binds the submit() method to the form for you.
 *
 * The options argument for ajaxForm works exactly as it does for ajaxSubmit.  ajaxForm merely
 * passes the options argument along after properly binding events for submit elements and
 * the form itself.
 */
$.fn.ajaxForm = function(options) {
    options = options || {};
    options.delegation = options.delegation && $.isFunction($.fn.on);
    
    // in jQuery 1.3+ we can fix mistakes with the ready state
    if (!options.delegation && this.length === 0) {
        var o = { s: this.selector, c: this.context };
        if (!$.isReady && o.s) {
            log('DOM not ready, queuing ajaxForm');
            $(function() {
                $(o.s,o.c).ajaxForm(options);
            });
            return this;
        }
        // is your DOM ready?  http://docs.jquery.com/Tutorials:Introducing_$(document).ready()
        log('terminating; zero elements found by selector' + ($.isReady ? '' : ' (DOM not ready)'));
        return this;
    }

    if ( options.delegation ) {
        $(document)
            .off('submit.form-plugin', this.selector, doAjaxSubmit)
            .off('click.form-plugin', this.selector, captureSubmittingElement)
            .on('submit.form-plugin', this.selector, options, doAjaxSubmit)
            .on('click.form-plugin', this.selector, options, captureSubmittingElement);
        return this;
    }

    return this.ajaxFormUnbind()
        .bind('submit.form-plugin', options, doAjaxSubmit)
        .bind('click.form-plugin', options, captureSubmittingElement);
};

// private event handlers    
function doAjaxSubmit(e) {
    /*jshint validthis:true */
    var options = e.data;
    if (!e.isDefaultPrevented()) { // if event has been canceled, don't proceed
        e.preventDefault();
        $(this).ajaxSubmit(options);
    }
}
    
function captureSubmittingElement(e) {
    /*jshint validthis:true */
    var target = e.target;
    var $el = $(target);
    if (!($el.is(":submit,input:image"))) {
        // is this a child element of the submit el?  (ex: a span within a button)
        var t = $el.closest(':submit');
        if (t.length === 0) {
            return;
        }
        target = t[0];
    }
    var form = this;
    form.clk = target;
    if (target.type == 'image') {
        if (e.offsetX !== undefined) {
            form.clk_x = e.offsetX;
            form.clk_y = e.offsetY;
        } else if (typeof $.fn.offset == 'function') {
            var offset = $el.offset();
            form.clk_x = e.pageX - offset.left;
            form.clk_y = e.pageY - offset.top;
        } else {
            form.clk_x = e.pageX - target.offsetLeft;
            form.clk_y = e.pageY - target.offsetTop;
        }
    }
    // clear form vars
    setTimeout(function() { form.clk = form.clk_x = form.clk_y = null; }, 100);
}


// ajaxFormUnbind unbinds the event handlers that were bound by ajaxForm
$.fn.ajaxFormUnbind = function() {
    return this.unbind('submit.form-plugin click.form-plugin');
};

/**
 * formToArray() gathers form element data into an array of objects that can
 * be passed to any of the following ajax functions: $.get, $.post, or load.
 * Each object in the array has both a 'name' and 'value' property.  An example of
 * an array for a simple login form might be:
 *
 * [ { name: 'username', value: 'jresig' }, { name: 'password', value: 'secret' } ]
 *
 * It is this array that is passed to pre-submit callback functions provided to the
 * ajaxSubmit() and ajaxForm() methods.
 */
$.fn.formToArray = function(semantic) {
    
    var a = [];
    if (this.length === 0) {
        return a;
    }

    var form = this[0];
    var els = semantic ? form.getElementsByTagName('*') : form.elements;
    if (!els) {
        return a;
    }

    var i,j,n,v,el,max,jmax;
    for(i=0, max=els.length; i < max; i++) {
        el = els[i];
        n = el.name;
        if (!n) {
            continue;
        }

        if (semantic && form.clk && el.type == "image") {
            // handle image inputs on the fly when semantic == true
            if(!el.disabled && form.clk == el) {
                a.push({name: n, value: $(el).val(), type: el.type });
                a.push({name: n+'.x', value: form.clk_x}, {name: n+'.y', value: form.clk_y});
            }
            continue;
        }

        v = $.fieldValue(el, true);
        if (v && v.constructor == Array) {
            for(j=0, jmax=v.length; j < jmax; j++) {
                a.push({name: n, value: v[j]});
            }
        }
        else if (feature.fileapi && el.type == 'file' && !el.disabled) {
            var files = el.files;
            for (j=0; j < files.length; j++) {
                a.push({name: n, value: files[j], type: el.type});
            }
        }
        else if (v !== null && typeof v != 'undefined') {
            a.push({name: n, value: v, type: el.type});
        }
    }

    if (!semantic && form.clk) {
        // input type=='image' are not found in elements array! handle it here
        var $input = $(form.clk), input = $input[0];
        n = input.name;
        if (n && !input.disabled && input.type == 'image') {
            a.push({name: n, value: $input.val()});
            a.push({name: n+'.x', value: form.clk_x}, {name: n+'.y', value: form.clk_y});
        }
    }
    return a;
};

/**
 * Serializes form data into a 'submittable' string. This method will return a string
 * in the format: name1=value1&amp;name2=value2
 */

$.fn.formSerialize = function(semantic) {
    //hand off to jQuery.param for proper encoding
    
    return $.param(this.formToArray(semantic));
};

/**
 * Serializes all field elements in the jQuery object into a query string.
 * This method will return a string in the format: name1=value1&amp;name2=value2
 */
$.fn.fieldSerialize = function(successful) {
    var a = [];
    this.each(function() {
        var n = this.name;
        if (!n) {
            return;
        }
        var v = $.fieldValue(this, successful);
        if (v && v.constructor == Array) {
            for (var i=0,max=v.length; i < max; i++) {
                a.push({name: n, value: v[i]});
            }
        }
        else if (v !== null && typeof v != 'undefined') {
            a.push({name: this.name, value: v});
        }
    });
    //hand off to jQuery.param for proper encoding
    return $.param(a);
};

/**
 * Returns the value(s) of the element in the matched set.  For example, consider the following form:
 *
 *  <form><fieldset>
 *      <input name="A" type="text" />
 *      <input name="A" type="text" />
 *      <input name="B" type="checkbox" value="B1" />
 *      <input name="B" type="checkbox" value="B2"/>
 *      <input name="C" type="radio" value="C1" />
 *      <input name="C" type="radio" value="C2" />
 *  </fieldset></form>
 *
 *  var v = $(':text').fieldValue();
 *  // if no values are entered into the text inputs
 *  v == ['','']
 *  // if values entered into the text inputs are 'foo' and 'bar'
 *  v == ['foo','bar']
 *
 *  var v = $(':checkbox').fieldValue();
 *  // if neither checkbox is checked
 *  v === undefined
 *  // if both checkboxes are checked
 *  v == ['B1', 'B2']
 *
 *  var v = $(':radio').fieldValue();
 *  // if neither radio is checked
 *  v === undefined
 *  // if first radio is checked
 *  v == ['C1']
 *
 * The successful argument controls whether or not the field element must be 'successful'
 * (per http://www.w3.org/TR/html4/interact/forms.html#successful-controls).
 * The default value of the successful argument is true.  If this value is false the value(s)
 * for each element is returned.
 *
 * Note: This method *always* returns an array.  If no valid value can be determined the
 *    array will be empty, otherwise it will contain one or more values.
 */
$.fn.fieldValue = function(successful) {
    for (var val=[], i=0, max=this.length; i < max; i++) {
        var el = this[i];
        var v = $.fieldValue(el, successful);
        if (v === null || typeof v == 'undefined' || (v.constructor == Array && !v.length)) {
            continue;
        }
        if (v.constructor == Array)
            $.merge(val, v);
        else
            val.push(v);
    }
    return val;
};

/**
 * Returns the value of the field element.
 */
$.fieldValue = function(el, successful) {
    var n = el.name, t = el.type, tag = el.tagName.toLowerCase();
    if (successful === undefined) {
        successful = true;
    }

    if (successful && (!n || el.disabled || t == 'reset' || t == 'button' ||
        (t == 'checkbox' || t == 'radio') && !el.checked ||
        (t == 'submit' || t == 'image') && el.form && el.form.clk != el ||
        tag == 'select' && el.selectedIndex == -1)) {
            return null;
    }

    if (tag == 'select') {
        var index = el.selectedIndex;
        if (index < 0) {
            return null;
        }
        var a = [], ops = el.options;
        var one = (t == 'select-one');
        var max = (one ? index+1 : ops.length);
        for(var i=(one ? index : 0); i < max; i++) {
            var op = ops[i];
            if (op.selected) {
                var v = op.value;
                if (!v) { // extra pain for IE...
                    v = (op.attributes && op.attributes['value'] && !(op.attributes['value'].specified)) ? op.text : op.value;
                }
                if (one) {
                    return v;
                }
                a.push(v);
            }
        }
        return a;
    }
    return $(el).val();
};

/**
 * Clears the form data.  Takes the following actions on the form's input fields:
 *  - input text fields will have their 'value' property set to the empty string
 *  - select elements will have their 'selectedIndex' property set to -1
 *  - checkbox and radio inputs will have their 'checked' property set to false
 *  - inputs of type submit, button, reset, and hidden will *not* be effected
 *  - button elements will *not* be effected
 */
$.fn.clearForm = function(includeHidden) {
    return this.each(function() {
        $('input,select,textarea', this).clearFields(includeHidden);
    });
};

/**
 * Clears the selected form elements.
 */
$.fn.clearFields = $.fn.clearInputs = function(includeHidden) {
    var re = /^(?:color|date|datetime|email|month|number|password|range|search|tel|text|time|url|week)$/i; // 'hidden' is not in this list
    return this.each(function() {
        var t = this.type, tag = this.tagName.toLowerCase();
        if (re.test(t) || tag == 'textarea' || (includeHidden && /hidden/.test(t)) ) {
            this.value = '';
        }
        else if (t == 'checkbox' || t == 'radio') {
            this.checked = false;
        }
        else if (tag == 'select') {
            this.selectedIndex = -1;
        }
    });
};

/**
 * Resets the form data.  Causes all form elements to be reset to their original value.
 */
$.fn.resetForm = function() {
    return this.each(function() {
        // guard against an input with the name of 'reset'
        // note that IE reports the reset function as an 'object'
        if (typeof this.reset == 'function' || (typeof this.reset == 'object' && !this.reset.nodeType)) {
            this.reset();
        }
    });
};

/**
 * Enables or disables any matching elements.
 */
$.fn.enable = function(b) {
    if (b === undefined) {
        b = true;
    }
    return this.each(function() {
        this.disabled = !b;
    });
};

/**
 * Checks/unchecks any matching checkboxes or radio buttons and
 * selects/deselects and matching option elements.
 */
$.fn.selected = function(select) {
    if (select === undefined) {
        select = true;
    }
    return this.each(function() {
        var t = this.type;
        if (t == 'checkbox' || t == 'radio') {
            this.checked = select;
        }
        else if (this.tagName.toLowerCase() == 'option') {
            var $sel = $(this).parent('select');
            if (select && $sel[0] && $sel[0].type == 'select-one') {
                // deselect all other options
                $sel.find('option').selected(false);
            }
            this.selected = select;
        }
    });
};

// expose debug var
$.fn.ajaxSubmit.debug = false;

// helper fn for console logging
function log() {
    if (!$.fn.ajaxSubmit.debug) 
        return;
    var msg = '[jquery.form] ' + Array.prototype.join.call(arguments,'');
    if (window.console && window.console.log) {
        window.console.log(msg);
    }
    else if (window.opera && window.opera.postError) {
        window.opera.postError(msg);
    }
}

})(jQuery);

// Read a page's GET URL variables and return them as an associative array.
$.extend({
    getUrlVars: function () {
        var vars = [], hash;
        var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
        for (var i = 0; i < hashes.length; i++) {
            hash = hashes[i].split('=');
            vars.push(hash[0]);
            vars[hash[0]] = hash[1];
        }
        return vars;
    },

    getUrlVar: function (name) {

        return $.getUrlVars()[name];
    },

    getQueryString: function () {
       
        if (window.location.href.indexOf('?') == -1) {
            return "";
        }
        else {
            return window.location.href.slice(window.location.href.indexOf('?') + 1);
        }
    }
});


function exctractDomain(url)
{    
    var domain;
    //find & remove protocol (http, ftp, etc.) and get domain
    if (url.indexOf("://") > -1) {
        domain = url.split('/')[2];
    }
    else {
        domain = url.split('/')[0];
    }

    //find & remove port number
    domain = domain.split(':')[0];

    return domain;

}

function isDomainsSimilar(url1, url2) {
    
    return exctractDomain(url1).toUpperCase() === exctractDomain(url2).toUpperCase();
}

/* version number */
//-------------------
/* end version number */
//Fix internet Explorer Plach Holdr

var _productType = "";
var _loadingImgUrl = "";
$(document).ready(function () {
    
    $(".searchWizardDestinationAutoComplete").each(function (i, el) {
        el = $(el);
        
        var sourceUrl = "/Handlers/Destinations.ashx";

        el.autocomplete({
            position: { my: "right top", at: "right bottom" },
            source: function (request, response) {
                var country = el.attr('rel');
                var productTypeForHandler = $("#hdn_wizard").val();
                var onlyabroad = false;
                if (productTypeForHandler == "Flight" || productTypeForHandler == "Deals")
                {
                    onlyabroad = true;
                    sourceUrl = "/Handlers/UmbracoDestination.ashx";
                    //sourceUrl = "/Handlers/Destinations.ashx";
                }

                $.ajax({
                    url: sourceUrl,

                    dataType: "json",
                    // request.term - the typed keys
                    data: { value: request.term, code: country, onlyabroad: onlyabroad, productType: productTypeForHandler },
                    success: function (data) {
                        if ($(el).parents("div.wizard").css("display") == "block") {
                            if (data != null && data.length > 0) {
                                //.map loops the result and shows the menu
                                response($.map(data, function (item) {
                                    if (item.destinationCode != "SDV") {
                                        $('#hiddenCountry').val(item.countryCode);
                                        var label = __highlight(item.destinationName, request.term);
                                        return { label: label, value: item.destinationCode, shortName: item.shortName }
                                    }

                                }));
                            }
                        }
                        else {
                        }
                    }
                });
            },
            /*focus: function (event, ui) {
            $(this).val(ui.item.label);
            $(this).attr('shortName', ui.item.shortName);
            return false;
            },*/
            // to replace the textbox value both select and focus events need to be overriden
            select: function (event, ui) {
                // each autocomplete textbox has a paralel hidden field. the difference between them is that
                // the textbox has no name attribute and the hidden field does. That is because when the search button is clicked
                // there is a call to jquery formSerialize() which loop all inputs with name attribute. There is no need for the destinations textboxes becuase
                // they are too long. there for the destination code is put in the hidden field which has a name attribute.
                $('#' + this.id.replace('txt', '')).val(ui.item.value).attr('shortName', ui.item.shortName);
                $(this).val(ui.item.shortName);
                $(this).attr('shortName', ui.item.shortName);
                $(this).attr('code', ui.item.value);
                //alert('ziv1')--> this is after select from autocomplete
                //Focus On next Element
                if (typeof ($(this).attr('next')) != "undefined" && $(this).attr('next') != '') {
                    $('#' + $(this).attr('next')).focus();
                }



                //Meny Way Assing Destanation on Next Data
                if ($('#ManyWays').hasClass('bg_red') && this.id == 'txtdestinationFlight') {
                    $('#txtfrom2').val($('#txtdestinationFlight').val());
                    $('#txtfrom2').attr('code', ui.item.value);
                    $('#from2').val(ui.item.value).attr('shortName', ui.item.shortName);

                    $('#fromFlight2').val($('#destinationFlight').val());
                }
                if ($('#ManyWays').hasClass('bg_red') && this.id == 'txtto2') {
                    $('#txtfrom3').val($('#txtto2').val());
                    $('#txtfrom3').attr('code', ui.item.value);

                    $('#from3').val(ui.item.value).attr('shortName', ui.item.shortName);
                }
                if ($('#ManyWays').hasClass('bg_red') && this.id == 'txtoriginFlight') {
                    $('#txtto3').val($('#txtoriginFlight').val());
                    $('#txtto3').attr('code', ui.item.value);
                    $('#to3').val($('#originFlight').val());
                }

                if (typeof (window.setWizardAfterAutoComplete) == "function") {
                    setWizardAfterAutoComplete();
                }
                //                var currentDate = new Date();
                //                GetSpecialDates(currentDate.getFullYear(), currentDate.getMonth() + 1, function () {
                //                    $("#from").datepicker("refresh");
                //                    $("#to").datepicker("refresh");
                //                    //rePaint();
                //                });
                return false;
            }
        }).data("ui-autocomplete")._renderItem = function (ul, item) {
            // only change here was to replace .text() with .html()
            return $("<li></li>")
                  .data("item.autocomplete", item)
                  .append($("<a></a>").html(item.label))
                  .appendTo(ul);
        };
    });

    $('#DomesticFlightsShortBox').live('click', function () {
        $(this).parent().hide();
        $('#DomesticFlightsBox').parent().show();
    });

    $('.autocompleterole').keydown(function (e) {
        if (e.keyCode == '13' || e.keyCode == '38' || e.keyCode == '40' || e.keyCode == '9') {
            //this is ok, this is enter, up, tab or down key... should not reset cause of this.
        }
        else { //any other key, reset.
            $(this).attr('code', '');
        }
    });


    $('#OrganizedShortBox').live('click', function () {
        $(this).parent().hide();
        $('#OrganizedBox').parent().show();
    });

    $('#CarShortBox').live('click', function () {
        $(this).parent().hide();
        $('#CarBox').parent().show();
    });

    $('#HotelsShortBox').live('click', function () {
        $(this).parent().hide();
        $('#HotelsBox').parent().show();
    });

    //    $('.allProducts').live('click', function () {
    //        $(this).parents('.controlNone').hide();
    //        $('.whatShortBox').show();
    //    });


    $('.boxs').live('click', function () {
        $(this).hide();
        $(this).next().show();
        //FixHeight();
    });


    //    $('.searchWizard > img').live('click', function () {
    //        $(this).parents('.controlNone').hide();
    //        $(this).parents('.controlNone').prev().show();
    //    });


    $('.searchBoxMore').bind('click', function () {
        if ($('#Div2').is(":visible")) {
            $('#Div2').hide();
        }

        $(this).siblings('.searchWizardMore:first').delay(100).show("slide", { direction: "right" }, 500);
    });

    $('.searchWizardMore .close').bind('click', function () {
        $(this).parents('.searchWizardMore:first').hide("slide", { direction: "right" }, 500);
    });

    // End - Search Wizard

    $('#ddlRoomsNum').change(function () {
        ddlRoomsNum_Change($(this).val());
    });

    $('.onlyselect input[type="text"]').mask("99/99/9999", { placeholder: '__/__/____' })
    $('.onlyselect input[type="text"]').bind('blur', function () {
        var arrDate = $('#hiddenToday').val().split('/');
        var myDate = new Date(arrDate[2], arrDate[1], arrDate[0]);
    });
});

function ddlRoomsNum_Change(roomCount) {
    var room1Html = $('#tblRoom1').html();
    for (var i = 1; i <= 6; i++) {

        //if the room table exists
        if ($('#tblRoom' + i).length > 0) {
            ///show relevant room tables only
            if (i <= roomCount) {
                var roomiHtml = room1Html.replace(/Room1/g, 'Room' + i);

                ///if the room table is not currently visible - create it with default values
                ///existing room selections won't be changed
                //if ($('#tblRoom' + i).html().toLowerCase() == '<tbody></tbody>' || $.trim($('#tblRoom' + i).html()) == '') {
                if ($('#tblRoom' + i).children('tbody').children('tr').length == 0) {
                    $('#tblRoom' + i).html(roomiHtml);
                    //romm title
                    $('#spnRoom' + i + 'Index').html(i);

                    ///default candidates
                    if (getQuerystring('Room' + i + 'A') != "")
                        $('#ddlAdultNumRoom' + i).val(getQuerystring('Room' + i + 'A'));
                    else
                        $('#ddlAdultNumRoom' + i).val('1');


                    if (getQuerystring('Room' + i + 'C') != "")
                        $('#ddlChildNumRoom' + i).val(getQuerystring('Room' + i + 'C'));
                    else
                        $('#ddlChildNumRoom' + i).val('0');


                    if (getQuerystring('Room' + i + 'B') != "")
                        $('#ddlBabyNumRoom' + i).val(getQuerystring('Room' + i + 'B'));
                    else
                        $('#ddlBabyNumRoom' + i).val('0');
                }
            }
                ///hide irelevant room tables
            else {
                $('#tblRoom' + i).html('<TBODY></TBODY>');
            }
        }
    }
}

function ShowSearchWizard(productEnum, lobbyUrl) {
    document.location.href = lobbyUrl;
    return;



}

function formDeserialize() {
    try {
        $("#form_wizard").deserialize(window.location.href.slice(window.location.href.indexOf('?') + 1), {
            except: ['page']
        })
    }
    ///TODO: find out why sometimes the deserialize throws.
    ///when removing this try, js processing of the rest of the scritps also throws
    catch (e) {

    }
}

function changeSorting(qParam) {
    var url = updateQueryStringParameter(window.location.href, 'sort', qParam);
    
    window.location.href = url;
}

function changeSortingOut(qParam) {
    var url = updateQueryStringParameter(window.location.href, 'sort', qParam);

    var queryString = url.slice(url.indexOf('?') + 1);

    GetOutGoingDomesticFlights(queryString);
}

function changeSortingIn(qParam) {
    var url = updateQueryStringParameter(window.location.href, 'sort', qParam);

    var queryString = url.slice(url.indexOf('?') + 1);

    GetIncommingDomesticFlights(queryString);
}

$(function () {
    if (typeof (window.getQuerystring) == "function") {
        $('#sorting').val(getQuerystring('sort'));
    }
});

function updateQueryStringParameter(a, k, v) {
    var re = new RegExp("([?|&])" + k + "=.*?(&|$)", "i"),
    separator = a.indexOf('?') !== -1 ? "&" : "?";

    if (a.match(re)) return a.replace(re, '$1' + k + "=" + v + '$2');
    else return a + separator + k + "=" + v;
}

function ShowLoadingPopup() {
    $(window).bind('beforeunload', function () {
        $('html').css("overflow", "hidden");
        setTimeout(function () {
            initLoader();
        }, 500);
    });
}

function GetCookie(c_name) {
    var i, x, y, ARRcookies = document.cookie.split(";");
    for (i = 0; i < ARRcookies.length; i++) {
        x = ARRcookies[i].substr(0, ARRcookies[i].indexOf("="));
        y = ARRcookies[i].substr(ARRcookies[i].indexOf("=") + 1);
        x = x.replace(/^\s+|\s+$/g, "");
        if (x == c_name) {
            return unescape(y);
        }
    }
    return "";
}


function searchRedirect(url, from_to_Serialize, isCharterDealSearch) {   
    //a logic for Deals charter search Sivovator
    if (!isCharterDealSearch) {
        isCharterDealSearch = "false";
    }

    if (isCharterDealSearch == "true") //is charter deals search
    {
        $(".dealsSubmitBtnJS").val("");

        $(".dealsSubmitLoader").show();
        var newUrlChart = url + "/deals/searchresults/?page=1&" + $('#' + from_to_Serialize).formSerialize();
        newUrlChart = AddGoogleIdAndEshetToursId(newUrlChart);
        window.location.href = newUrlChart;
        return;
    }
    else {
        var newUrl = "";

        //$('#myIframe').attr('src', _loadingImgUrl);
        initLoader();
        var width = 0;
        setInterval(function () {
            if (width < 215) {
                width++;
                $('#divProgress').width(width + 'px');
            }
            else {
                width = 0;
            }
        }, 110);
        if (from_to_Serialize == "form_wizard_Cruise") {
            try{
            var paramsForLS = { setDate: new Date(), geoArea: $('#geographicAreaCruise').val(), CountryCode: $('#destinationCruise').val(), searchPeriod: $('#ddlSearchPeriodCruise').find(":selected").attr("rel") };
            localStorage.setItem("Cruise", JSON.stringify(paramsForLS));
            } catch (e) { }
        }

        if (from_to_Serialize == "form_wizard_flight") {
            newUrl = url + "/flights/searchresults/?page=1&" + $('#' + from_to_Serialize).formSerialize();
            newUrl = AddGoogleIdAndEshetToursId(newUrl);
            window.location.href = newUrl;
            return;
        }               
             
        window.location.href = url + "/?page=1&" + $('#' + from_to_Serialize).formSerialize();

        if (from_to_Serialize == "form_wizard_Ski") {
            newUrl = url + "/deals/searchresults/?page=1&" + $('#' + from_to_Serialize).formSerialize();
            newUrl = AddGoogleIdAndEshetToursId(newUrl);
            window.location.href = newUrl;

            return;
        }

        if (from_to_Serialize == "form_wizard_deals") {
            if (wizard_mode == 2) {
                newUrl = url + "/flydrivedeals/searchresults/?page=1&" + $('#' + from_to_Serialize).formSerialize();
                newUrl = AddGoogleIdAndEshetToursId(newUrl);
                window.location.href = newUrl;
                return;
            }
            else {
                newUrl = url + "/deals/searchresults/?page=1&" + $('#' + from_to_Serialize).formSerialize();
                newUrl = AddGoogleIdAndEshetToursId(newUrl);
                window.location.href = newUrl;
                return;
            }
        }

        //Organized - Will be executed only as a fall back
        if (from_to_Serialize == "form_wizard_Organized") {
            var eshetMvcOrganizedSearchUrl = '/Organized/SearchResults?ContinentName=&ContinentCode=&CountryName=&CountryCode=&MonthAndYearHe=&MonthAndYear=&Candidate.CandidatesLst%5B0%5D.Type=Adult&Candidate.CandidatesLst%5B0%5D.Count=2&Candidate.CandidatesLst%5B1%5D.Type=Child&Candidate.CandidatesLst%5B1%5D.Count=0&Candidate.CandidatesLst%5B2%5D.Type=Infant&Candidate.CandidatesLst%5B2%5D.Count=0'
            newUrl = url + eshetMvcOrganizedSearchUrl
            newUrl = AddGoogleIdAndEshetToursId(newUrl);
            window.location.href = newUrl;
            return;
        }

       window.location.href = url + "/?page=1&" + $('#' + from_to_Serialize).formSerialize();

    }
}

function setText(action) {
    switch (action) {
        case "cars":
            var x = $('#divBGTextnoActive');

            var shortName = $('.searchStartDestination').attr('shortName');
            var matchTo = $('#ddlCarFor').val();
            if (typeof (shortName) == "undefined") {
                shortName = $('#txtCity').attr('shortName');
            }

            if (typeof (matchTo) == "undefined") {
                matchTo = getPeopleGroups();
            }
            else {
                matchTo += '&nbsp;אנשים';
            }

            $(x).html($(x).html() + shortName);
            $(x).html($(x).html() + "<span style='display:block;color:#fff;font: bold 14px/1 Arial;'>לתאריכים&nbsp;" + $('#from').val() + "&nbsp;-&nbsp;" + $('#to').val() + '</span>');
            $(x).html($(x).html() + "<span style='display:block;color:#fff;font: bold 14px/1 Arial;'>" + "מתאים ל&nbsp;" + matchTo + '</span>');
            $(x).html($(x).html() + "<span style='display:block;color:#fff;font: bold 14px/1 Arial;'>אנא המתן...</span>");
            $('.AnimatedContainerBG p').html($(x).html());
            break;
        case "flight":
            if ($('.spnInternal').length > 0) { // internal flights
                var x = $('#divBGTextnoActive');
                var shortName = $('.searchStartDestination').attr('shortName');
                if (typeof (shortName) == "undefined") {
                    shortName = $('.txtorigin option:selected').attr('shortName') + '&nbsp;' + $('.txtdestination option:selected').attr('shortName');
                }
                $(x).html($(x).html() + shortName);
                $(x).html($(x).html() + "<span style='display:block;color:#fff;font: bold 14px/1 Arial;'>לתאריכים&nbsp;" + $('#from').val() + "&nbsp;-&nbsp;" + $('#to').val() + '</span>');
                $(x).html($(x).html() + "<span style='display:block;color:#fff;font: bold 14px/1 Arial;'>" + "מתאים ל&nbsp;" + "להרכב&nbsp;" + getPeopleGroups() + '</span>');
                $(x).html($(x).html() + "<span style='display:block;color:#fff;font: bold 14px/1 Arial;'>אנא המתן...</span>");
                $('.AnimatedContainerBG p').html($(x).html());
            }
            else {
                if ($('#ManyWays').is(':checked')) { // many ways flights,requires another validation
                    var x = $('#divBGTextnoActive');
                    var shortName = $('.searchStartDestination').attr('shortName');
                    if (typeof (shortName) == "undefined") {
                        shortName = $('#txtfrom1').attr('shortName') + '&nbsp;' + $('#txtto1').attr('shortName');
                    }
                    $(x).html($(x).html() + shortName);
                    $(x).html($(x).html() + "<span style='display:block;color:#fff;font: bold 14px/1 Arial;'>לתאריכים&nbsp;" + $('#from').val() + "&nbsp;-&nbsp;" + $('#to').val() + '</span>');
                    $(x).html($(x).html() + "<span style='display:block;color:#fff;font: bold 14px/1 Arial;'>" + "להרכב&nbsp;" + getPeopleGroups() + '</span>');
                    $(x).html($(x).html() + "<span style='display:block;color:#fff;font: bold 14px/1 Arial;'>אנא המתן...</span>");
                    $('.AnimatedContainerBG p').html($(x).html());
                }
                else {
                    var x = $('#divBGTextnoActive');
                    var shortName = $('.searchStartDestination').attr('shortName');
                    if (typeof (shortName) == "undefined") {
                        shortName = $('.txtorigin').attr('shortName') + '&nbsp;' + $('.txtdestination').attr('shortName');
                    }
                    $(x).html($(x).html() + shortName);
                    $(x).html($(x).html() + "<span style='display:block;color:#fff;font: bold 14px/1 Arial;'>לתאריכים&nbsp;" + $('#from').val() + "&nbsp;-&nbsp;" + $('#to').val() + '</span>');
                    $(x).html($(x).html() + "<span style='display:block;color:#fff;font: bold 14px/1 Arial;'>" + "להרכב&nbsp;" + getPeopleGroups() + '</span>');
                    $(x).html($(x).html() + "<span style='display:block;color:#fff;font: bold 14px/1 Arial;'>אנא המתן...</span>");
                    $('.AnimatedContainerBG p').html($(x).html());
                }
            }
            break;
        case "domesticpackages":
            if ($('#txtCity').length == 0) { // internal packages
                var x = $('#divBGTextnoActive');
                var shortName = $('.searchStartDestination').attr('shortName');
                if (typeof (shortName) == "undefined") {
                    shortName = $('.txtdestination option:selected').attr('shortName');
                }
                $(x).html($(x).html() + shortName);
                $(x).html($(x).html() + "<span style='display:block;color:#fff;font: bold 14px/1 Arial;'>לתאריכים&nbsp;" + $('#from').val() + "&nbsp;-&nbsp;" + $('#to').val() + '</span>');
                $(x).html($(x).html() + "<span style='display:block;color:#fff;font: bold 14px/1 Arial;'>" + "להרכב&nbsp;" + getPeopleGroups() + '</span>');
                $(x).html($(x).html() + "<span style='display:block;color:#fff;font: bold 14px/1 Arial;'>אנא המתן...</span>");
                $('.AnimatedContainerBG p').html($(x).html());
            }
            else {
                var x = $('#divBGTextnoActive');
                var shortName = $('.searchStartDestination').attr('shortName');
                if (typeof (shortName) == "undefined") {
                    shortName = $('#txtCity').attr('shortName');
                }
                $(x).html($(x).html() + shortName);
                $(x).html($(x).html() + "<span style='display:block;color:#fff;font: bold 14px/1 Arial;'>לתאריכים&nbsp;" + $('#from').val() + "&nbsp;-&nbsp;" + $('#to').val() + '</span>');
                $(x).html($(x).html() + "<span style='display:block;color:#fff;font: bold 14px/1 Arial;'>" + "להרכב&nbsp;" + getPeopleGroups() + '</span>');
                $(x).html($(x).html() + "<span style='display:block;color:#fff;font: bold 14px/1 Arial;'>אנא המתן...</span>");
                $('.AnimatedContainerBG p').html($(x).html());
            }
            break;
        case "domestichotels":            
            var x = $('#divBGTextnoActive');
            var shortName = $('.searchStartDestination').attr('shortName');
            if (typeof (shortName) == "undefined") {
                shortName = $('#ddlDestinationDomesticHotel option:selected').text();
            }
            $(x).html($(x).html() + shortName);
            $(x).html($(x).html() + "<span style='display:block;color:#fff;font: bold 14px/1 Arial;'>לתאריכים&nbsp;" + $('#fromDomesticHotel').val() + "&nbsp;-&nbsp;" + $('#toDomesticHotel').val() + '</span>');
            $(x).html($(x).html() + "<span style='display:block;color:#fff;font: bold 14px/1 Arial;'>" + "להרכב&nbsp;" + getPeopleGroups() + '</span>');
            $(x).html($(x).html() + "<span style='display:block;color:#fff;font: bold 14px/1 Arial;'>אנא המתן...</span>");
            $('.AnimatedContainerBG p').html($(x).html());
            break;
        case "hotel":
            var x = $('#divBGTextnoActive');
            var shortName = $('.searchStartDestination').attr('shortName');
            if (typeof (shortName) == "undefined") {
                shortName = $('#txtCity').attr('shortName');
            }
            $(x).html($(x).html() + shortName);
            $(x).html($(x).html() + "<span style='display:block;color:#fff;font: bold 14px/1 Arial;'>לתאריכים&nbsp;" + $('#from').val() + "&nbsp;-&nbsp;" + $('#to').val() + '</span>');
            $(x).html($(x).html() + "<span style='display:block;color:#fff;font: bold 14px/1 Arial;'>" + "להרכב&nbsp;" + getPeopleGroups() + '</span>');
            $(x).html($(x).html() + "<span style='display:block;color:#fff;font: bold 14px/1 Arial;'>אנא המתן...</span>");
            $('.AnimatedContainerBG p').html($(x).html());
            break;
        case "organizedtour":
            var x = $('#divBGTextnoActive');
            var shortName = $('.searchStartDestination').attr('shortName');
            if (typeof (shortName) == "undefined") {
                shortName = $('#geographicArea option:selected').text();
            }
            $(x).html($(x).html() + shortName);
            $(x).html($(x).html() + "<span style='display:block;color:#fff;font: bold 14px/1 Arial;'>לתאריכים&nbsp;" + $('#from').val() + "&nbsp;-&nbsp;" + $('#to').val() + '</span>');
            $(x).html($(x).html() + "<span style='display:block;color:#fff;font: bold 14px/1 Arial;'>" + "להרכב&nbsp;" + getPeopleGroups() + '</span>');
            $(x).html($(x).html() + "<span style='display:block;color:#fff;font: bold 14px/1 Arial;'>אנא המתן...</span>");
            $('.AnimatedContainerBG p').html($(x).html());
            break;
        case "guide":
            var x = $('#divBGTextnoActive');
            $(x).html($(x).html() + $('.guideTitle h1').html());
            $(x).html($(x).html().replace("{0}", getProduct($('#hiddenProduct').attr('rel'))));
            if ($('#from').val() != "" && $('#to').val() != "") {
                $(x).html($(x).html() + "<span style='display:block;color:#fff;font: bold 14px/1 Arial;'>לתאריכים&nbsp;" + $('#from').val() + "&nbsp;-&nbsp;" + $('#to').val() + "</span>");
            }
            else {
                $(x).html($(x).html() + "<span style='display:block;'>&nbsp;</span>");
            }
            $(x).html($(x).html() + "<span style='display:block;color:#fff;font: bold 14px/1 Arial;'>להרכב&nbsp;" + getPeopleGroups() + '</span>');
            $(x).html($(x).html() + "<span style='display:block;color:#fff;font: bold 14px/1 Arial;'>אנא המתן...</span>");
            $('.AnimatedContainerBG p').html($(x).html());
            break;
        case "cruise":
            var x = $('#divBGTextnoActive');
            var msg = "";

            if ($('#destination').val() == "-1") {
                msg = $('#geographicArea option:selected').text();
            }
            else {
                msg = $('#destination option:selected').text();
            }

            if (typeof (msg) == "undefined") {
                msg = $('.searchStartDestination').attr('shortName');
            }

            $(x).html($(x).html() + msg);
            $(x).html($(x).html() + "<span style='display:block;color:#fff;font: bold 14px/1 Arial;'>לתאריכים&nbsp;" + $('#from').val() + "&nbsp;-&nbsp;" + $('#to').val() + '</span>');
            $(x).html($(x).html() + "<span style='display:block;color:#fff;font: bold 14px/1 Arial;'>" + "להרכב&nbsp;" + getPeopleGroups() + '</span>');
            $(x).html($(x).html() + "<span style='display:block;color:#fff;font: bold 14px/1 Arial;'>אנא המתן...</span>");
            $('.AnimatedContainerBG p').html($(x).html());
            break;
        case "flydrivedeals":
            var x = $('#divBGTextnoActive');
            var shortName = $('.searchStartDestination').attr('shortName');
            if (typeof (shortName) == "undefined") {
                /*shortName = $('#txtCity').attr('shortName');*/
                shortName = $('#ddlDestinations option:selected').html();
            }
            $(x).html($(x).html() + shortName);
            $(x).html($(x).html() + "<span style='display:block;color:#fff;font: bold 14px/1 Arial;'>לתאריכים&nbsp;" + $('#from').val() + "&nbsp;-&nbsp;" + $('#to').val() + '</span>');
            $(x).html($(x).html() + "<span style='display:block;color:#fff;font: bold 14px/1 Arial;'>" + "להרכב&nbsp;" + getPeopleGroups() + '</span>');
            $(x).html($(x).html() + "<span style='display:block;color:#fff;font: bold 14px/1 Arial;'>אנא המתן...</span>");
            $('.AnimatedContainerBG p').html($(x).html());
            break;
        default:
            break;
    }
    $('#divBGTextnoActive').html($('#divBGTextnoActive2').html());
}
function getPeopleGroups() {
    var value = 0;
    var obj = new Object();

    $('.adultsearch').each(function () { value += parseInt($(this).val()); });
    var text = value + '&nbsp;מבוגרים';
    obj.children = 0;
    $('.childsearch').each(function () { obj.children += parseInt($(this).val()); });
    if (obj.children > 0) {
        text += '&nbsp;ו&nbsp;' + obj.children + '&nbsp;ילדים';
    }
    obj.infant = 0;
    $('.infantsearch').each(function () { obj.infant += parseInt($(this).val()); })
    if (obj.infant > 0) {
        text += '&nbsp;ו&nbsp;' + obj.infant + '&nbsp;תינוקות';
    }
    obj.young = 0;
    $('.youngsearch').each(function () { obj.young += parseInt($(this).val()); })
    if (obj.young > 0) {
        text += '&nbsp;ו&nbsp;' + obj.young + '&nbsp;צעירים';
    }
    obj.old = 0;
    $('.oldsearch').each(function () { obj.old += parseInt($(this).val()); })
    if (obj.old > 0) {
        text += '&nbsp;ו&nbsp;' + obj.old + '&nbsp;גיל הזהב';
    }

    return text;
}
function initLoader() {
    setText($('#hiddenProduct').val());
    //LoadingPopup();
    initSearchLoader();
}




// Add or remove all names from inputs that belong to the Multi Destinations checkbox
function AddRemoveSearchWizardMultiDestinationsInputs(bVisible) {

    if (!bVisible) {
        AddRemoveSearchWizardInput('to1', 'to1', false)
        AddRemoveSearchWizardInput('to2', 'to2', false)
        AddRemoveSearchWizardInput('to3', 'to3', false)
        AddRemoveSearchWizardInput('from1', 'from1', false)
        AddRemoveSearchWizardInput('from2', 'from2', false)
        AddRemoveSearchWizardInput('from3', 'from3', false)
    }
    else {
        AddRemoveSearchWizardInput('to1', 'to1', true)
        AddRemoveSearchWizardInput('to2', 'to2', true)
        AddRemoveSearchWizardInput('to3', 'to3', true)
        AddRemoveSearchWizardInput('from1', 'from1', true)
        AddRemoveSearchWizardInput('from2', 'from2', true)
        AddRemoveSearchWizardInput('from3', 'from3', true)
    }
}


// Add or remove the name of an input with id of inputId according to the bVisible flag
function AddRemoveSearchWizardInput(inputId, inputName, bVisible) {
    if (!bVisible) {
        $('#' + inputId).removeAttr("name");
    }
    else {
        $('#' + inputId).attr("name", inputName);
    }
}

function getObjects(obj, key, val) {
    var objects = [];
    for (var i in obj) {
        if (!obj.hasOwnProperty(i)) continue;
        if (typeof obj[i] == 'object') {
            objects = objects.concat(getObjects(obj[i], key, val));
        } else if (i == key && obj[key] == val) {
            objects.push(obj);
        }
    }
    return objects;
}

function getQuerystring(key, default_) {

    if (default_ == null) default_ = "";
    key = key.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
    var regex = new RegExp("[\\?&]" + key + "=([^&#]*)");
    var qs = regex.exec(window.location.href);
    if (qs == null)
        return default_;
    else
        return qs[1];
}

function setDestinationAutoComplete() {
    $('.searchWizardDestinationAutoComplete').each(function (index) {
        var currentDestinationCode = $('#' + this.id.replace('txt', '')).val();
        var country = '';
        var currentDestinationField = this.id;

        if ($(this).attr('rel') != null && $(this).attr('rel').length > 0) {
            country = $(this).attr('rel');
        }

        if (currentDestinationCode != '') {
            var productTypeForHandler = $("#hdn_wizard").val();
            $.ajax({
                url: "/Handlers/UmbracoDestination.ashx",
                dataType: "json",
                //data: { typedKeys: currentDestinationCode, code: country, productType: productTypeForHandler },
                data: { value: currentDestinationCode, code: country, onlyabroad: true, productType: productTypeForHandler },
                success: function (data) {
            
                    if (data != null && data.rows != null && data.rows.length > 0) {
                        if (data.rows[0]["destinationCode"] == currentDestinationCode && index == 0) {
                            if ($('#txtfrom1').length > 0) { /*flight external*/
                                $('#txtfrom1').val(data.rows[0]["destinationName"]);
                                $('#txtfrom1').attr('shortName', data.rows[0]["shortName"]);
                            }
                            if ($('#txtto3').length > 0) { /*flight external*/
                                $('#txtto3').val(data.rows[0]["destinationName"]);
                                $('#txtto3').attr('shortName', data.rows[0]["shortName"]);
                            }
                        }
                        $('#' + currentDestinationField).val(data.rows[0]["destinationName"]);
                        $('#' + currentDestinationField).attr('code', data.rows[0]["destinationCode"]);
                        $('#' + currentDestinationField).attr('shortName', data.rows[0]["shortName"]);
                    }
                    else if(data != null && data.length > 0 ) 
                    {
                        $('#' + currentDestinationField).val(data[0]["shortName"]);
                        $('#' + currentDestinationField).attr('code', data[0]["destinationCode"]);
                        $('#' + currentDestinationField).attr('shortName', data[0]["shortName"]);
                    }
                }
            });
        }
    });

}

function setDestinationAutoCompletePerTextBox(textBoxId) {
    var currentDestinationCode = $('#' + textBoxId).val();
    var country = '';
    var currentDestinationField = textBoxId;

    if ($(this).attr('rel') != null && $(this).attr('rel').length > 0) {
        country = $(this).attr('rel');
    }

    if (currentDestinationCode != '') {
        var productTypeForHandler = $("#hdn_wizard").val();
        $.ajax({
            url: "/Handlers/Destinations.ashx",
            dataType: "json",
            data: { typedKeys: currentDestinationCode, code: country, productType: productTypeForHandler },
            success: function (data) {
                if (data != null && data.rows.length > 0) {

                    if ($('#' + textBoxId).length > 0) { /*flight external*/
                        $('#' + textBoxId).val(data.rows[0]["destinationName"]);
                        $('#' + textBoxId).attr('shortName', data.rows[0]["shortName"]);
                    }
                    $('#' + currentDestinationField).val(data.rows[0]["destinationName"]);
                    $('#' + currentDestinationField).attr('code', data.rows[0]["destinationCode"]);
                    $('#' + currentDestinationField).attr('shortName', data.rows[0]["shortName"]);
                }
            }
        });
    }
}




























function onlyNumbers(evt) {
    var e = event || evt; // for trans-browser compatibility
    var charCode = e.which || e.keyCode;

    if (charCode > 31 && (charCode < 48 || charCode > 57))
        return false;

    return true;

}

$(function () {
    $('.searchPeriodCruise').bind('change', function () {
        $('#hiddenSearchPeriod').val($(this).val());
        if ($.trim($(this).attr('rel')) != "") {
            setCalanderDatesCruise($(this).attr('rel'));
        }
    });

    $('#ddlSearchPeriodCruise').bind('change', function () {
        $('#hiddenSearchPeriod').val($(this).val());
        var rel = $(this).children('option:selected').attr('rel');
        if (rel != "") {
            setCalanderDatesCruise(rel);
        }
    });

    $('.doSelected, .dateRangeFrom input[type="text"], .dateRangeTo input[type="text"]').bind('click', function (e) {
        $(this).select();
    });
});

function setCalanderDatesCruise(dates) {
    var arr = [];
    arr = dates.split('_');
    var dateFrom = tm(arr[0]);
    var dateTo = tm(arr[1]);

    //unused code
    // $('#fromCruise').datepicker('setDate', new Date(dateFrom));
    // $('#toCruise').datepicker('setDate', new Date(dateTo));

    //start lior added
    //take care that date format will be like "dd/MM/yyyy" 
    //add '0' if the number (day/month) < 10 
    var sDay = dateFrom.getDate();
    sDay = sDay < 10 ? "0" + sDay : sDay;

    var eDay = dateTo.getDate();
    eDay = eDay < 10 ? "0" + eDay : eDay;

    var sMonth = dateFrom.getMonth() + 1;
    sMonth = sMonth < 10 ? "0" + sMonth : sMonth;

    var eMonth = dateTo.getMonth() + 1;
    eMonth = eMonth < 10 ? "0" + eMonth : eMonth;

    $('#fromCruise').attr("value", sDay + "/" + sMonth + "/" + dateFrom.getFullYear());
    $('#toCruise').attr("value", eDay + "/" + eMonth + "/" + dateTo.getFullYear());

    //end lior edded

    //calculation of the new night
    //dateFrom = new Date($('#fromCruise').datepicker('getDate').getFullYear(), $('#fromCruise').datepicker('getDate').getMonth(), $('#fromCruise').datepicker('getDate').getDate());
    //dateTo = new Date($('#toCruise').datepicker('getDate').getFullYear(), $('#toCruise').datepicker('getDate').getMonth(), $('#toCruise').datepicker('getDate').getDate());
    //dateFrom = $('#fromCruise').datepicker('getDate');
    //dateTo = $('#toCruise').datepicker('getDate');



    var difference_ms = Math.abs(dateFrom.getTime() - dateTo.getTime());
    var ONE_DAY = 1000 * 60 * 60 * 24;
    $('#txtNightsNum').val(Math.floor(difference_ms / ONE_DAY));
}

$(function () {
    $('.searchPeriodOrganized').bind('change', function () {
        $('#hiddenSearchPeriod').val($(this).val());
        if ($.trim($(this).attr('rel')) != "") {
            setCalanderDatesOrganized($(this).attr('rel'));
        }
    });

    $('#ddlSearchPeriodOrganized').bind('change', function () {
        $('#hiddenSearchPeriod').val($(this).val());
        var rel = $(this).children('option:selected').attr('rel');
        if (rel != "") {
            setCalanderDatesOrganized(rel);
        }
    });

    $('.doSelected, .dateRangeFrom input[type="text"], .dateRangeTo input[type="text"]').bind('click', function (e) {
        $(this).select();
    });
});

function setCalanderDatesOrganized(dates) {

    var arr = [];
    arr = dates.split('_');
    var dateFrom = tm(arr[0]);
    var dateTo = tm(arr[1]);

    //  $('#fromOrganized').datepicker('setDate', new Date(dateFrom));
    //  $('#toOrganized').datepicker('setDate', new Date(dateTo));

    // these two lines should fill the date "sDate" and eDate", but it will be done in server instead.
    // $('#fromOrganized').val(new Date(dateFrom));
    //  $('#toOrganized').val(new Date(dateTo));
    //calculation of the new night
    dateFrom = new Date($('#fromOrganized').datepicker('getDate').getFullYear(), $('#fromOrganized').datepicker('getDate').getMonth(), $('#fromOrganized').datepicker('getDate').getDate());
    dateTo = new Date($('#toOrganized').datepicker('getDate').getFullYear(), $('#toOrganized').datepicker('getDate').getMonth(), $('#toOrganized').datepicker('getDate').getDate());
    dateFrom = $('#fromOrganized').datepicker('getDate');
    dateTo = $('#toOrganized').datepicker('getDate');
    var difference_ms = Math.abs(dateFrom.getTime() - dateTo.getTime());
    var ONE_DAY = 1000 * 60 * 60 * 24;
    $('#txtNightsNum').val(Math.floor(difference_ms / ONE_DAY));
}

function tm(unix_tm) {
    var dt = new Date(unix_tm * 1000);
    return dt;
}

function RedirectAfterBasket(url) {
    if (url != '') {
        document.location.href = url;
    }
}

function getProduct(product) {
    var text = "";
    switch (product) {
        case "cars":
            text = 'רכב';
            break;
        case "domesticpackages":
            text = 'חבילות בארץ';
            break;
        case "domestichotels":
            text = 'מלונות בארץ';
            break;
        case "hotel":
            text = 'מלונות בחו&quot;ל';
            break;
        case "flight":
            text = 'טיסות';
            break;
        case "organized":
            text = 'טיול מאורגן';
            break;
    }

    return text;
}

// parse a date in yyyy-mm-dd format
function parseDate(input) {
    var parts = input.split('/');
    // new Date(year, month [, day [, hours[, minutes[, seconds[, ms]]]]])
    return new Date(parts[2], parts[1] - 1, parts[0]); // Note: months are 0-based
}


function __highlight(s, t) {
    var matcher = new RegExp("(" + $.ui.autocomplete.escapeRegex(t) + ")", "ig");
    if (matcher != undefined) {
        return s.replace(matcher, "<strong>$1</strong>");
    } else {
        return s;
    }
}
/* version number */
//-------------------
/* end version number */
function validateAlphaNumeric(obj) {
    obj.val(obj.val().replace(/[^א-תa-zA-Z 0-9']+/g, ''));
}

function validateAlpha(obj) {
    obj.val(obj.val().replace(/[^א-תa-zA-Z ']+/g, ''));
}

function validateNumeric(obj) {
    obj.val(obj.val().replace(/[^0-9']+/g, ''));
}

function validateDates(obj) {
    obj.val(obj.val().replace(/[^0-9/']+/g, ''));
}

function isEmpty(obj) {
    if ($.trim($(obj).val()) == '' || typeof ($(obj).val()) == "undefined" || $(obj).val() == null || $(obj).val() == obj.attr('placeholder')) {
        return false;
    }
    return true;
}

function validatePassword(obj) {
    obj.val(obj.val().replace(/[^a-zA-Z0-9']+/g, ''));
}

function checkDate(dateStr) {
        s = dateStr.split('/');
                    //year       //month        //day
        d = new Date(+s[2], s[1] - 1, +s[0]);
        if (Object.prototype.toString.call(d) === "[object Date]") {
            if (!isNaN(d.getTime()) && d.getDate() == s[0] &&d.getMonth() == (s[1] - 1) && s[2].length == 4) {
                return true;
            }
        }
        return false;
    }


function dropDownListValid(obj) {
    if ($(obj).val() == "-1") {
        return false;
    }
    return true;
}

function callToFunction(type, obj) {
    var flag = false;
    switch (type) {
        case "dropdownlist":
            flag = dropDownListValid(obj);

            if($(obj).parents('.searchWizard').attr('id') == "divDomesticHotelPassengerBox") { // domestic hotels
                flag = checkAges();
            }

            if($(obj).parents('.searchWizard').attr('id') == "divDomesticFlightPassengerBox") { // domestic flights
                flag = VaildDomesticFlightBaby();
            }

            if($(obj).parents('.searchWizard').attr('id') == "divFlightPassengerBox") { // flights
                flag = VaildFlightBaby();
            }

            if($(obj).parents('.searchWizard').attr('id') == "divDomesticPackagePassengerBox") { // domestic packages
                flag = VaildPackageBaby();
            }

            if($(obj).parents('.searchWizard').attr('id') == "divAbroadFlightPassengerBox") { // abroad packages
                flag = VaildPackageBaby();
            }
            
            if($(obj).parents('.searchWizard').attr('id') == "divOrganizedPassengerBox") { // organized
                flag = VaildPackageBaby();
            }
                
            break;

        case "textbox":
            flag = isEmpty(obj);
            break;
        case "hidden_autocomplete":
            flag = isEmpty(obj);
            break;

    }
    return flag;
}

function CheckValidationAutoComplete(hdn_id,txt_id)
{
    if ($('#' + hdn_id).val() == '' && $('#' + txt_id).val() != '') {
        $('#' + txt_id).autocomplete("search");
    }
}

function VaildPackageBaby(){
    if( parseInt($('#ddlAdultNumRoom1').val()) < parseInt($('#ddlBabyNumRoom1').val()) ) 
    {
        return false;
    }

    if( parseInt($('#ddlAdultNumRoom2').val()) < parseInt($('#ddlBabyNumRoom2').val()) ) 
    {
        return false;
    }

    if( parseInt($('#ddlAdultNumRoom3').val()) < parseInt($('#ddlBabyNumRoom3').val()) ) 
    {
        return false;
    }
    return true;
}

function VaildDomesticFlightBaby(){
    if( parseInt($('#adult').val()) <  parseInt($('#baby').val()))
    {
        return false;
    }
    return true;
}

function VaildFlightBaby(){
    if( parseInt($('#adult').val()) + parseInt($('#young').val()) + parseInt($('#old').val()) <  parseInt($('#baby').val())) 
    {
        return false;
    }
    return true;
}

function checkAges(){
    if($('#ddlAdultNumRoom1').val() == 0 && $('#ddlChildNumRoom1').val() == 0) 
    {
        return false;
    }
    return true;
}

function compareDatesManyWays()//flight external validation
{
    var flag = false;
    var firstDate = null;
    var secondDate = null;
    var thirdDate = null;
    if($('#firstDate').datepicker('getDate') == null && $('#secondDate').datepicker('getDate') == null && $('#thirdDate').datepicker('getDate') == null){
         
    }
}

function validateCheckBox(src, args) {
    args.IsValid = $('.checkedCheckBox').is(':checked');
}

function isDate(txtDate, separator) {
    var aoDate,           // needed for creating array and object
        ms,               // date in milliseconds
        month, day, year; // (integer) month, day and year
    // if separator is not defined then set '/'
    if (separator === undefined) {
        separator = '/';
    }
    // split input date to month, day and year
    aoDate = txtDate.split(separator);
    // array length should be exactly 3 (no more no less)
    if (aoDate.length !== 3) {
        return false;
    }
    // define month, day and year from array (expected format is m/d/yyyy)
    // subtraction will cast variables to integer implicitly
    month = aoDate[1] - 1; // because months in JS start from 0
    day = aoDate[0] - 0;
    year = aoDate[2] - 0;
    // test year range
    if (year < 1000 || year > 3000) {
        return false;
    }
    // convert input date to milliseconds
    ms = (new Date(year, month, day)).getTime();
    // initialize Date() object from milliseconds (reuse aoDate variable)
    aoDate = new Date();
    aoDate.setTime(ms);
    // compare input date and parts from Date() object
    // if difference exists then input date is not valid
    if (aoDate.getFullYear() !== year ||
        aoDate.getMonth() !== month ||
        aoDate.getDate() !== day) {
        return false;
    }
    // date is OK, return true
    return true;
}

function validDateRange(today,theDate)
{  
    if(theDate >= today){
    console.log('ok');
        return true;
    }
    console.log('false');
    return false;
}
/// <reference path="DomesticResulat.js" />
/* version number */
//-------------------
/* end version number */
var filter_itemsInPage;
var isSliderChanged = false;

$(function () {
    $('.DoFilter').live('change', function () {
        //mark text If Check Box Is Checked
        if ($(this).is(':checked')) {
            ClearHotel();
            $(this).next().addClass("color_checked");
        }
        else {
            $(this).next().removeClass("color_checked");

        }
        DoFilter(undefined, true);

        //display again the result header box(not the new search box) 
        var headerEl = $('.position_header');
        if (headerEl.css("display") == "none") {
            headerEl.css("display", "block")
        }
    });

    $("#ddl_sort").change(function () {
        $('input[name="sort"]').val($(this).val());
        DoFilter();
    });
});

var minPriceDis_old;
var maxPriceDis_old;
function setSlider(maxAmount, minAmount, currency) {
    minPriceDis_old = minAmount;
    maxPriceDis_old = maxAmount;

    $("#slider-sorting").slider();
    $("#slider-sorting").slider({
        range: true,
        min: parseInt(minAmount),
        max: parseInt(maxAmount),
        step: 20,
        values: [parseInt(minAmount), parseInt(maxAmount)],
        slide: function (event, ui) {
            $("#sortingAmount").val(currency + ui.values[0] + " - " + currency + ui.values[1]);

            $("#minPriceDis").text(ui.values[0]);
            $("#maxPriceDis").text(ui.values[1]);


        },
        change: function (event, ui) {
            
            if (minPriceDis_old != ui.values[0] || maxPriceDis_old != ui.values[1]) {
                minPriceDis_old = ui.values[0];
                maxPriceDis_old = ui.values[1];

                //update input
                $("#minPrice").val(ui.values[0]);
                $("#maxPrice").val(ui.values[1]);

                DoFilter(true, true);
            }

        }
    });
    $("#sortingAmount").val(currency + $("#slider-sorting").slider("values", 0) + " - " + currency + $("#slider-sorting").slider("values", 1));
}

function setSliderAbroad(maxAmount, minAmount, currency) {

    $("#slider-sorting").slider();
    $("#slider-sorting").slider({
        range: true,
        min: parseInt(minAmount),
        max: parseInt(maxAmount),
        step: 20,
        values: [parseInt(minAmount), parseInt(maxAmount)],
        slide: function (event, ui) {
            $(".domestic_filter_to_price").html(ui.values[1]);
            $(".domestic_filter_from_price").html(ui.values[0]);
        },
        change: function (event, ui) {
            
            isSliderChanged = true;
            $("#minPrice").val(ui.values[0]);
            $("#maxPrice").val(ui.values[1]);
            DoFilter(true, true);
        }
    });

    $(".domestic_filter_currency_js").html(currency);
    $(".domestic_filter_to_price").html($("#slider-sorting").slider("values", 1));
    $(".domestic_filter_from_price").html($("#slider-sorting").slider("values", 0));
}
function setSliderHotelsAbroad(maxAmount, minAmount, currency) {
    
    $("#slider-sorting").slider();
    $("#slider-sorting").slider({
        range: true,
        min: parseInt(minAmount),
        max: parseInt(maxAmount),
        step: 20,
        values: [parseInt(minAmount), parseInt(maxAmount)],
        slide: function (event, ui) {
            $(".hotels_filter_to_price").html(ui.values[1]);
            $(".hotels_filter_from_price").html(ui.values[0]);
        },
        change: function (event, ui) {
            
            isSliderChanged = true;
            $("#minPrice").val(ui.values[0]);
            $("#maxPrice").val(ui.values[1]);
            DoFilter(true, true, 'hotels', 'Price');
        }
    });

    $(".hotels_filter_currency_js").html(currency);
    $(".hotels_filter_to_price").html($("#slider-sorting").slider("values", 1));
    $(".hotels_filter_from_price").html($("#slider-sorting").slider("values", 0));
}

function setSliderDomestic(maxAmount, minAmount, currency)
{
    $("#slider-sorting").slider();
    $("#slider-sorting").slider({
        range: true,
        min: parseInt(minAmount),
        max: parseInt(maxAmount),
        step: 20,
        values: [parseInt(minAmount), parseInt(maxAmount)],
        slide: function (event, ui) {
            $(".domestic_filter_to_price").html(ui.values[1]);
            $(".domestic_filter_from_price").html(ui.values[0]);
        },
        change: function (event, ui) {
            isSliderChanged = true;
            $("#minPrice").val(ui.values[0]);
            $("#maxPrice").val(ui.values[1]);
            DoFilter(true, true);
        }
    });

    $(".domestic_filter_currency_js").html(currency);
    $(".domestic_filter_to_price").html($("#slider-sorting").slider("values", 1));
    $(".domestic_filter_from_price").html($("#slider-sorting").slider("values", 0));
}

function setSliderDays(maxDays, minDays) {
    $("#slider-days").slider();
    $("#slider-days").slider({
        range: true,
        min: parseInt(minDays),
        max: parseInt(maxDays),
        step: 1,
        values: [parseInt(minDays), parseInt(maxDays)],
        slide: function (event, ui) {
            $(".filter_max_days_js").html(ui.values[1]);
            $(".filter_min_days_js").html(ui.values[0]);
        },
        change: function (event, ui) {
            isSliderChanged = true;
            $("#MaxDays").val(ui.values[1]);
            $("#MinDays").val(ui.values[0]);
            DoFilter(true, true);
        }
    });

    $(".filter_max_days_js").html($("#slider-days").slider("values", 1));
    $(".filter_min_days_js").html($("#slider-days").slider("values", 0));
}

function getResults(queryString, isShowFilterLoader) {
    //var dt1 = new Date();
    
    queryString += "&filterrequest=true";
    url = $("#HandlerForPagingUrl").val() + '&showresultpanel=1&';

    $.ajax({

        url: url + queryString,
        type: 'GET',
        beforeSend: function () {
            if (isShowFilterLoader) {
                $("html, body").animate({ scrollTop: "0" }, 1000);
                showFilterLoader();
            }
            else {
                initSmallLoader();
            }
        },
        success: function (result) {
            
            //$('html, body').animate({ scrollTop: 0 }, 'fast');
            if ($(result).find(".company_details_wrapper").length == 0 && result.indexOf("JS_FOR_FILTER_HOTEL_IN_CROSS_SELL") == 0) {
                $(".filter_no_results").show();
                $(".filter_no_results").find(".moreResults").show();
            }
            else {
                var numOfResults = $(result).find(".content-wrapper-hotel-control").length;
                $(".filter_no_results").hide();
                $("#domestic_hotel_num_of_res").html("נמצאו " + numOfResults + " תוצאות");
            }
            //check for domestic flight
            if (result.toLowerCase().indexOf("filterdomesticflightspliter") > 0) {
                var arr = result.split('filterdomesticflightspliter');
                $('#result_content_out_going_domestic_flight').html(arr[0]);
                $('#result_content_in_going_domestic_flight').html(arr[1]);
            }
            if (result.indexOf("JS_FOR_FILTER_HOTEL_IN_CROSS_SELL") > 0) {

                $('#JS_INJECTION_FOR_CROSS_SELL').html(result);

            }
            else {
                $('#result_content').html(result);
            }
            InitMainJs();

            if (isShowFilterLoader) {
                closeLoaderFilter();
            }
            else {
                CloseSmallLoader();
            }

            if (typeof (DoWorkAfterControlLoadsForSpecificProduct) != 'undefined') {
                DoWorkAfterControlLoadsForSpecificProduct();
            }
            if ($("#googleMapdDiv").length == 1) {
                initMap();
            }


        },
        error: function (result) {
            if (isShowFilterLoader) {
                closeLoaderFilter();
            }
            else {
                CloseSmallLoader();
            }
            $("#linkAdditionalSearchResults").hide();
        },
        complete: function () {

            if (isShowFilterLoader) {
                closeLoaderFilter();
            }
            else {
                CloseSmallLoader();
            }

            $('#' + PageResultsNumberid).val(filter_itemsInPage);
            if (parseInt($('#hidTotalItems').val()) > parseInt($('#' + PageResultsNumberid).val())) {
                $(".flightsMoreResults").show();
            }
            else {
                $(".flightsMoreResults").hide();
            }
        }
    });
}

function DoFilter(sliderChanged, isShowFilterLoader, productType, el) {
    $('.domestic_search_details').show();
    $('#main_wizard').hide();
    //$('#main_wizard').height('169px');
    if (productType == 'hotels') {
        //when the costumer clicks on filter - send it to google analytics
        var sortType = $(el).attr('name');
        //In case of select dropdown of hotel names
        if (sortType == 'hotel' || sortType == undefined) {
            if (sortType=='hotel') {
                sortType = 'name';
            }
            else {
                sortType = 'price';
            }
        }
        var analytic = 'hotels-search-results-filter-hotel-' + sortType;
        GTDataLayer.push({ 'event': analytic });
    }
    isShowFilterLoader = typeof (isShowFilterLoader) == "undefined" ? false : isShowFilterLoader;
    isSliderChanged = typeof (sliderChanged) == "undefined" ? false : sliderChanged;
    $("#linkAdditionalSearchResults").show();
    var url = window.location.href;
    if (url.indexOf('#') > -1) {
        url = url.substring(0, url.indexOf('#'));
    }
    filter_itemsInPage = parseInt($('#' + PageResultsNumberid).val());
    if (window.location.href.indexOf("details_") > 0) {
        url = url.replace(window.location.hash, "");
    }
    url = updateQueryStringParameter(url, PageResultsNumberid, filter_itemsInPage);

    var queryString = url.slice(window.location.href.indexOf('?') + 1) + "&" + $('#form_filter').formSerialize();
    getResults(queryString, isShowFilterLoader);
    var loc = location.pathname.split('/');
    $('#' + currentPageIndexid).val('1');
    //if (loc[1].length > 0 && (loc[1].toString().toLowerCase() == "hotels" || loc.toString().toLowerCase() == "deals")) {
    //    getProducts();
    //}
}

function SearchSwitch() {
    $("#filterSwitch").fadeOut();
    $("#searchSwitch").fadeIn();
    $('.tagCloud').fadeIn();
}

function filterSwitch() {
    $("#filterSwitch").fadeIn();
    $("#searchSwitch").fadeOut();
    $('.tagCloud').fadeOut();
}

function resetFilterForm() {
    var $form = $('#form_filter');
    $form.find('input:text, input:password, input:file,textarea').not('#sortingAmount').val('');
    $form.find('input:radio, input:checkbox').removeAttr('checked').removeAttr('selected');
    $form.find('select').each(function () {
        $(this).val($('option:eq(0)', this).val());
    });

    if (typeof ($('#ddlHotel').val()) != "undefined" && $('#ddlHotel').length > 0) {
        $('#ddlHotel option:selected').removeAttr('selected');
    }
}

function showFilterLoader() {
    var loaderHeight = $("#result_content").height();
    var loaderWidth = $("#result_content").width();

    if ($(".full-page-map").is(":visible")) {
        loaderHeight = $(".full-page-map").height() - 60;
        loaderWidth = $(".full-page-map").width() -40 ;
    }

    $(".filter_loader_wraper").height(loaderHeight);
    $(".filter_loader_wraper").width(loaderWidth);
    $(".filter_loader_wraper").show();
}

function closeLoaderFilter() {
    $(".filter_loader_wraper").hide();
}

function setFilterTemplate(hiddenName, templateName, tbodyName) {
    if ($('#' + hiddenName).val() != null) {
        $("#" + templateName).tmpl(JSON.parse($('#' + hiddenName).val())).appendTo("#" + tbodyName);
    }
}

function setDistanceSlider(sliderId) {
    var initialMinimum = $("#" + sliderId).data("min");
    var initialMaximum = $("#" + sliderId).data("max");
    $("#" + sliderId).slider({
        range: false,
        min: initialMinimum,
        max: initialMaximum,
        step: 2,
        value: initialMaximum,
        slide: function (event, ui) {
            //$("#" + sliderId).find("input").val(ui.value);
        },
        change: function (event, ui) {
            $("#distanceSelected").val(ui.value);
            $("#" + sliderId).closest(".filter_range").find("input.innerDistanceSelected").val(ui.value);
            $("#" + sliderId).closest(".filter_range").find(".chosen_val").html(ui.value);
            DoFilter(true, true);
        }
    });





    //var hours = "";
    //var sliderIdClean = toIdCase(sliderId.replace(/-/g, " ").replace(" range", "")).replace(/\s/g, "");
    //var datesForDiv;

    //if (dates != 15 && dates != undefined) {
    //    if (dates[0] != dates[1]) {
    //        var firstDate = dates[0].split('/');
    //        firstDate = firstDate[0] + "." + firstDate[1];
    //        var secondDate = dates[1].split('/');
    //        secondDate = secondDate[0] + "." + secondDate[1];
    //        datesForDiv = secondDate + "-" + firstDate;
    //    }
    //    else {
    //        var date = dates[0].split('/');
    //        date = date[0] + "." + date[1];
    //        datesForDiv = date;
    //    }
    //}

    //$("#" + sliderId).slider({
    //    range: true,
    //    min: initialMinimum,
    //    max: initialMaximum,
    //    step: steps,
    //    values: [initialMinimum, initialMaximum],
    //    create: function (e, ui) {
    //        if (sliderIdClean == "flightDuration" || sliderIdClean == "stopDuration") {
    //            hours = minutesToTime(initialMinimum, true);
    //            $(this).closest(".range_slider_js").find(".range_min_js .time-value").html(hours);
    //            hours = minutesToTime(initialMaximum, true);
    //            $(this).closest(".range_slider_js").find(".range_max_js .time-value").html(hours);
    //        }
    //        else {
    //            hours = minutesToTime(initialMinimum, false);
    //            $(this).closest(".range_slider_js").find(".range_min_js .time-value").html(hours);
    //            hours = minutesToTime(initialMaximum, false);
    //        }

    //        $(this).closest(".range_slider_js").find(".range_max_js .time-value").html(hours);
    //        $(this).parent().prev('.filter_subtitle').children('div').text(datesForDiv);

    //        $(this).append("<input type='hidden' class='initialMinimum' value='" + initialMinimum + "'/>");
    //        $(this).append("<input type='hidden' class='initialMaximum' value='" + initialMaximum + "'/>");

    //    },
    //    slide: function (e, ui) {
    //        updateSliderValues(sliderId, ui.values[0], ui.values[1]);

    //    },
    //    change: function (event, ui) {
    //        if ($('#' + sliderIdClean + 'Min').val() == initialMinimum && $('#' + sliderIdClean + 'Max').val() == initialMaximum) {
    //            $('#' + sliderIdClean + 'Min').val("");
    //            clearFilter(this);
    //        } else {
    //            setFilter(this);
    //        }

    //    }
    //});
}

/// <reference path="../../../lib/jquery-1.2.6.js" />
/*
Masked Input plugin for jQuery
Copyright (c) 2007-2009 Josh Bush (digitalbush.com)
Licensed under the MIT license (http://digitalbush.com/projects/masked-input-plugin/#license) 
Version: 1.2.2 (03/09/2009 22:39:06)
*/
// Modified by ramiro at conductiva.com to accept placeholder for the full mask
(function ($) { var w = ($.browser.msie ? 'paste' : 'input') + ".mask"; var x = (window.orientation != undefined); $.mask = { definitions: { '9': "[0-9]", 'a': "[A-Za-z]", '*': "[A-Za-z0-9]"} }; $.fn.extend({ caret: function (b, c) { if (this.length == 0) return; if (typeof b == 'number') { c = (typeof c == 'number') ? c : b; return this.each(function () { if (this.setSelectionRange) { this.focus(); this.setSelectionRange(b, c) } else if (this.createTextRange) { var a = this.createTextRange(); a.collapse(true); a.moveEnd('character', c); a.moveStart('character', b); a.select() } }) } else { if (this[0].setSelectionRange) { b = this[0].selectionStart; c = this[0].selectionEnd } else if (document.selection && document.selection.createRange) { var d = document.selection.createRange(); b = 0 - d.duplicate().moveStart('character', -100000); c = b + d.text.length } return { begin: b, end: c} } }, unmask: function () { return this.trigger("unmask") }, mask: function (m, n) { if (!m && this.length > 0) { var o = $(this[0]); var q = o.data("tests"); return $.map(o.data("buffer"), function (c, i) { return q[i] ? c : null }).join('') } n = $.extend({ placeholder: "_", completed: null }, n); var r = $.mask.definitions; var q = []; var s = m.length; var u = null; var v = m.length; $.each(m.split(""), function (i, c) { if (c == '?') { v--; s = i } else if (r[c]) { q.push(new RegExp(r[c])); if (u == null) u = q.length - 1 } else { q.push(null) } }); return this.each(function () { var f = $(this); var g = $.map(m.split(""), function (c, i) { if (c != '?') { return r[c] ? (n.placeholder.length > 1 ? n.placeholder.charAt(i) : n.placeholder) : c } }); var h = false; var l = f.val(); f.data("buffer", g).data("tests", q); function seekNext(a) { while (++a <= v && !q[a]); return a }; function shiftL(a) { while (!q[a] && --a >= 0); for (var i = a; i < v; i++) { if (q[i]) { g[i] = n.placeholder.length > 1 ? n.placeholder.charAt(i) : n.placeholder; var j = seekNext(i); if (j < v && q[i].test(g[j])) { g[i] = g[j] } else break } } writeBuffer(); f.caret(Math.max(u, a)) }; function shiftR(a) { for (var i = a; i < v; i++) { var c = n.placeholder.length > 1 ? n.placeholder.charAt(i) : n.placeholder; if (q[i]) { var j = seekNext(i); var t = g[i]; g[i] = c; if (j < v && q[j].test(t)) c = t; else break } } }; function keydownEvent(e) { var a = $(this).caret(); var k = e.keyCode; h = (k < 16 || (k > 16 && k < 32) || (k > 32 && k < 41)); if ((a.begin - a.end) != 0 && (!h || k == 8 || k == 46)) clearBuffer(a.begin, a.end); if (k == 8 || k == 46 || (x && k == 127)) { shiftL(a.begin + (k == 46 ? 0 : -1)); return false } else if (k == 27) { f.val(l); f.caret(0, checkVal()); return false } }; function keypressEvent(e) { if (h) { h = false; return (e.keyCode == 8) ? false : null } e = e || window.event; var k = e.charCode || e.keyCode || e.which; var a = $(this).caret(); if (e.ctrlKey || e.altKey || e.metaKey) { return true } else if ((k >= 32 && k <= 125) || k > 186) { var p = seekNext(a.begin - 1); if (p < v) { var c = String.fromCharCode(k); if (q[p].test(c)) { shiftR(p); g[p] = c; writeBuffer(); var b = seekNext(p); $(this).caret(b); if (n.completed && b == v) n.completed.call(f) } } } return false }; function clearBuffer(a, b) { for (var i = a; i < b && i < v; i++) { if (q[i]) g[i] = n.placeholder.length > 1 ? n.placeholder.charAt(i) : n.placeholder } }; function writeBuffer() { return f.val(g.join('')).val() }; function checkVal(a) { var b = f.val(); var d = -1; for (var i = 0, pos = 0; i < v; i++) { if (q[i]) { g[i] = n.placeholder.length > 1 ? n.placeholder.charAt(i) : n.placeholder; while (pos++ < b.length) { var c = b.charAt(pos - 1); if (q[i].test(c)) { g[i] = c; d = i; break } } if (pos > b.length) break } else if (g[i] == b[pos] && i != s) { pos++; d = i } } if (!a && d + 1 < s) { f.val(""); clearBuffer(0, v) } else if (a || d + 1 >= s) { writeBuffer(); if (!a) f.val(f.val().substring(0, d + 1)) } return (s ? i : u) }; if (!f.attr("readonly")) f.one("unmask", function () { f.unbind(".mask").removeData("buffer").removeData("tests") }).bind("focus.mask", function () { l = f.val(); var a = checkVal(); writeBuffer(); setTimeout(function () { if (a == m.length) f.caret(0, a); else f.caret(a) }, 0) }).bind("blur.mask", function () { checkVal(); if (f.val() != l) f.change() }).bind("keydown.mask", keydownEvent).bind("keypress.mask", keypressEvent).bind(w, function () { setTimeout(function () { f.caret(checkVal(true)) }, 0) }); checkVal() }) } }) })(jQuery);
/* version number */
//-------------------
/* end version number */
var selectedShip = "";
function initRoomCruise() {

    $('#ddlRoomsNum').change(function () {
        ddlRoomsNum_Change($(this).val());
    });
    setShips();

   
}

function setShips() {
   //if (typeof ($('#hiddenShips').val()) != "undefined" && $('#hiddenShips').val().length > 0) {
   //    var jsonData = JSON.parse($('#hiddenShips').val());
   //    $('#ddlCruiseShips').empty();
   //    $('#ddlCruiseShips').append($("<option></option>").attr("value", -1).text('בחר/י'));
   //    for (i = 0; i < jsonData.length; i++) {
   //        $('#ddlCruiseShips').append($("<option></option>").attr("value", jsonData[i].id).text(jsonData[i].name));
   //    }
   //}
    //init  Cruise Ships Filter
    if (typeof ($('#hiddenShips').val()) != "undefined" && $('#hiddenShips').val().length > 0) {
        var ships = JSON.parse($('#hiddenShips').val());
        $('#ddlCruiseShips').append($("<input id=\"radi_shipsAll\" type=\"radio\" checked name=\"shp\" class=\"myinput ddlCruiseShips large custom DoFilter right\" value=\"-1\"><span class=\"pr5 color_checked \">" + 'הכל' + "</span></br>"));

        for (var i = 0; i < ships.length; i++) {
            $('#ddlCruiseShips').append($("<input id=\"radi_" + i + "\" type=\"radio\" name=\"shp\" class=\"myinput ddlCruiseShips large custom DoFilter right\" value=\"" + ships[i].id + "\"><span class=\"pr5 color_checked\">" + ships[i].name + "</span></br>"));
        }
    }
    //init month for filter
    if (typeof ($('#hiddenMonthTrip').val()) != "undefined" && $('#hiddenMonthTrip').val().length > 0) {
        var month = JSON.parse($('#hiddenMonthTrip').val());
        $('#ddlMonthTrip').append($("<input id=\"radi_radi_monthAll\" type=\"radio\" checked name=\"month\" class=\"myinput ddlMonthTrip large custom DoFilter right\" value=\"-1\"><span class=\"pr5 color_checked \">" + 'הכל' + "</span></br>"));
        if (month.length <= 1)
        {
            $('#monthListFilter').hide()
        }
        for (var i = 0; i < month.length; i++) {
            $('#ddlMonthTrip').append($("<input id=\"radi_month" + i + "\" type=\"radio\" name=\"month\" class=\"myinput ddlMonthTrip large custom DoFilter right\" value=\"" + month[i].periodCode + "\" data-period-code=\"" + month[i].periodCode + "\"><span class=\"pr5 color_checked\">" + month[i].hebMonthName + "</span></br>"));
        }
    }
}




function ddlRoomsNum_Change(roomCount) {

    var room1Html = $('#tblRoom1').html();

    for (var i = 2; i <= 3; i++) {

        // if room table exists
        if ($('#tblRoom' + i).length > 0) {
            // show relevant room tables only
            if (i <= roomCount) {
                var roomiHtml = room1Html.replace(/Room1/g, 'Room' + i);

                // if the room table is not currently visible - create it with default values
                // existing room selections won't be changed
                if ($('#tblRoom' + i).html().toLowerCase() == '<tbody></tbody>' || $('#tblRoom' + i).html() == '') {
                    $('#tblRoom' + i).html(roomiHtml);
                    // room title
                    $('#spnRoom' + i + 'Index').html(i);

                    // default candidates
                    $('#ddlAdultNumRoom' + i).val('1');
                    $('#ddlChildNumRoom' + i).val('0');
                    $('#ddlBabyNumRoom' + i).val('0');
                }
            }
            // hide irrelevant room tables
            else {
                $('#tblRoom' + i).html('<TBODY></TBODY>');
            }
        }
    }
}

function getShips(areaCode) {
    if (areaCode == "") {
        areaCode = -1;
    }
    if (areaCode == -1) {
        $("#ddlCruiseShips").empty();
        $("#ddlMonthTrip").empty();
        setShips();
        return;
    }

    $.ajax({
        url: "/Handlers/Cruise.ashx",
        dataType: "json",
        data: { code: areaCode },
        async: false,
        success: function (data) {
            //init  Cruise Ships Filter
            //if (typeof ($('#hiddenShips').val()) != "undefined" && $('#hiddenShips').val().length > 0) {
            //    var ships = JSON.parse($('#hiddenShips').val());
            //    $('#ddlCruiseShips').append($("<input id=\"radi_" + i + "\" type=\"radio\" checked name=\"cruiseShip\" class=\"myinput ddlCruiseShips large custom DoFilter\" value=\"\"><span class=\"pr5\">" + '<%=Resource("all","SearchWizardDomesticHotels")%>' + "</span></br>"));
            //
            //    for (var i = 0; i < ships.length; i++) {
            //
            //        $('#ddlCruiseShips').append($("<input id=\"radi_" + i + "\" type=\"radio\" name=\"cruiseShip\" class=\"myinput ddlCruiseShips large custom DoFilter\" value=\"" + ships[i].id + "\"><span class=\"pr5\">" + ships[i].name + "</span></br>"));
            //    }
            //}


            $("#ddlCruiseShips").empty();
            $('#ddlCruiseShips').append($("<input id=\"radi_shipsAll\" type=\"radio\" checked name=\"shp\" class=\"myinput ddlCruiseShips large custom DoFilter right\" value=\"-1\"><span class=\"pr5 color_checked \">" + 'הכל' + "</span></br>"));
            var ships = JSON.parse($('#hiddenShips').val());
            if (data != null && data != '') {                
                for (var i = 0; i < data.length; i++) {
                    if (isShipInArray(data[i], ships))
                    {
                        $('#ddlCruiseShips').append($("<input id=\"radi_" + i + "\" type=\"radio\" name=\"shp\" class=\"myinput ddlCruiseShips large custom DoFilter\" value=\"" + data[i].ShipCode + "\"><span class=\"pr5 color_checked\">" + data[i].ShipName + "</span></br>"));
                    }
                }
               }
            
        },
        error: function () {
          //  alert("Error in Get Countries !");
        },
        complete: function () {
            $("#ddlCruiseShips").val(selectedShip);
        }
    });

}

function isShipInArray(ship, arr) {
    for (i in arr) {
        if (ship.ShipCode == arr[i].id)
            return true;
    }
    return false;
}

function addRecommend() {

    var lcid = $('#lcid').val();
    var tripId = $('#tripId').val();
    var title = $('#txtTitle').val();
    var year = $('#ddYear').val();
    var traveller = $('#txtTravellerName').val();
    var email = $('#txtEmail').val();
    var guide = $('#txtGuide').val();
    var fullDescription = $('#txtFullDescription').val();
    var imageId = $('#UploadImageId').val(); // if no image set to 0

    if (!isValidRecommend(title, traveller, email, fullDescription)) return;

    $.ajax({
        url: "/Handlers/Recommend.ashx",
        dataType: "json",
        data: {
            lcid: lcid,
            tripId: tripId,
            year: year,
            guide: guide,
            traveller: traveller,
            title: title,
            fullDescription: fullDescription,
            imageId: imageId,
            alt: ""
        },

        success: function (data) {
            alert("ההמלצה נוספה בהצלחה");
        },
        error: function () {
            alert("בעיה בהוספת המלצה");
        }
    });

    closeRecommendPopup();
}

function isValidRecommend(title, traveller, email, fullDescription) {

    var isValid = 0;

    $("#addRecommendation #summaryErr ul li").remove();

    if (title == '') {
        isValid = 1;
        $("#addRecommendation #summaryErr ul").append('<li>אנא הזן כותרת</li>');
    }
    if (traveller == '') {
        isValid = (isValid == 0) ? 2 : isValid;
        $("#addRecommendation #summaryErr ul").append('<li>אנא הזן שם מטייל</li>');
    }
    if (email == '') {
        isValid = (isValid == 0) ? 3 : isValid;
        $("#addRecommendation #summaryErr ul").append('<li>אנא הזן כתובת דוא"ל</li>');
    }
    if (fullDescription == '') {
        isValid = (isValid == 0) ? 4 : isValid;
        $("#addRecommendation #summaryErr ul").append('<li>אנא הזן תיאור מלא</li>');
    }

    switch (isValid) {
        case 1: $('#txtTitle').focus();
            break;
        case 2: $('#txtTravellerName').focus();
            break;
        case 3: $('#txtEmail').focus();
            break;
        case 4: $('#txtFullDescription').focus();
            break;
    }

    return isValid == 0;
}

function closeRecommendPopup() {
    clearRecommend();
    $("#addRecommendation").dialog("close");
}

function clearRecommend() {

    $("#addRecommendation #summaryErr ul li").remove();

    $('#txtTitle').val("");
    $('#txtTravellerName').val("");
    $('#txtEmail').val("");
    $('#txtGuide').val("");
    $('#txtFullDescription').val("");
    $('#ddYear').val("2012");
    $('#UploadImageId').val("0");
}


/* version number */
//-------------------
/* end version number */

function fillValuesOfTemplatesInDDLs(valueAtTemplatesDDL) {
    switch (valueAtTemplatesDDL) {
        case ('0'):
            $("#ddlAdultNumRoom1Cruise").val(2);
            $("#ddlChildNumRoom1Cruise").val(0);
            break;
        case ('1'):
            $("#ddlAdultNumRoom1Cruise").val(1);
            $("#ddlChildNumRoom1Cruise").val(0);
            break;
        case ('2'):
            $("#ddlAdultNumRoom1Cruise").val(2);
            $("#ddlChildNumRoom1Cruise").val(1);
            break;
        case ('3'):
            $("#ddlAdultNumRoom1Cruise").val(2);
            $("#ddlChildNumRoom1Cruise").val(2);
            break;
        default:
            $("#ddlAdultNumRoom1Cruise").val(0);
            $("#ddlChildNumRoom1Cruise").val(0);
            break;
    }
}

function finishLoad() {
    if (typeof (window.FixHeight) == "function") {
        FixHeight();
    }
    formDeserialize();
    getShips($('#ddlCruiseCompanies').val());
    setWizardControls();
}

function setCruiseDestination(code) {
    $('#destinationCruise').val(code);
    showControls();
}

function LoadgeographicAreaCruise(){
    $('#geographicAreaCruise').change(function () {
        setDestinationsForCruise($(this).val());
        showControls();
    });

    $('#destinationCruise').change(function () {
        $('#hiddenDestinationCruise').val($(this).val());
        showControls();
    });

    $('.aClosePopUp').live('click', function (e) {
        $(this).parents('.searchWizardMore').hide("slide", { direction: "right" }, 500);
    });
}

function setDestinationsForCruise(area,callback) {
    $.ajax({
        url: "/Handlers/Destinations.ashx",
        dataType: "json",
        data: { area: area, cruise: 1 },
        success: function (data) {
            if (data != "") {
                $('#destinationCruise').empty();
                $('#destinationCruise').append($("<option></option>").attr("value", ("-1")).text('בחר/י'));
                for (var i = 0; i < data["rows"].length; i++) { // fill options
                    $('#destinationCruise').append($("<option></option>").attr("value", (data["rows"][i].destinationCode)).text(data["rows"][i].destinationName));
                }
            }
        },
        error: function () {
        },
        complete: function () {
            if (typeof (callback) != "undefined") {
                callback();
            }
        }
    });
}

function showControls() {
    if ($('#geographicAreaCruise').val() != -1) {
        $('.showControl').show();
        $('.boxs').hide();
    }
}

var defaultSettings = "";
var specialDays = [];
specialDays[0] = [];
specialDays[1] = [];

function LoadDatePickerCruise(){
    function legend() {

        setTimeout(function () {
            if ($('.ulHolidays').length > 0) {
                $('.ulHolidays').remove();
            }
            $(".ui-datepicker-row-break").append("<ul class='ulHolidays'><li><span class='valid'>*&nbsp;</span><span>חג</span></li><li><img src='/images/chooseBg.png' width='18' height='17' alt='' /><span>בחירה</span></li></ul><a class='cleanDates'>נקה בחירה</a>");
        }, 100);
    }
    defaultSettings = {
        showOn: "button",
        buttonImage: "/images/calendarIcon2.png",
        buttonImageOnly: true,
        //showButtonPanel: true,
        beforeShowDay: function (thedate) {
            var theday = thedate.getDate();
            var d = thedate.getDate() + "";
            var m = thedate.getMonth() + 1;
            var yerrr = thedate.getFullYear();
            var key = d + "/" + m + "/" + yerrr;

            if (typeof (specialDays[1]) != "undefined") {
                if (typeof (specialDays[1][key]) != "undefined") {
                    if (typeof (specialDays[0][key]) != "undefined") {
                        return [true, 'charterholiday', specialDays[0][key]];
                    }
                    else {
                        return [true, 'charter', specialDays[1][key]];
                    }
                }
            }

            if (typeof (specialDays[0]) != "undefined") {
                if (typeof (specialDays[0][key]) != "undefined") {
                    return [true, 'holiday', specialDays[0][key]];
                }
            }

            return [true, ''];
        },
        beforeShow: function (input, inst) {
            legend();

            if (!$('.ui-datepicker').parent().hasClass('wrap')) {
                $('.ui-datepicker').wrap("<div class='wrap' id='calendarWrapper'></div>");

            }
            $('.ui-datepicker').parent().removeClass('from').removeClass('to');

            $('.ui-datepicker').parent().addClass(inst.id);
            var year = inst.drawYear; var month = inst.drawMonth; var currentTime = new Date()
            if (year == 0) year = currentTime.getFullYear(); if (month == 0) month = currentTime.getMonth();

            /*GetSpecialDates(year, month + 2, function () {
            $("#from").datepicker("refresh");
            $("#to").datepicker("refresh");
            });*/
        },
        onChangeMonthYear: function (year, month, inst) {
            legend();
            GetSpecialDatesCruise(year, month, function () {
                $("#fromCruise").datepicker("refresh");
                $("#toCruise").datepicker("refresh");
            });
        },
        defaultDate: "+1w",       
        numberOfMonths: 2,
        onSelect: function (selectedDate) {
//            var option = this.id == "from" ? "minDate" : "maxDate",
//					instance = $(this).data("datepicker"),
//					date = $.datepicker.parseDate(
//						instance.settings.dateFormat ||
//						$.datepicker._defaults.dateFormat,
//						selectedDate, instance.settings);
//            dates.not(this).datepicker("option", option, date);
            if (this.id == "fromCruise") {
                setTimeout(function () {
                    $("#toCruise").datepicker("setDate", selectedDate);
                    $("#toCruise").datepicker("show");
                }, 100);
            }
            $(".searchPeriod").attr("checked", false);
        },
        minDate: $('#hiddenTodayCruise').val(),
        showOtherMonths: true,
        showMonthAfterYear: false,
        monthNames: ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'],
        monthNamesShort: ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'],
        dayNamesMin: ['א', 'ב', 'ג', 'ד', 'ה', 'ו', 'ש'],
        dateFormat: 'dd/mm/yy'
    }

    var dates = $("#fromCruise, #toCruise").datepicker(defaultSettings);
    $("#ui-datepicker-div").addClass("datepickerWrapper");
    $('.cleanDates').live('click', function () {
        $("#fromCruise, #toCruise").val('');
    });

    var currentDate = new Date();

    GetSpecialDatesCruise(currentDate.getFullYear(), currentDate.getMonth() + 2, function () {
        $("#fromCruise").datepicker("refresh");
        $("#toCruise").datepicker("refresh");
        //rePaint();
    });

    $('#fromCruise,#toCruise').focus(function (e) {
        e.preventDefault();
        e.stopPropagation();
        $(this).datepicker('show');
    });

    $('#ddlSearchPeriodCruise').trigger('change');
}

function setWizardControls() {

    if ($('#geographicAreaCruise').val() != -1) {
        $('.showControl').show();
        $('.boxs').hide();
    }
}

function GetSpecialDatesCruise(year, month, callback) {
    var url = "";
    var action = "cruise";
    url = "/Handlers/CalanderDates.ashx?m=" + month + "&y=" + year + "&city=" + $('#hiddenCity').val() + "&country=" + $('#hiddenCountry').val() + "&actioncharter=" + action;

    $.ajax({
        type: 'GET',
        url: url,
        async: false,
        cache: true,
        jsonpCallback: 'DatesCallBack',
        contentType: "application/json",
        dataType: 'jsonp',
        success: function (dates) {

            var tempo = dates.data;
            for (var i in tempo[0]) {
                specialDays[0][i] = tempo[0][i];
            }
            for (var x in tempo[1]) {
                specialDays[1][x] = tempo[1][x];
            }

            callback();
        }
    });
}



/*
* jQuery Templates Plugin 1.0.0pre
* http://github.com/jquery/jquery-tmpl
* Requires jQuery 1.4.2
*
* Copyright 2011, Software Freedom Conservancy, Inc.
* Dual licensed under the MIT or GPL Version 2 licenses.
* http://jquery.org/license
*/
(function (a) { var r = a.fn.domManip, d = "_tmplitem", q = /^[^<]*(<[\w\W]+>)[^>]*$|\{\{\! /, b = {}, f = {}, e, p = { key: 0, data: {} }, i = 0, c = 0, l = []; function g(g, d, h, e) { var c = { data: e || (e === 0 || e === false) ? e : d ? d.data : {}, _wrap: d ? d._wrap : null, tmpl: null, parent: d || null, nodes: [], calls: u, nest: w, wrap: x, html: v, update: t }; g && a.extend(c, g, { nodes: [], parent: d }); if (h) { c.tmpl = h; c._ctnt = c._ctnt || c.tmpl(a, c); c.key = ++i; (l.length ? f : b)[i] = c } return c } a.each({ appendTo: "append", prependTo: "prepend", insertBefore: "before", insertAfter: "after", replaceAll: "replaceWith" }, function (f, d) { a.fn[f] = function (n) { var g = [], i = a(n), k, h, m, l, j = this.length === 1 && this[0].parentNode; e = b || {}; if (j && j.nodeType === 11 && j.childNodes.length === 1 && i.length === 1) { i[d](this[0]); g = this } else { for (h = 0, m = i.length; h < m; h++) { c = h; k = (h > 0 ? this.clone(true) : this).get(); a(i[h])[d](k); g = g.concat(k) } c = 0; g = this.pushStack(g, f, i.selector) } l = e; e = null; a.tmpl.complete(l); return g } }); a.fn.extend({ tmpl: function (d, c, b) { return a.tmpl(this[0], d, c, b) }, tmplItem: function () { return a.tmplItem(this[0]) }, template: function (b) { return a.template(b, this[0]) }, domManip: function (d, m, k) { if (d[0] && a.isArray(d[0])) { var g = a.makeArray(arguments), h = d[0], j = h.length, i = 0, f; while (i < j && !(f = a.data(h[i++], "tmplItem"))); if (f && c) g[2] = function (b) { a.tmpl.afterManip(this, b, k) }; r.apply(this, g) } else r.apply(this, arguments); c = 0; !e && a.tmpl.complete(b); return this } }); a.extend({ tmpl: function (d, h, e, c) { var i, k = !c; if (k) { c = p; d = a.template[d] || a.template(null, d); f = {} } else if (!d) { d = c.tmpl; b[c.key] = c; c.nodes = []; c.wrapped && n(c, c.wrapped); return a(j(c, null, c.tmpl(a, c))) } if (!d) return []; if (typeof h === "function") h = h.call(c || {}); e && e.wrapped && n(e, e.wrapped); i = a.isArray(h) ? a.map(h, function (a) { return a ? g(e, c, d, a) : null }) : [g(e, c, d, h)]; return k ? a(j(c, null, i)) : i }, tmplItem: function (b) { var c; if (b instanceof a) b = b[0]; while (b && b.nodeType === 1 && !(c = a.data(b, "tmplItem")) && (b = b.parentNode)); return c || p }, template: function (c, b) { if (b) { if (typeof b === "string") b = o(b); else if (b instanceof a) b = b[0] || {}; if (b.nodeType) b = a.data(b, "tmpl") || a.data(b, "tmpl", o(b.innerHTML)); return typeof c === "string" ? (a.template[c] = b) : b } return c ? typeof c !== "string" ? a.template(null, c) : a.template[c] || a.template(null, q.test(c) ? c : a(c)) : null }, encode: function (a) { return ("" + a).split("<").join("&lt;").split(">").join("&gt;").split('"').join("&#34;").split("'").join("&#39;") } }); a.extend(a.tmpl, { tag: { tmpl: { _default: { $2: "null" }, open: "if($notnull_1){__=__.concat($item.nest($1,$2));}" }, wrap: { _default: { $2: "null" }, open: "$item.calls(__,$1,$2);__=[];", close: "call=$item.calls();__=call._.concat($item.wrap(call,__));" }, each: { _default: { $2: "$index, $value" }, open: "if($notnull_1){$.each($1a,function($2){with(this){", close: "}});}" }, "if": { open: "if(($notnull_1) && $1a){", close: "}" }, "else": { _default: { $1: "true" }, open: "}else if(($notnull_1) && $1a){" }, html: { open: "if($notnull_1){__.push($1a);}" }, "=": { _default: { $1: "$data" }, open: "if($notnull_1){__.push($.encode($1a));}" }, "!": { open: ""} }, complete: function () { b = {} }, afterManip: function (f, b, d) { var e = b.nodeType === 11 ? a.makeArray(b.childNodes) : b.nodeType === 1 ? [b] : []; d.call(f, b); m(e); c++ } }); function j(e, g, f) { var b, c = f ? a.map(f, function (a) { return typeof a === "string" ? e.key ? a.replace(/(<\w+)(?=[\s>])(?![^>]*_tmplitem)([^>]*)/g, "$1 " + d + '="' + e.key + '" $2') : a : j(a, e, a._ctnt) }) : e; if (g) return c; c = c.join(""); c.replace(/^\s*([^<\s][^<]*)?(<[\w\W]+>)([^>]*[^>\s])?\s*$/, function (f, c, e, d) { b = a(e).get(); m(b); if (c) b = k(c).concat(b); if (d) b = b.concat(k(d)) }); return b ? b : k(c) } function k(c) { var b = document.createElement("div"); b.innerHTML = c; return a.makeArray(b.childNodes) } function o(b) { return new Function("jQuery", "$item", "var $=jQuery,call,__=[],$data=$item.data;with($data){__.push('" + a.trim(b).replace(/([\\'])/g, "\\$1").replace(/[\r\t\n]/g, " ").replace(/\$\{([^\}]*)\}/g, "{{= $1}}").replace(/\{\{(\/?)(\w+|.)(?:\(((?:[^\}]|\}(?!\}))*?)?\))?(?:\s+(.*?)?)?(\(((?:[^\}]|\}(?!\}))*?)\))?\s*\}\}/g, function (m, l, k, g, b, c, d) { var j = a.tmpl.tag[k], i, e, f; if (!j) throw "Unknown template tag: " + k; i = j._default || []; if (c && !/\w$/.test(b)) { b += c; c = "" } if (b) { b = h(b); d = d ? "," + h(d) + ")" : c ? ")" : ""; e = c ? b.indexOf(".") > -1 ? b + h(c) : "(" + b + ").call($item" + d : b; f = c ? e : "(typeof(" + b + ")==='function'?(" + b + ").call($item):(" + b + "))" } else f = e = i.$1 || "null"; g = h(g); return "');" + j[l ? "close" : "open"].split("$notnull_1").join(b ? "typeof(" + b + ")!=='undefined' && (" + b + ")!=null" : "true").split("$1a").join(f).split("$1").join(e).split("$2").join(g || i.$2 || "") + "__.push('" }) + "');}return __;") } function n(c, b) { c._wrap = j(c, true, a.isArray(b) ? b : [q.test(b) ? b : a(b).html()]).join("") } function h(a) { return a ? a.replace(/\\'/g, "'").replace(/\\\\/g, "\\") : null } function s(b) { var a = document.createElement("div"); a.appendChild(b.cloneNode(true)); return a.innerHTML } function m(o) { var n = "_" + c, k, j, l = {}, e, p, h; for (e = 0, p = o.length; e < p; e++) { if ((k = o[e]).nodeType !== 1) continue; j = k.getElementsByTagName("*"); for (h = j.length - 1; h >= 0; h--) m(j[h]); m(k) } function m(j) { var p, h = j, k, e, m; if (m = j.getAttribute(d)) { while (h.parentNode && (h = h.parentNode).nodeType === 1 && !(p = h.getAttribute(d))); if (p !== m) { h = h.parentNode ? h.nodeType === 11 ? 0 : h.getAttribute(d) || 0 : 0; if (!(e = b[m])) { e = f[m]; e = g(e, b[h] || f[h]); e.key = ++i; b[i] = e } c && o(m) } j.removeAttribute(d) } else if (c && (e = a.data(j, "tmplItem"))) { o(e.key); b[e.key] = e; h = a.data(j.parentNode, "tmplItem"); h = h ? h.key : 0 } if (e) { k = e; while (k && k.key != h) { k.nodes.push(j); k = k.parent } delete e._ctnt; delete e._wrap; a.data(j, "tmplItem", e) } function o(a) { a = a + n; e = l[a] = l[a] || g(e, b[e.parent.key + n] || e.parent) } } } function u(a, d, c, b) { if (!a) return l.pop(); l.push({ _: a, tmpl: d, item: this, data: c, options: b }) } function w(d, c, b) { return a.tmpl(a.template(d), c, b, this) } function x(b, d) { var c = b.options || {}; c.wrapped = d; return a.tmpl(a.template(b.tmpl), b.data, c, b.item) } function v(d, c) { var b = this._wrap; return a.map(a(a.isArray(b) ? b.join("") : b).filter(d || "*"), function (a) { return c ? a.innerText || a.textContent : a.outerHTML || s(a) }) } function t() { var b = this.nodes; a.tmpl(null, null, null, this).insertBefore(b[0]); a(b).remove() } })(jQuery);
///* version number */
////-------------------
///* end version number */
////Wizard Mode
////1= Domestic Hotel
////2- Domestic Flight
////3 - Domestic Packaged
//var wizard_mode = 1;

//function finishLoad() {
//    if (typeof (window.FixHeight) == "function") {
//        FixHeight();
//    }
//    formDeserialize();
//    setDestinationAutoComplete();
//    ddlRoomsNum_Change($('#ddlRoomsNum').val());
//}

//function changeSorting(qParam) {
//    var url = updateQueryStringParameter(window.location.href, 'sort', qParam);
//    window.location.href = url;
//}

//$(function () {

//    ChangeRoomsCount();

//});
//function NightsChanged(nights) {
//    var strDate = $('#fromDomesticHotel').val();
//    var dateParts = strDate.split("/");
//    var d = new Date(dateParts[2], (dateParts[1] - 1), dateParts[0]);
//    d = addDays(d, Number(nights));
//    $('#toDomesticHotel').val(addZero(d.getDate(), 'day') + "/" + addZero(Number(d.getMonth()), 'month') + "/" + d.getFullYear());
//}

//function setWizardAfterAutoComplete() {
//    if (typeof ($('#originDomesticHotel').val()) == "undefined") { // internal hotels
//        if ($('#destinationDomesticHotel').val() != "" && $('#destinationDomesticHotel').val() != null) {
//            $('.showControl').show();
//            $('.boxs').hide();
//        }
//    }
//    else {
//        if (($('#originDomesticHotel').val() != "" && $('#originDomesticHotel').val() != -1) && ($('#destinationDomesticHotel').val() != "" && $('#destinationDomesticHotel').val() != null)) { // internal packages
//            $('.showControl').show();
//            $('.boxs').hide();
//        }
//    }
//}

//function fillValuesOfTemplatesInDDLs_DomesticHotels(valueAtTemplatesDDL) {
//    switch (valueAtTemplatesDDL) {
//        case ('0'):
//            $("#Room1ADomesticHotel").val(2);
//            $("#Room1CDomesticHotel").val(0);
//            break;
//        case ('1'):
//            $("#Room1ADomesticHotel").val(2);
//            $("#Room1CDomesticHotel").val(1);
//            break;
//        case ('2'):
//            $("#Room1ADomesticHotel").val(2);
//            $("#Room1CDomesticHotel").val(2);
//            break;
//        case ('3'):
//            $("#Room1ADomesticHotel").val(2);
//            $("#Room1CDomesticHotel").val(3);
//            break;
//        case ('4'):
//            $("#Room1ADomesticHotel").val(1);
//            $("#Room1CDomesticHotel").val(0);
//            break;
//        case ('5'):
//            $("#Room1ADomesticHotel").val(1);
//            $("#Room1CDomesticHotel").val(1);
//            break;
//        case ('6'):
//            $("#Room1ADomesticHotel").val(1);
//            $("#Room1CDomesticHotel").val(2);
//            break;
//        case ('7'):
//            $("#Room1ADomesticHotel").val(1);
//            $("#Room1CDomesticHotel").val(3);
//            break;
//        case ('8'):
//            $("#Room1ADomesticHotel").val(3);
//            $("#Room1CDomesticHotel").val(0);
//            break;
//        case ('9'):
//            $("#Room1ADomesticHotel").val(3);
//            $("#Room1CDomesticHotel").val(1);
//            break;
//        case ('10'):
//            $("#Room1ADomesticHotel").val(3);
//            $("#Room1CDomesticHotel").val(2);
//            break;
//        case ('11'):
//            $("#Room1ADomesticHotel").val(3);
//            $("#Room1CDomesticHotel").val(3);
//            break;
//        case ('12'):
//            $("#Room1ADomesticHotel").val(4);
//            $("#Room1CDomesticHotel").val(0);
//            break;
//        case ('13'):
//            $("#Room1ADomesticHotel").val(4);
//            $("#Room1CDomesticHotel").val(1);
//            break;
//        case ('14'):
//            $("#Room1ADomesticHotel").val(5);
//            $("#Room1CDomesticHotel").val(0);
//            break;
//        default:
//            $("#Room1ADomesticHotel").val(0);
//            $("#Room1CDomesticHotel").val(0);
//            break;
//    }
//}

//function addDays(myDate, days) {
//    return new Date(myDate.getTime() + days * 24 * 60 * 60 * 1000);
//}

//function addZero(num, dateCase) {
//    switch (dateCase) {
//        case "month":
//            num++;
//            break;
//        default:
//            break;
//    }

//    if (num < 10) {
//        return "0" + num;
//    }
//    return num;
//}

//function legendDomestic(id) {
   
//    setTimeout(function () {
//        if ($('.ulHolidays').length > 0) {
//            $('.ulHolidays .datepicker-message').remove();
//            $('.one_way_calender').remove();
//        }

//        var legendHtmlStr = "<ul class='ulHolidays'><li><span class='index_calender_selected mr4'></span><span style='display:inline-block;line-height:17px;'>בחירה</span></li></ul><a class='cleanDates'></a>";
        
//        var holidaysLegendStr = "<li class='holidays-legend'><span class='valid'><img src='/images/calendarHolidayIcon.png' width='18' height='17' alt='' /></span><span>חג</span></li>";
         
//        // Set break row for the datepicker
//        setDatepickerBreakRow(legendHtmlStr, holidaysLegendStr);
       
//        //one Way Option - Only On Domestic Flight Mode
//        //if (id == 'toDomesticHotel' && wizard_mode == 2) {
//        //    $(".ui-datepicker-row-break").append("<a class='one_way_calender' onclick=\"OneWey();\">כיוון אחד</a>");

//        //}

//    }, 100)
//}

//var specialDays = [];
//specialDays[0] = [];
//specialDays[1] = [];
//var defaultSettingsDomesticHotels = "";
//var loadChainFirstTime = true;
//var loadHotelsFirstTime = true;
//function ActiveDomesticHotel() {

//    $('#div_domestic_departure').removeClass("ddl-domestic-flight-departure-date-one-direction");
//    $('#div_domestic_departure').addClass("ddl-domestic-flight-departure-date");

//    $('.search_btn').removeClass("mr18");
//    $('.search_btn').removeClass("mr7");
//    $('.search_btn').removeClass("deals_wizard_search_btn");
//    $('.search_btn').removeClass("mt0");

//    $('.search_btn').addClass("mr15_none_impo");

//    if (getQuerystring('origin') != "")
//        setWizardAfterAutoComplete();

//    initDatePickerFromDomesticHotels();

//    defaultSettingsDomesticHotels = {

//        //showButtonPanel: true,
//        beforeShowDay: function (thedate) {
//            var theday = thedate.getDate();
//            var d = thedate.getDate() + "";
//            var m = thedate.getMonth() + 1;
//            var yerrr = thedate.getFullYear();
//            var key = d + "/" + m + "/" + yerrr;

//            if (this.id == "toDomesticHotel") {
//                var fromDate = parseDate($("#fromDomesticHotel").val());
//                if (fromDate.getDate() == thedate.getDate() && fromDate.getMonth() == thedate.getMonth() && fromDate.getFullYear() == thedate.getFullYear()) {
//                    return [true, "ui-state-disabled ui-datepicker-unselectable ui-state-disabled-start-date"];
//                }
//            }

//            if (typeof (specialDays[1]) != "undefined") {
//                if (typeof (specialDays[1][key]) != "undefined") {
//                    if (typeof (specialDays[0][key]) != "undefined") {
//                        return [true, 'charterholiday', specialDays[0][key]];
//                    }
//                    else {
//                        return [true, 'charter', specialDays[1][key]];
//                    }
//                }
//            }

//            if (typeof (specialDays[0]) != "undefined") {
//                if (typeof (specialDays[0][key]) != "undefined") {
//                    return [true, 'holiday', specialDays[0][key]];
//                }
//            }

//            return [true, ''];
//        },
//        beforeShow: function (input, inst) {
//            legendDomestic(inst.id);

//            setDP_classesForJS("False");

//            //Datepicker animation
//            $(this).datepicker("option", "showAnim", "fadeIn");
//            doDatePickerPositionHandle(input);

//            if (!$('.ui-datepicker').parent().hasClass('wrap')) {
//                $('.ui-datepicker').wrap("<div class='wrap' id='calendarWrapper'></div>");

//            }
//            $('.ui-datepicker').parent().removeClass('from').removeClass('to');

//            $('.ui-datepicker').parent().addClass(inst.id);
//            if (this.id == "toDomesticHotel") {

//                setDP_classesForJS("True");

//                doDatePickerDateRange();


//                $("#toDomesticHotel").datepicker("option", "minDate", $("#fromDomesticHotel").val());
//            }
//            $("#toDomesticHotel").datepicker("refresh");
//        },
//        onChangeMonthYear: function (year, month, inst) {
//            legendDomestic(inst.id);
//        },
//        defaultDate: "+1w",

//        numberOfMonths: 2,
//        onSelect: function (selectedDate) {

//            setWizardAfterDateChangeDomesticHotel();
//            if (this.id == "fromDomesticHotel") {
//                //if (wizard_mode == 2 || wizard_mode == 3) {
//                setTimeout(function () {
//                    if ($("#ways").val() != 1) {
//                        $("#toDomesticHotel").datepicker("setDate", selectedDate);
//                        $("#toDomesticHotel").datepicker("option", "minDate", selectedDate);
//                        $("#toDomesticHotel").datepicker("show");
//                    }
//                }, 100);
//                //}
//            }
//            else if (this.id == "toDomesticHotel") {
//                $('#ways').val('2');

//            }
//            $(".searchPeriod").attr("checked", false);
//        },
//        minDate: $('#hiddenToday').val(),
//        showOtherMonths: true,
//        showMonthAfterYear: false,
//        monthNames: ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'],
//        monthNamesShort: ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'],
//        dayNamesMin: ['א', 'ב', 'ג', 'ד', 'ה', 'ו', 'ש'],
//        dateFormat: 'dd/mm/yy'
//    }

//    var dates = $("#fromDomesticHotel, #toDomesticHotel").datepicker(defaultSettingsDomesticHotels);
//    $("#ui-datepicker-div").addClass("datepickerWrapper");
//    setWizardAfterDateChangeDomesticHotel();

//    $('.cleanDates').live('click', function () {
//        $("#fromDomesticHotel, #toDomesticHotel").val('');
//    });

//    var currentDate = new Date();
//    GetSpecialDatesDH(currentDate.getFullYear(), currentDate.getMonth() + 1, function () {
//        $("#fromDomesticHotel").datepicker("refresh");
//        $("#toDomesticHotel").datepicker("refresh");
//    });

//    $('#ddlDestinationDomesticHotel,#destinationDomesticHotel').bind('change', function () {
//        if ($(this).val().indexOf(',') > 0) {
//            $('#destinationDomesticHotel').val($(this).val().split(',')[0]);
//            $('#ddlHotelDomesticHotel').val($('#ddlHotelDomesticHotel').attr('placeholder'));
//            $('#yayacode').val($(this).val().split(',')[1]);
//        }
//        else {
//            $('#destinationDomesticHotel').val($(this).val());
//        }       
//        getHotels($('#destinationDomesticHotel').val());
//    });

   
//    $("#ddlHotelDomesticHotel").live('click', function () {
//        $(this).autocomplete('search', '');
//    });

//    $('#hotelChainDomesticHotel').bind('change', function () {
//        $('#hiddenChain').val($(this).val());
//        if ($(this).val() != "") {
//            getHotelsByNetwork($('#destinationDomesticHotel').val(), $(this).val());
//        }

//    });

//    $('#ddlHodel').bind('change', function () {
//        $('#hiddenHotel').val($(this).val());
//    });

//    $('#fromDomesticHotel,#toDomesticHotel').focus(function (e) {
//        e.preventDefault();
//        e.stopPropagation();
//        $(this).datepicker('show');
//    });


//}

//function initDatePickerToDomesticHotels() {

//    instance = $('#toDomesticHotel').data("datepicker");
//    date = $.datepicker.parseDate(instance.settings.dateFormat || $.datepicker._defaults.dateFormat, $('#toDomesticHotel').val(), instance.settings);

//}

//function initDatePickerFromDomesticHotels() {

//    specialDays[0] = [];
//    specialDays[1] = [];
//    legendDomestic();

//    setTimeout(function () {
//        var date = $.datepicker.parseDate("dd/mm/yy" || $.datepicker._defaults.dateFormat, $('#fromDomesticHotel').val());
//        if (date == null)
//            date = new Date();

//        initDatePickerToDomesticHotels();

//    }, 100);
//}


////onw Wey Flight
//function OneWey() {
//    $('#div_domestic_flight_return_date').hide();
//    $('#toDomesticHotel').datepicker('hide');
//    $('#toDomesticHotel').val('כיוון אחד');
//    $('#ways').val('1');

//    $('#div_domestic_departure').removeClass("ddl-domestic-flight-departure-date");
//    $('#div_domestic_departure').addClass("ddl-domestic-flight-departure-date-one-direction");
//}

////return flights
//function returnFlights() {
//    $('#div_domestic_flight_return_date').show();
//    $('#toDomesticHotel').val($("#fromDomesticHotel").val());
//    $('#ways').val('2');

//    $('#div_domestic_departure').removeClass("ddl-domestic-flight-departure-date-one-direction");
//    $('#div_domestic_departure').addClass("ddl-domestic-flight-departure-date");
//}

//function setWizardAfterDateChangeDomesticHotel() {
//    if ($.trim($('#fromDomesticHotel').val()) != '' && $.trim($('#toDomesticHotel').val()) != '') {
//        var dateFrom = new Date($('#fromDomesticHotel').datepicker('getDate').getFullYear(), $('#fromDomesticHotel').datepicker('getDate').getMonth(), $('#fromDomesticHotel').datepicker('getDate').getDate());
//        var dateTo = new Date($('#toDomesticHotel').datepicker('getDate').getFullYear(), $('#toDomesticHotel').datepicker('getDate').getMonth(), $('#toDomesticHotel').datepicker('getDate').getDate());
//        var ONE_DAY = 1000 * 60 * 60 * 24;
//        var difference_ms = Math.abs(dateFrom.getTime() - dateTo.getTime());
//        $('#txtNightsNum').val(Math.floor(difference_ms / ONE_DAY));
//    }
//}

//function GetSpecialDatesDH(year, month, callback) {
//    var url = "";
//    var action = "internaldeals";
//    url = "/Handlers/CalanderDates.ashx?m=" + month + "&y=" + year + "&city=" + $('#ddlDestinationDomesticHotel').val() + "&country=" + $('#destinationDomesticHotel').attr('rel') + "&actioncharter=" + action;

//    $.ajax({
//        type: 'GET',
//        url: url,
//        async: false,
//        cache: true,
//        jsonpCallback: 'DatesCallBack',
//        contentType: "application/json",
//        dataType: 'jsonp',
//        success: function (dates) {
//            var tempo = dates.data;
//            for (var i in tempo[0]) {
//                specialDays[0][i] = tempo[0][i];
//            }
//            for (var x in tempo[1]) {
//                specialDays[1][x] = tempo[1][x];
//            }
//            callback();
//        }
//    });
//}

//function getHotels(value) {
//    hotelsNames = [];
//    $('#destinationDomesticHotel').val(value);
//    $.ajax({
//        url: "/Handlers/DomesticHotels.ashx",
//        dataType: "json",
//        data: { city: value, action: 'hotel' },
//        success: function (data) {
//            //$('#ddlHotelDomesticHotel').empty();
//            //$('#ddlHotelDomesticHotel').append($("<option></option>").attr('value', '').text('הכל'));
//            $('#ddlHotel2').empty();
//            $('#ddlHotel2').append($("<option></option>").attr('value', '').text('הכל'));
         
//            if (data != null && data.length > 0) {
//                hotelsNames.push("הכל");
//                for (i = 0; i < data.length; i++) {
//                    $('#ddlHotel2').append($("<option>", { text: data[i].name + "          ", value: data[i].name }));
//                    hotelsNames.push(data[i].code);
//                }
//                $("#ddlHotelDomesticHotel").autocomplete({
//                    source: hotelsNames,
//                    minLength: 0,
//                    select: function (event, ui) {
//                        $("#ddlHotelDomesticHotel").attr('class', 'form-control');
//                    },
//                    change: function (event, ui) {
//                    },
//                    search: function (event, ui) {
//                        $("#ddlHotelDomesticHotel").attr('class', 'form-control');
//                    },
//                    response: function (event, ui) {
//                        var hotelName = this.value;
//                        var resultExist = true;

//                        if (hotelName != null && hotelName != undefined && hotelName != "") {
//                            if (ui != null && ui != undefined && ui.content != null && ui.content != undefined && ui.content.length == 0) {
//                                resultExist = false;
//                            }

//                            if (!resultExist) {
//                                $("#formErrorWrapper").show();
//                                autocompleteValid = false;
//                                //$("#ddlHotelDomesticHotel").focus();                                                                
//                            } else {
//                                $("#formErrorWrapper").hide();
//                                autocompleteValid = true;
//                            }
//                        } else {
//                            $("#formErrorWrapper").hide();
//                            autocompleteValid = true;
//                        }
//                    },
//                    close: function (event, ui) {
//                        $("#ddlHotelDomesticHotel").attr('class', 'form-control');
//                    }
//                }).focus(function () {
//                    $(this).autocomplete('search', '')
//                });
//            }
//        }
//    });
//}

//function getHotelsNoChain() {
//    $.ajax({
//        url: "/Handlers/DomesticHotels.ashx",
//        dataType: "json",
//        data: { city: $('#destinationDomesticHotel').val(), action: 'hotel' },
//        success: function (data) {
//            $('#ddlHotelDomesticHotel').empty();
//            $('#ddlHotel2').empty();
//            $('#ddlHotelDomesticHotel').append($("<option selected='selected'></option>").attr('value', '').text('הכל'));
//            $('#ddlHotel2').append($("<option selected='selected'></option>").attr('value', '').text('הכל'));
//            if (data != null && data.length > 0) {
//                for (i = 0; i < data.length; i++) {
//                    $('#ddlHotelDomesticHotel').append($("<option></option>").attr('value', data[i].code).text(data[i].name));
//                    $('#ddlHotel2').append($("<option></option>").attr('value', data[i].code).text(data[i].name));
//                }
//            }
//        },
//        complete: function () {
//            if ((typeof ($('#hiddenHotel').val()) != "undefined" && $('#hiddenHotel').val() != "") && loadHotelsFirstTime) {
//                $('#ddlHotelDomesticHotel').val($('#hiddenHotel').val().replace('+', ' '));
//                $('#ddlHotel2').val($('#hiddenHotel').val().replace('+', ' '));
//                loadHotelsFirstTime = false;
//            }
//        }
//    });
//}

//function getHotelNetworks(value) {

//    $.ajax({
//        url: "/Handlers/DomesticHotels.ashx",
//        dataType: "json",
//        data: { city: value, action: 'network' },
//        success: function (data) {
//            $('#hotelChainDomesticHotel').empty();
//            $('#ddlHotelChain').empty();
//            $('#hotelChainDomesticHotel').append($("<option></option>").attr('value', '').text('הכל'));
//            $('#ddlHotelChain').append($("<option></option>").attr('value', '').text('הכל'));
//            if (data != null && data.length > 0) {
//                for (i = 0; i < data.length; i++) {
//                    $('#hotelChainDomesticHotel').append($("<option></option>").attr('value', data[i].code).text(data[i].name));
//                    $('#ddlHotelChain').append($("<option></option>").attr('value', data[i].code).text(data[i].name));
//                }
//            }
//        },
//        complete: function () {
//            if (getQuerystring('destination') != $('#destinationDomesticHotel').val()) {
//                getHotels($('#destinationDomesticHotel').val());
//                return;
//            }
//            if ((typeof ($('#hiddenChain').val()) != "undefined" && $('#hiddenChain').val() != "") && loadChainFirstTime) {
//                $('#hotelChainDomesticHotel').val($('#hiddenChain').val().replace('+', ' '));
//                $('#ddlHotelChain').val($('#hiddenChain').val().replace('+', ' '));
//                loadChainFirstTime = false;
//            }
//            if (typeof ($('#hiddenChain').val()) != "undefined" && $('#hiddenChain').val() != "") {
//                getHotelsByNetwork($('#destinationDomesticHotel').val(), $('#hiddenChain').val());
//            }
//            //            else {
//            //                getHotelsNoChain();
//            //            }
//        }
//    });
//}

//function getHotelsByNetwork(destinationCode, net) {

//    $.ajax({
//        url: "/Handlers/DomesticHotels.ashx",
//        dataType: "json",
//        data: { city: destinationCode, network: net, action: 'hotelbynetwork' },
//        success: function (data) {
//            $('#ddlHotelDomesticHotel').empty();
//            $('#ddlHotel2').empty();
//            $('#ddlHotelDomesticHotel').append($("<option></option>").attr('value', '').text('הכל'));
//            $('#ddlHotel2').append($("<option></option>").attr('value', '').text('הכל'));

//            if (data != null && data.length > 0) {
//                for (i = 0; i < data.length; i++) {
//                    $('#ddlHotelDomesticHotel').append($("<option></option>").attr('value', data[i].code).text(data[i].name));
//                    $('#ddlHotel2').append($("<option></option>").attr('value', data[i].code).text(data[i].name));
//                }
//            }
//        },
//        complete: function () {
//            if ($('#hiddenHotel').val() != "" && loadHotelsFirstTime) {
//                $('#ddlHotelDomesticHotel').val($('#hiddenHotel').val().replace('+', ' '));
//                $('#ddlHotel2').val($('#hiddenHotel').val().replace('+', ' '));
//                loadHotelsFirstTime = false;
//            }
//        }
//    });
//}

//function ChangeStyle(search_result_page) {

//    if (search_result_page == "hotels") {
//        $('#a_domestic_packages').removeClass('act');
//        $('#a_domestic_flight').removeClass('act');
//        $('#a_domestic_hotel').addClass('act');
//    }

//    if (search_result_page == "packages") {
//        $('#a_domestic_hotel').removeClass('act');
//        $('#a_domestic_flight').removeClass('act');
//        $('#a_domestic_packages').addClass('act');

//    }

//    if (search_result_page == "internal_flights") {
//        $('#a_domestic_hotel').removeClass('act');
//        $('#a_domestic_packages').removeClass('act');
//        $('#a_domestic_flight').addClass('act');
//    }
//}

//function HandleClassChangeDomesticFlight() {
//    $('#div_domestic_hotel_name').hide();
//    $('#div_domestic_herkev').hide();
//    $('#div_domestic_nights').hide();
//    $('#div_domestic_rooms_count').hide();

//    $('#div_domestic_flight_adults').show();
//    $('#div_domestic_flight_children').show();
//    $('#div_domestic_flight_baby').show();
//    $('#div_domestic_flight_departure').show();
//    $('#div_domestic_flight_return_date').show();

//    $('#div_domestic_destination').hide();
//    $('#div_domestic_flight_destination').show();

//    $('#div_domestic_departure').removeClass("ddl-domestic-flight-departure-date-one-direction");
//    $('#div_domestic_departure').addClass("ddl-domestic-flight-departure-date");

//    $('#div_domestic_destination').removeClass('ddl-domestic-destination');
//    $('#div_domestic_departure').removeClass('ddl-domestic-departure');
//    $('#div_domestic_flight_return_date').removeClass('ddl-domestic-flight-hotel-return-date');
//    $('#div_domestic_departure').removeClass('ddl-domestic-flight-hotel-departure-date');
//    $('#div_domestic_flight_departure').removeClass('ddl-domestic-flight-hotel-destination');


//    $('#div_domestic_flight_return_date').addClass('ddl-domestic-flight-return-date');
//    $('#div_domestic_destination').addClass('ddl-domestic-flight-arrival');
//    $('#div_domestic_departure').addClass('ddl-domestic-flight-departure-date');
//}

//function HandlePositionsChangeDomesticFlight() {
//    $('#div_domestic_flight_departure').insertBefore('#div_domestic_flight_destination');
//    $('#div_domestic_departure').insertAfter('#div_domestic_flight_destination');
//    $('#div_domestic_flight_return_date').insertAfter('#div_domestic_departure');

//    $('#div_domestic_flight_adults').insertAfter('#div_sec_wizard');
//    $('#div_domestic_flight_children').insertAfter('#div_domestic_flight_adults');
//    $('#div_domestic_flight_baby').insertAfter('#div_domestic_flight_children');
//    $('#div_btn_submit').insertAfter('#div_domestic_flight_baby');

//}

//function HandleClassChangeDomesticHotel() {
//    $('#div_domestic_hotel_name').show();
//    $('#div_domestic_herkev').show();
//    //$('#div_domestic_nights').show();    
//    $('#div_domestic_destination').show();
//    $('#div_domestic_rooms_count').show();

//    $('#div_domestic_flight_adults').hide();
//    $('#div_domestic_flight_children').hide();
//    $('#div_domestic_flight_baby').hide();
//    $('#div_domestic_flight_departure').hide();
//    //$('#div_domestic_flight_return_date').hide();
//    $('#div_domestic_nights').hide();

//    $('#div_domestic_destination').show();
//    $('#div_domestic_flight_destination').hide();

//    $('#div_domestic_destination').addClass('ddl-domestic-destination');
//    //$('#div_domestic_departure').addClass('ddl-domestic-departure');
//    //$('#div_domestic_departure').removeClass("ddl-domestic-flight-departure-date-one-direction");
//    //$('#div_domestic_departure').addClass("ddl-domestic-flight-departure-date");
//    $('#div_domestic_herkev').addClass('ddl-domestic-herkev');
//    $('#div_domestic_destination').removeClass('ddl-domestic-flight-arrival');
//    //$('#div_domestic_departure').removeClass('ddl-domestic-flight-departure-date');
//    //$('#div_domestic_flight_return_date').removeClass('ddl-domestic-flight-hotel-return-date');
//    //$('#div_domestic_departure').removeClass('ddl-domestic-flight-hotel-departure-date');
//    $('#div_domestic_herkev').removeClass('ddl-domestic-flight-hotel-herkev');
    
//    $('#div_domestic_departure').removeClass("ddl-domestic-flight-departure-date-one-direction");
//    $('#div_domestic_departure').addClass("ddl-domestic-flight-departure-date");
//    $('#div_domestic_departure').removeClass('ddl-domestic-departure');
//    $('#div_domestic_flight_return_date').removeClass('ddl-domestic-flight-hotel-return-date');
//    $('#div_domestic_departure').removeClass('ddl-domestic-flight-hotel-departure-date');
//    $('#div_domestic_flight_return_date').addClass('ddl-domestic-flight-return-date');
//    $('#div_domestic_departure').addClass('ddl-domestic-flight-departure-date');
//}

//function HandlePositionsChangeDomesticHotel() {
//    $('#div_domestic_destination').insertAfter('#div_first_row');
//    $('#div_domestic_hotel_name').insertAfter('#div_domestic_destination');
//    $('#div_domestic_herkev').insertAfter('#div_sec_wizard');
//    //$('#div_domestic_departure').insertAfter('#div_domestic_herkev');
//    //$('#div_domestic_nights').insertAfter('#div_domestic_departure');
//    $('#div_domestic_herkev').insertAfter('#div_domestic_rooms_count');
//    $('#div_btn_submit').insertAfter('#div_domestic_herkev3');
//    $('#div_domestic_departure').insertAfter('#div_domestic_hotel_name');
//    $('#div_domestic_flight_return_date').insertAfter('#div_domestic_departure');
//}

//function HandleClassChangeDomesticPackages() {
//    $('#div_domestic_hotel_name').hide();
//    $('#div_domestic_destination').hide();
//    $('#div_domestic_flight_destination').hide();
//    $('#div_domestic_flight_adults').hide();
//    $('#div_domestic_flight_children').hide();
//    $('#div_domestic_flight_baby').hide();
//    $('#div_domestic_nights').hide();
//    $('#div_domestic_rooms_count').hide();

//    $('#div_domestic_flight_departure').show();
//    $('#div_domestic_herkev').show();
//    $('#div_domestic_departure').show();
//    $('#div_domestic_flight_return_date').show();
    
    
//    $('#div_domestic_herkev').addClass('ddl-domestic-flight-hotel-herkev');

//    $('#div_domestic_flight_departure').addClass('ddl-domestic-flight-hotel-destination');
//    $('#div_domestic_herkev').addClass('ddl-domestic-flight-hotel-herkev');

//    $('#div_domestic_departure').removeClass("ddl-domestic-flight-departure-date-one-direction");
//    $('#div_domestic_departure').addClass("ddl-domestic-flight-departure-date");

//    $('#div_domestic_departure').removeClass('ddl-domestic-departure');
//    $('#div_domestic_departure').removeClass('ddl-domestic-flight-departure-date');
//    $('#div_domestic_departure').addClass('ddl-domestic-flight-hotel-departure-date');

//    $('#div_domestic_flight_return_date').removeClass('ddl-domestic-flight-return-date');
//    $('#div_domestic_flight_return_date').addClass('ddl-domestic-flight-hotel-return-date');

//}

//function HandlePositionsChangeDomesticPackages() {

//    $('#div_domestic_flight_departure').insertAfter('#div_first_row');
//    $('#div_domestic_herkev').insertAfter('#div_domestic_flight_departure');

//    $('#div_domestic_departure').insertAfter('#div_sec_wizard');
//    $('#div_domestic_flight_return_date').insertAfter('#div_domestic_departure');

//}

//function ChangeToDomesticHotel() {
//    //--Wizard Promotion  Show\Hide
//    $('.domestic_wizard').hide();
//    $('.DomesticHotels_pwizard').show();

//    $("#lbl_departure_date_domestic").html("הגעה:");
//    $("#lbl_return_date_domestic").html("עזיבה:");
//    $("#lbl_domestic_herkev").html("הרכב 1 :");

//    $('.wizard_suggested_JS').hide();
//    $('.wizard_promotions_DomesticHotels_JS').fadeIn();

//    ChangeRoomsCount();

//    if ($('.wizard_promotions_DomesticHotels_JS').length > 0) {
//        $('#div_title_box_suggested').html('הצעות נבחרות למלונות בארץ');
//        $('.promotion_home_page_suggested_JS').slideDown();
//    } else {
//        $('.promotion_home_page_suggested_JS').slideUp();
//    }

//    ///========================

//    wizard_mode = 1;

//    $("#btn_submit").removeClass("margtop_btn_flight_multi");

//    $('#a_domestic_packages').removeClass('cb_wizard_new');
//    $('#a_domestic_flight').removeClass('cb_wizard_new');
//    $('#a_domestic_hotel').addClass('cb_wizard_new');


//    $('#a_domestic_packages').removeClass('act');
//    $('#a_domestic_flight').removeClass('act');
//    $('#a_domestic_hotel').addClass('act');

//    HandlePositionsChangeDomesticHotel();
//    HandleClassChangeDomesticHotel();
//    ChangeCadnitainNameForHotelMode();

//    //Fill Values 
//    fillValuesOfTemplatesInDDLs_DomesticHotels($('.ddl_roomsTemplates').val());
//    $("div.wizard_cb_wrapper_for_js").hide();
//    setDefaultFlightsForHotels();
//    showEilatOnDestination(true);

//}

////Change To domestic Flight
//function ChangeToDomesticFlight() {
//    //--Wizard Promotion  Show\Hide
//    $('.domestic_wizard').hide();
//    $('.DomesticFlights_pwizard').show();
//    $('#div_domestic_herkev').hide();
//    $('#div_domestic_herkev2').hide();
//    $('#div_domestic_herkev3').hide();
//    $('.wizard_suggested_JS').hide();
//    $('.wizard_promotions_DomesticFlights_JS').fadeIn();

//    $("#lbl_departure_date_domestic").html("יציאה:");
//    $("#lbl_return_date_domestic").html("חזרה:");

//    if ($('.wizard_promotions_DomesticFlights_JS').length > 0) {
//        $('#div_title_box_suggested').html('הצעות נבחרות לטיסות לאילת');
//        $('.promotion_home_page_suggested_JS').slideDown();
//    } else {
//        $('.promotion_home_page_suggested_JS').slideUp();
//    }
//    ///========================

//    wizard_mode = 2;

//    $('#a_domestic_hotel').removeClass('cb_wizard_new');
//    $('#a_domestic_packages').removeClass('cb_wizard_new');
//    $('#a_domestic_flight').addClass('cb_wizard_new');

//    $('#a_domestic_packages').removeClass('act');
//    $('#a_domestic_flight').addClass('act');
//    $('#a_domestic_hotel').removeClass('act');

//    HandleClassChangeDomesticFlight();
//    HandlePositionsChangeDomesticFlight();
//    ChangeCadnitainNameForFlightMode();

//    //Fill Values 
//    if (localStorage.getItem("DomesticFlights") == null) {
//        fillValuesOfTemplatesInDDLs_DomesticHotels($('.ddl_roomsTemplates').val());
//    }
    
//    ////Fill Default Value for Flights , if there isn't
//    if ($('#Room1ADomesticHotel').val() == '0' && $('#Room1CDomesticHotel').val() == '0' && $('#ddlBabyNumRoom1DomesticHotel').val() == '0') {
//        $('#Room1ADomesticHotel').val(1);
      
//    }

//    $("div.wizard_cb_wrapper_for_js").show();
//    showEilatOnDestination(true);

//}
////Change Format Of Candidate to flight format - adult child - baby
//function ChangeCadnitainNameForFlightMode() {
//    $("#Room1ADomesticHotel").attr('name', 'adult');
//    $("#Room1CDomesticHotel").attr('name', 'child');

//}
////Change Format Of Candidate to flight format - adult child - baby
//function ChangeCadnitainNameForHotelMode() {
//    $("#Room1ADomesticHotel").attr('name', 'Room1ADomesticHotel');
//    $("#Room1CDomesticHotel").attr('name', 'Room1CDomesticHotel');

//}
////Change To Domestic Packges Mode
//function ChangeToDomesticPackages() {
//    //--Wizard Promotion  Show\Hide
//    $('.domestic_wizard').hide();
//    $('.DomesticPackages_pwizard').show();
//    $('#div_domestic_herkev').hide();
//    $('#div_domestic_herkev2').hide();
//    $('#div_domestic_herkev3').hide();

//    $('.wizard_suggested_JS').hide();
//    $('.wizard_promotions_DomesticPackages_JS').fadeIn();
    
//    $("#lbl_departure_date_domestic").html("יציאה:");
//    $("#lbl_domestic_herkev").html("הרכב חדר :");

//    if ($('.wizard_promotions_DomesticPackages_JS').length > 0) {
//        $('#div_title_box_suggested').html('הצעות נבחרות לחבילות באילת');
//        $('.promotion_home_page_suggested_JS').slideDown();
//    } else {
//        $('.promotion_home_page_suggested_JS').slideUp();
//    }
//    ///========================
//    wizard_mode = 3;
        
//    $("#btn_submit").removeClass("margtop_btn_flight_multi");    
//    $('#div_domestic_herkev').removeClass('ddl-domestic-herkev');
//    $('#a_domestic_hotel').removeClass('cb_wizard_new');
//    $('#a_domestic_flight').removeClass('cb_wizard_new');
//    $('#a_domestic_packages').addClass('cb_wizard_new');

//    $('#a_domestic_packages').addClass('act');
//    $('#a_domestic_flight').removeClass('act');
//    $('#a_domestic_hotel').removeClass('act');

//    HandlePositionsChangeDomesticPackages();
//    HandleClassChangeDomesticPackages();
//    ChangeCadnitainNameForHotelMode();

//    //Fill Values 
//    fillValuesOfTemplatesInDDLs_DomesticHotels($('.ddl_roomsTemplates').val());
//    $("div.wizard_cb_wrapper_for_js").hide();
//    setDefaultFlightsForPackages();
//    showEilatOnDestination(false);
//}

//function showEilatOnDestination(_show) {
//    //for domestic package we do not display EILAT
//    if (_show) {
//        $("#originDomesticHotel option[value=ETH]").show();
//    } else {
//        $("#originDomesticHotel option[value=ETH]").hide();
//    }

//}
//function setDefaultFlightsForHotels() {
//    if ($("#ways").val() != 2) {
//        $('#div_domestic_flight_return_date').hide();
//        setDefault();
//    }
//}

//function setDefaultFlightsForPackages() {
//    if ($("#ways").val() != 2) {
//        $('#div_domestic_flight_return_date').show();
//        $('#ways').val('2');
//        setDefault();
//    }
//}
//function setDefault() {
//    $('#toDomesticHotel').val($("#fromDomesticHotel").val());
//    //$("#fromDomesticHotel").removeClass("fromDomesticHotel_large"); *lee
//    $(".returnFlights_js").addClass("activeCB");
//    $(".returnFlights_js").removeClass("notactiveCB");
//    $(".oneway_js").removeClass("activeCB");
//    $(".oneway_js").addClass("notactiveCB");
//}

//function ChangeRoomsCount() {
//    var roomsCount = parseInt($("#ddl_roomsCount").val());

//    switch (roomsCount) {
//        case (1):
//            {
//                if (IsSerachResultDomesticHotel) {
//                      $('#main_wizard').height('163px');
//                }
//                $('#backgroundImage').height('260px');
//                $("#div_domestic_herkev2").hide();
//                $("#div_domestic_herkev3").hide();
//                break;
//            }
//        case (2):
//            {
//                if (IsSerachResultDomesticHotel) {
//                    $('#main_wizard').height('163px');
//                }
//                $('#backgroundImage').height('260px');
//                $("#div_domestic_herkev2").show();
//                $("#div_domestic_herkev3").hide();
//                break;
//            }
//        case (3):
//            {
//                if (IsSerachResultDomesticHotel) {
//                    $('#main_wizard').height('214px');
//                }
//                $('#backgroundImage').height('310px');
//                $("#div_domestic_herkev2").show();
//                $("#div_domestic_herkev3").show();
//                break;
//            }
//        default:

//    }
//}

//function ShowRoomsPrices(obj) {
//    $(obj).prev().show();           
//}

//function CloseRoomsPrices(obj) {
//    $(obj).prev().hide();
//}
/* version number */
//-------------------
/* end version number */
var multiClickIndexes = [];

$(document).ready(function () {
    $('div.image_slider_JS').each(function () {
        $(this).initializeOneImageSlider();
    });
});

function ActivehotelsAbroad() {
    ActivehotelsAbroadInit();
    ActiveHotelAbprdFunction();
}

function ActivehotelsAbroadInit() {
    $("#ddl_room_count").change(function () {
        var RoomCount = $(this).find(":selected").val();
        $('.search_hotel_room_JS').hide();
        for (var i = 1; i <= RoomCount; i++) {
            $('#div_abroad_herkev_' + i).show();
        }
    });

    $("#txtCityHotelsAbroad").autocomplete({
        source: function (request, response) {
            $.ajax({
                url: "/Handlers/Destinations.ashx",
                dataType: "json",
                //data: { value: request.term },
                data: { value: request.term, vendorID: 17, method: 'hotelAbroad', onlyabroad: true },
                success: function (data) {
                    if (data != null && data.length > 0) {
                        if ($('#title_Hotel').length == 0 || $('#title_Hotel').hasClass('act')) {
                            response($.map(data, function (item) {
                                return { label: item.destinationName, value: item.destinationCode, cityCode: item.cityCode, destinationCode2: item.destinationCode2, countryCode: item.countryCode, shortName: item.shortName }
                            }));
                        }
                    }
                    else {

                    }
                }
            });
        },
        /*focus: function (event, ui) {
        $("#txtCity").val(ui.item.label);
        $("#txtCity").attr('shortName', ui.item.shortName);
        return false;
        },*/
        select: function (event, ui) {

            $('#trHotel').hide();
            $('#hiddenCityCodeHotelsAbroad').val(ui.item.cityCode);
            $('#CityHotelsAbroad').val(ui.item.value);
            $('#hiddenCountryHotelsAbroad').val(ui.item.countryCode);
            $("#txtCityHotelsAbroad").attr('shortName', ui.item.shortName);
            $("#txtCityHotelsAbroad").attr('code', ui.item.value);
            $("#txtCityHotelsAbroad").val(ui.item.label);
            setWizardControls();
            event.preventDefault();
            if (typeof ($('#hidTotalItems').val()) != "undefined" && $('#hidTotalItems').val() > 0) {
                //   getProducts();
            }

            initDatePickerFromHotelsAbroad();
        }
    });
}



function FillRoomsAboratHotel() {
    $(".search_hotel_room_JS").each(function (index) {
        if ($(this).is(':visible')) {
            fillValuesOfTemplatesInDDLs_Hotels((index + 1), $(this).find(":selected").val());
        }
    });
}



function fillValuesOfTemplatesInDDLs_Hotels(RoomNum, valueAtTemplatesDDL) {
    switch (valueAtTemplatesDDL) {
        case ('0'):
            $("#Room" + RoomNum + "AAbroadHotel").val(2);
            $("#Room" + RoomNum + "CAbroadHotel").val(0);
            break;
        case ('1'):
            $("#Room" + RoomNum + "AAbroadHotel").val(1);
            $("#Room" + RoomNum + "CAbroadHotel").val(0);
            break;
        case ('2'):
            $("#Room" + RoomNum + "AAbroadHotel").val(1);
            $("#Room" + RoomNum + "CAbroadHotel").val(1);
            break;
        case ('3'):
            $("#Room" + RoomNum + "AAbroadHotel").val(1);
            $("#Room" + RoomNum + "CAbroadHotel").val(2);
            break;
        case ('4'):
            $("#Room" + RoomNum + "AAbroadHotel").val(1);
            $("#Room" + RoomNum + "CAbroadHotel").val(3);
            break;
        case ('5'):
            $("#Room" + RoomNum + "AAbroadHotel").val(2);
            $("#Room" + RoomNum + "CAbroadHotel").val(1);
            break;
        case ('6'):
            $("#Room" + RoomNum + "AAbroadHotel").val(2);
            $("#Room" + RoomNum + "CAbroadHotel").val(2);
            break;
        case ('7'):
            $("#Room" + RoomNum + "AAbroadHotel").val(2);
            $("#Room" + RoomNum + "CAbroadHotel").val(3);
            break;
        case ('8'):
            $("#Room" + RoomNum + "AAbroadHotel").val(3);
            $("#Room" + RoomNum + "CAbroadHotel").val(0);
            break;
        case ('9'):
            $("#Room" + RoomNum + "AAbroadHotel").val(4);
            $("#Room" + RoomNum + "CAbroadHotel").val(0);
            break;
    }
}




function getProductsHotelOnly(token) {
    var hotelFullListCode = new Array();
    $('#ddlHotelhotelabroad').empty();

    var toDate = $('#toDeals').val(); //Hotels Abroads
    if (toDate == undefined || toDate == null) {
        toDate = $('#ToDeals').val(); //Abroad Deals (dynamic)
    }
    $.ajax({
        url: "/Handlers/HotelsMultiSelect.ashx",
        dataType: "json",
        async: true,
        cache: false,
        data: {
            token: token,
            board: $('#board').val(), rank: $('#rank').val(), destination: $('#CityDeals').val(), cityCode: $('#hiddenCityCodeDeals').val(),
            ddlCountry: $('#hiddenCountryDeals').val(), to: toDate, from: $('#fromDeals').val(),
            amount: $('#amount').val(), roomsnum: $('#ddlRoomsNumHotelsAbroad').val(),
            Room1A: $('#ddlAdultNumRoom1HotelsAbroad').val(), Room1C: $('#ddlChildNumRoom1HotelsAbroad').val(), Room1B: $('#ddlBabyNumRoom1').val(),
            pageResultsNumber: $('#PageResultsNumber').val(),
            destinationHotelsAbroad: $('#CityHotelsAbroad').val()
        },
        success: function (data) {

            if ($.trim(data) != "") {
                $('#ddlHotelhotelabroad').empty()
                var hotelFullListName = new Array();
                $('#ddlHotelhotelabroad').append($("<option></option>").attr("value", "").text("הכל"));
                for (i = 0; i < data.length; i++) {
                    $('#ddlHotelhotelabroad').append($("<option></option>").attr({ value: data[i].Code }).text(data[i].Name));
                    hotelFullListName[i] = data[i].Name;
                    hotelFullListCode[i] = data[i].Code;
                }
                shortenedSelect();
                $("#txtHotelsAbroad").autocomplete({
                    source: hotelFullListName,
                    autoFocus: true,
                    select: function (event, ui) {
                        setTimeout(submitFunction, 500, hotelFullListName, hotelFullListCode, ui); //the timeout is for catching select on enter and on mouse do not chnage - eyal 2016
                        $("#DEleteAutoSearch").show();
                    },
                    appendTo: '#txtHotelsAbroadContainer'

                }).keypress(function (e) { //disable enter key from autotcompleate if no item has been chosen
                    if (e.keyCode === 13) {
                        return false;
                    }

                });
                $('#trAbroadHotelhotelabroad').show();
            }
        },
        error: function () {

        },
        complete: function () {
            //initMultiSelect('ddlHotel');
        }
    });
}

//Get the selected hotel and send it to filter search
function submitFunction(nameList, codeList, ui) {
    if (nameList != null) {
        var index = $.inArray(ui.item.value, nameList)
        var selectedCodeByIndex = codeList[index];
        //   $('#txtHotelsAbroad').val(selectedCodeByIndex);
        $('#hid_txtHotelsAbroad').val(selectedCodeByIndex);
        DoFilter();
    }
    else {
        $('#txtHotelsAbroad').val(null);
        $('#hid_txtHotelsAbroad').val(null);
        DoFilter();
    }
}


function setPointOfIntrest(el, lat, lon, name, isDoFiler) {
    try {
        GTDataLayer.push({ 'event': 'hotels-search-results-filter-area' });

        var doFilter = isDoFiler;

        //clear previous selected 
        // "selected_JS" class is used for placing a flag on the map
        $(".point_of_interest_JS").removeClass("selected_JS");

        if ($(el).attr('checked')) {
            // clear all other checked:
            $(".area-filter .myinput").attr("checked", false);
            $(".area-filter span").removeClass("color_checked");
            // add checked classes:
            $(el).attr("checked", true);
            $(el).parent(".point_of_interest_JS").addClass("selected_JS");
            // Hide other sliders and update common input value:
            $(".distanceFilterRange").hide();
            $("#distanceSelected").val($(el).closest(".area-filter-wrap").find("input.innerDistanceSelected").val());
            $("#hiddenSelectedLatLon").val(lat + "," + lon);
            // show the slider of this point:
            $(el).closest(".area-filter-wrap").find(".distanceFilterRange").show();

            if (name) {
                $("#hiddenPoiName").val(name);
            }
        }
        else {
            // if uncheck clear input and hide slider:
            $("#hiddenSelectedLatLon").val("");
            $(".distanceFilterRange").hide();

            if (!$(".pois_cb_JS input:checkbox:checked").length > 0) {

                $('.pois_city_center_cb_true').trigger('click');
                doFilter = false;
            }
        }

        if (doFilter) {
            DoFilter(false, true);
        }
    } catch (ex) {

    }
}
function initMultiSelect(id) {

    if ($('#' + id).children('option').length > 0) {

        $('#' + id).multiselect('destroy');
        $('#' + id).multiselect({
            classes: 'hotelMultiSelect',
            open: function () {
                $('.ui-multiselect-menu').jScrollPane('destroy');
                $('.ui-multiselect-menu').jScrollPane({
                    scrollbarMargin: 0,
                    verticalDragMinHeight: 34,
                    wheelSpeed: 71
                });
                var pos = $('.hotelMultiSelect').position();
                $('.hotelMultiSelect').css('left', pos.left - 114 + 'px');
                $('.jspHorizontalBar').hide();
                $('.jspHorizontalBar .jspTrack').hide();
                $('.jspHorizontalBar .jspCorner').hide();
                $('.jspTrack').css('height', '148px');
                fillSelected();
            },
            header: false,
            checkAllText: '', // בחר הכל,
            uncheckAllText: '', // בטל הכל,
            height: 'auto',
            width: 'auto',
            show: ['fade', 500],
            multiple: true,
            autoOpen: false,
            noneSelectedText: 'בחר/י',
            selectedText: 'נבחרו # מלונות',
            close: function () {

            },
            click: function () {
                multiClickIndexes = [];
                var array_of_checked_values = $(this).multiselect("getChecked").map(function (index, item) {
                    return { index: $(item).parents('li').index(), name: this.value };
                }).get();
                var filters = "";
                for (i = 0; i < array_of_checked_values.length; i++) {
                    filters += array_of_checked_values[i].name + "|";
                    multiClickIndexes.push(array_of_checked_values[i].index);
                }
                $('input[name="filter"]').val(filters);
                DoFilter();
            }
        });
        $('#' + id).multiselect("uncheckAll");
        $('#ddlHotelhotelabroad option[value="-1"]').attr('selected', true);
        $('#trHotel').show();
    }
    else {
        $('#trHotel').hide();
    }
}

function fillSelected() {
    for (var i = 0; i < multiClickIndexes.length; i++) {
        $("#ddlHotelhotelabroad").multiselect("widget").find(":checkbox:eq(" + multiClickIndexes[i] + ")").attr('checked', true);
    }
}

function ClearAllExtraRoomsHTML() {
    for (var i = 2; i <= 5; i++) {

        if ($('#tblRoom' + i).length > 0) {
            $('#tblRoom' + i).html('');
        }

    }
}

function getDestination(countryCode) {

    $.ajax({
        url: "/Handlers/Destinations.ashx",
        dataType: "json",
        data: { code: countryCode, vendorID: 17, abroad: 1 },
        async: true,
        success: function (data) {
            $("#ddlDestination").empty();
            $('#ddlDestination').append($("<option></option>").attr("value", (-1)).text('בחר/י'));
            if (data != null && data != '') {
                for (var yy = 0; yy < data.rows.length; yy++) {
                    $('#ddlDestination').append($("<option></option>").attr({ value: (data.rows[yy].destinationCode), destination: (data.rows[yy].destinationCode2) }).text(data.rows[yy].destinationName));
                }
            }
        },
        error: function () {

        }
    });

}

function setWizardControls() {
    $('.showControl').show();
    $('.boxs').hide();
}




function getNewDetail(objData) {
    var postData = new Object({ "xmlData": objData });
    var urlForPost = $('#UrlForPost').val();

    $.ajax({
        type: 'POST',
        url: urlForPost,
        data: postData,
        success: function (data) {
            closedialog();
            $("#AlternativeColumn").html(data);
            if (window.location.href.indexOf("smartpromotion") == -1) {
                $("#returnToSearchResult").append('<a class="button marBottom10 back"></a><div class="dottedSpacer">&nbsp;</div>');
            }
            $('#galleryPic').nivoSlider({
                prevText: '',
                nextText: ''
            });

            // Start - Tabs
            $(".tabs ul li:first").addClass("activeTab").show();
            $(".tabs > div:first").show();
        }
    });
}



function postDataToSearchResults(data) {
    var urlForPost = $('#HandlerForPagingUrl').val();

    var postData = data;
    var postWrapper = { data: data };
    $.ajax({
        type: 'POST',
        url: urlForPost,
        //data: JSON.stringify(postWrapper),
        //dataType: "json",
        //contentType: "application/json; charset=utf-8",
        success: function (data) {
            $.address.value(rel);
            $('html, body').animate({ scrollTop: 0 }, 'fast');
            $("#CenterColumn").hide();
            $("aside.leftColumn").show();
            $("#AlternativeColumn").show();
            $("#AlternativeColumn").html(data);
            if (window.location.href.indexOf("smartpromotion") == -1) {
                $("#returnToSearchResult").append('<a class="button marBottom10 back"><span>&lt;&lt;&nbsp;חזרה לתוצאות החיפוש,</span></a><div class="dottedSpacer">&nbsp;</div>');
            }
            // Check if has images in galleryPic
            if ($('#galleryPic > *').size() > 0) {
                $('#galleryPic').nivoSlider({
                    prevText: '',
                    nextText: ''
                });
            }

            // Start - Tabs
            $(".tabs ul li:first").addClass("activeTab").show();
            $(".tabs > div:first").show();

            $('.PopupLoading').dialog("close");

        },
        error: function () {
            alert("ארעה תקלה בטעינת פרטי המוצר");
        }
    });

}

function legendHotels() {

    setTimeout(function () {
        if ($('.ulHolidays').length > 0) {
            $('.ulHolidays .datepicker-message').remove();
        }

        var legendHtmlStr = "<ul class='ulHolidays'><li><span class='index_calender_selected mr4'></span><span style='display:inline-block;line-height:17px;'>בחירה</span></li></ul><a class='cleanDates'></a>";

        var holidaysLegendStr = "<li class='holidays-legend'><span class='valid'><img src='/images/calendarHolidayIcon.png' width='18' height='17' alt='' /></span><span>חג</span></li>";

        // Set break row for the datepicker
        setDatepickerBreakRow(legendHtmlStr, holidaysLegendStr);
    }, 100)
}

var defaultSettingsHotelsAbroad = "";
var specialDays = [];
specialDays[0] = [];
specialDays[1] = [];
function ActiveHotelAbprdFunction() {

    initDatePickerFromHotelsAbroad();

    defaultSettingsHotelsAbroad = {

        //showButtonPanel: true,
        beforeShowDay: function (thedate) {
            var theday = thedate.getDate();
            var d = thedate.getDate() + "";
            var m = thedate.getMonth() + 1;
            var yerrr = thedate.getFullYear();
            var key = d + "/" + m + "/" + yerrr;

            if (this.id == "toHotelsAbroad") {
                var fromDate = parseDate($("#fromHotelsAbroad").val());
                if (fromDate.getDate() == thedate.getDate() && fromDate.getMonth() == thedate.getMonth() && fromDate.getFullYear() == thedate.getFullYear()) {
                    return [true, "ui-state-disabled ui-datepicker-unselectable ui-state-disabled-start-date"];
                }
            }

            if (typeof (specialDays[1]) != "undefined") {
                if (typeof (specialDays[1][key]) != "undefined") {
                    if (typeof (specialDays[0][key]) != "undefined") {
                        return [true, 'charterholiday', specialDays[0][key]];
                    }
                    else {
                        return [true, 'charter', specialDays[1][key]];
                    }
                }
            }

            if (typeof (specialDays[0]) != "undefined") {
                if (typeof (specialDays[0][key]) != "undefined") {
                    return [true, 'holiday', specialDays[0][key]];
                }
            }

            return [true, ''];
        },
        beforeShow: function (input, inst) {

            //Datepicker animation
            $(this).datepicker("option", "showAnim", "fadeIn");
            doDatePickerPositionHandle(input);

            setDP_classesForJS("False");

            legendHotels();

            if (!$('.ui-datepicker').parent().hasClass('wrap')) {
                $('.ui-datepicker').wrap("<div class='wrap' id='calendarWrapper'></div>");

            }
            $('.ui-datepicker').parent().removeClass('from').removeClass('to');

            $('.ui-datepicker').parent().addClass(inst.id);

            if (inst.id == "toHotelsAbroad") {

                setDP_classesForJS("True");

                doDatePickerDateRange();

                var fromDate = parseDate($("#fromHotelsAbroad").val());
                var toDate = new Date(fromDate);
                toDate.setDate(fromDate.getDate());
                $("#toHotelsAbroad").datepicker("option", "minDate", toDate);
                $("#toHotelsAbroad").datepicker("refresh");
            }

        },
        onChangeMonthYear: function (year, month, inst) {
            legendHotels();
            //            GetSpecialDates(year, month, function () {
            //                $("#from").datepicker("refresh");
            //                $("#to").datepicker("refresh");
            //            });
        },
        defaultDate: "+1w",
        numberOfMonths: 2,
        onSelect: function (selectedDate) {
            //            var option = this.id == "from" ? "minDate" : "maxDate",
            instance = $(this).data("datepicker"),
                     date = $.datepicker.parseDate(
                         instance.settings.dateFormat ||
                         $.datepicker._defaults.dateFormat,
                         selectedDate, instance.settings);
            //            dates.not(this).datepicker("option", option, date);
            setWizardAfterDateChangeHotelsAbroad();
            if (this.id == "fromHotelsAbroad") {
                setTimeout(function () {
                    $("#toHotelsAbroad").datepicker("setDate", selectedDate);
                    $("#toHotelsAbroad").datepicker("option", "minDate", addDaysToDate(date, 1));
                    $("#toHotelsAbroad").datepicker("show");
                }, 100);
            }
            $(".searchPeriod").attr("checked", false);
        },
        minDate: $('#hiddenTodayHotelsAbroad').val(),
        showOtherMonths: true,
        showMonthAfterYear: false,
        monthNames: ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'],
        monthNamesShort: ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'],
        dayNamesMin: ['א', 'ב', 'ג', 'ד', 'ה', 'ו', 'ש'],
        dateFormat: 'dd/mm/yy'
    }
    var dates = $("#fromHotelsAbroad, #toHotelsAbroad").datepicker(defaultSettingsHotelsAbroad);

    $("#ui-datepicker-div").addClass("datepickerWrapper");
    setWizardAfterDateChangeHotelsAbroad();
    $('.cleanDates').live('click', function () {
        $("#fromHotelsAbroad, #toHotelsAbroad").val('');
    });

    var currentDate = new Date();

    GetSpecialDates(currentDate.getFullYear(), currentDate.getMonth() + 1, function () {
        $("#fromHotelsAbroad").datepicker("refresh");
        $("#toHotelsAbroad").datepicker("refresh");
        //rePaint();
    });

    $('#fromHotelsAbroad,#toHotelsAbroad').focus(function (e) {
        e.preventDefault();
        e.stopPropagation();
        $(this).datepicker('show');
    });

}

function initDatePickerToHotelsAbroad() {

    instance = $('#toHotelsAbroad').data("datepicker");
    date = $.datepicker.parseDate(instance.settings.dateFormat || $.datepicker._defaults.dateFormat, $('#toHotelsAbroad').val(), instance.settings);

}

function initDatePickerFromHotelsAbroad() {

    specialDays[0] = [];
    specialDays[1] = [];
    legendHotels();

    setTimeout(function () {
        var date = $.datepicker.parseDate("dd/mm/yy" || $.datepicker._defaults.dateFormat, $('#fromHotelsAbroad').val());
        if (date == null)
            date = new Date();

        initDatePickerToHotelsAbroad();

    }, 100);
}

function setWizardAfterDateChangeHotelsAbroad() {

    if ($.trim($('#fromHotelsAbroad').val()) != '' && $.trim($('#toHotelsAbroad').val()) != '') {
        var dateFrom = new Date($('#fromHotelsAbroad').datepicker('getDate').getFullYear(), $('#fromHotelsAbroad').datepicker('getDate').getMonth(), $('#fromHotelsAbroad').datepicker('getDate').getDate());
        var dateTo = new Date($('#toHotelsAbroad').datepicker('getDate').getFullYear(), $('#toHotelsAbroad').datepicker('getDate').getMonth(), $('#toHotelsAbroad').datepicker('getDate').getDate());
        var ONE_DAY = 1000 * 60 * 60 * 24;
        var difference_ms = Math.abs(dateFrom.getTime() - dateTo.getTime());

    }
}

function NightsChanged(nights) {
    if (nights == -1) {
        return;
    }
    var strDate = $('#fromHotelsAbroad').val();
    var dateParts = strDate.split("/");
    var d = new Date(dateParts[2], (dateParts[1] - 1), dateParts[0]);
    d = addDays(d, Number(nights));
    $('#toHotelsAbroad').val(addZero(d.getDate(), 'day') + "/" + addZero(Number(d.getMonth()), 'month') + "/" + d.getFullYear());
}

function addZero(num, dateCase) {
    switch (dateCase) {
        case "month":
            num++;
            break;
        default:
            break;
    }

    if (num < 10) {
        return "0" + num;
    }
    return num;
}

function addDays(myDate, days) {
    return new Date(myDate.getTime() + days * 24 * 60 * 60 * 1000);
}

function finishLoadHotel() {

    if (typeof (window.FixHeight) == "function") {
        FixHeight();
    }
    formDeserialize();

    if (($('#hiddenCountryHotelsAbroad').val() != null && $.trim($('#hiddenCountryHotelsAbroad').val()) != '') && ($('#CityHotelsAbroad').val() != null && $.trim($('#CityHotelsAbroad').val()) != ''))
        initSelectionHotel($('#hiddenCountryHotelsAbroad').val(), $('#CityHotelsAbroad').val());

    if (getQuerystring('from') != "")
        setWizardControls();

    ddlRoomsNum_Change($('#ddlRoomsNumHotelsAbroad').val());
}

function initSelectionHotel(countryCode, destinationCode) {
    $.ajax({
        url: "/Handlers/Destinations.ashx",
        dataType: "json",
        data: { method: 'initSelectionHotelHG', destinationcode: destinationCode },
        success: function (data) {
            $('#txtCityHotelsAbroad').val(data.destinationName);
            $("#txtCityHotelsAbroad").attr('shortName', data.shortName);
            $("#txtCityHotelsAbroad").attr('code', destinationCode);
            //if ($('.hiddenContainer').length > 0)
            //    getProducts();
        }
    });
}

function GetSpecialDates(year, month, callback) {
    var url = "";
    var action = "hotels";
    url = "/Handlers/CalanderDates.ashx?m=" + month + "&y=" + year + "&city=" + $('#hiddenCity').val() + "&country=" + $('#hiddenCountryHotelsAbroad').val() + "&actioncharter=" + action;

    $.ajax({
        type: 'GET',
        url: url,
        async: false,
        cache: true,
        jsonpCallback: 'DatesCallBack',
        contentType: "application/json",
        dataType: 'jsonp',
        success: function (dates) {

            var tempo = dates.data;
            for (var i in tempo[0]) {
                specialDays[0][i] = tempo[0][i];
            }
            for (var x in tempo[1]) {
                specialDays[1][x] = tempo[1][x];
            }

            callback();
        }
    });
}

function RoomOptionSwitch() {

    $(".btn_select_comain").click(function () {

        var selcted_option = $(this).closest('.room_info_wrapper_abroad');
        var clone = $('<div class="room_info_wrapper_abroad select" style="position:absolute" >' + selcted_option.html() + '</div>');
        var c_top = $('.selcted_room').offset().top;
        var c_left = selcted_option.offset().left - $('.selcted_room').offset().left;
        clone.css('left', $('.selcted_room').offset().left + 'px')
        clone.css('top', selcted_option.offset().top + 'px')
        clone.insertAfter('#transporter_option');


        //Save Curr Dll Borad Price
        var SelctedBoradVal = selcted_option.find(".boardBasisName").filter(':visible').find(":selected").val();
        var newPrice = clone.find('.roomPrice').text();
        var Price = $("<span class=\"roomPrice spanMainRoomPrice color_red fs35\" style=\"position:absolute;z-index:999\">" + clone.find('.roomPrice').text() + "</span>");
        Price.insertAfter('#price_selcted');
        Price.css('left', clone.find('.roomPrice').offset().left + 'px');
        Price.css('top', clone.find('.roomPrice').offset().top + 'px');


        clone.find(".boardBasisName").filter(':hidden').val(SelctedBoradVal);
        clone.find(".boardBasisName").filter(':visible').val(SelctedBoradVal);

        clone.hide();

        var cur_price_top = $("#total_price").offset().top;
        var cur_price_left = $("#total_price").offset().left;;
        var cur_selcted_option = $('.selcted_room');
        var cur_clone = $('<div class="room_info_wrapper_abroad change_room_box" style="position:absolute">' + cur_selcted_option.html() + '</div>');
        var cur_top = selcted_option.offset().top;
        var cur_left = selcted_option.offset().left;
        cur_clone.css('left', selcted_option.offset().left + 'px')
        cur_clone.css('top', $('.selcted_room').offset().top + 'px')
        cur_clone.find('.cancelation_policy').hide();
        cur_clone.insertAfter('#transporter_selcted');
        var room_option_pos = selcted_option.find('input[type=hidden]:first').val();
        //מעביר את המחיר
        Price.animate({
            top: cur_price_top + 10,
            left: cur_price_left,
            opacity: 1
        }, 500, function () {
            Price.remove();
            $("#total_price").text(newPrice);

            //מעיבר מלמעלה למטה
            cur_clone.animate({
                top: cur_top,
                opacity: 1
            }, 300, function () {
                cur_clone.find('.cancelation_policy').show();

                cur_clone.insertAfter('.' + room_option_pos);
                cur_clone.css('position', 'relative');
                cur_clone.css('left', '0px')
                $('.' + room_option_pos).remove();
                cur_clone.addClass(room_option_pos);
                cur_clone.find('.price_per_one_room_main').hide();
                cur_clone.find('.price_per_one_room').show();
                //If there is no hidden id 
                if (cur_clone.find('input[type=hidden]:first').val().indexOf('room_option_') == -1) {
                    cur_clone.prepend(selcted_option.find('input[type=hidden]:first'));
                }

                SelectBoradEvantChange(cur_clone.find('.boardBasisName'));
                setDivLocation(false);
                clone.show();
                //מעביר מלמטה למעלה
                clone.animate({
                    top: c_top,
                    opacity: 1
                }, 800, function () {
                    clone.insertAfter('#transporter_selcted');
                    clone.css('position', 'static');
                    clone.css('left', '0px')
                    $('.selcted_room').remove();
                    clone.addClass('selcted_room');
                    clone.find('.price_per_one_room_main').show();
                    clone.find('.price_per_one_room').hide();
                    clone.find('input[type=hidden]:first').remove();

                    //Set New Local Price For Comperesion Of cancelation Policy
                    var SelctedBeforeDiscontPrice = clone.find(".boardBasisName").filter(':visible').find(":selected").attr('o_price');
                    $('#hdn_o_price').val(SelctedBeforeDiscontPrice);
                    ShowSelectCanceletionPolicy();
                    RoomOptionSwitch();

                });

            });


        });

    });

}

function setDivLocation(animate) {
    if (animate) {
        $('.change_room_box').animate({ top: div_px_to_move + "px" });

    }
    else {
        $('.change_room_box').css('top', div_px_to_move + "px");

    }
    if (div_step == div_count - 1) {
        $('#scroll_down').css('visibility', 'hidden');
    }
    else {
        $('#scroll_down').css('visibility', 'visible');

    }
    if (div_step == 0) {
        $('#scroll_up').css('visibility', 'hidden');
    }
    else {
        $('#scroll_up').css('visibility', 'visible');

    }
}

function showErrorPopUpDialog() {
    $("#dialog_price_chane").dialog({
        autoOpen: true,
        modal: false,
        height: 200,
        width: 410,
        open: function (event, ui) {
            $('.ui-widget-overlay').bind('click', function () { $("#dialog_price_chane").dialog('close'); });
            $('.popup_canc_btn').show();
            $('.parg_can').show();
            $('.popup_serach_again_btn ').hide();
        },
        close: function (event, ui) {
            $('.popup_canc_btn').hide();
            $('.parg_can').hide();
            $('.popup_serach_again_btn ').hide();

        },
        buttons: {
            OK: function () {
                $(this).dialog("close");
                parent.history.back();
            }

        },
        dialogClass: 'ErrorPopUp'

    });
    $('.ErrorPopUp .ui-button-text:contains(OK)').text('חזור');
}
function hideErrorPopUpDialog() {
    $('#dialog_price_chane').hide();
}
function AddToHotelBasket() {
    if (typeof (initSmallLoader) == 'function') {
        initSmallLoader();
    }

    var infoImg = $('.imggalery_div').attr('src');
    var selcted_option = $('.selcted_room').closest('.room_info_wrapper_abroad');
    var SelctedBoradUniqID = selcted_option.find(".boardBasisName").filter(':visible').find(":selected").attr('uniqid');
    var rooms = [];
    var products = [];
    var serializedObjects = [];
    var producttype = 'Hotel';
    //If Dynamic PackagesPre Book flight first
    if ($('.SerializedItinerary').length > 0) {
        producttype = "Deals";
        serializedObjects.push($(".SerializedItinerary").val());
        var preData = new Object({ "data": JSON.stringify(serializedObjects) });
        $.ajax({
            type: 'POST',
            url: GlobalAppRootJS + "/Handlers/CheckFlightPreBook.ashx",
            data: preData,
            async: true,
            success: function (data) {
                if (data == "") {
                    if (typeof (CloseSmallLoader) == 'function') {
                        CloseSmallLoader();
                    }
                    showErrorPopUpDialog();
                    return;
                }
                else {
                    products.push(data);
                    AddToBasketHotelOnly(products, producttype, rooms, SelctedBoradUniqID, infoImg);
                }
            },
            error: function (request, status, error) {
                if (typeof (CloseSmallLoader) == 'function') {
                    CloseSmallLoader();
                }
                showErrorPopUpDialog();
                return;
            },
            complete: function () {

            }
        });

    }
    else {
        AddToBasketHotelOnly(products, producttype, rooms, SelctedBoradUniqID, infoImg);
    }



}

//בחבילה דינמאית שבאה מקידום אנחנו יוצאים לחיפוש נוסף על מנת לאמת את פרטי הטיסה מחדש
function SetHotelOrDynamicPackagesLogic(FromSerachResult, HotelOnly, hotelPrice) {


    $.ajax({
        type: 'POST',
        url: GlobalAppRootJS + "/Handlers/GetDataForDynamicPromotion.aspx",
        data: {
            Hotel: $('#SerializeHotel').val(),
            Flight: $('.SerializedItinerary').val(),
            FromSerachResult: FromSerachResult,
            HotelOnly: HotelOnly
        },
        async: true,
        cache: false,
        success: function (data) {

            //הצלחנו לקבל טיסה
            if (data != "") {
                //Error!!!
                if (data.indexOf('ERROR') >= 0) {
                    showErrorPopUpDialog();
                }
                else {
                    var Product = data.split('#####SPLITER#####');
                    if (Product.length == 2) {
                        //Flight
                        //Get old Price for compering after getting new object
                        var old_price = Math.floor(hotelPrice);
                        if (!HotelOnly) {
                            var HtmlData = $(Product[1]);
                            HtmlData.insertAfter($('#hotel_flight_position'));
                            old_price += Math.floor($('#hdn_fprice').val());
                        }

                        //Hotel
                        var HtmlDataRoom = $(Product[0]);
                        HtmlDataRoom.insertAfter($('#room_place'));
                        //Get new Price for compering after getting new object
                        var new_price = Math.floor($('#hdn_total_price').val());
                        if (Token != '' && AreqForDetails != '') {
                            ShowSelectCanceletionPolicy(false);
                        }

                        // Check if price chenged and show warning (only if hotel price from Hotel GW is updated if not we send alert before this function)
                        if (!priceChange && Math.abs(old_price - new_price) > 1) {
                            $("#dialog_flight_price_changed").dialog({
                                autoOpen: true,

                                //height: 250,
                                width: 500,
                                open: function (event, ui) {


                                },
                                close: function (event, ui) {


                                    $(this).dialog("close");
                                },
                                buttons: {
                                    OK: function () {
                                        $(this).dialog("close");
                                    }
                                },
                                dialogClass: 'ErrorPopUp'
                            });
                            $('.ui-button-text:contains(OK)').text('אישור');
                        }
                        RoomOptionSwitch();
                        $('.AddToBasket').bind('click', function () {
                            AddToHotelBasket();
                        });
                    }
                }
            }
        },
        //General Error Msg
        error: function (request, status, error) {
            showErrorPopUpDialog();
        },
        complete: function () {
            CloseSmallLoader();
            // $("#loadingPopupSmall_dynamic_promotion").dialog("close");
        }
        , beforeSend: function () {
            if (typeof (initSmallLoader) == 'function') {
                PreventClosingPopUpinMasterPage = true;
                initSmallLoader();
            }
            $('.flight_control_dynamic').remove();
            $('#SerializeHotel').remove();

        }

    });
}


function AddToBasketHotelOnly(products, producttype, rooms, SelctedBoradUniqID, infoImg) {

    $.ajax({
        url: "/Handlers/HotelGWfilteringBeforeBaskter.ashx",
        type: "POST",
        cache: false,
        data:
            {
                Hotel: $('#SerializeHotel').val(),
                BoradBaseUniqID: SelctedBoradUniqID,
                InfoImg: infoImg,
                isFromCampaigns: isFromCampaigns,
                CancellationPolicy: $('#rem_spn_cancel_description').html(),
                CancellationPolicyLimitDate: $('#rem_spn_cancel_limit_date').html()

            },
        beforeSend: function () {


        },
        success: function (data) {
            var arr = data.split('#####ROOMSPLIT#####');
            $.each(arr, function (index, value) {
                if (index == 0) {
                    products.push(value);

                }
                else {
                    rooms.push(value);

                }

            });
            var postData = new Object({ "xmlData": JSON.stringify(products), "passengers": "", "producttype": producttype, "Rooms": JSON.stringify(rooms), "SessionId": $("#InstantSessionId").val() });
            $.ajax({
                type: 'POST',
                url: "/Handlers/user/UserSession.aspx?action=ADDTOBASKET",
                data: postData,
                beforeSend: function () {

                },
                success: function (data) {
                    $.ajax({
                        type: 'POST',
                        url: "/Handlers/user/UserSession.aspx?action=PREBOOKING",
                        success: function (data) {

                            if (data != "") {
                                alert(data);
                            }
                            else {
                                PostBasket(producttype);
                            }

                        }
                    });



                },
                error: function (request, status, error) {
                    if (typeof (CloseSmallLoader) == 'function') {
                        CloseSmallLoader();
                    }

                    return;
                }
            });

        },
        error: function (xhr, status, error) {
            if (typeof (CloseSmallLoader) == 'function') {
                CloseSmallLoader();
            }
        },
        complete: function () {
            //initMultiSelect('ddlHotel');
        }
    });

}
function closeHotelDetailsPopup(obj) {
    $(obj).parents(".hotel_details_popup").slideUp(400);
}

function getHotelLiteHotelData(obj, evt, token, AUniqForDetails) {
    // close other popups:
    $(obj).closest('.post_flight').siblings('.post_flight').find(".hotel_details_popup").slideUp(400);

    // scroll page to see all the popup:
    $("html, body").animate({ scrollTop: evt.pageY - 250 + "px" }, 1000);

    //Send params to google analytics
    GTDataLayer.push({ 'event': 'hotels-search-results-click-hotel-details-button' });

    var popUp = $(obj).closest('.post_flight').find("div.hotel_details_popup");
    popUp.slideToggle(400);

    // if the popup is not filled with data go get data:
    if (popUp.find(".hotel_info_text").length == 0) {
        $.ajax({
            url: "/Handlers/GetHotelLiteInfoPopup.aspx",
            async: true,
            cache: false,
            data: {
                token: token,
                AUniqForDetails: AUniqForDetails
            },
            success: function (data) {
                popUp.find('.inner_hotel_info').html(data);
                if (popUp.find('div.image_slider_wrapper').length > 0) { popUp.find('div.image_slider_wrapper').initializeSlider(); }
                popUp.find('img').css('opacity', '1')
            },
            error: function (error) {
                popUp.find('.inner_hotel_info').html("<div class='hotel_info_text text_center'>אין מידע להצגה</div>");
                $(obj).parents(".hotel_details_popup").slideUp(400);
            },
            complete: function () {

            }
        });
    }
}

//Fill in the image list  // send from 
function getHotelImageListData(obj, token, AUniqForDetails) {
    $.ajax({
        url: "/Handlers/GetHotelImageListInfoPopup.aspx",
        async: true,
        cache: false,
        data: {
            token: token,
            AUniqForDetails: AUniqForDetails
        },
        success: function (data) {
            $(obj).find(".image_slider_wrapper").html(data);
            $(obj).find(".image_slider_wrapper").initializeOneImageSlider();
        },
        error: function (error) {
            $(obj).find(".image_slider_wrapper").html("");
            //  $(obj).parents(".hotel_details_popup").slideUp(400);
        },
        complete: function () {

        }
    });


    //$("html, body").animate({ scrollTop: evt.pageY - 250 + "px" }, 1000);
    ////if the popup does not have this div, it means that the popup is empty, we get the info from hanlder
    //if (!popUp.find("div.hotel_info_text").length > 0) {
    //    var serializedObj = $(obj).parents("div.search_item_main").find("input.ListObject").val();
    //    var postData = new Object({
    //        "data": serializedObj
    //    });

    //    $.ajax({
    //        type: 'POST',
    //        url: GlobalAppRootJS + "/Handlers/GetDealLiteInfoPopup.aspx",
    //        data: postData,
    //        success: function (data) {
    //            popUp.find('.inner_hotel_info').html(data);
    //            popUp.find('div.image_slider_wrapper').initializeSlider();

    //        }
    //    });
    //}
}


function getHotelInfo(token, AUniqForDetails, ForCrossSell, CrossSellCursorRefernce) {
    //Google Analytics Evant
    if (ForCrossSell) {
        _gaqfor_cross_sell.push(['_trackEvent', 'flights', 'cshoteldetails', '{iatacode}'])
    }


    $.ajax({
        url: "/Handlers/HotelGWInfo.ashx",
        dataType: "json",
        async: true,
        cache: false,
        data: {
            token: token,
            AUniqForDetails: AUniqForDetails

        },
        success: function (data) {
            if (ForCrossSell) {
                $('#hotel_description_cross_sell').text(data.Description);
            }
            else {

                if ($('#hotel_description').length > 0) {
                    $('#hotel_description').text(data.Description);
                }
                    //For Product Page Dynamic Packages
                else if ($('#hotelShortDescription').length > 0) {
                    $('#hotelShortDescription').text(CutDisplayedText(data.Description, 200));
                    if (data.Description.length > 200) {
                        $('.hotelShortDescription_read_more_js').show();
                    }
                    $('#hotelFullDescription').text(CutMoreText(data.Description, 200));
                    $('.hotel_description').show();

                }
            }
            var HlFacilityList = [];;
            var RlFacilityList = [];;

            for (var k in data.pHotelDealFacilityList) {
                if (data.pHotelDealFacilityList[k].Type == "H") {
                    HlFacilityList.push(data.pHotelDealFacilityList[k]);
                }
                else if (data.pHotelDealFacilityList[k].Type == "R") {
                    RlFacilityList.push(data.pHotelDealFacilityList[k]);
                }
            }
            if (ForCrossSell) {
                $('#hotel_facility_wrapp_cross_sell').html('');
                $('#room_facility_wrapp_cross_sell').html('');
            }
            if (HlFacilityList.length > 0 || RlFacilityList.length > 0) {
                var h_child = $("#hotel_facility").tmpl(HlFacilityList);
                var r_child = $("#room_facility").tmpl(RlFacilityList);
                if (ForCrossSell) {
                    h_child.appendTo($('#hotel_facility_wrapp_cross_sell'));
                    r_child.appendTo($('#room_facility_wrapp_cross_sell'));
                }
                else {


                    h_child.appendTo($('#hotel_facility_wrapp'));
                    r_child.appendTo($('#room_facility_wrapp'));
                    //For Dynamic Packages
                    if ($('#hotelFacilities li').length > 0) {
                        $('#hotelFacilities').show();
                        $('#_5').show();
                    }
                    if ($('#roomFacilities li').length > 0) {
                        $('#roomFacilities').show();
                        $('#_5').show();
                    }
                }

            }
            else {
                //For Dynamic Packages
                if ($("#navigationMenu #5").length == 0) {
                    $("#navigationMenu #5").parent().remove();
                    $("#_5").hide();
                }
                $('#facility_list').remove();
            }
            //Get Hotel Address and Map for cross sell
            if (ForCrossSell) {
                $('.show_map_cross_sell_link').hide();
            }
            if (($('#spn_hotel_address').text() == '' && data.Address != '') || (ForCrossSell && data.Address != '')) {
                if (ForCrossSell) {
                    $('#spn_hotel_address_cross_sell').text(data.Address);
                }
                else {
                    $('#spn_hotel_address').text(data.Address);

                }
                if (ForCrossSell) {
                    $.ajax({
                        url: "/Handlers/GetMapForCrossSell.aspx",
                        dataType: "html",
                        async: true,
                        cache: false,
                        type: "POST",
                        data: {
                            Address: data.Address,
                        },
                        success: function (data) {
                            if (data != '') {
                                $('.show_map_cross_sell_link').show();
                                var HtmlData = $(data);
                                $("#hotel_map_position").append(HtmlData);
                                try {
                                    //Active Map
                                    initialize();
                                }
                                catch (e) {
                                }
                            }
                        }
                    });
                }
            }
            //אם אין תמונות מייצר תמונות מהפרטי מלון
            if (data.pImageList.length > 0) {
                $('#div_gallery_wrap_hg').remove();
                $.ajax({
                    url: "/Handlers/LoadHGGallery.aspx",
                    dataType: "html",
                    async: true,
                    cache: false,
                    type: "POST",
                    data: {
                        Images: JSON.stringify(data.pImageList),
                        ForCrossSell: ForCrossSell,
                    },
                    success: function (data) {
                        var HtmlData = $(data);
                        if (ForCrossSell) {
                            $("#hotel_images_position_cross_sell").append(HtmlData);
                        }
                        else {
                            HtmlData.insertAfter("#hotel_images_position");

                        }
                        try {
                            ActiveGallery();
                        }
                        catch (e) {
                            //TODO: Gallery error msg
                        }
                    },
                    error: function () {
                    },
                    complete: function () {

                    }
                });
            }

        },
        error: function () {

        },
        complete: function () {
            if (ForCrossSell) {
                $('#hotel_detials_popup').show();
                $(".popup_wrapper_hotel_detials").center();

                $(".closeHotelDetialsInfo").position({
                    my: "left top",
                    at: "left top",
                    of: ".popup_wrapper_hotel_detials"
                });
                $(CrossSellCursorRefernce).css('cursor', 'pointer');
            }
            else {
                if ($('.flight_control_dynamic').length == 0) {
                    $('.flight_control_dynamic').insertAfter($('#hotel_images_position'));
                }
                $('#div_load_info').hide();
                $('.hotel_more_info').show();

            }

            try {
                //Active Map
                initialize();
            }
            catch (e) {
            }

        }
    });
}

function SelectBoradEvantChange(obj) {
    var selcted_option = $(obj).closest('.room_info_wrapper_abroad');
    var SelctedBoradText = selcted_option.find(".boardBasisName").filter(':visible').find(":selected").text();
    var SelctedBeforeDiscontPrice = selcted_option.find(".boardBasisName").filter(':visible').find(":selected").attr('o_price');
    var SelctedPrice = $(obj).val();
    selcted_option.find('.spn_selcted_borad_base').text(SelctedBoradText);
    //לחדרים מוצעים
    if ($(obj).closest('.price_per_one_room').find('.roomPrice').is(':visible')) {
        $(obj).closest('.price_per_one_room').find('.roomPrice').text(SelctedPrice);
    }
        //לחדר שנבחר
    else {
        //Set priceBeforeDis In hdn field 
        $('#hdn_o_price').val(SelctedBeforeDiscontPrice);
        $('#total_price').text(SelctedPrice);
        //Refresh Cencaltion Policy
        ShowSelectCanceletionPolicy();
    }
    selcted_option.find(".boardBasisName").filter(':hidden').val(SelctedPrice);
    $('.like_billion_Price .price_only').text(SelctedPrice);

}

function ShowCancellationPolicy(_request) {
    //שלא ילחצו כמה פעמים i am busy
    if ($(_request).css('cursor') == 'wait') {
        return;
    }
    $(_request).css('cursor', 'wait');
    var selcted_option = $(_request).closest('.room_info_wrapper_abroad');
    var SelctedBoradUniqID = selcted_option.find(".boardBasisName").filter(':visible').find(":selected").attr('uniqid');
    $.ajax({
        url: "/Handlers/HotelGWCancellationPolicy.ashx",
        dataType: "json",
        async: true,
        type: "POST",
        cache: false,
        data:
            {
                Hotel: $('#SerializeHotel').val(),
                BoradBaseUniqID: SelctedBoradUniqID
            },
        success: function (data) {
            if (data.CancellationPolicy != null) {
                $('#CancellationPolicy_dialog_text').html(data.CancellationPolicy);
                $('.CancellationPolicy_dialog_text').show();
            }
            else {
                $('.CancellationPolicy_dialog_text').hide();
            }
            if (data.CancellationPolicyLimitDate != null) {
                $('#spn_cnclpolicy_limit_date').html(data.CancellationPolicyLimitDate);
                $('.spn_cnclpolicy_limit_date').show();
            }
            else {
                $('.CancellationPolicy_dialog_text').hide();
                $('#CancellationPolicy_dialog_text').html('לא התקבלו נתונים');
                $('#CancellationPolicy_dialog_text').show();
                $('.spn_cnclpolicy_limit_date').hide();
            }
            $("#dialog_CancellationPolicy").dialog({

                autoOpen: true,
                modal: false,
                height: 250,
                width: 500,
                open: function (event, ui) { $('.ui-widget-overlay').bind('click', function () { $("#dialog_CancellationPolicy").dialog('close'); }); }

            });

            $(_request).css('cursor', 'pointer');

        },
        error: function () {

        },
        complete: function () {
            //initMultiSelect('ddlHotel');
        }
    });

}

var priceChange = false;
function ShowSelectCanceletionPolicy(isAsync, LoadSameHotel) {
    if (typeof (isAsync) === 'undefined') isAsync = true;
    var CurrPrice = parseFloat($('#hdn_o_price').val());
    var selcted_option = $('.selcted_room').closest('.room_info_wrapper_abroad');
    var SelctedBoradUniqID = selcted_option.find(".SelctedBoardBaeName").find(":selected").attr('uniqid');
    var rooms = [];
    var products = [];

    priceChange = false;

    $.ajax({
        url: "/Handlers/HotelGWCancellationPolicy.ashx",
        dataType: "json",
        async: isAsync,
        type: "POST",
        cache: false,
        data:
            {
                Hotel: $('#SerializeHotel').val(),
                BoradBaseUniqID: SelctedBoradUniqID
            },
        beforeSend: function () {
            $('#div_main_cancelation_policy').hide();
            //In Dynamic Packages We Dont Show Cacelation Policy
            if ($('.SerializedItinerary').length == 0) {
                $('#image_loading_can').show();
            }

        },
        success: function (data) {
            //אם המחיר השתנה
            if (data == null || data.PriceChangeRate != 0 && Math.abs(CurrPrice - data.PriceChangeRate) > 1) {
                //Hide Order Btn

                priceChange = true;
                showErrorPopUpDialog();
            }
            //זמן החיפוש עבר יש לבצע חיפוש חדש
            //if we get zero here it mean that the time of the search is expired
            if (!priceChange && data != null && data.CancellationPolicyTTLSeconds <= 0) {
                priceChange = true;
                //$('#dialog_CancellationPolicy').hide();
                hideErrorPopUpDialog();
                $('#dialog_flight_price_changed').hide();
                $("#dialog_ttl_time_overtime").dialog({
                    autoOpen: true,
                    modal: false,
                    height: 300,
                    width: 500,
                    open: function (event, ui) {
                        $('.parg_can').show();
                        $('.popup_serach_again_btn ').show();

                    },
                    close: function (event, ui) {
                        $('.parg_can').hide();
                        $('.popup_serach_again_btn ').hide();
                        //Show Wizard For Out logic
                        $('#main_wizard').show();
                        $('#wrap_Hotel').show();
                        //Set true To Avoid Getting Same Resualt From Cache
                        $("#hdn_SkipHotel").val("True");
                        $('#btn_sumbit').click();//parent.history.back();
                        $("#hdn_SkipHotel").val("False");
                        $('#main_wizard').hide();
                        $('#wrap_Hotel').hide();
                    },
                    buttons: {
                        OK: function () {
                            $(this).dialog("close");
                            location.reload(true);
                        }

                    },
                    dialogClass: 'TTlPopUp'

                });
                $('.TTlPopUp .ui-button-text:contains(OK)').text('אישור');

            }



            //מעלים או מסתיר את כפתור ההזמנה 
            if (priceChange) {
                $('.AddToBasket').hide()
            }
            else {
                $('.AddToBasket').show()

            }
            //Write Cancalation Polciy Date 
            if (!priceChange && data.CancellationPolicyLimitDate != null) {
                //In Dynamic Packages We Dont Show Cacelation Policy
                if ($('.SerializedItinerary').length == 0) {
                    $('#spn_cancel_limit_date').html(data.CancellationPolicyLimitDate);
                    $('#rem_spn_cancel_limit_date').html(data.CancellationPolicyLimitDate);
                    $('#rem_spn_cancel_description').html(data.CancellationPolicy);
                    $('#div_main_cancelation_policy').show();
                    $('.no_cancaltion_date_td').hide();
                    $('.cancaltion_td').show();

                }
            }
                //Write Const Messge for no cancelation Date
            else if (!priceChange && data.CancellationPolicyLimitDate == null) {
                //In Dynamic Packages We Dont Show Cacelation Policy
                if ($('.SerializedItinerary').length == 0) {
                    $('.cancaltion_td').hide();
                    $('.no_cancaltion_date_td').show();
                }
            }

        },
        error: function () {

        },
        complete: function () {
            //In Dynamic Packages We Dont Show Cacelation Policy
            if ($('.SerializedItinerary').length == 0) {
                $('#image_loading_can').hide();
            }

        }
    });

}

function closedialog(id) {
    $('#' + id).dialog('close');
    try {
        $('#' + id).dialog('destroy ');
    } catch (e) {

    }
}

function parseDate(input) {
    var parts = input.split('/');
    // new Date(year, month [, day [, hours[, minutes[, seconds[, ms]]]]])
    return new Date(parts[2], parts[1] - 1, parts[0]); // Note: months are 0-based
}



function checkIfTimePassed() {
    var dateCreated = $("#DateCreated").val();
    dateCreated = Date.parse(dateCreated);
    var now = new Date();
    var timePassed = now.getTime() - dateCreated;
    timePassed = (timePassed / (1000 * 60));

    if (timePassed > ParameterTimeOut) { //20 minutes
        loadErrorTimeOut();
    }
    else {
        AddToHotelBasket();
    }
}



function loadErrorTimeOut() {
    $("#dialog_ttl_time_overtime").dialog({
        autoOpen: true,
        modal: false,
        height: 300,
        width: 500,
        open: function (event, ui) {
            $('.parg_can').show();
            $('.popup_serach_again_btn ').show();
        },
        close: function (event, ui) {
            $('.parg_can').hide();
            $('.popup_serach_again_btn ').hide();
            //Show Wizard For Out logic
            $('#main_wizard').show();
            $('#wrap_Hotel').show();
            //Set true To Avoid Getting Same Resualt From Cache
            //$("#hdn_SkipHotel").val("True");
            $('#btn_sumbit').click();//parent.history.back();
            $("#hdn_SkipHotel").val("False");
            $('#main_wizard').hide();
            $('#wrap_Hotel').hide();
        },
        buttons: {
            OK: function () {
                $(this).dialog("close");
                window.location = GlobalSiteRootJS;
            }
        },
        dialogClass: 'TTlPopUp'
    });
    $('.TTlPopUp .ui-button-text:contains(OK)').text('אישור');
}



function ClearAutoComplete(el) {
    $(el).val("");
    submitFunction(null);
    $("#DEleteAutoSearch").hide();

}

function ClearHotel() {
    $("#txtHotelsAbroad").val("");
    $("#ddlHotelhotelabroad").val("");
    $("#DEleteAutoSearch").hide();
    $("#hid_txtHotelsAbroad").val("");

}

function SendToGoogle() {
    GTDataLayer.push({ 'event': 'hotels-search-results-click-order-button' });
}

//Get all hotel names from page
function getHotelNames() {

    var hotelFullListName = new Array();
    var hotelFullListCode = new Array();
    $('#ddlHotelhotelabroad').html($("<option></option>").attr("value", "").text("הכל"));
    $(".hotelCodeAndName").each(function (index, element) {
        var code = $(element).val().split("#")[0];
        var name = $(element).val().split("#")[1];
        $('#ddlHotelhotelabroad').append($("<option></option>").attr({ value: code }).text(name));
        hotelFullListName[index] = name;
        hotelFullListCode[index] = code;
    });
    shortenedSelect();
    $("#txtHotelsAbroad").autocomplete({
        source: hotelFullListName,
        autoFocus: true,
        select: function (event, ui) {
            setTimeout(submitFunction, 500, hotelFullListName, hotelFullListCode, ui); //the timeout is for catching select on enter and on mouse do not chnage - eyal 2016
            $("#DEleteAutoSearch").show();
        },
        appendTo: '#txtHotelsAbroadContainer'

    }).keypress(function (e) { //disable enter key from autotcompleate if no item has been chosen
        if (e.keyCode === 13) {
            return false;
        }

    });
    $('#trAbroadHotelhotelabroad').show();
}

//Get obselete result in results page
function CheckTTL() {
    var hotel = $(".ListObject")[0].value;
    var board_uniqID = $(".board_uniqid")[0].value;

    $.ajax({
        url: "/Handlers/HotelGWCancellationPolicy.ashx",
        dataType: "json",
        async: true,
        type: "POST",
        cache: false,
        data:
            {
                Hotel: hotel,
                BoradBaseUniqID: board_uniqID
            },
        success: function (data) {

            //זמן החיפוש עבר יש לבצע חיפוש חדש
            //if we get zero here it mean that the time of the search is expired
            if (data != null && data.CancellationPolicyTTLSeconds <= 0) {
                $("#dialog_ttl_time_overtime").dialog({
                    autoOpen: true,
                    modal: false,
                    height: 300,
                    width: 500,
                    open: function (event, ui) {

                        $('.parg_can').show();
                        $('.popup_serach_again_btn ').show();
                    },
                    close: function (event, ui) {

                        $('.parg_can').hide();
                        $('.popup_serach_again_btn ').hide();
                        //Show Wizard For Out logic
                        $('#main_wizard').show();
                        $('#wrap_Hotel').show();
                        //Set true To Avoid Getting Same Resualt From Cache
                        $("#hdn_SkipHotel").val("True");
                        $('#btn_sumbit').click();//parent.history.back();
                        $("#hdn_SkipHotel").val("False");
                        $('#main_wizard').hide();
                        $('#wrap_Hotel').hide();
                    },
                    buttons: {
                        OK: function () {

                            $(this).dialog("close");
                            location.reload(true);
                        }

                    },
                    dialogClass: 'TTlPopUp'

                });
                $('.TTlPopUp .ui-button-text:contains(OK)').text('אישור');
            }
        },
        error: function () {

        }
    });

}


function InitgeographicAreaOrganizedSecondJS(){

    $('#geographicAreaOrganized').change(function () {
        getCountries($(this).val());
    }); 
}

function getCountries(areaCode) {
    if (areaCode == -1) {
        $("#countryOrganized").empty();
        $('#countryOrganized').append($("<option></option>").attr("value", -999).text('בחר/י אזור'));
        return;
    }

    $.ajax({
        url: "/Handlers/Country.ashx",
        dataType: "json",
        data: { code: areaCode, productType: 'organized' },
        async:false,
        success: function (data) {
            $("#countryOrganized").empty();
            $('#countryOrganized').append($("<option></option>").attr("value", -1).text('הכל'));
            if (data != null && data != '') {
                for (var i = 0; i < data.rows.length; i++) {
                    $('#countryOrganized').append($("<option></option>").attr("value", (data.rows[i].CountryCode)).text(data.rows[i].CountryName));
                }
            }

            // Set selected country by QueryString
            var countryCode = $.getUrlVars()["c"];
            if (countryCode != undefined) {
                $("#countryOrganized").val(countryCode);

            } else {
                $("#countryOrganized").val(-1);
            }
            
        },
        error: function () {
          //  alert("Error in Get Countries !");
        }
    });

}

function addRecommend() {
   
    var lcid = $('#lcid').val();
    var tripId = $('#tripId').val();
    var title = $('#txtTitle').val();
    var year = $('#ddYear').val();
    var traveller = $('#txtTravellerName').val();
    var email = $('#txtEmail').val();
    var guide = $('#txtGuide').val();
    var fullDescription = $('#txtFullDescription').val();
    var imageId = $('#UploadImageId').val(); // if no image set to 0
    if (! isValidRecommend(title, traveller, email, fullDescription)) return;

    $.ajax({
        url: "/Handlers/Recommend.ashx",
        dataType: "json",
        data: {
            lcid: lcid,
            tripId: tripId,
            year: year,
            guide: guide,
            traveller: traveller,
            title: title,
            fullDescription: fullDescription,
            imageId: imageId,
            alt: ""
        },

        success: function (data) {
            alert("ההמלצה נוספה בהצלחה");
        },
        error: function () {
            alert("בעיה בהוספת המלצה");
        }
    });

    closeRecommendPopup();
}

function isValidRecommend(title, traveller, email, fullDescription) {
    
    var isValid = 0;

    $("#addRecommendation #summaryErr ul li").remove();

    if (title == '') {
        isValid = 1;
        $("#addRecommendation #summaryErr ul").append('<li>אנא הזן כותרת</li>');
    }
    if (traveller == '') {
        isValid = (isValid == 0) ? 2 : isValid;
        $("#addRecommendation #summaryErr ul").append('<li>אנא הזן שם מטייל</li>');
    }
    if (email == '') {
        isValid = (isValid == 0) ? 3 : isValid;
        $("#addRecommendation #summaryErr ul").append('<li>אנא הזן כתובת דוא"ל</li>');
    }
    if (fullDescription == '') {
        isValid = (isValid == 0) ? 4 : isValid;
        $("#addRecommendation #summaryErr ul").append('<li>אנא הזן תיאור מלא</li>');
    }

    switch (isValid) {
        case 1: $('#txtTitle').focus(); 
                break;
        case 2: $('#txtTravellerName').focus(); 
                break;
        case 3: $('#txtEmail').focus(); 
                break;
        case 4: $('#txtFullDescription').focus(); 
                break;
    }

    return isValid == 0;
}

function closeRecommendPopup() {
    clearRecommend();
    $("#addRecommendation").dialog("close");
}

function clearRecommend() {

    $("#addRecommendation #summaryErr ul li").remove();

    $('#txtTitle').val("");
    $('#txtTravellerName').val("");
    $('#txtEmail').val("");
    $('#txtGuide').val("");
    $('#txtFullDescription').val("");
    $('#ddYear').val("2012");
    $('#UploadImageId').val("0");
}

/* version number */
//-------------------
/* end version number */


function fillValuesOfTemplatesOrganizeInDDLs(valueAtTemplatesDDL) {

    switch (valueAtTemplatesDDL) {
        case ('0'):
            $("#ddlAdultNumRoom1Organized").val(2);
            $("#ddlChildNumRoom1Organized").val(0);
            break;
        case ('1'):
            $("#ddlAdultNumRoom1Organized").val(1);
            $("#ddlChildNumRoom1Organized").val(0);
            break;
        case ('2'):
            $("#ddlAdultNumRoom1Organized").val(2);
            $("#ddlChildNumRoom1Organized").val(1);
            break;
        case ('3'):
            $("#ddlAdultNumRoom1Organized").val(2);
            $("#ddlChildNumRoom1Organized").val(2);
            break;
        case ('4'):
            $("#ddlAdultNumRoom1Organized").val(3);
            $("#ddlChildNumRoom1Organized").val(0);
            break;
        default:
            $("#ddlAdultNumRoom1Organized").val(0);
            $("#ddlChildNumRoom1Organized").val(0);
            break;
    }
}

function finishLoad() {
    if (typeof (window.FixHeight) == "function") {
        FixHeight();
    }
    formDeserialize();
    getCountries($('#geographicAreaOrganized').val());
    ddlRoomsNum_Change($('#ddlRoomsNum').val());
}

function setOrganizedDestination(code,callback) {
    $.ajax({
        url: "/Handlers/Destinations.ashx",
        data: { organizeddestination: code },
        dataType: "json",
        success: function (data) {
            if ($.trim(data) != "") {
                $('#geographicAreaOrganized').val(data.region);
                $('#geographicAreaOrganized').trigger('change');
                $('#countryOrganized').val(data.country);
            }
        },
        complete: function () {
            if (typeof (callback) != "undefined") {
                callback();
            }
        }
    });

    $('.searchWizardMore').hide();
}





var defaultSettings = "";
var specialDays = [];
specialDays[0] = [];
specialDays[1] = [];

function InitDatePickerOrganizedJS(){
    function legend() {
        setTimeout(function () {
            if ($('.ulHolidays').length > 0) {
                $('.ulHolidays').remove();
            }
            $(".ui-datepicker-row-break").append("<ul class='ulHolidays'><li><span class='valid'>*&nbsp;</span><span>חג</span></li><li><img src='/images/chooseBg.png' width='18' height='17' alt='' /><span>בחירה</span></li></ul><a class='cleanDates'>נקה בחירה</a>");
        }, 100)
    } 
    defaultSettings = {
        showOn: "button",
        buttonImage: "/images/calendarIcon2.png",
        buttonImageOnly: true,
        //showButtonPanel: true,
        beforeShowDay: function (thedate) {
            var theday = thedate.getDate();
            var d = thedate.getDate() + "";
            var m = thedate.getMonth() + 1;
            var yerrr = thedate.getFullYear();
            var key = d + "/" + m + "/" + yerrr;

            if (typeof (specialDays[1]) != "undefined") {
                if (typeof (specialDays[1][key]) != "undefined") {
                    if (typeof (specialDays[0][key]) != "undefined") {
                        return [true, 'charterholiday', specialDays[0][key]];
                    }
                    else {
                        return [true, 'charter', specialDays[1][key]];
                    }
                }
            }

            if (typeof (specialDays[0]) != "undefined") {
                if (typeof (specialDays[0][key]) != "undefined") {
                    return [true, 'holiday', specialDays[0][key]];
                }
            }

            return [true, ''];
        },
        beforeShow: function (input, inst) {
            legend();

            if (!$('.ui-datepicker').parent().hasClass('wrap')) {
                $('.ui-datepicker').wrap("<div class='wrap' id='calendarWrapper'></div>");

            }
            $('.ui-datepicker').parent().removeClass('from').removeClass('to');

            $('.ui-datepicker').parent().addClass(inst.id);

            var year = inst.drawYear; var month = inst.drawMonth; var currentTime = new Date()
            if (year == 0) year = currentTime.getFullYear(); if (month == 0) month = currentTime.getMonth();

            GetSpecialDates(year, month + 2, function () {
                $("#fromOrganized").datepicker("refresh");
                $("#toOrganized").datepicker("refresh");
            });
        },
        onChangeMonthYear: function (year, month, inst) {
            legend();
            GetSpecialDates(year, month, function () {
                $("#fromOrganized").datepicker("refresh");
                $("#toOrganized").datepicker("refresh");
            });
        },
        defaultDate: "+1w",
        numberOfMonths: 2,
        onSelect: function (selectedDate) {
            //var option = this.id == "from" ? "minDate" : "maxDate",
					instance = $(this).data("datepicker"),
					date = $.datepicker.parseDate(
						instance.settings.dateFormat ||
						$.datepicker._defaults.dateFormat,
						selectedDate, instance.settings);
//            dates.not(this).datepicker("option", option, date);
					if (this.id == "fromOrganized") {
                setTimeout(function () {
                    $("#toOrganized").datepicker("setDate", selectedDate);
                    $("#toOrganized").datepicker("show");
                }, 100);
            }
            $(".searchPeriod").attr("checked", false);
        },
        minDate: $('#hiddenTodayOrganized').val(),
        showOtherMonths: true,
        showMonthAfterYear: false,
        monthNames: ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'],
        monthNamesShort: ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'],
        dayNamesMin: ['א', 'ב', 'ג', 'ד', 'ה', 'ו', 'ש'],
        dateFormat: 'dd/mm/yy'
    }
    var dates = $("#fromOrganized, #toOrganized").datepicker(defaultSettings);
    $("#ui-datepicker-div").addClass("datepickerWrapper");
    $('.cleanDates').live('click', function () {
        $("#fromOrganized, #toOrganized").val('');
    });

    var currentDate = new Date();

    GetSpecialDates(currentDate.getFullYear(), currentDate.getMonth() + 1, function () {
        $("#fromOrganized").datepicker("refresh");
        $("#toOrganized").datepicker("refresh");
        //rePaint();
    });

    $('#fromOrganized,#toOrganized').focus(function (e) {
        e.preventDefault();
        e.stopPropagation();
        $(this).datepicker('show');
    });

    $('#ddlSearchPeriodOrganized').trigger('change');
}

function NightsChanged(nights) {
    var strDate = $('#fromOrganized').val();
    var dateParts = strDate.split("/");
    var d = new Date(dateParts[2], (dateParts[1] - 1), dateParts[0]);
    d = addDays(d, Number(nights));
    $('#toOrganized').val(addZero(d.getDate(), 'day') + "/" + addZero(Number(d.getMonth()), 'month') + "/" + d.getFullYear());
}

function addZero(num, dateCase) {
    switch (dateCase) {
        case "month":
            num++;
            break;
        default:
            break;
    }

    if (num < 10) {
        return "0" + num;
    }
    return num;
}

function addDays(myDate, days) {
    return new Date(myDate.getTime() + days * 24 * 60 * 60 * 1000);
}

function GetSpecialDates(year, month, callback) {
    var url = "";
    var action = "organized";
    url = "/Handlers/CalanderDates.ashx?m=" + month + "&y=" + year + "&city=" + $('#hiddenCity').val() + "&country=" + $('#hiddenCountry').val() + "&actioncharter=" + action;

    $.ajax({
        type: 'GET',
        url: url,
        async: false,
        cache: true,
        jsonpCallback: 'DatesCallBack',
        contentType: "application/json",
        dataType: 'jsonp',
        success: function (dates) {

            var tempo = dates.data;
            for (var i in tempo[0]) {
                specialDays[0][i] = tempo[0][i];
            }
            for (var x in tempo[1]) {
                specialDays[1][x] = tempo[1][x];
            }

            callback();
        } 
    });
}
/* version number */
//-------------------
/* end version number */

var wizard_mode = 1;

var specialDays = [];
specialDays[0] = [];
specialDays[1] = [];

var disableDynamicPackage = false;
var getSpecialDatesTimeout;

function finishLoad() {
    if (typeof (window.FixHeight) == "function") {
        FixHeight();
    }

    formDeserialize();
    if (($('#hiddenCountryDeals').val() != null && $.trim($('#hiddenCountryDeals').val()) != '') && ($('#CityDeals').val() != null && $.trim($('#CityDeals').val()) != ''))
        initSelection($('#hiddenCountryDeals').val(), $('#CityDeals').val(), $('#hiddenOdyseaDestinationDeals').val());

    setWizardControls();

    ddlRoomsNum_Change($('#ddlRoomsNum').val());
}

function initSelectionFlyDrive(countryCode, destinationCode, odyssea_code) {
    $.ajax({
        url: "/Handlers/Destinations.ashx",
        dataType: "json",
        data: { code: countryCode, destinationcode: destinationCode, odysseaCode: odyssea_code },
        success: function (data) {

            $('#inp_flyDriveDestination').val(data.rows[0].shortName);
            $('#inp_flyDriveDestination').attr('shortName', data.rows[0].shortName);
            $('#hiddenCountryDeals').val(data.rows[0].countryCode);
            $('#CityDealsFlyDrive').val(data.rows[0].destinationCode);
            //$('#hiddenCityCodeDeals').val(data.rows[0].cityCode);
            //if ($('.hiddenContainer').length > 0)
            //    getProducts();
        }
    });
}


function initSelection(countryCode, destinationCode, odyssea_code) {

    $.ajax({
        url: "/Handlers/Destinations.ashx",
        dataType: "json",
        data: { code: countryCode, destinationcode: destinationCode, odysseaCode: odyssea_code },
        success: function (data) {
            if (data && data.rows[0]) {
                $('#txtCityDeals').val(data.rows[0].destinationName);
                $('#txtCityDeals').attr('shortName', data.rows[0].shortName);
                $('#hiddenCountryDeals').val(data.rows[0].countryCode);
                $('#CityDeals').val(data.rows[0].destinationCode);
                $('#hiddenCityCodeDeals').val(data.rows[0].cityCode);
                if ($('.hiddenContainer').length > 0)
                    getProducts();
            }
        }
    });
}

function setWizardControls() {
    if ($('#hiddenCountryDeals').val() != null && $.trim($('#hiddenCountryDeals').val()) != '') {

        $('#WhenShortBox').hide();
        $('#divWhenShortBox').show();

        $('#PassengersShortBox').hide();
        $('#divPassengersShortBox').show();

        $('.showControl ').show();
        $('.BudgetShortBox').hide();
        $('.boxs').hide();
    }
}


var defaultSettings = "";
var selectedstartdate = "";


var activeInput = "";
var openall = true;
function legendDeals() {
    setTimeout(function () {
        if ($('.ulHolidays').length > 0) {
            $('.ulHolidays .datepicker-message').remove();
        }
        var legendHtmlStr = "<ul class='ulHolidays px360'><li><span class='index_calender_charter'></span><span style='display:inline-block;line-height:17px;'>חבילות בתאריכים מומלצים</span></li><li><span class='index_calender_selected'></span><span style='display:inline-block;line-height:17px;'>בחירה</span></li></ul><a class='cleanDates'></a>";

        var holidaysLegendStr = "<li class='holidays-legend'><span class='valid'><img src='/images/calendarHolidayIcon.png' width='18' height='17' alt='' /></span><span>חג</span></li>";

        // Set break row for the datepicker
        setDatepickerBreakRow(legendHtmlStr, holidaysLegendStr);
        CheckAvilablity();
    }, 100)
}

function legendFlyDriveDeals() {
    setTimeout(function () {
        if ($('.ulHolidays').length > 0) {
            $('.ulHolidays .datepicker-message').remove();
        }

        var legendHtmlStr = "<ul class='ulHolidays px360'><li><span class='index_calender_charter'></span><span style='display:inline-block;line-height:17px;'>חבילות בתאריכים מומלצים</span></li><li><span class='index_calender_selected'></span><span style='display:inline-block;line-height:17px;'>בחירה</span></li></ul><a class='cleanDates'></a>";

        var holidaysLegendStr = "<li class='holidays-legend'><span class='valid'><img src='/images/calendarHolidayIcon.png' width='18' height='17' alt='' /></span><span>חג</span></li>";

        // Set break row for the datepicker
        setDatepickerBreakRow(legendHtmlStr, holidaysLegendStr);
        CheckAvilablityFlyDrive();
    }, 100)
}

function ActiveDealsControlinitJS() {

    initDatePickerFrom();
    defaultSettings = {
        rangeSelect: true,
        beforeShowDay: function (thedate, optionsObj) {
            var theday = thedate.getDate();
            var d = thedate.getDate();

            var m = thedate.getMonth() + 1;

            var yerrr = thedate.getFullYear();
            var key = d + "/" + m + "/" + yerrr;

            var selectedClass = "ui-datepicker-week-end ui-state-disabled ui-datepicker-week-end ui-datepicker-unselectable ui-state-disabled ui-datepicker-week-end ui-state-disabled ui-state-disabled ui-state-disabled";

            var isutlistOneSelcted = false;

            if (openall) {
                selectedClass = "";
            }
            var holiday = "";
            if (this.id == "ToDeals") {
                var fromDate = parseDate($("#fromDeals").val());
                if (fromDate.getDate() == thedate.getDate() && fromDate.getMonth() == thedate.getMonth() && fromDate.getFullYear() == thedate.getFullYear()) {
                    if (typeof (specialDays[0]) != "undefined") {
                        if (typeof (specialDays[0][key]) != "undefined") {
                            holiday = " holiday";
                        }
                    }
                    return [true, "ui-state-disabled ui-datepicker-unselectable ui-state-disabled-start-date" + holiday];
                }
            }

            if (this.id == "fromDeals") {

                if (typeof (specialDays[1]) != "undefined") {
                    if (typeof (specialDays[1][key]) != "undefined") {
                        if (typeof (specialDays[0][key]) != "undefined") {
                            return [true, 'charterholiday', specialDays[0][key]];
                        }
                        else {
                            return [true, 'charter', specialDays[1][key].price];
                        }

                    }
                    else {
                        if ((disableDynamicPackage || subjectType == $("#hiddenSportType").val() || subjectType == $("#hiddenHotelCarFlightType").val())) {
                            if (typeof (specialDays[0]) != "undefined") {
                                if (typeof (specialDays[0][key]) != "undefined") {
                                    return [false, 'holiday not_charter', specialDays[0][key]];
                                }
                            }
                            return [false, 'not_charter locked'];
                        }
                    }
                }
                else {//if not a charter
                    if ((disableDynamicPackage || subjectType == $("#hiddenSportType").val() || subjectType == $("#hiddenHotelCarFlightType").val())) {
                        if (typeof (specialDays[0]) != "undefined") {
                            if (typeof (specialDays[0][key]) != "undefined") {
                                return [false, 'holiday not_charter', specialDays[0][key]];
                            }
                        }
                        return [false, 'not_charter locked'];
                    }
                }
            }
            else {
                if (typeof (selectedstartdate[key]) != "undefined") {
                    if (typeof (specialDays[0][key]) != "undefined") {
                        return [true, 'charterholiday', specialDays[0][key]];
                    }
                    else {
                        return [true, 'charter', selectedstartdate[key].price];
                    }
                }
                else {
                    if (disableDynamicPackage || (subjectType == $("#hiddenSportType").val() || subjectType == $("#hiddenHotelCarFlightType").val())) {
                        if (typeof (specialDays[0]) != "undefined") {
                            if (typeof (specialDays[0][key]) != "undefined") {
                                return [false, 'holiday not_charter', specialDays[0][key]];
                            }
                        }
                        return [false, 'not_charter locked'];
                    }
                }
            }

            if (typeof (specialDays[0]) != "undefined") {
                if (typeof (specialDays[0][key]) != "undefined") {
                    return [true, 'holiday ' + selectedClass, specialDays[0][key]];
                }
            }

            return [true, selectedClass];
        },
        beforeShow: function (input, inst) {

            activeInput = inst.id;

            if (!$('.ui-datepicker').parent().hasClass('wrap')) {
                $('.ui-datepicker').wrap("<div class='wrap popupCalendar ' id='calendarWrapper'></div>");

            }
            $('.ui-datepicker').parent().removeClass('from').removeClass('to');

            $('.ui-datepicker').parent().addClass(inst.id);

            //Datepicker animation
            $(this).datepicker("option", "showAnim", "fadeIn");
            doDatePickerPositionHandle(input);

            if (inst.id == "fromDeals") {

                setDP_classesForJS("False");

                var instance = $(this).data("datepicker");
                var date = $.datepicker.parseDate(instance.settings.dateFormat || $.datepicker._defaults.dateFormat, input.value, instance.settings);
                if (date == null)
                    date = new Date();

                GetSpecialDatesDeals(inst.id, date.getFullYear(), date.getMonth() + 1, function () {
                    $('#fromDeals').datepicker("refresh");
                    $('#ToDeals').datepicker("refresh");
                    legendDeals();

                });
            }
            else {
                if (this.id == "ToDeals") {

                    setDP_classesForJS("True");

                    doDatePickerDateRange();

                    var fromDate = parseDate($("#fromDeals").val());
                    var toDate = new Date(fromDate);
                    toDate.setDate(fromDate.getDate());

                    $("#ToDeals").datepicker("option", "minDate", toDate);
                }
                $("#ToDeals").datepicker("refresh");
                legendDeals();

            }

        },
        onChangeMonthYear: function (year, month, inst) {
            var changeMonthYear = new Date(year, month, 1);
            var currentDate = new Date();
            if (currentDate > changeMonthYear) {
                month = currentDate.getMonth() + 1;
                year = currentDate.getFullYear();

            }
            if (this.id == "fromDeals") {
                //אנחנו עושים timeout 
                //כי אם מעבירים מהר בין חודשים אז נוצר מצב ש:
                //1. יוצאים לחיפוש של תאריכים שלא צריכים ומעמיס על השרת סתם
                //2. התאריכון בחודש הנדרש לא נצבע
                //לכן, מחכים חצי שניה, אם העבירו עוד חודש מהר, אנחנו מנקים את הפעולה הקודמת (כדי לא יצא לחיפוש על החודש האמצעי
                clearTimeout(getSpecialDatesTimeout);
                getSpecialDatesTimeout = setTimeout(function () {
                    GetSpecialDatesDeals(inst.id, year, month, function () {
                        legendDeals();
                    })

                }, 500);
            }
        },
        defaultDate: null,
        numberOfMonths: 2,
        onSelect: function (selectedDate) {
            //            var option = this.id == "fromDeals" ? "minDate" : "maxDate";
            var instance = $(this).data("datepicker");
            date = $.datepicker.parseDate(
						instance.settings.dateFormat ||
						$.datepicker._defaults.dateFormat,
						selectedDate, instance.settings);


            var d = date.getDate() + "";
            var m = date.getMonth() + 1;
            var yerrr = date.getFullYear();
            var key = d + "/" + m + "/" + yerrr;

            if (this.id == "fromDeals") {
                if (typeof (specialDays[1][key]) != "undefined") {
                    selectedstartdate = {};
                    for (var f = 0; f < specialDays[1][key].length; f++) {
                        var flightkey = specialDays[1][key][f].endDate.replace('.', '/').replace('.', '/');
                        if (flightkey.indexOf("0") == 0) {
                            flightkey = flightkey.substring(1);
                            flightkey = flightkey.replace("/0", "/");
                        }
                        flightkey = flightkey.replace("/0", "/");
                        selectedstartdate[flightkey] = specialDays[1][key][f];
                    }
                    $("#isDealDate").val("true");
                } else {
                    $("#isDealDate").val("false");
                }


                $("#ToDeals").datepicker("option", "minDate", date);
                setTimeout(function () {
                    $("#ToDeals").datepicker("setDate", selectedDate);
                    $("#ToDeals").datepicker("show");
                }, 100);
                $(".searchPeriod").attr("checked", false);
            } else {//toDeals
                if (typeof (selectedstartdate[key]) == "undefined") {
                    $("#isDealDate").val("false");
                }
            }

        },
        minDate: $('#hiddenToday').val(),
        showOtherMonths: true,
        showMonthAfterYear: false,
        monthNames: ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'],
        monthNamesShort: ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'],
        dayNamesMin: ['א', 'ב', 'ג', 'ד', 'ה', 'ו', 'ש'],
        dateFormat: 'dd/mm/yy'
    }
    //initFlyDriveDatePickers();

    var dates = $("#fromDeals, #ToDeals").datepicker(defaultSettings);

    $("#ui-datepicker-div").addClass("datepickerWrapper");
    setWizardAfterDateChange();
    $('.cleanDates').live('click', function () {
        $("#" + activeInput).val('');
    });

    $('#ddlNightsRange').bind('change', function () {
        var arr = $(this).val().split('_');
        $('input[name="minNights"]').val(arr[0]);
        $('input[name="maxNights"]').val(arr.length == 1 ? '' : arr[1]);
    });

    $('.search_btn').removeClass("mr18");
    $('.search_btn').removeClass("mr15_none_impo");
    $('.search_btn').addClass("deals_wizard_search_btn");

    $('#ddlNightsRange').trigger('change');
    var currentDate = new Date();

}


function popularDestinations(destination, country) {
    initSelection(country, destination, "");

    $('.searchWizardMore').hide();
}

//init Fly drive date pickers
function initFlyDriveDatePickers() {

    initDatePickerFlyDriveFrom();
    defaultSettings = {

        beforeShowDay: function (thedate) {
            var theday = thedate.getDate();
            var d = thedate.getDate();

            var m = thedate.getMonth() + 1;

            var yerrr = thedate.getFullYear();
            var key = d + "/" + m + "/" + yerrr;

            var selectedClass = "ui-datepicker-week-end ui-state-disabled ui-datepicker-week-end ui-datepicker-unselectable ui-state-disabled ui-datepicker-week-end ui-state-disabled ui-state-disabled ui-state-disabled";

            var isutlistOneSelcted = false;

            if (openall)
                selectedClass = "";
            if (this.id == "inp_flyDriveDepartureDate") {
                if (typeof (specialDays[1]) != "undefined") {
                    if (typeof (specialDays[1][key]) != "undefined") {
                        if (typeof (specialDays[0][key]) != "undefined") {
                            return [true, 'charterholiday', specialDays[0][key]];
                        }
                        else {
                            return [true, 'charter', specialDays[1][key].price];
                        }

                    }
                    else {
                        return [false, 'not_charter locked'];
                    }
                }
                else {
                    return [false, 'not_charter locked'];
                }
            }
            else {
                if (typeof (selectedstartdate[key]) != "undefined") {
                    return [true, 'charter', selectedstartdate[key].price];
                }
                else {
                    return [false, 'not_charter locked'];
                }
            }

            if (typeof (specialDays[0]) != "undefined") {
                if (typeof (specialDays[0][key]) != "undefined") {
                    return [true, 'holiday ' + selectedClass, specialDays[0][key]];
                }
            }
            return [true, selectedClass];
        },


        beforeShow: function (input, inst) {

            activeInput = inst.id;

            setDP_classesForJS("False"); // = No Date Range at FlyDrive Datepicker

            //Datepicker animation
            $(this).datepicker("option", "showAnim", "fadeIn");
            doDatePickerPositionHandle(input);

            if (!$('.ui-datepicker').parent().hasClass('wrap')) {
                $('.ui-datepicker').wrap("<div class='wrap popupCalendar ' id='calendarWrapper'></div>");

            }
            $('.ui-datepicker').parent().removeClass('from').removeClass('to');

            $('.ui-datepicker').parent().addClass(inst.id);

            if (inst.id == "inp_flyDriveDepartureDate") {

                var instance = $(this).data("datepicker");
                var date = $.datepicker.parseDate(instance.settings.dateFormat || $.datepicker._defaults.dateFormat, input.value, instance.settings);
                if (date == null)
                    date = new Date();



                GetSpecialDatesDeals(inst.id, date.getFullYear(), date.getMonth() + 1, function () {
                    $('#inp_flyDriveDepartureDate').datepicker("refresh");
                    $('#inp_flyDriveReturnDate').datepicker("refresh");
                    legendFlyDriveDeals();

                });
            }
            else {
                if (this.id == "inp_flyDriveReturnDate") {

                    var fromDate = parseDate($("#inp_flyDriveDepartureDate").val());
                    var toDate = new Date(fromDate);
                    toDate.setDate(fromDate.getDate() + 1);
                    $("#inp_flyDriveReturnDate").datepicker("option", "minDate", toDate);
                }
                $("#inp_flyDriveReturnDate").datepicker("refresh");
                legendFlyDriveDeals();

            }

        },
        onChangeMonthYear: function (year, month, inst) {
            var changeMonthYear = new Date(year, month, 1);
            var currentDate = new Date();
            if (currentDate > changeMonthYear) {
                month = currentDate.getMonth() + 1;
                year = currentDate.getFullYear();

            }

            //אנחנו עושים timeout 
            //כי אם מעבירים מהר בין חודשים אז נוצר מצב ש:
            //1. יוצאים לחיפוש של תאריכים שלא צריכים ומעמיס על השרת סתם
            //2. התאריכון בחודש הנדרש לא נצבע
            //לכן, מחכים חצי שניה, אם העבירו עוד חודש מהר, אנחנו מנקים את הפעולה הקודמת (כדי לא יצא לחיפוש על החודש האמצעי
            clearTimeout(getSpecialDatesTimeout);
            getSpecialDatesTimeout = setTimeout(function () {
                GetSpecialDatesDeals(inst.id, year, month, function () {
                    legendFlyDriveDeals();
                })

            }, 500);

        },
        defaultDate: null,
        numberOfMonths: 2,
        onSelect: function (selectedDate) {
            //            var option = this.id == "fromDeals" ? "minDate" : "maxDate";
            var instance = $(this).data("datepicker");
            date = $.datepicker.parseDate(
						instance.settings.dateFormat ||
						$.datepicker._defaults.dateFormat,
						selectedDate, instance.settings);



            if (this.id == "inp_flyDriveDepartureDate") {
                var d = date.getDate() + "";
                var m = date.getMonth() + 1;
                var yerrr = date.getFullYear();
                var key = d + "/" + m + "/" + yerrr;
                if (typeof (specialDays[1][key]) != "undefined") {
                    selectedstartdate = {};
                    for (var f = 0; f < specialDays[1][key].length; f++) {
                        var flightkey = specialDays[1][key][f].endDate.replace('.', '/').replace('.', '/');
                        if (flightkey.indexOf("0") == 0) {
                            flightkey = flightkey.substring(1);
                            flightkey = flightkey.replace("/0", "/");
                        }
                        flightkey = flightkey.replace("/0", "/");
                        selectedstartdate[flightkey] = specialDays[1][key][f];
                    }
                }


                $("#inp_flyDriveReturnDate").datepicker("option", "minDate", date);
                setTimeout(function () {
                    $("#inp_flyDriveReturnDate").datepicker("setDate", selectedDate);
                    $("#inp_flyDriveReturnDate").datepicker("show");
                }, 100);
                $(".searchPeriod").attr("checked", false);
            }


            if (this.id == "inp_flyDriveDepartureDate") {
                var d = date.getDate() + "";
                var m = date.getMonth() + 1;
                var yerrr = date.getFullYear();
                var key = d + "/" + m + "/" + yerrr;
                if (typeof (specialDays[1][key]) != "undefined") {
                    selectedstartdate = {};
                    for (var f = 0; f < specialDays[1][key].length; f++) {
                        var flightkey = specialDays[1][key][f].endDate.replace('.', '/').replace('.', '/');
                        if (flightkey.indexOf("0") == 0) {
                            flightkey = flightkey.substring(1);
                            flightkey = flightkey.replace("/0", "/");
                        }
                        flightkey = flightkey.replace("/0", "/");
                        selectedstartdate[flightkey] = specialDays[1][key][f];
                    }
                }


                $("#inp_flyDriveReturnDate").datepicker("option", "minDate", date);
                setTimeout(function () {
                    $("#inp_flyDriveReturnDate").datepicker("setDate", selectedDate);
                    $("#inp_flyDriveReturnDate").datepicker("show");
                }, 100);

                setWizardAfterDateChange();

                $(".searchPeriod").attr("checked", false);
            }

            // dates.not(this).datepicker("option", option, date);

        },
        minDate: $('#hiddenToday').val(),
        showOtherMonths: true,
        showMonthAfterYear: false,
        monthNames: ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'],
        monthNamesShort: ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'],
        dayNamesMin: ['א', 'ב', 'ג', 'ד', 'ה', 'ו', 'ש'],
        dateFormat: 'dd/mm/yy'
    }

    var datesFlyDrive = $("#inp_flyDriveDepartureDate, #inp_flyDriveReturnDate").datepicker(defaultSettings);

}

function setWizardAfterDateChange() {
    if (typeof ($('#txtNightsNum').val()) != "undefined" && $.trim($('#fromDeals').val()) != '' && $.trim($('#ToDeals').val()) != '') {
        var datefromDeals = new Date($('#fromDeals').datepicker('getDate').getFullYear(), $('#fromDeals').datepicker('getDate').getMonth(), $('#fromDeals').datepicker('getDate').getDate());
        var dateTo = new Date($('#ToDeals').datepicker('getDate').getFullYear(), $('#ToDeals').datepicker('getDate').getMonth(), $('#ToDeals').datepicker('getDate').getDate());
        var ONE_DAY = 1000 * 60 * 60 * 24;
        var difference_ms = Math.abs(dateFrom.getTime() - dateTo.getTime());
        $('#txtNightsNum').val(Math.floor(difference_ms / ONE_DAY));
    }
}

function NightsChanged(nights) {
    var strDate = $('#fromDeals').val();
    var dateParts = strDate.split("/");
    var d = new Date(dateParts[2], (dateParts[1] - 1), dateParts[0]);
    d = addDays(d, Number(nights));
    $('#ToDeals').val(addZero(d.getDate(), 'day') + "/" + addZero(Number(d.getMonth()), 'month') + "/" + d.getFullYear());
}

function addZero(num, dateCase) {
    switch (dateCase) {
        case "month":
            num++;
            break;
        default:
            break;
    }

    if (num < 10) {
        return "0" + num;
    }
    return num;
}

function addDays(myDate, days) {
    return new Date(myDate.getTime() + days * 24 * 60 * 60 * 1000);
}

//Not at use
function CheckAvilablity() {
    return;
    var isAvial = false;
    ClearAvilablity();
    $(".charter").each(function (index) {
        if (!$(this).hasClass('ui-datepicker-other-month')) {
            isAvial = true;
            return;
        }
    });
    if (!isAvial) {
        $("#ui-datepicker-div").prepend("<a class='no_res_calender' >לצערנו אין תאריכים זמינים ליעד זה<br> נא לנסות חודש אחר או יעד אחר.</a>");
    }
}

function CheckAvilablityFlyDrive() {

    var isAvial = false;
    ClearAvilablity();
    $(".charter").each(function (index) {
        if (!$(this).hasClass('ui-datepicker-other-month')) {
            isAvial = true;
            return;
        }
    });
    if (!isAvial) {
        $("#ui-datepicker-div").prepend("<a class='no_res_calender' >אין תאריכים זמינים ליעד זה<br> אנא נסה חודש אחר או יעד אחר.</a>");
    }
}

function ClearAvilablity() {
    $('.no_res_calender').remove();
}

function GetSpecialDatesDeals(datePickerId, year, month, callback) {
    setTimeout(function () {
        $(".ui-datepicker-group").append("<img src='/images/ajax-loader-dots.gif' class='calendarLoader' style='position: absolute;top: 35%; left: 46%' />");
    }, 25);

    var codeType = $("#hiddendestCodeType").val();
    var url = "";
    var action = "deals";
    //if "fly drive"
    if (datePickerId == "inp_flyDriveDepartureDate" || datePickerId == "inp_flyDriveReturnDate") {
        action = "flydrive";
        url = "/Handlers/CalanderDates.ashx?m=" + month + "&y=" + year + "&from=" + $('#originDeals').val() + "&to=" + $('#CityDealsFlyDrive').val() + "&actioncharter=" + action + "&subjectType=" + subjectType;
    } else {// deals
        url = "/Handlers/CalanderDates.ashx?m=" + month + "&y=" + year + "&from=" + $('#originDeals').val() + "&to=" + $('#CityDeals').val() + "&toOdyssea=" + $("#hiddenOdyseaDestinationDeals").val() + "&actioncharter=" + action + "&subjectType=" + subjectType + "&codeType=" + codeType;
    }

    specialDays = [];
    specialDays[0] = [];
    specialDays[1] = [];
    openall = true;
    //the subjectType is defined in Main_Wizard.ascx
    //url = "/Handlers/CalanderDates.ashx?m=" + month + "&y=" + year + "&from=" + $('#originDeals').val() + "&to=" + $('#CityDeals').val() + "&actioncharter=" + action + "&subjectType=" + subjectType;
    $.ajax({
        type: 'GET',
        url: url,
        async: true,
        cache: true,
        jsonpCallback: 'DatesCallBack',
        contentType: "application/json",
        dataType: 'jsonp',
        success: function (dates) {

            //check if disable dynamic packages dates
            if (dates.isFindDynamicPackagesDates != undefined && dates.isFindDynamicPackagesDates == "False") {
                disableDynamicPackage = true;
            } else if (dates.isFindDynamicPackagesDates != undefined && dates.isFindDynamicPackagesDates == "True") {
                disableDynamicPackage = false;
            }

            var tempo = dates.data;
            for (var i in tempo[0]) {
                specialDays[0][i] = tempo[0][i];
            }

            for (var x in tempo[1]) {
                openall = true;
                specialDays[1][x] = tempo[1][x];
            }

            callback();
        },
        complete: function () {
            setTimeout(function () {
                $(".calendarLoader").remove();
            }, 100);
            //            $('#' + datePickerId).datepicker('enable');
            $('#' + datePickerId).datepicker('refresh');
            if (datePickerId == "" || datePickerId == "") {
                $('#inp_flyDriveReturnDate').datepicker('enable');
                $('#inp_flyDriveDepartureDate').datepicker('enable');
            }
            $('#ToDeals').datepicker('enable');
            $('#fromDeals').datepicker('enable');
        }
    });
}

function initDatePickerTo() {

    instance = $('#ToDeals').data("datepicker");
    if ($('#fromDeals').val() != '') {
        date = $.datepicker.parseDate(instance.settings.dateFormat || $.datepicker._defaults.dateFormat, $('#fromDeals').val(), instance.settings);
    } else {
        date = new Date();
    }
    var d = date.getDate() + "";
    var m = date.getMonth() + 1;
    var yerrr = date.getFullYear();
    var key = d + "/" + m + "/" + yerrr;
    if (typeof (specialDays[1][key]) != "undefined") {
        selectedstartdate = {};
        for (var f = 0; f < specialDays[1][key].length; f++) {
            var flightkey = specialDays[1][key][f].endDate.replace('.', '/').replace('.', '/');
            if (flightkey.indexOf("0") == 0) {
                flightkey = flightkey.substring(1);
                flightkey = flightkey.replace("/0", "/");
            }
            flightkey = flightkey.replace("/0", "/");
            selectedstartdate[flightkey] = specialDays[1][key][f];

        }
    }

}

function initDatePickerFrom() {

    setTimeout(function () {
        var date = $.datepicker.parseDate("dd/mm/yy" || $.datepicker._defaults.dateFormat, $('#fromDeals').val());
        if (date == null)
            date = new Date();

        GetSpecialDatesDeals('fromDeals', date.getFullYear(), date.getMonth() + 1, function () {
            initDatePickerTo();
            legendDeals();

        });
    }, 100);
}

function initDatePickerFlyDriveFrom() {

    setTimeout(function () {
        var date = $.datepicker.parseDate("dd/mm/yy" || $.datepicker._defaults.dateFormat, $('#inp_flyDriveDepartureDate').val());
        if (date == null)
            date = new Date();

        GetSpecialDatesDeals('inp_flyDriveDepartureDate', date.getFullYear(), date.getMonth() + 1, function () {
            initDatePickerFlyDriveTo();
            legendDeals();

        });
    }, 100);
}


function initDatePickerFlyDriveTo() {

    instance = $('#inp_flyDriveReturnDate').data("datepicker");
    date = $.datepicker.parseDate(instance.settings.dateFormat || $.datepicker._defaults.dateFormat, $('#inp_flyDriveDepartureDate').val(), instance.settings);
    try {
        var d = date.getDate() + "";
        var m = date.getMonth() + 1;
        var yerrr = date.getFullYear();
        var key = d + "/" + m + "/" + yerrr;
        if (typeof (specialDays[1][key]) != "undefined") {
            selectedstartdate = {};
            for (var f = 0; f < specialDays[1][key].length; f++) {
                var flightkey = specialDays[1][key][f].endDate.replace('.', '/').replace('.', '/');
                if (flightkey.indexOf("0") == 0) {
                    flightkey = flightkey.substring(1);
                    flightkey = flightkey.replace("/0", "/");
                }
                flightkey = flightkey.replace("/0", "/");
                selectedstartdate[flightkey] = specialDays[1][key][f];

            }
        } else {
            return [false, 'not_charter locked'];
        }
    } catch (e) {
        return [false, 'not_charter locked'];
    }
}





function FillRoomsDeals() {
    $(".search_deals_room").each(function (index) {
        if ($(this).is(':visible')) {
            fillValuesOfTemplatesInDDLs_Deals($(this).find(":selected").val());
        }
    });
}


function FillFlyDriveRoomsDeals() {
    fillValuesOfTemplatesInDDLs_Deals('0');//2 Adults Search for Fly Drive Product
}

function fillValuesOfTemplatesInDDLs_Deals(valueAtTemplatesDDL) {

    switch (valueAtTemplatesDDL) {
        case ('0'):
            $("#Room1A").val(2);
            $("#Room1C").val(0);
            break;
        case ('1'):
            $("#Room1A").val(1);
            $("#Room1C").val(0);
            break;
        case ('2'):
            $("#Room1A").val(1);
            $("#Room1C").val(1);
            break;
        case ('3'):
            $("#Room1A").val(1);
            $("#Room1C").val(2);
            break;
        case ('4'):
            $("#Room1A").val(1);
            $("#Room1C").val(3);
            break;
        case ('5'):
            $("#Room1A").val(2);
            $("#Room1C").val(1);
            break;
        case ('6'):
            $("#Room1A").val(2);
            $("#Room1C").val(2);
            break;
        case ('7'):
            $("#Room1A").val(2);
            $("#Room1C").val(3);
            break;
        case ('8'):
            $("#Room1A").val(3);
            $("#Room1C").val(0);
            break;
        case ('9'):
            $("#Room1A").val(3);
            $("#Room1C").val(1);
            break;
        case ('10'):
            $("#Room1A").val(3);
            $("#Room1C").val(2);
            break;
        case ('11'):
            $("#Room1A").val(3);
            $("#Room1C").val(3);
            break;
        case ('12'):
            $("#Room1A").val(4);
            $("#Room1C").val(0);
            break;
        case ('13'):
            $("#Room1A").val(4);
            $("#Room1C").val(1);
            break;
        case ('14'):
            $("#Room1A").val(5);
            $("#Room1C").val(0);
            break;
        default:
            $("#Room1A").val(0);
            $("#Room1C").val(0);
            break;
    }
}


//Change To Deals Mode
function ChangeToDeals() {

    wizard_mode = 1;

    //--Wizard Promotion  Show\Hide
    $('.wizard_suggested_JS').hide();
    $('.wizard_promotions_Deals_JS').fadeIn();

    if ($('.wizard_promotions_Deals_JS').length > 0) {
        $('#div_title_box_suggested').html('הצעות נבחרות לחבילות נופש');
        $('.promotion_home_page_suggested_JS').slideDown();
    } else {
        $('.promotion_home_page_suggested_JS').slideUp();
    }
    ///========================

    $('#a_fly_drive').removeClass('cb_wizard_new');
    $('#a_deals').addClass('cb_wizard_new');

    $('#a_deals').addClass('act');
    $('#a_fly_drive').removeClass('act');

    $("#div_package_destination").show();
    $("#div_package_herkev").show();
    $("#div_package_departure_date").show();
    $("#div_package_return_date").show();
    $(".popularDestinationsIcon_deals").show();
    $("#div_choose_city_destination").show();

    $("#div_package_flydrive_destination").hide();
    $("#div_package_flydrive_departure_date").hide();
    $("#div_package_flydrive_return_date").hide();
}



//Change To FlyDrive Mode
function ChangeToFlyDrive() {

    wizard_mode = 2;
    initFlyDriveDatePickers();

    //--Wizard Promotion  Show\Hide

    $('.wizard_suggested_JS').hide();
    $('.wizard_promotions_FlyDriveDeals_JS').fadeIn();

    if ($('.wizard_promotions_FlyDriveDeals_JS').length > 0) {
        $('#div_title_box_suggested').html('הצעות נבחרות לחבילות טוס וסע');
        $('.promotion_home_page_suggested_JS').slideDown();
    } else {
        $('.promotion_home_page_suggested_JS').slideUp();
    }

    ///========================

    $('#a_fly_drive').addClass('cb_wizard_new');
    $('#a_deals').removeClass('cb_wizard_new');

    $('#a_deals').removeClass('act');
    $('#a_fly_drive').addClass('act');


    $("#div_package_destination").hide();
    $("#div_package_herkev").hide();
    $("#div_package_departure_date").hide();
    $("#div_package_return_date").hide();
    $(".popularDestinationsIcon_deals").hide();
    $("#div_choose_city_destination").hide();

    $("#div_package_flydrive_destination").show();
    $("#div_package_flydrive_departure_date").show();
    $("#div_package_flydrive_return_date").show();

}
function getSubTypesDestinations(_subtype) {
    citiesNames = [];
    $.ajax({
        url: "/Handlers/SubPackageDestinations.ashx",
        dataType: "json",
        data: { subtype: _subtype },
        success: function (data) {
            if (data != null && data.length > 0) {
                for (i = 0; i < data.length; i++) {
                    citiesNames.push(data[i].name);
                }
                $("#ddlSpecialCity").autocomplete({
                    source: citiesNames,
                    minLength: 0,
                    select: function (event, ui) {
                        $("#ddlSpecialCity").attr('class', 'destination_hotel_name');
                    },
                    change: function (event, ui) {
                    },
                    search: function (event, ui) {
                        $("#ddlSpecialCity").attr('class', 'destination_hotel_name_search');
                    },
                    response: function (event, ui) {
                        var cityName = this.value;
                        var resultExist = true;

                        if (cityName != null && cityName != undefined && cityName != "") {
                            if (ui != null && ui != undefined && ui.content != null && ui.content != undefined && ui.content.length == 0) {
                                resultExist = false;
                            }

                            if (!resultExist) {
                                $("#formErrorWrapper").show();
                                autocompleteValid = false;
                            } else {
                                $("#formErrorWrapper").hide();
                                autocompleteValid = true;
                            }
                        } else {
                            $("#formErrorWrapper").hide();
                            autocompleteValid = true;
                        }
                    },
                    close: function (event, ui) {
                        $("#ddlSpecialCity").attr('class', 'destination_hotel_name');
                    }
                }).focus(function () {
                    $(this).autocomplete('search', $(this).val())
                });
            }
        }
    });
}
/* version number */
//-------------------
/* end version number */

//var wizard_mode = 11;
//var specialDays = [];
//specialDays[0] = [];
//specialDays[1] = [];
//var disableDynamicPackage = false;
//var getSpecialDatesTimeout;
//var defaultSettings = "";
//var selectedstartdate = "";
//var activeInput = "";
//var openall = true;

function ActiveSkiControlinitJS() {

    initDatePickerFrom();
    defaultSettings = {
    rangeSelect: true,
    beforeShowDay: function (thedate) {

        var theday = thedate.getDate();
        var d = thedate.getDate();

        var m = thedate.getMonth() + 1;

        var yerrr = thedate.getFullYear();
        var key = d + "/" + m + "/" + yerrr;

        var selectedClass = "ui-datepicker-week-end ui-state-disabled ui-datepicker-week-end ui-datepicker-unselectable ui-state-disabled ui-datepicker-week-end ui-state-disabled ui-state-disabled ui-state-disabled";

        var isutlistOneSelcted = false;

        if (openall)
            selectedClass = "";
            var holiday = "";
        if (this.id == "ToSki") {
            var fromDate = parseDate($("#fromSki").val());
            if (fromDate.getDate() == thedate.getDate() && fromDate.getMonth() == thedate.getMonth() && fromDate.getFullYear() == thedate.getFullYear()) {
                if (typeof (specialDays[0]) != "undefined") {
                    if (typeof (specialDays[0][key]) != "undefined") {
                        holiday = " holiday";
                        }
                        }
                    return [true, "ui-state-disabled ui-datepicker-unselectable ui-state-disabled-start-date" + holiday];
                }
            }

            if (this.id == "fromSki") {

                if (typeof (specialDays[1]) != "undefined") {
                    if (typeof (specialDays[1][key]) != "undefined") {
                        if (typeof (specialDays[0][key]) != "undefined") {
                            return [true, 'charterholiday', specialDays[0][key]];
                            }
                            else {
                                return [true, 'charter', specialDays[1][key].price];
                            }

                            }
                    else {
                        if ((disableDynamicPackage || subjectType == $("#hiddenSportType").val() || subjectType == $("#hiddenHotelCarFlightType").val())) {
                            if (typeof (specialDays[0]) != "undefined") {
                                if (typeof (specialDays[0][key]) != "undefined") {
                                    return [false, 'holiday not_charter', specialDays[0][key]];
                                    }
                            }
                            return [false, 'not_charter locked'];
                                }
                        }
                        }
                else {//if not a charter
                    if ((disableDynamicPackage || subjectType == $("#hiddenSportType").val() || subjectType == $("#hiddenHotelCarFlightType").val())) {
                        if (typeof (specialDays[0]) != "undefined") {
                            if (typeof (specialDays[0][key]) != "undefined") {
                                return [false, 'holiday not_charter', specialDays[0][key]];
                                }
                        }
                        return [false, 'not_charter locked'];
                            }
                            }
                    }
                    else {
                        if (typeof (selectedstartdate[key]) != "undefined") {
                    if (typeof (specialDays[0][key]) != "undefined") {
                        return [true, 'charterholiday', specialDays[0][key]];
                        }
                        else {
                        return [true, 'charter', selectedstartdate[key].price];
                        }
                        }
                else {
                    if (disableDynamicPackage || (subjectType == $("#hiddenSportType").val() || subjectType == $("#hiddenHotelCarFlightType").val())) {
                        if (typeof (specialDays[0]) != "undefined") {
                            if (typeof (specialDays[0][key]) != "undefined") {
                                return [false, 'holiday not_charter', specialDays[0][key]];
                                }
                        }
                        return [false, 'not_charter locked'];
                            }
                            }
                    }

            if (typeof (specialDays[0]) != "undefined") {
                if (typeof (specialDays[0][key]) != "undefined") {
                    return [true, 'holiday ' + selectedClass, specialDays[0][key]];
                    }
                    }

            return [true, selectedClass];
        },


                        beforeShow: function (input, inst) {

        activeInput = inst.id;

        if (!$('.ui-datepicker').parent().hasClass('wrap')) {
            $('.ui-datepicker').wrap("<div class='wrap' id='calendarWrapper'></div>");

            }
        $('.ui-datepicker').parent().removeClass('from').removeClass('to');

        $('.ui-datepicker').parent().addClass(inst.id);

        //Datepicker animation
        $(this).datepicker("option", "showAnim", "fadeIn");
        doDatePickerPositionHandle(input);

            if (inst.id == "fromSki") {

            setDP_classesForJS("False");

            var instance = $(this).data("datepicker");
            var date = $.datepicker.parseDate(instance.settings.dateFormat || $.datepicker._defaults.dateFormat, input.value, instance.settings);
            if (date == null)
                date = new Date();

            GetSpecialDatesSki(inst.id, date.getFullYear(), date.getMonth() + 1, function () {
                $('#fromSki').datepicker("refresh");
                $('#ToSki').datepicker("refresh");
                    legendDeals();

                });
                }
                else {
            if (this.id == "ToSki") {

                setDP_classesForJS("True");

                doDatePickerDateRange();

                var fromDate = parseDate($("#fromSki").val());
                    var toDate = new Date(fromDate);
                    toDate.setDate(fromDate.getDate());

                    $("#ToSki").datepicker("option", "minDate", toDate);
                    }
            $("#ToSki").datepicker("refresh");
            legendDeals();

                }

            },
                onChangeMonthYear: function (year, month, inst) {
            var changeMonthYear = new Date(year, month, 1);
            var currentDate = new Date();
            if (currentDate > changeMonthYear) {
                month = currentDate.getMonth() + 1;
                year = currentDate.getFullYear();

                }
            if (this.id == "fromSki") {
                //אנחנו עושים timeout 
                //כי אם מעבירים מהר בין חודשים אז נוצר מצב ש:
                    //1. יוצאים לחיפוש של תאריכים שלא צריכים ומעמיס על השרת סתם
                    //2. התאריכון בחודש הנדרש לא נצבע
                    //לכן, מחכים חצי שניה, אם העבירו עוד חודש מהר, אנחנו מנקים את הפעולה הקודמת (כדי לא יצא לחיפוש על החודש האמצעי
                clearTimeout(getSpecialDatesTimeout);
                getSpecialDatesTimeout = setTimeout(function () {
                    GetSpecialDatesSki(inst.id, year, month, function () {
                        legendDeals();
                    })

                    }, 500);
            }
            },
                defaultDate: null,
                numberOfMonths: 2,
                            onSelect: function (selectedDate) {
            //            var option = this.id == "fromDeals" ? "minDate" : "maxDate";
            var instance = $(this).data("datepicker");
            date = $.datepicker.parseDate(
						instance.settings.dateFormat ||
						$.datepicker._defaults.dateFormat,
						selectedDate, instance.settings);


            var d = date.getDate() + "";
            var m = date.getMonth() + 1;
            var yerrr = date.getFullYear();
            var key = d + "/" + m + "/" + yerrr;

            if (this.id == "fromSki") {
                if (typeof (specialDays[1][key]) != "undefined") {
                    selectedstartdate = {};
                    for (var f = 0; f < specialDays[1][key].length; f++) {
                        var flightkey = specialDays[1][key][f].endDate.replace('.', '/').replace('.', '/');
                            if (flightkey.indexOf("0") == 0) {
                                flightkey = flightkey.substring(1);
                            flightkey = flightkey.replace("/0", "/");
                        }
                        flightkey = flightkey.replace("/0", "/");
                        selectedstartdate[flightkey] = specialDays[1][key][f];
                        }
                    $("#isSkiDate").val("true");
                    } else {
                    $("#isSkiDate").val("false");
                }


                $("#ToSki").datepicker("option", "minDate", date);
                setTimeout(function () {
                    $("#ToSki").datepicker("setDate", selectedDate);
                    $("#ToSki").datepicker("show");
                }, 100);
                $(".searchPeriod").attr("checked", false);
                } else {//toDeals
                if (typeof (selectedstartdate[key]) == "undefined") {
                    $("#isSkiDate").val("false");
                }
                }

                },
                    minDate: $('#hiddenToday').val(),
                    showOtherMonths: true,
                showMonthAfterYear: false,
                monthNames: ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'],
                    monthNamesShort: ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'],
                        dayNamesMin: ['א', 'ב', 'ג', 'ד', 'ה', 'ו', 'ש'],
                        dateFormat: 'dd/mm/yy'
                        }
            //initFlyDriveDatePickers();

            var dates = $("#fromSki, #ToSki").datepicker(defaultSettings);

$("#ui-datepicker-div").addClass("datepickerWrapper");
setWizardAfterDateChange();
$('.cleanDates').live('click', function () {
    $("#" + activeInput).val('');
    });

$('#ddlNightsRange').bind('change', function () {
    var arr = $(this).val().split('_');
    $('input[name="minNights"]').val(arr[0]);
    $('input[name="maxNights"]').val(arr.length == 1 ? '' : arr[1]);
    });

$('.search_btn').removeClass("mr18");
$('.search_btn').removeClass("mr15_none_impo");
$('.search_btn').addClass("deals_wizard_search_btn");

    $('#ddlNightsRange').trigger('change');
var currentDate = new Date();

}


function GetSpecialDatesSki(datePickerId, year, month, callback) {
    setTimeout(function () {
        $(".ui-datepicker-group").append("<img src='/images/ajax-loader-dots.gif' class='calendarLoader' style='position: absolute;top: 35%; left: 46%' />");
        }, 25);

    var codeType = $("#SkiCodeType").val();
    var url = "";
    var action = "deals";

    url = "/Handlers/CalanderDates.ashx?m=" + month + "&y=" + year + "&from=" + $('#originSki').val() + "&to=" + $('#SkiDestination').val() + "&toOdyssea=" + $("#hiddenOdyseaDestinationSki").val() + "&actioncharter=" + action + "&subjectType=" + subjectType + "&codeType=" + codeType;


    specialDays = [];
    specialDays[0] = [];
    specialDays[1] = [];

    openall = true;

    $.ajax({
                type: 'GET',
                url: url,
                async: true,
            cache: true,
            jsonpCallback: 'DatesCallBack',
                contentType: "application/json",
                dataType: 'jsonp',
                    success: function (dates) {

                //check if disable dynamic packages dates
                if (dates.isFindDynamicPackagesDates != undefined && dates.isFindDynamicPackagesDates == "False") {
                disableDynamicPackage = true;
                } else if (dates.isFindDynamicPackagesDates != undefined && dates.isFindDynamicPackagesDates == "True") {
                disableDynamicPackage = false;
                }

            var tempo = dates.data;
            for (var i in tempo[0]) {
                specialDays[0][i] = tempo[0][i];
                }

                for (var x in tempo[1]) {
                    openall = true;
                    specialDays[1][x] = tempo[1][x];
                    }

                callback();
        },
                        complete: function () {
                setTimeout(function () {
                $(".calendarLoader").remove();
            }, 100);
                //            $('#' + datePickerId).datepicker('enable');
                $('#' + datePickerId).datepicker('refresh');
            if (datePickerId == "" || datePickerId == "") {
                $('#inp_flyDriveReturnDate').datepicker('enable');
                $('#inp_flyDriveDepartureDate').datepicker('enable');
                }
            $('#ToDeals').datepicker('enable');
            $('#fromDeals').datepicker('enable');
            }
            });
            }


            function FillRoomsSki() {

    $(".search_ski_room").each(function (index) {
        if ($(this).is(':visible')) {
            fillValuesOfTemplatesInDDLs_Ski($(this).find(":selected").val());
            }
            });
            }

function fillValuesOfTemplatesInDDLs_Ski(valueAtTemplatesDDL) {

    switch (valueAtTemplatesDDL) {
        case ('0'):
            $("#SkiRoom1A").val(2);
            $("#SkiRoom1C").val(0);
            break;
        case ('1'):
            $("#SkiRoom1A").val(1);
            $("#SkiRoom1C").val(0);
            break;
        case ('2'):
            $("#SkiRoom1A").val(1);
            $("#SkiRoom1C").val(1);
            break;
        case ('3'):
            $("#SkiRoom1A").val(1);
            $("#SkiRoom1C").val(2);
            break;
        case ('4'):
            $("#SkiRoom1C").val(3);
            $("#SkiRoom1A").val(1);
            break;
        case ('5'):
            $("#SkiRoom1A").val(2);
            $("#SkiRoom1C").val(1);
            break;
        case ('6'):
            $("#SkiRoom1A").val(2);
            $("#SkiRoom1C").val(2);
            break;
        case ('7'):
            $("#SkiRoom1A").val(2);
            $("#SkiRoom1C").val(3);
            break;
        case ('8'):
            $("#SkiRoom1A").val(3);
            $("#SkiRoom1C").val(0);
            break;
        case ('9'):
            $("#SkiRoom1A").val(3);
            $("#SkiRoom1C").val(1);
            break;
        case ('10'):
            $("#SkiRoom1A").val(3);
            $("#SkiRoom1C").val(2);
            break;
        case ('11'):
            $("#SkiRoom1A").val(3);
            $("#SkiRoom1C").val(3);
            break;
        case ('12'):
            $("#SkiRoom1A").val(4);
            $("#SkiRoom1C").val(0);
            break;
        case ('13'):
            $("#SkiRoom1A").val(4);
            $("#SkiRoom1C").val(1);
            break;
        case ('14'):
            $("#SkiRoom1A").val(5);
            $("#SkiRoom1C").val(0);
            break;
        default:
            $("#SkiRoom1A").val(0);
            $("#SkiRoom1C").val(0);
            break;
            }

            }

                //Change To Ski Mode
                function ChangeToSki() {

    wizard_mode = 11;

//--Wizard Promotion  Show\Hide
    $('.wizard_suggested_JS').hide();
    $('.wizard_promotions_Ski_JS').fadeIn();

    if ($('.wizard_promotions_Ski_JS').length > 0) {
        $('#div_title_box_suggested').html('הצעות נבחרות לחבילות סקי');
        $('.promotion_home_page_suggested_JS').slideDown();
        } else {
        $('.promotion_home_page_suggested_JS').slideUp();
        }

    $('#a_deals').addClass('cb_wizard_new');

    $('#a_deals').addClass('act');

    $("#div_package_destination").show();
    $("#div_package_herkev").show();
    $("#div_package_departure_date").show();
    $("#div_package_return_date").show();
    $("#div_choose_city_destination").show();
    }

/* version number */
//-------------------
/* end version number */

var multiClickIndexes = [];
var allListItems = [];

$(document).ready(function () {

    if ($("#txtCityDeals").length > 0) {
        $("#txtCityDeals").autocomplete({
            position: { my: "right top", at: "right bottom" },
            source: function (request, response) {
                var productTypeForHandler = $("#hdn_wizard").val();
                $.ajax({
                    //url: "/Handlers/Destinations.ashx",
                    url: "/Handlers/UmbracoDestination.ashx",
                    dataType: "json",
                    //data: { value: request.term },
                    data: { value: request.term, vendorID: 0, abroad: 1, ProductType: productTypeForHandler },
                    success: function (data) {
                        allListItems = [];
                        if (data != null && data.length > 0) {
                            if ($('#title_Deals').length == 0 || $('#title_Deals').hasClass('act')) {
                                response($.map(data, function (item) {
                                    return AddDealsDestination(request.term, item);
                                }));
                            }

                        }
                    }
                });
            },
            /*focus: function (event, ui) {
            $("#txtCity").val(ui.item.label);
            $("#txtCity").attr('shortName', ui.item.shortName);
            return false;
            },*/
            select: function (event, ui) {
                //   alert(ui.item.destinationCode2);
                //$('#trAbroadHotel').hide();
                $('#hiddenOdyseaDestinationDeals').val(ui.item.odysseaCode);
                $('#CityDeals').val(ui.item.destinationCode);
                $('#hiddenCountryDeals').val(ui.item.countryCode);
                $("#txtCityDeals").attr('shortName', ui.item.shortName);
                $("#txtCityDeals").val(ui.item.shortName);
                $("#txtCityDeals").attr('code', ui.item.destinationCode);

                $('#hiddenCityCodeDeals').val(ui.item.cityCode);
                $('#hiddendestCodeType').val(ui.item.destCodeType);
                event.preventDefault();
                $('#ddlHotel').empty();
                if ($('.hiddenContainer').length > 0) {
                    //getProducts();
                }
                $('#WhenShortBox').hide();
                $('#divWhenShortBox').show();
            }
        }).data("ui-autocomplete")._renderItem = function (ul, item) {
            // only change here was to replace .text() with .html()
            return $("<li></li>")
                  .data("item.autocomplete", item)
                  .append($("<a></a>").html(item.label))
                  .appendTo(ul);
        };
    }

    $("#inp_flyDriveDestination").autocomplete({
        position: { my: "right top", at: "right bottom" },
        source: function (request, response) {
            $.ajax({
                url: "/Handlers/Destinations.ashx",
                dataType: "json",
                //data: { value: request.term },
                data: { value: request.term, vendorID: 0, abroad: 1 },
                success: function (data) {

                    if (data != null && data.length > 0) {
                        response($.map(data, function (item) {
                            return { label: item.destinationName, value: item.destinationCode, countryCode: item.countryCode, shortName: item.shortName, odysseaCode: item.destinationCode2 }
                        }));
                    }
                    else {

                    }
                }
            });
        },
        select: function (event, ui) {
            $('#CityDealsFlyDrive').val(ui.item.value);
            $('#hiddenOdyseaDestinationFlyDriveDeals').val(ui.item.odysseaCode);
            $('#hiddenCountryFlyDriveDeals').val(ui.item.countryCode);

            $("#inp_flyDriveDestination").attr('shortName', ui.item.shortName);
            $("#inp_flyDriveDestination").val(ui.item.label);
            $("#inp_flyDriveDestination").attr('code', ui.item.value);

            event.preventDefault();

        }
    });

    $('#ddlDestinations').bind('change', function () {
        $('#CityDeals').val($(this).val());
        $('#hiddenCountryDeals').val($(this).children('option:selected').attr('rel'));
    });

    $('#ddlRoomsNum').live('change', function () {
        ddlRoomsNum_Change($(this).val());
    });

    $('#fromDeals,#ToDeals').focus(function (e) {
        e.preventDefault();
        e.stopPropagation();
        $(this).datepicker('show');
        if ($('#hiddenProduct').val() == 'flydrivedeals') {
            $('.ui-datepicker-today').children('a').removeClass('ui-state-highlight').removeClass('ui-state-hover');
        }
    });
});


function ddlRoomsNum_Change(roomCount) {
    var room1Html = $('#tblRoom1').html();

    for (var i = 2; i <= 3; i++) {

        //if the room table exists
        if ($('#tblRoom' + i).length > 0) {
            ///show relevant room tables only
            if (i <= roomCount) {
                var roomiHtml = room1Html.replace(/Room1/g, 'Room' + i);

                ///if the room table is not currently visible - create it with default values
                ///existing room selections won't be changed
                if ($('#tblRoom' + i).html().toLowerCase() == '<tbody></tbody>' || $('#tblRoom' + i).html() == '') {
                    $('#tblRoom' + i).html(roomiHtml);
                    //romm title
                    $('#spnRoom' + i + 'Index').html(i);

                    ///default candidates
                    $('#ddlAdultNumRoom' + i).val('1');
                    $('#ddlChildNumRoom' + i).val('0');
                    $('#ddlBabyNumRoom' + i).val('0');
                }
            }
                ///hide irelevant room tables
            else {
                $('#tblRoom' + i).html('<TBODY></TBODY>');
            }
        }
    }
}

function getProducts() {
    //בודק האן יש צורך לבצע חיפוש של שמות מלונות בלבד
    if ($('#ddlHotel').length == 0) {
        return;
    }
    var arrHotelOptions = [];
    var loadPackges = true;
    $('#ddlHotel').empty();
    var url = '/Handlers/DealsMultiSelect.ashx';
    if ($('#isDynamicDeal').length) {
        url = "/Handlers/AbroadPackagesMultiSelect.ashx"
    }
    //Fill hidden Filed from Tepmlate
    fillValuesOfTemplatesInDDLs_Deals($('#ddlAdultNumRoom1Deals').val());

    $.ajax({
        url: url,
        dataType: "json",
        async: true,
        cache: false,
        data: {
            destination: $('#CityDeals').val(), ddlCountry: $('#hiddenCountryDeals').val(),
            to: $('#ToDeals').val(),
            from: $('#fromDeals').val(), abroad: 1, citycode: $('#hiddenCityCodeDeals').val(),
            Room1A: $('#Room1A').val(), Room1C: $('#Room1C').val(), rank: $('#rank').val(),
            OdysseaCode: $("#hiddenOdyseaDestinationDeals").val()
        },
        beforeSend: function () {
            $('#dealsAbroadHotelLoader').show();
        },
        success: function (data) {
            if ($.trim(data) != "") {
                for (i = 0; i < data.length; i++) {
                    arrHotelOptions.push(data[i].Name);
                }
                $('#trAbroadHotel').show();
            }
            else {
                loadPackges = false;
                $('#trAbroadHotel').hide();
            }
        },
        error: function (jqXHR, textStatus, errorThrown) {

        },
        complete: function () {
            if (loadPackges) {
                $('#ddlHotel').html($("<option>", { text: 'הכל', value: '-1' }));
                for (var i = 0; i < arrHotelOptions.length; i++) {
                    $('#ddlHotel').append($("<option>", { text: arrHotelOptions[i], value: arrHotelOptions[i] }));
                }
                //Check About MultiSelect
                //initMultiSelect('ddlHotel');
            }
            $('#dealsAbroadHotelLoader').hide();
        }
    });
}


function initMultiSelect(id) {

    if ($('#' + id).children('option').length > 0) {
        $('#' + id).multiselect({
            classes: 'hotelMultiSelect',
            open: function () {
                $('.ui-multiselect-menu').jScrollPane('destroy');
                $('.ui-multiselect-menu').jScrollPane({
                    scrollbarMargin: 0,
                    verticalDragMinHeight: 34,
                    wheelSpeed: 71
                });
                var pos = $('.hotelMultiSelect').position();
                $('.hotelMultiSelect').css('left', pos.left - 114 + 'px');
                $('.jspHorizontalBar').hide();
                $('.jspHorizontalBar .jspTrack').hide();
                $('.jspHorizontalBar .jspCorner').hide();
                $('.jspTrack').css('height', '148px');
                fillSelected();
            },
            header: false,
            checkAllText: '', // בחר הכל
            uncheckAllText: '', //בטל הכל
            height: 'auto',
            width: 'auto',
            show: ['fade', 500],
            multiple: true,
            autoOpen: false,
            noneSelectedText: 'בחר/י',
            selectedText: 'נבחרו # מלונות',
            close: function () {
                var values = new Array();
                $(this).multiselect("getChecked").each(function (index, item) {
                    values.push($(item).val());
                });
            },
            click: function () {
                multiClickIndexes = [];
                var array_of_checked_values = $(this).multiselect("getChecked").map(function (index, item) {
                    return { index: $(item).parents('li').index(), name: this.value };
                }).get();
                var filters = "";

                for (i = 0; i < array_of_checked_values.length; i++) {
                    filters += array_of_checked_values[i].name + "|";
                    multiClickIndexes.push(array_of_checked_values[i].index);
                }
                $('input[name="filter"]').val(filters);
                DoFilter();
            }
        });
        $('#' + id).multiselect("uncheckAll");

        $('#ddlHotel').append($("<option></option>").attr("value", "-1").text(" CHOOSEALL: PackagesAbroad"));
        $('#ddlHotel option[value="-1"]').attr('selected', true);
        $('#trAbroadHotel').show();

    }
    else {
        $('#trAbroadHotel').hide();
    }
}

function fillSelected() {
    for (var i = 0; i < multiClickIndexes.length; i++) {
        $("#ddlHotel").multiselect("widget").find(":checkbox:eq(" + multiClickIndexes[i] + ")").attr('checked', true);
    }
}

function NightsChanged(nights) {
    var strDate = $('#fromDeals').val();
    var dateParts = strDate.split("/");
    var d = new Date(dateParts[2], (dateParts[1] - 1), dateParts[0]);
    d = addDays(d, Number(nights));
    $('#to').val(addZero(d.getDate(), 'day') + "/" + addZero(Number(d.getMonth()), 'month') + "/" + d.getFullYear());
}

function addZero(num, dateCase) {
    switch (dateCase) {
        case "month":
            num++;
            break;
        default:
            break;
    }

    if (num < 10) {
        return "0" + num;
    }
    return num;
}

function addDays(myDate, days) {
    return new Date(myDate.getTime() + days * 24 * 60 * 60 * 1000);
}

var decodeEntities = (function () {
    // this prevents any overhead from creating the object each time
    var element = document.createElement('div');

    function decodeHTMLEntities(str) {
        if (str && typeof str === 'string') {
            // strip script/html tags
            str = str.replace(/<script[^>]*>([\S\s]*?)<\/script>/gmi, '');
            str = str.replace(/<\/?\w(?:[^"'>]|"[^"]*"|'[^']*')*>/gmi, '');
            element.innerHTML = str;
            str = element.textContent;
            element.textContent = '';
        }

        return str;
    }

    return decodeHTMLEntities;
})();


// add destination to list for dropdown
function AddDealsDestination(term, item) {

    var displayName = "";
    var SearchResultFormat = "";
    var code = item.destinationCode;

    if (allListItems[code] == true && !item.isChild) {
        return ;
    }

    var cityName = (item.cityNameHe != undefined && item.cityNameHe != "") ? item.cityNameHe : item.cityName;
    if (item.isRegional) {
        item.SearchResultFormat = displayName = cityName + " - כל היעדים ";
    }
    else {
        if (item.cityNameHe != undefined && item.cityNameHe != "") {
            displayName = item.cityNameHe;

        } else {
            displayName = item.CityName;
        }

        SearchResultFormat = "";
        if (item.cityNameHe != undefined && item.cityNameHe != "") {
            SearchResultFormat += item.cityNameHe + ", ";
        }

        if (item.countryNameHe != undefined && item.countryNameHe != "") {
            SearchResultFormat += item.countryNameHe + ", ";
        }

        SearchResultFormat += code + ", ";

        if (item.cityName != undefined && item.cityName != "") {
            SearchResultFormat += item.cityName + ", ";
        }

        if (item.countryNameHe == undefined || item.countryNameHe == "") {
            SearchResultFormat += item.countryName + ", ";
        }

        item.SearchResultFormat = SearchResultFormat.slice(0, -2);


    }


    //if it's Tel Aviv we only want to display the city name
    if (code == "TLV") {
        if (item.CityNameHe != undefined && item.CityNameHe != "") {
            displayName = item.CityNameHe;
        } else {
            displayName = "תל אביב";
        }
    }

    //// check if have dynamic option to search (id 3) if not will lock the calender
    //var lockDates = true;
    //if (!isRegional) {
    //    lockDates = SetDealsLoackDates(item);
    //}


    var label = __highlight(item.SearchResultFormat, term);

    if (item.isChild) {
        label = "<i class='icon-arrow_airport'></i> " + label;
    }

    allListItems[code] = true;

    return {
    label: label,
    value: displayName,
    countryCode: item.countryCode,
    destinationCode: code,
    shortName: item.shortName,
    odysseaCode: item.destinationCode2,
    destCodeType: item.destCodeType
    }

}



function __highlight(s, t) {
    var matcher = new RegExp("(" + $.ui.autocomplete.escapeRegex(t) + ")", "ig");
    if (matcher != undefined) {
        return s.replace(matcher, "<strong>$1</strong>");
    } else {
        return s;
    }
}
/* version number */
//-------------------
/* end version number */




//Set Passanger Defualt Value and select all text box text 
function initDefualtFLightSetting() {
    $('.search_btn').removeClass("mr15_none_impo");
    $('.search_btn').removeClass("mr7");
    $('.search_btn').removeClass("deals_wizard_search_btn");
    $('.search_btn').removeClass("mr18");
    $('.search_btn').removeClass("mt0");

    //default Tel Aviv
    if ($("#txtoriginFlight").attr("code") == "" || $("#txtoriginFlight").val() == "עיר או שדה תעופה") {
       $("#txtoriginFlight").val("תל אביב");
       $("#txtoriginFlight").attr("code", "TLV");
    }

    //Round Trip by defualt
    ChangeToFlightRoundTrip();
    //highlight LAl Text When Clicking on text box
    $(".autoselect")
       .focus(function () { $(this).select(); })
       .mouseup(function (e) { e.preventDefault(); });

    //Set Defualt Passanger Value 
    if ($("#adult").val() + $("#child").val() == 0)
        $("#adult").val(1);

}
///Chnage To Flight  One Why
function ChangeToFlightOneWey() {

    HandleClassChangeFlightOneWay();
    HandlePositionsChangeFlightOneWay();

    $('.title-wizard h2').show();

    $('.img_home_page').animate({ height: 540 }, 200);

    //Show Wizard Promotion
    $('.promotion_home_page_flight').show();

    HideThirdDestination();

    $('#div_flight_return_date').hide();
    $('#hidden_WaysFlight').val('1');
    HideMultiTripFlightField();
    $('#txtoriginFlight').attr('data-prompt-position', 'topLeft:160');

    $('#txtoriginFlight').addClass('destination_from_img_flight');
    $('#txtdestinationFlight').addClass('destination_to_img_flight');
    $('#txtdestinationFlight').attr('data-prompt-position', 'topLeft:200');

    $('#fromFlight').attr('data-prompt-position', 'topLeft:300');
    $('#RoundTrip').removeClass('cb_wizard_new');
    $('#RoundTrip').removeClass('act');
    $('#ManyWays').removeClass('cb_wizard_new');
    $('#ManyWays').removeClass('act');
    $('#OneWey').addClass('cb_wizard_new');
    $('#OneWey').addClass('act');


    //FOR POPULAR DESTINATIONS - Pablo
    var num = $(".destinationForPopularDestination").attr("num")
    $(".destinationForPopularDestination").removeAttr("num");
    $(".popularDestinationsIcon_flights_" + num).removeAttr("num").addClass("popularDestinationsIcon_flights");
    $(".popularDestinationsIcon_flights").removeClass("popularDestinationsIcon_flights_" + num);
    closePopularDestinations("flights");

    //FOR COMPANIES AND HERKEV
    $(".search_herkev_flights_multi").addClass("search_herkev_flights").removeClass("search_herkev_flights_multi").removeClass("twodestinations");
    $(".search_company_multi").addClass("search_company").removeClass("search_company_multi").removeClass("twodestinations");
    $(".box_herkev_wrapper_multi").addClass("box_herkev_wrapper").removeClass("box_herkev_wrapper_multi");
    $(".passengersDiv").hide();
    $(".newDestinationLabel").hide();
    //HIDE 3days +/- option
    HideCalendarOption();

    RemoveErrorMsg();

    //HIDE 3days +/- option
    $("#div_oneway_domestic").show();

    $("#form_wizard_flight").validationEngine();


    setBackgroundHeight();
}

//Change To Flight Round Trip
function ChangeToFlightRoundTrip() {

    HandleClassChangeFlightTwoWays();
    HandlePositionsChangeFlightTwoWays();

    $('.title-wizard h2').show();

    $('.img_home_page').animate({ height: 540 }, 200);

    //Show Wizard Promotion
    $('.promotion_home_page_flight').show();

    HideThirdDestination();

    $('#div_flight_return_date').show();
    $('#hidden_WaysFlight').val('2');

    HideMultiTripFlightField();
    $('#txtoriginFlight').attr('data-prompt-position', 'topLeft:160');

    $('#txtoriginFlight').addClass('destination_from_img_flight');
    $('#txtdestinationFlight').addClass('destination_to_img_flight');
    $('#txtdestinationFlight').attr('data-prompt-position', 'topLeft:200');

    $('#fromFlight').attr('data-prompt-position', 'topLeft:70');

    $('#RoundTrip').addClass('cb_wizard_new');
    $('#ManyWays').removeClass('cb_wizard_new');
    $('#OneWey').removeClass('cb_wizard_new');

    $('#ManyWays').removeClass('act');
    $('#OneWey').removeClass('act');
    $('#RoundTrip').addClass('act');

    //FOR POPULAR DESTINATIONS - Pablo
    var num = $(".destinationForPopularDestination").attr("num")
    $(".destinationForPopularDestination").removeAttr("num");
    $(".popularDestinationsIcon_flights_" + num).removeAttr("num").addClass("popularDestinationsIcon_flights");
    $(".popularDestinationsIcon_flights").removeClass("popularDestinationsIcon_flights_" + num);
    closePopularDestinations("flights");

    //FOR COMPANIES AND HERKEV
    $(".search_herkev_flights_multi").addClass("search_herkev_flights").removeClass("search_herkev_flights_multi").removeClass("twodestinations");
    $(".search_company_multi").addClass("search_company").removeClass("search_company_multi").removeClass("twodestinations");
    $(".box_herkev_wrapper_multi").addClass("box_herkev_wrapper").removeClass("box_herkev_wrapper_multi");
    $(".passengersDiv").hide();
    $(".newDestinationLabel").hide();


    //HIDE 3days +/- option
    $(".calendar_wraper").show();

    RemoveErrorMsg();
    try{
        setBackgroundHeight();
    }catch (ex){}
}

//Change To Flight Multi Trip
function ChangeToFlightMultiWey() {

    HandleClassChangeFlightMultiWays();
    HandlePositionsChangeFlightMultiWays();

    $('.title-wizard h2').hide();

    //hide Wizard Promotion
    $('.promotion_home_page_flight').hide();

    $('#div_flight_return_date').hide();
    $('#hidden_WaysFlight').val('3');//at first we do the multi segemnt as OpenJaw tryp (only 2 segment will be valid) (if the user set the third segment, we change this attr to 4)
    ShrinkTextBox();
    ShowMultiTripFlightField();

    $('#txtoriginFlight').removeClass('destination_from_img_flight');
    $('#txtoriginFlight').attr('data-prompt-position', 'topLeft:90');
    $('#txtdestinationFlight').attr('data-prompt-position', 'topLeft:100');

    $('#txtdestinationFlight').removeClass('destination_to_img_flight');
    $('#fromFlight').attr('data-prompt-position', 'topLeft:100');

    $('#ManyWays').addClass('cb_wizard_new');
    $('#RoundTrip').removeClass('cb_wizard_new');
    $('#OneWey').removeClass('cb_wizard_new');

    $('#ManyWays').addClass('act');
    $('#OneWey').removeClass('act');
    $('#RoundTrip').removeClass('act');
    //Fill Values At ManyWay Fields
    $('#txtfrom2').val($('#txtdestinationFlight').val());

    //FOR POPULAR DESTINATIONS - Pablo
    $(".popularDestinationsIcon_flights").attr("num", 1).addClass("popularDestinationsIcon_flights_1")
    $(".popularDestinationsIcon_flights_1").removeClass("popularDestinationsIcon_flights");
    $(".destinationForPopularDestination").attr("num", 1);

    //FOR COMPANIES AND HERKEV
    $(".search_herkev_flights").addClass("search_herkev_flights_multi").addClass("twodestinations").removeClass("search_herkev_flights");
    $(".search_company").addClass("search_company_multi").addClass("twodestinations").removeClass("search_company");
    $(".box_herkev_wrapper").addClass("box_herkev_wrapper_multi").removeClass("box_herkev_wrapper");
    $(".passengersDiv").hide();
    $(".newDestinationLabel").show();

    //HIDE 3days +/- option
    HideCalendarOption();

    RemoveErrorMsg();

    //THIS FUNCTION IS ON flights.js
    setBackgroundHeight();
}


function HandleClassChangeFlightMultiWays() {

    $('#row_wizard_fourth_row').show();

    $('#div_flight_departure').removeClass('ddl-flight-departure');
    $('#div_flight_arrival').removeClass('ddl-flight-arrival');
    $('#div_flight_departure_date').removeClass('ddl-flight-departure-date');
    $('#div_flight_airline').removeClass('ddl-flight-airline');
    $('#div_flight_herkev').removeClass('ddl-flight-herkev');
    $('#div_flight_departure_date').removeClass('ddl-flight-departure-date-one-direction');
    $('.img_home_page').removeClass('height585');

    $('#box_herkev_wrapper').removeClass('top215px');

    $('#div_flight_departure').addClass('ddl-flight-multi-destination');
    $('#div_flight_arrival').addClass('ddl-flight-multi-arrival');
    $('#div_flight_departure_date').addClass('ddl-flight-multi-departure-date');
    $('#div_flight_airline').addClass('ddl-flight-multi-airline');
    $('#div_flight_herkev').addClass('ddl-flight-multi-herkev');

}


function HandlePositionsChangeFlightMultiWays() {

    $('#div_flight_departure').insertAfter('#div_first_row_flights');
    $('#div_flight_arrival').insertAfter('#div_flight_departure');
    $('#div_flight_departure_date').insertAfter('#div_flight_arrival');

    $('#div_flight_multi_destination2').insertAfter('#div_second_row_flights');
    $('#div_flight_multi_arrival2').insertAfter('#div_flight_multi_destination2');
    $('#div_flight_multi_departure_date2').insertAfter('#div_flight_multi_arrival2');

    $('#div_flight_herkev').insertAfter('#div_fourth_row_flights');
    $('#div_flight_airline').insertAfter('#div_flight_herkev');
    $('#div_btn_search').insertAfter('#div_flight_airline');

}

function HandleClassChangeFlightOneWay() {

    $('#row_wizard_fourth_row').hide();

    $('.img_home_page').removeClass('height585');
    $('#div_flight_departure').removeClass('ddl-flight-multi-destination');
    $('#div_flight_arrival').removeClass('ddl-flight-multi-arrival');
    $('#div_flight_departure_date').removeClass('ddl-flight-multi-departure-date');
    $('#div_flight_departure_date').removeClass('ddl-flight-departure-date');
    $('#div_flight_airline').removeClass('ddl-flight-multi-airline');
    $('#div_flight_herkev').removeClass('ddl-flight-multi-herkev');

    $('#box_herkev_wrapper').removeClass('top215px');

    $('#div_flight_departure').addClass('ddl-flight-departure');
    $('#div_flight_arrival').addClass('ddl-flight-arrival');
    $('#div_flight_departure_date').addClass('ddl-flight-departure-date-one-direction');
    $('#div_flight_airline').addClass('ddl-flight-airline');
    $('#div_flight_herkev').addClass('ddl-flight-herkev');

}

function HandlePositionsChangeFlightOneWay() {

    $('#div_flight_departure').insertAfter('#div_first_row_flights');
    $('#div_flight_arrival').insertAfter('#div_flight_departure');
    $('#div_flight_herkev').insertAfter('#div_flight_arrival');

    $('#div_flight_departure_date').insertAfter('#div_second_row_flights');
    $('#div_flight_return_date').insertAfter('#div_flight_departure_date');
    $('#div_flight_airline').insertAfter('#div_flight_return_date');
    $('#div_btn_search').insertAfter('#div_flight_airline');

}

function HandleClassChangeFlightTwoWays() {

    $('#row_wizard_fourth_row').hide();

    $('#div_flight_departure').removeClass('ddl-flight-multi-destination');
    $('#div_flight_arrival').removeClass('ddl-flight-multi-arrival');
    $('#div_flight_departure_date').removeClass('ddl-flight-multi-departure-date');
    $('#div_flight_airline').removeClass('ddl-flight-multi-airline');
    $('#div_flight_herkev').removeClass('ddl-flight-multi-herkev');
    $('#div_flight_departure_date').removeClass('ddl-flight-departure-date-one-direction');

    $('#box_herkev_wrapper').removeClass('top215px');

    $('#div_flight_departure').addClass('ddl-flight-departure');
    $('#div_flight_arrival').addClass('ddl-flight-arrival');
    $('#div_flight_departure_date').addClass('ddl-flight-departure-date');
    $('#div_flight_airline').addClass('ddl-flight-airline');
    $('#div_flight_herkev').addClass('ddl-flight-herkev');

}

function HandlePositionsChangeFlightTwoWays() {

    $('#div_flight_departure').insertAfter('#div_first_row_flights');
    $('#div_flight_arrival').insertAfter('#div_flight_departure');
    $('#div_flight_herkev').insertAfter('#div_flight_arrival');

    $('#div_flight_departure_date').insertAfter('#div_second_row_flights');
    $('#div_flight_return_date').insertAfter('#div_flight_departure_date');
    $('#div_flight_airline').insertAfter('#div_flight_return_date');
    $('#div_btn_search').insertAfter('#div_flight_airline');

}


function HideCalendarOption() {
    $(".calendar_wraper").hide();
    $("#calendarOnly").val("false");
}

function HideMultiTripFlightField() {

    $('#div_flight_multi_destination2').hide();
    $('#div_flight_multi_arrival2').hide();
    $('#div_flight_multi_destination3').hide();
    $('#div_flight_multi_arrival3').hide();
    $('#div_flight_multi_departure_date2').hide();
    $('#div_flight_multi_departure_date3').hide();
    $(".popularDestinationsIcon_flights_2").hide();
    $(".popularDestinationsIcon_flights_3").hide();

}
function ShowMultiTripFlightField() {

    $('#div_flight_multi_destination2').show();
    $('#div_flight_multi_arrival2').show();
    $('#div_flight_multi_destination3').show();
    $('#div_flight_multi_arrival3').show();
    $('#div_flight_multi_departure_date2').show();
    $('#div_flight_multi_departure_date3').show();
    $(".popularDestinationsIcon_flights_2").show();
    $(".popularDestinationsIcon_flights_3").show();
}

//Shrink  text Box For multy wey Flight Wizard

function ShrinkTextBox() {
    //Exit Image
    var root = location.protocol + '//' + location.host;
}


function setCalanderDates(dates) {
    var arr = [];
    arr = dates.split('_');
    var dateFrom = tm(arr[0]);
    var dateTo = tm(arr[1]);

    $('#fromFlight').datepicker('setDate', new Date(dateFrom));
    $('#toFlight').datepicker('setDate', new Date(dateTo));

    //calculation of the new night
    dateFrom = new Date($('#Flight').datepicker('getDate').getFullYear(), $('#Flight').datepicker('getDate').getMonth(), $('#Flight').datepicker('getDate').getDate());
    dateTo = new Date($('#toFlight').datepicker('getDate').getFullYear(), $('#toFlight').datepicker('getDate').getMonth(), $('#toFlight').datepicker('getDate').getDate());
    dateFrom = $('#Flight').datepicker('getDate');
    dateTo = $('#toFlight').datepicker('getDate');
    var difference_ms = Math.abs(dateFrom.getTime() - dateTo.getTime());
    var ONE_DAY = 1000 * 60 * 60 * 24;
    $('#txtNightsNum').val(Math.floor(difference_ms / ONE_DAY));
}



function SetWey() {
    $('.waysradios').change(function () {
        if ($('#ManyWays').is(':checked')) {
            $('#searchPeriodSimpleOneWay').hide();
        }
        else {
            $('#searchPeriodSimpleOneWay').show();
        }
    });
}



function finishLoad() {

    var ways = getQuerystring('ways');
    if (ways == 2) {
        //rdoSearchWizardTwoWays_Click();
    }
    if (ways == 1) {
        //    rdoSearchWizardOneWays_Click();
    }
    if (ways > 100) {
        //  rdoSearchWizardManyWays_Click();
    }
    if (typeof (window.FixHeight) == "function") {
        FixHeight();
    }
    formDeserialize();

    if (typeof (window.initDestination) == "function") {

        initDestination();
    }

    setDestinationAutoComplete();

    setWizardControls();
}

function setFlightItem(src, code) {
    $('#' + src).val(code);
    setDestinationAutoComplete();
    setWizardControls();

    $('.searchWizardMore').hide();
}

function getDestinationListByCountryCode(countryId, controlId) {
    $.ajax({
        url: "/Handlers/Wizard_Flight_CountryCities.aspx",
        data: { countryId: countryId, src: controlId },
        success: function (data) {
            $('#DivDestinations').html(data);
        }
    });
}

function setWizardControls() {
    if (($('#originFlight').val() != "" && $('#originFlight').val() != -1) && ($('#destinationFlight').val() != "" && $('#destinationFlight').val() != -1)) {
        $('.showControl').show();
        $('.boxs').hide();
    }
}

/* for internal flights*/
function SetInternalFlight() {
    $('#originFlight').bind('change', function () {
        setWizardControls();
    });
    $('#destinationFlight').bind('change', function () {
        setWizardControls();
    });

    $('.aClosePopUp').live('click', function (e) {
        $(this).closest().parents('.searchWizardMore').hide("slide", { direction: "right" }, 500);
    });

    $('.cleanDates').live('click', function () {
        $("#fromFlight, #toFlight").val('');
        $("#firstDate,#secondDate,#thirdDate").val('');
    });

    $('.cleanDates2').live('click', function () {
        $("#firstDate,#secondDate,#thirdDate").val('');
    });


    ///   $("#TwoWays").live('click', rdoSearchWizardTwoWays_Click);
    ///   $("#OneWays").live('click', rdoSearchWizardOneWays_Click);
    ///   $("#ManyWays").live('click', rdoSearchWizardManyWays_Click);
    ///


}


function setWizardAfterAutoComplete() {
    if (($('#originFlight').val() != "" && $('#originFlight').val() != null) && ($('#destinationFlight').val() != "" && $('#destinationFlight').val() != null)) { // wizard flights
        $('.showControl').show();
        $('.boxs').hide();
    }
}

var specialDays = [];
specialDays[0] = [];
specialDays[1] = [];
var selectedstartdate = "";
var activeInput = "";

var defaultSettings = "";


//one Wey - Round Trip Calender
function SetFlightoneWayJS() {


    defaultSettings = {

        beforeShowDay: function (thedate) {
            var theday = thedate.getDate();
            var d = thedate.getDate();
            var m = thedate.getMonth() + 1;
            var yerrr = thedate.getFullYear();
            var key = d + "/" + m + "/" + yerrr;
            var selectedClass = "";

            if (this.id == "toFlight") {
                var fromDate = parseDate($("#fromFlight").val());
                if (fromDate.getDate() == thedate.getDate() && fromDate.getMonth() == thedate.getMonth() && fromDate.getFullYear() == thedate.getFullYear()) {
                    return [true, "ui-state-disabled ui-datepicker-unselectable ui-state-disabled-start-date"];
                }
            }

            //if (this.id == "fromFlight") {
            //    if (typeof (specialDays[1]) != "undefined") {
            //        if (typeof (specialDays[1][key]) != "undefined") {
            //            if (typeof (specialDays[0][key]) != "undefined") {
            //                return [true, 'charterholiday', specialDays[0][key]];
            //            }
            //            else {
            //                return [true, 'charter', specialDays[1][key].price];
            //            }
            //        }
            //    }


            //}
            //else {
            //    if (typeof (selectedstartdate[key]) != "undefined") {
            //        return [true, 'charter', selectedstartdate[key].price];
            //    }
            //}

            if (typeof (specialDays[0]) != "undefined") {
                if (typeof (specialDays[0][key]) != "undefined") {
                    return [true, 'holiday ' + selectedClass, specialDays[0][key]];
                }
            }

            return [true, selectedClass];
        },
        beforeShow: function (input, inst) {
            if (!$('.ui-datepicker').parent().hasClass('wrap')) {
                $('.ui-datepicker').wrap("<div class='wrap' id='calendarWrapper'></div>");
            }
            $('.ui-datepicker').parent().removeClass('from').removeClass('to');
          
            $('.ui-datepicker').parent().addClass(inst.id);

            //DP animation
            $(this).datepicker("option", "showAnim", "fadeIn");
            doDatePickerPositionHandle(input);
            setDP_classesForJS("False");

            activeInput = inst.id;
            if (inst.id == "fromFlight") {
                var instance = $(this).data("datepicker");
                var date = $.datepicker.parseDate(instance.settings.dateFormat || $.datepicker._defaults.dateFormat, input.value, instance.settings);
                if (date == null)
                    date = new Date();
                GetSpecialDatesFlight(date.getFullYear(), date.getMonth() + 1, function () {
                    if (activeInput == "fromFlight") {
                        $("#fromFlight").datepicker("refresh");
                    }
                    legend();
                }, $('#destinationFlight').val(), $('#hiddenCountryFlight').val(), $('#originFlight').val());
            }
            else {
                if (this.id == "toFlight") {
                    setDP_classesForJS("True");
                    doDatePickerDateRange();

                    $("#toFlight").datepicker("option", "minDate", $("#fromFlight").val());
                }
                $("#toFlight").datepicker("refresh");
                legend();
            }

        },
        onChangeMonthYear: function (year, month, inst) {
            if (inst.id == "fromFlight") {
                GetSpecialDatesFlight(year, month, function () {
                    if (activeInput == "fromFlight") {
                        $("#fromFlight").datepicker("refresh");
                    }
                    legend();
                }, $('#destinationFlight').val(), $('#hiddenCountryFlight').val(), $('#originFlight').val());
            }
            else {
                $("#toFlight").datepicker("refresh");
                legend();
            }
        },
        defaultDate: "+1w",
        numberOfMonths: 2,
        onSelect: function (selectedDate) {
            //            var option = this.id == "from" ? "minDate" : "maxDate",
            instance = $(this).data("datepicker"),
            date = $.datepicker.parseDate(
                instance.settings.dateFormat ||
                $.datepicker._defaults.dateFormat,
                selectedDate, instance.settings);
            // dates.not(this).datepicker("option", option, date);

            if (this.id == "fromFlight") {
                var d = date.getDate() + "";
                var m = date.getMonth() + 1;

                //                if (d < 10)
                //                    d = "0" + d;

                //                if (m < 10)
                //                    m = "0" + m;

                var yerrr = date.getFullYear();
                var key = d + "/" + m + "/" + yerrr;
                if (typeof (specialDays[1][key]) != "undefined") {
                    selectedstartdate = {};
                    for (var f = 0; f < specialDays[1][key].length; f++) {
                        var flightkey = specialDays[1][key][f].endDate.replace('.', '/').replace('.', '/');
                        if (flightkey.indexOf("0") == 0) {
                            flightkey = flightkey.substring(1);
                            flightkey = flightkey.replace("/0", "/");
                        }
                        flightkey = flightkey.replace("/0", "/");
                        selectedstartdate[flightkey] = specialDays[1][key][f];
                    }
                }
                $("#toFlight").datepicker("option", "minDate", date);


                $("#secondDate").datepicker("option", "minDate", date);

                //if It is one Wey Not opening Second Calender
                if ($('#hidden_WaysFlight').val() != "2") {
                    //Focus On next Element
                    if (typeof ($(this).attr('next')) != "undefined" && $(this).attr('next') != '') {
                        $('#' + $(this).attr('next')).focus();
                    }
                    return;
                }


                setTimeout(function () {
                    $("#toFlight").datepicker("setDate", selectedDate);
                    $("#secondDate").datepicker("setDate", selectedDate);
                    ////$("#calendarWrapper").animate({ right: "250px" }, "slow");
                    //var calendarClone = $("#calendarWrapper").html();
                    //calendarClone.show().animate({ right: "250px" }, "slow");
                    $("#toFlight").datepicker("show");
                }, 100);

                $(".searchPeriod").attr("checked", false);
            }
        },
        minDate: $('#hiddenTodayFlight').val(),
        showOtherMonths: true,
        showMonthAfterYear: false,
        monthNames: ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'],
        monthNamesShort: ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'],
        dayNamesMin: ['א', 'ב', 'ג', 'ד', 'ה', 'ו', 'ש'],
        dateFormat: 'dd/mm/yy'
    }
    var dates = $("#fromFlight, #toFlight").datepicker(defaultSettings);
    $("#ui-datepicker-div").addClass("datepickerWrapper");

    $('#fromFlight,#toFlight').focus(function (e) {
        e.preventDefault();
        e.stopPropagation();
        $(this).datepicker('show');
    });

}

var defaultSettings2 = "";

var SecondDateMinDate = '';


//Multi Trip Calender

function SetFlightoneMultiTripJS() {
    defaultSettings2 = {


        beforeShowDay: function (thedate) {
            var theday = thedate.getDate();
            var d = thedate.getDate() + "";
            var m = thedate.getMonth() + 1;
            var yerrr = thedate.getFullYear();
            var key = d + "/" + m + "/" + yerrr;
            var selectedClass = "";

            //if (typeof (specialDays[1]) != "undefined") {
            //    if (typeof (specialDays[1][key]) != "undefined") {
            //        if (typeof (specialDays[0][key]) != "undefined") {
            //            return [true, 'charterholiday', specialDays[0][key]];
            //        }
            //        else {
            //            return [true, 'charter', specialDays[1][key].price];
            //        }
            //    }
            //}



            if (typeof (specialDays[0]) != "undefined") {
                if (typeof (specialDays[0][key]) != "undefined") {
                    return [true, 'holiday ' + selectedClass, specialDays[0][key]];
                }
            }

            return [true, selectedClass];
        },
        beforeShow: function (input, inst) {
            if (!$('.ui-datepicker').parent().hasClass('wrap')) {
                $('.ui-datepicker').wrap("<div class='wrap ' id='calendarWrapper'></div>");
            }
            $('.ui-datepicker').parent().removeClass('from').removeClass('to');
          
            $('.ui-datepicker').parent().addClass(inst.id);
            var instance = $(this).data("datepicker");
            var date = $.datepicker.parseDate(instance.settings.dateFormat || $.datepicker._defaults.dateFormat, input.value, instance.settings);
            if (date == null)
                date = new Date();

            //Datepicker animation
            $(this).datepicker("option", "showAnim", "fadeIn");
            doDatePickerPositionHandle(input);

            //Second Date Flight
            if (this.id == 'secondDate') {
                GetSpecialDatesFlight(date.getFullYear(), date.getMonth() + 1, function () {
                    if (activeInput == "secondDate") {
                        $('#secondDate').datepicker("refresh");
                    }
                    legend();
                }, $('#to2').val(), $('#hiddenCountryFlight2').val(), $('#from2').val());


                $("#secondDate").datepicker("option", "minDate", $("#fromFlight").val());
            }
            else if (this.id == 'thirdDate') {
                GetSpecialDatesFlight(date.getFullYear(), date.getMonth() + 1, function () {
                    if (activeInput == "thirdDate") {
                        $('#thirdDate').datepicker("refresh");
                    }
                    legend();
                }, $('#to3').val(), $('#hiddenCountryFlight3').val(), $('#from3').val());
                legend();

                $("#thirdDate").datepicker("option", "minDate", $("#secondDate").val());
            }
        },
        onChangeMonthYear: function (year, month, inst) {
            //Second Date Flight

            if (this.id == 'secondDate') {
                GetSpecialDatesFlight(year, month + 1, function () {
                    if (activeInput == "secondDate") {
                        $('#secondDate').datepicker("refresh");
                    }
                    legend();
                }, $('#to2').val(), $('#hiddenCountryFlight2').val(), $('#from2').val());
            }
            else {
                $("#thirdDate").datepicker("refresh");
                legend();
            }
        },
        defaultDate: "+1w",
        numberOfMonths: 2,
        onSelect: function (selectedDate) {

            instance = $(this).data("datepicker"),
            date = $.datepicker.parseDate(
                instance.settings.dateFormat ||
                $.datepicker._defaults.dateFormat,
                selectedDate, instance.settings);
            // dates.not(this).datepicker("option", option, date);
            if (this.id == "secondDate") {
                var d = date.getDate() + "";
                var m = date.getMonth() + 1;


                var yerrr = date.getFullYear();
                var key = d + "/" + m + "/" + yerrr;

                if (typeof (specialDays[1][key]) != "undefined") {
                    selectedstartdate = {};
                    for (var f = 0; f < specialDays[1][key].length; f++) {
                        var flightkey = specialDays[1][key][f].endDate.replace('.', '/').replace('.', '/');
                        if (flightkey.indexOf("0") == 0) {
                            flightkey = flightkey.substring(1);
                            flightkey = flightkey.replace("/0", "/");
                        }
                        flightkey = flightkey.replace("/0", "/");
                        selectedstartdate[flightkey] = specialDays[1][key][f];
                    }
                }

                $("#thirdDate").datepicker("option", "minDate", date);
                setTimeout(function () {
                    $("#thirdDate").datepicker("setDate", selectedDate);

                    // $("#thirdDate").datepicker("show");
                }, 100);

                $(".searchPeriod").attr("checked", false);

                //Focus On next Element
                if (typeof ($(this).attr('next')) != "undefined" && $(this).attr('next') != '') {
                    $('#' + $(this).attr('next')).focus();
                }
            }
        },
        minDate: $('#hiddenTodayFlight').val(),
        showOtherMonths: true,
        showMonthAfterYear: false,
        monthNames: ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'],
        monthNamesShort: ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'],
        dayNamesMin: ['א', 'ב', 'ג', 'ד', 'ה', 'ו', 'ש'],
        dateFormat: 'dd/mm/yy'
    }

    var dates = $("#secondDate,#thirdDate").datepicker(defaultSettings2);
    $("#ui-datepicker-div").addClass("datepickerWrapper");
    $('#secondDate,#thirdDate').focus(function (e) {
        e.preventDefault();
        e.stopPropagation();
        $(this).datepicker('show');
    });
}

function legend() {

    setTimeout(function () {
        if ($('.ulHolidays').length > 0) {
            $('.ulHolidays .datepicker-message').remove();
        }
        
        var legendHtmlStr = "<ul class='ulHolidays'><li class='mt2minus'><span class='index_calender_selected'></span><span style='display:inline-block;line-height:17px;'>בחירה</span></li></ul><a class='cleanDates'></a>";

        var holidaysLegendStr = "<li class='holidays-legend'><span class='valid'><img src='/images/calendarHolidayIcon.png' width='18' height='17' alt='' /></span><span>חג</span></li>";

        // Set break row for the datepicker
        setDatepickerBreakRow(legendHtmlStr, holidaysLegendStr);
    }, 100)
}

function NightsChanged(nights) {
    var strDate = $('#fromFlight').val();
    var dateParts = strDate.split("/");
    var d = new Date(dateParts[2], (dateParts[1] - 1), dateParts[0]);
    d = addDays(d, Number(nights));
    $('#toFlight').val(addZero(d.getDate(), 'day') + "/" + addZero(Number(d.getMonth()), 'month') + "/" + d.getFullYear());
}

function addZero(num, dateCase) {
    switch (dateCase) {
        case "month":
            num++;
            break;
        default:
            break;
    }

    if (num < 10) {
        return "0" + num;
    }
    return num;
}

function addDays(myDate, days) {
    return new Date(myDate.getTime() + days * 24 * 60 * 60 * 1000);
}

function GetSpecialDatesFlight(year, month, callback, destantion, country, from) {   
    var url = "";
    var action = "flights";
    specialDays = [];
    specialDays[0] = [];
    specialDays[1] = [];
    url = "/Handlers/CalanderDates.ashx?m=" + month + "&y=" + year + "&city=" + destantion + "&country=" + country + "&actioncharter=" + action + "&from=" + from + "&to=" + destantion;
    $.ajax({
        type: 'GET',
        url: url,
        async: true,
        cache: true,
        jsonpCallback: 'DatesCallBack',
        contentType: "application/json",
        dataType: 'jsonp',
        success: function (dates) {

            var tempo = dates.data;
            for (var i in tempo[0]) {
                specialDays[0][i] = tempo[0][i];
            }
            for (var x in tempo[1]) {
                specialDays[1][x] = tempo[1][x];
            }

        }, complete: function () {
            callback();
        }
    });
}

function AddOrRemoveThirdDestination(obj) {
    if ($(".thidrdDestinationDiv").is(":visible")) {
        $(".thidrdDestinationDiv").hide();
        //FOR COMPANIES AND HERKEV
        $(".search_herkev_flights_multi").addClass("twodestinations");
        $(".search_company_multi").addClass("twodestinations");
        $(obj).children("span").html("+ הוסף יעד");
        $('#hidden_WaysFlight').val('3');//change back to open jaw

        $('#box_herkev_wrapper').removeClass('top215px');

        $('.img_home_page').animate({ height: 540 }, 200);
    } else {
        $(".thidrdDestinationDiv").show();
        //FOR COMPANIES AND HERKEV
        $(".search_herkev_flights_multi").removeClass("twodestinations");
        $(".search_company_multi").removeClass("twodestinations");
        $(obj).children("span").html("- הסר יעד");
        $('#hidden_WaysFlight').val('4');//now is multi destination
        $('#box_herkev_wrapper').addClass('top215px');

        $('.img_home_page').animate({ height: 585 }, 200);
    }

    setBackgroundHeight();
}

function HideThirdDestination() {
    $(".thidrdDestinationDiv").hide();
    //FOR COMPANIES AND HERKEV
    $(".search_herkev_flights_multi").addClass("twodestinations");
    $(".search_company_multi").addClass("twodestinations");
    $(".newDestinationLabel").children("span").html("+ הוסף יעד");
    $('#hidden_WaysFlight').val('3');//change back to open jaw
}

function ShowThirdDestination() {
    $(".thidrdDestinationDiv").show();
    //FOR COMPANIES AND HERKEV
    $(".search_herkev_flights_multi").removeClass("twodestinations");
    $(".search_company_multi").removeClass("twodestinations");
    $(".newDestinationLabel").children("span").html("- הסר יעד");
    $('#hidden_WaysFlight').val('4');//now is multi destination
}

function disableValidation() {
    $('#thirdDate').removeClass('validate[required, custom[date]]');
    $('#txtto3').removeClass('validate[autocomplete]');
    $('#txtto3').removeClass('validate');
    $('#txtfrom3').removeClass('validate[autocomplete]');
    $('#txtfrom3').removeClass('validate');
    $('#hidden_WaysFlight').val('3');//at first we do the multi segemnt as OpenJaw tryp (only 2 segment will be valid) (if the user set the third segment, we change this attr to 4)
}
function setAirlines() {
    if ($('#hiddenAirLines').val() != null) {
        $("#airLinesTemplate").tmpl(JSON.parse($('#hiddenAirLines').val())).appendTo("#tbodyAirLines");
    }
}

function fillData(obj) {
    data.push({ field: $.trim($(obj).parents('td').prev().children().last().text()), msg: $(obj).attr('resource') });
}

function setNum(nameTextBox, isPlus) {
    var pattern = /[0-9]+/g;
    var totalPax;
    var totalPaxTemp;
    var num = parseInt($('#' + nameTextBox).html());
    var totalBabies = parseInt($("#babys").html());
    var isBaby = (nameTextBox == "babys" ? true : false);

    if ($(".search_flights_wraper").val().match(pattern) == null) {
        totalPax = 1;
    } else {
        totalPax = parseInt($(".search_flights_wraper").val().match(pattern)[0]);//this take only the number of the textbox (e.g. 2 נוסעים, returns 2)
    }
    totalPaxTemp = totalPax;

    if (isPlus) {
        if ((totalPaxTemp - totalBabies < 9) || isBaby) {
            var maxNumAllowed = parseInt($('#' + nameTextBox + '_max').val());
            if (num < maxNumAllowed) {
                var newNum = num + 1;
                totalPax += 1;
            }
        } else {
            //$('#search_herkev_flights').validationEngine('showPrompt', 'לא ניתן לחפש עבור יותר מתשעה נוסעים ', 'pass')
        }
    }
    else {
        if (num > 0) {
            var newNum = num - 1;
            totalPax -= 1;
        }
    }
    $("#" + nameTextBox).html(newNum);

    setWraperTextBox(totalPax);

}

function setWraperTextBox(totalPax) {
    if (totalPax == 1) {
        $(".search_flights_wraper").val("נוסע אחד");
    } else {
        $(".search_flights_wraper").val(totalPax + " נוסעים")
    }
}

function closeHerkevsBox() {
    $(".passengersDiv").slideUp("slow");
}

//function setPassegengers() {
//    $("#adult").val($("#hf_Adult").val());
//    $("#child").val($("#hf_Child").val());
//    $("#baby").val($("#hf_Baby").val());
//    $("#youth").val($("#hf_Young").val());
//    $("#pensioner").val($("#hf_Old").val());

//    $("#adults").html($("#hf_Adult").val());
//    $("#childs").html($("#hf_Child").val());
//    $("#babys").html($("#hf_Baby").val());
//    $("#youths").html($("#hf_Young").val());
//    $("#pensioners").html($("#hf_Old").val());
//    var totalPax = parseInt($("#hf_Adult").val()) + parseInt($("#hf_Child").val()) + parseInt($("#hf_Baby").val()) + parseInt($("#hf_Old").val()) + parseInt($("#hf_Young").val());

//    if (isNaN(totalPax)) {
//        totalPax = 1;
//    }
//    setWraperTextBox(totalPax);
//}
/*!
* jQuery Cookie Plugin
* https://github.com/carhartl/jquery-cookie
*
* Copyright 2011, Klaus Hartl
* Dual licensed under the MIT or GPL Version 2 licenses.
* http://www.opensource.org/licenses/mit-license.php
* http://www.opensource.org/licenses/GPL-2.0
*/
(function ($) {
    $.cookie = function (key, value, options) {

        // key and at least value given, set cookie...
        if (arguments.length > 1 && (!/Object/.test(Object.prototype.toString.call(value)) || value === null || value === undefined)) {
            options = $.extend({}, options);

            if (value === null || value === undefined) {
                options.expires = -1;
            }

            if (typeof options.expires === 'number') {
                var days = options.expires, t = options.expires = new Date();
                t.setDate(t.getDate() + days);
            }

            value = String(value);

            return (document.cookie = [
                encodeURIComponent(key), '=', options.raw ? value : encodeURIComponent(value),
                options.expires ? '; expires=' + options.expires.toUTCString() : '', // use expires attribute, max-age is not supported by IE
                options.path ? '; path=' + options.path : '',
                options.domain ? '; domain=' + options.domain : '',
                options.secure ? '; secure' : ''
            ].join(''));
        }

        // key and possibly options given, get cookie...
        options = value || {};
        var decode = options.raw ? function (s) { return s; } : decodeURIComponent;

        var pairs = document.cookie.split('; ');
        for (var i = 0, pair; pair = pairs[i] && pairs[i].split('='); i++) {
            if (decode(pair[0]) === key) return decode(pair[1] || ''); // IE saves cookies with empty string as "c; ", e.g. without "=" as opposed to EOMB, thus pair[1] may be undefined
        }
        return null;
    };
})(jQuery);

//======================================Start Function=============================================
$(document).ready(function () {
    ValidateNumric();

});
//======================================Global Vars =============================================
//האם עבר וולדיאציה
var IsValid = true;
//צבע טקסט בעת שגיאה
var error_color = "rgb(250, 0, 0)";
//צבע טקסט רגיל
var validate_color = "black";
//============================Validate Error message==============================================

//שם תאגיד
var error_EngOnly = "יש להזין שם באנגלית בלבד";
var error_FirstName = "נא להכניס שם פרטי";
var error_PassengerFirstName = "נא להזין שם פרטי";
var error_LastName = "נא להזין שם משפחה";
var error_PassengerLastName = "נא להזין שם משפחה";
var ph_FirstName = "*שם פרטי :";
var ph_LastName = "*שם משפחה :";
var ph_PassengerFirstName = "*שם פרטי:";
var ph_PassengerLastName = "*שם משפחה:";
var error_phone = "נא להזין מספר טלפון";
var ph_phone = "*טלפון :";
var error_mail_not_match = 'כתובות הדוא"ל אינן זהות';

var error_PassangerDay = "*נא להזין יום";
var error_PassangerMonth = "*נא להזין חודש";
var error_PassangerYear = "*נא להזין שנה";

var ph_PassangerDay = "יום";
var ph_PassangerMonth = "חודש";
var ph_PassangerYear = "שנה";

var error_chkTerms = "*נא אשר את פרטי ההזמנה ואת תנאי האתר";
var ph_chkTerms = "מאשר את פרטי ההזמנה ואת תנאי האתר";



//מייל
var error_mail = "נא להכניס כתובת מייל";
//מייל לא תקין
var error_mail_not_valid = "נא להכניס מייל תקין";
//==========================================================================================
//===============================Regular Expression=========================================
//mail Validate - new regex changed by rafi(לקוח הזמין טיסה לחול עם אימייל לא תקין ולכן הזמנה נכשלה - shenhavo@post.bgu.ac..il)
//var mail_regex = new RegExp(/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i);
var mail_regex = new RegExp(/^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i);
var englishAlphabetAndWhiteSpace = new RegExp ("^[a-zA-Z ]+$");
//============================= Genric Function ==========================================

///Change Css To Valide Color
//control -  Control ID 
function ChangeCSS(control) {
    $('#' + control).css('color', validate_color);
}
//Clearing Error msg
//Control -  Control ID 
function ClearErrorValue(control) {

    if ($('#' + control).css('color') == error_color) {
        $('#' + control).val("");
    }
}
///Clearing Passworn Error label
//control_error_pass - lbl Id For password
//control_error_confirm_pass - lbl Id For confirm password
function ClearErrorPassValue(control_error_pass, control_error_confirm_pass) {
    $('#' + control_error_pass).css('display', 'none');
    $('#' + control_error_confirm_pass).css('display', 'none');
}


//Checking Empty Field Validation 
//control -  Control ID 
//Errormsg - Msg To Show incase of error
function checkCheckBoxValidation_requied_field(control, error_msg, ph_msg, lbl_checkbox) {

    var IsSingleValid = true;
    if ($('#' + control).is(":checked")) {
        $('#' + control).css('color', validate_color);
    }
    else {
        if (lbl_checkbox != undefined && lbl_checkbox != '') {
            $('#' + lbl_checkbox).val(error_msg);
            $('#' + lbl_checkbox).css('color', error_color);
        } else {
            $('#' + control).val(error_msg);
            $('#' + control).css('color', error_color);
        }

        IsValid = false;
        IsSingleValid = false;
    }
    return IsSingleValid;
}

//Checking Empty Field Validation 
//control -  Control ID 
//Errormsg - Msg To Show incase of error
function checkValidation_requied_field(control, error_msg, ph_msg) {

    var IsSingleValid = true;
    if ($('#' + control).val() == "" || $('#' + control).val() == error_msg || $('#' + control).val() == ph_msg) {

        $('#' + control).val(error_msg);
        $('#' + control).css('color', error_color);
        IsValid = false;
        IsSingleValid = false;
    }
    else {
        $('#' + control).css('color', validate_color);
    }
    return IsSingleValid;
}

//Checking Empty Field Validation By Class
//control -  Control ID 
//Errormsg - Msg To Show incase of error
function checkValidation_requied_fieldByClass(control, error_msg, ph_msg, isMultipleElements) {

    if (isMultipleElements != undefined && isMultipleElements) {
        $('.' + control).each(function () {
            doCheckValidation_requied_fieldByClass(this, error_msg, ph_msg);
        });
    } else {
        doCheckValidation_requied_fieldByClass($('.' + control), error_msg, ph_msg);
    }

}

//Checking Empty Field Validation By Class
//control -  Control ID 
//Errormsg - Msg To Show incase of error
function doCheckValidation_requied_fieldByClass(this_control, error_msg, ph_msg) {
    var IsSingleValid = true;
    if ($(this_control).val() == "" || $(this_control).val() == error_msg || $(this_control).val() == ph_msg) {

        $(this_control).val(error_msg);
        $(this_control).css('color', error_color);
        IsValid = false;
        IsSingleValid = false;
    }
    else {
        $(this_control).css('color', validate_color);
    }
    return IsSingleValid;
}


function ValidateEnglishOnlyPH(element, error_text)
{
    if ($(element).val() != error_text) {
        if (englishAlphabetAndWhiteSpace.test($(element).val())) {
            $(element).css('color', validate_color);
            return true;
        }

        $(element).val(error_EngOnly);
        $(element).css('color', error_color);
        IsValid = false;
        IsSingleValid = false;
        //$(element).val("");
        //alert('יש להזין תווים באנגלית בלבד');
        return false;
    }
}

//Checking Empty Field Validation By Class
//control -  Control ID 
//Errormsg - Msg To Show incase of error
function checkValidation_requied_date_fieldByClass(control, error_msg, ph_msg, isMultipleElements) {

    if (isMultipleElements != undefined && isMultipleElements) {
        $('.' + control).each(function () {
            doCheckValidation_requied_date_fieldByClass(this, error_msg, ph_msg);
        });
    } else {
        doCheckValidation_requied_date_fieldByClass($('.' + control), error_msg, ph_msg);
    }

}

//Checking Empty Field Validation By Class
//control -  Control ID 
//Errormsg - Msg To Show incase of error
function doCheckValidation_requied_date_fieldByClass(this_control, error_msg, ph_msg) {
    var IsSingleValid = true;
    if ($(this_control).val() == "" || $(this_control).val() == error_msg || $(this_control).val() == ph_msg || $(this_control).val() == -1) {
        $(this_control).val(-1);
        $(this_control).addClass('color_red_impo');
        IsValid = false;
        IsSingleValid = false;
    }
    else {
        $(this_control).removeClass('color_red_impo');
    }
    return IsSingleValid;
}




///Check For Field For max Lenthg And Empty Field
//control -  Control ID 
//error_msg_if_empty - Msg To Show incase of Empty Field error
//error_max_length - Msg To Show incase of Over Max Length Field error
//max_length - max length Of Field
function checkValidation_requied_field_and_max_length(control, error_msg_if_empty, error_max_length, max_length) {
    var IsSingleValid = true;

    //Check For Previuos Error msg
    if ($('#' + control).val() == error_max_length) {
        $('#' + control).val("");
    }

    //If String Is Not Empty lok for max lenth
    if (checkValidation_requied_field(control, error_msg_if_empty)) {
        //Value Is Over Max Lenth
        if ($('#' + control).val().length > max_length) {
            $('#' + control).val(error_max_length);
            $('#' + control).css('color', error_color);
            IsValid = false;
            IsSingleValid = false;
        }
    }
        //Value Is Empty
    else {

        IsSingleValid = false;
    }
    return IsSingleValid;
}


///Check For Field For max Lenthg And Empty Field
//control -  Control ID 
//error_msg_if_empty - Msg To Show incase of Empty Field error
//error_not_equal - Msg To Show incase of Not Equal Field error
//equal_length - equal length Of Field
function checkValidation_requied_field_and_equal_to_length(control, error_msg_if_empty, error_not_equal, equal_length) {
    var IsSingleValid = true;

    //Check For Previuos Error msg
    if ($('#' + control).val() == error_not_equal) {
        $('#' + control).val("");
    }

    //If String Is Not Empty lok for max lenth
    if (checkValidation_requied_field(control, error_msg_if_empty)) {
        //Value Is Over Max Lenth
        if ($('#' + control).val().length != equal_length) {
            $('#' + control).val(error_not_equal);
            $('#' + control).css('color', error_color);
            IsValid = false;
            IsSingleValid = false;
        }
    }
        //Value Is Empty
    else {

        IsSingleValid = false;
    }
    return IsSingleValid;
}


//Checking Empty Field Validation fro laebl
//control -  Control ID 
//Errormsg - Msg To Show incase of error
function checkValidation_requied_field_label(control, error_msg) {

    var IsSingleValid = true;
    if ($('#' + control).html() == "" || $('#' + control).html() == error_msg) {

        $('#' + control).html(error_msg);
        $('#' + control).css('color', error_color);
        IsValid = false;
        IsSingleValid = false;
    }
    else {
        $('#' + control).css('color', validate_color);
    }
    return IsSingleValid;
}

//Checking Change Password Validation 
//control_old_pass - Control Id Fro Old Pass
///control_pass -  Control Id For Password
///control_pass_confirm -  Control Id For Password Confirm
//control_error_pass - lbl Id For password
//control_error_confirm_pass - lbl Id For confirm password
function checkValidation_change_password(control_old_pass, control_pass, control_pass_confirm, control_error_pass, control_error_confirm_pass) {

    if (checkValidation_password(control_pass, control_pass_confirm, control_error_pass, control_error_confirm_pass)) {
        if ($('#' + control_old_pass).val() == "") {

            $('#' + control_error_pass).html(error_old_pasword);
            $('#' + control_error_pass).css('color', error_color);
            $('#' + control_error_pass).css('display', 'block');
            IsValid = false;
        }
    }
}


//Checking Password Validation 
///control_pass -  Control Id For Password
///control_pass_confirm -  Control Id For Password Confirm
//control_error_pass - lbl Id For password
//control_error_confirm_pass - lbl Id For confirm password
function checkValidation_password(control_pass, control_pass_confirm, control_error_pass, control_error_confirm_pass) {


    var IsSingleValid = true;
    if ($('#' + control_pass).val() == "") {

        $('#' + control_error_pass).html(error_pasword);
        $('#' + control_error_pass).css('color', error_color);
        $('#' + control_error_pass).css('display', 'block');
        IsValid = false;
        IsSingleValid = false;
    }
    else if ($('#' + control_pass).val().length < 6) {
        $('#' + control_error_pass).html(error_pasword_to_short);
        $('#' + control_error_pass).css('color', error_color);
        $('#' + control_error_pass).css('display', 'block');
        IsValid = false;
        IsSingleValid = false;
    }
    else if ($('#' + control_pass).val().length > 50) {
        $('#' + control_error_pass).html(error_pasword_to_long);
        $('#' + control_error_pass).css('color', error_color);
        $('#' + control_error_pass).css('display', 'block');
        IsValid = false;
        IsSingleValid = false;
    }
    else if ($('#' + control_pass).val().search(/\d/) == -1) {
        $('#' + control_error_pass).html(error_pasword_no_num);
        $('#' + control_error_pass).css('color', error_color);
        $('#' + control_error_pass).css('display', 'block');
        IsValid = false;
        IsSingleValid = false;
    }
    else if ($('#' + control_pass).val().search(/[א-ת]/) >= 0) {
        $('#' + control_error_pass).html(error_pasword_en_only);
        $('#' + control_error_pass).css('color', error_color);
        $('#' + control_error_pass).css('display', 'block');
        IsValid = false;
        IsSingleValid = false;
    }
    else if ($('#' + control_pass).val().search(/[a-zA-Z]/) == -1) {
        $('#' + control_error_pass).html(error_pasword_no_letter);
        $('#' + control_error_pass).css('color', error_color);
        $('#' + control_error_pass).css('display', 'block');
        IsValid = false;
        IsSingleValid = false;
    }

    else if ($('#' + control_pass).val().search(/[^a-zA-Z0-9\!\@\#\$\%\^\&\*\(\)\_\+]/) != -1) {
        $('#' + control_error_pass).html(error_pasword_ileigel_letter);
        $('#' + control_error_pass).css('color', error_color);
        $('#' + control_error_pass).css('display', 'block');
        IsValid = false;
        IsSingleValid = false;
    }
    else if ($('#' + control_pass).val() != $('#' + control_pass_confirm).val()) {
        $('#' + control_error_confirm_pass).html(error_confirm_pasword);
        $('#' + control_error_confirm_pass).css('color', error_color);
        $('#' + control_error_confirm_pass).css('display', 'block');
        IsValid = false;
        IsSingleValid = false;
    }

    return IsSingleValid;

}


//=====================================================
//Checking Mail Validation
//control - Mail Text ID
function checkValidation_mail(control) {
    ;
    //If mail Is not Empty
    if (checkValidation_requied_field(control, error_mail)) {

        if (!($('#' + control).val().match(mail_regex))) {
            $('#' + control).val(error_mail_not_valid);
            $('#' + control).css('color', error_color);
            IsValid = false;
        }
        else {
            $('#' + control).css('color', validate_color);
        }

    }


}

//Validate Muth mail 
function check_mail_Validate(control, controltovalidate) {


    if ($('#' + control).val() != $('#' + controltovalidate).val()) {
        $('#' + controltovalidate).val(error_mail_not_match);
        $('#' + controltovalidate).css('color', error_color);
        IsValid = false;
    }
    else {
        $('#' + controltovalidate).css('color', validate_color);
    }



}
function checkValidation_city(control, CityID, CityName) {

    if ($('#' + control).val() == "" || $('#' + control).val() == error_city) {
        $('#' + control).val(error_city);
        $('#' + control).css('color', error_color);
        IsValid = false;
    }
    else if ($('#' + control).val() != $('#' + CityName).val()) {
        $('#' + control).val(error_city_from_auto_complete);
        $('#' + control).css('color', error_color);
        IsValid = false;
    }
}
/// Prevent From  Selcted Text Box to Write nothing But number
function ValidateNumric() {
    $(".numeric").keypress(function (e) {

        var key = e.charCode || e.keyCode || 0;

        // allow backspace, tab, delete, arrows, numbers and keypad numbers ONLY

        if (!(
                                        key == 8 ||
                                        key == 9 ||
                                        key == 46 ||
                                        key == 13 ||
                                        key == 38 ||
                                        key == 40 ||
                                        (key >= 37 && key <= 40) ||
                                        (key >= 48 && key <= 57) ||
                                        (key >= 96 && key <= 105))
                                        ) {
            e.preventDefault();

        }
    })

    $(".numeric").keydown(function (event) {
        //assing . and check for duplicate .

        if (event.keyCode == 190 || event.keyCode == 191 || event.keyCode == 110) {

            var msg = $(this).val()
            if (msg.indexOf(".") == -1) {
                event.preventDefault();
                var msg = $(this).val()
                $(this).val(msg + '.');
            }

        }

        // Allow: backspace, delete, tab and escape ,enter, or arrow down and up
        if (event.keyCode == 46 || event.keyCode == 8 || event.keyCode == 9 || event.keyCode == 13 || event.keyCode == 40 || event.keyCode == 38 || event.keyCode == 27 ||
            // Allow: Ctrl+A
                                    (event.keyCode == 65 && event.ctrlKey === true) ||
            // Allow: home, end, left, right
                                    (event.keyCode >= 35 && event.keyCode <= 39)) {

            // let it happen, don't do anything
            return;
        }
        else {
            // Ensure that it is a number and stop the keypress
            if ((event.keyCode < 48 || event.keyCode > 57) && (event.keyCode < 96 || event.keyCode > 105)) {
                event.preventDefault();
            }
        }
    })
}




/********************************************************************************************************************

        Loading Layer v1 with JQuery
        Create Date 2014. 5. 12.
        Developer : Parkheesung (parkheesung@outlook.com)
        Website : Parkheesung.com

********************************************************************************************************************/

function Loading(show, text, callback) {
    
    if (typeof (show) == "boolean") {
		var LoadingImage = "../images/loading_flower.gif"; //29x29
        var dh = $(document).outerHeight(true);
        var wh = $(window).outerHeight(true);
        var h = (dh > wh) ? dh : wh;
        var dw = $(document).outerWidth(true);
        var ww = $(window).outerWidth(true);
        var w = (dw > ww) ? dw : ww;
        // center of window
        var posX = (w / 2) - 70;// width of div 140/2
        var posY = 50;//(h / 2) - 50;// height of div 100/2

        if (show) {
            if (document.getElementById("LoadingDivLayer") == null) {
                var loadingTag  = "<div id=\"LoadingDivLayer\" class=\"LoadingDivLayerClass\" style=\"height:" + String(h) + "px\">";
					loadingTag += "		<div class=\"LoadingForeground\" style=\"height:" + String(h) + "px;\">";
					loadingTag += "			<div class=\"LoadingBox\" style=\"top:" + String(posY) + "%;right:" + String(posX) + "px;\">";
					loadingTag += "				<div><img src=\"" + LoadingImage + "\" alt=\"Loading...\" /></div>";
					loadingTag += "				<div style='color:#FFFFFF;' >" + text + "</div>";
					loadingTag += "			</div>";
					loadingTag += "		</div>";
					loadingTag += "		<div class=\"LoadingBackground\" style=\"height:" + String(h) + "px\"></div>";
					loadingTag += "</div>";
					
                $("body").prepend(loadingTag);
                $("#LoadingDivLayer").fadeIn(350, function () {
                    if (callback != null) {
                        callback();
                    }
                });
            }
        } else {
            if (document.getElementById("LoadingDivLayer") != null) {
                $("#LoadingDivLayer").remove();
                if (callback != null) {
                    callback();
                }
            }
        }
    } 
};

$(window).resize(function () {
    if (document.getElementById("LoadingDivLayer") != null) {
        var dh = $(document).outerHeight(true);
        var wh = $(window).outerHeight(true);
        var h = (dh > wh) ? dh : wh;
        var dw = $(document).outerWidth(true);
        var ww = $(window).outerWidth(true);
        var w = (dw > ww) ? dw : ww;
        var posX = (w / 2) + 14;
        var posY = (h / 2) + 14;

        $("#LoadingDivLayer").css({
            height:String(h) + "px"
        });

        $("#LoadingDivLayer > .LoadingForeground").css({
            height: String(h) + "px"
        });

        $("#LoadingDivLayer > .LoadingForeground > .LoadingBox").css({
            top: String(posY) + "px",
            left: String(posX) + "px"
        });

        $("#LoadingDivLayer > .LoadingBackground").css({
            height: String(h) + "px"
        });
    }
});
/* == jquery mousewheel plugin == Version: 3.1.12, License: MIT License (MIT) */
!function(a){"function"==typeof define&&define.amd?define(["jquery"],a):"object"==typeof exports?module.exports=a:a(jQuery)}(function(a){function b(b){var g=b||window.event,h=i.call(arguments,1),j=0,l=0,m=0,n=0,o=0,p=0;if(b=a.event.fix(g),b.type="mousewheel","detail"in g&&(m=-1*g.detail),"wheelDelta"in g&&(m=g.wheelDelta),"wheelDeltaY"in g&&(m=g.wheelDeltaY),"wheelDeltaX"in g&&(l=-1*g.wheelDeltaX),"axis"in g&&g.axis===g.HORIZONTAL_AXIS&&(l=-1*m,m=0),j=0===m?l:m,"deltaY"in g&&(m=-1*g.deltaY,j=m),"deltaX"in g&&(l=g.deltaX,0===m&&(j=-1*l)),0!==m||0!==l){if(1===g.deltaMode){var q=a.data(this,"mousewheel-line-height");j*=q,m*=q,l*=q}else if(2===g.deltaMode){var r=a.data(this,"mousewheel-page-height");j*=r,m*=r,l*=r}if(n=Math.max(Math.abs(m),Math.abs(l)),(!f||f>n)&&(f=n,d(g,n)&&(f/=40)),d(g,n)&&(j/=40,l/=40,m/=40),j=Math[j>=1?"floor":"ceil"](j/f),l=Math[l>=1?"floor":"ceil"](l/f),m=Math[m>=1?"floor":"ceil"](m/f),k.settings.normalizeOffset&&this.getBoundingClientRect){var s=this.getBoundingClientRect();o=b.clientX-s.left,p=b.clientY-s.top}return b.deltaX=l,b.deltaY=m,b.deltaFactor=f,b.offsetX=o,b.offsetY=p,b.deltaMode=0,h.unshift(b,j,l,m),e&&clearTimeout(e),e=setTimeout(c,200),(a.event.dispatch||a.event.handle).apply(this,h)}}function c(){f=null}function d(a,b){return k.settings.adjustOldDeltas&&"mousewheel"===a.type&&b%120===0}var e,f,g=["wheel","mousewheel","DOMMouseScroll","MozMousePixelScroll"],h="onwheel"in document||document.documentMode>=9?["wheel"]:["mousewheel","DomMouseScroll","MozMousePixelScroll"],i=Array.prototype.slice;if(a.event.fixHooks)for(var j=g.length;j;)a.event.fixHooks[g[--j]]=a.event.mouseHooks;var k=a.event.special.mousewheel={version:"3.1.12",setup:function(){if(this.addEventListener)for(var c=h.length;c;)this.addEventListener(h[--c],b,!1);else this.onmousewheel=b;a.data(this,"mousewheel-line-height",k.getLineHeight(this)),a.data(this,"mousewheel-page-height",k.getPageHeight(this))},teardown:function(){if(this.removeEventListener)for(var c=h.length;c;)this.removeEventListener(h[--c],b,!1);else this.onmousewheel=null;a.removeData(this,"mousewheel-line-height"),a.removeData(this,"mousewheel-page-height")},getLineHeight:function(b){var c=a(b),d=c["offsetParent"in a.fn?"offsetParent":"parent"]();return d.length||(d=a("body")),parseInt(d.css("fontSize"),10)||parseInt(c.css("fontSize"),10)||16},getPageHeight:function(b){return a(b).height()},settings:{adjustOldDeltas:!0,normalizeOffset:!0}};a.fn.extend({mousewheel:function(a){return a?this.bind("mousewheel",a):this.trigger("mousewheel")},unmousewheel:function(a){return this.unbind("mousewheel",a)}})});
/* == malihu jquery custom scrollbar plugin == Version: 3.0.6, License: MIT License (MIT) */
!function(e,t,a){!function(t){var o="function"==typeof define&&define.amd,n="https:"==a.location.protocol?"https:":"http:",i="cdnjs.cloudflare.com/ajax/libs/jquery-mousewheel/3.1.12/jquery.mousewheel.min.js";o||e.event.special.mousewheel||e("head").append(decodeURI("%3Cscript src="+n+"//"+i+"%3E%3C/script%3E")),t()}(function(){var o="mCustomScrollbar",n="mCS",i=".mCustomScrollbar",r={setTop:0,setLeft:0,axis:"y",scrollbarPosition:"inside",scrollInertia:950,autoDraggerLength:!0,alwaysShowScrollbar:0,snapOffset:0,mouseWheel:{enable:!0,scrollAmount:"auto",axis:"y",deltaFactor:"auto",disableOver:["select","option","keygen","datalist","textarea"]},scrollButtons:{scrollType:"stepless",scrollAmount:"auto"},keyboard:{enable:!0,scrollType:"stepless",scrollAmount:"auto"},contentTouchScroll:25,advanced:{autoScrollOnFocus:"input,textarea,select,button,datalist,keygen,a[tabindex],area,object,[contenteditable='true']",updateOnContentResize:!0,updateOnImageLoad:!0},theme:"light",callbacks:{onTotalScrollOffset:0,onTotalScrollBackOffset:0,alwaysTriggerOffsets:!0}},l=0,s={},c=t.attachEvent&&!t.addEventListener?1:0,d=!1,u=["mCSB_dragger_onDrag","mCSB_scrollTools_onDrag","mCS_img_loaded","mCS_disabled","mCS_destroyed","mCS_no_scrollbar","mCS-autoHide","mCS-dir-rtl","mCS_no_scrollbar_y","mCS_no_scrollbar_x","mCS_y_hidden","mCS_x_hidden","mCSB_draggerContainer","mCSB_buttonUp","mCSB_buttonDown","mCSB_buttonLeft","mCSB_buttonRight"],f={init:function(t){var t=e.extend(!0,{},r,t),a=h.call(this);if(t.live){var o=t.liveSelector||this.selector||i,c=e(o);if("off"===t.live)return void p(o);s[o]=setTimeout(function(){c.mCustomScrollbar(t),"once"===t.live&&c.length&&p(o)},500)}else p(o);return t.setWidth=t.set_width?t.set_width:t.setWidth,t.setHeight=t.set_height?t.set_height:t.setHeight,t.axis=t.horizontalScroll?"x":g(t.axis),t.scrollInertia=t.scrollInertia>0&&t.scrollInertia<17?17:t.scrollInertia,"object"!=typeof t.mouseWheel&&1==t.mouseWheel&&(t.mouseWheel={enable:!0,scrollAmount:"auto",axis:"y",preventDefault:!1,deltaFactor:"auto",normalizeDelta:!1,invert:!1}),t.mouseWheel.scrollAmount=t.mouseWheelPixels?t.mouseWheelPixels:t.mouseWheel.scrollAmount,t.mouseWheel.normalizeDelta=t.advanced.normalizeMouseWheelDelta?t.advanced.normalizeMouseWheelDelta:t.mouseWheel.normalizeDelta,t.scrollButtons.scrollType=v(t.scrollButtons.scrollType),m(t),e(a).each(function(){var a=e(this);if(!a.data(n)){a.data(n,{idx:++l,opt:t,scrollRatio:{y:null,x:null},overflowed:null,contentReset:{y:null,x:null},bindEvents:!1,tweenRunning:!1,sequential:{},langDir:a.css("direction"),cbOffsets:null,trigger:null});var o=a.data(n),i=o.opt,r=a.data("mcs-axis"),s=a.data("mcs-scrollbar-position"),c=a.data("mcs-theme");r&&(i.axis=r),s&&(i.scrollbarPosition=s),c&&(i.theme=c,m(i)),x.call(this),e("#mCSB_"+o.idx+"_container img:not(."+u[2]+")").addClass(u[2]),f.update.call(null,a)}})},update:function(t,a){var o=t||h.call(this);return e(o).each(function(){var t=e(this);if(t.data(n)){var o=t.data(n),i=o.opt,r=e("#mCSB_"+o.idx+"_container"),l=[e("#mCSB_"+o.idx+"_dragger_vertical"),e("#mCSB_"+o.idx+"_dragger_horizontal")];if(!r.length)return;o.tweenRunning&&V(t),t.hasClass(u[3])&&t.removeClass(u[3]),t.hasClass(u[4])&&t.removeClass(u[4]),b.call(this),S.call(this),"y"===i.axis||i.advanced.autoExpandHorizontalScroll||r.css("width",_(r.children())),o.overflowed=T.call(this),I.call(this),i.autoDraggerLength&&C.call(this),y.call(this),M.call(this);var s=[Math.abs(r[0].offsetTop),Math.abs(r[0].offsetLeft)];"x"!==i.axis&&(o.overflowed[0]?l[0].height()>l[0].parent().height()?k.call(this):(Q(t,s[0].toString(),{dir:"y",dur:0,overwrite:"none"}),o.contentReset.y=null):(k.call(this),"y"===i.axis?O.call(this):"yx"===i.axis&&o.overflowed[1]&&Q(t,s[1].toString(),{dir:"x",dur:0,overwrite:"none"}))),"y"!==i.axis&&(o.overflowed[1]?l[1].width()>l[1].parent().width()?k.call(this):(Q(t,s[1].toString(),{dir:"x",dur:0,overwrite:"none"}),o.contentReset.x=null):(k.call(this),"x"===i.axis?O.call(this):"yx"===i.axis&&o.overflowed[0]&&Q(t,s[0].toString(),{dir:"y",dur:0,overwrite:"none"}))),a&&o&&(2===a&&i.callbacks.onImageLoad&&"function"==typeof i.callbacks.onImageLoad?i.callbacks.onImageLoad.call(this):3===a&&i.callbacks.onSelectorChange&&"function"==typeof i.callbacks.onSelectorChange?i.callbacks.onSelectorChange.call(this):i.callbacks.onUpdate&&"function"==typeof i.callbacks.onUpdate&&i.callbacks.onUpdate.call(this)),X.call(this)}})},scrollTo:function(t,a){if("undefined"!=typeof t&&null!=t){var o=h.call(this);return e(o).each(function(){var o=e(this);if(o.data(n)){var i=o.data(n),r=i.opt,l={trigger:"external",scrollInertia:r.scrollInertia,scrollEasing:"mcsEaseInOut",moveDragger:!1,timeout:60,callbacks:!0,onStart:!0,onUpdate:!0,onComplete:!0},s=e.extend(!0,{},l,a),c=j.call(this,t),d=s.scrollInertia>0&&s.scrollInertia<17?17:s.scrollInertia;c[0]=Y.call(this,c[0],"y"),c[1]=Y.call(this,c[1],"x"),s.moveDragger&&(c[0]*=i.scrollRatio.y,c[1]*=i.scrollRatio.x),s.dur=d,setTimeout(function(){null!==c[0]&&"undefined"!=typeof c[0]&&"x"!==r.axis&&i.overflowed[0]&&(s.dir="y",s.overwrite="all",Q(o,c[0].toString(),s)),null!==c[1]&&"undefined"!=typeof c[1]&&"y"!==r.axis&&i.overflowed[1]&&(s.dir="x",s.overwrite="none",Q(o,c[1].toString(),s))},s.timeout)}})}},stop:function(){var t=h.call(this);return e(t).each(function(){var t=e(this);t.data(n)&&V(t)})},disable:function(t){var a=h.call(this);return e(a).each(function(){var a=e(this);if(a.data(n)){{a.data(n)}X.call(this,"remove"),O.call(this),t&&k.call(this),I.call(this,!0),a.addClass(u[3])}})},destroy:function(){var t=h.call(this);return e(t).each(function(){var a=e(this);if(a.data(n)){var i=a.data(n),r=i.opt,l=e("#mCSB_"+i.idx),s=e("#mCSB_"+i.idx+"_container"),c=e(".mCSB_"+i.idx+"_scrollbar");r.live&&p(r.liveSelector||e(t).selector),X.call(this,"remove"),O.call(this),k.call(this),a.removeData(n),Z(this,"mcs"),c.remove(),s.find("img."+u[2]).removeClass(u[2]),l.replaceWith(s.contents()),a.removeClass(o+" _"+n+"_"+i.idx+" "+u[6]+" "+u[7]+" "+u[5]+" "+u[3]).addClass(u[4])}})}},h=function(){return"object"!=typeof e(this)||e(this).length<1?i:this},m=function(t){var a=["rounded","rounded-dark","rounded-dots","rounded-dots-dark"],o=["rounded-dots","rounded-dots-dark","3d","3d-dark","3d-thick","3d-thick-dark","inset","inset-dark","inset-2","inset-2-dark","inset-3","inset-3-dark"],n=["minimal","minimal-dark"],i=["minimal","minimal-dark"],r=["minimal","minimal-dark"];t.autoDraggerLength=e.inArray(t.theme,a)>-1?!1:t.autoDraggerLength,t.autoExpandScrollbar=e.inArray(t.theme,o)>-1?!1:t.autoExpandScrollbar,t.scrollButtons.enable=e.inArray(t.theme,n)>-1?!1:t.scrollButtons.enable,t.autoHideScrollbar=e.inArray(t.theme,i)>-1?!0:t.autoHideScrollbar,t.scrollbarPosition=e.inArray(t.theme,r)>-1?"outside":t.scrollbarPosition},p=function(e){s[e]&&(clearTimeout(s[e]),Z(s,e))},g=function(e){return"yx"===e||"xy"===e||"auto"===e?"yx":"x"===e||"horizontal"===e?"x":"y"},v=function(e){return"stepped"===e||"pixels"===e||"step"===e||"click"===e?"stepped":"stepless"},x=function(){var t=e(this),a=t.data(n),i=a.opt,r=i.autoExpandScrollbar?" "+u[1]+"_expand":"",l=["<div id='mCSB_"+a.idx+"_scrollbar_vertical' class='mCSB_scrollTools mCSB_"+a.idx+"_scrollbar mCS-"+i.theme+" mCSB_scrollTools_vertical"+r+"'><div class='"+u[12]+"'><div id='mCSB_"+a.idx+"_dragger_vertical' class='mCSB_dragger' style='position:absolute;' oncontextmenu='return false;'><div class='mCSB_dragger_bar' /></div><div class='mCSB_draggerRail' /></div></div>","<div id='mCSB_"+a.idx+"_scrollbar_horizontal' class='mCSB_scrollTools mCSB_"+a.idx+"_scrollbar mCS-"+i.theme+" mCSB_scrollTools_horizontal"+r+"'><div class='"+u[12]+"'><div id='mCSB_"+a.idx+"_dragger_horizontal' class='mCSB_dragger' style='position:absolute;' oncontextmenu='return false;'><div class='mCSB_dragger_bar' /></div><div class='mCSB_draggerRail' /></div></div>"],s="yx"===i.axis?"mCSB_vertical_horizontal":"x"===i.axis?"mCSB_horizontal":"mCSB_vertical",c="yx"===i.axis?l[0]+l[1]:"x"===i.axis?l[1]:l[0],d="yx"===i.axis?"<div id='mCSB_"+a.idx+"_container_wrapper' class='mCSB_container_wrapper' />":"",f=i.autoHideScrollbar?" "+u[6]:"",h="x"!==i.axis&&"rtl"===a.langDir?" "+u[7]:"";i.setWidth&&t.css("width",i.setWidth),i.setHeight&&t.css("height",i.setHeight),i.setLeft="y"!==i.axis&&"rtl"===a.langDir?"989999px":i.setLeft,t.addClass(o+" _"+n+"_"+a.idx+f+h).wrapInner("<div id='mCSB_"+a.idx+"' class='mCustomScrollBox mCS-"+i.theme+" "+s+"'><div id='mCSB_"+a.idx+"_container' class='mCSB_container' style='position:relative; top:"+i.setTop+"; left:"+i.setLeft+";' dir="+a.langDir+" /></div>");var m=e("#mCSB_"+a.idx),p=e("#mCSB_"+a.idx+"_container");"y"===i.axis||i.advanced.autoExpandHorizontalScroll||p.css("width",_(p.children())),"outside"===i.scrollbarPosition?("static"===t.css("position")&&t.css("position","relative"),t.css("overflow","visible"),m.addClass("mCSB_outside").after(c)):(m.addClass("mCSB_inside").append(c),p.wrap(d)),w.call(this);var g=[e("#mCSB_"+a.idx+"_dragger_vertical"),e("#mCSB_"+a.idx+"_dragger_horizontal")];g[0].css("min-height",g[0].height()),g[1].css("min-width",g[1].width())},_=function(t){return Math.max.apply(Math,t.map(function(){return e(this).outerWidth(!0)}).get())},S=function(){var t=e(this),a=t.data(n),o=a.opt,i=e("#mCSB_"+a.idx+"_container");o.advanced.autoExpandHorizontalScroll&&"y"!==o.axis&&i.css({position:"absolute",width:"auto"}).wrap("<div class='mCSB_h_wrapper' style='position:relative; left:0; width:999999px;' />").css({width:Math.ceil(i[0].getBoundingClientRect().right+.4)-Math.floor(i[0].getBoundingClientRect().left),position:"relative"}).unwrap()},w=function(){var t=e(this),a=t.data(n),o=a.opt,i=e(".mCSB_"+a.idx+"_scrollbar:first"),r=tt(o.scrollButtons.tabindex)?"tabindex='"+o.scrollButtons.tabindex+"'":"",l=["<a href='#' class='"+u[13]+"' oncontextmenu='return false;' "+r+" />","<a href='#' class='"+u[14]+"' oncontextmenu='return false;' "+r+" />","<a href='#' class='"+u[15]+"' oncontextmenu='return false;' "+r+" />","<a href='#' class='"+u[16]+"' oncontextmenu='return false;' "+r+" />"],s=["x"===o.axis?l[2]:l[0],"x"===o.axis?l[3]:l[1],l[2],l[3]];o.scrollButtons.enable&&i.prepend(s[0]).append(s[1]).next(".mCSB_scrollTools").prepend(s[2]).append(s[3])},b=function(){var t=e(this),a=t.data(n),o=e("#mCSB_"+a.idx),i=t.css("max-height")||"none",r=-1!==i.indexOf("%"),l=t.css("box-sizing");if("none"!==i){var s=r?t.parent().height()*parseInt(i)/100:parseInt(i);"border-box"===l&&(s-=t.innerHeight()-t.height()+(t.outerHeight()-t.innerHeight())),o.css("max-height",Math.round(s))}},C=function(){var t=e(this),a=t.data(n),o=e("#mCSB_"+a.idx),i=e("#mCSB_"+a.idx+"_container"),r=[e("#mCSB_"+a.idx+"_dragger_vertical"),e("#mCSB_"+a.idx+"_dragger_horizontal")],l=[o.height()/i.outerHeight(!1),o.width()/i.outerWidth(!1)],s=[parseInt(r[0].css("min-height")),Math.round(l[0]*r[0].parent().height()),parseInt(r[1].css("min-width")),Math.round(l[1]*r[1].parent().width())],d=c&&s[1]<s[0]?s[0]:s[1],u=c&&s[3]<s[2]?s[2]:s[3];r[0].css({height:d,"max-height":r[0].parent().height()-10}).find(".mCSB_dragger_bar").css({"line-height":s[0]+"px"}),r[1].css({width:u,"max-width":r[1].parent().width()-10})},y=function(){var t=e(this),a=t.data(n),o=e("#mCSB_"+a.idx),i=e("#mCSB_"+a.idx+"_container"),r=[e("#mCSB_"+a.idx+"_dragger_vertical"),e("#mCSB_"+a.idx+"_dragger_horizontal")],l=[i.outerHeight(!1)-o.height(),i.outerWidth(!1)-o.width()],s=[l[0]/(r[0].parent().height()-r[0].height()),l[1]/(r[1].parent().width()-r[1].width())];a.scrollRatio={y:s[0],x:s[1]}},B=function(e,t,a){var o=a?u[0]+"_expanded":"",n=e.closest(".mCSB_scrollTools");"active"===t?(e.toggleClass(u[0]+" "+o),n.toggleClass(u[1]),e[0]._draggable=e[0]._draggable?0:1):e[0]._draggable||("hide"===t?(e.removeClass(u[0]),n.removeClass(u[1])):(e.addClass(u[0]),n.addClass(u[1])))},T=function(){var t=e(this),a=t.data(n),o=e("#mCSB_"+a.idx),i=e("#mCSB_"+a.idx+"_container"),r=null==a.overflowed?i.height():i.outerHeight(!1),l=null==a.overflowed?i.width():i.outerWidth(!1);return[r>o.height(),l>o.width()]},k=function(){var t=e(this),a=t.data(n),o=a.opt,i=e("#mCSB_"+a.idx),r=e("#mCSB_"+a.idx+"_container"),l=[e("#mCSB_"+a.idx+"_dragger_vertical"),e("#mCSB_"+a.idx+"_dragger_horizontal")];if(V(t),("x"!==o.axis&&!a.overflowed[0]||"y"===o.axis&&a.overflowed[0])&&(l[0].add(r).css("top",0),Q(t,"_resetY")),"y"!==o.axis&&!a.overflowed[1]||"x"===o.axis&&a.overflowed[1]){var s=dx=0;"rtl"===a.langDir&&(s=i.width()-r.outerWidth(!1),dx=Math.abs(s/a.scrollRatio.x)),r.css("left",s),l[1].css("left",dx),Q(t,"_resetX")}},M=function(){function t(){r=setTimeout(function(){e.event.special.mousewheel?(clearTimeout(r),W.call(a[0])):t()},100)}var a=e(this),o=a.data(n),i=o.opt;if(!o.bindEvents){if(E.call(this),i.contentTouchScroll&&D.call(this),L.call(this),i.mouseWheel.enable){var r;t()}P.call(this),H.call(this),i.advanced.autoScrollOnFocus&&z.call(this),i.scrollButtons.enable&&U.call(this),i.keyboard.enable&&F.call(this),o.bindEvents=!0}},O=function(){var t=e(this),o=t.data(n),i=o.opt,r=n+"_"+o.idx,l=".mCSB_"+o.idx+"_scrollbar",s=e("#mCSB_"+o.idx+",#mCSB_"+o.idx+"_container,#mCSB_"+o.idx+"_container_wrapper,"+l+" ."+u[12]+",#mCSB_"+o.idx+"_dragger_vertical,#mCSB_"+o.idx+"_dragger_horizontal,"+l+">a"),c=e("#mCSB_"+o.idx+"_container");i.advanced.releaseDraggableSelectors&&s.add(e(i.advanced.releaseDraggableSelectors)),o.bindEvents&&(e(a).unbind("."+r),s.each(function(){e(this).unbind("."+r)}),clearTimeout(t[0]._focusTimeout),Z(t[0],"_focusTimeout"),clearTimeout(o.sequential.step),Z(o.sequential,"step"),clearTimeout(c[0].onCompleteTimeout),Z(c[0],"onCompleteTimeout"),o.bindEvents=!1)},I=function(t){var a=e(this),o=a.data(n),i=o.opt,r=e("#mCSB_"+o.idx+"_container_wrapper"),l=r.length?r:e("#mCSB_"+o.idx+"_container"),s=[e("#mCSB_"+o.idx+"_scrollbar_vertical"),e("#mCSB_"+o.idx+"_scrollbar_horizontal")],c=[s[0].find(".mCSB_dragger"),s[1].find(".mCSB_dragger")];"x"!==i.axis&&(o.overflowed[0]&&!t?(s[0].add(c[0]).add(s[0].children("a")).css("display","block"),l.removeClass(u[8]+" "+u[10])):(i.alwaysShowScrollbar?(2!==i.alwaysShowScrollbar&&c[0].add(s[0].children("a")).css("display","none"),l.removeClass(u[10])):(s[0].css("display","none"),l.addClass(u[10])),l.addClass(u[8]))),"y"!==i.axis&&(o.overflowed[1]&&!t?(s[1].add(c[1]).add(s[1].children("a")).css("display","block"),l.removeClass(u[9]+" "+u[11])):(i.alwaysShowScrollbar?(2!==i.alwaysShowScrollbar&&c[1].add(s[1].children("a")).css("display","none"),l.removeClass(u[11])):(s[1].css("display","none"),l.addClass(u[11])),l.addClass(u[9]))),o.overflowed[0]||o.overflowed[1]?a.removeClass(u[5]):a.addClass(u[5])},R=function(e){var t=e.type;switch(t){case"pointerdown":case"MSPointerDown":case"pointermove":case"MSPointerMove":case"pointerup":case"MSPointerUp":return[e.originalEvent.pageY,e.originalEvent.pageX,!1];case"touchstart":case"touchmove":case"touchend":var a=e.originalEvent.touches[0]||e.originalEvent.changedTouches[0],o=e.originalEvent.touches.length||e.originalEvent.changedTouches.length;return[a.pageY,a.pageX,o>1];default:return[e.pageY,e.pageX,!1]}},E=function(){function t(e){var t=p.find("iframe");if(t.length){var a=e?"auto":"none";t.css("pointer-events",a)}}function o(e,t,a,o){if(p[0].idleTimer=f.scrollInertia<233?250:0,i.attr("id")===m[1])var n="x",r=(i[0].offsetLeft-t+o)*u.scrollRatio.x;else var n="y",r=(i[0].offsetTop-e+a)*u.scrollRatio.y;Q(s,r.toString(),{dir:n,drag:!0})}var i,r,l,s=e(this),u=s.data(n),f=u.opt,h=n+"_"+u.idx,m=["mCSB_"+u.idx+"_dragger_vertical","mCSB_"+u.idx+"_dragger_horizontal"],p=e("#mCSB_"+u.idx+"_container"),g=e("#"+m[0]+",#"+m[1]),v=f.advanced.releaseDraggableSelectors?g.add(e(f.advanced.releaseDraggableSelectors)):g;g.bind("mousedown."+h+" touchstart."+h+" pointerdown."+h+" MSPointerDown."+h,function(o){if(o.stopImmediatePropagation(),o.preventDefault(),$(o)){d=!0,c&&(a.onselectstart=function(){return!1}),t(!1),V(s),i=e(this);var n=i.offset(),u=R(o)[0]-n.top,h=R(o)[1]-n.left,m=i.height()+n.top,p=i.width()+n.left;m>u&&u>0&&p>h&&h>0&&(r=u,l=h),B(i,"active",f.autoExpandScrollbar)}}).bind("touchmove."+h,function(e){e.stopImmediatePropagation(),e.preventDefault();var t=i.offset(),a=R(e)[0]-t.top,n=R(e)[1]-t.left;o(r,l,a,n)}),e(a).bind("mousemove."+h+" pointermove."+h+" MSPointerMove."+h,function(e){if(i){var t=i.offset(),a=R(e)[0]-t.top,n=R(e)[1]-t.left;if(r===a)return;o(r,l,a,n)}}).add(v).bind("mouseup."+h+" touchend."+h+" pointerup."+h+" MSPointerUp."+h,function(){i&&(B(i,"active",f.autoExpandScrollbar),i=null),d=!1,c&&(a.onselectstart=null),t(!0)})},D=function(){function t(e,t){var a=[1.5*t,2*t,t/1.5,t/2];return e>90?t>4?a[0]:a[3]:e>60?t>3?a[3]:a[2]:e>30?t>8?a[1]:t>6?a[0]:t>4?t:a[2]:t>8?t:a[3]}function a(e,t,a,o,n,i){e&&Q(g,e.toString(),{dur:t,scrollEasing:a,dir:o,overwrite:n,drag:i})}var o,i,r,l,s,c,u,f,h,m,p,g=e(this),v=g.data(n),x=v.opt,_=n+"_"+v.idx,S=e("#mCSB_"+v.idx),w=e("#mCSB_"+v.idx+"_container"),b=[e("#mCSB_"+v.idx+"_dragger_vertical"),e("#mCSB_"+v.idx+"_dragger_horizontal")],C=[],y=[],B=0,T="yx"===x.axis?"none":"all",k=[];w.bind("touchstart."+_+" pointerdown."+_+" MSPointerDown."+_,function(e){if(et(e)&&!d&&!R(e)[2]){var t=w.offset();o=R(e)[0]-t.top,i=R(e)[1]-t.left,k=[R(e)[0],R(e)[1]]}}).bind("touchmove."+_+" pointermove."+_+" MSPointerMove."+_,function(e){if(et(e)&&!d&&!R(e)[2]){e.stopImmediatePropagation(),c=J();var t=S.offset(),n=R(e)[0]-t.top,r=R(e)[1]-t.left,l="mcsLinearOut";if(C.push(n),y.push(r),k[2]=Math.abs(R(e)[0]-k[0]),k[3]=Math.abs(R(e)[1]-k[1]),v.overflowed[0])var s=b[0].parent().height()-b[0].height(),u=o-n>0&&n-o>-(s*v.scrollRatio.y)&&(2*k[3]<k[2]||"yx"===x.axis);if(v.overflowed[1])var f=b[1].parent().width()-b[1].width(),h=i-r>0&&r-i>-(f*v.scrollRatio.x)&&(2*k[2]<k[3]||"yx"===x.axis);(u||h)&&e.preventDefault(),m="yx"===x.axis?[o-n,i-r]:"x"===x.axis?[null,i-r]:[o-n,null],w[0].idleTimer=250,v.overflowed[0]&&a(m[0],B,l,"y","all",!0),v.overflowed[1]&&a(m[1],B,l,"x",T,!0)}}),S.bind("touchstart."+_+" pointerdown."+_+" MSPointerDown."+_,function(e){if(et(e)&&!d&&!R(e)[2]){e.stopImmediatePropagation(),V(g),s=J();var t=S.offset();r=R(e)[0]-t.top,l=R(e)[1]-t.left,C=[],y=[]}}).bind("touchend."+_+" pointerup."+_+" MSPointerUp."+_,function(e){if(et(e)&&!d&&!R(e)[2]){e.stopImmediatePropagation(),u=J();var o=S.offset(),n=R(e)[0]-o.top,i=R(e)[1]-o.left;if(!(u-c>30)){h=1e3/(u-s);var g="mcsEaseOut",_=2.5>h,b=_?[C[C.length-2],y[y.length-2]]:[0,0];f=_?[n-b[0],i-b[1]]:[n-r,i-l];var B=[Math.abs(f[0]),Math.abs(f[1])];h=_?[Math.abs(f[0]/4),Math.abs(f[1]/4)]:[h,h];var k=[Math.abs(w[0].offsetTop)-f[0]*t(B[0]/h[0],h[0]),Math.abs(w[0].offsetLeft)-f[1]*t(B[1]/h[1],h[1])];m="yx"===x.axis?[k[0],k[1]]:"x"===x.axis?[null,k[1]]:[k[0],null],p=[4*B[0]+x.scrollInertia,4*B[1]+x.scrollInertia];var M=parseInt(x.contentTouchScroll)||0;m[0]=B[0]>M?m[0]:0,m[1]=B[1]>M?m[1]:0,v.overflowed[0]&&a(m[0],p[0],g,"y",T,!1),v.overflowed[1]&&a(m[1],p[1],g,"x",T,!1)}}})},L=function(){function o(){return t.getSelection?t.getSelection().toString():a.selection&&"Control"!=a.selection.type?a.selection.createRange().text:0}function i(e,t,a){u.type=a&&r?"stepped":"stepless",u.scrollAmount=10,q(l,e,t,"mcsLinearOut",a?60:null)}var r,l=e(this),s=l.data(n),c=s.opt,u=s.sequential,f=n+"_"+s.idx,h=e("#mCSB_"+s.idx+"_container"),m=h.parent();h.bind("mousedown."+f,function(){r||(r=1,d=!0)}).add(a).bind("mousemove."+f,function(e){if(r&&o()){var t=h.offset(),a=R(e)[0]-t.top+h[0].offsetTop,n=R(e)[1]-t.left+h[0].offsetLeft;a>0&&a<m.height()&&n>0&&n<m.width()?u.step&&i("off",null,"stepped"):("x"!==c.axis&&s.overflowed[0]&&(0>a?i("on",38):a>m.height()&&i("on",40)),"y"!==c.axis&&s.overflowed[1]&&(0>n?i("on",37):n>m.width()&&i("on",39)))}}).bind("mouseup."+f,function(){r&&(r=0,i("off",null)),d=!1})},W=function(){function t(e){var t=null;try{var a=e.contentDocument||e.contentWindow.document;t=a.body.innerHTML}catch(o){}return null!==t}var a=e(this),o=a.data(n);if(o){var i=o.opt,r=n+"_"+o.idx,l=e("#mCSB_"+o.idx),s=[e("#mCSB_"+o.idx+"_dragger_vertical"),e("#mCSB_"+o.idx+"_dragger_horizontal")],d=e("#mCSB_"+o.idx+"_container").find("iframe"),u=l;d.length&&d.each(function(){var a=this;t(a)&&(u=u.add(e(a).contents().find("body")))}),u.bind("mousewheel."+r,function(t,n){if(V(a),!A(a,t.target)){var r="auto"!==i.mouseWheel.deltaFactor?parseInt(i.mouseWheel.deltaFactor):c&&t.deltaFactor<100?100:t.deltaFactor||100;if("x"===i.axis||"x"===i.mouseWheel.axis)var d="x",u=[Math.round(r*o.scrollRatio.x),parseInt(i.mouseWheel.scrollAmount)],f="auto"!==i.mouseWheel.scrollAmount?u[1]:u[0]>=l.width()?.9*l.width():u[0],h=Math.abs(e("#mCSB_"+o.idx+"_container")[0].offsetLeft),m=s[1][0].offsetLeft,p=s[1].parent().width()-s[1].width(),g=t.deltaX||t.deltaY||n;else var d="y",u=[Math.round(r*o.scrollRatio.y),parseInt(i.mouseWheel.scrollAmount)],f="auto"!==i.mouseWheel.scrollAmount?u[1]:u[0]>=l.height()?.9*l.height():u[0],h=Math.abs(e("#mCSB_"+o.idx+"_container")[0].offsetTop),m=s[0][0].offsetTop,p=s[0].parent().height()-s[0].height(),g=t.deltaY||n;"y"===d&&!o.overflowed[0]||"x"===d&&!o.overflowed[1]||(i.mouseWheel.invert&&(g=-g),i.mouseWheel.normalizeDelta&&(g=0>g?-1:1),(g>0&&0!==m||0>g&&m!==p||i.mouseWheel.preventDefault)&&(t.stopImmediatePropagation(),t.preventDefault()),Q(a,(h-g*f).toString(),{dir:d}))}})}},A=function(t,a){var o=a.nodeName.toLowerCase(),i=t.data(n).opt.mouseWheel.disableOver,r=["select","textarea"];return e.inArray(o,i)>-1&&!(e.inArray(o,r)>-1&&!e(a).is(":focus"))},P=function(){var t=e(this),a=t.data(n),o=n+"_"+a.idx,i=e("#mCSB_"+a.idx+"_container"),r=i.parent(),l=e(".mCSB_"+a.idx+"_scrollbar ."+u[12]);l.bind("touchstart."+o+" pointerdown."+o+" MSPointerDown."+o,function(){d=!0}).bind("touchend."+o+" pointerup."+o+" MSPointerUp."+o,function(){d=!1}).bind("click."+o,function(o){if(e(o.target).hasClass(u[12])||e(o.target).hasClass("mCSB_draggerRail")){V(t);var n=e(this),l=n.find(".mCSB_dragger");if(n.parent(".mCSB_scrollTools_horizontal").length>0){if(!a.overflowed[1])return;var s="x",c=o.pageX>l.offset().left?-1:1,d=Math.abs(i[0].offsetLeft)-.9*c*r.width()}else{if(!a.overflowed[0])return;var s="y",c=o.pageY>l.offset().top?-1:1,d=Math.abs(i[0].offsetTop)-.9*c*r.height()}Q(t,d.toString(),{dir:s,scrollEasing:"mcsEaseInOut"})}})},z=function(){var t=e(this),o=t.data(n),i=o.opt,r=n+"_"+o.idx,l=e("#mCSB_"+o.idx+"_container"),s=l.parent();l.bind("focusin."+r,function(){var o=e(a.activeElement),n=l.find(".mCustomScrollBox").length,r=0;o.is(i.advanced.autoScrollOnFocus)&&(V(t),clearTimeout(t[0]._focusTimeout),t[0]._focusTimer=n?(r+17)*n:0,t[0]._focusTimeout=setTimeout(function(){var e=[at(o)[0],at(o)[1]],a=[l[0].offsetTop,l[0].offsetLeft],n=[a[0]+e[0]>=0&&a[0]+e[0]<s.height()-o.outerHeight(!1),a[1]+e[1]>=0&&a[0]+e[1]<s.width()-o.outerWidth(!1)],c="yx"!==i.axis||n[0]||n[1]?"all":"none";"x"===i.axis||n[0]||Q(t,e[0].toString(),{dir:"y",scrollEasing:"mcsEaseInOut",overwrite:c,dur:r}),"y"===i.axis||n[1]||Q(t,e[1].toString(),{dir:"x",scrollEasing:"mcsEaseInOut",overwrite:c,dur:r})},t[0]._focusTimer))})},H=function(){var t=e(this),a=t.data(n),o=n+"_"+a.idx,i=e("#mCSB_"+a.idx+"_container").parent();i.bind("scroll."+o,function(){(0!==i.scrollTop()||0!==i.scrollLeft())&&e(".mCSB_"+a.idx+"_scrollbar").css("visibility","hidden")})},U=function(){var t=e(this),a=t.data(n),o=a.opt,i=a.sequential,r=n+"_"+a.idx,l=".mCSB_"+a.idx+"_scrollbar",s=e(l+">a");s.bind("mousedown."+r+" touchstart."+r+" pointerdown."+r+" MSPointerDown."+r+" mouseup."+r+" touchend."+r+" pointerup."+r+" MSPointerUp."+r+" mouseout."+r+" pointerout."+r+" MSPointerOut."+r+" click."+r,function(n){function r(e,a){i.scrollAmount=o.snapAmount||o.scrollButtons.scrollAmount,q(t,e,a)}if(n.preventDefault(),$(n)){var l=e(this).attr("class");switch(i.type=o.scrollButtons.scrollType,n.type){case"mousedown":case"touchstart":case"pointerdown":case"MSPointerDown":if("stepped"===i.type)return;d=!0,a.tweenRunning=!1,r("on",l);break;case"mouseup":case"touchend":case"pointerup":case"MSPointerUp":case"mouseout":case"pointerout":case"MSPointerOut":if("stepped"===i.type)return;d=!1,i.dir&&r("off",l);break;case"click":if("stepped"!==i.type||a.tweenRunning)return;r("on",l)}}})},F=function(){var t=e(this),o=t.data(n),i=o.opt,r=o.sequential,l=n+"_"+o.idx,s=e("#mCSB_"+o.idx),c=e("#mCSB_"+o.idx+"_container"),d=c.parent(),u="input,textarea,select,datalist,keygen,[contenteditable='true']";s.attr("tabindex","0").bind("blur."+l+" keydown."+l+" keyup."+l,function(n){function l(e,a){r.type=i.keyboard.scrollType,r.scrollAmount=i.snapAmount||i.keyboard.scrollAmount,"stepped"===r.type&&o.tweenRunning||q(t,e,a)}switch(n.type){case"blur":o.tweenRunning&&r.dir&&l("off",null);break;case"keydown":case"keyup":var s=n.keyCode?n.keyCode:n.which,f="on";if("x"!==i.axis&&(38===s||40===s)||"y"!==i.axis&&(37===s||39===s)){if((38===s||40===s)&&!o.overflowed[0]||(37===s||39===s)&&!o.overflowed[1])return;"keyup"===n.type&&(f="off"),e(a.activeElement).is(u)||(n.preventDefault(),n.stopImmediatePropagation(),l(f,s))}else if(33===s||34===s){if((o.overflowed[0]||o.overflowed[1])&&(n.preventDefault(),n.stopImmediatePropagation()),"keyup"===n.type){V(t);var h=34===s?-1:1;if("x"===i.axis||"yx"===i.axis&&o.overflowed[1]&&!o.overflowed[0])var m="x",p=Math.abs(c[0].offsetLeft)-.9*h*d.width();else var m="y",p=Math.abs(c[0].offsetTop)-.9*h*d.height();Q(t,p.toString(),{dir:m,scrollEasing:"mcsEaseInOut"})}}else if((35===s||36===s)&&!e(a.activeElement).is(u)&&((o.overflowed[0]||o.overflowed[1])&&(n.preventDefault(),n.stopImmediatePropagation()),"keyup"===n.type)){if("x"===i.axis||"yx"===i.axis&&o.overflowed[1]&&!o.overflowed[0])var m="x",p=35===s?Math.abs(d.width()-c.outerWidth(!1)):0;else var m="y",p=35===s?Math.abs(d.height()-c.outerHeight(!1)):0;Q(t,p.toString(),{dir:m,scrollEasing:"mcsEaseInOut"})}}})},q=function(t,a,o,i,r){function l(e){var a="stepped"!==f.type,o=r?r:e?a?d.scrollInertia/1.5:d.scrollInertia:1e3/60,n=e?a?7.5:40:2.5,s=[Math.abs(h[0].offsetTop),Math.abs(h[0].offsetLeft)],u=[c.scrollRatio.y>10?10:c.scrollRatio.y,c.scrollRatio.x>10?10:c.scrollRatio.x],m="x"===f.dir[0]?s[1]+f.dir[1]*u[1]*n:s[0]+f.dir[1]*u[0]*n,p="x"===f.dir[0]?s[1]+f.dir[1]*parseInt(f.scrollAmount):s[0]+f.dir[1]*parseInt(f.scrollAmount),g="auto"!==f.scrollAmount?p:m,v=i?i:e?a?"mcsLinearOut":"mcsEaseInOut":"mcsLinear",x=e?!0:!1;return e&&17>o&&(g="x"===f.dir[0]?s[1]:s[0]),Q(t,g.toString(),{dir:f.dir[0],scrollEasing:v,dur:o,onComplete:x}),e?void(f.dir=!1):(clearTimeout(f.step),void(f.step=setTimeout(function(){l()},o)))}function s(){clearTimeout(f.step),Z(f,"step"),V(t)}var c=t.data(n),d=c.opt,f=c.sequential,h=e("#mCSB_"+c.idx+"_container"),m="stepped"===f.type?!0:!1;switch(a){case"on":if(f.dir=[o===u[16]||o===u[15]||39===o||37===o?"x":"y",o===u[13]||o===u[15]||38===o||37===o?-1:1],V(t),tt(o)&&"stepped"===f.type)return;l(m);break;case"off":s(),(m||c.tweenRunning&&f.dir)&&l(!0)}},j=function(t){var a=e(this).data(n).opt,o=[];return"function"==typeof t&&(t=t()),t instanceof Array?o=t.length>1?[t[0],t[1]]:"x"===a.axis?[null,t[0]]:[t[0],null]:(o[0]=t.y?t.y:t.x||"x"===a.axis?null:t,o[1]=t.x?t.x:t.y||"y"===a.axis?null:t),"function"==typeof o[0]&&(o[0]=o[0]()),"function"==typeof o[1]&&(o[1]=o[1]()),o},Y=function(t,a){if(null!=t&&"undefined"!=typeof t){var o=e(this),i=o.data(n),r=i.opt,l=e("#mCSB_"+i.idx+"_container"),s=l.parent(),c=typeof t;a||(a="x"===r.axis?"x":"y");var d="x"===a?l.outerWidth(!1):l.outerHeight(!1),u="x"===a?l[0].offsetLeft:l[0].offsetTop,h="x"===a?"left":"top";switch(c){case"function":return t();case"object":var m=t.jquery?t:e(t);if(!m.length)return;return"x"===a?at(m)[1]:at(m)[0];case"string":case"number":if(tt(t))return Math.abs(t);if(-1!==t.indexOf("%"))return Math.abs(d*parseInt(t)/100);if(-1!==t.indexOf("-="))return Math.abs(u-parseInt(t.split("-=")[1]));if(-1!==t.indexOf("+=")){var p=u+parseInt(t.split("+=")[1]);return p>=0?0:Math.abs(p)}if(-1!==t.indexOf("px")&&tt(t.split("px")[0]))return Math.abs(t.split("px")[0]);if("top"===t||"left"===t)return 0;if("bottom"===t)return Math.abs(s.height()-l.outerHeight(!1));if("right"===t)return Math.abs(s.width()-l.outerWidth(!1));if("first"===t||"last"===t){var m=l.find(":"+t);return"x"===a?at(m)[1]:at(m)[0]}return e(t).length?"x"===a?at(e(t))[1]:at(e(t))[0]:(l.css(h,t),void f.update.call(null,o[0]))}}},X=function(t){function a(){clearTimeout(h[0].autoUpdate),h[0].autoUpdate=setTimeout(function(){return d.advanced.updateOnSelectorChange&&(m=r(),m!==S)?(l(3),void(S=m)):(d.advanced.updateOnContentResize&&(p=[h.outerHeight(!1),h.outerWidth(!1),v.height(),v.width(),_()[0],_()[1]],(p[0]!==w[0]||p[1]!==w[1]||p[2]!==w[2]||p[3]!==w[3]||p[4]!==w[4]||p[5]!==w[5])&&(l(p[0]!==w[0]||p[1]!==w[1]),w=p)),d.advanced.updateOnImageLoad&&(g=o(),g!==b&&(h.find("img").each(function(){i(this)}),b=g)),void((d.advanced.updateOnSelectorChange||d.advanced.updateOnContentResize||d.advanced.updateOnImageLoad)&&a()))},60)}function o(){var e=0;return d.advanced.updateOnImageLoad&&(e=h.find("img").length),e}function i(t){function a(e,t){return function(){return t.apply(e,arguments)}}function o(){this.onload=null,e(t).addClass(u[2]),l(2)}if(e(t).hasClass(u[2]))return void l();var n=new Image;n.onload=a(n,o),n.src=t.src}function r(){d.advanced.updateOnSelectorChange===!0&&(d.advanced.updateOnSelectorChange="*");var t=0,a=h.find(d.advanced.updateOnSelectorChange);return d.advanced.updateOnSelectorChange&&a.length>0&&a.each(function(){t+=e(this).height()+e(this).width()}),t}function l(e){clearTimeout(h[0].autoUpdate),f.update.call(null,s[0],e)}var s=e(this),c=s.data(n),d=c.opt,h=e("#mCSB_"+c.idx+"_container");if(t)return clearTimeout(h[0].autoUpdate),void Z(h[0],"autoUpdate");var m,p,g,v=h.parent(),x=[e("#mCSB_"+c.idx+"_scrollbar_vertical"),e("#mCSB_"+c.idx+"_scrollbar_horizontal")],_=function(){return[x[0].is(":visible")?x[0].outerHeight(!0):0,x[1].is(":visible")?x[1].outerWidth(!0):0]},S=r(),w=[h.outerHeight(!1),h.outerWidth(!1),v.height(),v.width(),_()[0],_()[1]],b=o();a()},N=function(e,t,a){return Math.round(e/t)*t-a},V=function(t){var a=t.data(n),o=e("#mCSB_"+a.idx+"_container,#mCSB_"+a.idx+"_container_wrapper,#mCSB_"+a.idx+"_dragger_vertical,#mCSB_"+a.idx+"_dragger_horizontal");o.each(function(){K.call(this)})},Q=function(t,a,o){function i(e){return s&&c.callbacks[e]&&"function"==typeof c.callbacks[e]}function r(){return[c.callbacks.alwaysTriggerOffsets||_>=S[0]+b,c.callbacks.alwaysTriggerOffsets||-C>=_]}function l(){var e=[h[0].offsetTop,h[0].offsetLeft],a=[v[0].offsetTop,v[0].offsetLeft],n=[h.outerHeight(!1),h.outerWidth(!1)],i=[f.height(),f.width()];t[0].mcs={content:h,top:e[0],left:e[1],draggerTop:a[0],draggerLeft:a[1],topPct:Math.round(100*Math.abs(e[0])/(Math.abs(n[0])-i[0])),leftPct:Math.round(100*Math.abs(e[1])/(Math.abs(n[1])-i[1])),direction:o.dir}}var s=t.data(n),c=s.opt,d={trigger:"internal",dir:"y",scrollEasing:"mcsEaseOut",drag:!1,dur:c.scrollInertia,overwrite:"all",callbacks:!0,onStart:!0,onUpdate:!0,onComplete:!0},o=e.extend(d,o),u=[o.dur,o.drag?0:o.dur],f=e("#mCSB_"+s.idx),h=e("#mCSB_"+s.idx+"_container"),m=h.parent(),p=c.callbacks.onTotalScrollOffset?j.call(t,c.callbacks.onTotalScrollOffset):[0,0],g=c.callbacks.onTotalScrollBackOffset?j.call(t,c.callbacks.onTotalScrollBackOffset):[0,0];if(s.trigger=o.trigger,(0!==m.scrollTop()||0!==m.scrollLeft())&&(e(".mCSB_"+s.idx+"_scrollbar").css("visibility","visible"),m.scrollTop(0).scrollLeft(0)),"_resetY"!==a||s.contentReset.y||(i("onOverflowYNone")&&c.callbacks.onOverflowYNone.call(t[0]),s.contentReset.y=1),"_resetX"!==a||s.contentReset.x||(i("onOverflowXNone")&&c.callbacks.onOverflowXNone.call(t[0]),s.contentReset.x=1),"_resetY"!==a&&"_resetX"!==a){switch(!s.contentReset.y&&t[0].mcs||!s.overflowed[0]||(i("onOverflowY")&&c.callbacks.onOverflowY.call(t[0]),s.contentReset.x=null),!s.contentReset.x&&t[0].mcs||!s.overflowed[1]||(i("onOverflowX")&&c.callbacks.onOverflowX.call(t[0]),s.contentReset.x=null),c.snapAmount&&(a=N(a,c.snapAmount,c.snapOffset)),o.dir){case"x":var v=e("#mCSB_"+s.idx+"_dragger_horizontal"),x="left",_=h[0].offsetLeft,S=[f.width()-h.outerWidth(!1),v.parent().width()-v.width()],w=[a,0===a?0:a/s.scrollRatio.x],b=p[1],C=g[1],y=b>0?b/s.scrollRatio.x:0,T=C>0?C/s.scrollRatio.x:0;break;
case"y":var v=e("#mCSB_"+s.idx+"_dragger_vertical"),x="top",_=h[0].offsetTop,S=[f.height()-h.outerHeight(!1),v.parent().height()-v.height()],w=[a,0===a?0:a/s.scrollRatio.y],b=p[0],C=g[0],y=b>0?b/s.scrollRatio.y:0,T=C>0?C/s.scrollRatio.y:0}w[1]<0||0===w[0]&&0===w[1]?w=[0,0]:w[1]>=S[1]?w=[S[0],S[1]]:w[0]=-w[0],t[0].mcs||(l(),i("onInit")&&c.callbacks.onInit.call(t[0])),clearTimeout(h[0].onCompleteTimeout),(s.tweenRunning||!(0===_&&w[0]>=0||_===S[0]&&w[0]<=S[0]))&&(G(v[0],x,Math.round(w[1]),u[1],o.scrollEasing),G(h[0],x,Math.round(w[0]),u[0],o.scrollEasing,o.overwrite,{onStart:function(){o.callbacks&&o.onStart&&!s.tweenRunning&&(i("onScrollStart")&&(l(),c.callbacks.onScrollStart.call(t[0])),s.tweenRunning=!0,B(v),s.cbOffsets=r())},onUpdate:function(){o.callbacks&&o.onUpdate&&i("whileScrolling")&&(l(),c.callbacks.whileScrolling.call(t[0]))},onComplete:function(){if(o.callbacks&&o.onComplete){"yx"===c.axis&&clearTimeout(h[0].onCompleteTimeout);var e=h[0].idleTimer||0;h[0].onCompleteTimeout=setTimeout(function(){i("onScroll")&&(l(),c.callbacks.onScroll.call(t[0])),i("onTotalScroll")&&w[1]>=S[1]-y&&s.cbOffsets[0]&&(l(),c.callbacks.onTotalScroll.call(t[0])),i("onTotalScrollBack")&&w[1]<=T&&s.cbOffsets[1]&&(l(),c.callbacks.onTotalScrollBack.call(t[0])),s.tweenRunning=!1,h[0].idleTimer=0,B(v,"hide")},e)}}}))}},G=function(e,a,o,n,i,r,l){function s(){b.stop||(_||p.call(),_=J()-x,c(),_>=b.time&&(b.time=_>b.time?_+h-(_-b.time):_+h-1,b.time<_+1&&(b.time=_+1)),b.time<n?b.id=m(s):v.call())}function c(){n>0?(b.currVal=f(b.time,S,C,n,i),w[a]=Math.round(b.currVal)+"px"):w[a]=o+"px",g.call()}function d(){h=1e3/60,b.time=_+h,m=t.requestAnimationFrame?t.requestAnimationFrame:function(e){return c(),setTimeout(e,.01)},b.id=m(s)}function u(){null!=b.id&&(t.requestAnimationFrame?t.cancelAnimationFrame(b.id):clearTimeout(b.id),b.id=null)}function f(e,t,a,o,n){switch(n){case"linear":case"mcsLinear":return a*e/o+t;case"mcsLinearOut":return e/=o,e--,a*Math.sqrt(1-e*e)+t;case"easeInOutSmooth":return e/=o/2,1>e?a/2*e*e+t:(e--,-a/2*(e*(e-2)-1)+t);case"easeInOutStrong":return e/=o/2,1>e?a/2*Math.pow(2,10*(e-1))+t:(e--,a/2*(-Math.pow(2,-10*e)+2)+t);case"easeInOut":case"mcsEaseInOut":return e/=o/2,1>e?a/2*e*e*e+t:(e-=2,a/2*(e*e*e+2)+t);case"easeOutSmooth":return e/=o,e--,-a*(e*e*e*e-1)+t;case"easeOutStrong":return a*(-Math.pow(2,-10*e/o)+1)+t;case"easeOut":case"mcsEaseOut":default:var i=(e/=o)*e,r=i*e;return t+a*(.499999999999997*r*i+-2.5*i*i+5.5*r+-6.5*i+4*e)}}e._mTween||(e._mTween={top:{},left:{}});var h,m,l=l||{},p=l.onStart||function(){},g=l.onUpdate||function(){},v=l.onComplete||function(){},x=J(),_=0,S=e.offsetTop,w=e.style,b=e._mTween[a];"left"===a&&(S=e.offsetLeft);var C=o-S;b.stop=0,"none"!==r&&u(),d()},J=function(){return t.performance&&t.performance.now?t.performance.now():t.performance&&t.performance.webkitNow?t.performance.webkitNow():Date.now?Date.now():(new Date).getTime()},K=function(){var e=this;e._mTween||(e._mTween={top:{},left:{}});for(var a=["top","left"],o=0;o<a.length;o++){var n=a[o];e._mTween[n].id&&(t.requestAnimationFrame?t.cancelAnimationFrame(e._mTween[n].id):clearTimeout(e._mTween[n].id),e._mTween[n].id=null,e._mTween[n].stop=1)}},Z=function(e,t){try{delete e[t]}catch(a){e[t]=null}},$=function(e){return!(e.which&&1!==e.which)},et=function(e){var t=e.originalEvent.pointerType;return!(t&&"touch"!==t&&2!==t)},tt=function(e){return!isNaN(parseFloat(e))&&isFinite(e)},at=function(e){var t=e.parents(".mCSB_container");return[e.offset().top-t.offset().top,e.offset().left-t.offset().left]};e.fn[o]=function(t){return f[t]?f[t].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof t&&t?void e.error("Method "+t+" does not exist"):f.init.apply(this,arguments)},e[o]=function(t){return f[t]?f[t].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof t&&t?void e.error("Method "+t+" does not exist"):f.init.apply(this,arguments)},e[o].defaults=r,t[o]=!0,e(t).load(function(){e(i)[o](),e.extend(e.expr[":"],{mcsInView:e.expr[":"].mcsInView||function(t){var a,o,n=e(t),i=n.parents(".mCSB_container");if(i.length)return a=i.parent(),o=[i[0].offsetTop,i[0].offsetLeft],o[0]+at(n)[0]>=0&&o[0]+at(n)[0]<a.height()-n.outerHeight(!1)&&o[1]+at(n)[1]>=0&&o[1]+at(n)[1]<a.width()-n.outerWidth(!1)},mcsOverflow:e.expr[":"].mcsOverflow||function(t){var a=e(t).data(n);if(a)return a.overflowed[0]||a.overflowed[1]}})})})}(jQuery,window,document);
/*! jsviews.js v0.9.76 (Beta) single-file version: http://jsviews.com/ */
/*! includes JsRender, JsObservable and JsViews - see: http://jsviews.com/#download */

/* Interactive data-driven views using JsRender templates */

//<<<<<<<<<<<<<<<<<<<<<<<<<<<<<< JsRender >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
/* JsRender:
 * See http://jsviews.com/#jsrender and http://github.com/BorisMoore/jsrender
 * Copyright 2016, Boris Moore
 * Released under the MIT License.
 */

//jshint -W018, -W041

(function (factory, global) {
    // global var is the this object, which is window when running in the usual browser environment
    var $ = global.jQuery;

    if (typeof exports === "object") { // CommonJS e.g. Browserify
        module.exports = $
			? factory(global, $)
			: function ($) { // If no global jQuery, take jQuery passed as parameter: require("jsviews")(jQuery)
			    return factory(global, $);
			};
    } else if (typeof define === "function" && define.amd) { // AMD script loader, e.g. RequireJS
        define(["jquery"], function ($) {
            return factory(global, $);
        }); // Require jQuery
    } else { // Browser using plain <script> tag
        factory(global, false);
    }
}(

// factory (for jsviews.js)
function (global, $) {
    "use strict";

    //========================== Top-level vars ==========================

    // global var is the this object, which is window when running in the usual browser environment
    var setGlobals = $ === false; // Only set globals if script block in browser (not AMD and not CommonJS)

    $ = $ || global.jQuery; // $ is jQuery passed in by CommonJS loader (Browserify), or global jQuery.

    if (!$ || !$.fn) {
        // jQuery is not loaded.
        throw "JsViews requires jQuery"; // We require jQuery
    }

    var versionNumber = "v0.9.76",

        jsvStoreName, rTag, rTmplString, topView, $views, $observe, $observable,

    //TODO	tmplFnsCache = {},
        $isFunction, $isArray, $templates, $converters, $helpers, $tags, $sub, $subSettings, $subSettingsAdvanced, $viewsSettings, delimOpenChar0, delimOpenChar1, delimCloseChar0, delimCloseChar1, linkChar, setting, baseOnError,

        rPath = /^(!*?)(?:null|true|false|\d[\d.]*|([\w$]+|\.|~([\w$]+)|#(view|([\w$]+))?)([\w$.^]*?)(?:[.[^]([\w$]+)\]?)?)$/g,
        //        not                               object     helper    view  viewProperty pathTokens      leafToken

        rParams = /(\()(?=\s*\()|(?:([([])\s*)?(?:(\^?)(!*?[#~]?[\w$.^]+)?\s*((\+\+|--)|\+|-|&&|\|\||===|!==|==|!=|<=|>=|[<>%*:?\/]|(=))\s*|(!*?[#~]?[\w$.^]+)([([])?)|(,\s*)|(\(?)\\?(?:(')|("))|(?:\s*(([)\]])(?=\s*[.^]|\s*$|[^([])|[)\]])([([]?))|(\s+)/g,
        //          lftPrn0        lftPrn        bound            path    operator err                                                eq             path2       prn    comma   lftPrn2   apos quot      rtPrn rtPrnDot                           prn2  space
        // (left paren? followed by (path? followed by operator) or (path followed by left paren?)) or comma or apos or quot or right paren or space

        isRenderCall,
        rNewLine = /[ \t]*(\r\n|\n|\r)/g,
        rUnescapeQuotes = /\\(['"])/g,
        rEscapeQuotes = /['"\\]/g, // Escape quotes and \ character
        rBuildHash = /(?:\x08|^)(onerror:)?(?:(~?)(([\w$_\.]+):)?([^\x08]+))\x08(,)?([^\x08]+)/gi,
        rTestElseIf = /^if\s/,
        rFirstElem = /<(\w+)[>\s]/,
        rAttrEncode = /[\x00`><"'&=]/g, // Includes > encoding since rConvertMarkers in JsViews does not skip > characters in attribute strings
        rIsHtml = /[\x00`><\"'&=]/,
        rHasHandlers = /^on[A-Z]|^convert(Back)?$/,
        rHtmlEncode = rAttrEncode,
        viewId = 0,
        charEntities = {
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            "\x00": "&#0;",
            "'": "&#39;",
            '"': "&#34;",
            "`": "&#96;",
            "=": "&#61;"
        },
        HTML = "html",
        OBJECT = "object",
        tmplAttr = "data-jsv-tmpl",
        jsvTmpl = "jsvTmpl",
        indexStr = "For #index in nested block use #getIndex().",
        $render = {},

        jsr = global.jsrender,
        jsrToJq = jsr && $ && !$.render, // JsRender already loaded, without jQuery. but we will re-load it now to attach to jQuery

        jsvStores = {
            template: {
                compile: compileTmpl
            },
            tag: {
                compile: compileTag
            },
            viewModel: {
                compile: compileViewModel
            },
            helper: {},
            converter: {}
        };

    // views object ($.views if jQuery is loaded, jsrender.views if no jQuery, e.g. in Node.js)
    $views = {
        jsviews: versionNumber,
        sub: {
            // subscription, e.g. JsViews integration
            View: View,
            Err: JsViewsError,
            tmplFn: tmplFn,
            parse: parseParams,
            extend: $extend,
            extendCtx: extendCtx,
            syntaxErr: syntaxError,
            onStore: {},
            addSetting: addSetting,
            settings: {
                allowCode: false
            },
            advSet: noop, // Update advanced settings
            _ths: tagHandlersFromProps,
            _tg: function () { }, // Constructor for tagDef
            _cnvt: convertVal,
            _tag: renderTag,
            _er: error,
            _err: onRenderError,
            _html: htmlEncode,
            _sq: function (token) {
                if (token === "constructor") {
                    syntaxError("");
                }
                return token;
            }
        },
        settings: {
            delimiters: $viewsDelimiters,
            advanced: function (value) {
                return value
					? (
							$extend($subSettingsAdvanced, value),
							$sub.advSet(),
							$viewsSettings
						)
						: $subSettingsAdvanced;
            }
        },
        map: dataMap // If jsObservable loaded first, use that definition of dataMap
    };

    function getDerivedMethod(baseMethod, method) {
        return function () {
            var ret,
                tag = this,
                prevBase = tag.base;

            tag.base = baseMethod; // Within method call, calling this.base will call the base method
            ret = method.apply(tag, arguments); // Call the method
            tag.base = prevBase; // Replace this.base to be the base method of the previous call, for chained calls
            return ret;
        };
    }

    function getMethod(baseMethod, method) {
        // For derived methods (or handlers declared declaratively as in {{:foo onChange=~fooChanged}} replace by a derived method, to allow using this.base(...)
        // or this.baseApply(arguments) to call the base implementation. (Equivalent to this._super(...) and this._superApply(arguments) in jQuery UI)
        if ($isFunction(method)) {
            method = getDerivedMethod(
                    !baseMethod
                        ? noop // no base method implementation, so use noop as base method
                        : baseMethod._d
                            ? baseMethod // baseMethod is a derived method, so us it
                            : getDerivedMethod(noop, baseMethod), // baseMethod is not derived so make its base method be the noop method
                    method
                );
            method._d = 1; // Add flag that this is a derived method
        }
        return method;
    }

    function tagHandlersFromProps(tag, tagCtx) {
        for (var prop in tagCtx.props) {
            if (rHasHandlers.test(prop)) {
                tag[prop] = getMethod(tag[prop], tagCtx.props[prop]);
                // Copy over the onFoo props, convert and convertBack from tagCtx.props to tag (overrides values in tagDef).
                // Note: unsupported scenario: if handlers are dynamically added ^onFoo=expression this will work, but dynamically removing will not work.
            }
        }
    }

    function retVal(val) {
        return val;
    }

    function noop() {
        return "";
    }

    function dbgBreak(val) {
        // Usage examples: {{dbg:...}}, {{:~dbg(...)}}, {{dbg .../}}, {^{for ... onAfterLink=~dbg}} etc.
        try {
            console.log("JsRender dbg breakpoint: " + val);
            throw "dbg breakpoint"; // To break here, stop on caught exceptions.
        }
        catch (e) { }
        return this.base ? this.baseApply(arguments) : val;
    }

    function JsViewsError(message) {
        // Error exception type for JsViews/JsRender
        // Override of $.views.sub.Error is possible
        this.name = ($.link ? "JsViews" : "JsRender") + " Error";
        this.message = message || this.name;
    }

    function $extend(target, source) {
        for (var name in source) {
            target[name] = source[name];
        }
        return target;
    }

    (JsViewsError.prototype = new Error()).constructor = JsViewsError;

    //========================== Top-level functions ==========================

    //===================
    // views.delimiters
    //===================

    function $viewsDelimiters(openChars, closeChars, link) {
        // Set the tag opening and closing delimiters and 'link' character. Default is "{{", "}}" and "^"
        // openChars, closeChars: opening and closing strings, each with two characters
        if (!openChars) {
            return $subSettings.delimiters;
        }

        $subSettings.delimiters = [openChars, closeChars, linkChar = link ? link.charAt(0) : linkChar];

        delimOpenChar0 = openChars.charAt(0); // Escape the characters - since they could be regex special characters
        delimOpenChar1 = openChars.charAt(1);
        delimCloseChar0 = closeChars.charAt(0);
        delimCloseChar1 = closeChars.charAt(1);
        openChars = "\\" + delimOpenChar0 + "(\\" + linkChar + ")?\\" + delimOpenChar1; // Default is "{^{"
        closeChars = "\\" + delimCloseChar0 + "\\" + delimCloseChar1;                   // Default is "}}"
        // Build regex with new delimiters
        //          [tag    (followed by / space or })  or cvtr+colon or html or code] followed by space+params then convertBack?
        rTag = "(?:(\\w+(?=[\\/\\s\\" + delimCloseChar0 + "]))|(\\w+)?(:)|(>)|(\\*))\\s*((?:[^\\"
            + delimCloseChar0 + "]|\\" + delimCloseChar0 + "(?!\\" + delimCloseChar1 + "))*?)";

        // make rTag available to JsViews (or other components) for parsing binding expressions
        $sub.rTag = "(?:" + rTag + ")";
        //                        { ^? {   tag+params slash?  or closingTag                                                   or comment
        rTag = new RegExp("(?:" + openChars + rTag + "(\\/)?|\\" + delimOpenChar0 + "(\\" + linkChar + ")?\\" + delimOpenChar1 + "(?:(?:\\/(\\w+))\\s*|!--[\\s\\S]*?--))" + closeChars, "g");

        // Default:  bind     tagName         cvt   cln html code    params            slash   bind2         closeBlk  comment
        //      /(?:{(\^)?{(?:(\w+(?=[\/\s}]))|(\w+)?(:)|(>)|(\*))\s*((?:[^}]|}(?!}))*?)(\/)?|{(\^)?{(?:(?:\/(\w+))\s*|!--[\s\S]*?--))}}

        rTmplString = new RegExp("<.*>|([^\\\\]|^)[{}]|" + openChars + ".*" + closeChars);
        // rTmplString looks for html tags or { or } char not preceded by \\, or JsRender tags {{xxx}}. Each of these strings are considered
        // NOT to be jQuery selectors
        return $viewsSettings;
    }

    //=========
    // View.get
    //=========

    function getView(inner, type) { //view.get(inner, type)
        if (!type && inner !== true) {
            // view.get(type)
            type = inner;
            inner = undefined;
        }

        var views, i, l, found,
            view = this,
            root = !type || type === "root";
        // If type is undefined, returns root view (view under top view).

        if (inner) {
            // Go through views - this one, and all nested ones, depth-first - and return first one with given type.
            // If type is undefined, i.e. view.get(true), return first child view.
            found = type && view.type === type && view;
            if (!found) {
                views = view.views;
                if (view._.useKey) {
                    for (i in views) {
                        if (found = type ? views[i].get(inner, type) : views[i]) {
                            break;
                        }
                    }
                } else {
                    for (i = 0, l = views.length; !found && i < l; i++) {
                        found = type ? views[i].get(inner, type) : views[i];
                    }
                }
            }
        } else if (root) {
            // Find root view. (view whose parent is top view)
            while (view.parent) {
                found = view;
                view = view.parent;
            }
        } else {
            while (view && !found) {
                // Go through views - this one, and all parent ones - and return first one with given type.
                found = view.type === type ? view : undefined;
                view = view.parent;
            }
        }
        return found;
    }

    function getNestedIndex() {
        var view = this.get("item");
        return view ? view.index : undefined;
    }

    getNestedIndex.depends = function () {
        return [this.get("item"), "index"];
    };

    function getIndex() {
        return this.index;
    }

    getIndex.depends = "index";

    //==========
    // View.hlp
    //==========

    function getHelper(helper) {
        // Helper method called as view.hlp(key) from compiled template, for helper functions or template parameters ~foo
        var wrapped,
            view = this,
            ctx = view.linkCtx,
            res = (view.ctx || {})[helper];

        if (res === undefined && ctx && ctx.ctx) {
            res = ctx.ctx[helper];
        }
        if (res === undefined) {
            res = $helpers[helper];
        }

        if (res) {
            if ($isFunction(res) && !res._wrp) {
                // If it is of type function, and not already wrapped, we will wrap it, so if called with no this pointer it will be called with the
                // view as 'this' context. If the helper ~foo() was in a data-link expression, the view will have a 'temporary' linkCtx property too.
                // Note that helper functions on deeper paths will have specific this pointers, from the preceding path.
                // For example, ~util.foo() will have the ~util object as 'this' pointer
                wrapped = function () {
                    return res.apply((!this || this === global) ? view : this, arguments);
                };
                wrapped._wrp = view;
                $extend(wrapped, res); // Attach same expandos (if any) to the wrapped function
            }
        }
        return wrapped || res;
    }

    function getTemplate(tmpl) {
        return tmpl && (tmpl.fn
            ? tmpl
            : this.getRsc("templates", tmpl) || $templates(tmpl)); // not yet compiled
    }

    //==============
    // views._cnvt
    //==============

    function convertVal(converter, view, tagCtx, onError) {
        // self is template object or linkCtx object
        var tag, value,
            // if tagCtx is an integer, then it is the key for the compiled function to return the boundTag tagCtx
            boundTag = typeof tagCtx === "number" && view.tmpl.bnds[tagCtx - 1],
            linkCtx = view.linkCtx; // For data-link="{cvt:...}"...

        if (onError !== undefined) {
            tagCtx = onError = { props: {}, args: [onError] };
        } else if (boundTag) {
            tagCtx = boundTag(view.data, view, $sub);
        }

        value = tagCtx.args[0];
        if (converter || boundTag) {
            tag = linkCtx && linkCtx.tag;
            if (!tag) {
                tag = $extend(new $sub._tg(), {
                    _: {
                        inline: !linkCtx,
                        bnd: boundTag,
                        unlinked: true
                    },
                    tagName: ":",
                    cvt: converter,
                    flow: true,
                    tagCtx: tagCtx
                });
                if (linkCtx) {
                    linkCtx.tag = tag;
                    tag.linkCtx = linkCtx;
                }
                tagCtx.ctx = extendCtx(tagCtx.ctx, (linkCtx ? linkCtx.view : view).ctx);
            }
            tag._er = onError && value;
            tagHandlersFromProps(tag, tagCtx);

            tagCtx.view = view;

            tag.ctx = tagCtx.ctx || {};
            tagCtx.ctx = undefined;

            value = tag.cvtArgs(tag.convert || converter !== "true" && converter)[0]; // If there is a convertBack but no convert, converter will be "true"

            // Call onRender (used by JsViews if present, to add binding annotations around rendered content)
            value = boundTag && view._.onRender
                ? view._.onRender(value, view, tag)
                : value;
        }
        return value != undefined ? value : "";
    }

    function convertArgs(converter) {
        var tag = this,
            tagCtx = tag.tagCtx,
            view = tagCtx.view,
            args = tagCtx.args;

        converter = tag.convert || converter;
        converter = converter && ("" + converter === converter
            ? (view.getRsc("converters", converter) || error("Unknown converter: '" + converter + "'"))
            : converter);

        args = !args.length && !tagCtx.index // On the opening tag with no args, bind to the current data context
            ? [view.data]
            : converter
                ? args.slice() // If there is a converter, use a copy of the tagCtx.args array for rendering, and replace the args[0] in
                // the copied array with the converted value. But we do not modify the value of tag.tagCtx.args[0] (the original args array)
                : args; // If no converter, get the original tagCtx.args

        if (converter) {
            if (converter.depends) {
                tag.depends = $sub.getDeps(tag.depends, tag, converter.depends, converter);
            }
            args[0] = converter.apply(tag, args);
        }
        return args;
    }

    //=============
    // views._tag
    //=============

    function getResource(resourceType, itemName) {
        var res, store,
            view = this;
        while ((res === undefined) && view) {
            store = view.tmpl && view.tmpl[resourceType];
            res = store && store[itemName];
            view = view.parent;
        }
        return res || $views[resourceType][itemName];
    }

    function renderTag(tagName, parentView, tmpl, tagCtxs, isUpdate, onError) {
        parentView = parentView || topView;
        var tag, tag_, tagDef, template, tags, attr, parentTag, i, l, itemRet, tagCtx, tagCtxCtx, content, callInit, mapDef, thisMap, args, props, initialTmpl, tagDataMap,
            ret = "",
            linkCtx = parentView.linkCtx || 0,
            ctx = parentView.ctx,
            parentTmpl = tmpl || parentView.tmpl,
            // if tagCtx is an integer, then it is the key for the compiled function to return the boundTag tagCtxs
            boundTag = typeof tagCtxs === "number" && parentView.tmpl.bnds[tagCtxs - 1];

        if (tagName._is === "tag") {
            tag = tagName;
            tagName = tag.tagName;
            tagCtxs = tag.tagCtxs;
            template = tag.template;
        } else {
            tagDef = parentView.getRsc("tags", tagName) || error("Unknown tag: {{" + tagName + "}} ");
            template = tagDef.template;
        }

        if (onError !== undefined) {
            ret += onError;
            tagCtxs = onError = [{ props: {}, args: [] }];
        } else if (boundTag) {
            tagCtxs = boundTag(parentView.data, parentView, $sub);
        }

        l = tagCtxs.length;
        for (i = 0; i < l; i++) {
            tagCtx = tagCtxs[i];
            if (!linkCtx || !linkCtx.tag || i && !linkCtx.tag._.inline || tag._er) {
                // Initialize tagCtx
                // For block tags, tagCtx.tmpl is an integer > 0
                if (content = parentTmpl.tmpls && tagCtx.tmpl) {
                    content = tagCtx.content = parentTmpl.tmpls[content - 1];
                }
                tagCtx.index = i;
                tagCtx.tmpl = content; // Set the tmpl property to the content of the block tag
                tagCtx.render = renderContent;
                tagCtx.view = parentView;
                tagCtx.ctx = extendCtx(tagCtx.ctx, ctx); // Clone and extend parentView.ctx
            }
            if (tmpl = tagCtx.props.tmpl) {
                // If the tmpl property is overridden, set the value (when initializing, or, in case of binding: ^tmpl=..., when updating)
                tagCtx.tmpl = parentView.getTmpl(tmpl);
            }

            if (!tag) {
                // This will only be hit for initial tagCtx (not for {{else}}) - if the tag instance does not exist yet
                // Instantiate tag if it does not yet exist
                // If the tag has not already been instantiated, we will create a new instance.
                // ~tag will access the tag, even within the rendering of the template content of this tag.
                // From child/descendant tags, can access using ~tag.parent, or ~parentTags.tagName
                tag = new tagDef._ctr();
                callInit = !!tag.init;

                tag.parent = parentTag = ctx && ctx.tag;
                tag.tagCtxs = tagCtxs;
                tagDataMap = tag.dataMap;

                if (linkCtx) {
                    tag._.inline = false;
                    linkCtx.tag = tag;
                    tag.linkCtx = linkCtx;
                }
                if (tag._.bnd = boundTag || linkCtx.fn) {
                    // Bound if {^{tag...}} or data-link="{tag...}"
                    tag._.arrVws = {};
                } else if (tag.dataBoundOnly) {
                    error("{^{" + tagName + "}} tag must be data-bound");
                }
                //TODO better perf for childTags() - keep child tag.tags array, (and remove child, when disposed)
                // tag.tags = [];
            }
            tagCtxs = tag.tagCtxs;
            tagDataMap = tag.dataMap;

            tagCtx.tag = tag;
            if (tagDataMap && tagCtxs) {
                tagCtx.map = tagCtxs[i].map; // Copy over the compiled map instance from the previous tagCtxs to the refreshed ones
            }
            if (!tag.flow) {
                tagCtxCtx = tagCtx.ctx = tagCtx.ctx || {};

                // tags hash: tag.ctx.tags, merged with parentView.ctx.tags,
                tags = tag.parents = tagCtxCtx.parentTags = ctx && extendCtx(tagCtxCtx.parentTags, ctx.parentTags) || {};
                if (parentTag) {
                    tags[parentTag.tagName] = parentTag;
                    //TODO better perf for childTags: parentTag.tags.push(tag);
                }
                tags[tag.tagName] = tagCtxCtx.tag = tag;
            }
        }
        if (!(tag._er = onError)) {
            tagHandlersFromProps(tag, tagCtxs[0]);
            tag.rendering = {}; // Provide object for state during render calls to tag and elses. (Used by {{if}} and {{for}}...)
            for (i = 0; i < l; i++) {
                tagCtx = tag.tagCtx = tagCtxs[i];
                props = tagCtx.props;
                args = tag.cvtArgs();

                if (mapDef = props.dataMap || tagDataMap) {
                    if (args.length || props.dataMap) {
                        thisMap = tagCtx.map;
                        if (!thisMap || thisMap.src !== args[0] || isUpdate) {
                            if (thisMap && thisMap.src) {
                                thisMap.unmap(); // only called if observable map - not when only used in JsRender, e.g. by {{props}}
                            }
                            thisMap = tagCtx.map = mapDef.map(args[0], props, undefined, !tag._.bnd);
                        }
                        args = [thisMap.tgt];
                    }
                }
                tag.ctx = tagCtx.ctx;

                if (!i) {
                    if (callInit) {
                        initialTmpl = tag.template;
                        tag.init(tagCtx, linkCtx, tag.ctx);
                        callInit = undefined;
                    }
                    if (linkCtx) {
                        // Set attr on linkCtx to ensure outputting to the correct target attribute.
                        // Setting either linkCtx.attr or this.attr in the init() allows per-instance choice of target attrib.
                        linkCtx.attr = tag.attr = linkCtx.attr || tag.attr;
                    }
                    attr = tag.attr;
                    tag._.noVws = attr && attr !== HTML;
                }

                itemRet = undefined;
                if (tag.render) {
                    itemRet = tag.render.apply(tag, args);
                }
                if (!args.length) {
                    args = [parentView]; // no arguments - (e.g. {{else}}) get data context from view.
                }
                if (itemRet === undefined) {
                    itemRet = tagCtx.render(args[0], true) || (isUpdate ? undefined : "");
                }
                // No return value from render, and no template/content tagCtx.render(...), so return undefined
                ret = ret ? ret + (itemRet || "") : itemRet; // If no rendered content, this will be undefined
            }
            tag.rendering = undefined;
        }
        tag.tagCtx = tagCtxs[0];
        tag.ctx = tag.tagCtx.ctx;

        if (tag._.noVws) {
            if (tag._.inline) {
                // inline tag with attr set to "text" will insert HTML-encoded content - as if it was element-based innerText
                ret = attr === "text"
                    ? $converters.html(ret)
                    : "";
            }
        }
        return boundTag && parentView._.onRender
            // Call onRender (used by JsViews if present, to add binding annotations around rendered content)
            ? parentView._.onRender(ret, parentView, tag)
            : ret;
    }

    //=================
    // View constructor
    //=================

    function View(context, type, parentView, data, template, key, onRender, contentTmpl) {
        // Constructor for view object in view hierarchy. (Augmented by JsViews if JsViews is loaded)
        var views, parentView_, tag, self_,
            self = this,
            isArray = type === "array";

        self.content = contentTmpl;
        self.views = isArray ? [] : {};
        self.parent = parentView;
        self.type = type || "top";
        self.data = data;
        self.tmpl = template;
        // If the data is an array, this is an 'array view' with a views array for each child 'item view'
        // If the data is not an array, this is an 'item view' with a views 'hash' object for any child nested views
        // ._.useKey is non zero if is not an 'array view' (owning a data array). Use this as next key for adding to child views hash
        self_ = self._ = {
            key: 0,
            useKey: isArray ? 0 : 1,
            id: "" + viewId++,
            onRender: onRender,
            bnds: {}
        };
        self.linked = !!onRender;
        if (parentView) {
            views = parentView.views;
            parentView_ = parentView._;
            if (parentView_.useKey) {
                // Parent is not an 'array view'. Add this view to its views object
                // self._key = is the key in the parent view hash
                views[self_.key = "_" + parentView_.useKey++] = self;
                self.index = indexStr;
                self.getIndex = getNestedIndex;
            } else if (views.length === (self_.key = self.index = key)) { // Parent is an 'array view'. Add this view to its views array
                views.push(self); // Adding to end of views array. (Using push when possible - better perf than splice)
            } else {
                views.splice(key, 0, self); // Inserting in views array
            }
            // If no context was passed in, use parent context
            // If context was passed in, it should have been merged already with parent context
            self.ctx = context || parentView.ctx;
        } else {
            self.ctx = context;
        }
    }

    View.prototype = {
        get: getView,
        getIndex: getIndex,
        getRsc: getResource,
        getTmpl: getTemplate,
        hlp: getHelper,
        _is: "view"
    };

    //====================================================
    // Registration
    //====================================================

    function compileChildResources(parentTmpl) {
        var storeName, resources, resourceName, resource, settings, compile, onStore;
        for (storeName in jsvStores) {
            settings = jsvStores[storeName];
            if ((compile = settings.compile) && (resources = parentTmpl[storeName + "s"])) {
                for (resourceName in resources) {
                    // compile child resource declarations (templates, tags, tags["for"] or helpers)
                    resource = resources[resourceName] = compile(resourceName, resources[resourceName], parentTmpl, 0);
                    resource._is = storeName; // Only do this for compiled objects (tags, templates...)
                    if (resource && (onStore = $sub.onStore[storeName])) {
                        // e.g. JsViews integration
                        onStore(resourceName, resource, compile);
                    }
                }
            }
        }
    }

    //===============
    // compileTag
    //===============

    function compileTag(name, tagDef, parentTmpl) {
        var tmpl, baseTag, prop,
            compiledDef = new $sub._tg();

        function Tag() {
            var tag = this;
            tag._ = {
                inline: true,
                unlinked: true
            };

            tag.tagName = name;
        }

        if ($isFunction(tagDef)) {
            // Simple tag declared as function. No presenter instantation.
            tagDef = {
                depends: tagDef.depends,
                render: tagDef
            };
        } else if ("" + tagDef === tagDef) {
            tagDef = { template: tagDef };
        }
        if (baseTag = tagDef.baseTag) {
            tagDef.flow = !!tagDef.flow; // Set flow property, so defaults to false even if baseTag has flow=true
            tagDef.baseTag = baseTag = "" + baseTag === baseTag
                ? (parentTmpl && parentTmpl.tags[baseTag] || $tags[baseTag])
                : baseTag;

            compiledDef = $extend(compiledDef, baseTag);

            for (prop in tagDef) {
                compiledDef[prop] = getMethod(baseTag[prop], tagDef[prop]);
            }
        } else {
            compiledDef = $extend(compiledDef, tagDef);
        }

        // Tag declared as object, used as the prototype for tag instantiation (control/presenter)
        if ((tmpl = compiledDef.template) !== undefined) {
            compiledDef.template = "" + tmpl === tmpl ? ($templates[tmpl] || $templates(tmpl)) : tmpl;
        }
        if (compiledDef.init !== false) {
            // Set init: false on tagDef if you want to provide just a render method, or render and template, but no constructor or prototype.
            // so equivalent to setting tag to render function, except you can also provide a template.
            (Tag.prototype = compiledDef).constructor = compiledDef._ctr = Tag;
        }

        if (parentTmpl) {
            compiledDef._parentTmpl = parentTmpl;
        }
        return compiledDef;
    }

    function baseApply(args) {
        // In derived method (or handler declared declaratively as in {{:foo onChange=~fooChanged}} can call base method,
        // using this.baseApply(arguments) (Equivalent to this._superApply(arguments) in jQuery UI)
        return this.base.apply(this, args);
    }

    //===============
    // compileTmpl
    //===============

    function compileTmpl(name, tmpl, parentTmpl, options) {
        // tmpl is either a template object, a selector for a template script block, the name of a compiled template, or a template object

        //==== nested functions ====
        function lookupTemplate(value) {
            // If value is of type string - treat as selector, or name of compiled template
            // Return the template object, if already compiled, or the markup string
            var currentName, tmpl;
            if (("" + value === value) || value.nodeType > 0 && (elem = value)) {
                if (!elem) {
                    if (/^\.\/[^\\:*?"<>]*$/.test(value)) {
                        // tmpl="./some/file.html"
                        // If the template is not named, use "./some/file.html" as name.
                        if (tmpl = $templates[name = name || value]) {
                            value = tmpl;
                        } else {
                            // BROWSER-SPECIFIC CODE (not on Node.js):
                            // Look for server-generated script block with id "./some/file.html"
                            elem = document.getElementById(value);
                        }
                    } else if ($.fn && !rTmplString.test(value)) {
                        try {
                            elem = $(document).find(value)[0]; // if jQuery is loaded, test for selector returning elements, and get first element
                        } catch (e) { }
                    }// END BROWSER-SPECIFIC CODE
                } //BROWSER-SPECIFIC CODE
                if (elem) {
                    // Generally this is a script element.
                    // However we allow it to be any element, so you can for example take the content of a div,
                    // use it as a template, and replace it by the same content rendered against data.
                    // e.g. for linking the content of a div to a container, and using the initial content as template:
                    // $.link("#content", model, {tmpl: "#content"});
                    if (options) {
                        // We will compile a new template using the markup in the script element
                        value = elem.innerHTML;
                    } else {
                        // We will cache a single copy of the compiled template, and associate it with the name
                        // (renaming from a previous name if there was one).
                        currentName = elem.getAttribute(tmplAttr);
                        if (currentName) {
                            if (currentName !== jsvTmpl) {
                                value = $templates[currentName];
                                delete $templates[currentName];
                            } else if ($.fn) {
                                value = $.data(elem)[jsvTmpl];
                            }
                        } else {
                            name = name || ($.fn ? jsvTmpl : value);
                            value = compileTmpl(name, elem.innerHTML, parentTmpl, options);
                        }
                        value.tmplName = name = name || currentName;
                        if (name !== jsvTmpl) {
                            $templates[name] = value;
                        }
                        elem.setAttribute(tmplAttr, name);
                        if ($.fn) {
                            $.data(elem, jsvTmpl, value);
                        }
                    }
                } // END BROWSER-SPECIFIC CODE
                elem = undefined;
            } else if (!value.fn) {
                value = undefined;
                // If value is not a string. HTML element, or compiled template, return undefined
            }
            return value;
        }

        var elem, compiledTmpl,
            tmplOrMarkup = tmpl = tmpl || "";

        //==== Compile the template ====
        if (options === 0) {
            options = undefined;
            tmplOrMarkup = lookupTemplate(tmplOrMarkup); // Top-level compile so do a template lookup
        }

        // If options, then this was already compiled from a (script) element template declaration.
        // If not, then if tmpl is a template object, use it for options
        options = options || (tmpl.markup ? tmpl : {});
        options.tmplName = name;
        if (parentTmpl) {
            options._parentTmpl = parentTmpl;
        }
        // If tmpl is not a markup string or a selector string, then it must be a template object
        // In that case, get it from the markup property of the object
        if (!tmplOrMarkup && tmpl.markup && (tmplOrMarkup = lookupTemplate(tmpl.markup))) {
            if (tmplOrMarkup.fn) {
                // If the string references a compiled template object, need to recompile to merge any modified options
                tmplOrMarkup = tmplOrMarkup.markup;
            }
        }
        if (tmplOrMarkup !== undefined) {
            if (tmplOrMarkup.fn || tmpl.fn) {
                // tmpl is already compiled, so use it
                if (tmplOrMarkup.fn) {
                    compiledTmpl = tmplOrMarkup;
                }
            } else {
                // tmplOrMarkup is a markup string, not a compiled template
                // Create template object
                tmpl = tmplObject(tmplOrMarkup, options);
                // Compile to AST and then to compiled function
                tmplFn(tmplOrMarkup.replace(rEscapeQuotes, "\\$&"), tmpl);
            }
            if (!compiledTmpl) {
                compileChildResources(options);

                compiledTmpl = $extend(function () {
                    return tmpl.render.apply(tmpl, arguments);
                }, tmpl);
            }
            if (name && !parentTmpl && name !== jsvTmpl) {
                $render[name] = compiledTmpl;
            }
            return compiledTmpl;
        }
    }

    //==== /end of function compileTmpl ====

    //=================
    // compileViewModel
    //=================

    function getDefaultVal(defaultVal, data) {
        return $.isFunction(defaultVal)
            ? defaultVal.call(data)
            : defaultVal;
    }

    function unmapArray(modelArr) {
        var i, arr = [],
			l = modelArr.length;
        for (i = 0; i < l; i++) {
            arr.push(modelArr[i].unmap());
        }
        return arr;
    }

    function compileViewModel(name, type) {
        var i, constructor,
            viewModels = this,
            getters = type.getters,
            extend = type.extend,
            id = type.id,
            proto = $.extend({
                _is: name || "unnamed",
                unmap: unmap,
                merge: merge
            }, extend),
            args = "",
            body = "",
            l = getters ? getters.length : 0,
            $observable = $.observable,
            getterNames = {};

        function GetNew(args) {
            constructor.apply(this, args);
        }

        function vm() {
            return new GetNew(arguments);
        }

        function iterate(data, action) {
            var j, getterType, defaultVal, prop, ob,
                m = getters.length;
            for (j = 0; j < m; j++) {
                prop = getters[j];
                getterType = undefined;
                if (prop + "" !== prop) {
                    getterType = prop;
                    prop = getterType.getter;
                }
                if ((ob = data[prop]) === undefined && getterType && (defaultVal = getterType.defaultVal) !== undefined) {
                    ob = getDefaultVal(defaultVal, data);
                }
                action(ob, getterType && viewModels[getterType.type], prop);
            }
        }

        function map(data) {
            data = data + "" === data
                ? JSON.parse(data) // Accept JSON string
                : data;            // or object/array
            var i, j, l, m, prop,
                ob = data,
                arr = [];

            if ($.isArray(data)) {
                data = data || [];
                l = data.length;
                for (i = 0; i < l; i++) {
                    arr.push(this.map(data[i]));
                }
                arr._is = name;
                arr.unmap = unmap;
                arr.merge = merge;
                return arr;
            }

            if (data) {
                iterate(data, function (ob, viewModel) {
                    if (viewModel) { // Iterate to build getters arg array (value, or mapped value)
                        ob = viewModel.map(ob);
                    }
                    arr.push(ob);
                });

                ob = this.apply(this, arr); // Insantiate this View Model, passing getters args array to constructor
                for (prop in data) { // Copy over any other properties. that are not get/set properties
                    if (!getterNames[prop]) {
                        ob[prop] = data[prop];
                    }
                }
            }
            return ob;
        }

        function merge(data) {
            data = data + "" === data
                ? JSON.parse(data) // Accept JSON string
                : data;            // or object/array
            var i, j, l, m, prop, mod, found, assigned, ob, newModArr,
                model = this;

            if ($.isArray(model)) {
                assigned = {};
                newModArr = [];
                l = data.length;
                m = model.length;
                for (i = 0; i < l; i++) {
                    ob = data[i];
                    found = false;
                    for (j = 0; j < m && !found; j++) {
                        if (assigned[j]) {
                            continue;
                        }
                        mod = model[j];

                        if (id) {
                            assigned[j] = found = id + "" === id
                            ? (ob[id] && (getterNames[id] ? mod[id]() : mod[id]) === ob[id])
                            : id(mod, ob);
                        }
                    }
                    if (found) {
                        mod.merge(ob);
                        newModArr.push(mod);
                    } else {
                        newModArr.push(vm.map(ob));
                    }
                }
                if ($observable) {
                    $observable(model).refresh(newModArr);
                } else {
                    model.splice.apply(model, [0, model.length].concat(newModArr));
                }
                return;
            }
            iterate(data, function (ob, viewModel, getter) {
                if (viewModel) {
                    model[getter]().merge(ob); // Update typed property
                } else {
                    model[getter](ob); // Update non-typed property
                }
            });
            for (prop in data) {
                if (!getterNames[prop]) {
                    model[prop] = data[prop];
                }
            }
        }

        function unmap() {
            var ob, prop, i, l, getterType, arr, value,
                model = this;

            if ($.isArray(model)) {
                return unmapArray(model);
            }
            ob = {};
            l = getters.length;
            for (i = 0; i < l; i++) {
                prop = getters[i];
                getterType = undefined;
                if (prop + "" !== prop) {
                    getterType = prop;
                    prop = getterType.getter;
                }
                value = model[prop]();
                ob[prop] = getterType && value && viewModels[getterType.type]
                    ? $.isArray(value)
                        ? unmapArray(value)
                        : value.unmap()
                    : value;
            }
            for (prop in model) {
                if (prop !== "_is" && !getterNames[prop] && (prop.charAt(0) !== "_" || !getterNames[prop.slice(1)]) && !$.isFunction(model[prop])) {
                    ob[prop] = model[prop];
                }
            }
            return ob;
        }

        GetNew.prototype = proto;

        for (i = 0; i < l; i++) {
            (function (getter) {
                getter = getter.getter || getter;
                getterNames[getter] = i + 1;
                var privField = "_" + getter;

                args += (args ? "," : "") + getter;
                body += "this." + privField + " = " + getter + ";\n";
                proto[getter] = proto[getter] || function (val) {
                    if (!arguments.length) {
                        return this[privField]; // If there is no argument, use as a getter
                    }
                    if ($observable) {
                        $observable(this).setProperty(getter, val);
                    } else {
                        this[privField] = val;
                    }
                };

                if ($observable) {
                    proto[getter].set = proto[getter].set || function (val) {
                        this[privField] = val; // Setter called by observable property change
                    };
                }
            })(getters[i]);
        }

        constructor = new Function(args, body.slice(0, -1));
        constructor.prototype = proto;
        proto.constructor = constructor;

        vm.map = map;
        vm.getters = getters;
        vm.extend = extend;
        vm.id = id;
        return vm;
    }

    function tmplObject(markup, options) {
        // Template object constructor
        var htmlTag,
            wrapMap = $subSettingsAdvanced._wm || {}, // Only used in JsViews. Otherwise empty: {}
            tmpl = $extend(
                {
                    tmpls: [],
                    links: {}, // Compiled functions for link expressions
                    bnds: [],
                    _is: "template",
                    render: renderContent
                },
                options
            );

        tmpl.markup = markup;
        if (!options.htmlTag) {
            // Set tmpl.tag to the top-level HTML tag used in the template, if any...
            htmlTag = rFirstElem.exec(markup);
            tmpl.htmlTag = htmlTag ? htmlTag[1].toLowerCase() : "";
        }
        htmlTag = wrapMap[tmpl.htmlTag];
        if (htmlTag && htmlTag !== wrapMap.div) {
            // When using JsViews, we trim templates which are inserted into HTML contexts where text nodes are not rendered (i.e. not 'Phrasing Content').
            // Currently not trimmed for <li> tag. (Not worth adding perf cost)
            tmpl.markup = $.trim(tmpl.markup);
        }

        return tmpl;
    }

    //==============
    // registerStore
    //==============

    function registerStore(storeName, storeSettings) {

        function theStore(name, item, parentTmpl) {
            // The store is also the function used to add items to the store. e.g. $.templates, or $.views.tags

            // For store of name 'thing', Call as:
            //    $.views.things(items[, parentTmpl]),
            // or $.views.things(name, item[, parentTmpl])

            var onStore, compile, itemName, thisStore;
            if (name && typeof name === OBJECT && !name.nodeType && !name.markup && !name.getTgt && !(storeName === "viewModel" && name.getters || name.extend)) {
                // Call to $.views.things(items[, parentTmpl]),

                // Adding items to the store
                // If name is a hash, then item is parentTmpl. Iterate over hash and call store for key.
                for (itemName in name) {
                    theStore(itemName, name[itemName], item);
                }
                return item || $views;
            }
            // Adding a single unnamed item to the store
            if (item === undefined) {
                item = name;
                name = undefined;
            }
            if (name && "" + name !== name) { // name must be a string
                parentTmpl = item;
                item = name;
                name = undefined;
            }
            thisStore = parentTmpl
                ? storeName === "viewModel"
                    ? parentTmpl
                    : (parentTmpl[storeNames] = parentTmpl[storeNames] || {})
                : theStore;
            compile = storeSettings.compile;
            if (item === null) {
                // If item is null, delete this entry
                if (name) {
                    delete thisStore[name];
                }
            } else {
                item = compile ? compile.call(thisStore, name, item, parentTmpl, 0) : item;
                if (name) {
                    thisStore[name] = item;
                }
            }
            if (compile && item) {
                item._is = storeName; // Only do this for compiled objects (tags, templates...)
            }
            if (item && (onStore = $sub.onStore[storeName])) {
                // e.g. JsViews integration
                onStore(name, item, compile);
            }
            return item;
        }

        var storeNames = storeName + "s";

        $views[storeNames] = theStore;
    }

    function addSetting(st) {
        $viewsSettings[st] = function (value) {
            return arguments.length
                ? ($subSettings[st] = value, $viewsSettings)
                : $subSettings[st];
        };
    }

    //=========
    // dataMap
    //=========

    function dataMap(mapDef) {
        function Map(source, options) {
            this.tgt = mapDef.getTgt(source, options);
        }

        if ($isFunction(mapDef)) {
            // Simple map declared as function
            mapDef = {
                getTgt: mapDef
            };
        }

        if (mapDef.baseMap) {
            mapDef = $extend($extend({}, mapDef.baseMap), mapDef);
        }

        mapDef.map = function (source, options) {
            return new Map(source, options);
        };
        return mapDef;
    }

    //==============
    // renderContent
    //==============

    function renderContent(data, context, noIteration, parentView, key, onRender) {
        var i, l, tag, tmpl, tagCtx, isTopRenderCall, prevData, prevIndex,
            view = parentView,
            result = "";

        if (context === true) {
            noIteration = context; // passing boolean as second param - noIteration
            context = undefined;
        } else if (typeof context !== OBJECT) {
            context = undefined; // context must be a boolean (noIteration) or a plain object
        }

        if (tag = this.tag) {
            // This is a call from renderTag or tagCtx.render(...)
            tagCtx = this;
            view = view || tagCtx.view;
            tmpl = view.getTmpl(tag.template || tagCtx.tmpl);
            if (!arguments.length) {
                data = view;
            }
        } else {
            // This is a template.render(...) call
            tmpl = this;
        }

        if (tmpl) {
            if (!view && data && data._is === "view") {
                view = data; // When passing in a view to render or link (and not passing in a parent view) use the passed-in view as parentView
            }

            if (view) {
                if (data === view) {
                    // Inherit the data from the parent view.
                    // This may be the contents of an {{if}} block
                    data = view.data;
                }
            }

            isTopRenderCall = !view;
            isRenderCall = isRenderCall || isTopRenderCall;
            if (!view) {
                (context = context || {}).root = data; // Provide ~root as shortcut to top-level data.
            }
            if (!isRenderCall || $subSettingsAdvanced.useViews || tmpl.useViews || view && view !== topView) {
                result = renderWithViews(tmpl, data, context, noIteration, view, key, onRender, tag);
            } else {
                if (view) { // In a block
                    prevData = view.data;
                    prevIndex = view.index;
                    view.index = indexStr;
                } else {
                    view = topView;
                    view.data = data;
                    view.ctx = context;
                }
                if ($isArray(data) && !noIteration) {
                    // Create a view for the array, whose child views correspond to each data item. (Note: if key and parentView are passed in
                    // along with parent view, treat as insert -e.g. from view.addViews - so parentView is already the view item for array)
                    for (i = 0, l = data.length; i < l; i++) {
                        view.index = i;
                        view.data = data[i];
                        result += tmpl.fn(data[i], view, $sub);
                    }
                } else {
                    view.data = data;
                    result += tmpl.fn(data, view, $sub);
                }
                view.data = prevData;
                view.index = prevIndex;
            }
            if (isTopRenderCall) {
                isRenderCall = undefined;
            }
        }
        return result;
    }

    function renderWithViews(tmpl, data, context, noIteration, view, key, onRender, tag) {
        function setItemVar(item) {
            // When itemVar is specified, set modified ctx with user-named ~item
            newCtx = $extend({}, context);
            newCtx[itemVar] = item;
        }

        // Render template against data as a tree of subviews (nested rendered template instances), or as a string (top-level template).
        // If the data is the parent view, treat as noIteration, re-render with the same data context.
        var i, l, newView, childView, itemResult, swapContent, contentTmpl, outerOnRender, tmplName, itemVar, newCtx, tagCtx,
            result = "";

        if (tag) {
            // This is a call from renderTag or tagCtx.render(...)
            tmplName = tag.tagName;
            tagCtx = tag.tagCtx;
            context = context ? extendCtx(context, tag.ctx) : tag.ctx;

            if (tmpl === view.content) { // {{xxx tmpl=#content}}
                contentTmpl = tmpl !== view.ctx._wrp // We are rendering the #content
                    ? view.ctx._wrp // #content was the tagCtx.props.tmpl wrapper of the block content - so within this view, #content will now be the view.ctx._wrp block content
                    : undefined; // #content was the view.ctx._wrp block content - so within this view, there is no longer any #content to wrap.
            } else if (tmpl !== tagCtx.content) {
                if (tmpl === tag.template) { // Rendering {{tag}} tag.template, replacing block content.
                    contentTmpl = tagCtx.tmpl; // Set #content to block content (or wrapped block content if tagCtx.props.tmpl is set)
                    context._wrp = tagCtx.content; // Pass wrapped block content to nested views
                } else { // Rendering tagCtx.props.tmpl wrapper
                    contentTmpl = tagCtx.content || view.content; // Set #content to wrapped block content
                }
            } else {
                contentTmpl = view.content; // Nested views inherit same wrapped #content property
            }

            if (tagCtx.props.link === false) {
                // link=false setting on block tag
                // We will override inherited value of link by the explicit setting link=false taken from props
                // The child views of an unlinked view are also unlinked. So setting child back to true will not have any effect.
                context = context || {};
                context.link = false;
            }

            if (itemVar = tagCtx.props.itemVar) {
                if (itemVar.charAt(0) !== "~") {
                    syntaxError("Use itemVar='~myItem'");
                }
                itemVar = itemVar.slice(1);
            }
        }

        if (view) {
            onRender = onRender || view._.onRender;
            context = extendCtx(context, view.ctx);
        }

        if (key === true) {
            swapContent = true;
            key = 0;
        }

        // If link===false, do not call onRender, so no data-linking marker nodes
        if (onRender && (context && context.link === false || tag && tag._.noVws)) {
            onRender = undefined;
        }
        outerOnRender = onRender;
        if (onRender === true) {
            // Used by view.refresh(). Don't create a new wrapper view.
            outerOnRender = undefined;
            onRender = view._.onRender;
        }
        // Set additional context on views created here, (as modified context inherited from the parent, and to be inherited by child views)
        context = tmpl.helpers
            ? extendCtx(tmpl.helpers, context)
            : context;

        newCtx = context;
        if ($isArray(data) && !noIteration) {
            // Create a view for the array, whose child views correspond to each data item. (Note: if key and view are passed in
            // along with parent view, treat as insert -e.g. from view.addViews - so view is already the view item for array)
            newView = swapContent
                ? view
                : (key !== undefined && view)
                    || new View(context, "array", view, data, tmpl, key, onRender);
            if (view && view._.useKey) {
                // Parent is not an 'array view'
                newView._.bnd = !tag || tag._.bnd && tag; // For array views that are data bound for collection change events, set the
                // view._.bnd property to true for top-level link() or data-link="{for}", or to the tag instance for a data-bound tag, e.g. {^{for ...}}
            }
            if (itemVar) {
                newView.it = itemVar;
            }
            itemVar = newView.it;
            for (i = 0, l = data.length; i < l; i++) {
                // Create a view for each data item.
                if (itemVar) {
                    setItemVar(data[i]); // use modified ctx with user-named ~item
                }
                childView = new View(newCtx, "item", newView, data[i], tmpl, (key || 0) + i, onRender, contentTmpl);

                itemResult = tmpl.fn(data[i], childView, $sub);
                result += newView._.onRender ? newView._.onRender(itemResult, childView) : itemResult;
            }
        } else {
            // Create a view for singleton data object. The type of the view will be the tag name, e.g. "if" or "myTag" except for
            // "item", "array" and "data" views. A "data" view is from programmatic render(object) against a 'singleton'.
            if (itemVar) {
                setItemVar(data);
            }
            newView = swapContent ? view : new View(newCtx, tmplName || "data", view, data, tmpl, key, onRender, contentTmpl);
            if (tag && !tag.flow) {
                newView.tag = tag;
            }
            result += tmpl.fn(data, newView, $sub);
        }
        return outerOnRender ? outerOnRender(result, newView) : result;
    }

    //===========================
    // Build and compile template
    //===========================

    // Generate a reusable function that will serve to render a template against data
    // (Compile AST then build template function)

    function onRenderError(e, view, fallback) {
        var message = fallback !== undefined
            ? $isFunction(fallback)
                ? fallback.call(view.data, e, view)
                : fallback || ""
            : "{Error: " + e.message + "}";

        if ($subSettings.onError && (fallback = $subSettings.onError.call(view.data, e, fallback && message, view)) !== undefined) {
            message = fallback; // There is a settings.debugMode(handler) onError override. Call it, and use return value (if any) to replace message
        }

        return view && !view.linkCtx ? $converters.html(message) : message;
    }

    function error(message) {
        throw new $sub.Err(message);
    }

    function syntaxError(message) {
        error("Syntax error\n" + message);
    }

    function tmplFn(markup, tmpl, isLinkExpr, convertBack, hasElse) {
        // Compile markup to AST (abtract syntax tree) then build the template function code from the AST nodes
        // Used for compiling templates, and also by JsViews to build functions for data link expressions

        //==== nested functions ====
        function pushprecedingContent(shift) {
            shift -= loc;
            if (shift) {
                content.push(markup.substr(loc, shift).replace(rNewLine, "\\n"));
            }
        }

        function blockTagCheck(tagName, block) {
            if (tagName) {
                tagName += '}}';
                //			'{{include}} block has {{/for}} with no open {{for}}'
                syntaxError((
                    block
                        ? '{{' + block + '}} block has {{/' + tagName + ' without {{' + tagName
                        : 'Unmatched or missing {{/' + tagName) + ', in template:\n' + markup);
            }
        }

        function parseTag(all, bind, tagName, converter, colon, html, codeTag, params, slash, bind2, closeBlock, index) {
            /*
            
                 bind     tagName         cvt   cln html code    params            slash   bind2         closeBlk  comment
            /(?:{(\^)?{(?:(\w+(?=[\/\s}]))|(\w+)?(:)|(>)|(\*))\s*((?:[^}]|}(?!}))*?)(\/)?|{(\^)?{(?:(?:\/(\w+))\s*|!--[\s\S]*?--))}}/g
            
            (?:
              {(\^)?{            bind
              (?:
                (\w+             tagName
                  (?=[\/\s}])
                )
                |
                (\w+)?(:)        converter colon
                |
                (>)              html
                |
                (\*)             codeTag
              )
              \s*
              (                  params
                (?:[^}]|}(?!}))*?
              )
              (\/)?              slash
              |
              {(\^)?{            bind2
              (?:
                (?:\/(\w+))\s*   closeBlock
                |
                !--[\s\S]*?--    comment
              )
            )
            }}/g
            
            */
            if (codeTag && bind || slash && !tagName || params && params.slice(-1) === ":" || bind2) {
                syntaxError(all);
            }

            // Build abstract syntax tree (AST): [tagName, converter, params, content, hash, bindings, contentMarkup]
            if (html) {
                colon = ":";
                converter = HTML;
            }
            slash = slash || isLinkExpr && !hasElse;

            var pathBindings = (bind || isLinkExpr) && [[]],
                props = "",
                args = "",
                ctxProps = "",
                paramsArgs = "",
                paramsProps = "",
                paramsCtxProps = "",
                onError = "",
                useTrigger = "",
                // Block tag if not self-closing and not {{:}} or {{>}} (special case) and not a data-link expression
                block = !slash && !colon;

            //==== nested helper function ====
            tagName = tagName || (params = params || "#data", colon); // {{:}} is equivalent to {{:#data}}
            pushprecedingContent(index);
            loc = index + all.length; // location marker - parsed up to here
            if (codeTag) {
                if (allowCode) {
                    content.push(["*", "\n" + params.replace(/^:/, "ret+= ").replace(rUnescapeQuotes, "$1") + ";\n"]);
                }
            } else if (tagName) {
                if (tagName === "else") {
                    if (rTestElseIf.test(params)) {
                        syntaxError('for "{{else if expr}}" use "{{else expr}}"');
                    }
                    pathBindings = current[7] && [[]];
                    current[8] = markup.substring(current[8], index); // contentMarkup for block tag
                    current = stack.pop();
                    content = current[2];
                    block = true;
                }
                if (params) {
                    // remove newlines from the params string, to avoid compiled code errors for unterminated strings
                    parseParams(params.replace(rNewLine, " "), pathBindings, tmpl)
                        .replace(rBuildHash, function (all, onerror, isCtx, key, keyToken, keyValue, arg, param) {
                            key = "'" + keyToken + "':";
                            if (arg) {
                                args += keyValue + ",";
                                paramsArgs += "'" + param + "',";
                            } else if (isCtx) {
                                ctxProps += key + keyValue + ",";
                                paramsCtxProps += key + "'" + param + "',";
                            } else if (onerror) {
                                onError += keyValue;
                            } else {
                                if (keyToken === "trigger") {
                                    useTrigger += keyValue;
                                }
                                props += key + keyValue + ",";
                                paramsProps += key + "'" + param + "',";
                                hasHandlers = hasHandlers || rHasHandlers.test(keyToken);
                            }
                            return "";
                        }).slice(0, -1);
                }

                if (pathBindings && pathBindings[0]) {
                    pathBindings.pop(); // Remove the bindings that was prepared for next arg. (There is always an extra one ready).
                }

                newNode = [
                        tagName,
                        converter || !!convertBack || hasHandlers || "",
                        block && [],
                        parsedParam(paramsArgs || (tagName === ":" ? "'#data'," : ""), paramsProps, paramsCtxProps), // {{:}} equivalent to {{:#data}}
                        parsedParam(args || (tagName === ":" ? "data," : ""), props, ctxProps),
                        onError,
                        useTrigger,
                        pathBindings || 0
                ];
                content.push(newNode);
                if (block) {
                    stack.push(current);
                    current = newNode;
                    current[8] = loc; // Store current location of open tag, to be able to add contentMarkup when we reach closing tag
                }
            } else if (closeBlock) {
                blockTagCheck(closeBlock !== current[0] && current[0] !== "else" && closeBlock, current[0]);
                current[8] = markup.substring(current[8], index); // contentMarkup for block tag
                current = stack.pop();
            }
            blockTagCheck(!current && closeBlock);
            content = current[2];
        }
        //==== /end of nested functions ====

        var result, newNode, hasHandlers,
            allowCode = $subSettings.allowCode || tmpl && tmpl.allowCode
                || $viewsSettings.allowCode === true, // include direct setting of settings.allowCode true for backward compat only
            astTop = [],
            loc = 0,
            stack = [],
            content = astTop,
            current = [, , astTop];

        if (allowCode) {
            tmpl.allowCode = allowCode;
        }

        //TODO	result = tmplFnsCache[markup]; // Only cache if template is not named and markup length < ...,
        //and there are no bindings or subtemplates?? Consider standard optimization for data-link="a.b.c"
        //		if (result) {
        //			tmpl.fn = result;
        //		} else {

        //		result = markup;
        if (isLinkExpr) {
            if (convertBack !== undefined) {
                markup = markup.slice(0, -convertBack.length - 2) + delimCloseChar1;
            }
            markup = delimOpenChar0 + markup + delimCloseChar1;
        }

        blockTagCheck(stack[0] && stack[0][2].pop()[0]);
        // Build the AST (abstract syntax tree) under astTop
        markup.replace(rTag, parseTag);

        pushprecedingContent(markup.length);

        if (loc = astTop[astTop.length - 1]) {
            blockTagCheck("" + loc !== loc && (+loc[8] === loc[8]) && loc[0]);
        }
        //			result = tmplFnsCache[markup] = buildCode(astTop, tmpl);
        //		}

        if (isLinkExpr) {
            result = buildCode(astTop, markup, isLinkExpr);
            setPaths(result, [astTop[0][7]]); // With data-link expressions, pathBindings array is astTop[0][7]
        } else {
            result = buildCode(astTop, tmpl);
        }
        return result;
    }

    function setPaths(fn, pathsArr) {
        var key, paths,
            i = 0,
            l = pathsArr.length;
        fn.deps = [];
        for (; i < l; i++) {
            paths = pathsArr[i];
            for (key in paths) {
                if (key !== "_jsvto" && paths[key].length) {
                    fn.deps = fn.deps.concat(paths[key]); // deps is the concatenation of the paths arrays for the different bindings
                }
            }
        }
        fn.paths = paths; // The array of paths arrays for the different bindings
    }

    function parsedParam(args, props, ctx) {
        return [args.slice(0, -1), props.slice(0, -1), ctx.slice(0, -1)];
    }

    function paramStructure(parts, type) {
        return '\n\t'
            + (type
                ? type + ':{'
                : '')
            + 'args:[' + parts[0] + ']'
            + (parts[1] || !type
                ? ',\n\tprops:{' + parts[1] + '}'
                : "")
            + (parts[2] ? ',\n\tctx:{' + parts[2] + '}' : "");
    }

    function parseParams(params, pathBindings, tmpl) {

        function parseTokens(all, lftPrn0, lftPrn, bound, path, operator, err, eq, path2, prn, comma, lftPrn2, apos, quot, rtPrn, rtPrnDot, prn2, space, index, full) {
            // /(\()(?=\s*\()|(?:([([])\s*)?(?:(\^?)(!*?[#~]?[\w$.^]+)?\s*((\+\+|--)|\+|-|&&|\|\||===|!==|==|!=|<=|>=|[<>%*:?\/]|(=))\s*|(!*?[#~]?[\w$.^]+)([([])?)|(,\s*)|(\(?)\\?(?:(')|("))|(?:\s*(([)\]])(?=\s*[.^]|\s*$|[^([])|[)\]])([([]?))|(\s+)/g,
            //   lftPrn0        lftPrn        bound            path    operator err                                                eq             path2       prn    comma   lftPrn2   apos quot      rtPrn rtPrnDot                        prn2  space
            // (left paren? followed by (path? followed by operator) or (path followed by paren?)) or comma or apos or quot or right paren or space
            bound = bindings && bound;
            if (bound && !eq) {
                path = bound + path; // e.g. some.fn(...)^some.path - so here path is "^some.path"
            }
            operator = operator || "";
            lftPrn = lftPrn || lftPrn0 || lftPrn2;
            path = path || path2;
            // Could do this - but not worth perf cost?? :-
            // if (!path.lastIndexOf("#data.", 0)) { path = path.slice(6); } // If path starts with "#data.", remove that.
            prn = prn || prn2 || "";

            var expr, exprFn, binds, theOb, newOb,
                rtSq = ")";

            if (prn === "[") {
                prn = "[j._sq(";
                rtSq = ")]";
            }

            function parsePath(allPath, not, object, helper, view, viewProperty, pathTokens, leafToken) {
                //rPath = /^(!*?)(?:null|true|false|\d[\d.]*|([\w$]+|\.|~([\w$]+)|#(view|([\w$]+))?)([\w$.^]*?)(?:[.[^]([\w$]+)\]?)?)$/g,
                //          not                               object     helper    view  viewProperty pathTokens      leafToken
                var subPath = object === ".";
                if (object) {
                    path = path.slice(not.length);
                    if (/^\.?constructor$/.test(leafToken || path)) {
                        syntaxError(allPath);
                    }
                    if (!subPath) {
                        allPath = (helper
                                ? 'view.hlp("' + helper + '")'
                                : view
                                    ? "view"
                                    : "data")
                            + (leafToken
                                ? (viewProperty
                                    ? "." + viewProperty
                                    : helper
                                        ? ""
                                        : (view ? "" : "." + object)
                                    ) + (pathTokens || "")
                                : (leafToken = helper ? "" : view ? viewProperty || "" : object, ""));

                        allPath = allPath + (leafToken ? "." + leafToken : "");

                        allPath = not + (allPath.slice(0, 9) === "view.data"
                            ? allPath.slice(5) // convert #view.data... to data...
                            : allPath);
                    }
                    if (bindings) {
                        binds = named === "linkTo" ? (bindto = pathBindings._jsvto = pathBindings._jsvto || []) : bndCtx.bd;
                        if (theOb = subPath && binds[binds.length - 1]) {
                            if (theOb._jsv) {
                                while (theOb.sb) {
                                    theOb = theOb.sb;
                                }
                                if (theOb.bnd) {
                                    path = "^" + path.slice(1);
                                }
                                theOb.sb = path;
                                theOb.bnd = theOb.bnd || path.charAt(0) === "^";
                            }
                        } else {
                            binds.push(path);
                        }
                        pathStart[parenDepth] = index + (subPath ? 1 : 0);
                    }
                }
                return allPath;
            }

            if (err && !aposed && !quoted) {
                syntaxError(params);
            } else {
                if (bindings && rtPrnDot && !aposed && !quoted) {
                    // This is a binding to a path in which an object is returned by a helper/data function/expression, e.g. foo()^x.y or (a?b:c)^x.y
                    // We create a compiled function to get the object instance (which will be called when the dependent data of the subexpression changes, to return the new object, and trigger re-binding of the subsequent path)
                    if (!named || boundName || bindto) {
                        expr = pathStart[parenDepth - 1];
                        if (full.length - 1 > index - (expr || 0)) { // We need to compile a subexpression
                            expr = full.slice(expr, index + all.length);
                            if (exprFn !== true) { // If not reentrant call during compilation
                                binds = bindto || bndStack[parenDepth - 1].bd;
                                // Insert exprOb object, to be used during binding to return the computed object
                                theOb = binds[binds.length - 1];
                                if (theOb && theOb.prm) {
                                    while (theOb.sb && theOb.sb.prm) {
                                        theOb = theOb.sb;
                                    }
                                    newOb = theOb.sb = { path: theOb.sb, bnd: theOb.bnd };
                                } else {
                                    binds.push(newOb = { path: binds.pop() }); // Insert exprOb object, to be used during binding to return the computed object
                                }											 // (e.g. "some.object()" in "some.object().a.b" - to be used as context for binding the following tokens "a.b")
                            }
                            rtPrnDot = delimOpenChar1 + ":" + expr // The parameter or function subexpression
                                + " onerror=''" // set onerror='' in order to wrap generated code with a try catch - returning '' as object instance if there is an error/missing parent
                                + delimCloseChar0;
                            exprFn = tmplLinks[rtPrnDot];
                            if (!exprFn) {
                                tmplLinks[rtPrnDot] = true; // Flag that this exprFn (for rtPrnDot) is being compiled
                                tmplLinks[rtPrnDot] = exprFn = tmplFn(rtPrnDot, tmpl, true); // Compile the expression (or use cached copy already in tmpl.links)
                            }
                            if (exprFn !== true && newOb) {
                                // If not reentrant call during compilation
                                newOb._jsv = exprFn;
                                newOb.prm = bndCtx.bd;
                                newOb.bnd = newOb.bnd || newOb.path && newOb.path.indexOf("^") >= 0;
                            }
                        }
                    }
                }
                return (aposed
                    // within single-quoted string
                    ? (aposed = !apos, (aposed ? all : lftPrn2 + '"'))
                    : quoted
                    // within double-quoted string
                        ? (quoted = !quot, (quoted ? all : lftPrn2 + '"'))
                        :
                    (
                        (lftPrn
                            ? (pathStart[parenDepth] = index++, bndCtx = bndStack[++parenDepth] = { bd: [] }, lftPrn)
                            : "")
                        + (space
                            ? (parenDepth
                                ? ""
                    // New arg or prop - so insert backspace \b (\x08) as separator for named params, used subsequently by rBuildHash, and prepare new bindings array
                                : (paramIndex = full.slice(paramIndex, index), named
                                    ? (named = boundName = bindto = false, "\b")
                                    : "\b,") + paramIndex + (paramIndex = index + all.length, bindings && pathBindings.push(bndCtx.bd = []), "\b")
                            )
                            : eq
                    // named param. Remove bindings for arg and create instead bindings array for prop
                                ? (parenDepth && syntaxError(params), bindings && pathBindings.pop(), named = path, boundName = bound, paramIndex = index + all.length, bound && (bindings = bndCtx.bd = pathBindings[named] = []), path + ':')
                                : path
                    // path
                                    ? (path.split("^").join(".").replace(rPath, parsePath)
                                        + (prn
                    // some.fncall(
                                            ? (bndCtx = bndStack[++parenDepth] = { bd: [] }, fnCall[parenDepth] = rtSq, prn)
                                            : operator)
                                    )
                                    : operator
                    // operator
                                        ? operator
                                        : rtPrn
                    // function
                                            ? ((rtPrn = fnCall[parenDepth] || rtPrn, fnCall[parenDepth] = false, bndCtx = bndStack[--parenDepth], rtPrn)
                                                + (prn // rtPrn and prn, e.g )( in (a)() or a()(), or )[ in a()[]
                                                    ? (bndCtx = bndStack[++parenDepth], fnCall[parenDepth] = rtSq, prn)
                                                    : "")
                                            )
                                            : comma
                                                ? (fnCall[parenDepth] || syntaxError(params), ",") // We don't allow top-level literal arrays or objects
                                                : lftPrn0
                                                    ? ""
                                                    : (aposed = apos, quoted = quot, '"')
                    ))
                );
            }
        }

        var named, bindto, boundName,
            quoted, // boolean for string content in double quotes
            aposed, // or in single quotes
            bindings = pathBindings && pathBindings[0], // bindings array for the first arg
            bndCtx = { bd: bindings },
            bndStack = { 0: bndCtx },
            paramIndex = 0, // list,
            tmplLinks = tmpl ? tmpl.links : bindings && (bindings.links = bindings.links || {}),
            // The following are used for tracking path parsing including nested paths, such as "a.b(c^d + (e))^f", and chained computed paths such as
            // "a.b().c^d().e.f().g" - which has four chained paths, "a.b()", "^c.d()", ".e.f()" and ".g"
            parenDepth = 0,
            fnCall = {}, // We are in a function call
            pathStart = {}, // tracks the start of the current path such as c^d() in the above example
            result = (params + (tmpl ? " " : "")).replace(rParams, parseTokens);

        return !parenDepth && result || syntaxError(params); // Syntax error if unbalanced parens in params expression
    }

    function buildCode(ast, tmpl, isLinkExpr) {
        // Build the template function code from the AST nodes, and set as property on the passed-in template object
        // Used for compiling templates, and also by JsViews to build functions for data link expressions
        var i, node, tagName, converter, tagCtx, hasTag, hasEncoder, getsVal, hasCnvt, useCnvt, tmplBindings, pathBindings, params, boundOnErrStart, boundOnErrEnd,
            tagRender, nestedTmpls, tmplName, nestedTmpl, tagAndElses, content, markup, nextIsElse, oldCode, isElse, isGetVal, tagCtxFn, onError, tagStart, trigger,
            tmplBindingKey = 0,
            useViews = $subSettingsAdvanced.useViews || tmpl.useViews || tmpl.tags || tmpl.templates || tmpl.helpers || tmpl.converters,
            code = "",
            tmplOptions = {},
            l = ast.length;

        if ("" + tmpl === tmpl) {
            tmplName = isLinkExpr ? 'data-link="' + tmpl.replace(rNewLine, " ").slice(1, -1) + '"' : tmpl;
            tmpl = 0;
        } else {
            tmplName = tmpl.tmplName || "unnamed";
            if (tmpl.allowCode) {
                tmplOptions.allowCode = true;
            }
            if (tmpl.debug) {
                tmplOptions.debug = true;
            }
            tmplBindings = tmpl.bnds;
            nestedTmpls = tmpl.tmpls;
        }
        for (i = 0; i < l; i++) {
            // AST nodes: [0: tagName, 1: converter, 2: content, 3: params, 4: code, 5: onError, 6: trigger, 7:pathBindings, 8: contentMarkup]
            node = ast[i];

            // Add newline for each callout to t() c() etc. and each markup string
            if ("" + node === node) {
                // a markup string to be inserted
                code += '\n+"' + node + '"';
            } else {
                // a compiled tag expression to be inserted
                tagName = node[0];
                if (tagName === "*") {
                    // Code tag: {{* }}
                    code += ";\n" + node[1] + "\nret=ret";
                } else {
                    converter = node[1];
                    content = !isLinkExpr && node[2];
                    tagCtx = paramStructure(node[3], 'params') + '},' + paramStructure(params = node[4]);
                    onError = node[5];
                    trigger = node[6];
                    markup = node[8] && node[8].replace(rUnescapeQuotes, "$1");
                    if (isElse = tagName === "else") {
                        if (pathBindings) {
                            pathBindings.push(node[7]);
                        }
                    } else {
                        tmplBindingKey = 0;
                        if (tmplBindings && (pathBindings = node[7])) { // Array of paths, or false if not data-bound
                            pathBindings = [pathBindings];
                            tmplBindingKey = tmplBindings.push(1); // Add placeholder in tmplBindings for compiled function
                        }
                    }
                    useViews = useViews || params[1] || params[2] || pathBindings || /view.(?!index)/.test(params[0]);
                    // useViews is for perf optimization. For render() we only use views if necessary - for the more advanced scenarios.
                    // We use views if there are props, contextual properties or args with #... (other than #index) - but you can force
                    // using the full view infrastructure, (and pay a perf price) by opting in: Set useViews: true on the template, manually...
                    if (isGetVal = tagName === ":") {
                        if (converter) {
                            tagName = converter === HTML ? ">" : converter + tagName;
                        }
                    } else {
                        if (content) { // TODO optimize - if content.length === 0 or if there is a tmpl="..." specified - set content to null / don't run this compilation code - since content won't get used!!
                            // Create template object for nested template
                            nestedTmpl = tmplObject(markup, tmplOptions);
                            nestedTmpl.tmplName = tmplName + "/" + tagName;
                            // Compile to AST and then to compiled function
                            nestedTmpl.useViews = nestedTmpl.useViews || useViews;
                            buildCode(content, nestedTmpl);
                            useViews = nestedTmpl.useViews;
                            nestedTmpls.push(nestedTmpl);
                        }

                        if (!isElse) {
                            // This is not an else tag.
                            tagAndElses = tagName;
                            useViews = useViews || tagName && (!$tags[tagName] || !$tags[tagName].flow);
                            // Switch to a new code string for this bound tag (and its elses, if it has any) - for returning the tagCtxs array
                            oldCode = code;
                            code = "";
                        }
                        nextIsElse = ast[i + 1];
                        nextIsElse = nextIsElse && nextIsElse[0] === "else";
                    }
                    tagStart = onError ? ";\ntry{\nret+=" : "\n+";
                    boundOnErrStart = "";
                    boundOnErrEnd = "";

                    if (isGetVal && (pathBindings || trigger || converter && converter !== HTML)) {
                        // For convertVal we need a compiled function to return the new tagCtx(s)
                        tagCtxFn = new Function("data,view,j,u", " // " + tmplName + " " + tmplBindingKey + " " + tagName
                                            + "\nreturn {" + tagCtx + "};");
                        tagCtxFn._er = onError;
                        tagCtxFn._tag = tagName;

                        if (isLinkExpr) {
                            return tagCtxFn;
                        }

                        setPaths(tagCtxFn, pathBindings);
                        tagRender = 'c("' + converter + '",view,';
                        useCnvt = true;
                        boundOnErrStart = tagRender + tmplBindingKey + ",";
                        boundOnErrEnd = ")";
                    }
                    code += (isGetVal
                        ? (isLinkExpr ? (onError ? "try{\n" : "") + "return " : tagStart) + (useCnvt // Call _cnvt if there is a converter: {{cnvt: ... }} or {^{cnvt: ... }}
                            ? (useCnvt = undefined, useViews = hasCnvt = true, tagRender + (pathBindings
                                ? ((tmplBindings[tmplBindingKey - 1] = tagCtxFn), tmplBindingKey) // Store the compiled tagCtxFn in tmpl.bnds, and pass the key to convertVal()
                                : "{" + tagCtx + "}") + ")")
                            : tagName === ">"
                                ? (hasEncoder = true, "h(" + params[0] + ")")
                                : (getsVal = true, "((v=" + params[0] + ')!=null?v:"")') // Strict equality just for data-link="title{:expr}" so expr=null will remove title attribute
                        )
                        : (hasTag = true, "\n{view:view,tmpl:" // Add this tagCtx to the compiled code for the tagCtxs to be passed to renderTag()
                            + (content ? nestedTmpls.length : "0") + "," // For block tags, pass in the key (nestedTmpls.length) to the nested content template
                            + tagCtx + "},"));

                    if (tagAndElses && !nextIsElse) {
                        // This is a data-link expression or an inline tag without any elses, or the last {{else}} of an inline tag
                        // We complete the code for returning the tagCtxs array
                        code = "[" + code.slice(0, -1) + "]";
                        tagRender = 't("' + tagAndElses + '",view,this,';
                        if (isLinkExpr || pathBindings) {
                            // This is a bound tag (data-link expression or inline bound tag {^{tag ...}}) so we store a compiled tagCtxs function in tmp.bnds
                            code = new Function("data,view,j,u", " // " + tmplName + " " + tmplBindingKey + " " + tagAndElses + "\nreturn " + code + ";");
                            code._er = onError;
                            code._tag = tagAndElses;
                            if (pathBindings) {
                                setPaths(tmplBindings[tmplBindingKey - 1] = code, pathBindings);
                            }
                            if (isLinkExpr) {
                                return code; // For a data-link expression we return the compiled tagCtxs function
                            }
                            boundOnErrStart = tagRender + tmplBindingKey + ",undefined,";
                            boundOnErrEnd = ")";
                        }

                        // This is the last {{else}} for an inline tag.
                        // For a bound tag, pass the tagCtxs fn lookup key to renderTag.
                        // For an unbound tag, include the code directly for evaluating tagCtxs array
                        code = oldCode + tagStart + tagRender + (tmplBindingKey || code) + ")";
                        pathBindings = 0;
                        tagAndElses = 0;
                    }
                    if (onError) {
                        useViews = true;
                        code += ';\n}catch(e){ret' + (isLinkExpr ? "urn " : "+=") + boundOnErrStart + 'j._err(e,view,' + onError + ')' + boundOnErrEnd + ';}' + (isLinkExpr ? "" : 'ret=ret');
                    }
                }
            }
        }
        // Include only the var references that are needed in the code
        code = "// " + tmplName

            + "\nvar v"
            + (hasTag ? ",t=j._tag" : "")                // has tag
            + (hasCnvt ? ",c=j._cnvt" : "")              // converter
            + (hasEncoder ? ",h=j._html" : "")           // html converter
            + (isLinkExpr ? ";\n" : ',ret=""\n')
            + (tmplOptions.debug ? "debugger;" : "")
            + code
            + (isLinkExpr ? "\n" : ";\nreturn ret;");

        if ($subSettings.debugMode !== false) {
            code = "try {\n" + code + "\n}catch(e){\nreturn j._err(e, view);\n}";
        }

        try {
            code = new Function("data,view,j,u", code);
        } catch (e) {
            syntaxError("Compiled template code:\n\n" + code + '\n: "' + e.message + '"');
        }
        if (tmpl) {
            tmpl.fn = code;
            tmpl.useViews = !!useViews;
        }
        return code;
    }

    //==========
    // Utilities
    //==========

    // Merge objects, in particular contexts which inherit from parent contexts
    function extendCtx(context, parentContext) {
        // Return copy of parentContext, unless context is defined and is different, in which case return a new merged context
        // If neither context nor parentContext are defined, return undefined
        return context && context !== parentContext
            ? (parentContext
                ? $extend($extend({}, parentContext), context)
                : context)
            : parentContext && $extend({}, parentContext);
    }

    // Get character entity for HTML and Attribute encoding
    function getCharEntity(ch) {
        return charEntities[ch] || (charEntities[ch] = "&#" + ch.charCodeAt(0) + ";");
    }

    function getTargetProps(source) {
        // this pointer is theMap - which has tagCtx.props too
        // arguments: tagCtx.args.
        var key, prop,
            props = [];

        if (typeof source === OBJECT) {
            for (key in source) {
                prop = source[key];
                if (!prop || !prop.toJSON || prop.toJSON()) {
                    if (!$isFunction(prop)) {
                        props.push({ key: key, prop: prop });
                    }
                }
            }
        }
        return props;
    }

    function $fnRender(data, context, noIteration) {
        var tmplElem = this.jquery && (this[0] || error('Unknown template: "' + this.selector + '"')),
            tmpl = tmplElem.getAttribute(tmplAttr);

        return renderContent.call(tmpl ? $.data(tmplElem)[jsvTmpl] : $templates(tmplElem), data, context, noIteration);
    }

    //========================== Register converters ==========================

    function htmlEncode(text) {
        // HTML encode: Replace < > & ' and " by corresponding entities.
        return text != undefined ? rIsHtml.test(text) && ("" + text).replace(rHtmlEncode, getCharEntity) || text : "";
    }

    //========================== Initialize ==========================

    $sub = $views.sub;
    $viewsSettings = $views.settings;

    if (!(jsr || $ && $.render)) {
        // JsRender not already loaded, or loaded without jQuery, and we are now moving from jsrender namespace to jQuery namepace
        for (jsvStoreName in jsvStores) {
            registerStore(jsvStoreName, jsvStores[jsvStoreName]);
        }

        $converters = $views.converters;
        $helpers = $views.helpers;
        $tags = $views.tags;

        $sub._tg.prototype = {
            baseApply: baseApply,
            cvtArgs: convertArgs
        };

        topView = $sub.topView = new View();

        //BROWSER-SPECIFIC CODE
        if ($) {

            ////////////////////////////////////////////////////////////////////////////////////////////////
            // jQuery (= $) is loaded

            $.fn.render = $fnRender;

            if ($.observable) {
                $extend($sub, $.views.sub); // jquery.observable.js was loaded before jsrender.js
                $views.map = $.views.map;
            }

        } else {
            ////////////////////////////////////////////////////////////////////////////////////////////////
            // jQuery is not loaded.

            $ = {};

            if (setGlobals) {
                global.jsrender = $; // We are loading jsrender.js from a script element, not AMD or CommonJS, so set global
            }

            // Error warning if jsrender.js is used as template engine on Node.js (e.g. Express or Hapi...)
            // Use jsrender-node.js instead...
            $.renderFile = $.__express = $.compile = function () { throw "Node.js: use npm jsrender, or jsrender-node.js"; };

            //END BROWSER-SPECIFIC CODE
            $.isFunction = function (ob) {
                return typeof ob === "function";
            };

            $.isArray = Array.isArray || function (obj) {
                return ({}.toString).call(obj) === "[object Array]";
            };

            $sub._jq = function (jq) { // private method to move from JsRender APIs from jsrender namespace to jQuery namespace
                if (jq !== $) {
                    $extend(jq, $); // map over from jsrender namespace to jQuery namespace
                    $ = jq;
                    $.fn.render = $fnRender;
                    delete $.jsrender;
                }
            };

            $.jsrender = versionNumber;
        }

        $subSettings = $sub.settings;
        $subSettings.allowCode = false;
        $isFunction = $.isFunction;
        $isArray = $.isArray;
        $.render = $render;
        $.views = $views;
        $.templates = $templates = $views.templates;

        for (setting in $subSettings) {
            addSetting(setting);
        }

        ($viewsSettings.debugMode = function (debugMode) {
            return debugMode === undefined
                ? $subSettings.debugMode
                : (
                    $subSettings.debugMode = debugMode,
                    $subSettings.onError = debugMode + "" === debugMode
                        ? new Function("", "return '" + debugMode + "';")
                        : $isFunction(debugMode)
                            ? debugMode
                            : undefined,
                    $viewsSettings);
        })(false); // jshint ignore:line

        $subSettingsAdvanced = $subSettings.advanced = {
            useViews: false,
            _jsv: false // For global access to JsViews store
        };

        //========================== Register tags ==========================

        $tags({
            "if": {
                render: function (val) {
                    // This function is called once for {{if}} and once for each {{else}}.
                    // We will use the tag.rendering object for carrying rendering state across the calls.
                    // If not done (a previous block has not been rendered), look at expression for this block and render the block if expression is truthy
                    // Otherwise return ""
                    var self = this,
                        tagCtx = self.tagCtx,
                        ret = (self.rendering.done || !val && (arguments.length || !tagCtx.index))
                            ? ""
                            : (self.rendering.done = true, self.selected = tagCtx.index,
                                // Test is satisfied, so render content on current context. We call tagCtx.render() rather than return undefined
                                // (which would also render the tmpl/content on the current context but would iterate if it is an array)
                                tagCtx.render(tagCtx.view, true)); // no arg, so renders against parentView.data
                    return ret;
                },
                flow: true
            },
            "for": {
                render: function (val) {
                    // This function is called once for {{for}} and once for each {{else}}.
                    // We will use the tag.rendering object for carrying rendering state across the calls.
                    var finalElse = !arguments.length,
                        value,
                        self = this,
                        tagCtx = self.tagCtx,
                        result = "",
                        done = 0;

                    if (!self.rendering.done) {
                        value = finalElse ? tagCtx.view.data : val; // For the final else, defaults to current data without iteration.
                        if (value !== undefined) {
                            result += tagCtx.render(value, finalElse); // Iterates except on final else, if data is an array. (Use {{include}} to compose templates without array iteration)
                            done += $isArray(value) ? value.length : 1;
                        }
                        if (self.rendering.done = done) {
                            self.selected = tagCtx.index;
                        }
                        // If nothing was rendered we will look at the next {{else}}. Otherwise, we are done.
                    }
                    return result;
                },
                flow: true
            },
            props: {
                baseTag: "for",
                dataMap: dataMap(getTargetProps),
                flow: true
            },
            include: {
                flow: true
            },
            "*": {
                // {{* code... }} - Ignored if template.allowCode and $.views.settings.allowCode are false. Otherwise include code in compiled template
                render: retVal,
                flow: true
            },
            ":*": {
                // {{:* returnedExpression }} - Ignored if template.allowCode and $.views.settings.allowCode are false. Otherwise include code in compiled template
                render: retVal,
                flow: true
            },
            dbg: $helpers.dbg = $converters.dbg = dbgBreak // Register {{dbg/}}, {{dbg:...}} and ~dbg() to throw and catch, as breakpoints for debugging.
        });

        $converters({
            html: htmlEncode,
            attr: htmlEncode, // Includes > encoding since rConvertMarkers in JsViews does not skip > characters in attribute strings
            url: function (text) {
                // URL encoding helper.
                return text != undefined ? encodeURI("" + text) : text === null ? text : ""; // null returns null, e.g. to remove attribute. undefined returns ""
            }
        });
    }
    //========================== Define default delimiters ==========================
    $subSettings = $sub.settings;
    $viewsSettings.delimiters("{{", "}}", "^");

    if (jsrToJq) { // Moving from jsrender namespace to jQuery namepace - copy over the stored items (templates, converters, helpers...)
        jsr.views.sub._jq($);
    }
    //<<<<<<<<<<<<<<<<<<<<<<<<<<<<<< JsObservable >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
    /* JsObservable:
     * See http://www.jsviews.com/#jsobservable and http://github.com/borismoore/jsviews
     * Copyright 2016, Boris Moore
     * Released under the MIT License.
     */

    //========================== Top-level vars ==========================

    $views = $.views;
    $sub = $views.sub;
    $isFunction = $.isFunction;
    $isArray = $.isArray;
    if (!$.observe) {

        var $eventSpecial = $.event.special,
            slice = [].slice,
            splice = [].splice,
            concat = [].concat,
            $expando = $.expando,
            PARSEINT = parseInt,
            rNotWhite = /\S+/g,
            propertyChangeStr = $sub.propChng = $sub.propChng || "propertyChange",// These two settings can be overridden on settings after loading
            arrayChangeStr = $sub.arrChng = $sub.arrChng || "arrayChange",        // jsRender, and prior to loading jquery.observable.js and/or JsViews
            cbBindingsStore = {},
            observeStr = propertyChangeStr + ".observe",
            observeObjKey = 1,
            observeCbKey = 1,
            observeInnerCbKey = 1,
            $hasData = $.hasData,
            $data = $.data,
            remove = {}, // flag for removeProperty

        //========================== Top-level functions ==========================

        getCbKey = function (cb) {
            return cb._cId = cb._cId || (".obs" + observeCbKey++);
        },

        ObjectObservable = function (ns, data) {
            this._data = data;
            this._ns = ns;
            return this;
        },

        ArrayObservable = function (ns, data) {
            this._data = data;
            this._ns = ns;
            return this;
        },

        wrapArray = function (data) {
            return $isArray(data)
                ? [data]
                : data;
        },

        resolvePathObjects = function (paths, root, callback) {
            paths = paths
                ? $isArray(paths)
                    ? paths
                    : [paths]
                : [];

            var i, path,
                object = root,
                nextObj = object,
                l = paths && paths.length,
                out = [];

            for (i = 0; i < l; i++) {
                path = paths[i];
                if ($isFunction(path)) {
                    out = out.concat(resolvePathObjects(path.call(root, root, callback), root));
                    continue;
                } else if ("" + path !== path) {
                    root = nextObj = path;
                    if (nextObj !== object) {
                        out.push(object = nextObj);
                    }
                    continue;
                }
                if (nextObj !== object) {
                    out.push(object = nextObj);
                }
                out.push(path);
            }
            return out;
        },

        removeCbBindings = function (cbBindings, cbBindingsId) {
            // If the cbBindings collection is empty we will remove it from the cbBindingsStore
            for (var cb in cbBindings) {
                return;
            }
            delete cbBindingsStore[cbBindingsId]; // This binding collection is empty, so remove from store
        },

        onObservableChange = function (ev, eventArgs) {
            function isOb(val) {
                return typeof val === OBJECT && (paths[0] || allowArray && $isArray(val));
            }

            if (!(ev.data && ev.data.off)) {
                // Skip if !!ev.data.off: - a handler that has already been removed (maybe was on handler collection at call time - then removed by another handler)
                var allPath, filter, parentObs,
                    oldValue = eventArgs.oldValue,
                    value = eventArgs.value,
                    ctx = ev.data,
                    observeAll = ctx.observeAll,
                    cb = ctx.cb,
                    allowArray = !cb.noArray,
                    paths = ctx.paths,
                    ns = ctx.ns;

                if (ev.type === arrayChangeStr) {
                    (cb.array || cb).call(ctx, ev, eventArgs); // If there is an arrayHandler expando on the regular handler, use it, otherwise use the regular handler for arrayChange events also - for example: $.observe(array, handler)
                    // or observeAll() with an array in the graph. Note that on data-link bindings we ensure always to have an array handler - $.noop if none is specified e.g. on the data-linked tag.
                } else if (ctx.prop === eventArgs.path || ctx.prop === "*") {
                    if (observeAll) {
                        allPath = observeAll._path + "." + eventArgs.path;
                        filter = observeAll.filter;
                        parentObs = [ev.target].concat(observeAll.parents());

                        if (isOb(oldValue)) {
                            observe_apply(allowArray, ns, [oldValue], paths, cb, true, filter, [parentObs], allPath); // unobserve
                        }
                        if (isOb(value)) {
                            observe_apply(allowArray, ns, [value], paths, cb, undefined, filter, [parentObs], allPath);
                        }
                    } else {
                        if (isOb(oldValue)) { // oldValue is an object, so unobserve
                            observe_apply(allowArray, ns, [oldValue], paths, cb, true); // unobserve
                        }
                        if (isOb(value)) { // value is an object, so observe
                            observe_apply(allowArray, ns, [value], paths, cb);
                        }
                    }
                    ctx.cb(ev, eventArgs);
                }
            }
        },

        observe_apply = function () {
            // $.observe(), but allowing you to include arrays within the arguments - which you want flattened.
            var args = concat.apply([], arguments); // Flatten the arguments
            return $observe.apply(args.shift(), args);
        },

        $observeAll = function (cb, filter, unobserve) {
            observeAll(this._ns, this._data, cb, filter, [], "root", unobserve);
        },

        $unobserveAll = function (cb, filter) {
            $observeAll.call(this, cb, filter, true);
        },

        observeAll = function (namespace, object, cb, filter, parentObs, allPath, unobserve, objMap) {
            function observeArrayItems(arr, unobs) {
                l = arr.length;
                newAllPath = allPath + "[]";
                while (l--) {
                    filterAndObserveAll(arr, l, unobs, 1);
                }
            }

            function filterAndObserveAll(obj, prop, unobs, nestedArray) {
                var newObject, newParentObs;
                if (prop !== $expando) {
                    if (newObject = $observable._fltr(newAllPath, obj[prop], nextParentObs, filter)) {
                        newParentObs = nextParentObs.slice();
                        if (nestedArray && updatedTgt && newParentObs[0] !== updatedTgt) {
                            newParentObs.unshift(updatedTgt); // For array change events when observing an array which is not the root, need to add updated array to parentObs
                        }
                        observeAll(namespace, newObject, cb, filter || (nestedArray ? undefined : 0), newParentObs, newAllPath, unobs, objMap);
                        // If nested array, need to observe the array too - so set filter to undefined
                    }
                }
            }

            function wrappedCb(ev, eventArgs) {
                // This object is changing.
                allPath = ev.data.observeAll._path;
                updatedTgt = ev.target;
                switch (eventArgs.change) { // observeAll/unobserveAll on added or removed objects
                    case "insert":
                        observeArrayItems(eventArgs.items);
                        break;
                    case "remove":
                        observeArrayItems(eventArgs.items, true); // unobserveAll on removed items
                        break;
                    case "refresh":
                        observeArrayItems(eventArgs.oldItems, true); // unobserveAll on old items
                        observeArrayItems(ev.target); // observeAll on new items
                        break;
                    case "set":
                        newAllPath = allPath + "." + eventArgs.path;
                        filterAndObserveAll(eventArgs, "oldValue", true); // unobserve old value
                        filterAndObserveAll(eventArgs, "value"); // observe new value
                }
                updatedTgt = undefined;
                cb.apply(this, arguments); // Observe this object (invoke the callback)
            }

            var l, isObject, newAllPath, nextParentObs, updatedTgt, obId,
                notRemoving = !objMap || objMap.un || !unobserve; // true unless it is an observeAll call (not unobserveAll) and we are removing a listener (not adding one)

            if (object && typeof object === OBJECT) {
                nextParentObs = [object].concat(parentObs); // The parentObs chain for the next depth of observeAll
                isObject = $isArray(object) ? "" : "*";
                if (objMap && notRemoving && $hasData(object) && objMap[obId = $data(object).obId]) {
                    objMap[obId]++;
                    return; // This object has already being observed/unobserved by this observeAll/unobserveAll call (must be a cyclic object graph) so skip, to avoid
                    // stack overflow/multiple instances of listener. See jsviews/pull/305
                    // NOTE - WE DO NOT support ObserveAll on data with cyclic graphs which include DUPLICATE REFERENCES TO ARRAY PROPERTIES - such as data.children = data.descendants = []
                }
                if (!objMap) {
                    objMap = { un: unobserve }; // Map object to register observed objects for this observeAll
                }

                if (cb) {
                    // Observe this object or array - and also listen for changes to object graph, to add or remove observers from the modified object graph
                    if (isObject || filter !== 0) {
                        // If an object, observe the object. If an array, only add arrayChange binding if has filter or if filter is undefined (!== 0) - which
                        // is the case for top-level calls or for nested array (array item of an array - e.g. member of 2-dimensional array).
                        // For array properties lower in the tree, with no filter, filter is set to 0 in filterAndObserveAll, so no arrayChange binding here,
                        // since they get arrayChange binding added during regular $.observe(array ...) binding.
                        wrappedCb._cId = getCbKey(cb); // Identify wrapped callback with unwrapped callback, so unobserveAll will
                        // remove previous observeAll wrapped callback, if inner callback was the same;
                        if (notRemoving) {
                            $observe(namespace, object, isObject, wrappedCb, unobserve, filter, nextParentObs, allPath);
                            obId = $data(object).obId;
                            objMap[obId] = (objMap[obId] || 0) + 1; // Register on map of objects observed/unobserved by this observeAll/unobserveAll call
                            //- or remove from map if we are removing this object from observeAll call. (Avoid dups, for cyclic graphs)
                        } else {
                            if (--objMap[$data(object).obId]) {
                                // Register on map of objects observed/unobserved by this observeAll/unobserveAll call
                                //- or remove from map if we are removing this object from observeAll call. (Avoid dups, for cyclic graphs)
                                return;
                            }
                            $observe(namespace, object, isObject, wrappedCb, unobserve, filter, nextParentObs, allPath);
                        }
                    }
                } else {
                    // No callback. Just unobserve if unobserve === true.
                    if (objMap) {
                        objMap[$data(object).obId] = 1; // Register on map of objects unobserved by this unobserveAll call. (Avoid dups, for cyclic graphs)
                    }
                    $observe(namespace, object, isObject, undefined, unobserve, filter, nextParentObs, allPath);
                }

                if (isObject) {
                    // Continue stepping through object graph, observing object and arrays
                    // To override filtering, pass in filter function, or replace $.observable._fltr
                    for (l in object) {
                        newAllPath = allPath + "." + l;
                        filterAndObserveAll(object, l, unobserve);
                    }
                } else { // Observe items in Array
                    observeArrayItems(object, unobserve);
                }
            }
        },

        shallowFilter = function (allPath /*, object, parentObs*/) {
            return allPath.indexOf(".") < 0 && allPath.indexOf("[") < 0;
        },

        $unobserve = function () {
            [].push.call(arguments, true); // Add true as additional final argument
            return $observe.apply(this, arguments);
        };

        $observe = function () {
            // $.observe([namespace, ]root, [1 or more objects, path or path Array params...], callback[, contextCallback][, unobserve])

            function innerObserve() {

                function observeOnOff(namespace, pathStr, isArrayBinding, off) {
                    var j, evData,
                        obIdExpando = $hasData(object),
                        boundObOrArr = wrapArray(object),
                        prntObs = parentObs,
                        allPth = allPath;

                    namespace = initialNs ? namespace + "." + initialNs : namespace;

                    if (!unobserve && (off || isArrayBinding)) {
                        events = obIdExpando && $._data(object);
                        events = events && events.events;
                        events = events && events[isArrayBinding ? arrayChangeStr : propertyChangeStr];
                        el = events && events.length;
                        while (el--) { // Skip duplicates
                            data = events[el] && events[el].data;
                            if (data && (off && data.ns !== initialNs
                                // When observing, don't unbind dups unless they have the same namespace
                                || !off && data.ns === initialNs && data.cb && data.cb._cId === callback._cId))
                                // When observing and doing array binding, don't bind dups if they have the same namespace (Dups can happen e.g. with {^{for people ~foo=people}})
                            {
                                return;
                            }
                        }
                    }
                    if (unobserve || off) {
                        $(boundObOrArr).off(namespace, onObservableChange);
                    } else {
                        evData = isArrayBinding ? {}
                            : {
                                fullPath: path,
                                paths: pathStr ? [pathStr] : [],
                                prop: prop
                            };
                        evData.ns = initialNs;
                        evData.cb = callback;

                        if (allPath) {
                            // This is an observeAll call
                            evData.observeAll = {
                                _path: allPth,
                                path: function () { // Step through path and parentObs parent chain, replacing '[]' by '[n]' based on current index of objects in parent arrays.
                                    j = prntObs.length;
                                    return allPth.replace(/[[.]/g, function (all) {
                                        j--;
                                        return all === "["
                                            ? "[" + $.inArray(prntObs[j - 1], prntObs[j])
                                            : ".";
                                    });
                                },
                                parents: function () {
                                    return prntObs; // The chain of parents between the modified object and the root object used in the observeAll() call
                                },
                                filter: filter
                            };
                        }
                        $(boundObOrArr).on(namespace, null, evData, onObservableChange);
                        if (cbBindings) {
                            // Add object to cbBindings
                            cbBindings[$data(object).obId || $data(object, "obId", observeObjKey++)] = object;
                        }
                    }
                }

                function getInnerCb(exprOb) {
                    // Returns the innerCb used for updating a computed in a compiled expression (setting the new instance as exprOb.ob, unobserving the previous object,
                    // and observing the new one), then calling the outerCB - i.e. the handler for the whole compiled expression.
                    // Initialized exprOb.ob to the current object.
                    // Uses the contextCb callback to execute the compiled exprOb template in the context of the view/data etc. to get the returned value, typically an object or array.
                    // If it is an array, registers array binding
                    var origRt = root;
                    // Note: For jsviews/issues/292 ctxCb will need var ctxCb = contextCb || function(exprOb, origRt) {return exprOb._jsv(origRt);};

                    exprOb.ob = contextCb(exprOb, origRt); // Initialize object

                    return exprOb.cb = function (ev, eventArgs) {
                        var obj = exprOb.ob, // The old object
                            sub = exprOb.sb,
                            newObj = contextCb(exprOb, origRt);

                        if (newObj !== obj) {
                            if (typeof obj === OBJECT) {
                                bindArray(obj, true);
                                if (sub || allowArray && $isArray(obj)) {
                                    innerObserve([obj], sub, callback, contextCb, true); // unobserve on the old object
                                }
                            }
                            exprOb.ob = newObj;
                            // Put the updated object instance onto the exprOb in the paths array, so subsequent string paths are relative to this object
                            if (typeof newObj === OBJECT) {
                                bindArray(newObj);
                                if (sub || allowArray && $isArray(newObj)) {
                                    // Register array binding
                                    innerObserve([newObj], sub, callback, contextCb);
                                }
                            }
                        }
                        // Call the outerCb - to execute the compiled expression that this computed is part of
                        callback(ev, eventArgs);
                    };
                }

                function bindArray(arr, unbind, isArray, relPath) {
                    if (allowArray) {
                        // This is a call to observe that does not come from observeAndBind (tag binding), so we allow arrayChange binding
                        var prevObj = object,
                            prevAllPath = allPath;

                        object = arr;
                        if (relPath) {
                            object = arr[relPath];
                            allPath += "." + relPath;
                        }
                        if (filter && object) {
                            object = $observable._fltr(allPath, object, relPath ? [arr].concat(parentObs) : parentObs, filter);
                        }
                        if (object && (isArray || $isArray(object))) {
                            observeOnOff(arrayChangeStr + ".observe" + (callback ? getCbKey(callback) : ""), undefined, true, unbind);
                        }
                        object = prevObj;
                        allPath = prevAllPath;
                    }
                }

                var i, p, skip, parts, prop, path, dep, unobserve, callback, cbId, inId, el, data, events, contextCb, items, cbBindings,
                    depth, innerCb, parentObs, allPath, filter, initNsArr, initNsArrLen,
                    ns = observeStr,
                    paths = this != 1 // Using != for IE<10 bug- see jsviews/issues/237
                        ? concat.apply([], arguments) // Flatten the arguments - this is a 'recursive call' with params using the 'wrapped array'
                                                        // style - such as innerObserve([object], path.path, [origRoot], path.prm, innerCb, ...);
                        : slice.call(arguments), // Don't flatten - this is the first 'top-level call, to innerObserve.apply(1, paths)
                    lastArg = paths.pop() || false,
                    root = paths.shift(),
                    object = root,
                    l = paths.length;

                if (lastArg + "" === lastArg) { // If last arg is a string then this observe call is part of an observeAll call,
                    allPath = lastArg;          // and the last three args are the parentObs array, the filter, and the allPath string.
                    parentObs = paths.pop();
                    filter = paths.pop();
                    lastArg = !!paths.pop(); // unobserve
                    l -= 3;
                }
                if (lastArg === !!lastArg) {
                    unobserve = lastArg;
                    lastArg = paths[l - 1];
                    lastArg = l && lastArg + "" !== lastArg && (!lastArg || $isFunction(lastArg)) ? (l--, paths.pop()) : undefined;
                    if (unobserve && !l && $isFunction(root)) {
                        lastArg = root;
                        root = undefined;
                    }
                }
                callback = lastArg;
                if (l && $isFunction(paths[l - 1])) {
                    contextCb = callback;
                    callback = paths.pop();
                    l--;
                }

                if (unobserve && callback && !callback._cId) {
                    return;
                }

                // Use a unique namespace (e.g. obs7) associated with each observe() callback to allow unobserve to remove handlers
                ns += callback
                    ? ((inId = callback._inId || ""), unobserve)
                        ? callback._cId + inId
                        : (cbId = getCbKey(callback)) + inId
                    : "";

                if (cbId && !unobserve) {
                    cbBindings = cbBindingsStore[cbId] = cbBindingsStore[cbId] || {};
                }

                initNsArr = initialNs && initialNs.match(rNotWhite) || [""];
                initNsArrLen = initNsArr.length;

                while (initNsArrLen--) {
                    initialNs = initNsArr[initNsArrLen];
                    if (root && (path = paths[0], !path || path + "" !== path)) {
                        if ($isArray(root)) {
                            bindArray(root, unobserve, true);
                        } else if (unobserve) {
                            // remove onObservableChange handlers that wrap that callback
                            observeOnOff(ns, "");
                        }
                    }
                    if (unobserve && !l && !root) { // unobserve() - unobserves all
                        for (p in cbBindingsStore) {
                            p = cbBindingsStore[p];
                            for (data in p) {
                                object = p[data];
                                if ($isArray(object)) {
                                    bindArray(object, unobserve, unobserve);
                                } else {
                                    // remove onObservableChange handlers that wrap that callback
                                    observeOnOff(ns, "");
                                }
                            }
                        }
                    }
                    depth = 0;
                    for (i = 0; i < l; i++) {
                        path = paths[i];
                        if (path === "") {
                            continue;
                        }
                        object = root;
                        if ("" + path === path) {
                            // Consider support for computed paths: jsviews/issues/292
                            //if (/[\(\[\+]/.test(path)) {
                            //	var b={links:{}}, t = $sub.tmplFn("{:"+path+"}", b, true), items = t.paths[0];
                            //	l += items.length - 1;
                            //	splice.apply(paths, [i--, 1].concat(items));
                            //	continue;
                            //}
                            parts = path.split("^");
                            if (parts[1]) {
                                // We bind the leaf, plus additional nodes based on depth.
                                // "a.b.c^d.e" is depth 2, so listens to changes of e, plus changes of d and of c
                                depth = parts[0].split(".").length;
                                path = parts.join(".");
                                depth = path.split(".").length - depth;
                                // if more than one ^ in the path, the first one determines depth
                            }
                            if (contextCb && (items = contextCb(path, root))) {
                                // If contextCb returns an array of objects and paths, we will insert them
                                // into the sequence, replacing the current item (path)
                                l += items.length - 1;
                                splice.apply(paths, [i--, 1].concat(items));
                                continue;
                            }
                            parts = path.split(".");
                        } else {
                            if (!$isFunction(path)) {
                                if (path && path._jsv) {
                                    // This is a compiled function for binding to an object returned by a helper/data function.
                                    // Set current object on exprOb.ob, and get innerCb for updating the object
                                    innerCb = unobserve ? path.cb : getInnerCb(path);
                                    innerCb.noArray = !allowArray;
                                    // innerCb._ctx = callback._ctx; Could pass context (e.g. linkCtx) for use in a depends = function() {} call, so depends is different for different linkCtx's
                                    innerCb._cId = callback._cId;
                                    // Set the same cbBindingsStore key as for callback, so when callback is disposed, disposal of innerCb happens too.
                                    innerCb._inId = innerCb._inId || ".obIn" + observeInnerCbKey++;
                                    if (path.bnd || path.prm && path.prm.length || !path.sb) {
                                        // If the exprOb is bound e.g. foo()^sub.path, or has parameters e.g. foo(bar) or is a leaf object (so no sub path) e.g. foo()
                                        // then observe changes on the object, or its parameters and sub-path
                                        innerObserve([object], path.path, [origRoot], path.prm, innerCb, contextCb, unobserve);
                                    }
                                    if (path.sb) { // subPath
                                        innerObserve([path.ob], path.sb, callback, contextCb, unobserve);
                                    }
                                    path = origRoot;
                                    object = undefined;
                                } else {
                                    object = path; // For top-level calls, objects in the paths array become the origRoot for subsequent paths.
                                }
                            }
                            parts = [root = path];
                        }
                        while (object && (prop = parts.shift()) !== undefined) {
                            if (typeof object === OBJECT) {
                                if ("" + prop === prop) {
                                    if (prop === "") {
                                        continue;
                                    }
                                    if ((parts.length < depth + 1) && !object.nodeType) {
                                        // Add observer for each token in path starting at depth, and on to the leaf
                                        if (!unobserve && (events = $hasData(object) && $._data(object))) {
                                            events = events.events;
                                            events = events && events[propertyChangeStr];
                                            el = events && events.length;
                                            skip = 0;
                                            while (el--) { // Skip duplicates
                                                data = events[el].data;
                                                if (data
                                                    && data.ns === initialNs
                                                    && data.cb._cId === callback._cId
                                                    && data.cb._inId === callback._inId
                                                    && (data.prop === prop || data.prop === "*" || data.prop === "**")) {
                                                    if (p = parts.join(".")) {
                                                        data.paths.push(p); // We will skip this binding, but if it is not a leaf binding,
                                                        // need to keep bindings for rest of path, ready for if the object gets swapped.
                                                    }
                                                    skip++;
                                                }
                                            }
                                            if (skip) {
                                                // Duplicate binding(s) found, so move on
                                                object = object[prop];
                                                continue;
                                            }
                                        }
                                        if (prop === "*" || prop === "**") { // "*" => all properties. "**" => all properties and sub-properties (i.e. deep observeAll behavior)
                                            if (!unobserve && events && events.length) {
                                                // Remove existing bindings, since they will be duplicates with "*" or "**"
                                                observeOnOff(ns, "", false, true);
                                            }
                                            if (prop === "*") {
                                                observeOnOff(ns, ""); // observe the object for any property change
                                                for (p in object) {
                                                    // observing "*": So (in addition to listening to prop change, above) listen to arraychange on props of type array
                                                    if (p !== $expando) {
                                                        bindArray(object, unobserve, undefined, p);
                                                    }
                                                }
                                            } else {
                                                $.observable(initialNs, object)[(unobserve ? "un" : "") + "observeAll"](callback); // observe or unobserve the object for any property change
                                            }
                                            break;
                                        } else if (prop) {
                                            observeOnOff(ns + ".p_" + prop, parts.join("^")); // By using "^" rather than "." we ensure that deep binding will be used on newly inserted object graphs
                                        }
                                    }
                                    if (allPath) {
                                        allPath += "." + prop;
                                    }
                                    prop = object[prop];
                                }
                                if ($isFunction(prop)) {
                                    if (dep = prop.depends) {
                                        // This is a computed observable. We will observe any declared dependencies
                                        innerObserve([object], resolvePathObjects(dep, object, callback), callback, contextCb, unobserve);
                                    }
                                    break;
                                }
                                object = prop;
                                if (unobserve && object === root && (i > l - 2 || paths[i + 1] + "" !== paths[i + 1])) {
                                    // unobserve all handlers of object, if not followed by string path.
                                    // e.g.$.unobserve(object1, object2, "path", object3) will unobserve all from object1 and object3, and just "path" listener from object2
                                    observeOnOff(ns, "");
                                }
                            }
                        }
                        bindArray(object, unobserve);
                    }
                }
                if (cbId) {
                    removeCbBindings(cbBindings, cbId);
                }

                // Return the cbBindings to the top-level caller, along with the cbId
                return { cbId: cbId, bnd: cbBindings };
            }

            var initialNs,
                allowArray = this != false, // If this === false, this is a call from observeAndBind - doing binding of datalink expressions. We don't bind
                // arrayChange events in this scenario. Instead, {^{for}} and similar do specific arrayChange binding to the tagCtx.args[0] value, in onAfterLink.
                // Note deliberately using this != false, rather than this !== false because of IE<10 bug- see jsviews/issues/237
                paths = slice.call(arguments),
                origRoot = paths[0];

            if (origRoot + "" === origRoot && allowArray) {
                initialNs = origRoot; // The first arg is a namespace, since it is a string, and this call is not from observeAndBind
                paths.shift();
                origRoot = paths[0];
            }

            return innerObserve.apply(1, paths);
        };

        $observable = function (ns, data) {
            if (arguments.length === 1) {
                data = ns;
                ns = "";
            }
            return $isArray(data)
                ? new ArrayObservable(ns, data)
                : new ObjectObservable(ns, data);
        };

        //========================== Initialize ==========================

        $sub.getDeps = function () {
            var args = arguments;
            return function () {
                var arg, dep,
                    deps = [],
                    l = args.length;
                while (l--) {
                    arg = args[l--];
                    dep = args[l];
                    if (dep) {
                        deps = deps.concat($isFunction(dep) ? dep(arg, arg) : dep);
                    }
                }
                return deps;
            };
        };

        $.observable = $observable;
        $observable._fltr = function (allPath, object, parentObs, filter) {
            if (filter && $isFunction(filter)
                ? filter(allPath, object, parentObs)
                : true // TODO Consider supporting filter being a string or strings to do RegEx filtering based on key and/or allPath
            ) {
                object = $isFunction(object)
                    ? object.set && object.call(parentObs[0]) // It is a getter/setter
                    : object;
                return typeof object === OBJECT && object;
            }
        };

        $observable.Object = ObjectObservable;
        $observable.Array = ArrayObservable;
        $.observe = $observable.observe = $observe;
        $.unobserve = $observable.unobserve = $unobserve;
        $observable._apply = observe_apply;

        ObjectObservable.prototype = {
            _data: null,

            observeAll: $observeAll,
            unobserveAll: $unobserveAll,

            data: function () {
                return this._data;
            },

            setProperty: function (path, value, nonStrict) {
                path = path || "";
                var key, pair, parts,
                    multi = path + "" !== path,
                    self = this,
                    object = self._data;

                if (object) {
                    if (multi) {
                        nonStrict = value;
                        if ($isArray(path)) {
                            // This is the array format generated by serializeArray. However, this has the problem that it coerces types to string,
                            // and does not provide simple support of convertTo and convertFrom functions.
                            key = path.length;
                            while (key--) {
                                pair = path[key];
                                self.setProperty(pair.name, pair.value, nonStrict === undefined || nonStrict); //If nonStrict not specified, default to true;
                            }
                        } else {
                            // Object representation where property name is path and property value is value.
                            for (key in path) {
                                self.setProperty(key, path[key], nonStrict);
                            }
                        }
                    } else if (path !== $expando) {
                        // Simple single property case.
                        parts = path.split(".");
                        while (object && parts.length > 1) {
                            object = object[parts.shift()];
                        }
                        if (object) {
                            self._setProperty(object, parts[0], value, nonStrict);
                        }
                    }
                }
                return self;
            },

            removeProperty: function (path) {
                this.setProperty(path, remove);
                return this;
            },

            _setProperty: function (leaf, path, value, nonStrict) {
                var setter, getter, removeProp,
                    property = path ? leaf[path] : leaf;

                if ($isFunction(property)) {
                    if (property.set) {
                        // Case of property setter/getter - with convention that property is getter and property.set is setter
                        leaf = leaf._wrp  // Case of JsViews 2-way data-linking to a helper function as getter, with a setter.
                            // The view will be the this pointer for getter and setter. Note: this is the one scenario where path is "".
                            || leaf;
                        getter = property;
                        setter = getter.set === true ? getter : getter.set;
                        property = getter.call(leaf); // get - only treated as getter if also a setter. Otherwise it is simply a property of type function. See unit tests 'Can observe properties of type function'.
                    }
                }

                if (property !== value || nonStrict && property != value) { // Optional non-strict equality, since serializeArray, and form-based editors can map numbers to strings, etc.
                    // Date objects don't support != comparison. Treat as special case.
                    if (!(property instanceof Date) || property > value || property < value) {
                        if (setter) {
                            setter.call(leaf, value);   //set
                            value = getter.call(leaf);  //get updated value
                        } else if (removeProp = value === remove) {
                            if (property !== undefined) {
                                delete leaf[path];
                                value = undefined;
                            } else {
                                path = undefined; // If value was already undefined, don't trigger handler for removeProp
                            }
                        } else if (path) {
                            leaf[path] = value;
                        }
                        if (path) {
                            this._trigger(leaf, { change: "set", path: path, value: value, oldValue: property, remove: removeProp });
                        }
                    }
                }
            },

            _trigger: function (target, eventArgs) {
                $(target).triggerHandler(propertyChangeStr + (this._ns ? "." + /^\S+/.exec(this._ns)[0] : ""), eventArgs); // If white-space separated namespaces, use first one only
            }
        };

        ArrayObservable.prototype = {
            _data: null,

            observeAll: $observeAll,
            unobserveAll: $unobserveAll,

            data: function () {
                return this._data;
            },

            insert: function (index, data) {
                var _data = this._data;
                if (arguments.length === 1) {
                    data = index;
                    index = _data.length;
                }
                index = PARSEINT(index);
                if (index > -1 && index <= _data.length) {
                    data = $isArray(data) ? data : [data];
                    // data can be a single item (including a null/undefined value) or an array of items.
                    // Note the provided items are inserted without being cloned, as direct references to the provided objects

                    if (data.length) {
                        this._insert(index, data);
                    }
                }
                return this;
            },

            _insert: function (index, data) {
                var _data = this._data,
                    oldLength = _data.length;
                splice.apply(_data, [index, 0].concat(data));
                this._trigger({ change: "insert", index: index, items: data }, oldLength);
            },

            remove: function (index, numToRemove) {
                var items,
                    _data = this._data;

                if (index === undefined) {
                    index = _data.length - 1;
                }

                index = PARSEINT(index);
                numToRemove = numToRemove ? PARSEINT(numToRemove) : numToRemove === 0 ? 0 : 1; // if null or undefined: remove 1
                if (numToRemove > -1 && index > -1) {
                    items = _data.slice(index, index + numToRemove);
                    numToRemove = items.length;
                    if (numToRemove) {
                        this._remove(index, numToRemove, items);
                    }
                }
                return this;
            },

            _remove: function (index, numToRemove, items) {
                var _data = this._data,
                    oldLength = _data.length;

                _data.splice(index, numToRemove);
                this._trigger({ change: "remove", index: index, items: items }, oldLength);
            },

            move: function (oldIndex, newIndex, numToMove) {
                numToMove = numToMove ? PARSEINT(numToMove) : numToMove === 0 ? 0 : 1; // if null or undefined: move 1
                oldIndex = PARSEINT(oldIndex);
                newIndex = PARSEINT(newIndex);

                if (numToMove > 0 && oldIndex > -1 && newIndex > -1 && oldIndex !== newIndex) {
                    var items = this._data.slice(oldIndex, oldIndex + numToMove);
                    numToMove = items.length;
                    if (numToMove) {
                        this._move(oldIndex, newIndex, numToMove, items);
                    }
                }
                return this;
            },

            _move: function (oldIndex, newIndex, numToMove, items) {
                var _data = this._data,
                    oldLength = _data.length;
                _data.splice(oldIndex, numToMove);
                splice.apply(_data, [newIndex, 0].concat(items));
                this._trigger({ change: "move", oldIndex: oldIndex, index: newIndex, items: items }, oldLength);
            },

            refresh: function (newItems) {
                var oldItems = this._data.slice();
                this._refresh(oldItems, newItems);
                return this;
            },

            _refresh: function (oldItems, newItems) {
                var _data = this._data,
                    oldLength = _data.length;

                splice.apply(_data, [0, _data.length].concat(newItems));
                this._trigger({ change: "refresh", oldItems: oldItems }, oldLength);
            },

            _trigger: function (eventArgs, oldLength) {
                var _data = this._data,
                    length = _data.length,
                    $_data = $([_data]);

                if (length !== oldLength) {
                    $_data.triggerHandler(propertyChangeStr, { change: "set", path: "length", value: length, oldValue: oldLength });
                }
                $_data.triggerHandler(arrayChangeStr + (this._ns ? "." + /^\S+/.exec(this._ns)[0] : ""), eventArgs); // If white-space separated namespaces, use first one only
            }
        };

        $eventSpecial[propertyChangeStr] = $eventSpecial[arrayChangeStr] = {
            // Register a jQuery special 'remove' event, to access the data associated with handlers being removed by jQuery.off().
            // We get data.cb._cId from the event handleObj and get the corresponding cbBindings hash from the cbBindingsStore,
            // then remove this object from that bindings hash - if the object does not have any other handlers associated with the same callback.
            remove: function (handleObj) {
                var cbBindings, found, events, l, data,
                    evData = handleObj.data;
                if ((evData) && (evData.off = true, evData = evData.cb)) { //Set off = true as marker for disposed event
                    // Get the cb._cId from handleObj.data.cb._cId
                    if (cbBindings = cbBindingsStore[evData._cId]) {
                        // There were bindings for this callback. If this was the last one, we'll remove it.
                        events = $._data(this).events[handleObj.type];
                        l = events.length;
                        while (l-- && !found) {
                            found = (data = events[l].data) && data.cb && data.cb._cId === evData._cId;
                            // Found another one with same callback (though may be a different innerCallback)
                        }
                        if (!found) {
                            // This was the last handler for this callback and object, so remove the binding entry
                            delete cbBindings[$data(this).obId];
                            removeCbBindings(cbBindings, evData._cId);
                        }
                    }
                }
            }
        };

        $views.map = function (mapDef) {
            function Map(source, options, target, unbound) {
                var changing,
                    map = this;
                if (this.src) {
                    this.unmap(); // We are re-mapping a new source
                }
                if (typeof source === OBJECT) {
                    map.src = source;
                    map.tgt = target || map.tgt || [];
                    map.options = options || map.options;
                    map.update();
                    if (!unbound) {
                        if (mapDef.obsSrc) {
                            $observable(map.src).observeAll(map.obs = function (ev, eventArgs) {
                                if (!changing) {
                                    changing = true;
                                    mapDef.obsSrc(map, ev, eventArgs);
                                    changing = undefined;
                                }
                            }, map.srcFlt);
                        }
                        if (mapDef.obsTgt) {
                            $observable(map.tgt).observeAll(map.obt = function (ev, eventArgs) {
                                if (!changing) {
                                    changing = true;
                                    mapDef.obsTgt(map, ev, eventArgs);
                                    changing = undefined;
                                }
                            }, map.tgtFlt);
                        }
                    }
                }
            }

            if ($isFunction(mapDef)) {
                // Simple map declared as function
                mapDef = {
                    getTgt: mapDef
                };
            }

            if (mapDef.baseMap) {
                mapDef = $.extend({}, mapDef.baseMap, mapDef);
            }

            mapDef.map = function (source, options, target, unbound) {
                return new Map(source, options, target, unbound);
            };

            (Map.prototype = {
                srcFlt: mapDef.srcFlt || shallowFilter, // default to shallowFilter
                tgtFlt: mapDef.tgtFlt || shallowFilter,
                update: function (options) {
                    var map = this;
                    $observable(map.tgt).refresh(mapDef.getTgt(map.src, map.options = options || map.options));
                },
                unmap: function () {
                    var map = this;
                    if (map.src) {
                        if (map.obs) {
                            $observable(map.src).unobserveAll(map.obs, map.srcFlt);
                        }
                        if (map.obt) {
                            $observable(map.tgt).unobserveAll(map.obt, map.tgtFlt);
                        }
                        map.src = undefined;
                    }
                },
                map: Map,
                _def: mapDef
            }).constructor = Map;

            return mapDef;
        };

        $sub.advSet = function () { // refresh advanced settings
            global._jsv = $subSettings.advanced._jsv
                ? { // create global _jsv, for accessing views, etc
                    cbBindings: cbBindingsStore
                }
                : undefined; // In IE8 cannot do delete global._jsv
        };
    }


    //<<<<<<<<<<<<<<<<<<<<<<<<<<<<<< JsViews >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
    /* JsViews:
     * Interactive data-driven views using templates and data-linking.
     * See http://www.jsviews.com/#jsviews and http://github.com/BorisMoore/jsviews
     * Copyright 2016, Boris Moore
     * Released under the MIT License.
     */

    //========================== Top-level vars ==========================

    $viewsSettings = $views.settings;
    $subSettings = $sub.settings;
    $subSettingsAdvanced = $subSettings.advanced;
    $converters = $views.converters;
    $.templates = $templates = $views.templates;
    $tags = $views.tags;
    rFirstElem = /<(?!script)(\w+)[>\s]/;

    if ($.link) { return $; } // JsViews is already loaded

    var activeBody, rTagDatalink, $view, $viewsLinkAttr, linkViewsSel, wrapMap, viewStore, oldAdvSet,
        jsvAttrStr = "data-jsv",
        elementChangeStr = "change.jsv",
        onBeforeChangeStr = "onBeforeChange",
        onAfterChangeStr = "onAfterChange",
        onAfterCreateStr = "onAfterCreate",
        CHECKED = "checked",
        CHECKBOX = "checkbox",
        RADIO = "radio",
        RADIOINPUT = "input[type=radio]",
        NONE = "none",
        SCRIPT = "SCRIPT",
        TRUE = "true",
        closeScript = '"></script>',
        openScript = '<script type="jsv',
        deferAttr = jsvAttrStr + "-df",
        bindElsSel = "script,[" + jsvAttrStr + "]",
        fnSetters = {
            value: "val",
            input: "val",
            html: HTML,
            text: "text"
        },
        valueBinding = { from: "value", to: "value" },
        isCleanCall = 0,
        oldCleanData = $.cleanData,
        oldJsvDelimiters = $viewsSettings.delimiters,
        safeFragment = document.createDocumentFragment(),
        qsa = document.querySelector,

        // elContent maps tagNames which have only element content, so may not support script nodes.
        elContent = { ol: 1, ul: 1, table: 1, tbody: 1, thead: 1, tfoot: 1, tr: 1, colgroup: 1, dl: 1, select: 1, optgroup: 1, svg: 1, svg_ns: 1 },
        badParent = { tr: "table" },
        voidElems = {
            br: 1, img: 1, input: 1, hr: 1, area: 1, base: 1, col: 1, link: 1, meta: 1,
            command: 1, embed: 1, keygen: 1, param: 1, source: 1, track: 1, wbr: 1
        },
        displayStyles = {},
        bindingStore = {},
        bindingKey = 1,
        rViewPath = /^#(view\.?)?/,
        rConvertMarkers = /((\/>)|<\/(\w+)>|)(\s*)([#\/]\d+(?:_|(\^)))`(\s*)(<\w+(?=[\s\/>]))?|\s*(?:(<\w+(?=[\s\/>]))|<\/(\w+)>(\s*)|(\/>)\s*|(>)|$)/g,
        rOpenViewMarkers = /(#)()(\d+)(_)/g,
        rOpenMarkers = /(#)()(\d+)([_^])/g,
        rViewMarkers = /(?:(#)|(\/))(\d+)(_)/g,
        rOpenTagMarkers = /(#)()(\d+)(\^)/g,
        rMarkerTokens = /(?:(#)|(\/))(\d+)([_^])([-+@\d]+)?/g,
        rSplitBindings = /&(\d+)\+?/g,
        getComputedStyle = global.getComputedStyle;

    $observable = $.observable;

    if (!$observable) {
        // JsObservable is not loaded.
        throw requiresStr + "JsObservable"; // jquery.observable.js must be loaded before JsViews
    }

    $observe = $observable.observe;

    //========================== Top-level functions ==========================

    //===============
    // Event handlers
    //===============

    function elemChangeHandler(ev, params, sourceValue) {
        var setter, cancel, fromAttr, linkCtx, cvtBack, cnvtName, target, $source, view, binding, oldLinkCtx, onBeforeChange, onAfterChange, tag, to, eventArgs, exprOb,
            source = ev.target,
            bindings = source._jsvBnd;

        // _jsvBnd is a string with the syntax: "&bindingId1&bindingId2"
        if (bindings) {
            while (binding = rSplitBindings.exec(bindings)) {
                if (binding = bindingStore[binding[1]]) {
                    if (to = binding.to) {
                        // The binding has a 'to' field, which is of the form [[targetObject, toPath], cvtBack]
                        linkCtx = binding.linkCtx;
                        view = linkCtx.view;
                        tag = linkCtx.tag;
                        $source = $(source);
                        onBeforeChange = view.hlp(onBeforeChangeStr); // TODO Can we optimize this and other instances of same?
                        onAfterChange = view.hlp(onAfterChangeStr); // TODO Can we optimize this and other instances of same
                        fromAttr = defaultAttr(source);
                        setter = fnSetters[fromAttr];
                        if (sourceValue === undefined) {
                            sourceValue = $isFunction(fromAttr)
                                ? fromAttr(source)
                                : setter
                                    ? $source[setter]()
                                    : $source.attr(fromAttr);
                        }
                        cnvtName = to[1];
                        to = to[0]; // [object, path]
                        to = to + "" === to ? [linkCtx.data, to] : to;
                        if (cnvtName) {
                            if ($isFunction(cnvtName)) {
                                cvtBack = cnvtName;
                            } else {
                                cvtBack = view.getRsc("converters", cnvtName);
                            }
                        }
                        if (linkCtx.elem.nodeName === "SELECT") {
                            linkCtx.elem._jsvSel = sourceValue = sourceValue || (linkCtx.elem.multiple ? [] : sourceValue);
                            // data-link <select> to string or (multiselect) array of strings
                        }
                        if (cvtBack) {
                            sourceValue = cvtBack.call(tag, sourceValue);
                        }

                        // Set linkCtx on view, dynamically, just during this handler call
                        oldLinkCtx = view.linkCtx;
                        view.linkCtx = linkCtx;
                        eventArgs = {
                            change: "change",
                            oldValue: linkCtx._val,
                            value: sourceValue
                        };
                        if ((!onBeforeChange || !(cancel = onBeforeChange.call(linkCtx, ev, eventArgs) === false)) &&
                                (!tag || !tag.onBeforeChange || !(cancel = tag.onBeforeChange(ev, eventArgs) === false)) &&
                                sourceValue !== undefined) {
                            target = to[0]; // [object, path]
                            if (sourceValue !== undefined && target) {
                                if (target._jsv) {
                                    exprOb = target;
                                    target = linkCtx.data;
                                    while (exprOb && exprOb.sb) {
                                        target = linkCtx._ctxCb(exprOb, target);
                                        exprOb = exprOb.sb;
                                    }
                                }
                                if (tag) {
                                    tag._.chging = true; // marker to prevent tag change event triggering its own refresh
                                }
                                $observable(target).setProperty(to[2] || to[1], sourceValue);
                                if (onAfterChange) {
                                    onAfterChange.call(linkCtx, ev, eventArgs);
                                }
                                if (tag) {
                                    if (tag.onAfterChange) {
                                        tag.onAfterChange(ev, eventArgs);
                                    }
                                    tag._.chging = undefined; // clear the marker
                                }
                                linkCtx._val = sourceValue;
                            }
                        }
                        view.linkCtx = oldLinkCtx;
                    }
                }
            }
        }
    }

    function propertyChangeHandler(ev, eventArgs, linkFn) {
        var attr, sourceValue, noUpdate, forceUpdate, hasError, onError,
            linkCtx = this,
            tag = linkCtx.tag,
            source = linkCtx.data,
            target = linkCtx.elem,
            cvt = linkCtx.convert,
            parentElem = target.parentNode,
            view = linkCtx.view,
            oldLinkCtx = view.linkCtx,
            onEvent = view.hlp(onBeforeChangeStr);

        // Set linkCtx on view, dynamically, just during this handler call
        view.linkCtx = linkCtx;

        if (parentElem && (!onEvent || !(eventArgs && onEvent.call(linkCtx, ev, eventArgs) === false))
            // If data changed, the ev.data is set to be the path. Use that to filter the handler action...
                && !(eventArgs && ev.data.prop !== "*" && ev.data.prop !== eventArgs.path)) {

            if (eventArgs) {
                linkCtx.eventArgs = eventArgs;
            }
            if (eventArgs || linkCtx._toLk) {
                // If eventArgs are defined, this is a data update
                // Otherwise this is the initial data-link rendering call. Bind on this the first time it get called
                linkCtx._toLk = 0; // Remove flag to skip unneccessary rebinding next time
                if (linkFn._er) {
                    // data-link="exprUsingTagOrCvt with onerror=..." - e.g. {tag ... {cvt:... {:... convert='cvt'
                    try {
                        sourceValue = linkFn(source, view);
                    } catch (e) {
                        hasError = linkFn._er;
                        onError = onRenderError(e, view, (new Function("data,view", "return " + hasError + ";"))(source, view));
                        sourceValue = [{ props: {}, args: [onError] }];
                    }
                } else {
                    sourceValue = linkFn(source, view, $sub);
                }
                // Compiled link expression for linkTag: return value for data-link="{:xxx}" with no cvt or cvtBk, otherwise tagCtx or tagCtxs

                attr = getTargetVal(sourceValue, linkCtx, tag = linkCtx.tag,
                        linkCtx.attr || defaultAttr(target, true, cvt !== undefined)
                    );

                if (tag) {
                    // Existing tag instance
                    forceUpdate = hasError || tag._er;
                    // If the new tagCtxs hasError or the previous tagCtxs had error, then force update
                    sourceValue = sourceValue[0] ? sourceValue : [sourceValue];
                    noUpdate = !forceUpdate && eventArgs && tag.onUpdate && tag.onUpdate(ev, eventArgs, sourceValue) === false;

                    mergeCtxs(tag, sourceValue, forceUpdate);

                    if (noUpdate || attr === NONE) {
                        // onUpdate returned false, or attr === "none", or this is an update coming from the tag's own change event
                        // - so don't refresh the tag: we just use the new tagCtxs merged from the sourceValue,
                        // (which may optionally have been modifed in onUpdate()...) and then bind, and we are done
                        if (attr === HTML && tag.onBeforeLink) {
                            tag.onBeforeLink();
                        }
                        callAfterLink(tag);
                        observeAndBind(linkCtx, source, target);
                        view.linkCtx = oldLinkCtx;
                        return;
                    }
                    if (tag._.chging) {
                        return;
                    }

                    sourceValue = tag.tagName === ":" // Call convertVal if it is a {{cvt:...}} - otherwise call renderTag
                        ? $sub._cnvt(tag.cvt, view, sourceValue[0])
                        : $sub._tag(tag, view, view.tmpl, sourceValue, true, onError);
                } else if (linkFn._tag) {
                    // For {{: ...}} without a convert or convertBack, we already have the sourceValue, and we are done
                    // For {{: ...}} with either cvt or cvtBack we call convertVal to get the sourceValue and instantiate the tag
                    // If cvt is undefined then this is a tag, and we call renderTag to get the rendered content and instantiate the tag
                    cvt = cvt === "" ? TRUE : cvt; // If there is a cvtBack but no cvt, set cvt to "true"
                    sourceValue = cvt // Call convertVal if it is a {{cvt:...}} - otherwise call renderTag
                        ? $sub._cnvt(cvt, view, sourceValue[0] || sourceValue) // convertVal
                        : $sub._tag(linkFn._tag, view, view.tmpl, sourceValue, true, onError); // renderTag

                    addLinkMethods(tag = linkCtx.tag, true); // In both convertVal and renderTag we have instantiated a tag
                    attr = linkCtx.attr || attr; // linkCtx.attr may have been set to tag.attr during tag instantiation in renderTag
                }

                if (updateContent(sourceValue, linkCtx, attr, tag)
                        && eventArgs
                        && (onEvent = view.hlp(onAfterChangeStr))) {
                    onEvent.call(linkCtx, ev, eventArgs);
                }
                linkCtx._noUpd = 0; // For data-link="^{...}" remove _noUpd flag so updates on subsequent calls

                if (tag) {
                    tag._er = hasError;
                    callAfterLink(tag, eventArgs);
                }
            }

            observeAndBind(linkCtx, source, target);

            // Remove dynamically added linkCtx from view
            view.linkCtx = oldLinkCtx;
        }
    }

    function getTargetVal(sourceValue, linkCtx, tag, attr) {
        var currentValue, setter, css, $target,
            target = tag && tag.parentElem || linkCtx.elem;

        if (sourceValue !== undefined) {
            $target = $(target);
            attr = tag && tag.attr || attr;
            if ($isFunction(sourceValue)) {
                error(linkCtx.expr + ": missing parens");
            }

            if (css = /^css-/.test(attr) && attr.slice(4)) {
                currentValue = $.style(target, css);
                if (+sourceValue === sourceValue) {
                    // Optimization for perf on integer values - e.g. css-width{:width+'px'}
                    currentValue = parseInt(currentValue);
                }
            } else if (attr !== "link") { // attr === "link" is for tag controls which do data binding but have no rendered output or target
                if (attr === "value") {
                    if (target.type === CHECKBOX) {
                        currentValue = $target.prop(attr = CHECKED);
                    }
                } else if (attr === RADIO) {
                    if (target.value === ("" + sourceValue)) {
                        currentValue = $target.prop(CHECKED);
                    } else {
                        return attr;
                    }
                }

                if (currentValue === undefined) {
                    setter = fnSetters[attr];
                    currentValue = setter ? $target[setter]() : $target.attr(attr);
                }
            }
            linkCtx._val = currentValue;
        }
        return attr;
    }

    function setDefer(elem, value) {
        elem._df = value; // Use both an expando and an attribute to track defered tokens. Attribute is needed for querySelectorAll for getViewInfos (childTags)
        elem[(value ? "set" : "remove") + "Attribute"](deferAttr, "");
    }

    function updateContent(sourceValue, linkCtx, attr, tag) {
        // When called for a tag, either in tag.refresh() or propertyChangeHandler(), returns a promise (and supports async)
        // When called (in propertyChangeHandler) for target HTML returns true
        // When called (in propertyChangeHandler) for other targets returns boolean for "changed"
        var setter, prevNode, nextNode, promise, nodesToRemove, useProp, tokens, id, openIndex, closeIndex, testElem, nodeName, cStyle, jsvSel,
            renders = attr !== NONE && sourceValue !== undefined && !linkCtx._noUpd, // For data-link="^{...}", don't update the first time (no initial render) - e.g. to leave server rendered values.
            source = linkCtx.data,
            target = tag && tag.parentElem || linkCtx.elem,
            targetParent = target.parentNode,
            $target = $(target),
            view = linkCtx.view,
            targetVal = linkCtx._val,
            oldLinkCtx = view.linkCtx,
            // If not a tag and not targeting HTML, we can use the ._val obtained from getTargetVal()
            // and only update when the new value (sourceValue) has changed from the previous one
            change = tag || attr === HTML;

        if (tag) {
            // Initialize the tag with element references
            tag.parentElem = tag.parentElem || (linkCtx.expr || tag._elCnt) ? target : targetParent;
            prevNode = tag._prv;
            nextNode = tag._nxt;
        }
        if (!renders) {
            if (attr === HTML && tag && tag.onBeforeLink) {
                tag.onBeforeLink();
            }
            return;
        }

        if (attr === "visible") {
            attr = "css-display";
        }
        if (/^css-/.test(attr)) {
            if (linkCtx.attr === "visible") {
                // Get the current display style
                cStyle = (target.currentStyle || getComputedStyle.call(global, target, "")).display;

                if (sourceValue) {
                    // We are showing the element.
                    // Get the cached 'visible' display value from the -jsvd expando
                    sourceValue = target._jsvd
                        // Or, if not yet cached, get the current display value
                        || cStyle;
                    if (sourceValue === NONE && !(sourceValue = displayStyles[nodeName = target.nodeName])) {
                        // Currently display value is 'none', and the 'visible' style has not been cached.
                        // We create an element to find the correct 'visible' display style for this nodeName
                        testElem = document.createElement(nodeName);
                        document.body.appendChild(testElem);

                        // Get the default style for this HTML tag to use as 'visible' style
                        sourceValue
                            // and cache it as a hash against nodeName
                            = displayStyles[nodeName]
                            = (testElem.currentStyle || getComputedStyle.call(global, testElem, "")).display;
                        document.body.removeChild(testElem);
                    }
                } else {
                    // We are hiding the element.
                    // Cache the current display value as 'visible' style, on _jsvd expando, for when we show the element again
                    target._jsvd = cStyle;
                    sourceValue = NONE; // Hide the element
                }
            }
            if (change = change || targetVal !== sourceValue) {
                $.style(target, attr.slice(4), sourceValue);
            }
        } else if (attr !== "link") { // attr === "link" is for tag controls which do data binding but have no rendered output or target
            if (/^data-/.test(attr)) {
                $.data(target, attr.slice(5), sourceValue); // Support for binding to data attributes: data-foo{:expr}: data-foo attribute will be
                // expr.toString(), but $.data(element, "foo") and $(element).data("foo") will actually return value of expr, even if of type object
            }
            if (attr === CHECKED) {
                useProp = true;
                sourceValue = sourceValue && sourceValue !== "false";
                // The string value "false" can occur with data-link="checked{attr:expr}" - as a result of attr, and hence using convertVal()
                // We will set the "checked" property
                // We will compare this with the current value
            } else if (attr === RADIO) {
                // This is a special binding attribute for radio buttons, which corresponds to the default 'to' binding.
                // This allows binding both to value (for each input) and to the default checked radio button (for each input in named group,
                // e.g. binding to parent data).
                // Place value binding first: <input type="radio" data-link="value{:name} {:#get('data').data.currency:} " .../>
                // or (allowing any order for the binding expressions):
                // <input type="radio" value="{{:name}}" data-link="{:#get('data').data.currency:} value^{:name}" .../>

                if (target.value === ("" + sourceValue)) {
                    // If the data value corresponds to the value attribute of this radio button input, set the checked property to true
                    sourceValue = useProp = true;
                    attr = CHECKED;
                } else {
                    // Otherwise, go straight to observeAndBind, without updating.
                    // (The browser will remove the 'checked' attribute, when another radio button in the group is checked).
                    observeAndBind(linkCtx, source, target);
                    return;
                }
            } else if (attr === "selected" || attr === "disabled" || attr === "multiple" || attr === "readonly") {
                sourceValue = (sourceValue && sourceValue !== "false") ? attr : null;
                // Use attr, not prop, so when the options (for example) are changed dynamically, but include the previously selected value,
                // they will still be selected after the change
            } else if (attr === "value" && target.nodeName === "SELECT") {
                target._jsvSel = $isArray(sourceValue)
                    ? sourceValue
                    : "" + sourceValue; // If not array, coerce to string
            }

            if (setter = fnSetters[attr]) {
                if (attr === HTML) {
                    // Set linkCtx on view, dynamically, just during this handler call
                    view.linkCtx = linkCtx;
                    if (tag && tag._.inline) {
                        nodesToRemove = tag.nodes(true);
                        if (tag._elCnt) {
                            if (prevNode && prevNode !== nextNode) {
                                // This prevNode will be removed from the DOM, so transfer the view tokens on prevNode to nextNode of this 'viewToRefresh'
                                transferViewTokens(prevNode, nextNode, target, tag._tgId, "^", true);
                            } else if (tokens = target._df) { // This occurs when there is no nextNode, and so the target._df may include tokens referencing
                                // view and tag bindings contained within the open and close tokens of the updated tag control. They need to be processed (disposed)
                                id = tag._tgId + "^";
                                openIndex = tokens.indexOf("#" + id) + 1;
                                closeIndex = tokens.indexOf("/" + id);

                                if (openIndex && closeIndex > 0) {
                                    openIndex += id.length;
                                    if (closeIndex > openIndex) {
                                        setDefer(target, tokens.slice(0, openIndex) + tokens.slice(closeIndex));
                                        disposeTokens(tokens.slice(openIndex, closeIndex));
                                    }
                                }
                            }
                            prevNode = prevNode
                                ? prevNode.previousSibling
                                : nextNode
                                    ? nextNode.previousSibling
                                    : target.lastChild;
                        }
                        // Remove HTML nodes
                        $(nodesToRemove).remove(); // Note if !tag._elCnt removing the nodesToRemove will process and dispose view and tag bindings contained within the updated tag control

                        if (tag && tag.onBeforeLink) {
                            tag.onBeforeLink();
                        }
                        // Insert and link new content
                        promise = view.link(view.data, target, prevNode, nextNode, sourceValue, tag && { tag: tag._tgId, lazyLink: tag.tagCtx.props.lazyLink });
                    } else {
                        // data-linked value targeting innerHTML: data-link="html{:expr}"
                        if (renders) {
                            $target.empty();
                        }
                        if (tag && tag.onBeforeLink) {
                            tag.onBeforeLink();
                        }
                        if (renders) {
                            promise = view.link(source, target, prevNode, nextNode, sourceValue, tag && { tag: tag._tgId });
                        }
                    }
                    // Remove dynamically added linkCtx and ctx from view
                    view.linkCtx = oldLinkCtx;
                } else {
                    if (change = change || targetVal !== sourceValue) {
                        if (attr === "text" && target.children && !target.children[0]) {
                            // This code is faster then $target.text()
                            if (target.textContent !== undefined) {
                                target.textContent = sourceValue;
                            } else {
                                target.innerText = sourceValue === null ? "" : sourceValue;
                            }
                        } else {
                            $target[setter](sourceValue);
                        }
                    }
                    if ((jsvSel = targetParent._jsvSel)
                        // Setting value of <option> element
                        && (attr === "value" || !$target.attr("value"))) { // Setting value attribute, or setting textContent if attribute is null
                        // Set/unselect selection based on value set on parent <select>. Works for multiselect too
                        target.selected = $.inArray("" + sourceValue, $isArray(jsvSel) ? jsvSel : [jsvSel]) > -1;
                    }
                }
            } else if (change = change || targetVal !== sourceValue) {
                // Setting an attribute to undefined should remove the attribute
                $target[useProp ? "prop" : "attr"](attr, sourceValue === undefined && !useProp ? null : sourceValue);
            }
            linkCtx._val = sourceValue;
        }
        return promise || change;
    }

    function arrayChangeHandler(ev, eventArgs) {
        var self = this,
            onBeforeChange = self.hlp(onBeforeChangeStr),
            onAfterChange = self.hlp(onAfterChangeStr);
        if (!onBeforeChange || onBeforeChange.call(this, ev, eventArgs) !== false) {
            if (eventArgs) {
                // This is an observable action (not a trigger/handler call from pushValues, or similar, for which eventArgs will be null)
                var action = eventArgs.change,
                    index = eventArgs.index,
                    items = eventArgs.items;

                switch (action) {
                    case "insert":
                        self.addViews(index, items);
                        break;
                    case "remove":
                        self.removeViews(index, items.length);
                        break;
                    case "move":
                        self.refresh(); // Could optimize this
                        break;
                    case "refresh":
                        self.refresh();
                        break;
                        // Other cases: (e.g.undefined, for setProperty on observable object) etc. do nothing
                }
            }
            if (onAfterChange) {
                onAfterChange.call(this, ev, eventArgs);
            }
        }
    }

    //=============================
    // Utilities for event handlers
    //=============================

    function setArrayChangeLink(view) {
        // Add/remove arrayChange handler on view
        var handler, arrayBinding,
            type = view.type, // undefined if view is being removed
            data = view.data,
            bound = view._.bnd; // true for top-level link() or data-link="{for}", or the for tag instance for {^{for}} (or for any custom tag that has an onArrayChange handler)

        if (!view._.useKey && bound) {
            // This is an array view. (view._.useKey not defined => data is array), and is data-bound to collection change events

            if (arrayBinding = view._.bndArr) {
                // First remove the current handler if there is one
                $([arrayBinding[1]]).off(arrayChangeStr, arrayBinding[0]);
                view._.bndArr = undefined;
            }
            if (bound !== !!bound) {
                // bound is not a boolean, so it is the data-linked tag that 'owns' this array binding - e.g. {^{for...}}
                if (type) {
                    bound._.arrVws[view._.id] = view;
                } else {
                    delete bound._.arrVws[view._.id]; // if view.type is undefined, view is being removed
                }
            } else if (type && data) {
                // If this view is not being removed, but the data array has been replaced, then bind to the new data array
                handler = function (ev) {
                    if (!(ev.data && ev.data.off)) {
                        // Skip if !!ev.data.off: - a handler that has already been removed (maybe was on handler collection at call time - then removed by another handler)
                        // If view.type is undefined, do nothing. (Corresponds to case where there is another handler on the same data whose
                        // effect was to remove this view, and which happened to precede this event in the trigger sequence. So although this
                        // event has been removed now, it is still called since already on the trigger sequence)
                        arrayChangeHandler.apply(view, arguments);
                    }
                };
                $([data]).on(arrayChangeStr, handler);
                view._.bndArr = [handler, data];
            }
        }
    }

    function defaultAttr(elem, to, linkGetVal) {
        // to: true - default attribute for setting data value on HTML element; false: default attribute for getting value from HTML element
        // Merge in the default attribute bindings for this target element
        var nodeName = elem.nodeName.toLowerCase(),
            attr =
                $subSettingsAdvanced._fe[nodeName] // get form element binding settings for input textarea select or optgroup
                || elem.contentEditable === TRUE && { to: HTML, from: HTML }; // Or if contentEditable set to "true" set attr to "html"
        return attr
            ? (to
                ? ((nodeName === "input" && elem.type === RADIO) // For radio buttons, bind from value, but bind to 'radio' - special value.
                    ? RADIO
                    : attr.to)
                : attr.from)
            : to
                ? linkGetVal ? "text" : HTML // Default innerText for data-link="a.b.c" or data-link="{:a.b.c}" (with or without converters)- otherwise innerHTML
                : ""; // Default is not to bind from
    }

    //==============================
    // Rendering and DOM insertion
    //==============================

    function renderAndLink(view, index, tmpl, views, data, context, refresh) {
        var html, linkToNode, prevView, nodesToRemove, bindId,
            parentNode = view.parentElem,
            prevNode = view._prv,
            nextNode = view._nxt,
            elCnt = view._elCnt;

        if (prevNode && prevNode.parentNode !== parentNode) {
            error("Missing parentNode");
            // Abandon, since node has already been removed, or wrapper element has been inserted between prevNode and parentNode
        }

        if (refresh) {
            nodesToRemove = view.nodes();
            if (elCnt && prevNode && prevNode !== nextNode) {
                // This prevNode will be removed from the DOM, so transfer the view tokens on prevNode to nextNode of this 'viewToRefresh'
                transferViewTokens(prevNode, nextNode, parentNode, view._.id, "_", true);
            }
            // Remove child views
            view.removeViews(undefined, undefined, true);
            linkToNode = nextNode;

            if (elCnt) {
                prevNode = prevNode
                    ? prevNode.previousSibling
                    : nextNode
                        ? nextNode.previousSibling
                        : parentNode.lastChild;
            }

            // Remove HTML nodes
            $(nodesToRemove).remove();

            for (bindId in view._.bnds) {
                // The view bindings may have already been removed above in: $(nodesToRemove).remove();
                // If not, remove them here:
                removeViewBinding(bindId);
            }
        } else {
            // addViews. Only called if view is of type "array"
            if (index) {
                // index is a number, so indexed view in view array
                prevView = views[index - 1];
                if (!prevView) {
                    return false; // If subview for provided index does not exist, do nothing
                }
                prevNode = prevView._nxt;
            }
            if (elCnt) {
                linkToNode = prevNode;
                prevNode = linkToNode
                    ? linkToNode.previousSibling         // There is a linkToNode, so insert after previousSibling, or at the beginning
                    : parentNode.lastChild;              // If no prevView and no prevNode, index is 0 and the container is empty,
                // so prevNode = linkToNode = null. But if prevView._nxt is null then we set prevNode to parentNode.lastChild
                // (which must be before the prevView) so we insert after that node - and only link the inserted nodes
            } else {
                linkToNode = prevNode.nextSibling;
            }
        }
        html = tmpl.render(data, context, view._.useKey && refresh, view, refresh || index, true);
        // Pass in view._.useKey as test for noIteration (which corresponds to when self._.useKey > 0 and self.data is an array)

        // Link the new HTML nodes to the data
        view.link(data, parentNode, prevNode, linkToNode, html, prevView);
        //}, 0);
    }

    //=====================
    // addBindingMarkers
    //=====================

    function addBindingMarkers(value, view, tag) {
        // Insert binding markers into the rendered template output, which will get converted to appropriate
        // data-jsv attributes (element-only content) or script marker nodes (phrasing or flow content), in convertMarkers,
        // within view.link, prior to inserting into the DOM. Linking will then bind based on these markers in the DOM.
        // Added view markers: #m_...VIEW.../m_
        // Added tag markers: #m^...TAG..../m^
        var id, end;
        if (tag) {
            // This is a binding marker for a data-linked tag {^{...}}
            end = "^`";
            addLinkMethods(tag, true); // This is {^{>...}} or {^{tag ...}}, {{cvt:...} or {^{:...}}, and tag was defined in convertVal or renderTag
            id = tag._tgId;
            if (!id) {
                bindingStore[id = bindingKey++] = tag; // Store the tag temporarily, ready for databinding.
                // During linking, in addDataBinding, the tag will be attached to the linkCtx,
                // and then in observeAndBind, bindingStore[bindId] will be replaced by binding info.
                tag._tgId = "" + id;
            }
        } else {
            // This is a binding marker for a view
            // Add the view to the store of current linked views
            end = "_`";
            addLinkMethods(viewStore[id = view._.id] = view);
        }
        // Example: "#23^TheValue/23^"
        return "#" + id + end
            + (value != undefined ? value : "") // For {^{:name}} this gives the equivalent semantics to compiled
                                                // (v=data.name)!=null?v:""; used in {{:name}} or data-link="name"
            + "/" + id + end;
    }

    //==============================
    // Data-linking and data binding
    //==============================

    //---------------
    // observeAndBind
    //---------------

    function observeAndBind(linkCtx, source, target) { //TODO? linkFnArgs) {;
        var binding, l, linkedElem, exprFnDeps, exprOb,
            tag = linkCtx.tag,
            cvtBk = linkCtx.convertBack,
            depends = [],
            bindId = linkCtx._bndId || "" + bindingKey++,
            handler = linkCtx._hdl;

        linkCtx._bndId = undefined;

        if (tag) {
            // Use the 'depends' paths set on linkCtx.tag - which may have been set on declaration
            // or in events: init, render, onBeforeLink, onAfterLink etc.
            depends = tag.depends || depends;
            depends = $isFunction(depends) ? tag.depends(tag) : depends;
            linkedElem = tag.linkedElem;
        }
        if (!linkCtx._depends || ("" + linkCtx._depends !== "" + depends)) {
            // Only bind the first time, or if the new depends (toString) has changed from when last bound
            if (linkCtx._depends) {
                // Unobserve previous binding
                $observable._apply(false, [source], linkCtx._depends, handler, true);
            }

            exprFnDeps = linkCtx.fn.deps.slice(); // Make a copy of the dependency paths for the compiled linkCtx expression - to pass to observe(). In getInnerCb(),
            // (and whenever the object is updated, in innerCb), we will set exprOb.ob to the current object returned by that computed expression, for this view.
            l = exprFnDeps.length;
            while (l--) {
                exprOb = exprFnDeps[l];
                if (exprOb._jsv) {
                    // This path is an 'exprOb', corresponding to a computed, returning an object. We replace the exprOb by
                    // a view-binding-specific exprOb instance. The current object will be stored as exprOb.ob.
                    exprFnDeps[l] = $extend({}, exprOb);
                }
            }

            binding = $observable._apply(
                false,
                [source],
                exprFnDeps, // flatten the paths - to gather all the dependencies across args and bound params
                depends,
                handler,
                linkCtx._ctxCb);
            // The binding returned by $observe has a bnd array with the source objects of the individual bindings.

            binding.elem = target; // The target of all the individual bindings
            binding.linkCtx = linkCtx;
            binding._tgId = bindId;

            // Add to the _jsvBnd on the target the view id and binding id - for unbinding when the target element is removed
            target._jsvBnd = target._jsvBnd || "";
            target._jsvBnd += "&" + bindId;
            linkCtx._depends = depends;
            // Store the binding key on the view, for disposal when the view is removed
            linkCtx.view._.bnds[bindId] = bindId;
            // Store the binding.
            bindingStore[bindId] = binding; // Note: If this corresponds to a data-linked tag, we are replacing the
            // temporarily stored tag by the stored binding. The tag will now be at binding.linkCtx.tag

            if (linkedElem) {
                binding.to = [[], cvtBk];
            }
            if (linkedElem || cvtBk !== undefined) {
                bindTo(binding, tag, linkedElem && linkedElem[0] || target, cvtBk);
            }
            if (tag) {
                if (tag.onAfterBind) {
                    tag.onAfterBind(binding);
                }
                if (!tag.flow && !tag._.inline) {
                    target.setAttribute(jsvAttrStr, (target.getAttribute(jsvAttrStr) || "") + "#" + bindId + "^/" + bindId + "^");
                    tag._tgId = "" + bindId;
                }
            }
        }
        if (linkedElem && linkedElem[0]) {
            if (tag._.radio) {
                linkedElem = linkedElem.find(RADIOINPUT);
            }

            l = linkedElem.length;
            while (l--) {
                linkedElem[l]._jsvBnd = linkedElem[l]._jsvBnd || (target._jsvBnd + "+");
                // Add a "+" for cloned binding - so removing elems with cloned bindings will not remove the 'parent' binding from the bindingStore.
                linkedElem[l]._jsvLkEl = tag;
            }
        }
    }

    //-------
    // $.link
    //-------

    function tmplLink(to, from, context, noIteration, parentView, prevNode, nextNode) {
        return $link(this, to, from, context, noIteration, parentView, prevNode, nextNode);
    }

    function $link(tmplOrLinkExpr, to, from, context, noIteration, parentView, prevNode, nextNode) {
        // When linking from a template, prevNode and nextNode parameters are ignored

        if (context === true) {
            noIteration = context; // passing boolean as third param - noIteration
            context = undefined;
        } else if (typeof context !== "object") {
            context = undefined; // context must be a boolean (noIteration) or a plain object
        } else {
            context = $extend({}, context);
        }
        if (tmplOrLinkExpr && to) {
            to = to.jquery ? to : $(to); // to is a jquery object or an element or selector

            if (!activeBody) {
                activeBody = document.body;
                $(activeBody)
                    .on(elementChangeStr, elemChangeHandler)
                    .on('blur', '[contenteditable]', elemChangeHandler);
            }

            var i, k, html, vwInfos, view, placeholderParent, targetEl, refresh, topLevelCall,
                onRender = addBindingMarkers,
                replaceMode = context && context.target === "replace",
                l = to.length;

            while (l--) {
                targetEl = to[l];

                parentView = parentView || $view(targetEl);

                if (topLevelCall = parentView === topView) {
                    topView.data = (topView.ctx = context || {}).root = from;
                }
                if ("" + tmplOrLinkExpr === tmplOrLinkExpr) {
                    // tmplOrLinkExpr is a string: treat as data-link expression.
                    addDataBinding(tmplOrLinkExpr, targetEl, parentView, undefined, true, from, context);
                } else {
                    if (tmplOrLinkExpr.markup !== undefined) {
                        // This is a call to template.link()
                        if (replaceMode) {
                            placeholderParent = targetEl.parentNode;
                        }

                        html = tmplOrLinkExpr.render(from, context, noIteration, parentView, undefined, onRender);
                        // TODO Consider finding a way to bind data (link) within template without html being different for each view, the HTML can
                        // be evaluated once outside the while (l--), and pushed into a document fragment, then cloned and inserted at each target.

                        if (placeholderParent) {
                            // This is target="replace" mode
                            prevNode = targetEl.previousSibling;
                            nextNode = targetEl.nextSibling;
                            $.cleanData([targetEl], true);
                            placeholderParent.removeChild(targetEl);

                            targetEl = placeholderParent;
                        } else {
                            prevNode = nextNode = undefined; // When linking from a template, prevNode and nextNode parameters are ignored
                            $(targetEl).empty();
                        }
                    } else if (tmplOrLinkExpr === true && parentView === topView) {
                        // $.link(true, selector, data, ctx) - where selector points to elem in top-level content. (If not top-level content, no-op)
                        refresh = { lnk: 1 };
                    } else {
                        break;
                    }

                    // TODO Consider deferred linking API feature on per-template basis - {@{ instead of {^{ which allows the user to see the rendered content
                    // before that content is linked, with better perceived perf. Have view.link return a deferred, and pass that to onAfterLink...
                    // or something along those lines.
                    // setTimeout(function() {

                    if (targetEl._df && !nextNode) {
                        // We are inserting new content and the target element has some deferred binding annotations,and there is no nextNode.
                        // Those views may be stale views (that will be recreated in this new linking action) so we will first remove them
                        // (if not already removed).
                        vwInfos = viewInfos(targetEl._df, true, rOpenViewMarkers);

                        for (i = 0, k = vwInfos.length; i < k; i++) {
                            view = vwInfos[i];
                            if ((view = viewStore[view.id]) && view.data !== undefined) {
                                // If this is the _prv (prevNode) for a view, remove the view
                                // - unless view.data is undefined, in which case it is already being removed
                                view.parent.removeViews(view._.key, undefined, true);
                            }
                        }
                        setDefer(targetEl); // remove defer tokens
                    }

                    // Link the content of the element, since this is a call to template.link(), or to $(el).link(true, ...),
                    parentView.link(from, targetEl, prevNode, nextNode, html, refresh, context);
                    //}, 0);
                }
                if (topLevelCall) {
                    topView.data = topView.ctx = undefined;
                }
            }
        }
        return to; // Allow chaining, to attach event handlers, etc.
    }

    //----------
    // view.link
    //----------

    function viewLink(outerData, parentNode, prevNode, nextNode, html, refresh, context, validateOnly) {
        // Optionally insert HTML into DOM using documentFragments (and wrapping HTML appropriately).
        // Data-link existing contents of parentNode, or the inserted HTML, if provided

        // Depending on the content model for the HTML elements, the standard data-linking markers inserted in the HTML by addBindingMarkers during
        // template rendering will be converted either to script marker nodes or, for element-only content sections, to data-jsv element annotations.

        // Data-linking will then add _prv and _nxt to views, where:
        //     _prv: References the previous node (script element of type "jsv123"), or (for elCnt=true), the first element node in the view (or if none, set _prv = _nxt)
        //     _nxt: References the last node (script element of type "jsv/123"), or (for elCnt=true), the next element node after the view.

        //==== nested functions ====
        function convertMarkers(all, preceding, selfClose, closeTag, spaceBefore, id, boundId, spaceAfter, tag1, tag2, closeTag2, spaceAfterClose, selfClose2, endOpenTag) {
            // rConvertMarkers = /(^|(\/>)|<\/(\w+)>|)(\s*)([#\/]\d+(?:_|(\^)))`(\s*)(<\w+(?=[\s\/>]))?|\s*(?:(<\w+(?=[\s\/>]))|<\/(\w+)>(\s*)|(\/>)\s*|(>))/g,
            //                 prec, slfCl, clsTag,  spBefore, id,      bndId  spAfter,tag1,                   tag2,               clTag2,sac  slfCl2, endOpenTag
            // Convert the markers that were included by addBindingMarkers in template output, to appropriate DOM annotations:
            // data-jsv attributes (for element-only content) or script marker nodes (within phrasing or flow content).

            // TODO consider detecting 'quoted' contexts (attribute strings) so that attribute encoding does not need to encode >
            // Currently rAttrEncode = /[><"'&]/g includes '>' encoding in order to avoid erroneous parsing of <span title="&lt;a/>"></span>">
            var errorMsg, bndId,
                endOfElCnt = "";
            if (endOpenTag) {
                inTag = 0;
                return all;
            }
            tag = tag1 || tag2 || "";
            closeTag = closeTag || closeTag2;
            selfClose = selfClose || selfClose2;
            if (isVoid && !selfClose && (!all || closeTag || tag || id && !inTag)) { // !all = end of string
                isVoid = undefined;
                parentTag = tagStack.shift(); // preceding tag was a void element, with no closing slash, such as <br>.
            }
            closeTag = closeTag || selfClose;
            if (closeTag) {
                inTag = 0;
                isVoid = undefined;
                // TODO: smart insertion of <tbody> - to be completed for robust insertion of deferred bindings etc.
                //if (closeTag === "table" && parentTag === "tbody") {
                //	preceding = "</tbody>" + preceding;
                //	parentTag = "table";
                //	tagStack.shift();
                //}
                if (validate) {
                    if (selfClose || selfClose2) {
                        if (!voidElems[parentTag] && !/;svg;|;math;/.test(";" + tagStack.join(";") + ";")) {
                            // Only self-closing elements must be legitimate void elements, such as <br/>, per HTML schema,
                            // or under svg or math foreign namespace elements.
                            errorMsg = "'<" + parentTag + ".../";
                        }
                    } else if (voidElems[closeTag]) {
                        errorMsg = "'</" + closeTag; // closing tag such as </input>
                    } else if (!tagStack.length || closeTag !== parentTag) {
                        errorMsg = "Mismatch: '</" + closeTag;
                    }
                    if (errorMsg) {
                        syntaxError(errorMsg + ">' in:\n" + html);
                    }
                }
                prevElCnt = elCnt;
                parentTag = tagStack.shift();
                elCnt = elContent[parentTag];
                closeTag2 = closeTag2 ? ("</" + closeTag2 + ">") : "";
                if (prevElCnt) {
                    // If there are ids (markers since the last tag), move them to the defer string
                    defer += ids;
                    ids = "";
                    if (!elCnt) {
                        endOfElCnt = closeTag2 + openScript + "@" + defer + closeScript + (spaceAfterClose || "");
                        defer = deferStack.shift();
                    } else {
                        defer += "-"; // Will be used for stepping back through deferred tokens
                    }
                }
            }
            if (elCnt) {
                // elContent maps tagNames which have only element content, so may not support script nodes.
                // We are in element-only content, can remove white space, and use data-jsv attributes on elements as markers
                // Example: <tr data-jsv="/2_#6_"> - close marker for view 2 and open marker for view 6

                if (id) {
                    // append marker for this id, to ids string
                    ids += id;
                } else {
                    preceding = (closeTag2 || selfClose2 || "");
                }
                if (tag) {
                    // TODO: smart insertion of <tbody> - to be completed for robust insertion of deferred bindings etc.
                    //if (tag === "<tr" && parentTag === "table") {
                    //	tagStack.unshift(parentTag);
                    //	parentTag = "tbody";
                    //	preceding += "<" + parentTag + ">";
                    //	if (defer) {
                    //		defer += "+"; // Will be used for stepping back through deferred tokens
                    //	}
                    //	// TODO: move this to design-time validation check
                    //	//	error('"' + parentTag + '" has incorrect parent tag');
                    //}
                    preceding += tag;
                    if (ids) {
                        preceding += ' ' + jsvAttrStr + '="' + ids + '"';
                        ids = "";
                    }
                }
            } else {
                // We are in phrasing or flow content, so use script marker nodes
                // Example: <script type="jsv3/"></script> - data-linked tag, close marker
                // We validate with inTag so no script markers are inserted in attribute context e.g. for:
                // "<table {{if ...}}...{{/if}}... >" or "<table {{if ...}}...> ...{{/if}}..."
                preceding = id
                    ? (preceding + endOfElCnt + spaceBefore + (inTag ? "" : openScript + id + closeScript) + spaceAfter + tag)
                    : endOfElCnt || all;
            }

            if (validate && boundId) {
                if (inTag) {
                    // JsViews data-linking tags are not allowed within element markup.
                    // See jsviews/issues/303
                    syntaxError('{^{ within elem markup (' + inTag + ' ). Use data-link="..."');
                }
                if (id.charAt(0) === "#") {
                    tagStack.unshift(id.slice(1));
                } else if (id.slice(1) !== (bndId = tagStack.shift())) {
                    // See jsviews/issues/213
                    syntaxError('Closing tag for {^{...}} under different elem: <' + bndId + '>');
                }
            }
            if (tag) {
                inTag = tag;
                // If there are ids (markers since the last tag), move them to the defer string
                tagStack.unshift(parentTag);
                parentTag = tag.slice(1);
                if (validate && tagStack[0] && tagStack[0] === badParent[parentTag]) {
                    // Missing <tbody>
                    // TODO: replace this by smart insertion of <tbody> tags
                    error('Parent of <tr> must be <tbody>');
                }
                isVoid = voidElems[parentTag];
                if ((elCnt = elContent[parentTag]) && !prevElCnt) {
                    deferStack.unshift(defer);
                    defer = "";
                }
                prevElCnt = elCnt;
                //TODO Consider providing validation which throws if you place <span> as child of <tr>, etc. - since if not caught,
                //this can cause errors subsequently which are difficult to debug.
                //				if (elContent[tagStack[0]]>2 && !elCnt) {
                //					error(parentTag + " in " + tagStack[0]);
                //				}
                if (defer && elCnt) {
                    defer += "+"; // Will be used for stepping back through deferred tokens
                }
            }
            return preceding;
        }

        function processViewInfos(vwInfos, targetParent) {
            // If targetParent, we are processing viewInfos (which may include navigation through '+-' paths) and hooking up to the right parentElem etc.
            // (and elem may also be defined - the next node)
            // If no targetParent, then we are processing viewInfos on newly inserted content
            var deferPath, deferChar, bindChar, parentElem, id, onAftCr, deep,
                addedBindEls = [];

            // In elCnt context (element-only content model), prevNode is the first node after the open, nextNode is the first node after the close.
            // If both are null/undefined, then open and close are at end of parent content, so the view is empty, and its placeholder is the
            // 'lastChild' of the parentNode. If there is a prevNode, then it is either the first node in the view, or the view is empty and
            // its placeholder is the 'previousSibling' of the prevNode, which is also the nextNode.
            if (vwInfos) {
                if (vwInfos._tkns.charAt(0) === "@") {
                    // We are processing newly inserted content. This is a special script element that was created in convertMarkers() to process deferred bindings,
                    // and inserted following the target parent element - because no element tags (outside elCnt) were encountered to carry those binding tokens.
                    // We will step back from the preceding sibling of this element, looking at targetParent elements until we find the one that the current binding
                    // token belongs to. Set elem to null (the special script element), and remove it from the DOM.
                    targetParent = elem.previousSibling;
                    elem.parentNode.removeChild(elem);
                    elem = undefined;
                }
                len = vwInfos.length;
                while (len--) {
                    vwInfo = vwInfos[len];
                    //if (prevIds.indexOf(vwInfo.token) < 0) { // This token is a newly created view or tag binding
                    bindChar = vwInfo.ch;
                    if (deferPath = vwInfo.path) {
                        // We have a 'deferred path'
                        j = deferPath.length - 1;
                        while (deferChar = deferPath.charAt(j--)) {
                            // Use the "+" and"-" characters to navigate the path back to the original parent node where the deferred bindings ocurred
                            if (deferChar === "+") {
                                if (deferPath.charAt(j) === "-") {
                                    j--;
                                    targetParent = targetParent.previousSibling;
                                } else {
                                    targetParent = targetParent.parentNode;
                                }
                            } else {
                                targetParent = targetParent.lastChild;
                            }
                            // Note: Can use previousSibling and lastChild, not previousElementSibling and lastElementChild,
                            // since we have removed white space within elCnt. Hence support IE < 9
                        }
                    }
                    if (bindChar === "^") {
                        if (tag = bindingStore[id = vwInfo.id]) {
                            // The binding may have been deleted, for example in a different handler to an array collectionChange event
                            // This is a tag binding
                            deep = targetParent && (!elem || elem.parentNode !== targetParent); // We are stepping back looking for the right targetParent,
                            // or we are linking existing content and this element is in elCnt, not an immediate child of the targetParent.
                            if (!elem || deep) {
                                tag.parentElem = targetParent;
                            }
                            if (vwInfo.elCnt && deep) {
                                // With element only content, if there is no following element, or if the binding is deeper than the following element
                                // then we need to set the open or close token as a deferred binding annotation on the parent
                                setDefer(targetParent, (vwInfo.open ? "#" : "/") + id + bindChar + (targetParent._df || ""));
                            }
                            // This is an open or close marker for a data-linked tag {^{...}}. Add it to bindEls.
                            addedBindEls.push([deep ? null : elem, vwInfo]);
                        }
                    } else if (view = viewStore[id = vwInfo.id]) {
                        // The view may have been deleted, for example in a different handler to an array collectionChange event
                        if (!view.parentElem) {
                            // If view is not already extended for JsViews, extend and initialize the view object created in JsRender, as a JsViews view
                            view.parentElem = targetParent || elem && elem.parentNode || parentNode;
                            view._.onRender = addBindingMarkers;
                            view._.onArrayChange = arrayChangeHandler;
                            setArrayChangeLink(view);
                        }
                        parentElem = view.parentElem;
                        if (vwInfo.open) {
                            // This is an 'open view' node (preceding script marker node,
                            // or if elCnt, the first element in the view, with a data-jsv annotation) for binding
                            view._elCnt = vwInfo.elCnt;
                            if (targetParent && !elem) {
                                setDefer(targetParent, "#" + id + bindChar + (targetParent._df || ""));
                            } else {
                                // No targetParent, so there is a ._nxt elem (and this is processing tokens on the elem)
                                if (!view._prv) {
                                    setDefer(parentElem, removeSubStr(parentElem._df, "#" + id + bindChar));
                                }
                                view._prv = elem;
                            }
                        } else {
                            // This is a 'close view' marker node for binding
                            if (targetParent && (!elem || elem.parentNode !== targetParent)) {
                                // There is no ._nxt so add token to _df. It is deferred.
                                setDefer(targetParent, "/" + id + bindChar + (targetParent._df || ""));
                                view._nxt = undefined;
                            } else if (elem) {
                                // This view did not have a ._nxt, but has one now, so token may be in _df, and must be removed. (No longer deferred)
                                if (!view._nxt) {
                                    setDefer(parentElem, removeSubStr(parentElem._df, "/" + id + bindChar));
                                }
                                view._nxt = elem;
                            }
                            linkCtx = view.linkCtx;
                            if (onAftCr = view.ctx && view.ctx.onAfterCreate || onAfterCreate) {
                                onAftCr.call(linkCtx, view);
                            }
                        }
                        //}
                    }
                }
                len = addedBindEls.length;
                while (len--) {
                    // These were added in reverse order to addedBindEls. We push them in BindEls in the correct order.
                    bindEls.push(addedBindEls[len]);
                }
            }
            return !vwInfos || vwInfos.elCnt;
        }

        function getViewInfos(vwInfos) {
            // Used by view.childTags() and tag.childTags()
            // Similar to processViewInfos in how it steps through bindings to find tags. Only finds data-linked tags.
            var level, parentTag, named;

            if (vwInfos) {
                len = vwInfos.length;
                for (j = 0; j < len; j++) {
                    vwInfo = vwInfos[j];
                    // This is an open marker for a data-linked tag {^{...}}, within the content of the tag whose id is get.id. Add it to bindEls.
                    // Note - if bindingStore[vwInfo.id]._is === "tag" then getViewInfos is being called too soon - during first linking pass
                    parentTag = tag = bindingStore[vwInfo.id].linkCtx.tag;
                    named = tag.tagName === tagName;
                    if (!tag.flow || named) {
                        if (!deep) {
                            level = 1;
                            while (parentTag = parentTag.parent) {
                                level++;
                            }
                            tagDepth = tagDepth || level; // The level of the first tag encountered.
                        }
                        if ((deep || level === tagDepth) && (!tagName || named)) {
                            // Filter on top-level or tagName as appropriate
                            tags.push(tag);
                        }
                    }
                }
            }
        }

        function dataLink() {
            //================ Data-link and fixup of data-jsv annotations ================
            var j, index,
                tokens = "",
                wrap = {},
                selector = linkViewsSel + (get ? ",[" + deferAttr + "]" : "");
            // If a childTags() call, get = ",[" + deferAttr + "]" - since we need to include elements that have a ._df expando for deferred tokens

            elems = qsa ? parentNode.querySelectorAll(selector) : $(selector, parentNode).get();
            l = elems.length;

            // The prevNode will be in the returned query, since we called markPrevOrNextNode() on it.
            // But it may have contained nodes that satisfy the selector also.
            if (prevNode && prevNode.innerHTML) {
                // Find the last contained node of prevNode, to use as the prevNode - so we only link subsequent elems in the query
                prevNodes = qsa ? prevNode.querySelectorAll(selector) : $(selector, prevNode).get();
                prevNode = prevNodes.length ? prevNodes[prevNodes.length - 1] : prevNode;
            }

            tagDepth = 0;
            for (i = 0; i < l; i++) {
                elem = elems[i];
                if (prevNode && !found) {
                    // If prevNode is set, not false, skip linking. If this element is the prevNode, set to false so subsequent elements will link.
                    found = (elem === prevNode);
                } else if (nextNode && elem === nextNode) {
                    // If nextNode is set then break when we get to nextNode
                    if (get) {
                        tokens += markerNodeInfo(elem);
                    }
                    break;
                } else if (elem.parentNode) {
                    // elem has not been removed from DOM
                    if (get) {
                        tokens += markerNodeInfo(elem);
                        if (elem._df) {
                            j = i + 1;
                            while (j < l && elem.contains(elems[j])) {
                                j++;
                            }
                            // Add defered tokens after any tokens on descendant elements of this one
                            wrap[j - 1] = elem._df;
                        }
                        if (wrap[i]) {
                            tokens += wrap[i] || "";
                        }
                    } else {
                        if (isLink && (vwInfo = viewInfos(elem, undefined, rViewMarkers)) && (vwInfo = vwInfo[0])) {
                            // If this is a link(trueOrString ...) call we will avoid re-binding to elems that are within template-rendered views
                            skip = skip ? (vwInfo.id !== skip && skip) : vwInfo.open && vwInfo.id;
                        }
                        if (!skip && processInfos(viewInfos(elem))
                            // If a link() call, processViewInfos() adds bindings to bindEls, and returns true for non-script nodes, for adding data-link bindings
                            // If a childTags() call, getViewInfos returns array of tag bindings.
                                && elem.getAttribute($viewsLinkAttr)) {
                            bindEls.push([elem]); // A data-linked element so add to bindEls too
                        }
                    }
                }
            }

            if (get) {
                tokens += parentNode._df || "";
                if (index = tokens.indexOf("#" + get.id) + 1) {
                    // We are looking for view.childTags() or tag.childTags() - so start after the open token of the parent view or tag.
                    tokens = tokens.slice(index + get.id.length);
                }
                index = tokens.indexOf("/" + get.id);
                if (index + 1) {
                    // We are looking for view.childTags() or tag.childTags() - so don't look beyond the close token of the parent view or tag.
                    tokens = tokens.slice(0, index);
                }
                // Call getViewInfos to add the found childTags to the tags array
                getViewInfos(viewInfos(tokens, undefined, rOpenTagMarkers));
            }

            if (html === undefined && parentNode.getAttribute($viewsLinkAttr)) {
                bindEls.push([parentNode]); // Support data-linking top-level element directly (not within a data-linked container)
            }

            // Remove temporary marker script nodes they were added by markPrevOrNextNode
            unmarkPrevOrNextNode(prevNode, elCnt);
            unmarkPrevOrNextNode(nextNode, elCnt);

            if (get) {
                if (lazyLink) {
                    lazyLink.resolve();
                }
                return; // We have added childTags to the tags array, so we are done
            }

            if (elCnt && defer + ids) {
                // There are some views with elCnt, for which the open or close did not precede any HTML tag - so they have not been processed yet
                elem = nextNode;
                if (defer) {
                    if (nextNode) {
                        processViewInfos(viewInfos(defer + "+", true), nextNode);
                    } else {
                        processViewInfos(viewInfos(defer, true), parentNode);
                    }
                }
                processViewInfos(viewInfos(ids, true), parentNode);
                // If there were any tokens on nextNode which have now been associated with inserted HTML tags, remove them from nextNode
                if (nextNode) {
                    tokens = nextNode.getAttribute(jsvAttrStr);
                    if (l = tokens.indexOf(prevIds) + 1) {
                        tokens = tokens.slice(l + prevIds.length - 1);
                    }
                    nextNode.setAttribute(jsvAttrStr, ids + tokens);
                }
            }

            //================ Bind the data-linked elements and tags ================
            l = bindEls.length;
            for (i = 0; i < l; i++) {
                elem = bindEls[i];
                linkInfo = elem[1];
                elem = elem[0];
                if (linkInfo) {
                    if (tag = bindingStore[linkInfo.id]) {
                        if (linkCtx = tag.linkCtx) {
                            // The tag may have been stored temporarily on the bindingStore - or may have already been replaced by the actual binding
                            tag = linkCtx.tag;
                            tag.linkCtx = linkCtx;
                        }
                        if (linkInfo.open) {
                            // This is an 'open linked tag' binding annotation for a data-linked tag {^{...}}
                            if (elem) {
                                tag.parentElem = elem.parentNode;
                                tag._prv = elem;
                            }
                            tag._elCnt = linkInfo.elCnt;
                            if (tag.onBeforeLink) {
                                tag.onBeforeLink();
                            }
                            // We data-link depth-first ("on the way in"), which is better for perf - and allows setting parent tags etc.
                            view = tag.tagCtx.view;
                            addDataBinding(undefined, tag._prv, view, linkInfo.id);
                        } else {
                            tag._nxt = elem;
                            if (tag._.unlinked) {
                                // This is a 'close linked tag' binding annotation
                                // Add data binding
                                tagCtx = tag.tagCtx;
                                view = tagCtx.view;
                                callAfterLink(tag);
                            }
                        }
                    }
                } else {
                    // Add data binding for a data-linked element (with data-link attribute)
                    addDataBinding(elem.getAttribute($viewsLinkAttr), elem, $view(elem), undefined, isLink, outerData, context);
                }
            }
            if (lazyLink) {
                lazyLink.resolve();
            }
        }
        //==== /end of nested functions ====

        var inTag, linkCtx, tag, i, l, j, len, elems, elem, view, vwInfo, linkInfo, prevNodes, token, prevView, nextView,
            node, tags, deep, tagName, tagCtx, validate, tagDepth, depth, fragment, copiedNode, firstTag, parentTag,
            isVoid, wrapper, div, tokens, elCnt, prevElCnt, htmlTag, ids, prevIds, found, skip, lazyLink, isLink, get,
            self = this,
            thisId = self._.id + "_",
            defer = "",
            // The marker ids for which no tag was encountered (empty views or final closing markers) which we carry over to container tag
            bindEls = [],
            tagStack = [],
            deferStack = [],
            onAfterCreate = self.hlp(onAfterCreateStr),
            processInfos = processViewInfos;

        if (refresh) {
            lazyLink = refresh.lazyLink && $.Deferred();
            if (refresh.tmpl) {
                // refresh is the prevView, passed in from addViews()
                prevView = "/" + refresh._.id + "_";
            } else {
                isLink = refresh.lnk; // Top-level linking
                if (refresh.tag) {
                    thisId = refresh.tag + "^";
                    refresh = true;
                }
                if (get = refresh.get) {
                    processInfos = getViewInfos;
                    tags = get.tags;
                    deep = get.deep;
                    tagName = get.name;
                }
            }
            refresh = refresh === true;
        }

        parentNode = parentNode
            ? ("" + parentNode === parentNode
                ? $(parentNode)[0]  // It is a string, so treat as selector
                : parentNode.jquery
                    ? parentNode[0] // A jQuery object - take first element.
                    : parentNode)
            : (self.parentElem      // view.link()
                || document.body);  // link(null, data) to link the whole document

        validate = !$subSettingsAdvanced.noValidate && parentNode.contentEditable !== TRUE;
        parentTag = parentNode.tagName.toLowerCase();
        elCnt = !!elContent[parentTag];

        prevNode = prevNode && markPrevOrNextNode(prevNode, elCnt);
        nextNode = nextNode && markPrevOrNextNode(nextNode, elCnt) || null;

        if (html != undefined) {
            //================ Insert html into DOM using documentFragments (and wrapping HTML appropriately). ================
            // Also convert markers to DOM annotations, based on content model.
            // Corresponds to nextNode ? $(nextNode).before(html) : $(parentNode).html(html);
            // but allows insertion to wrap correctly even with inserted script nodes. jQuery version will fail e.g. under tbody or select.
            // This version should also be slightly faster
            div = document.createElement("div");
            wrapper = div;
            prevIds = ids = "";
            htmlTag = parentNode.namespaceURI === "http://www.w3.org/2000/svg" ? "svg_ns" : (firstTag = rFirstElem.exec(html)) && firstTag[1] || "";
            if (elCnt) {
                // Now look for following view, and find its tokens, or if not found, get the parentNode._df tokens
                node = nextNode;
                while (node && !(nextView = viewInfos(node))) {
                    node = node.nextSibling;
                }
                if (tokens = nextView ? nextView._tkns : parentNode._df) {
                    token = prevView || "";
                    if (refresh || !prevView) {
                        token += "#" + thisId;
                    }
                    j = tokens.indexOf(token);
                    if (j + 1) {
                        j += token.length;
                        // Transfer the initial tokens to inserted nodes, by setting them as the ids variable, picked up in convertMarkers
                        prevIds = ids = tokens.slice(0, j);
                        tokens = tokens.slice(j);
                        if (nextView) {
                            node.setAttribute(jsvAttrStr, tokens);
                        } else {
                            setDefer(parentNode, tokens);
                        }
                    }
                }
            }

            //================ Convert the markers to DOM annotations, based on content model. ================
            //			oldElCnt = elCnt;
            isVoid = undefined;
            html = ("" + html).replace(rConvertMarkers, convertMarkers);
            //			if (!!oldElCnt !== !!elCnt) {
            //				error("Parse: " + html); // Parse error. Content not well-formed?
            //			}
            if (validate && tagStack.length) {
                syntaxError("Mismatched '<" + parentTag + "...>' in:\n" + html); // Unmatched tag
            }
            if (validateOnly) {
                return;
            }
            // Append wrapper element to doc fragment
            safeFragment.appendChild(div);

            // Go to html and back, then peel off extra wrappers
            // Corresponds to jQuery $(nextNode).before(html) or $(parentNode).html(html);
            // but supports svg elements, and other features missing from jQuery version (and this version should also be slightly faster)
            htmlTag = wrapMap[htmlTag] || wrapMap.div;
            depth = htmlTag[0];
            wrapper.innerHTML = htmlTag[1] + html + htmlTag[2];
            while (depth--) {
                wrapper = wrapper.lastChild;
            }
            safeFragment.removeChild(div);
            fragment = document.createDocumentFragment();
            while (copiedNode = wrapper.firstChild) {
                fragment.appendChild(copiedNode);
            }
            // Insert into the DOM
            parentNode.insertBefore(fragment, nextNode);
        }

        if (lazyLink) {
            setTimeout(dataLink, 0);
        } else {
            dataLink();
        }

        return lazyLink && lazyLink.promise();
    }

    function addDataBinding(linkMarkup, node, currentView, boundTagId, isLink, data, context) {
        // Add data binding for data-linked elements or {^{...}} data-linked tags
        var tmpl, tokens, attr, convertBack, params, trimLen, tagExpr, linkFn, linkCtx, tag, rTagIndex, hasElse, lastIndex,
            linkExpressions = [];

        if (boundTagId) {
            // boundTagId is a string for {^{...}} data-linked tag. So only one linkTag in linkMarkup
            // data and context parameters are undefined
            tag = bindingStore[boundTagId];
            tag = tag.linkCtx ? tag.linkCtx.tag : tag;

            linkCtx = tag.linkCtx || {
                data: currentView.data,                   // source
                elem: tag._elCnt ? tag.parentElem : node, // target
                view: currentView,
                ctx: currentView.ctx,
                attr: HTML, // Script marker nodes are associated with {^{ and always target HTML.
                fn: tag._.bnd,
                tag: tag,
                // Pass the boundTagId in the linkCtx, so that it can be picked up in observeAndBind
                _bndId: boundTagId
            };
            bindDataLinkTarget(linkCtx, linkCtx.fn);
        } else if (linkMarkup && node) {
            // If isLink then this is a top-level linking: .link(expression, target, data, ....) or
            // .link(true, target, data, ....) scenario - and data and context are passed in separately from the view
            data = isLink ? data : currentView.data;

            // Compiled linkFn expressions could be stored in the tmpl.links array of the template
            // TODO - consider also caching globally so that if {{:foo}} or data-link="foo" occurs in different places,
            // the compiled template for this is cached and only compiled once...
            //links = currentView.links || currentView.tmpl.links;

            tmpl = currentView.tmpl;

            //			if (!(linkTags = links[linkMarkup])) {
            // This is the first time this view template has been linked, so we compile the data-link expressions, and store them on the template.

            linkMarkup = normalizeLinkTag(linkMarkup, defaultAttr(node));
            lastIndex = rTagDatalink.lastIndex = 0;
            while (tokens = rTagDatalink.exec(linkMarkup)) { // TODO require } to be followed by whitespace or $, and remove the \}(!\}) option.
                linkExpressions.push(tokens);
                lastIndex = rTagDatalink.lastIndex;
            }
            if (lastIndex < linkMarkup.length) {
                syntaxError(linkMarkup);
            }
            while (tokens = linkExpressions.shift()) {
                // Iterate over the data-link expressions, for different target attrs,
                // e.g. <input data-link="{:firstName:} title{>~description(firstName, lastName)}"
                // tokens: [all, attr, bindOnly, tagExpr, tagName, converter, colon, html, comment, code, params]
                rTagIndex = rTagDatalink.lastIndex;
                attr = tokens[1];
                tagExpr = tokens[3];
                while (linkExpressions[0] && linkExpressions[0][4] === "else") { // If this is {someTag...} and is followed by an {else...} add to tagExpr
                    tagExpr += "}{" + linkExpressions.shift()[3];
                    hasElse = true;
                }
                if (hasElse) { // If an {else} has been added, need also to add closing {{/someTag}}
                    tagExpr += "}{{/" + tokens[4] + "}";
                }
                params = tokens[9];

                linkCtx = {
                    data: data, // source
                    elem: node, // target
                    view: currentView,
                    ctx: context,
                    attr: attr,
                    isLk: isLink, // top-level linking?
                    _toLk: 1, // Flag to data-link on initial data-link call rendering call
                    _noUpd: tokens[2] // Flag for data-link="^{...}" so on initial data-link call will bind, but not render)
                };

                convertBack = undefined;
                if (tokens[6]) {
                    convertBack = tokens[10] || undefined;
                    linkCtx.convert = tokens[5] || "";
                    if (!attr && convertBack !== undefined && defaultAttr(node)) {
                        // Default target, so allow 2 way binding
                        linkCtx.convertBack = convertBack = convertBack.slice(1);
                    }
                }
                // Compile the linkFn expression which evaluates and binds a data-link expression
                // TODO - optimize for the case of simple data path with no conversion, helpers, etc.:
                //     i.e. data-link="a.b.c". Avoid creating new instances of Function every time. Can use a default function for all of these...

                linkCtx.expr = attr + tagExpr;
                linkFn = tmpl.links[tagExpr];
                if (!linkFn) {
                    tmpl.links[tagExpr] = linkFn = $sub.tmplFn(tagExpr, tmpl, true, convertBack, hasElse);
                }
                linkCtx.fn = linkFn;
                bindDataLinkTarget(linkCtx, linkFn);
                // We store rTagIndex in local scope, since this addDataBinding method can sometimes be called recursively,
                // and each is using the same rTagDatalink instance.
                rTagDatalink.lastIndex = rTagIndex;
            }
            //		}
        }
    }

    function bindDataLinkTarget(linkCtx, linkFn) {
        // Add data link bindings for a link expression in data-link attribute markup
        function handler(ev, eventArgs) {
            propertyChangeHandler.call(linkCtx, ev, eventArgs, linkFn);
            // If the link expression uses a custom tag, the propertyChangeHandler call will call renderTag, which will set tagCtx on linkCtx
        }
        handler.noArray = true;
        if (linkCtx.isLk) {
            // Top-level linking: .link(expressionOrTrue, data, context) - so we need to create a view for the linking, with the data and ctx
            // which may be different than the current context of the target. Note that this view is not a standard data-linked view, so it will
            // be disposed only when its parent view is disposed.
            addLinkMethods(linkCtx.view = new $sub.View(
                $sub.extendCtx(linkCtx.ctx, linkCtx.view.ctx),
                "link", linkCtx.view, linkCtx.data, linkCtx.expr, undefined, addBindingMarkers));
        }
        linkCtx._ctxCb = getContextCb(linkCtx.view); // _ctxCb is for filtering/appending to dependency paths: function(path, object) { return [(object|path)*]}
        linkCtx._hdl = handler;
        // handler._ctx = linkCtx; Could pass linkCtx for use in a depends = function() {} call, so depends is different for different linkCtx's
        handler(true);
    }

    //=====================
    // Data-linking helpers
    //=====================

    function removeSubStr(str, substr) {
        var k;
        return str
            ? (k = str.indexOf(substr),
                (k + 1
                    ? str.slice(0, k) + str.slice(k + substr.length)
                    : str))
            : "";
    }

    function markerNodeInfo(node) {
        return node &&
            ("" + node === node
                ? node
                : node.tagName === SCRIPT
                    ? node.type.slice(3)
                    : node.nodeType === 1 && node.getAttribute(jsvAttrStr) || "");
    }

    function viewInfos(node, isVal, rBinding) {
        // Test whether node is a script marker node, and if so, return metadata
        function getInfos(all, open, close, id, ch, elPath) {
            infos.push({
                elCnt: elCnt,
                id: id,
                ch: ch,
                open: open,
                close: close,
                path: elPath,
                token: all
            });
        }
        var elCnt, tokens,
            infos = [];
        if (tokens = isVal ? node : markerNodeInfo(node)) {
            elCnt = infos.elCnt = node.tagName !== SCRIPT;
            elCnt = tokens.charAt(0) === "@" || elCnt;
            infos._tkns = tokens;
            // rMarkerTokens = /(?:(#)|(\/))(\d+)([_^])([-+@\d]+)?/g;
            tokens.replace(rBinding || rMarkerTokens, getInfos);
            return infos;
        }
    }

    function unmarkPrevOrNextNode(node, elCnt) {
        if (node) {
            if (node.type === "jsv") {
                node.parentNode.removeChild(node);
            } else if (elCnt && node.getAttribute($viewsLinkAttr) === "") {
                node.removeAttribute($viewsLinkAttr);
            }
        }
    }

    function markPrevOrNextNode(node, elCnt) {
        var marker = node;
        while (elCnt && marker && marker.nodeType !== 1) {
            marker = marker.previousSibling;
        }
        if (marker) {
            if (marker.nodeType !== 1) {
                // For text nodes, we will add a script node before
                marker = document.createElement(SCRIPT);
                marker.type = "jsv";
                node.parentNode.insertBefore(marker, node);
            } else if (!markerNodeInfo(marker) && !marker.getAttribute($viewsLinkAttr)) {
                // For element nodes, we will add a data-link attribute (unless there is already one)
                // so that this node gets included in the node linking process.
                marker.setAttribute($viewsLinkAttr, "");
            }
        }
        return marker;
    }

    function normalizeLinkTag(linkMarkup, twoway) {
        linkMarkup = $.trim(linkMarkup).replace(rEscapeQuotes, "\\$&");
        return linkMarkup.slice(-1) !== delimCloseChar0
        // If simplified syntax is used: data-link="expression", convert to data-link="{:expression}",
        // or for inputs, data-link="{:expression:}" for (default) two-way binding
            ? linkMarkup = delimOpenChar1 + ":" + linkMarkup + (twoway ? ":" : "") + delimCloseChar0
            : linkMarkup;
    }

    //===========================
    // Methods for views and tags
    //===========================

    function callAfterLink(tag, eventArgs) {
        var $linkedElem, linkedElem, radioButtons, val, l, linkedTag, oldTrig, newTrig,
            tagCtx = tag.tagCtx,
            view = tagCtx.view,
            props = tagCtx.props,
            linkCtx = tag.linkCtx = tag.linkCtx || {
                tag: tag,
                data: view.data,
                view: view,
                ctx: view.ctx
            };

        if (tag.onAfterLink) {
            tag.onAfterLink(tagCtx, linkCtx, eventArgs);
        }
        tag._.unlinked = undefined;
        $linkedElem = tag.targetTag ? tag.targetTag.linkedElem : tag.linkedElem;
        if (!tag.noVal && (linkedElem = $linkedElem && $linkedElem[0])) {
            if (radioButtons = tag._.radio) {
                $linkedElem = $linkedElem.find(RADIOINPUT);
            }
            if (radioButtons || !tag._.chging) {
                val = tag.cvtArgs()[0];

                if (radioButtons || linkedElem !== linkCtx.elem) {
                    l = $linkedElem.length;
                    while (l--) {
                        linkedElem = $linkedElem[l];
                        linkedTag = linkedElem._jsvLkEl;
                        if (tag._.inline && (!linkedTag || linkedTag !== tag && linkedTag.targetTag !== tag)) {
                            // For data-linked tags, identify the linkedElem with the tag, for "to" binding
                            // (For data-linked elements, if not yet bound, we identify later when the linkCtx.elem is bound)
                            linkedElem._jsvLkEl = tag;
                            bindTo(bindingStore[tag._tgId], tag, linkedElem);
                            linkedElem._jsvBnd = "&" + tag._tgId + "+"; // Add a "+" for cloned binding - so removing
                            // elems with cloned bindings will not remove the 'parent' binding from the bindingStore.
                        }
                        if (radioButtons) {
                            // For radio button, set to if val === value. For others set val() to val, below
                            linkedElem[CHECKED] = val === linkedElem.value;
                        }
                    }
                    linkCtx._val = val;
                }
                if (val !== undefined) {
                    if (!radioButtons && linkedElem.value !== undefined) {
                        if (linkedElem.type === CHECKBOX) {
                            linkedElem[CHECKED] = val && val !== "false";
                        } else {
                            $linkedElem.val(val);
                        }
                    } else if (linkedElem.contentEditable === TRUE) {
                        linkedElem.innerHTML = val;
                    }
                }
            }
            if (tag.setSize) {
                if (props.height) {
                    $linkedElem.height(props.height);
                }
                if (props.width) {
                    $linkedElem.width(props.width);
                }
            }
            if (props["class"]) {
                $linkedElem.addClass(props["class"]);
            }
            if (props.id) {
                $linkedElem[0].id = props.id;
            }
            if (props.name) {
                $linkedElem.attr("name", props.name);
            }
        }
    }

    function asyncElemChangeHandler(ev) {
        setTimeout(function () {
            elemChangeHandler(ev);
        }, 0);
    }

    function bindElChange($elem, trig, onoff) {
        if (trig) {
            trig = "" + trig === trig ? trig : "keydown"; // Set trigger to (true || truey non-string (e.g. 1) || 'keydown'): Get 'keydown' with async
            $elem[onoff](trig, trig === "keydown" ? asyncElemChangeHandler : elemChangeHandler);
        }
    }

    function bindTo(binding, tag, linkedElem, cvtBk) {
        // Two-way binding.
        // We set the binding.to[1] to be the cvtBack, and binding.to[0] to be either the path to the target, or [object, path] where the target is the path on the provided object.
        // So for a computed path with an object call: a.b.getObject().d.e, then we set to[0] to be [exprOb, "d.e"], and we bind to the path on the returned object, exprOb.ob, as target
        // Otherwise our target is the first path, paths[0], which we will convert with contextCb() for paths like ~a.b.c or #x.y.z

        var bindto, pathIndex, path, lastPath, bindtoOb, $linkedElem, newTrig, oldTrig,
            linkCtx = binding.linkCtx,
            source = linkCtx.data,
            paths = linkCtx.fn.paths;

        if (binding && paths) {
            oldTrig = linkedElem._jsvTr;
            newTrig = $subSettings.trigger;
            if (tag) {
                cvtBk = tag.convertBack || cvtBk;
                newTrig = tag.tagCtx.props.trigger || newTrig;
            }
            if (oldTrig !== newTrig) {
                linkedElem._jsvTr = newTrig;
                $linkedElem = $(linkedElem);
                bindElChange($linkedElem, oldTrig, "off");
                bindElChange($linkedElem, newTrig, "on");
            }

            paths = (bindto = paths._jsvto) || paths[0];
            pathIndex = paths && paths.length;
            if (pathIndex && (!tag || tag.tagCtx.args.length)) {
                lastPath = paths[pathIndex - 1];
                if (lastPath._jsv) {
                    bindtoOb = lastPath;
                    while (lastPath.sb && lastPath.sb._jsv) {
                        path = lastPath = lastPath.sb;
                    }
                    path = lastPath.sb || path && path.path;
                    lastPath = path ? path.slice(1) : bindtoOb.path;
                }
                binding.to = path
                    ? [ // "...someexpr().lastpath..." - so need to get the bindtoOb 'exprOb' object for this view-binding
                        [
                            bindtoOb, // 'exprOb' for this expression and view-binding. So bindtoOb.ob is current object returned by expression.
                            lastPath
                        ],
                        cvtBk
                    ]
                    : [
                        linkCtx._ctxCb(path = lastPath.split("^").join(".")) || [source, path],
                        cvtBk
                    ];
            } else {
                binding.to = [[], cvtBk];
            }
        }
    }

    function mergeCtxs(tag, newCtxs, replace) { // Merge updated tagCtxs into tag.tagCtxs
        var tagCtx, newTagCtx,
            view = tag.tagCtx.view,
            tagCtxs = tag.tagCtxs || [tag.tagCtx],
            l = tagCtxs.length,
            refresh = !newCtxs;

        newCtxs = newCtxs || tag._.bnd.call(view.tmpl, (tag.linkCtx || view).data, view, $sub);

        if (replace) {
            // Replace previous tagCtxs by new ones, rather than merging
            tagCtxs = tag.tagCtxs = newCtxs;
            tag.tagCtx = tagCtxs[0];
        } else {
            while (l--) {
                tagCtx = tagCtxs[l];
                newTagCtx = newCtxs[l];
                $observable(tagCtx.props).setProperty(newTagCtx.props);
                $extend(tagCtx.ctx, newTagCtx.ctx); // We don't support propagating ctx variables, ~foo, observably, to nested views. So extend, not setProperty...
                tagCtx.args = newTagCtx.args;
                if (refresh) {
                    tagCtx.tmpl = newTagCtx.tmpl;
                }
            }
        }
        $sub._ths(tag, tagCtxs[0]); // tagHandlersFromProps
        return tagCtxs;
    }

    //=========
    // Disposal
    //=========

    function clean(elems) {
        // Remove data-link bindings, or contained views
        var l, elem, bindings,
            elemArray = [],
            len = elems.length,
            i = len;
        while (i--) {
            // Copy into an array, so that deletion of nodes from DOM will not cause our 'i' counter to get shifted
            // (Note: This seems as fast or faster than elemArray = [].slice.call(elems); ...)
            elemArray.push(elems[i]);
        }
        i = len;
        while (i--) {
            elem = elemArray[i];
            if (elem.parentNode) {
                // Has not already been removed from the DOM
                if (bindings = elem._jsvBnd) {
                    // Get propertyChange bindings for this element
                    // This may be an element with data-link, or the opening script marker node for a data-linked tag {^{...}}
                    // bindings is a string with the syntax: "(&bindingId)*"
                    bindings = bindings.slice(1).split("&");
                    elem._jsvBnd = "";
                    l = bindings.length;
                    while (l--) {
                        // Remove associated bindings
                        removeViewBinding(bindings[l], elem._jsvLkEl, elem); // unbind bindings with this bindingId on this view
                    }
                }
                disposeTokens(markerNodeInfo(elem) + (elem._df || ""));
            }
        }
    }

    function removeViewBinding(bindId, linkedElemTag, elem) {
        // Unbind
        var objId, linkCtx, tag, object, obsId, tagCtxs, l, map, $linkedElem, linkedElem, trigger, view,
            binding = bindingStore[bindId];

        if (linkedElemTag) {
            if (elem === linkedElemTag.linkedElem[0]) {
                elem._jsvLkEl = undefined;
                linkedElemTag.linkedElem = undefined;
            }
        } else if (binding) {
            delete bindingStore[bindId]; // Delete already, so call to onDispose handler below cannot trigger recursive deletion (through recursive call to jQuery cleanData)
            for (objId in binding.bnd) {
                object = binding.bnd[objId];
                obsId = binding.cbId;
                if ($isArray(object)) {
                    $([object]).off(arrayChangeStr + obsId).off(propertyChangeStr + obsId); // There may be either or both of arrayChange and propertyChange
                } else {
                    $(object).off(propertyChangeStr + obsId);
                }
                delete binding.bnd[objId];
            }

            if (linkCtx = binding.linkCtx) {
                if (tag = linkCtx.tag) {
                    if (tagCtxs = tag.tagCtxs) {
                        l = tagCtxs.length;
                        while (l--) {
                            if (map = tagCtxs[l].map) {
                                map.unmap(); //unobserve
                            }
                        }
                    }
                    $linkedElem = tag.linkedElem;
                    linkedElem = $linkedElem && $linkedElem[0] || linkCtx.elem;

                    if (trigger = linkedElem && linkedElem._jsvTr) {
                        bindElChange($linkedElem || $(linkedElem), trigger, "off");
                        linkedElem._jsvTr = undefined;
                    }

                    if (tag.onDispose) {
                        tag.onDispose();
                    }

                    if (!tag._elCnt) {
                        if (tag._prv) {
                            tag._prv.parentNode.removeChild(tag._prv);
                        }
                        if (tag._nxt) {
                            tag._nxt.parentNode.removeChild(tag._nxt);
                        }
                    }
                }
                view = linkCtx.view;
                if (view.type === "link") {
                    view.parent.removeViews(view._.key, undefined, true); // A "link" view is associated with the binding, so should be disposed with binding.
                } else {
                    delete view._.bnds[bindId];
                }
            }
            delete cbBindingsStore[binding.cbId];
        }
    }

    function $unlink(to) {
        if (to) {
            to = to.jquery ? to : $(to);
            to.each(function () {
                var innerView;
                //TODO fix this for better perf. Rather that calling inner view multiple times which does querySelectorAll each time, consider a single querySelectorAll
                // or simply call view.removeViews() on the top-level views under the target 'to' node, then clean(...)
                while ((innerView = $view(this, true)) && innerView.parent) {
                    innerView.parent.removeViews(innerView._.key, undefined, true);
                }
                clean(this.getElementsByTagName("*"));
            });
            clean(to);
        } else {
            // Call to $.unlink() is equivalent to $.unlink(true, "body")
            if (activeBody) {
                $(activeBody)
                    .off(elementChangeStr, elemChangeHandler)
                    .off('blur', '[contenteditable]', elemChangeHandler);
                activeBody = undefined;
            }
            topView.removeViews();
            clean(document.body.getElementsByTagName("*"));
        }
    }

    //========
    // Helpers
    //========

    function getContextCb(view) {
        // TODO Consider exposing or allowing override, as public API
        return function (path, object) {
            // TODO consider only calling the contextCb on the initial token in path '~a.b.c' and not calling again on
            // the individual tokens, 'a', 'b', 'c'... Currently it is called multiple times
            var tokens, tag,
                items = [object];
            if (view && path) {
                if (path._jsv) {
                    return path._jsv.call(view.tmpl, object, view, $sub);
                }
                if (path.charAt(0) === "~") {
                    // We return new items to insert into the sequence, replacing the "~a.b.c" string:
                    // [helperObject 'a', "a.b.c" currentDataItem] so currentDataItem becomes the object for subsequent paths.
                    if (path.slice(0, 4) === "~tag") {
                        tag = view.ctx;
                        if (path.charAt(4) === ".") {
                            // "~tag.xxx"
                            tokens = path.slice(5).split(".");
                            tag = tag.tag;
                        }
                        if (tokens) {
                            return tag ? [tag, tokens.join("."), object] : [];
                        }
                    }
                    path = path.slice(1).split(".");
                    if (object = view.hlp(path.shift())) {
                        if (path.length) {
                            items.unshift(path.join("."));
                        }
                        items.unshift(object);
                    }
                    return object ? items : [];
                }
                if (path.charAt(0) === "#") {
                    // We return new items to insert into the sequence, replacing the "#a.b.c" string: [view, "a.b.c" currentDataItem]
                    // so currentDataItem becomes the object for subsequent paths. The 'true' flag makes the paths bind only to leaf changes.
                    return path === "#data" ? [] : [view, path.replace(rViewPath, ""), object];
                }
            }
        };
    }

    function inputAttrib(elem) {
        return elem.type === CHECKBOX ? elem[CHECKED] : elem.value;
    }

    //========================== Initialize ==========================

    //=====================
    // JsRender integration
    //=====================

    $sub.onStore.template = function (name, item) {
        item.link = tmplLink;
        if (name) {
            $.link[name] = function () {
                return tmplLink.apply(item, arguments);
            };
        }
    };

    $sub.viewInfos = viewInfos; // Expose viewInfos() as public helper method

    // Define JsViews version of delimiters(), and initialize
    ($viewsSettings.delimiters = function () {
        // Run delimiters initialization in context of jsrender.js
        var ret = oldJsvDelimiters.apply(0, arguments);

        if (oldJsvDelimiters !== $viewsDelimiters) {
            // If JsRender was loaded before JsViews, then need also to initialize and set globals in that JsRender instance
            ret = $viewsDelimiters.apply(0, arguments);
        }

        // Data-linking must use new delimiters
        rTagDatalink = new RegExp("(?:^|\\s*)([\\w-]*)(\\" + linkChar + ")?(\\" + delimOpenChar1 + $sub.rTag + "(:\\w*)?\\" + delimCloseChar0 + ")", "g");
        return ret;
    })(); // jshint ignore:line

    $sub.addSetting("trigger");

    //====================================
    // Additional members for linked views
    //====================================

    function transferViewTokens(prevNode, nextNode, parentElem, id, viewOrTagChar, refresh) {
        // Transfer tokens on prevNode of viewToRemove/viewToRefresh to nextNode or parentElem._df
        var i, l, vwInfos, vwInfo, viewOrTag, viewId, tokens,
            precedingLength = 0,
            emptyView = prevNode === nextNode;

        if (prevNode) {
            // prevNode is either the first node in the viewOrTag, or has been replaced by the vwInfos tokens string
            vwInfos = viewInfos(prevNode) || [];
            for (i = 0, l = vwInfos.length; i < l; i++) {
                // Step through views or tags on the prevNode
                vwInfo = vwInfos[i];
                viewId = vwInfo.id;
                if (viewId === id && vwInfo.ch === viewOrTagChar) {
                    if (refresh) {
                        // This is viewOrTagToRefresh, this is the last viewOrTag to process...
                        l = 0;
                    } else {
                        // This is viewOrTagToRemove, so we are done...
                        break;
                    }
                }
                if (!emptyView) {
                    viewOrTag = vwInfo.ch === "_"
                        ? viewStore[viewId]
                        : bindingStore[viewId].linkCtx.tag;
                    if (vwInfo.open) {
                        // A "#m" token
                        viewOrTag._prv = nextNode;
                    } else if (vwInfo.close) {
                        // A "/m" token
                        viewOrTag._nxt = nextNode;
                    }
                }
                precedingLength += viewId.length + 2;
            }

            if (precedingLength) {
                prevNode.setAttribute(jsvAttrStr, prevNode.getAttribute(jsvAttrStr).slice(precedingLength));
            }
            tokens = nextNode ? nextNode.getAttribute(jsvAttrStr) : parentElem._df;
            if (l = tokens.indexOf("/" + id + viewOrTagChar) + 1) {
                tokens = vwInfos._tkns.slice(0, precedingLength) + tokens.slice(l + (refresh ? -1 : id.length + 1));
            }
            if (tokens) {
                if (nextNode) {
                    // If viewOrTagToRemove was an empty viewOrTag, we will remove both #n and /n
                    // (and any intervening tokens) from the nextNode (=== prevNode)
                    // If viewOrTagToRemove was not empty, we will take tokens preceding #n from prevNode,
                    // and concatenate with tokens following /n on nextNode
                    nextNode.setAttribute(jsvAttrStr, tokens);
                } else {
                    setDefer(parentElem, tokens);
                }
            }
        } else {
            // !prevNode, so there may be a deferred nodes token on the parentElem. Remove it.
            setDefer(parentElem, removeSubStr(parentElem._df, "#" + id + viewOrTagChar));
            if (!refresh && !nextNode) {
                // If this viewOrTag is being removed, and there was no .nxt, remove closing token from deferred tokens
                setDefer(parentElem, removeSubStr(parentElem._df, "/" + id + viewOrTagChar));
            }
        }
    }

    function disposeTokens(tokens) {
        var i, l, vwItem, vwInfos;
        if (vwInfos = viewInfos(tokens, true, rOpenMarkers)) {
            for (i = 0, l = vwInfos.length; i < l; i++) {
                vwItem = vwInfos[i];
                if (vwItem.ch === "_") {
                    if ((vwItem = viewStore[vwItem.id]) && vwItem.type) {
                        // If this is the _prv (prevNode) for a view, remove the view
                        // - unless view.type is undefined, in which case it is already being removed
                        vwItem.parent.removeViews(vwItem._.key, undefined, true);
                    }
                } else {
                    removeViewBinding(vwItem.id); // unbind bindings with this bindingId on this view
                }
            }
        }
    }

    //====================================
    // Add link methods to data-linked view or tag
    //====================================
    function addLinkMethods(tagOrView, isTag) {

        tagOrView.contents = function (deep, select) {
            // For a view or a tag, return jQuery object with the content nodes,
            if (deep !== !!deep) {
                // deep not boolean, so this is contents(selector)
                select = deep;
                deep = undefined;
            }
            var filtered,
                nodes = $(this.nodes());
            if (nodes[0]) {
                filtered = select ? nodes.filter(select) : nodes;
                nodes = deep && select ? filtered.add(nodes.find(select)) : filtered;
            }
            return nodes;
        };

        tagOrView.nodes = function (withMarkers, prevNode, nextNode) {
            // For a view or a tag, return top-level nodes
            // Do not return any script marker nodes, unless withMarkers is true
            // Optionally limit range, by passing in prevNode or nextNode parameters

            var node,
                self = this,
                elCnt = self._elCnt,
                prevIsFirstNode = !prevNode && elCnt,
                nodes = [];

            prevNode = prevNode || self._prv;
            nextNode = nextNode || self._nxt;

            node = prevIsFirstNode
                ? (prevNode === self._nxt
                    ? self.parentElem.lastSibling
                    : prevNode)
                : (self._.inline === false
                    ? prevNode || self.linkCtx.elem.firstChild
                    : prevNode && prevNode.nextSibling);

            while (node && (!nextNode || node !== nextNode)) {
                if (withMarkers || elCnt || node.tagName !== SCRIPT) {
                    // All the top-level nodes in the view
                    // (except script marker nodes, unless withMarkers = true)
                    // (Note: If a script marker node, viewInfo.elCnt undefined)
                    nodes.push(node);
                }
                node = node.nextSibling;
            }
            return nodes;
        };

        tagOrView.childTags = function (deep, tagName) {
            // For a view or a tag, return child tags - at any depth, or as immediate children only.
            if (deep !== !!deep) {
                // deep not boolean, so this is childTags(tagName) - which looks for top-level tags of given tagName
                tagName = deep;
                deep = undefined;
            }

            var self = this,
                view = self.link ? self : self.tagCtx.view, // this may be a view or a tag. If a tag, get the view from tag.view.tagCtx
                prevNode = self._prv,
                elCnt = self._elCnt,
                tags = [];

            view.link(
                undefined,
                self.parentElem,
                elCnt ? prevNode && prevNode.previousSibling : prevNode,
                self._nxt,
                undefined,
                {
                    get: {
                        tags: tags,
                        deep: deep,
                        name: tagName,
                        id: self.link ? self._.id + "_" : self._tgId + "^"
                    }
                }
            );
            return tags;
        };

        tagOrView.refresh = function (sourceValue) {
            var promise, attr,
                tag = this,
                linkCtx = tag.linkCtx,
                view = tag.tagCtx.view;

            if (tag.disposed) { error("Removed tag"); }
            if (sourceValue === undefined) {
                sourceValue = $sub._tag(tag, view, view.tmpl, mergeCtxs(tag), true); // Get rendered HTML for tag, based on refreshed tagCtxs
            }
            if (sourceValue + "" === sourceValue) {
                // If no rendered content, sourceValue will not be a string (can be 0 or undefined)
                attr = tag._.inline ? HTML : (linkCtx.attr || defaultAttr(tag.parentElem, true));
                promise = updateContent(sourceValue, linkCtx, attr, tag);
            }

            callAfterLink(tag);
            return promise || tag;
        };

        tagOrView.update = function (value) {
            var linkedElem = this.linkedElem;
            if (linkedElem) {
                elemChangeHandler({
                    target: linkedElem[0]
                }, undefined, value);
            }
        };

        if (isTag) {
            // This is a TAG
            tagOrView.domChange = function () { // domChange notification support
                var elem = this.parentElem,
                    hasListener = $.hasData(elem) && $._data(elem).events,
                    domChangeNotification = "jsv-domchange";

                if (hasListener && hasListener[domChangeNotification]) {
                    // Only trigger handler if there is a handler listening for this event. (Note using triggerHandler - so no event bubbling.)
                    $(elem).triggerHandler(domChangeNotification, arguments);
                }
            };
        } else {
            // This is a VIEW
            // Note: a linked view will also, after linking have nodes[], _prv (prevNode), _nxt (nextNode) ...
            tagOrView.addViews = function (index, dataItems, tmpl) {
                // if view is not an array view, do nothing
                var i, viewsCount,
                    self = this,
                    itemsCount = dataItems.length,
                    views = self.views;

                if (!self._.useKey && itemsCount && (tmpl = self.tmpl)) {
                    // view is of type "array"
                    // Use passed-in template if provided, since self added view may use a different template than the original one used to render the array.
                    viewsCount = views.length + itemsCount;

                    if (viewsCount === self.data.length // If views not already synced to array (e.g. triggered by array.length propertyChange - jsviews/issues/301)
                            && renderAndLink(self, index, tmpl, views, dataItems, self.ctx) !== false) {
                        for (i = index + itemsCount; i < viewsCount; i++) {
                            $observable(views[i]).setProperty("index", i);
                            // This is fixing up index, but not key, and not index on child views. From child views, use view.getIndex()
                        }
                    }
                }
                return self;
            };

            tagOrView.removeViews = function (index, itemsCount, keepNodes) {
                // view.removeViews() removes all the child views
                // view.removeViews(index) removes the child view with specified index or key
                // view.removeViews(index, count) removes the specified nummber of child views, starting with the specified index
                function removeView(index) {
                    var id, bindId, parentElem, prevNode, nextNode, nodesToRemove,
                        viewToRemove = views[index];

                    if (viewToRemove && viewToRemove.link) {
                        id = viewToRemove._.id;
                        if (!keepNodes) {
                            // Remove the HTML nodes from the DOM, unless they have already been removed, including nodes of child views
                            nodesToRemove = viewToRemove.nodes();
                        }

                        // Remove child views, without removing nodes
                        viewToRemove.removeViews(undefined, undefined, true);

                        viewToRemove.type = undefined; // Set type to undefined: used as a flag that this view is being removed
                        prevNode = viewToRemove._prv;
                        nextNode = viewToRemove._nxt;
                        parentElem = viewToRemove.parentElem;
                        // If prevNode and nextNode are the same, the view is empty
                        if (!keepNodes) {
                            // Remove the HTML nodes from the DOM, unless they have already been removed, including nodes of child views
                            if (viewToRemove._elCnt) {
                                // if keepNodes is false (and transferring of tokens has not already been done at a higher level)
                                // then transfer tokens from prevNode which is being removed, to nextNode.
                                transferViewTokens(prevNode, nextNode, parentElem, id, "_");
                            }
                            $(nodesToRemove).remove();
                        }
                        if (!viewToRemove._elCnt) {
                            try {
                                prevNode.parentNode.removeChild(prevNode); // (prevNode.parentNode is parentElem, except if jQuery Mobile or similar has inserted an intermediate wrapper
                                nextNode.parentNode.removeChild(nextNode);
                            } catch (e) { }
                        }
                        setArrayChangeLink(viewToRemove);
                        for (bindId in viewToRemove._.bnds) {
                            removeViewBinding(bindId);
                        }
                        delete viewStore[id];
                    }
                }

                var current, view, viewsCount,
                    self = this,
                    isArray = !self._.useKey,
                    views = self.views;

                if (isArray) {
                    viewsCount = views.length;
                }
                if (index === undefined) {
                    // Remove all child views
                    if (isArray) {
                        // views and data are arrays
                        current = viewsCount;
                        while (current--) {
                            removeView(current);
                        }
                        self.views = [];
                    } else {
                        // views and data are objects
                        for (view in views) {
                            // Remove by key
                            removeView(view);
                        }
                        self.views = {};
                    }
                } else {
                    if (itemsCount === undefined) {
                        if (isArray) {
                            // The parentView is data array view.
                            // Set itemsCount to 1, to remove this item
                            itemsCount = 1;
                        } else {
                            // Remove child view with key 'index'
                            removeView(index);
                            delete views[index];
                        }
                    }
                    if (isArray && itemsCount
                        && viewsCount - itemsCount === self.data.length) { // If views not already synced to array (e.g. triggered by array.length propertyChange - jsviews/issues/301)
                        current = index + itemsCount;
                        // Remove indexed items (parentView is data array view);
                        while (current-- > index) {
                            removeView(current);
                        }
                        views.splice(index, itemsCount);
                        if (viewsCount = views.length) {
                            // Fixup index on following view items...
                            while (index < viewsCount) {
                                $observable(views[index]).setProperty("index", index++);
                            }
                        }
                    }
                }
                return this;
            };

            tagOrView.refresh = function () {
                var self = this,
                    parent = self.parent;

                if (parent) {
                    renderAndLink(self, self.index, self.tmpl, parent.views, self.data, undefined, true);
                    setArrayChangeLink(self);
                }
                return self;
            };

            tagOrView.link = viewLink;
        }
    }

    //========================
    // JsViews-specific converters
    //========================

    $converters.merge = function (val) {
        // Special converter used in data-linking to space-separated lists, such as className:
        // Currently only supports toggle semantics - and has no effect if toggle string is not specified
        // data-link="class{merge:boolExpr toggle=className}"
        var regularExpression,
            currentValue = this.linkCtx._val || "",
            toggle = this.tagCtx.props.toggle;

        if (toggle) {
            // We are toggling the class specified by the toggle property,
            // and the boolean val binding is driving the insert/remove toggle

            regularExpression = toggle.replace(/[\\^$.|?*+()[{]/g, "\\$&");
            // Escape any regular expression special characters (metacharacters) within the toggle string
            regularExpression = "(\\s(?=" + regularExpression + "$)|(\\s)|^)(" + regularExpression + "(\\s|$))";
            // Example: /(\s(?=myclass$)|(\s)|^)?(myclass(\s|$))/ - so matches (" myclass" or " " or ^ ) followed by ("myclass " or "myclass$") where ^/$ are beginning/end of string
            currentValue = currentValue.replace(new RegExp(regularExpression), "$2");
            val = currentValue + (val ? (currentValue && " ") + toggle : "");
        }
        return val;
    };

    //========================
    // JsViews-specific tags
    //========================

    $tags("on", {
        attr: NONE,
        init: function (tagCtx) {
            var tag = this,
                props = tagCtx.props,
                content = tagCtx.content,
                elemType = props.elem;

            if (tag._.inline) {
                tag.attr = HTML;
                elemType = (elemType || "span") + ">";
                tag.template = "<" + elemType + (props.label || content.markup || tagCtx.params.args[0]) + "</" + elemType;
            }
        },
        render: function () {
            var tagCtx = this.tagCtx;
            return tagCtx.render(tagCtx.view, true); // no arg, so renders against parentView.data
        },
        onAfterLink: function (tagCtx, linkCtx) {
            var handler, params,
                tag = this,
                i = 0,
                args = tagCtx.args, // [events,] [selector,] handler
                l = args.length,
                props = tagCtx.props,
                data = props.data,
                view = tagCtx.view,
                contextOb = props.context; // Context ('this' pointer) for attached handler

            tag.activeElem = tag.activeElem || $(tag._.inline ? (tag._elCnt && error('Use data-link="{on...}"'), tag.nodes()[0]) : linkCtx.elem);

            while (i < l && !(params = $isFunction(handler = args[i++]))) { } // Handler is first arg of type function

            if (params) { // There is a handler
                params = args.slice(i); // Subsequent args are params
                args = args.slice(0, i - 1); // Preceding args (if any) are events and selector

                if (!contextOb) {
                    // Get the path for the preceding object (context object) of handler (which is the last arg), compile function
                    // to return that context object, and run compiled function against data
                    contextOb = /^(.*)[\.^][\w$]+$/.exec(tagCtx.params.args.slice(-params.length - 1)[0]);
                    contextOb = contextOb && $sub.tmplFn("{:" + contextOb[1] + "}", view.tmpl, true)(linkCtx.data, view);
                }

                if (tag._evs) {
                    tag.onDispose();
                }

                tag.activeElem.on(
                    tag._evs = args[0] || "click", // events defaults to "click"
                    tag._sel = args[1],
                    data == undefined ? null : data,
                    tag._hlr = function (ev) {
                        return handler.apply(contextOb || linkCtx.data, [].concat(
                            params, // e.g. par1, par2
                            ev,
                            { change: ev.type, view: view, linkCtx: linkCtx },
                            params.slice.call(arguments, 1) // If triggering event (e.g. jsv-domchange) has additional arguments after ev, pass them too
                        ));
                        // for {on 'click' handler par1 par2} use handler(par1, par2, ev, domchangeEventArgs)
                        // for {on 'jsv-domchange' handler par1 par2} use handler(par1, par2, ev, domchangeEventArgs, tagCtx, linkCtx, observableEventArgs)
                    }
                );
            }
        },
        onUpdate: function () {
            return false;
        },
        onDispose: function () {
            this.activeElem.off(this._evs, this._sel, this._hlr);
        },
        flow: true
    });

    $extend($tags["for"], {
        //onUpdate: function(ev, eventArgs, tagCtxs) {
        //Consider adding filtering for perf optimization. However the below prevents update on some scenarios which _should_ update - namely when there is another array on which for also depends.
        //var i, l, tci, prevArg;
        //for (tci = 0; (prevArg = this.tagCtxs[tci]) && prevArg.args.length; tci++) {
        //	if (prevArg.args[0] !== tagCtxs[tci].args[0]) {
        //		return true;
        //	}
        //}
        //return false;
        //},
        onArrayChange: function (ev, eventArgs, tagCtx, linkCtx) {
            var arrayView,
                target = ev.target,
                targetLength = target.length,
                tag = this,
                change = eventArgs.change;
            if (tag._.noVws // Child views not supported because target is not html - e.g. data-link="title{for ...}"
                || tag.tagCtxs[1] && ( // There is an {{else}}
                    change === "insert" && targetLength === eventArgs.items.length // inserting, and new length is same as inserted length, so going from 0 to n
                    || change === "remove" && !targetLength // removing , and new length 0, so going from n to 0
                    || change === "refresh" && !eventArgs.oldItems.length !== !targetLength // refreshing, and length is going from 0 to n or from n to 0
                )) {
                tag.refresh();
            } else {
                for (arrayView in tag._.arrVws) {
                    arrayView = tag._.arrVws[arrayView];
                    if (arrayView.data === target) {
                        arrayView._.onArrayChange.apply(arrayView, arguments);
                    }
                }
            }
            tag.domChange(tagCtx, linkCtx, eventArgs);
            ev.done = true;
        },
        onAfterLink: function (tagCtx, linkCtx) {
            var i, arrHandler, arrBinding, data,
                tag = this,
                arrayBindings = tag._ars || {},
                tagCtxs = tag.tagCtxs,
                l = tagCtxs.length,
                selected = tag.selected || 0;

            for (i = 0; i <= selected; i++) {
                tagCtx = tagCtxs[i];        // loop through tagCtxs up to selected
                data = tagCtx.map
                    ? tagCtx.map.tgt        // 'data' is mapped data
                    : tagCtx.args.length
                        ? tagCtx.args[0]    // or args[0]
                        : tagCtx.view.data; // or defaults to current data.

                if ((arrBinding = arrayBindings[i]) && data !== arrBinding[0]) { // Is there previous array data on this tagCtx, different from new data
                    $observe(arrBinding[0], arrBinding[1], true); //unobserve previous array
                    delete arrayBindings[i];
                }
                if (!arrayBindings[i] && $isArray(data)) {
                    $observe(data, arrHandler = function (ev, eventArgs) {
                        var tagCt = tagCtx;
                        tag.onArrayChange(ev, eventArgs, tagCt, linkCtx);
                    });
                    arrayBindings[i] = [data, arrHandler]; // Store array data and arrayChangeHandler on tag._ars[i]
                }
            }
            for (i = selected + 1; i < l; i++) { // If there were previous bindings on later tagCtxs, remove them
                if (arrBinding = arrayBindings[i]) {
                    $observe(arrBinding[0], arrBinding[1], true); //unobserve previous binding
                    delete arrayBindings[i];
                }
            }
            tag._ars = arrayBindings;
        },
        onDispose: function () {
            var l, tag = this;
            for (l in tag._ars) {
                $observe(tag._ars[l][0], tag._ars[l][1], true); //unobserve
            }
        }
    });

    $extend($tags["if"], {
        onUpdate: function (ev, eventArgs, tagCtxs) {
            var tci, prevArg, different;
            for (tci = 0; (prevArg = this.tagCtxs[tci]) && prevArg.args.length; tci++) {
                prevArg = prevArg.args[0];
                different = !prevArg !== !tagCtxs[tci].args[0];
                if ((!this.convert && !!prevArg) || different) {
                    return different;
                    // If there is no converter, and newArg and prevArg are both truthy, return false to cancel update. (Even if values on later elses are different, we still don't want to update, since rendered output would be unchanged)
                    // If newArg and prevArg are different, return true, to update
                    // If newArg and prevArg are both falsey, move to the next {{else ...}}
                }
            }
            // Boolean value of all args are unchanged (falsey), so return false to cancel update
            return false;
        },
        onAfterLink: function (tagCtx, linkCtx, eventArgs) {
            if (eventArgs) {
                this.domChange(tagCtx, linkCtx, eventArgs);
            }
        }
    });

    function observeProps(map, ev, eventArgs) {
        if (eventArgs.change === "set") {
            var target = map.tgt,
                l = target.length;
            while (l--) {
                if (target[l].key === eventArgs.path) {
                    break;
                }
            }
            if (l === -1) {
                if (eventArgs.path && !eventArgs.remove) {
                    $observable(target).insert({ key: eventArgs.path, prop: eventArgs.value });
                }
            } else if (eventArgs.remove) {
                $observable(target).remove(l);
            } else {
                $observable(target[l]).setProperty("prop", eventArgs.value);
            }
        }
    }

    function observeMappedProps(map, ev, eventArgs) {
        var item,
            source = map.src,
            change = eventArgs.change;

        if (change === "set") {
            if (eventArgs.path === "prop") {
                $observable(source).setProperty(ev.target.key, eventArgs.value);
            } else { // path === "key"
                $observable(source).setProperty(eventArgs.oldValue, null);
                delete source[eventArgs.oldValue];
                $observable(source).setProperty(eventArgs.value, ev.target.prop);
            }
        } else if (change === "remove") {
            item = eventArgs.items[0];
            $observable(source).removeProperty(item.key);
            delete source[item.key];
        } else if (change === "insert") {
            item = eventArgs.items[0];
            if (item.key) {
                $observable(source).setProperty(item.key, item.prop);
            }
        }
    }

    function shallowArrayFilter(allPath /*, object, parentObs*/) { // Filter used by {{props}} for the mappedProps target array
        return allPath.indexOf(".") < 0;
    }

    $tags("props", {
        baseTag: "for",
        dataMap: $views.map({
            getTgt: $tags.props.dataMap.getTgt,
            obsSrc: observeProps,
            obsTgt: observeMappedProps,
            tgtFlt: shallowArrayFilter
        }),
        flow: true
    });

    //========================
    // Extend jQuery namespace
    //========================

    $extend($, {

        //=======================
        // jQuery $.view() plugin
        //=======================

        view: $view = function (node, inner, type) {
            // $.view() returns top view
            // $.view(node) returns view that contains node
            // $.view(selector) returns view that contains first selected element
            // $.view(nodeOrSelector, type) returns nearest containing view of given type
            // $.view(nodeOrSelector, "root") returns root containing view (child of top view)
            // $.view(nodeOrSelector, true, type) returns nearest inner (contained) view of given type

            function getInnerView(nd, isVl) {
                if (nd) {
                    vwInfos = viewInfos(nd, isVl, rOpenViewMarkers);
                    for (j = 0, k = vwInfos.length; j < k; j++) {
                        if ((view = viewStore[vwInfos[j].id]) && (view = view && type ? view.get(true, type) : view)) {
                            break;
                        }
                    }
                }
            }

            if (inner !== !!inner) {
                // inner not boolean, so this is view(nodeOrSelector, type)
                type = inner;
                inner = undefined;
            }
            var view, vwInfos, i, j, k, l, elems,
                level = 0,
                body = document.body;

            if (node && node !== body && topView._.useKey > 1) {
                // Perf optimization for common cases

                node = "" + node === node
                    ? $(node)[0]
                    : node.jquery
                        ? node[0]
                        : node;

                if (node) {
                    if (inner) {
                        getInnerView(node._df, true);
                        if (!view) {
                            // Treat supplied node as a container element and return the first view encountered.
                            elems = qsa ? node.querySelectorAll(bindElsSel) : $(bindElsSel, node).get();
                            l = elems.length;
                            for (i = 0; !view && i < l; i++) {
                                getInnerView(elems[i]);
                            }
                        }
                        return view;
                    }
                    while (node) {
                        // Move back through siblings and up through parents to find preceding node which is a _prv (prevNode)
                        // script marker node for a non-element-content view, or a _prv (first node) for an elCnt view
                        if (vwInfos = viewInfos(node, undefined, rViewMarkers)) {
                            l = vwInfos.length;
                            while (l--) {
                                view = vwInfos[l];
                                if (view.open) {
                                    if (level < 1) {
                                        view = viewStore[view.id];
                                        return view && type ? view.get(type) : view || topView;
                                    }
                                    level--;
                                } else {
                                    // level starts at zero. If we hit a view.close, then we move level to 1, and we don't return a view until
                                    // we are back at level zero (or a parent view with level < 0)
                                    level++;
                                }
                            }
                        }
                        node = node.previousSibling || node.parentNode;
                    }
                }
            }
            return topView;
        },

        link: $link,
        unlink: $unlink,

        //=====================
        // override $.cleanData
        //=====================
        cleanData: function (elems) {
            if (elems.length && isCleanCall) {
                // Remove JsViews bindings. Also, remove from the DOM any corresponding script marker nodes
                clean(elems);
            }
            oldCleanData.apply($, arguments);
        }
    });

    // Possible future addition - e.g. for ckeditor tag control
    //$views.utility = {
    //	validate: function(html) {
    //		try {
    //			topView.link(undefined, document.createElement("div"), undefined, undefined, html, undefined, undefined, 1);
    //		}
    //		catch (e) {
    //			return e.message;
    //		}
    //	}
    //};

    //===============================
    // Extend jQuery instance plugins
    //===============================

    $extend($.fn, {
        link: function (expr, from, context, noIteration, parentView, prevNode, nextNode) {
            return $link(expr, this, from, context, noIteration, parentView, prevNode, nextNode);
        },
        unlink: function () {
            return $unlink(this);
        },
        view: function (inner, type) {
            return $view(this[0], inner, type);
        }
    });

    //==============================================================================
    // Override jQuery methods that call our overridden cleanData, for disposal etc.
    //==============================================================================

    $.each([HTML, "replaceWith", "empty", "remove"], function (i, name) {
        var oldFn = $.fn[name];
        $.fn[name] = function () {
            var result;
            isCleanCall = 1; // Make sure cleanData does disposal only when coming from these calls.
            try {
                result = oldFn.apply(this, arguments);
            }
            finally {
                isCleanCall = 0;
            }
            return result;
        };
    });

    //===============
    // Extend topView
    //===============

    addLinkMethods($extend(topView = $sub.topView, { tmpl: { links: {} } }));

    viewStore = { 0: topView }; // Top-level view

    //=========================
    // Extend $.views.settings
    //=========================

    oldAdvSet = $sub.advSet;

    $sub.advSet = function () { // refresh advanced settings
        oldAdvSet();
        global._jsv = $subSettingsAdvanced._jsv
            ? $extend(global._jsv || {}, { // create global _jsv, for accessing views, etc
                views: viewStore,
                bindings: bindingStore
            })
            : undefined; // In IE8 cannot do delete global._jsv
        $viewsLinkAttr = $subSettingsAdvanced.linkAttr;
        linkViewsSel = bindElsSel + ",[" + $viewsLinkAttr + "]";
        wrapMap = $subSettingsAdvanced._wm;
        wrapMap.optgroup = wrapMap.option;
        wrapMap.tbody = wrapMap.tfoot = wrapMap.colgroup = wrapMap.caption = wrapMap.thead;
        wrapMap.th = wrapMap.td;
    };

    $viewsSettings.advanced({
        linkAttr: "data-link",
        useViews: false,
        noValidate: false,
        // wrapMap provide appropriate wrappers for inserting innerHTML, used in insertBefore
        // We have to close these tags to support XHTML (#13200)
        // TODO investigate whether more recent jQuery implementation using wrapMap in domManip/$().html() etc. is better optimized now...
        _wm: {
            option: [1, "<select multiple='multiple'>", "</select>"],
            legend: [1, "<fieldset>", "</fieldset>"],
            area: [1, "<map>", "</map>"],
            param: [1, "<object>", "</object>"],
            thead: [1, "<table>", "</table>"],
            tr: [2, "<table><tbody>", "</tbody></table>"],
            td: [3, "<table><tbody><tr>", "</tr></tbody></table>"],
            col: [2, "<table><tbody></tbody><colgroup>", "</colgroup></table>"],
            svg_ns: [1, "<svg>", "</svg>"],
            // IE6-8 can't serialize link, script, style, or any html5 (NoScope) tags,
            // unless wrapped in a div with non-breaking characters in front of it.
            div: $.support.htmlSerialize ? [0, "", ""] : [1, "X<div>", "</div>"]
        },
        _fe: {
            input: {
                from: inputAttrib, to: "value"
            },
            textarea: valueBinding,
            select: valueBinding,
            optgroup: {
                to: "label"
            }
        }
    });

    return $;
}, window));
var helperVars = {};
$.views.helpers({
    formatDate: formatDate,
    getDay: function (val) {
        if (val != null) {
            var timestamp = val.replace(/\/Date\(/g, ' ').replace(/\)\//g, '');
            // Create a new JavaScript Date object based on the timestamp
            // multiplied by 1000 so that the argument is in milliseconds, not seconds.
            var date = new Date(parseInt(timestamp, 10));

            var date = date.getDate();

            return date;
        }
        return '';

    },
    round: function (num) {
        return Math.round(num);
    },
    ceiling: function (num) {
        return Math.ceil(num);
    },
    setvar: function (key, value) {
        helperVars[key] = value;
    },
    getvar: function (key) {
        return helperVars[key];
    },
    increase: function (key) {
        helperVars[key] = helperVars[key] + 1;
    },
    isHebrew: isHebrew,
    numberWithCommas: numberWithCommas,
    isValidLatitudeLongitudeValues: isValidLatLong,
    formatDateToPattern: formatDateToPattern,
    handleStringLength: handleStringLength,
    setImagePath: setImagePath,
    //Mobile - domestic hotels filters tabs functions
    isDomesticHotelsRateTabIncluded: isDomesticHotelsRateTabIncluded,
    isDomesticHotelsBoardTabIncluded: isDomesticHotelsBoardTabIncluded,
    isDomesticHotelsNamesTabIncluded: isDomesticHotelsNamesTabIncluded,
    isDomesticHotelsPriceRangeTabIncluded: isDomesticHotelsPriceRangeTabIncluded,
    isInternalFlightMultipleDestinationsIncluded: isInternalFlightMultipleDestinationsIncluded,
    isInternalFlightPriceRangeTabIncluded: isInternalFlightPriceRangeTabIncluded,
    isInternalFlightTimeRangeTabIncluded: isInternalFlightTimeRangeTabIncluded,
    isNullOrEmpty: isNullOrEmpty,
    splitCapacity: splitCapacity,
    isNullOrEmpty: isNullOrEmpty,
    getCapacityString: getCapacityString,
    isStarsPlus: isStarsPlus,
    moduloNumber: moduloNumber,
    floor: floor

});

$.views.helpers({
    paxArray: [
    { code: "Adult", caption: "מבוגר" },
    { code: "Child", caption: "ילד" },
    { code: "Infant", caption: "תינוק" },
    { code: "Youth", caption: "צעיר" },
    { code: "Senior", caption: "פנסיונר" },
    ],
    dealsPaxArray: [
   { code: "Adults", caption: "מבוגר", fareCode: "AdultFare" },
   { code: "Children", caption: "ילד", fareCode: "ChildFare" },
   { code: "Infant", caption: "תינוק", fareCode: "BabyFare" }
    ],
    organizedPaxArray: [
  { code: "NumAdults", caption: "מבוגר", fareCode: "AdultPriceAfterDiscout" },
  { code: "NumChilds", caption: "ילד", fareCode: "ChildPriceAfterDiscout" },
  { code: "NumInfants", caption: "תינוק", fareCode: "InfantPriceAfterDiscout" }
    ],
    domesticHotelsPaxArray: [
    { code: "NumAdults", caption: "מבוגר", fareCode: "AdultPriceAfterDiscout" },
    { code: "NumChilds", caption: "ילד", fareCode: "ChildPriceAfterDiscout" },
    { code: "NumInfants", caption: "תינוק", fareCode: "InfantPriceAfterDiscout" }
    ],
    internalFlightsPaxArray: [
  { code: "Adults", caption: "מבוגר", fareCode: "AdultPriceAfterDiscout" },
  { code: "Children", caption: "ילד", fareCode: "ChildPriceAfterDiscout" },
  { code: "Infants", caption: "תינוק", fareCode: "InfantPriceAfterDiscout" }
    ]
});

function formatDate(val) {
    if (val != null) {
        var timestamp = val.replace(/\/Date\(/g, ' ').replace(/\)\//g, '');
        // Create a new JavaScript Date object based on the timestamp
        // multiplied by 1000 so that the argument is in milliseconds, not seconds.
        var date = new Date(parseInt(timestamp, 10));
        var year = date.getFullYear().toString().substr(2, 2);
        var month = date.getMonth() + 1;
        var date = date.getDate();

        // Will display time in dd.mm.yy format
        var formattedTime = date + '.' + month + '.' + year;

        return formattedTime;
    }
    return "";
}

// Returns date string in date format
function formatDateToPattern(dateVal, pattern) {
    var formattedTime = '';
    if (dateVal != null) {
        var timestamp = dateVal.replace(/\/Date\(/g, ' ').replace(/\)\//g, '');
        // Create a new JavaScript Date object based on the timestamp
        // multiplied by 1000 so that the argument is in milliseconds, not seconds.
        var date = new Date(parseInt(timestamp, 10));

        var year = date.getFullYear().toString().substr(2, 2);
        var fullYear = date.getFullYear().toString();
        var month = date.getMonth() + 1;
        month = ('0' + month).slice(-2); // add zero if smaller than 10
        var day = date.getDate();
        day = ('0' + day).slice(-2); // add zero if smaller than 10

        if (pattern != undefined && pattern != null) {
            switch (pattern) {
                case 'dd.mm':
                    formattedTime = day + '.' + month;
                    break;
                case 'dd.mm.yy':
                    formattedTime = day + '.' + month + '.' + year;
                    break;
                case 'dd-mm-yy':
                    formattedTime = day + '-' + month + '-' + year;
                    break;
                case 'dd/mm/yy':
                    formattedTime = day + '/' + month + '/' + year;
                    break;
                case 'dd.mm.yyyy':
                    formattedTime = day + '.' + month + '.' + fullYear;
                    break;
                case 'dd/mm/yyyy':
                    formattedTime = day + '/' + month + '/' + fullYear;
                    break;
                case 'mm/dd/yyyy':
                    formattedTime = month + '/' + day + '/' + fullYear;
                    break;
                case 'timestamp':
                    formattedTime = parseInt(timestamp, 10);
                    break;
                default:
                    formattedTime = day + '.' + month + '.' + year;
            }

        } else {// Will display time in dd.mm.yy format           
            formattedTime = day + '.' + month + '.' + year;
        }
    }
    return formattedTime;
}


// Returns date timestamp
function formatDateFromPattern(dateVal, pattern) {
    var timestamp = dateVal;
    var formattedTime = "";
    timestamp = parseDateFromString(dateVal, pattern);
    formattedTime = "/Date(" + timestamp + ")/";

    return formattedTime;
}


function parseDateFromString(dateVal, pattern) {

    var newDate = "";
    var splitDate = [];

    if (dateVal != null) {
        if (pattern != undefined && pattern == "MM/dd/yyyy") {
            newDate = dateVal;
        } else {
            splitDate = dateVal.split(/[\.\/-]/);
            if (splitDate.length == 3)
                newDate = splitDate[1] + "/" + splitDate[0] + "/" + splitDate[2];
        }
    }
    return new Date(newDate).getTime();
}

function daydiff(first, second) {
    return Math.round((second - first) / (1000 * 60 * 60 * 24));
}

$.views.helpers({ 'logs': console.log });

$.views.allowCode = true;

//Function for adding comma tag to number tha is bigger then 3 digits
function numberWithCommas(num) {
    if (num != null) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }
    return '';
}

function isValidLatLong(latitudeVal, longitudeVal) {
    var returnVal = false;
    if (latitudeVal != null && latitudeVal != '0' && latitudeVal != "" && latitudeVal >= -90 && latitudeVal <= 90 && longitudeVal != null && longitudeVal != '0' && longitudeVal != "" && longitudeVal >= -180 && longitudeVal <= 180) {
        returnVal = true;
    }
    return returnVal;
}

function isHebrew(val) {
    var returnVal = false;
    if (val != null) {
        if (val.search(/[\u0590-\u05FF]/) >= 0) {
            returnVal = true;
        }
        else {
            returnVal = false;
        }
    }
    return returnVal;
}

function handleStringLength(stringVal, length) {
    var returnVal = stringVal;
    if (stringVal.length > length) {
        returnVal = stringVal.substring(0, length) + "...";
    }
    return returnVal;
}

function formatForAnalytics(str) {
    if (str == null || str == undefined || str == "") {
        return "NA";
    }
    return str.replace(/['"]/g, "");
}

function setImagePath(imagePath, sizeParameter) {
    if (imagePath != null && imagePath != undefined && imagePath != "") {
        return imagePath.replace('{0}', sizeParameter);
    }
    return imagePath;
}

// Mobile - Domestic Hotels Filter tabs functions - BEGIN
function isDomesticHotelsRateTabIncluded(filtersDictionery) {
    return (filtersDictionery["DomesticHotelsRank"] != null || filtersDictionery["DomesticHotelsYotpo"] != null);
}

function isDomesticHotelsBoardTabIncluded(filtersDictionery) {
    return (filtersDictionery["DomesticHotelsBoard"] != null);
}

function isDomesticHotelsNamesTabIncluded(filtersDictionery) {
    return (filtersDictionery["DomesticHotelsCompanyNames"] != null || filtersDictionery["DomesticHotelsNames"] != null);
}

function isDomesticHotelsPriceRangeTabIncluded(filtersDictionery) {
    return (filtersDictionery["DomesticHotelsPriceRange"] != null);
}
// Mobile - Domestic Hotels Filter tabs functions - END
// Mobile - Internal Flights Filter tabs functions - BEGIN
function isInternalFlightMultipleDestinationsIncluded(filtersDictionery) {
    return (filtersDictionery["FromRegionalDeparture"] != null || filtersDictionery["ToRegionalReturnFlight"] != null);
}

function isInternalFlightPriceRangeTabIncluded(filtersDictionery) {
    return (filtersDictionery["InternalFlightsPriceRangeDeparture"] != null || filtersDictionery["InternalFlightsPriceRangeReturnFlight"] != null);
}

function isInternalFlightTimeRangeTabIncluded(filtersDictionery) {
    return (filtersDictionery["InternalFlightsDepartureTimeRangeDepartureFlight"] != null || filtersDictionery["InternalFlightsDepartureTimeRangeReturnFlight"] != null);
}
// Mobile - Internal Flights Filter tabs functions - END

function isNullOrEmpty(str) {
    return str == undefined || str == null || str == "";
}

function splitCapacity(capacity, index) {
    return capacityArr = capacity.split("_")[index];
}

// Returns string of capacity names form capacity format string ("2_0_0")
function getCapacityString(capacity) {
    var capacityString = "";
    var capacityArray = capacity.split("_");
    if (capacityArray.length > 0) {
        for (var i = 0; i < capacityArray.length; i++) {
            if (typeof capacityArray[i] != 'undefined' && capacityArray[i] != null) {
                var capacityCount = parseInt(capacityArray[i]);
                if (i == 0) { // Adults
                    if (capacityCount < 2 && capacityCount != 0) {
                        capacityString += " מבוגר"
                    } else if (capacityCount >= 2 && capacityCount != 0) {
                        capacityString += capacityCount + " מבוגרים"
                    }
                }
                if (i == 1) { //Childres
                    if (capacityCount < 2 && capacityCount != 0) {
                        capacityString += " + " + "ילד"
                    } else if (capacityCount >= 2 && capacityCount != 0) {
                        capacityString += " + " + capacityCount + " ילדים"
                    }
                }
                if (i == 2) { //Babies
                    if (capacityCount < 2 && capacityCount != 0) {
                        capacityString += " + " + "תינוק"
                    } else if (capacityCount >= 2 && capacityCount != 0) {
                        capacityString += " + " + capacityCount + " תינוקות"
                    }
                }

            }
        }
    }

    return capacityString;
}

function isNullOrEmpty(str) {
    return str == undefined || str == null || str == "";
}

function isStarsPlus(stars) {
    return stars % 1 == 0.5;
}


function moduloNumber(num, moduloVar) {
    if (typeof num != 'undefined' && num != null && typeof moduloVar != 'undefined' && moduloVar != null && moduloVar != 0) {
        var number = parseFloat(num);
        number = (number % moduloVar);
        return number;
    } else {
        return num;
    }
}

function floor(num) {
    return parseInt(num);
}
